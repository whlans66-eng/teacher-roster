<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è³‡æ–™åŒæ­¥ä¿®å¾©å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    h1 {
      color: #1d1d1f;
      margin-bottom: 10px;
      font-size: 32px;
    }

    .subtitle {
      color: #6e6e73;
      margin-bottom: 30px;
      font-size: 16px;
    }

    .info-box {
      background: #f5f5f7;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .info-box h3 {
      color: #1d1d1f;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e5e5e7;
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-label {
      color: #6e6e73;
      font-size: 14px;
    }

    .info-value {
      color: #1d1d1f;
      font-weight: 600;
      font-size: 14px;
    }

    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 12px;
    }

    .btn-primary {
      background: #007aff;
      color: white;
    }

    .btn-primary:hover {
      background: #0051d5;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,122,255,0.3);
    }

    .btn-secondary {
      background: #34c759;
      color: white;
    }

    .btn-secondary:hover {
      background: #248a3d;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(52,199,89,0.3);
    }

    .btn-danger {
      background: #ff3b30;
      color: white;
    }

    .btn-danger:hover {
      background: #d70015;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255,59,48,0.3);
    }

    .status {
      margin-top: 20px;
      padding: 16px;
      border-radius: 12px;
      font-size: 14px;
      display: none;
    }

    .status.success {
      background: #d1f4e0;
      color: #248a3d;
      border: 2px solid #34c759;
    }

    .status.error {
      background: #ffe5e5;
      color: #d70015;
      border: 2px solid #ff3b30;
    }

    .status.info {
      background: #e5f3ff;
      color: #0051d5;
      border: 2px solid #007aff;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ è³‡æ–™åŒæ­¥ä¿®å¾©å·¥å…·</h1>
    <p class="subtitle">è§£æ±ºè³‡æ–™è¡çªå’ŒåŒæ­¥å•é¡Œ</p>

    <div class="info-box" id="dataInfo">
      <h3>ğŸ“Š ç•¶å‰è³‡æ–™ç‹€æ…‹</h3>
      <div class="info-item">
        <span class="info-label">æœ¬åœ°æ•™å¸«è³‡æ–™</span>
        <span class="info-value" id="localTeachers">è¼‰å…¥ä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">æœ¬åœ°æ’ç¨‹è³‡æ–™</span>
        <span class="info-value" id="localCourses">è¼‰å…¥ä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">æœ¬åœ°æµ·äº‹èª²ç¨‹</span>
        <span class="info-value" id="localMaritime">è¼‰å…¥ä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">æœ€å¾ŒåŒæ­¥æ™‚é–“</span>
        <span class="info-value" id="lastSync">è¼‰å…¥ä¸­...</span>
      </div>
      <div class="info-item">
        <span class="info-label">localStorage ä½¿ç”¨é‡</span>
        <span class="info-value" id="storageSize">è¼‰å…¥ä¸­...</span>
      </div>
    </div>

    <button class="btn btn-primary" onclick="diagnose()">
      ğŸ” è¨ºæ–·å•é¡Œ
    </button>

    <button class="btn btn-secondary" onclick="forceClearAndReload()">
      ğŸ”„ æ¸…é™¤å¿«å–ä¸¦é‡æ–°è¼‰å…¥
    </button>

    <button class="btn btn-danger" onclick="clearAllData()">
      âš ï¸ æ¸…é™¤æ‰€æœ‰æœ¬åœ°è³‡æ–™
    </button>

    <div id="status" class="status"></div>
  </div>

  <script>
    // è¼‰å…¥è³‡æ–™ç‹€æ…‹
    function loadDataStatus() {
      try {
        const teachers = JSON.parse(localStorage.getItem('teachers') || '[]');
        const courses = JSON.parse(localStorage.getItem('courseAssignments') || '[]');
        const maritime = JSON.parse(localStorage.getItem('maritimeCourses') || '[]');
        const lastSync = localStorage.getItem('lastSyncTime');

        document.getElementById('localTeachers').textContent = `${teachers.length} ç­†`;
        document.getElementById('localCourses').textContent = `${courses.length} ç­†`;
        document.getElementById('localMaritime').textContent = `${maritime.length} ç­†`;
        document.getElementById('lastSync').textContent = lastSync
          ? new Date(lastSync).toLocaleString('zh-TW')
          : 'å¾æœªåŒæ­¥';

        // è¨ˆç®— localStorage ä½¿ç”¨é‡
        let totalSize = 0;
        for (let key in localStorage) {
          if (localStorage.hasOwnProperty(key)) {
            totalSize += localStorage[key].length + key.length;
          }
        }
        const sizeInKB = (totalSize / 1024).toFixed(2);
        document.getElementById('storageSize').textContent = `${sizeInKB} KB`;

      } catch (error) {
        showStatus('è¼‰å…¥è³‡æ–™ç‹€æ…‹å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    // è¨ºæ–·å•é¡Œ
    function diagnose() {
      showStatus('æ­£åœ¨è¨ºæ–·...', 'info');

      const issues = [];

      // æª¢æŸ¥ 1ï¼šæ˜¯å¦æœ‰è³‡æ–™
      const teachers = JSON.parse(localStorage.getItem('teachers') || '[]');
      const courses = JSON.parse(localStorage.getItem('courseAssignments') || '[]');

      if (teachers.length === 0) {
        issues.push('âŒ æ²’æœ‰æ•™å¸«è³‡æ–™');
      }

      if (courses.length === 0) {
        issues.push('âš ï¸ æ²’æœ‰æ’ç¨‹è³‡æ–™');
      }

      // æª¢æŸ¥ 2ï¼šæ˜¯å¦æœ‰åŒæ­¥æ¨™è¨˜
      const hasChanges = localStorage.getItem('hasLocalChanges');
      if (hasChanges === 'true') {
        issues.push('âš ï¸ æœ‰æœªåŒæ­¥çš„æœ¬åœ°ä¿®æ”¹');
      }

      // æª¢æŸ¥ 3ï¼šlocalStorage æ˜¯å¦éå¤§
      let totalSize = 0;
      for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
          totalSize += localStorage[key].length + key.length;
        }
      }
      const sizeInMB = totalSize / (1024 * 1024);
      if (sizeInMB > 5) {
        issues.push('âŒ localStorage è¶…é 5MBï¼Œå¯èƒ½å°è‡´æ€§èƒ½å•é¡Œ');
      }

      // é¡¯ç¤ºçµæœ
      if (issues.length === 0) {
        showStatus('âœ… æ²’æœ‰ç™¼ç¾å•é¡Œï¼è³‡æ–™ç‹€æ…‹æ­£å¸¸ã€‚', 'success');
      } else {
        showStatus('ç™¼ç¾ä»¥ä¸‹å•é¡Œï¼š\n' + issues.join('\n'), 'error');
      }
    }

    // å¼·åˆ¶æ¸…é™¤ä¸¦é‡æ–°è¼‰å…¥
    function forceClearAndReload() {
      if (confirm('âš ï¸ é€™å°‡æ¸…é™¤æ‰€æœ‰æœ¬åœ°å¿«å–ä¸¦é‡æ–°å¾å¾Œç«¯è¼‰å…¥è³‡æ–™ã€‚\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
        showStatus('æ­£åœ¨æ¸…é™¤å¿«å–...', 'info');

        setTimeout(() => {
          localStorage.clear();
          showStatus('âœ… å¿«å–å·²æ¸…é™¤ï¼Œå³å°‡é‡æ–°è¼‰å…¥é é¢...', 'success');

          setTimeout(() => {
            window.location.href = '/';
          }, 1500);
        }, 500);
      }
    }

    // æ¸…é™¤æ‰€æœ‰æœ¬åœ°è³‡æ–™
    function clearAllData() {
      if (confirm('âš ï¸ å±éšªæ“ä½œï¼\n\né€™å°‡åˆªé™¤æ‰€æœ‰æœ¬åœ°è³‡æ–™ï¼ŒåŒ…æ‹¬ï¼š\n- æ•™å¸«è³‡æ–™\n- æ’ç¨‹è³‡æ–™\n- æµ·äº‹èª²ç¨‹\n- æ‰€æœ‰è¨­å®š\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
        if (confirm('â— æœ€å¾Œç¢ºèªï¼šçœŸçš„è¦åˆªé™¤æ‰€æœ‰æœ¬åœ°è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
          localStorage.clear();
          showStatus('âœ… æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤ï¼å³å°‡é‡æ–°è¼‰å…¥...', 'success');

          setTimeout(() => {
            location.reload();
          }, 2000);
        }
      }
    }

    // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
      status.style.display = 'block';
    }

    // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºè³‡æ–™ç‹€æ…‹
    loadDataStatus();
  </script>
</body>
</html>
