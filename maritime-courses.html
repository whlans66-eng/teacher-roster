<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºæ…§æ´¾èª² | æµ·äº‹å°ˆæ¥­è¨“ç·´èª²ç¨‹ç³»çµ±</title>

  <style>
  :root {
    --apple-blue: #0071e3;
    --apple-blue-hover: #0077ed;
    --apple-text: #1d1d1f;
    --apple-gray: #86868b;
    --glass-bg: rgba(255, 255, 255, 0.65);
    --glass-border: rgba(255, 255, 255, 0.4);
    --card-radius: 20px;
    --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.05);
  }

  * { box-sizing: border-box; font-family: "SF Pro Text", -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; }

  body {
    background: #f5f5f7;
    min-height: 100vh;
    color: var(--apple-text);
    padding-bottom: 40px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; animation: floatUp 0.8s ease; }

  @keyframes floatUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* é ‚éƒ¨å°èˆª */
  .header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
  .back-btn {
    display: flex; align-items: center; gap: 6px; color: var(--apple-text);
    text-decoration: none; font-weight: 500; font-size: 15px; padding: 10px 20px;
    background: #ffffff; border-radius: 30px;
    border: 1px solid rgba(0, 0, 0, 0.04); transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
  }
  .back-btn:hover { background: #ffffff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
  .page-title { text-align: center; flex: 1; }
  .page-title h1 { font-size: 28px; font-weight: 700; }
  .page-title p { font-size: 13px; color: var(--apple-gray); margin-top: 4px; font-weight: 500; }

  /* iOS åˆ†é åˆ‡æ› */
  .segmented-control {
    background: #ffffff; padding: 4px;
    border-radius: 12px; display: flex; margin: 0 auto 40px auto; width: 100%; max-width: 400px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
    border: 1px solid rgba(0, 0, 0, 0.04);
  }
  .segment-btn {
    flex: 1; border: none; background: transparent; padding: 8px 0; border-radius: 9px;
    font-size: 13px; font-weight: 500; color: var(--apple-text); cursor: pointer; transition: all 0.3s ease;
  }
  .segment-btn.active { background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.12); font-weight: 600; }

  /* ç™½è‰²å¡ç‰‡ */
  .glass-panel {
    background: #ffffff;
    border: 1px solid rgba(0, 0, 0, 0.04); border-radius: var(--card-radius);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
    padding: 30px; margin-bottom: 24px; transition: transform 0.3s ease;
  }

  /* è¼¸å…¥æ¡† */
  .ios-input {
    width: 100%; padding: 14px 16px; border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    background: #f5f5f7; font-size: 15px; transition: all 0.2s;
  }
  .ios-input:focus { outline: none; background: #fff; border-color: var(--apple-blue); box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.15); }

  /* æŒ‰éˆ• */
  .primary-btn {
    background: var(--apple-blue); color: white; border: none; border-radius: 12px;
    padding: 12px 24px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 15px;
  }
  .primary-btn:hover { background: var(--apple-blue-hover); transform: scale(1.02); }

  .secondary-btn {
    background: rgba(0, 0, 0, 0.05); color: var(--apple-text); border: none;
    border-radius: 12px; padding: 12px 24px; font-weight: 600; cursor: pointer; font-size: 15px;
  }
  .secondary-btn:hover { background: rgba(0, 0, 0, 0.1); }

  .danger-btn {
    background: rgba(255, 59, 48, 0.1); color: #ff3b30; border: none;
    border-radius: 12px; padding: 12px 24px; font-weight: 600; cursor: pointer; font-size: 15px;
  }
  .danger-btn:hover { background: rgba(255, 59, 48, 0.2); }

  /* èª²ç¨‹å¡ç‰‡ */
  .course-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 24px; }
  .course-card {
    background: #ffffff;
    border: 1px solid rgba(0, 0, 0, 0.04); border-radius: 20px; padding: 24px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
  }
  .course-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), 0 12px 32px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04);
    border-color: rgba(0, 122, 255, 0.1);
  }
  .course-card.dragging {
    opacity: 0.5;
    cursor: grabbing;
  }
  .course-card.drag-over {
    border-color: rgba(0, 122, 255, 0.5);
    background: rgba(0, 122, 255, 0.05);
  }
  .drag-handle {
    cursor: grab;
    color: #86868b;
    padding: 4px;
    display: inline-flex;
    align-items: center;
    transition: color 0.2s;
  }
  .drag-handle:hover {
    color: #007aff;
  }
  .drag-handle:active {
    cursor: grabbing;
  }
  .course-title { font-size: 19px; font-weight: 700; margin-bottom: 8px; line-height: 1.3; }
  .badge {
    padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.5px; display: inline-block;
  }
  .badge-blue { background: rgba(0, 113, 227, 0.1); color: #0071e3; }
  .badge-green { background: rgba(52, 199, 89, 0.1); color: #34c759; }
  .badge-orange { background: rgba(255, 149, 0, 0.1); color: #ff9500; }

  /* é«˜äº® */
  .highlight { background-color: #fef3c7; padding: 2px 4px; border-radius: 3px; }

  /* çµ±è¨ˆå¡ç‰‡ */
  .stat-card {
    background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
    border-radius: 18px; padding: 28px; color: white; text-align: center;
    position: relative; overflow: hidden; transition: all 0.4s ease;
  }
  .stat-card.purple { background: linear-gradient(135deg, #5856d6 0%, #3634a3 100%); }
  .stat-card.green { background: linear-gradient(135deg, #34c759 0%, #248a3d 100%); }
  .stat-card:hover { transform: translateY(-4px); box-shadow: 0 16px 48px rgba(0, 122, 255, 0.3); }

  /* å½ˆçª— */
  .modal-backdrop {
    position: fixed; inset: 0; z-index: 9999; display: none; align-items: center; justify-content: center;
    background: rgba(0, 0, 0, 0.5);
  }
  .modal-backdrop.show { display: flex; }
  .apple-modal {
    background: #ffffff;
    border-radius: 24px; width: 90%; max-width: 560px; padding: 32px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(0, 0, 0, 0.04);
    max-height: 85vh; overflow-y: auto;
  }

  /* é—œéµå­—æ¨™ç±¤ */
  .keyword-tag-input {
    display: flex; align-items: center; gap: 6px; background: #f5f5f7; border-radius: 16px;
    padding: 6px 12px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    border: 1px solid rgba(0, 0, 0, 0.08);
  }
  .keyword-tag-input input {
    border: none; background: transparent; outline: none; width: 80px; font-size: 13px;
  }
  .keyword-tag-input .remove-btn {
    cursor: pointer; color: #ff3b30; font-weight: bold; font-size: 16px;
  }

  .hidden { display: none !important; }

  /* ========== AI å°è©±ä»‹é¢ ========== */
  .ai-chat-container {
    display: flex;
    flex-direction: column;
    height: 600px;
    background: #ffffff;
    border-radius: 20px;
    border: 1px solid rgba(0, 0, 0, 0.04);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
    overflow: hidden;
  }
  .ai-chat-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 20px 24px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  .ai-chat-header-icon {
    width: 40px; height: 40px;
    border-radius: 12px;
    background: rgba(255,255,255,0.2);
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
  }
  .ai-chat-header-title { font-size: 17px; font-weight: 700; }
  .ai-chat-header-sub { font-size: 12px; opacity: 0.8; }
  .ai-chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    scroll-behavior: smooth;
  }
  .ai-msg {
    max-width: 85%;
    padding: 14px 18px;
    border-radius: 18px;
    font-size: 14px;
    line-height: 1.7;
    word-break: break-word;
    animation: msgFadeIn 0.3s ease;
  }
  @keyframes msgFadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .ai-msg.user {
    align-self: flex-end;
    background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
    color: white;
    border-bottom-right-radius: 6px;
  }
  .ai-msg.assistant {
    align-self: flex-start;
    background: #f5f5f7;
    color: #1d1d1f;
    border-bottom-left-radius: 6px;
  }
  .ai-msg.assistant ul, .ai-msg.assistant ol {
    margin: 8px 0;
    padding-left: 20px;
  }
  .ai-msg.assistant li { margin-bottom: 4px; }
  .ai-msg.assistant strong { color: #007aff; }
  .ai-msg.assistant code {
    background: rgba(0,0,0,0.06);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 13px;
  }
  .ai-msg.system {
    align-self: center;
    background: transparent;
    color: #86868b;
    font-size: 13px;
    text-align: center;
    padding: 8px;
  }
  .ai-chat-input-area {
    display: flex;
    gap: 10px;
    padding: 16px 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.06);
    background: #fafafa;
  }
  .ai-chat-input {
    flex: 1;
    padding: 12px 16px;
    border-radius: 24px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    background: #ffffff;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .ai-chat-input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
  }
  .ai-chat-send {
    width: 44px; height: 44px;
    border-radius: 50%;
    border: none;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, opacity 0.2s;
  }
  .ai-chat-send:hover { transform: scale(1.08); }
  .ai-chat-send:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .ai-typing-indicator {
    display: flex;
    gap: 4px;
    padding: 14px 18px;
    align-self: flex-start;
    background: #f5f5f7;
    border-radius: 18px;
    border-bottom-left-radius: 6px;
  }
  .ai-typing-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #86868b;
    animation: typingBounce 1.4s infinite ease-in-out;
  }
  .ai-typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .ai-typing-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typingBounce {
    0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
    40% { transform: scale(1); opacity: 1; }
  }
  .ai-quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.04);
    background: #fafafa;
  }
  .ai-quick-btn {
    padding: 8px 14px;
    border-radius: 20px;
    border: 1px solid rgba(0, 0, 0, 0.08);
    background: white;
    color: #1d1d1f;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }
  .ai-quick-btn:hover {
    border-color: #667eea;
    color: #667eea;
    background: #f5f3ff;
  }

  /* æ™ºæ…§åŒ¹é…ç¯©é¸å™¨ */
  .smart-match-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
    border: 1px solid #ddd6fe;
    border-radius: 14px;
    margin-top: 16px;
  }
  .smart-match-bar label {
    font-size: 13px;
    font-weight: 600;
    color: #5b21b6;
    white-space: nowrap;
  }
  .smart-match-bar select {
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid #c4b5fd;
    background: white;
    font-size: 13px;
    color: #1d1d1f;
    outline: none;
  }
  .smart-match-bar select:focus {
    border-color: #7c3aed;
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.15);
  }
  .smart-match-toggle {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #5b21b6;
    font-weight: 500;
    cursor: pointer;
  }
  .smart-match-toggle input[type="checkbox"] {
    width: 18px; height: 18px;
    accent-color: #7c3aed;
  }

  /* é©ç”¨å°è±¡é¸é …æ¨£å¼ */
  .target-option.selected { border-color: #007aff !important; background: linear-gradient(135deg, #e6f0ff 0%, #f0f5ff 100%) !important; }
  .target-option.selected.new { border-color: #34c759 !important; background: linear-gradient(135deg, #e8f9ed 0%, #f0fdf4 100%) !important; }
  .rank-option-new.selected { border-color: #6366f1 !important; background: linear-gradient(135deg, #eef2ff 0%, #f5f3ff 100%) !important; }
  .target-checkbox:hover .target-option, .target-checkbox:hover .rank-option-new { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  /* æ¨¡æ…‹æ¡†é¸é …æ¨£å¼ */
  .target-option-modal.selected { border-color: #007aff !important; background: linear-gradient(135deg, #e6f0ff 0%, #f0f5ff 100%) !important; }
  .target-option-modal.selected.new { border-color: #34c759 !important; background: linear-gradient(135deg, #e8f9ed 0%, #f0fdf4 100%) !important; }
  .rank-option-modal.selected { border-color: #6366f1 !important; background: linear-gradient(135deg, #eef2ff 0%, #f5f3ff 100%) !important; color: #4f46e5; }
  .target-checkbox-modal:hover .target-option-modal, .target-checkbox-modal:hover .rank-option-modal { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

  /* ========== èª²ç¨‹è©³æƒ…é é¢æ¨£å¼ ========== */
  .course-detail-layout {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 32px;
  }
  @media (max-width: 1024px) {
    .course-detail-layout { grid-template-columns: 1fr; }
  }
  .course-detail-main { display: flex; flex-direction: column; gap: 24px; }
  .course-detail-sidebar { display: flex; flex-direction: column; gap: 20px; }

  /* è©³æƒ…å¡ç‰‡ */
  .detail-card {
    background: #ffffff;
    border-radius: 24px;
    border: 1px solid #f1f5f9;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    overflow: hidden;
  }
  .sidebar-card { padding: 24px; }

  /* æ¨™é¡Œå¡ç‰‡ */
  .detail-header-card {
    padding: 32px;
    position: relative;
    overflow: hidden;
  }
  .header-card-decoration {
    position: absolute;
    top: 32px;
    right: 32px;
    opacity: 0.08;
    transform: rotate(12deg);
  }
  .header-card-decoration i { font-size: 128px; color: #3b82f6; }
  .header-card-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
    position: relative;
    z-index: 1;
  }
  .header-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border-radius: 9999px;
    font-size: 12px;
    font-weight: 600;
    border: 1px solid;
  }
  .header-badge i { font-size: 14px; }
  .header-badge-blue { background: #eff6ff; color: #2563eb; border-color: #dbeafe; }
  .header-badge-indigo { background: #eef2ff; color: #4f46e5; border-color: #e0e7ff; }
  .header-card-title {
    font-size: 28px;
    font-weight: 800;
    color: #0f172a;
    line-height: 1.3;
    margin-bottom: 20px;
    position: relative;
    z-index: 1;
  }
  .header-card-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    font-size: 14px;
    color: #64748b;
    position: relative;
    z-index: 1;
  }
  .header-card-meta span { display: flex; align-items: center; gap: 8px; }
  .header-card-meta i { font-size: 16px; }

  /* å¡ç‰‡æ¨™é¡Œå€ */
  .detail-card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 20px 24px;
    border-bottom: 1px solid #f8fafc;
    background: linear-gradient(to bottom, #fafbfc, #ffffff);
  }
  .detail-card-header-flex {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid #f8fafc;
    background: linear-gradient(to bottom, #fafbfc, #ffffff);
  }
  .detail-card-icon {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .detail-card-icon-blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
  .detail-card-icon-orange { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
  .detail-card-title { font-size: 18px; font-weight: 700; color: #0f172a; }
  .detail-card-body { padding: 24px; }

  /* èª²ç¨‹æè¿° */
  .description-content {
    font-size: 15px;
    line-height: 1.8;
    color: #334155;
    background: #f8fafc;
    padding: 20px 24px;
    border-radius: 16px;
    border-left: 4px solid #3b82f6;
  }

  /* é—œéµå­—æ¨™ç±¤ */
  .keyword-count-badge {
    font-size: 12px;
    font-weight: 700;
    color: #64748b;
    background: #f1f5f9;
    padding: 6px 12px;
    border-radius: 9999px;
  }
  .keyword-tags-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .keyword-tag-item {
    padding: 10px 18px;
    background: #ffffff;
    border: 1px solid #e2e8f0;
    color: #475569;
    font-size: 14px;
    font-weight: 500;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
  }
  .keyword-tag-item:hover {
    border-color: #3b82f6;
    color: #2563eb;
    background: #eff6ff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59,130,246,0.15);
  }
  .keyword-tag-item:active { transform: scale(0.97); }

  /* ç©ºç‹€æ…‹ */
  .empty-state {
    text-align: center;
    padding: 48px 24px;
    color: #94a3b8;
  }
  .empty-state i { font-size: 48px; margin-bottom: 12px; display: block; }
  .empty-state p { font-size: 14px; font-weight: 500; }

  /* å´é‚Šæ¬„æ¨£å¼ */
  .sidebar-section { margin-bottom: 24px; }
  .sidebar-section:last-child { margin-bottom: 0; }
  .sidebar-section-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    font-weight: 700;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 16px;
  }
  .sidebar-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
  }
  .sidebar-dot-indigo { background: #6366f1; }
  .sidebar-dot-emerald { background: #10b981; }
  .sidebar-dot-purple { background: #8b5cf6; }

  .sidebar-info-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 24px;
    border-radius: 16px;
    border: 1px solid;
    transition: all 0.2s ease;
    cursor: default;
  }
  .sidebar-info-box:hover { transform: scale(1.02); }
  .sidebar-info-box-indigo { background: linear-gradient(135deg, #eef2ff 0%, #f5f3ff 100%); border-color: #e0e7ff; }
  .sidebar-info-box-emerald { background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%); border-color: #d1fae5; }
  .sidebar-info-icon {
    width: 56px;
    height: 56px;
    background: #ffffff;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    border: 1px solid rgba(99,102,241,0.1);
    transition: transform 0.2s ease;
  }
  .sidebar-info-box:hover .sidebar-info-icon { transform: scale(1.1); }
  .sidebar-info-icon i { font-size: 28px; color: #6366f1; }
  .sidebar-info-icon-emerald i { color: #10b981; }
  .sidebar-info-main { font-size: 18px; font-weight: 700; color: #0f172a; margin-bottom: 4px; }
  .sidebar-info-sub { font-size: 11px; color: #64748b; font-weight: 600; letter-spacing: 0.05em; }

  /* é©ç”¨å°è±¡ */
  .target-audience-content { display: flex; flex-direction: column; gap: 16px; }
  .target-section-label { font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 8px; }
  .target-badges { display: flex; flex-wrap: wrap; gap: 8px; }
  .target-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 9999px;
    font-size: 12px;
    font-weight: 600;
  }
  .target-badge i { font-size: 14px; }
  .target-badge-blue { background: #eff6ff; color: #2563eb; }
  .target-badge-green { background: #ecfdf5; color: #059669; }
  .target-badge-purple { background: #f5f3ff; color: #7c3aed; }

  /* ç©ºç‹€æ…‹ï¼ˆå´é‚Šæ¬„ï¼‰ */
  .empty-state-sidebar {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 48px 24px;
    border: 2px dashed #e2e8f0;
    border-radius: 16px;
    background: linear-gradient(135deg, #fafbfc 0%, #f8fafc 100%);
  }
  .empty-state-sidebar-icon {
    width: 64px;
    height: 64px;
    background: #ffffff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  .empty-state-sidebar-icon i { font-size: 32px; color: #cbd5e1; }
  .empty-state-sidebar p { font-size: 14px; color: #94a3b8; font-weight: 500; margin-bottom: 16px; }
  .empty-state-btn {
    padding: 8px 16px;
    background: #ffffff;
    border: 1px solid #e2e8f0;
    color: #3b82f6;
    font-size: 12px;
    font-weight: 700;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
  }
  .empty-state-btn:hover { background: #eff6ff; border-color: #bfdbfe; }

  /* æ“ä½œæŒ‰éˆ• */
  .sidebar-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
    position: sticky;
    bottom: 24px;
  }
  .action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 16px 24px;
    border-radius: 16px;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
  }
  .action-btn i { font-size: 18px; }
  .action-btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    box-shadow: 0 8px 24px rgba(59,130,246,0.35);
  }
  .action-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 32px rgba(59,130,246,0.4);
  }
  .action-btn-primary:active { transform: scale(0.98); }
  .action-btn-secondary {
    background: #ffffff;
    color: #475569;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .action-btn-secondary:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
  }
  .action-btn-secondary:active { transform: scale(0.98); }

  /* è¡çªå°è©±æ¡† */
  .conflict-dialog {
    background: #ffffff;
    padding: 30px; border-radius: 24px; max-width: 480px; width: 90%;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2); border: 1px solid rgba(0, 0, 0, 0.04);
  }
  .conflict-user-list {
    background: rgba(0,0,0,0.03); padding: 15px; border-radius: 12px; margin: 20px 0;
  }
  .conflict-user-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05);
  }

  /* åœ“é¤…åœ– */
  .pie-chart {
    width: 280px; height: 280px; border-radius: 50%;
    background: conic-gradient(from 0deg,
      #4f46e5 0deg, #4f46e5 var(--angle1, 0deg),
      #06b6d4 var(--angle1, 0deg), #06b6d4 var(--angle2, 0deg),
      #10b981 var(--angle2, 0deg), #10b981 var(--angle3, 0deg),
      #f59e0b var(--angle3, 0deg), #f59e0b var(--angle4, 0deg),
      #ef4444 var(--angle4, 0deg), #ef4444 var(--angle5, 0deg),
      #8b5cf6 var(--angle5, 0deg), #8b5cf6 var(--angle6, 0deg),
      #f97316 var(--angle6, 0deg), #f97316 var(--angle7, 0deg),
      #84cc16 var(--angle7, 0deg), #84cc16 var(--angle8, 0deg),
      #ec4899 var(--angle8, 0deg), #ec4899 360deg);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); position: relative;
    transition: all 0.4s ease; margin: 0 auto;
  }
  .pie-chart:hover { transform: scale(1.02); }
  .pie-chart::before {
    content: ''; position: absolute; top: 50%; left: 50%;
    width: 130px; height: 130px; background: #fff; border-radius: 50%;
    transform: translate(-50%, -50%); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }
  .pie-chart::after {
    content: 'ğŸ“Š\Aèª²ç¨‹åˆ†å¸ƒ'; position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%); font-size: 13px; font-weight: 600;
    color: #1d1d1f; z-index: 1; text-align: center; white-space: pre; line-height: 1.4;
  }

  .donut-chart {
    position: relative; width: 120px; height: 120px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    background: conic-gradient(from 0deg,
      var(--color) 0deg, var(--color) var(--angle, 0deg),
      rgba(0, 0, 0, 0.06) var(--angle, 0deg), rgba(0, 0, 0, 0.06) 360deg);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }
  .donut-chart::before {
    content: ''; position: absolute; width: 75px; height: 75px;
    background: white; border-radius: 50%; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
  }
  .donut-chart-label {
    position: absolute; font-size: 16px; font-weight: 600; color: #1d1d1f; z-index: 1;
  }

  .method-card {
    background: #ffffff;
    border-radius: 16px; padding: 28px 20px; text-align: center;
    transition: all 0.4s ease; border: 1px solid rgba(0, 0, 0, 0.04);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
  }
  .method-card:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), 0 12px 32px rgba(0, 0, 0, 0.08); }
  </style>

  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <script src="js/security.js"></script>
  <script src="js/api.js"></script>
</head>
<body>
  <script src="js/auth.js"></script>
  <script>protectPage(['admin', 'teacher']);</script>

  <div class="container">
    <!-- è·¨é å°è¦½åˆ— -->
    <nav style="background: #ffffff; border-bottom: 1px solid rgba(0,0,0,0.08); box-shadow: 0 1px 3px rgba(0,0,0,0.04); position: sticky; top: 0; z-index: 50; margin: -40px -40px 40px -40px; padding: 0 40px;">
      <div style="max-width: 1280px; margin: 0 auto;">
        <div style="display: flex; align-items: center; justify-content: space-between; height: 56px;">
          <a href="index.html" style="display: flex; align-items: center; gap: 8px; color: #6b7280; text-decoration: none; font-size: 14px; font-weight: 500; transition: color 0.2s;" onmouseover="this.style.color='#1f2937'" onmouseout="this.style.color='#6b7280'">
            <i class="ph ph-house" style="font-size: 18px;"></i>
            <span>é¦–é </span>
          </a>
          <div style="display: flex; align-items: center; gap: 4px;">
            <a href="teacher-management.html" style="padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; text-decoration: none; color: #6b7280; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb';this.style.color='#374151'" onmouseout="this.style.background='transparent';this.style.color='#6b7280'">
              <i class="ph ph-user-list"></i> å¸«è³‡ç®¡ç†
            </a>
            <a href="course-management.html" style="padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; text-decoration: none; color: #6b7280; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb';this.style.color='#374151'" onmouseout="this.style.background='transparent';this.style.color='#6b7280'">
              <i class="ph ph-calendar"></i> è¨“ç·´æ’ç¨‹
            </a>
            <a href="maritime-courses.html" style="padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; text-decoration: none; background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe;">
              <i class="ph ph-anchor"></i> æ™ºæ…§æ´¾èª²
            </a>
          </div>
          <div style="width: 60px;"></div>
        </div>
      </div>
    </nav>

    <div class="page-title" style="margin-bottom: 40px;">
      <h1>æ™ºæ…§æ´¾èª²</h1>
      <p>Smart Course Assignment System</p>
    </div>

    <div class="segmented-control" style="max-width: 520px;">
      <button id="maritimeViewTab" class="segment-btn active" onclick="switchMaritimeTab('view')">èª²ç¨‹ç€è¦½</button>
      <button id="maritimeAITab" class="segment-btn" onclick="switchMaritimeTab('ai')">AI é¡§å•</button>
      <button id="maritimeEditTab" class="segment-btn" onclick="switchMaritimeTab('edit')">èª²ç¨‹ç®¡ç†</button>
      <button id="maritimeStatsTab" class="segment-btn" onclick="switchMaritimeTab('stats')">çµ±è¨ˆåˆ†æ</button>
    </div>

    <!-- 1. èª²ç¨‹ç€è¦½é é¢ -->
    <div id="maritimeViewPage">
      <div class="glass-panel">
        <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 20px;">ğŸ” èª²ç¨‹æœå°‹</h2>
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px;">
          <input type="text" id="maritimeSearchInput" placeholder="è¼¸å…¥èª²ç¨‹åç¨±æˆ–é—œéµå­—..." class="ios-input" oninput="displayMaritimeCourses()">
          <select id="maritimeCategoryFilter" class="ios-input" onchange="displayMaritimeCourses()">
            <option value="">æ‰€æœ‰åˆ†é¡</option>
            <option value="01">01 èˆ¹èˆ¶æ“ç¸±èˆ‡èˆªè¡Œ</option>
            <option value="02">02 é ˜å°çµ±å¾¡èˆ‡ç®¡ç†</option>
            <option value="03">03 äº‹æ•…æ¡ˆä¾‹åˆ†æ</option>
            <option value="04">04 èˆ¹èˆ¶è¨­å‚™æ“ä½œ</option>
            <option value="05">05 åœ‹éš›æ³•è¦çŸ¥è­˜</option>
            <option value="06">06 è²¨ç‰©è£å¸å¯¦å‹™</option>
            <option value="07">07 èˆ¹å“¡ç¶“é©—äº¤æµ</option>
            <option value="08">08 è·ç´šè½‰æ›èª¿é©</option>
            <option value="09">09 å…¶ä»–</option>
            <option value="10">10 è³‡æ–™åˆ†æ</option>
          </select>
        </div>
      </div>
      <!-- æ™ºæ…§åŒ¹é…ç¯©é¸ -->
      <div class="smart-match-bar">
        <label><i class="ph ph-magic-wand"></i> æ™ºæ…§åŒ¹é…</label>
        <select id="smartMatchRank" onchange="displayMaritimeCourses()">
          <option value="">-- é¸æ“‡è·ç­‰ --</option>
          <option value="C/P">C/P èˆ¹é•·</option>
          <option value="C/O">C/O å¤§å‰¯</option>
          <option value="2/O">2/O äºŒå‰¯</option>
          <option value="3/O">3/O ä¸‰å‰¯</option>
          <option value="bosun">æ°´æ‰‹é•·</option>
          <option value="AB">å¹¹ç·´æ°´æ‰‹</option>
          <option value="deckCadet">ç”²æ¿å¯¦ç¿’ç”Ÿ</option>
          <option value="C/E">C/E è¼ªæ©Ÿé•·</option>
          <option value="2/E">2/E å¤§ç®¡</option>
          <option value="3/E">3/E 2ç®¡</option>
          <option value="4/E">4/E 3ç®¡</option>
          <option value="oiler">åŠ æ²¹é•·</option>
          <option value="fitter">éŠ…åŒ </option>
          <option value="engineCadet">è¼ªæ©Ÿå¯¦ç¿’ç”Ÿ</option>
        </select>
        <select id="smartMatchCategory" onchange="displayMaritimeCourses()">
          <option value="">-- äººå“¡é¡åˆ¥ --</option>
          <option value="existing">ç¾æœ‰èˆ¹å“¡</option>
          <option value="new">æ–°é€²èˆ¹å“¡</option>
        </select>
        <label class="smart-match-toggle">
          <input type="checkbox" id="smartMatchEnabled" onchange="displayMaritimeCourses()">
          å•Ÿç”¨åŒ¹é…æ’åº
        </label>
      </div>

      <div id="maritimeCourseResults" class="course-grid"></div>
    </div>

    <!-- èª²ç¨‹è©³æƒ…æª¢è¦–é é¢ -->
    <div id="courseDetailView" class="hidden">
      <div style="margin-bottom: 24px;">
        <button onclick="backToCourseList()" class="back-btn" style="display: inline-flex;">
          <i class="ph ph-arrow-left"></i>
          <span>è¿”å›èª²ç¨‹åˆ—è¡¨</span>
        </button>
      </div>
      <div id="courseDetailContent"></div>
    </div>

    <!-- AI é¡§å•é é¢ -->
    <div id="maritimeAIPage" class="hidden">
      <div class="ai-chat-container">
        <div class="ai-chat-header">
          <div class="ai-chat-header-icon">
            <i class="ph ph-robot"></i>
          </div>
          <div>
            <div class="ai-chat-header-title">AI èª²ç¨‹é¡§å•</div>
            <div class="ai-chat-header-sub">æ ¹æ“šèª²ç¨‹è³‡æ–™åº«ç‚ºæ‚¨æä¾›æ™ºæ…§æ¨è–¦</div>
          </div>
          <button onclick="aiChat.clearHistory(); document.getElementById('aiChatMessages').innerHTML = ''; addAIWelcomeMessage();"
            style="margin-left:auto; background:rgba(255,255,255,0.2); border:none; color:white; padding:8px 14px; border-radius:10px; font-size:12px; font-weight:600; cursor:pointer;">
            <i class="ph ph-arrow-counter-clockwise"></i> æ–°å°è©±
          </button>
        </div>
        <div id="aiChatMessages" class="ai-chat-messages"></div>
        <div class="ai-quick-actions">
          <button class="ai-quick-btn" onclick="sendAIQuickMessage('æ¨è–¦å¤§å‰¯é©åˆçš„èª²ç¨‹')">æ¨è–¦å¤§å‰¯èª²ç¨‹</button>
          <button class="ai-quick-btn" onclick="sendAIQuickMessage('æ–°é€²èˆ¹å“¡éœ€è¦ä¸Šå“ªäº›èª²ï¼Ÿ')">æ–°é€²èˆ¹å“¡èª²ç¨‹</button>
          <button class="ai-quick-btn" onclick="sendAIQuickMessage('é ˜å°çµ±å¾¡ç›¸é—œçš„èª²ç¨‹æœ‰å“ªäº›ï¼Ÿ')">é ˜å°çµ±å¾¡</button>
          <button class="ai-quick-btn" onclick="sendAIQuickMessage('è«‹åˆ†æç›®å‰èª²ç¨‹åˆ†ä½ˆæ˜¯å¦å‡è¡¡')">èª²ç¨‹åˆ†ä½ˆåˆ†æ</button>
        </div>
        <div class="ai-chat-input-area">
          <input type="text" id="aiChatInput" class="ai-chat-input"
            placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œï¼Œä¾‹å¦‚ï¼šã€Œæ¨è–¦é©åˆäºŒå‰¯çš„å®‰å…¨èª²ç¨‹ã€"
            onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); sendAIMessage();}">
          <button id="aiChatSendBtn" class="ai-chat-send" onclick="sendAIMessage()">
            <i class="ph ph-paper-plane-tilt"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- 2. èª²ç¨‹ç®¡ç†é é¢ -->
    <div id="maritimeEditPage" class="hidden">
      <div class="glass-panel">
        <h2 style="font-size: 22px; font-weight: 700; margin-bottom: 24px;">æ–°å¢èª²ç¨‹</h2>
        <form id="maritimeCourseForm">
          <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div>
              <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); margin-left: 4px; display: block; margin-bottom: 6px;">èª²ç¨‹åç¨±</label>
              <input type="text" id="maritimeCourseName" required class="ios-input" placeholder="è¼¸å…¥èª²ç¨‹åç¨±">
            </div>
            <div>
              <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); margin-left: 4px; display: block; margin-bottom: 6px;">åˆ†é¡</label>
              <select id="maritimeCourseCategory" required class="ios-input">
                <option value="">é¸æ“‡åˆ†é¡</option>
                <option value="01">01 èˆ¹èˆ¶æ“ç¸±</option>
                <option value="02">02 é ˜å°çµ±å¾¡</option>
                <option value="03">03 äº‹æ•…åˆ†æ</option>
                <option value="04">04 è¨­å‚™æ“ä½œ</option>
                <option value="05">05 æ³•è¦çŸ¥è­˜</option>
                <option value="06">06 è²¨ç‰©è£å¸</option>
                <option value="07">07 ç¶“é©—äº¤æµ</option>
                <option value="08">08 è·ç´šè½‰æ›</option>
                <option value="09">09 å…¶ä»–</option>
                <option value="10">10 è³‡æ–™åˆ†æ</option>
              </select>
            </div>
            <div>
              <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); margin-left: 4px; display: block; margin-bottom: 6px;">æˆèª²æ–¹å¼</label>
              <select id="maritimeCourseMethod" required class="ios-input">
                <option value="å¯¦é«”èª²ç¨‹">å¯¦é«”èª²ç¨‹</option>
                <option value="ç·šä¸Šèª²ç¨‹">ç·šä¸Šèª²ç¨‹</option>
                <option value="æ··åˆèª²ç¨‹">æ··åˆèª²ç¨‹</option>
              </select>
            </div>
          </div>
          <div style="margin-bottom: 16px;">
            <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); margin-left: 4px; display: block; margin-bottom: 6px;">èª²ç¨‹æè¿°</label>
            <textarea id="maritimeCourseDescription" rows="3" class="ios-input" style="resize: vertical;" placeholder="è¼¸å…¥èª²ç¨‹å¤§ç¶±..."></textarea>
          </div>
          <!-- é©ç”¨å°è±¡ -->
          <div style="margin-bottom: 24px; background: #f5f5f7; border-radius: 16px; padding: 20px;">
            <label style="font-size: 14px; font-weight: 700; color: #1d1d1f; margin-bottom: 16px; display: block;">
              <i class="ph ph-users" style="margin-right: 6px;"></i>é©ç”¨å°è±¡
            </label>

            <!-- äººå“¡é¡åˆ¥ -->
            <div style="margin-bottom: 20px;">
              <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); margin-left: 4px; display: block; margin-bottom: 8px;">äººå“¡é¡åˆ¥</label>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <label class="target-checkbox" style="cursor: pointer;">
                  <input type="checkbox" name="targetCategory" value="existing" style="display: none;">
                  <div class="target-option" style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; border: 2px solid #e5e5ea; border-radius: 12px; transition: all 0.2s; background: white;">
                    <i class="ph ph-check-circle" style="font-size: 18px; color: #007aff;"></i>
                    <div><div style="font-weight: 600; font-size: 14px;">ç¾æœ‰</div><div style="font-size: 11px; color: #86868b;">æ—¢æœ‰èˆ¹å“¡</div></div>
                  </div>
                </label>
                <label class="target-checkbox" style="cursor: pointer;">
                  <input type="checkbox" name="targetCategory" value="new" style="display: none;">
                  <div class="target-option" style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; border: 2px solid #e5e5ea; border-radius: 12px; transition: all 0.2s; background: white;">
                    <i class="ph ph-user-plus" style="font-size: 18px; color: #34c759;"></i>
                    <div><div style="font-weight: 600; font-size: 14px;">æ–°é€²</div><div style="font-size: 11px; color: #86868b;">æ–°åŠ å…¥èˆ¹å“¡</div></div>
                  </div>
                </label>
              </div>
            </div>

            <!-- ç”²æ¿éƒ¨é–€è·ç­‰ -->
            <div style="margin-bottom: 20px;">
              <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); margin-left: 4px; display: block; margin-bottom: 8px;">ç”²æ¿éƒ¨é–€è·ç­‰</label>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                <label class="target-checkbox" style="cursor: pointer;">
                  <input type="checkbox" name="targetRank" value="C/P" style="display: none;">
                  <div class="rank-option-new" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #e5e5ea; border-radius: 10px; transition: all 0.2s; background: white;">
                    <i class="ph ph-anchor" style="font-size: 16px; color: #6366f1;"></i>
                    <div><div style="font-weight: 600; font-size: 13px;">C/P</div><div style="font-size: 10px; color: #86868b;">èˆ¹é•·</div></div>
                  </div>
                </label>
                <label class="target-checkbox" style="cursor: pointer;">
                  <input type="checkbox" name="targetRank" value="C/O" style="display: none;">
                  <div class="rank-option-new" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #e5e5ea; border-radius: 10px; transition: all 0.2s; background: white;">
                    <i class="ph ph-compass" style="font-size: 16px; color: #6366f1;"></i>
                    <div><div style="font-weight: 600; font-size: 13px;">C/O</div><div style="font-size: 10px; color: #86868b;">å¤§å‰¯</div></div>
                  </div>
                </label>
                <label class="target-checkbox" style="cursor: pointer;">
                  <input type="checkbox" name="targetRank" value="2/O" style="display: none;">
                  <div class="rank-option-new" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #e5e5ea; border-radius: 10px; transition: all 0.2s; background: white;">
                    <i class="ph ph-binoculars" style="font-size: 16px; color: #3b82f6;"></i>
                    <div><div style="font-weight: 600; font-size: 13px;">2/O</div><div style="font-size: 10px; color: #86868b;">äºŒå‰¯</div></div>
                  </div>
                </label>
                <label class="target-checkbox" style="cursor: pointer;">
                  <input type="checkbox" name="targetRank" value="3/O" style="display: none;">
                  <div class="rank-option-new" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #e5e5ea; border-radius: 10px; transition: all 0.2s; background: white;">
                    <i class="ph ph-navigation-arrow" style="font-size: 16px; color: #3b82f6;"></i>
                    <div><div style="font-weight: 600; font-size: 13px;">3/O</div><div style="font-size: 10px; color: #86868b;">ä¸‰å‰¯</div></div>
                  </div>
                </label>
                <label class="target-checkbox" style="cursor: pointer;">
                  <input type="checkbox" name="targetRank" value="bosun" style="display: none;">
                  <div class="rank-option-new" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #e5e5ea; border-radius: 10px; transition: all 0.2s; background: white;">
                    <i class="ph ph-users-three" style="font-size: 16px; color: #06b6d4;"></i>
                    <div><div style="font-weight: 600; font-size: 13px;">æ°´æ‰‹é•·</div><div style="font-size: 10px; color: #86868b;">Bosun</div></div>
                  </div>
                </label>
                <label class="target-checkbox" style="cursor: pointer;">
                  <input type="checkbox" name="targetRank" value="carpenter" style="display: none;">
                  <div class="rank-option-new" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #e5e5ea; border-radius: 10px; transition: all 0.2s; background: white;">
                    <i class="ph ph-hammer" style="font-size: 16px; color: #f59e0b;"></i>
                    <div><div style="font-weight: 600; font-size: 13px;">æœ¨åŒ </div><div style="font-size: 10px; color: #86868b;">Carpenter</div></div>
                  </div>
                </label>
                <label class="target-checkbox" style="cursor: pointer;">
                  <input type="checkbox" name="targetRank" value="AB" style="display: none;">
                  <div class="rank-option-new" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #e5e5ea; border-radius: 10px; transition: all 0.2s; background: white;">
                    <i class="ph ph-user-check" style="font-size: 16px; color: #14b8a6;"></i>
                    <div><div style="font-weight: 600; font-size: 13px;">å¹¹ç·´æ°´æ‰‹</div><div style="font-size: 10px; color: #86868b;">A.B.</div></div>
                  </div>
                </label>
                <label class="target-checkbox" style="cursor: pointer;">
                  <input type="checkbox" name="targetRank" value="deckCadet" style="display: none;">
                  <div class="rank-option-new" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #e5e5ea; border-radius: 10px; transition: all 0.2s; background: white;">
                    <i class="ph ph-student" style="font-size: 16px; color: #0ea5e9;"></i>
                    <div><div style="font-weight: 600; font-size: 13px;">ç”²æ¿å¯¦ç¿’ç”Ÿ</div><div style="font-size: 10px; color: #86868b;">Deck Cadet</div></div>
                  </div>
                </label>
              </div>
            </div>

            <!-- è¼ªæ©Ÿéƒ¨é–€è·ç­‰ -->
            <div>
              <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); margin-left: 4px; display: block; margin-bottom: 8px;">è¼ªæ©Ÿéƒ¨é–€è·ç­‰</label>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                <label class="target-checkbox" style="cursor: pointer;">
                  <input type="checkbox" name="targetRank" value="C/E" style="display: none;">
                  <div class="rank-option-new" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #e5e5ea; border-radius: 10px; transition: all 0.2s; background: white;">
                    <i class="ph ph-gear" style="font-size: 16px; color: #8b5cf6;"></i>
                    <div><div style="font-weight: 600; font-size: 13px;">C/E</div><div style="font-size: 10px; color: #86868b;">è¼ªæ©Ÿé•·</div></div>
                  </div>
                </label>
                <label class="target-checkbox" style="cursor: pointer;">
                  <input type="checkbox" name="targetRank" value="2/E" style="display: none;">
                  <div class="rank-option-new" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #e5e5ea; border-radius: 10px; transition: all 0.2s; background: white;">
                    <i class="ph ph-engine" style="font-size: 16px; color: #a855f7;"></i>
                    <div><div style="font-weight: 600; font-size: 13px;">2/E</div><div style="font-size: 10px; color: #86868b;">å¤§ç®¡</div></div>
                  </div>
                </label>
                <label class="target-checkbox" style="cursor: pointer;">
                  <input type="checkbox" name="targetRank" value="3/E" style="display: none;">
                  <div class="rank-option-new" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #e5e5ea; border-radius: 10px; transition: all 0.2s; background: white;">
                    <i class="ph ph-wrench" style="font-size: 16px; color: #d946ef;"></i>
                    <div><div style="font-weight: 600; font-size: 13px;">3/E</div><div style="font-size: 10px; color: #86868b;">2ç®¡</div></div>
                  </div>
                </label>
                <label class="target-checkbox" style="cursor: pointer;">
                  <input type="checkbox" name="targetRank" value="4/E" style="display: none;">
                  <div class="rank-option-new" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #e5e5ea; border-radius: 10px; transition: all 0.2s; background: white;">
                    <i class="ph ph-screwdriver" style="font-size: 16px; color: #ec4899;"></i>
                    <div><div style="font-weight: 600; font-size: 13px;">4/E</div><div style="font-size: 10px; color: #86868b;">3ç®¡</div></div>
                  </div>
                </label>
                <label class="target-checkbox" style="cursor: pointer;">
                  <input type="checkbox" name="targetRank" value="oiler" style="display: none;">
                  <div class="rank-option-new" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #e5e5ea; border-radius: 10px; transition: all 0.2s; background: white;">
                    <i class="ph ph-drop" style="font-size: 16px; color: #f97316;"></i>
                    <div><div style="font-weight: 600; font-size: 13px;">åŠ æ²¹é•·</div><div style="font-size: 10px; color: #86868b;">Oiler</div></div>
                  </div>
                </label>
                <label class="target-checkbox" style="cursor: pointer;">
                  <input type="checkbox" name="targetRank" value="fitter" style="display: none;">
                  <div class="rank-option-new" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #e5e5ea; border-radius: 10px; transition: all 0.2s; background: white;">
                    <i class="ph ph-toolbox" style="font-size: 16px; color: #ef4444;"></i>
                    <div><div style="font-weight: 600; font-size: 13px;">éŠ…åŒ </div><div style="font-size: 10px; color: #86868b;">Fitter</div></div>
                  </div>
                </label>
                <label class="target-checkbox" style="cursor: pointer;">
                  <input type="checkbox" name="targetRank" value="engineCadet" style="display: none;">
                  <div class="rank-option-new" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #e5e5ea; border-radius: 10px; transition: all 0.2s; background: white;">
                    <i class="ph ph-student" style="font-size: 16px; color: #f43f5e;"></i>
                    <div><div style="font-weight: 600; font-size: 13px;">è¼ªæ©Ÿå¯¦ç¿’ç”Ÿ</div><div style="font-size: 10px; color: #86868b;">Engine Cadet</div></div>
                  </div>
                </label>
              </div>
            </div>
          </div>

          <div style="margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); margin-left: 4px;">é—œéµå­—æ¨™ç±¤</label>
              <button type="button" onclick="addMaritimeKeyword()" style="border: none; background: none; color: var(--apple-blue); font-size: 13px; font-weight: 600; cursor: pointer;">+ æ–°å¢é—œéµå­—</button>
            </div>
            <div id="maritimeKeywordList" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 12px; min-height: 50px;"></div>
          </div>
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" id="maritimeCancelEdit" class="secondary-btn">é‡ç½®</button>
            <button type="submit" class="primary-btn">å„²å­˜èª²ç¨‹</button>
          </div>
        </form>
      </div>

      <div class="glass-panel">
        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">å·²å»ºç«‹çš„èª²ç¨‹</h2>
        <input type="text" id="maritimeManageSearchInput" placeholder="æœå°‹èª²ç¨‹..." class="ios-input" style="margin-bottom: 20px;" oninput="displayManageMaritimeCourses()">
        <div id="maritimeManageCourseList" style="display: grid; gap: 12px;"></div>
      </div>
    </div>

    <!-- 3. çµ±è¨ˆåˆ†æé é¢ -->
    <div id="maritimeStatsPage" class="hidden">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px;">
        <div class="stat-card">
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ç¸½èª²ç¨‹æ•¸</div>
          <div id="maritimeTotalCourses" style="font-size: 48px; font-weight: 700; margin: 10px 0;">0</div>
          <div style="font-size: 12px; opacity: 0.8;">æŒçºŒæˆé•·ä¸­</div>
        </div>
        <div class="stat-card purple">
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">æœ€ç†±é–€åˆ†é¡</div>
          <div id="maritimePopularCategory" style="font-size: 20px; font-weight: 600; margin: 24px 0;">-</div>
        </div>
        <div class="stat-card green">
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">é—œéµå­—ç¸½æ•¸</div>
          <div id="maritimeTotalKeywords" style="font-size: 48px; font-weight: 700; margin: 10px 0;">0</div>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
        <div class="glass-panel">
          <h3 style="margin-bottom: 20px; font-size: 16px; font-weight: 600;">èª²ç¨‹åˆ†é¡åˆ†ä½ˆ</h3>
          <div id="maritimeCategoryStats"></div>
        </div>
        <div class="glass-panel">
          <h3 style="margin-bottom: 20px; font-size: 16px; font-weight: 600; text-align: center;">èª²ç¨‹åˆ†é¡åœ“é¤…åœ–</h3>
          <div id="maritimePieChart" class="pie-chart"></div>
          <div id="maritimeChartLegend" style="margin-top: 24px;"></div>
        </div>
      </div>

      <div class="glass-panel" style="margin-top: 24px;">
        <h3 style="margin-bottom: 20px; font-size: 16px; font-weight: 600;">æˆèª²æ–¹å¼çµ±è¨ˆ</h3>
        <div id="maritimeMethodStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;"></div>
      </div>

      <!-- ç†±é–€é—œéµå­— -->
      <div class="glass-panel" style="margin-top: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h3 style="font-size: 16px; font-weight: 600; display: flex; align-items: center;">
            ğŸ”‘ ç†±é–€é—œéµå­—
          </h3>
        </div>
        <div id="maritimeKeywordsCloud" style="display: flex; flex-wrap: wrap; gap: 12px;"></div>
      </div>
    </div>
  </div>

  <!-- ç·¨è¼¯å½ˆçª— -->
  <div id="maritimeCourseModal" class="modal-backdrop" onclick="if(event.target === this) closeMaritimeCourseModal()">
    <div class="apple-modal">
      <h3 id="maritimeModalTitle" style="font-size: 24px; font-weight: 700; margin-bottom: 24px; text-align: center;">ç·¨è¼¯èª²ç¨‹</h3>

      <form id="maritimeCourseModalForm" onsubmit="saveMaritimeCourseFromModal(event)">
        <div style="margin-bottom: 16px;">
          <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); display: block; margin-bottom: 6px;">èª²ç¨‹åç¨±</label>
          <input type="text" id="maritimeCourseNameModal" required class="ios-input" placeholder="èª²ç¨‹åç¨±">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div>
            <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); display: block; margin-bottom: 6px;">åˆ†é¡</label>
            <select id="maritimeCourseCategoryModal" required class="ios-input">
              <option value="01">01 èˆ¹èˆ¶æ“ç¸±</option>
              <option value="02">02 é ˜å°çµ±å¾¡</option>
              <option value="03">03 äº‹æ•…åˆ†æ</option>
              <option value="04">04 è¨­å‚™æ“ä½œ</option>
              <option value="05">05 æ³•è¦çŸ¥è­˜</option>
              <option value="06">06 è²¨ç‰©è£å¸</option>
              <option value="07">07 ç¶“é©—äº¤æµ</option>
              <option value="08">08 è·ç´šè½‰æ›</option>
              <option value="09">09 å…¶ä»–</option>
              <option value="10">10 è³‡æ–™åˆ†æ</option>
            </select>
          </div>
          <div>
            <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); display: block; margin-bottom: 6px;">æˆèª²æ–¹å¼</label>
            <select id="maritimeCourseMethodModal" required class="ios-input">
              <option value="å¯¦é«”èª²ç¨‹">å¯¦é«”èª²ç¨‹</option>
              <option value="ç·šä¸Šèª²ç¨‹">ç·šä¸Šèª²ç¨‹</option>
              <option value="æ··åˆèª²ç¨‹">æ··åˆèª²ç¨‹</option>
            </select>
          </div>
        </div>

        <div style="margin-bottom: 16px;">
          <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); display: block; margin-bottom: 6px;">èª²ç¨‹æè¿°</label>
          <textarea id="maritimeCourseDescriptionModal" rows="3" class="ios-input" style="resize: vertical;" placeholder="èª²ç¨‹æè¿°"></textarea>
        </div>

        <!-- é©ç”¨å°è±¡ Modal -->
        <div style="margin-bottom: 20px; background: #f5f5f7; border-radius: 12px; padding: 16px;">
          <label style="font-size: 13px; font-weight: 700; color: #1d1d1f; margin-bottom: 12px; display: block;">
            <i class="ph ph-users" style="margin-right: 6px;"></i>é©ç”¨å°è±¡
          </label>

          <div style="margin-bottom: 12px;">
            <label style="font-size: 11px; font-weight: 600; color: var(--apple-gray); display: block; margin-bottom: 6px;">äººå“¡é¡åˆ¥</label>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <label class="target-checkbox-modal" style="cursor: pointer;">
                <input type="checkbox" name="targetCategoryModal" value="existing" style="display: none;">
                <div class="target-option-modal" style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; border: 2px solid #e5e5ea; border-radius: 8px; transition: all 0.2s; background: white; font-size: 12px;">
                  <i class="ph ph-check-circle" style="color: #007aff;"></i>
                  <span style="font-weight: 600;">ç¾æœ‰</span>
                </div>
              </label>
              <label class="target-checkbox-modal" style="cursor: pointer;">
                <input type="checkbox" name="targetCategoryModal" value="new" style="display: none;">
                <div class="target-option-modal" style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; border: 2px solid #e5e5ea; border-radius: 8px; transition: all 0.2s; background: white; font-size: 12px;">
                  <i class="ph ph-user-plus" style="color: #34c759;"></i>
                  <span style="font-weight: 600;">æ–°é€²</span>
                </div>
              </label>
            </div>
          </div>

          <div style="margin-bottom: 12px;">
            <label style="font-size: 11px; font-weight: 600; color: var(--apple-gray); display: block; margin-bottom: 6px;">ç”²æ¿éƒ¨é–€</label>
            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
              <label class="target-checkbox-modal" style="cursor: pointer;"><input type="checkbox" name="targetRankModal" value="C/P" style="display: none;"><div class="rank-option-modal" style="padding: 4px 10px; border: 2px solid #e5e5ea; border-radius: 6px; font-size: 11px; font-weight: 600; background: white;">C/P</div></label>
              <label class="target-checkbox-modal" style="cursor: pointer;"><input type="checkbox" name="targetRankModal" value="C/O" style="display: none;"><div class="rank-option-modal" style="padding: 4px 10px; border: 2px solid #e5e5ea; border-radius: 6px; font-size: 11px; font-weight: 600; background: white;">C/O</div></label>
              <label class="target-checkbox-modal" style="cursor: pointer;"><input type="checkbox" name="targetRankModal" value="2/O" style="display: none;"><div class="rank-option-modal" style="padding: 4px 10px; border: 2px solid #e5e5ea; border-radius: 6px; font-size: 11px; font-weight: 600; background: white;">2/O</div></label>
              <label class="target-checkbox-modal" style="cursor: pointer;"><input type="checkbox" name="targetRankModal" value="3/O" style="display: none;"><div class="rank-option-modal" style="padding: 4px 10px; border: 2px solid #e5e5ea; border-radius: 6px; font-size: 11px; font-weight: 600; background: white;">3/O</div></label>
              <label class="target-checkbox-modal" style="cursor: pointer;"><input type="checkbox" name="targetRankModal" value="bosun" style="display: none;"><div class="rank-option-modal" style="padding: 4px 10px; border: 2px solid #e5e5ea; border-radius: 6px; font-size: 11px; font-weight: 600; background: white;">æ°´æ‰‹é•·</div></label>
              <label class="target-checkbox-modal" style="cursor: pointer;"><input type="checkbox" name="targetRankModal" value="carpenter" style="display: none;"><div class="rank-option-modal" style="padding: 4px 10px; border: 2px solid #e5e5ea; border-radius: 6px; font-size: 11px; font-weight: 600; background: white;">æœ¨åŒ </div></label>
              <label class="target-checkbox-modal" style="cursor: pointer;"><input type="checkbox" name="targetRankModal" value="AB" style="display: none;"><div class="rank-option-modal" style="padding: 4px 10px; border: 2px solid #e5e5ea; border-radius: 6px; font-size: 11px; font-weight: 600; background: white;">å¹¹ç·´æ°´æ‰‹</div></label>
              <label class="target-checkbox-modal" style="cursor: pointer;"><input type="checkbox" name="targetRankModal" value="deckCadet" style="display: none;"><div class="rank-option-modal" style="padding: 4px 10px; border: 2px solid #e5e5ea; border-radius: 6px; font-size: 11px; font-weight: 600; background: white;">ç”²æ¿å¯¦ç¿’ç”Ÿ</div></label>
            </div>
          </div>

          <div>
            <label style="font-size: 11px; font-weight: 600; color: var(--apple-gray); display: block; margin-bottom: 6px;">è¼ªæ©Ÿéƒ¨é–€</label>
            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
              <label class="target-checkbox-modal" style="cursor: pointer;"><input type="checkbox" name="targetRankModal" value="C/E" style="display: none;"><div class="rank-option-modal" style="padding: 4px 10px; border: 2px solid #e5e5ea; border-radius: 6px; font-size: 11px; font-weight: 600; background: white;">C/E</div></label>
              <label class="target-checkbox-modal" style="cursor: pointer;"><input type="checkbox" name="targetRankModal" value="2/E" style="display: none;"><div class="rank-option-modal" style="padding: 4px 10px; border: 2px solid #e5e5ea; border-radius: 6px; font-size: 11px; font-weight: 600; background: white;">2/E</div></label>
              <label class="target-checkbox-modal" style="cursor: pointer;"><input type="checkbox" name="targetRankModal" value="3/E" style="display: none;"><div class="rank-option-modal" style="padding: 4px 10px; border: 2px solid #e5e5ea; border-radius: 6px; font-size: 11px; font-weight: 600; background: white;">3/E</div></label>
              <label class="target-checkbox-modal" style="cursor: pointer;"><input type="checkbox" name="targetRankModal" value="4/E" style="display: none;"><div class="rank-option-modal" style="padding: 4px 10px; border: 2px solid #e5e5ea; border-radius: 6px; font-size: 11px; font-weight: 600; background: white;">4/E</div></label>
              <label class="target-checkbox-modal" style="cursor: pointer;"><input type="checkbox" name="targetRankModal" value="oiler" style="display: none;"><div class="rank-option-modal" style="padding: 4px 10px; border: 2px solid #e5e5ea; border-radius: 6px; font-size: 11px; font-weight: 600; background: white;">åŠ æ²¹é•·</div></label>
              <label class="target-checkbox-modal" style="cursor: pointer;"><input type="checkbox" name="targetRankModal" value="fitter" style="display: none;"><div class="rank-option-modal" style="padding: 4px 10px; border: 2px solid #e5e5ea; border-radius: 6px; font-size: 11px; font-weight: 600; background: white;">éŠ…åŒ </div></label>
              <label class="target-checkbox-modal" style="cursor: pointer;"><input type="checkbox" name="targetRankModal" value="engineCadet" style="display: none;"><div class="rank-option-modal" style="padding: 4px 10px; border: 2px solid #e5e5ea; border-radius: 6px; font-size: 11px; font-weight: 600; background: white;">è¼ªæ©Ÿå¯¦ç¿’ç”Ÿ</div></label>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 24px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray);">é—œéµå­—</label>
            <button type="button" onclick="addMaritimeKeywordModal()" style="border:none; background:none; color:var(--apple-blue); font-weight:600; font-size:12px; cursor:pointer;">+ æ–°å¢</button>
          </div>
          <div id="maritimeKeywordListModal" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 40px; background: rgba(0,0,0,0.03); padding: 8px; border-radius: 8px;"></div>
        </div>

        <div style="display: flex; gap: 12px;">
          <button type="button" onclick="deleteMaritimeCourseFromModal()" class="danger-btn">åˆªé™¤èª²ç¨‹</button>
          <div style="flex: 1;"></div>
          <button type="button" onclick="closeMaritimeCourseModal()" class="secondary-btn">å–æ¶ˆ</button>
          <button type="submit" class="primary-btn">å„²å­˜è®Šæ›´</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ========== æµ·äº‹èª²ç¨‹ç³»çµ± ==========
    let maritimeCourses = [];
    let editingMaritimeCourseId = null;

    const maritimeCategoryNames = {
      '01': 'èˆ¹èˆ¶æ“ç¸±èˆ‡èˆªè¡Œå¯¦å‹™',
      '02': 'é ˜å°çµ±å¾¡èˆ‡æª¢æŸ¥æ‡‰å°',
      '03': 'äº‹æ•…æ¡ˆä¾‹åˆ†æ',
      '04': 'èˆ¹èˆ¶è¨­å‚™æ“ä½œ',
      '05': 'åœ‹éš›æ³•è¦èˆ‡ç’°å¢ƒ',
      '06': 'è²¨ç‰©è£å¸ä½œæ¥­',
      '07': 'èˆ¹å“¡ç¶“é©—äº¤æµ',
      '08': 'è·ç´šè½‰æ›èª¿é©',
      '09': 'å…¶ä»–',
      '10': 'è³‡æ–™åˆ†æ'
    };

    // åˆ‡æ›é é¢
    function switchMaritimeTab(tab) {
      document.getElementById('maritimeViewPage').classList.add('hidden');
      document.getElementById('maritimeAIPage').classList.add('hidden');
      document.getElementById('maritimeEditPage').classList.add('hidden');
      document.getElementById('maritimeStatsPage').classList.add('hidden');
      document.getElementById('courseDetailView').classList.add('hidden');

      document.querySelectorAll('.segment-btn').forEach(btn => btn.classList.remove('active'));

      if (tab === 'view') {
        document.getElementById('maritimeViewPage').classList.remove('hidden');
        document.getElementById('maritimeViewTab').classList.add('active');
        displayMaritimeCourses();
      } else if (tab === 'ai') {
        document.getElementById('maritimeAIPage').classList.remove('hidden');
        document.getElementById('maritimeAITab').classList.add('active');
        // é¦–æ¬¡é€²å…¥æ™‚é¡¯ç¤ºæ­¡è¿è¨Šæ¯
        if (document.getElementById('aiChatMessages').children.length === 0) {
          addAIWelcomeMessage();
        }
      } else if (tab === 'edit') {
        document.getElementById('maritimeEditPage').classList.remove('hidden');
        document.getElementById('maritimeEditTab').classList.add('active');
        displayManageMaritimeCourses();
      } else if (tab === 'stats') {
        document.getElementById('maritimeStatsPage').classList.remove('hidden');
        document.getElementById('maritimeStatsTab').classList.add('active');
        displayMaritimeStats();
      }
    }

    // åˆå§‹åŒ–
    async function initMaritimeCourseSystem() {
      // å…ˆç”¨æœ¬åœ°è³‡æ–™
      maritimeCourses = JSON.parse(localStorage.getItem('maritimeCourses') || '[]');
      displayMaritimeCourses();

      // å¾Œç«¯åŒæ­¥ï¼ˆèƒŒæ™¯ï¼‰
      if (typeof initializeDataSync !== 'undefined') {
        try {
          await initializeDataSync();
          maritimeCourses = JSON.parse(localStorage.getItem('maritimeCourses') || '[]');
          displayMaritimeCourses();
        } catch (err) {
          console.warn('âš ï¸ å¾Œç«¯åŒæ­¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™:', err.message);
        }
      }

      // é©ç”¨å°è±¡ checkbox äº‹ä»¶ç›£è½ï¼ˆæ–°å¢è¡¨å–®ï¼‰
      document.querySelectorAll('#maritimeCourseForm .target-checkbox input').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const option = this.nextElementSibling;
          if (this.checked) {
            option.classList.add('selected');
            if (this.value === 'new') option.classList.add('new');
          } else {
            option.classList.remove('selected', 'new');
          }
        });
      });

      // é©ç”¨å°è±¡ checkbox äº‹ä»¶ç›£è½ï¼ˆç·¨è¼¯æ¨¡æ…‹æ¡†ï¼‰
      document.querySelectorAll('#maritimeCourseModalForm .target-checkbox-modal input').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const option = this.nextElementSibling;
          if (this.checked) {
            option.classList.add('selected');
            if (this.value === 'new') option.classList.add('new');
          } else {
            option.classList.remove('selected', 'new');
          }
        });
      });

      // è¡¨å–®äº‹ä»¶
      document.getElementById('maritimeCourseForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const course = {
          id: Date.now(),
          name: document.getElementById('maritimeCourseName').value,
          category: document.getElementById('maritimeCourseCategory').value,
          method: document.getElementById('maritimeCourseMethod').value,
          description: document.getElementById('maritimeCourseDescription').value,
          keywords: Array.from(document.querySelectorAll('#maritimeKeywordList input')).map(i => i.value.trim()).filter(v => v),
          targetCategories: Array.from(document.querySelectorAll('#maritimeCourseForm input[name="targetCategory"]:checked')).map(i => i.value),
          targetRanks: Array.from(document.querySelectorAll('#maritimeCourseForm input[name="targetRank"]:checked')).map(i => i.value)
        };
        maritimeCourses.push(course);
        await saveMaritimeCourses();
        showMaritimeMessage('âœ“ èª²ç¨‹æ–°å¢æˆåŠŸ', 'success');
        document.getElementById('maritimeCourseForm').reset();
        document.getElementById('maritimeKeywordList').innerHTML = '';
        // æ¸…é™¤ checkbox é¸å–ç‹€æ…‹
        document.querySelectorAll('#maritimeCourseForm .target-option, #maritimeCourseForm .rank-option-new').forEach(o => o.classList.remove('selected', 'new'));
        addMaritimeKeyword();
        displayManageMaritimeCourses();
      });

      document.getElementById('maritimeCancelEdit').addEventListener('click', () => {
        document.getElementById('maritimeCourseForm').reset();
        // æ¸…é™¤ checkbox é¸å–ç‹€æ…‹
        document.querySelectorAll('#maritimeCourseForm .target-option, #maritimeCourseForm .rank-option-new').forEach(o => o.classList.remove('selected', 'new'));
        document.getElementById('maritimeKeywordList').innerHTML = '';
        addMaritimeKeyword();
      });

      addMaritimeKeyword();
    }

    // é¡¯ç¤ºèª²ç¨‹åˆ—è¡¨ï¼ˆé—œéµå­—å„ªå…ˆæœå°‹ + é«˜äº®ï¼‰
    function displayMaritimeCourses() {
      const search = document.getElementById('maritimeSearchInput').value.toLowerCase();
      const catFilter = document.getElementById('maritimeCategoryFilter').value;
      const container = document.getElementById('maritimeCourseResults');

      // æ™ºæ…§åŒ¹é…è¨­å®š
      const smartMatchEnabled = document.getElementById('smartMatchEnabled').checked;
      const smartRank = document.getElementById('smartMatchRank').value;
      const smartCategory = document.getElementById('smartMatchCategory').value;

      let filteredCourses;
      let isKeywordMatch = false;

      if (search) {
        let keywordMatchedCourses = maritimeCourses.filter(course => {
          if (!course || typeof course.name !== 'string') return false;
          const matchesKeyword = Array.isArray(course.keywords)
            ? course.keywords.some(keyword => typeof keyword === 'string' && keyword.toLowerCase().includes(search))
            : false;
          const matchesCategory = !catFilter || course.category === catFilter;
          return matchesKeyword && matchesCategory;
        });

        if (keywordMatchedCourses.length > 0) {
          filteredCourses = keywordMatchedCourses;
          isKeywordMatch = true;
        } else {
          filteredCourses = maritimeCourses.filter(course => {
            if (!course || typeof course.name !== 'string') return false;
            const matchesSearch = course.name.toLowerCase().includes(search) ||
              (course.description && typeof course.description === 'string' ? course.description.toLowerCase().includes(search) : false);
            const matchesCategory = !catFilter || course.category === catFilter;
            return matchesSearch && matchesCategory;
          });
        }
      } else {
        filteredCourses = maritimeCourses.filter(course => {
          if (!course) return false;
          return !catFilter || course.category === catFilter;
        });
      }

      // æ™ºæ…§åŒ¹é…æ’åº
      if (smartMatchEnabled && (smartRank || smartCategory)) {
        const searchKeywords = search ? search.split(/\s+/).filter(k => k) : [];
        const scored = filteredCourses.map(course => {
          let score = 0;
          // è·ç­‰åŒ¹é…ï¼ˆæ¬Šé‡ 40ï¼‰
          if (smartRank && Array.isArray(course.targetRanks) && course.targetRanks.includes(smartRank)) {
            score += 40;
          }
          // äººå“¡é¡åˆ¥åŒ¹é…ï¼ˆæ¬Šé‡ 20ï¼‰
          if (smartCategory && Array.isArray(course.targetCategories) && course.targetCategories.includes(smartCategory)) {
            score += 20;
          }
          // æœå°‹é—œéµå­—åŒ¹é…åŠ åˆ†ï¼ˆæ¬Šé‡ 30ï¼‰
          if (searchKeywords.length > 0 && Array.isArray(course.keywords)) {
            const matchCount = searchKeywords.filter(sk =>
              course.keywords.some(ck => typeof ck === 'string' && ck.toLowerCase().includes(sk))
            ).length;
            score += Math.round((matchCount / searchKeywords.length) * 30);
          }
          // å…§å®¹å“è³ªåŠ åˆ†
          if (course.description && course.description.length > 20) score += 5;
          if (Array.isArray(course.keywords) && course.keywords.length > 0) score += 5;
          return { ...course, matchScore: score };
        });
        scored.sort((a, b) => b.matchScore - a.matchScore);
        filteredCourses = scored;
      }

      if (filteredCourses.length === 0) {
        container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#86868b; padding:40px;">æ²’æœ‰æ‰¾åˆ°ç›¸é—œèª²ç¨‹</div>';
        return;
      }

      let html = '';
      if (isKeywordMatch && search) {
        html += `<div style="grid-column: 1 / -1; padding: 16px; background: linear-gradient(135deg, #e6f3ff 0%, #f0f5ff 100%); border-radius: 12px; margin-bottom: 16px; text-align: center; border: 1px solid #007aff30;">
          <span style="color: #007aff; font-weight: 600;">æ‰¾åˆ° ${filteredCourses.length} å€‹ç¬¦åˆé—œéµå­—ã€Œ${search}ã€çš„èª²ç¨‹</span>
        </div>`;
      }

      if (smartMatchEnabled && (smartRank || smartCategory) && filteredCourses.some(c => c.matchScore > 0)) {
        const matchCount = filteredCourses.filter(c => c.matchScore > 0).length;
        html += `<div style="grid-column: 1 / -1; padding: 16px; background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); border-radius: 12px; margin-bottom: 16px; text-align: center; border: 1px solid #ddd6fe;">
          <span style="color: #7c3aed; font-weight: 600;"><i class="ph ph-magic-wand"></i> æ™ºæ…§åŒ¹é…ï¼š${matchCount} é–€èª²ç¨‹ç¬¦åˆæ¢ä»¶ï¼Œå·²ä¾åŒ¹é…åº¦æ’åº</span>
        </div>`;
      }

      html += filteredCourses.map((c, index) => {
        let badgeColor = 'badge-blue';
        if (c.method === 'ç·šä¸Šèª²ç¨‹') badgeColor = 'badge-green';
        if (c.method === 'æ··åˆèª²ç¨‹') badgeColor = 'badge-orange';

        const scoreHtml = (smartMatchEnabled && c.matchScore !== undefined && c.matchScore > 0)
          ? `<span style="background:linear-gradient(135deg, #7c3aed, #6d28d9); color:white; padding:4px 10px; border-radius:12px; font-size:11px; font-weight:700;">åŒ¹é… ${c.matchScore}%</span>`
          : '';

        return `
          <div class="course-card" draggable="true" data-course-id="${c.id}" data-index="${index}" onclick="onCourseCardClick(event, ${c.id})">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
              <div style="display:flex; align-items:center; gap:8px;">
                <span class="drag-handle" onmousedown="event.stopPropagation()">
                  <i class="ph ph-dots-six-vertical" style="font-size:20px;"></i>
                </span>
                <span class="badge ${badgeColor}">${c.method || 'æœªè¨­å®š'}</span>
              </div>
              <span style="
                background: rgba(139, 92, 246, 0.15);
                color: #7c3aed;
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
              ">${maritimeCategoryNames[c.category] || c.category}</span>
              ${scoreHtml}
            </div>
            <div class="course-title" style="
              display: -webkit-box;
              -webkit-line-clamp: 2;
              -webkit-box-orient: vertical;
              overflow: hidden;
              text-overflow: ellipsis;
              line-height: 1.4;
              max-height: 2.8em;
            ">${highlightMaritimeText(c.name, search)}</div>
            <div style="
              font-size:14px;
              color:#86868b;
              margin-bottom:20px;
              line-height:1.6;
              display: -webkit-box;
              -webkit-line-clamp: 2;
              -webkit-box-orient: vertical;
              overflow: hidden;
              text-overflow: ellipsis;
              max-height: 3.2em;
            ">
              ${highlightMaritimeText(c.description || 'ç„¡æè¿°', search)}
            </div>
            <div style="
              display:flex;
              gap:6px;
              flex-wrap:wrap;
              max-height: 3.2em;
              overflow: hidden;
            ">
              ${(c.keywords || []).map(k =>
                `<span style="font-size:11px; padding:4px 10px; background:rgba(0,0,0,0.05); color:#86868b; border-radius:6px;">#${highlightMaritimeText(k, search)}</span>`
              ).join('')}
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;

      // ç‚ºæ‰€æœ‰å¡ç‰‡æ·»åŠ æ‹–æ”¾äº‹ä»¶ç›£è½å™¨
      const cards = container.querySelectorAll('.course-card');
      cards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('drop', handleDrop);
        card.addEventListener('dragend', handleDragEnd);
        card.addEventListener('dragleave', handleDragLeave);
      });
    }

    // æ‹–æ”¾è®Šé‡
    let draggedCard = null;
    let isDragging = false;

    // è™•ç†å¡ç‰‡é»æ“Šï¼ˆå€åˆ†æ‹–å‹•å’Œæ™®é€šé»æ“Šï¼‰
    function onCourseCardClick(event, courseId) {
      if (!isDragging) {
        viewCourseDetail(courseId);
      }
    }

    // æ‹–å‹•é–‹å§‹
    function handleDragStart(e) {
      isDragging = true;
      draggedCard = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
    }

    // æ‹–å‹•ç¶“é
    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = 'move';

      const afterElement = getDragAfterElement(this.parentElement, e.clientY);
      const dragging = document.querySelector('.dragging');

      if (afterElement == null) {
        this.parentElement.appendChild(dragging);
      } else {
        this.parentElement.insertBefore(dragging, afterElement);
      }

      return false;
    }

    // æ”¾ä¸‹
    function handleDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }

      if (draggedCard !== this) {
        // ç²å–æ‰€æœ‰å¡ç‰‡çš„æ–°é †åº
        const container = document.getElementById('maritimeCourseResults');
        const cards = Array.from(container.querySelectorAll('.course-card'));
        const newOrder = cards.map(card => parseInt(card.dataset.courseId));

        // é‡æ–°æ’åˆ— maritimeCourses é™£åˆ—
        const reorderedCourses = newOrder.map(id =>
          maritimeCourses.find(c => c.id === id)
        ).filter(c => c !== undefined);

        // ä¿ç•™æœªåœ¨é¡¯ç¤ºåˆ—è¡¨ä¸­çš„èª²ç¨‹
        const displayedIds = new Set(newOrder);
        const hiddenCourses = maritimeCourses.filter(c => !displayedIds.has(c.id));

        maritimeCourses = [...reorderedCourses, ...hiddenCourses];
        saveMaritimeCourses();
      }

      return false;
    }

    // æ‹–å‹•çµæŸ
    function handleDragEnd(e) {
      setTimeout(() => {
        isDragging = false;
      }, 100);

      this.classList.remove('dragging');

      const cards = document.querySelectorAll('.course-card');
      cards.forEach(card => {
        card.classList.remove('drag-over');
      });
    }

    // é›¢é–‹æ‹–å‹•å€åŸŸ
    function handleDragLeave(e) {
      this.classList.remove('drag-over');
    }

    // ç²å–æ‹–å‹•å¾Œçš„ä½ç½®
    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.course-card:not(.dragging)')];

      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;

        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function highlightMaritimeText(text, searchTerm) {
      if (!searchTerm) return text;
      const regex = new RegExp(`(${searchTerm})`, 'gi');
      return text.replace(regex, '<span class="highlight">$1</span>');
    }

    // é¡¯ç¤ºç®¡ç†åˆ—è¡¨
    function displayManageMaritimeCourses() {
      const search = document.getElementById('maritimeManageSearchInput').value.toLowerCase();
      const container = document.getElementById('maritimeManageCourseList');

      const filtered = maritimeCourses.filter(course => {
        if (!course || typeof course.name !== 'string') return false;
        const matchName = course.name.toLowerCase().includes(search);
        const matchDescription = course.description && typeof course.description === 'string'
          ? course.description.toLowerCase().includes(search) : false;
        const matchKeywords = Array.isArray(course.keywords)
          ? course.keywords.some(keyword => typeof keyword === 'string' && keyword.toLowerCase().includes(search)) : false;
        return matchName || matchDescription || matchKeywords;
      });

      if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 32px 0; color: #6e6e73;">æ²’æœ‰æ‰¾åˆ°èª²ç¨‹</div>';
        return;
      }

      container.innerHTML = filtered.map(c => `
        <div style="background:white; padding:16px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
          <div>
            <div style="font-weight:600; font-size:15px;">${c.name}</div>
            <div style="font-size:12px; color:#86868b;">${maritimeCategoryNames[c.category] || c.category}</div>
          </div>
          <button onclick="editMaritimeCourse(${c.id})" class="secondary-btn" style="padding:6px 16px; font-size:13px;">ç·¨è¼¯</button>
        </div>
      `).join('');
    }

    // æ–°å¢é—œéµå­—
    function addMaritimeKeyword(val = '') {
      createKeywordTag(document.getElementById('maritimeKeywordList'), val);
    }

    function addMaritimeKeywordModal(val = '') {
      createKeywordTag(document.getElementById('maritimeKeywordListModal'), val);
    }

    function createKeywordTag(container, val) {
      const div = document.createElement('div');
      div.className = 'keyword-tag-input';
      div.innerHTML = `
        <input type="text" value="${val}" placeholder="é—œéµå­—">
        <span class="remove-btn" onclick="this.parentElement.remove()">Ã—</span>
      `;
      container.appendChild(div);
    }

    // æª¢è¦–èª²ç¨‹è©³æƒ…
    function viewCourseDetail(courseId) {
      const course = maritimeCourses.find(c => c.id === courseId);
      if (!course) return;

      // éš±è—èª²ç¨‹åˆ—è¡¨ï¼Œé¡¯ç¤ºè©³æƒ…é é¢
      document.getElementById('maritimeViewPage').querySelector('.glass-panel').classList.add('hidden');
      document.getElementById('maritimeCourseResults').classList.add('hidden');
      document.getElementById('courseDetailView').classList.remove('hidden');

      const categoryName = maritimeCategoryNames[course.category] || course.category;
      const keywordCount = (course.keywords || []).length;

      // æˆèª²æ–¹å¼åœ–æ¨™å’Œé¡è‰²
      const methodConfig = {
        'å¯¦é«”èª²ç¨‹': { icon: 'ph-buildings', color: '#3b82f6', bgColor: '#eff6ff', borderColor: '#dbeafe' },
        'ç·šä¸Šèª²ç¨‹': { icon: 'ph-laptop', color: '#10b981', bgColor: '#ecfdf5', borderColor: '#d1fae5' },
        'æ··åˆèª²ç¨‹': { icon: 'ph-arrows-clockwise', color: '#10b981', bgColor: '#ecfdf5', borderColor: '#d1fae5' }
      };
      const method = methodConfig[course.method] || methodConfig['å¯¦é«”èª²ç¨‹'];

      // åˆ†é¡åœ–æ¨™
      const categoryIcons = {
        '01': 'ph-anchor', '02': 'ph-users-three', '03': 'ph-warning-circle',
        '04': 'ph-gear', '05': 'ph-globe', '06': 'ph-package',
        '07': 'ph-chat-circle-dots', '08': 'ph-arrow-u-up-left', '09': 'ph-dots-three'
      };
      const catIcon = categoryIcons[course.category] || 'ph-folder';

      const content = document.getElementById('courseDetailContent');
      content.innerHTML = `
        <div class="course-detail-layout">
          <!-- å·¦å´ä¸»å…§å®¹ -->
          <div class="course-detail-main">

            <!-- æ¨™é¡Œå¡ç‰‡ -->
            <div class="detail-card detail-header-card">
              <div class="header-card-decoration">
                <i class="ph ph-book-open"></i>
              </div>

              <div class="header-card-badges">
                <span class="header-badge header-badge-blue">
                  <i class="ph ${method.icon}"></i>
                  ${course.method || 'æœªè¨­å®š'}
                </span>
                <span class="header-badge header-badge-indigo">
                  <i class="ph ph-globe"></i>
                  ${course.category} ${categoryName}
                </span>
              </div>

              <h1 class="header-card-title">${course.name}</h1>

              <div class="header-card-meta">
                <span><i class="ph ph-calendar-blank"></i> å»ºç«‹æ–¼ ${new Date(course.id).toLocaleDateString('zh-TW')}</span>
                <span><i class="ph ph-tag"></i> ${keywordCount} å€‹é—œéµå­—</span>
              </div>
            </div>

            <!-- èª²ç¨‹æè¿°å¡ç‰‡ -->
            <div class="detail-card">
              <div class="detail-card-header">
                <div class="detail-card-icon detail-card-icon-blue">
                  <i class="ph ph-clipboard-text"></i>
                </div>
                <h2 class="detail-card-title">èª²ç¨‹è©³ç´°æè¿°</h2>
              </div>

              <div class="detail-card-body">
                ${course.description ? `
                  <div class="description-content">
                    ${course.description.replace(/\n/g, '<br>')}
                  </div>
                ` : `
                  <div class="empty-state">
                    <i class="ph ph-note-pencil"></i>
                    <p>å°šæœªå¡«å¯«èª²ç¨‹æè¿°</p>
                  </div>
                `}
              </div>
            </div>

            <!-- é—œéµå­—æ¨™ç±¤å¡ç‰‡ -->
            <div class="detail-card">
              <div class="detail-card-header-flex">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div class="detail-card-icon detail-card-icon-orange">
                    <i class="ph ph-hash"></i>
                  </div>
                  <h2 class="detail-card-title">é—œéµå­—æ¨™ç±¤</h2>
                </div>
                <span class="keyword-count-badge">å…± ${keywordCount} å€‹æ¨™ç±¤</span>
              </div>

              <div class="detail-card-body">
                ${(course.keywords && course.keywords.length > 0) ? `
                  <div class="keyword-tags-grid">
                    ${course.keywords.map(keyword => `
                      <span class="keyword-tag-item"># ${keyword}</span>
                    `).join('')}
                  </div>
                ` : `
                  <div class="empty-state">
                    <i class="ph ph-tag"></i>
                    <p>å°šæœªè¨­å®šé—œéµå­—</p>
                  </div>
                `}
              </div>
            </div>
          </div>

          <!-- å³å´å´é‚Šæ¬„ -->
          <div class="course-detail-sidebar">

            <!-- æ ¸å¿ƒå±¬æ€§å¡ç‰‡ -->
            <div class="detail-card sidebar-card">
              <!-- èª²ç¨‹åˆ†é¡ -->
              <div class="sidebar-section">
                <h3 class="sidebar-section-title">
                  <span class="sidebar-dot sidebar-dot-indigo"></span>
                  èª²ç¨‹åˆ†é¡
                </h3>
                <div class="sidebar-info-box sidebar-info-box-indigo">
                  <div class="sidebar-info-icon">
                    <i class="ph ${catIcon}"></i>
                  </div>
                  <span class="sidebar-info-main">${categoryName}</span>
                  <span class="sidebar-info-sub">IDENTIFIER: ${course.category}</span>
                </div>
              </div>

              <!-- æˆèª²æ–¹å¼ -->
              <div class="sidebar-section">
                <h3 class="sidebar-section-title">
                  <span class="sidebar-dot sidebar-dot-emerald"></span>
                  æˆèª²æ–¹å¼
                </h3>
                <div class="sidebar-info-box sidebar-info-box-emerald">
                  <div class="sidebar-info-icon sidebar-info-icon-emerald">
                    <i class="ph ${method.icon}"></i>
                  </div>
                  <span class="sidebar-info-main">${course.method || 'æœªè¨­å®š'}</span>
                  <span class="sidebar-info-sub">${getMethodDescription(course.method)}</span>
                </div>
              </div>
            </div>

            <!-- é©ç”¨å°è±¡å¡ç‰‡ -->
            <div class="detail-card sidebar-card">
              <h3 class="sidebar-section-title">
                <span class="sidebar-dot sidebar-dot-purple"></span>
                é©ç”¨å°è±¡
              </h3>

              ${((course.targetCategories && course.targetCategories.length > 0) || (course.targetRanks && course.targetRanks.length > 0)) ? `
                <div class="target-audience-content">
                  ${(course.targetCategories && course.targetCategories.length > 0) ? `
                    <div class="target-section">
                      <div class="target-section-label">äººå“¡é¡åˆ¥</div>
                      <div class="target-badges">
                        ${course.targetCategories.map(cat => `
                          <span class="target-badge ${cat === 'existing' ? 'target-badge-blue' : 'target-badge-green'}">
                            <i class="ph ${cat === 'existing' ? 'ph-check-circle' : 'ph-user-plus'}"></i>
                            ${cat === 'existing' ? 'ç¾æœ‰èˆ¹å“¡' : 'æ–°é€²èˆ¹å“¡'}
                          </span>
                        `).join('')}
                      </div>
                    </div>
                  ` : ''}
                  ${(course.targetRanks && course.targetRanks.length > 0) ? `
                    <div class="target-section">
                      <div class="target-section-label">é©ç”¨è·ç­‰</div>
                      <div class="target-badges">
                        ${course.targetRanks.map(rank => `
                          <span class="target-badge target-badge-purple">${getRankDisplayName(rank)}</span>
                        `).join('')}
                      </div>
                    </div>
                  ` : ''}
                </div>
              ` : `
                <div class="empty-state-sidebar">
                  <div class="empty-state-sidebar-icon">
                    <i class="ph ph-users"></i>
                  </div>
                  <p>å°šæœªè¨­å®šç‰¹å®šå°è±¡</p>
                  <button onclick="editMaritimeCourse(${course.id})" class="empty-state-btn">å‰å¾€è¨­å®š</button>
                </div>
              `}
            </div>

            <!-- æ“ä½œæŒ‰éˆ•çµ„ -->
            <div class="sidebar-actions">
              <button onclick="editMaritimeCourse(${course.id})" class="action-btn action-btn-primary">
                <i class="ph ph-pencil-simple"></i>
                ç·¨è¼¯èª²ç¨‹è³‡æ–™
              </button>
              <button onclick="backToCourseList()" class="action-btn action-btn-secondary">
                <i class="ph ph-arrow-left"></i>
                è¿”å›èª²ç¨‹åˆ—è¡¨
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // è¿”å›èª²ç¨‹åˆ—è¡¨
    function backToCourseList() {
      document.getElementById('courseDetailView').classList.add('hidden');
      document.getElementById('maritimeViewPage').querySelector('.glass-panel').classList.remove('hidden');
      document.getElementById('maritimeCourseResults').classList.remove('hidden');
    }

    // å–å¾—åˆ†é¡åœ–ç¤º
    function getCategoryIcon(category) {
      const icons = {
        '01': '<i class="ph ph-anchor"></i>',
        '02': '<i class="ph ph-users-three"></i>',
        '03': '<i class="ph ph-warning-circle"></i>',
        '04': '<i class="ph ph-gear"></i>',
        '05': '<i class="ph ph-scales"></i>',
        '06': '<i class="ph ph-package"></i>',
        '07': '<i class="ph ph-chat-circle-dots"></i>',
        '08': '<i class="ph ph-arrow-u-up-left"></i>',
        '09': '<i class="ph ph-dots-three"></i>'
      };
      return icons[category] || '<i class="ph ph-folder"></i>';
    }

    // å–å¾—æˆèª²æ–¹å¼èƒŒæ™¯è‰²
    function getMethodBackground(method) {
      const backgrounds = {
        'å¯¦é«”èª²ç¨‹': 'linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)',
        'ç·šä¸Šèª²ç¨‹': 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)',
        'æ··åˆèª²ç¨‹': 'linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)'
      };
      return backgrounds[method] || 'linear-gradient(135deg, #f5f5f7 0%, #e5e5ea 100%)';
    }

    // å–å¾—æˆèª²æ–¹å¼èªªæ˜
    function getMethodDescription(method) {
      const descriptions = {
        'å¯¦é«”èª²ç¨‹': 'é¢å°é¢èª²å ‚æ•™å­¸ï¼Œäº’å‹•æ€§å¼·',
        'ç·šä¸Šèª²ç¨‹': 'é è·ç·šä¸Šæˆèª²ï¼Œæ™‚é–“å½ˆæ€§',
        'æ··åˆèª²ç¨‹': 'çµåˆå¯¦é«”èˆ‡ç·šä¸Šçš„æ··åˆå¼æ•™å­¸'
      };
      return descriptions[method] || 'æˆèª²æ–¹å¼å¾…å®š';
    }

    // å–å¾—è·ç­‰é¡¯ç¤ºåç¨±
    function getRankDisplayName(rank) {
      const rankNames = {
        'C/P': 'C/P èˆ¹é•·',
        'C/O': 'C/O å¤§å‰¯',
        '2/O': '2/O äºŒå‰¯',
        '3/O': '3/O ä¸‰å‰¯',
        'bosun': 'æ°´æ‰‹é•·',
        'carpenter': 'æœ¨åŒ ',
        'AB': 'å¹¹ç·´æ°´æ‰‹',
        'deckCadet': 'ç”²æ¿å¯¦ç¿’ç”Ÿ',
        'C/E': 'C/E è¼ªæ©Ÿé•·',
        '2/E': '2/E å¤§ç®¡',
        '3/E': '3/E 2ç®¡',
        '4/E': '4/E 3ç®¡',
        'oiler': 'åŠ æ²¹é•·',
        'fitter': 'éŠ…åŒ ',
        'engineCadet': 'è¼ªæ©Ÿå¯¦ç¿’ç”Ÿ'
      };
      return rankNames[rank] || rank;
    }

    // ç·¨è¼¯èª²ç¨‹
    function editMaritimeCourse(id) {
      editingMaritimeCourseId = id;
      const c = maritimeCourses.find(x => x.id === id);
      if (!c) return;

      document.getElementById('maritimeCourseNameModal').value = c.name;
      document.getElementById('maritimeCourseCategoryModal').value = c.category;
      document.getElementById('maritimeCourseMethodModal').value = c.method;
      document.getElementById('maritimeCourseDescriptionModal').value = c.description;

      const list = document.getElementById('maritimeKeywordListModal');
      list.innerHTML = '';
      if (c.keywords && c.keywords.length > 0) {
        c.keywords.forEach(k => addMaritimeKeywordModal(k));
      } else {
        addMaritimeKeywordModal();
      }

      // è¨­å®šé©ç”¨å°è±¡é¸å–ç‹€æ…‹
      // å…ˆæ¸…é™¤æ‰€æœ‰é¸å–
      document.querySelectorAll('#maritimeCourseModalForm .target-option-modal, #maritimeCourseModalForm .rank-option-modal').forEach(o => o.classList.remove('selected', 'new'));
      document.querySelectorAll('#maritimeCourseModalForm input[name="targetCategoryModal"], #maritimeCourseModalForm input[name="targetRankModal"]').forEach(i => i.checked = false);

      // è¨­å®šäººå“¡é¡åˆ¥
      if (c.targetCategories && c.targetCategories.length > 0) {
        c.targetCategories.forEach(cat => {
          const checkbox = document.querySelector(`#maritimeCourseModalForm input[name="targetCategoryModal"][value="${cat}"]`);
          if (checkbox) {
            checkbox.checked = true;
            checkbox.nextElementSibling.classList.add('selected');
            if (cat === 'new') checkbox.nextElementSibling.classList.add('new');
          }
        });
      }

      // è¨­å®šè·ç­‰
      if (c.targetRanks && c.targetRanks.length > 0) {
        c.targetRanks.forEach(rank => {
          const checkbox = document.querySelector(`#maritimeCourseModalForm input[name="targetRankModal"][value="${rank}"]`);
          if (checkbox) {
            checkbox.checked = true;
            checkbox.nextElementSibling.classList.add('selected');
          }
        });
      }

      document.getElementById('maritimeCourseModal').classList.add('show');
    }

    function closeMaritimeCourseModal() {
      document.getElementById('maritimeCourseModal').classList.remove('show');
      editingMaritimeCourseId = null;
    }

    async function saveMaritimeCourseFromModal(e) {
      e.preventDefault();
      const newData = {
        name: document.getElementById('maritimeCourseNameModal').value,
        category: document.getElementById('maritimeCourseCategoryModal').value,
        method: document.getElementById('maritimeCourseMethodModal').value,
        description: document.getElementById('maritimeCourseDescriptionModal').value,
        keywords: Array.from(document.querySelectorAll('#maritimeKeywordListModal input')).map(i => i.value.trim()).filter(v => v),
        targetCategories: Array.from(document.querySelectorAll('#maritimeCourseModalForm input[name="targetCategoryModal"]:checked')).map(i => i.value),
        targetRanks: Array.from(document.querySelectorAll('#maritimeCourseModalForm input[name="targetRankModal"]:checked')).map(i => i.value)
      };

      const idx = maritimeCourses.findIndex(x => x.id === editingMaritimeCourseId);
      if (idx >= 0) {
        maritimeCourses[idx] = { ...maritimeCourses[idx], ...newData };
        await saveMaritimeCourses();
        showMaritimeMessage('âœ“ èª²ç¨‹æ›´æ–°æˆåŠŸ', 'success');
        closeMaritimeCourseModal();
        displayMaritimeCourses();
        displayManageMaritimeCourses();
      }
    }

    async function deleteMaritimeCourseFromModal() {
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹èª²ç¨‹å—ï¼Ÿ')) {
        maritimeCourses = maritimeCourses.filter(x => x.id !== editingMaritimeCourseId);
        await saveMaritimeCourses();
        showMaritimeMessage('âœ“ èª²ç¨‹å·²åˆªé™¤', 'success');
        closeMaritimeCourseModal();
        displayMaritimeCourses();
        displayManageMaritimeCourses();
      }
    }

    // å„²å­˜ï¼ˆå«è¡çªæª¢æŸ¥ï¼‰
    async function saveMaritimeCourses() {
      localStorage.setItem('maritimeCourses', JSON.stringify(maritimeCourses));

      if (typeof syncManager !== 'undefined') {
        syncManager.markAsChanged();
        const result = await syncManager.saveToBackendSafe();
        if (result.conflict) {
          showConflictDialog(result);
        }
      } else if (typeof api !== 'undefined') {
        await api.save('maritimeCourses', maritimeCourses);
      }
    }

    // çµ±è¨ˆåˆ†æ - å¾çœŸå¯¦è³‡æ–™è¨ˆç®—
    function displayMaritimeStats() {
      // å¾çœŸå¯¦çš„ maritimeCourses è¨ˆç®—çµ±è¨ˆ
      const totalCourses = maritimeCourses.length;

      // å®šç¾©åˆ†é¡åç¨±å’Œé¡è‰²
      const categoryNames = {
        '01': { name: 'èˆ¹èˆ¶æ“ç¸±èˆ‡èˆªè¡Œå¯¦å‹™è¨“ç·´', color: '#4f46e5' },
        '02': { name: 'é ˜å°çµ±å¾¡èˆ‡æª¢æŸ¥æ‡‰å°ç®¡ç†', color: '#06b6d4' },
        '03': { name: 'äº‹æ•…æ¡ˆä¾‹åˆ†æèˆ‡æ‡‰è®Šè™•ç½®è¨“ç·´', color: '#10b981' },
        '04': { name: 'èˆ¹èˆ¶è¨­å‚™æ“ä½œèˆ‡æŠ€è¡“çŸ¥èƒ½è¨“ç·´', color: '#f59e0b' },
        '05': { name: 'åœ‹éš›æ³•è¦èˆ‡ç’°å¢ƒåˆè¦çŸ¥è­˜', color: '#ef4444' },
        '06': { name: 'èˆ¹èˆ¶è²¨ç‰©è£å¸ä½œæ¥­å¯¦å‹™', color: '#8b5cf6' },
        '07': { name: 'èˆ¹å“¡ç¶“é©—äº¤æµèˆ‡è·èƒ½å›é¥‹', color: '#f97316' },
        '08': { name: 'è·ç´šè½‰æ›èˆ‡å£“åŠ›èª¿é©', color: '#84cc16' },
        '09': { name: 'å…¶ä»–', color: '#ec4899' },
        '10': { name: 'è³‡æ–™åˆ†æ', color: '#0ea5e9' }
      };

      // çµ±è¨ˆæ¯å€‹åˆ†é¡çš„èª²ç¨‹æ•¸é‡
      const categoryCounts = {};
      maritimeCourses.forEach(course => {
        const cat = course.category || '09';
        categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
      });

      // å»ºç«‹å®Œæ•´çš„ categories ç‰©ä»¶
      const categories = {};
      Object.keys(categoryNames).forEach(code => {
        categories[code] = {
          ...categoryNames[code],
          count: categoryCounts[code] || 0
        };
      });

      // æ‰¾å‡ºæœ€ç†±é–€çš„åˆ†é¡
      let popularCategory = '09å…¶ä»–';
      let maxCount = 0;
      Object.entries(categories).forEach(([code, cat]) => {
        if (cat.count > maxCount) {
          maxCount = cat.count;
          popularCategory = code + cat.name;
        }
      });

      // çµ±è¨ˆé—œéµå­—
      const keywordCounts = {};
      maritimeCourses.forEach(course => {
        if (Array.isArray(course.keywords)) {
          course.keywords.forEach(keyword => {
            const kw = keyword.trim();
            if (kw) {
              keywordCounts[kw] = (keywordCounts[kw] || 0) + 1;
            }
          });
        }
      });

      // è½‰æ›ç‚ºé™£åˆ—ä¸¦æŒ‰å‡ºç¾æ¬¡æ•¸æ’åº
      const keywords = Object.entries(keywordCounts)
        .map(([text, count]) => ({ text, count }))
        .sort((a, b) => b.count - a.count);

      const totalKeywords = keywords.length;

      // çµ±è¨ˆæˆèª²æ–¹å¼
      const methodCounts = {};
      maritimeCourses.forEach(course => {
        const method = course.method || 'æœªè¨­å®š';
        methodCounts[method] = (methodCounts[method] || 0) + 1;
      });

      const methods = {};
      Object.entries(methodCounts).forEach(([method, count]) => {
        methods[method] = {
          count,
          percentage: totalCourses > 0 ? ((count / totalCourses) * 100).toFixed(1) : 0
        };
      });

      // é ‚éƒ¨çµ±è¨ˆå¡ç‰‡
      document.getElementById('maritimeTotalCourses').innerText = totalCourses;
      document.getElementById('maritimeTotalKeywords').innerText = totalKeywords;
      document.getElementById('maritimePopularCategory').innerText = popularCategory;

      // åˆ†é¡çµ±è¨ˆ - æ¢ç‹€åœ–
      const catHtml = Object.keys(categories).map(code => {
        const cat = categories[code];
        const percentage = totalCourses > 0 ? (cat.count / totalCourses) * 100 : 0;
        return `
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <div style="font-size:12px; width:140px; color: #1d1d1f;">${code} ${cat.name}</div>
            <div style="flex:1; background:#e5e5ea; height:8px; border-radius:4px; overflow: hidden;">
              <div style="width:${percentage}%; background:${cat.color}; height:100%; border-radius:4px; transition: width 0.3s;"></div>
            </div>
            <div style="font-size:13px; font-weight:600; width:30px; text-align:right;">${cat.count}</div>
          </div>
        `;
      }).join('');
      document.getElementById('maritimeCategoryStats').innerHTML = catHtml;

      // åœ“é¤…åœ–è§’åº¦è¨ˆç®— (åªé¡¯ç¤ºæœ‰èª²ç¨‹çš„åˆ†é¡)
      const activeCategories = Object.keys(categories).filter(code => categories[code].count > 0);
      let currentAngle = 0;
      const pieChart = document.getElementById('maritimePieChart');

      activeCategories.forEach((code, index) => {
        const cat = categories[code];
        const percentage = totalCourses > 0 ? (cat.count / totalCourses) * 360 : 0;
        currentAngle += percentage;
        pieChart.style.setProperty(`--angle${parseInt(code)}`, `${currentAngle}deg`);
      });

      // åœ“é¤…åœ–åœ–ä¾‹
      const legend = document.getElementById('maritimeChartLegend');
      legend.innerHTML = activeCategories.map(code => {
        const cat = categories[code];
        const percentage = totalCourses > 0 ? ((cat.count / totalCourses) * 100).toFixed(1) : 0;
        return `
          <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; transition: background 0.2s;">
            <div style="width: 14px; height: 14px; border-radius: 50%; background: ${cat.color}; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);"></div>
            <div style="flex: 1; font-size: 13px;">${cat.name}</div>
            <div style="font-size: 12px; color: #86868b;">${cat.count} é–€èª²ç¨‹ (${percentage}%)</div>
          </div>
        `;
      }).join('');

      // æˆèª²æ–¹å¼çµ±è¨ˆ
      const methodColors = { å¯¦é«”èª²ç¨‹: '#3b82f6', ç·šä¸Šèª²ç¨‹: '#10b981', æ··åˆèª²ç¨‹: '#f59e0b', æœªè¨­å®š: '#6b7280' };
      const methodIcons = { å¯¦é«”èª²ç¨‹: '<i class="ph ph-buildings"></i>', ç·šä¸Šèª²ç¨‹: '<i class="ph ph-laptop"></i>', æ··åˆèª²ç¨‹: '<i class="ph ph-arrows-clockwise"></i>', æœªè¨­å®š: '<i class="ph ph-question"></i>' };

      document.getElementById('maritimeMethodStats').innerHTML = Object.entries(methods).map(([method, data]) => {
        const angle = totalCourses > 0 ? (data.count / totalCourses) * 360 : 0;
        return `
          <div class="method-card">
            <div class="donut-chart" style="--color: ${methodColors[method] || '#6b7280'}; --angle: ${angle}deg; margin: 0 auto 16px;">
              <div class="donut-chart-label">${data.count}</div>
            </div>
            <div style="font-size: 32px; margin-bottom: 8px;">${methodIcons[method] || '<i class="ph ph-question"></i>'}</div>
            <h4 style="font-weight: 600; color: #1d1d1f; margin-bottom: 4px;">${method}</h4>
            <p style="font-size: 13px; color: #6e6e73;">${data.percentage}% çš„èª²ç¨‹</p>
            <p style="font-size: 12px; color: #86868b; margin-top: 4px;">å…± ${data.count} é–€èª²ç¨‹</p>
          </div>
        `;
      }).join('');

      // ç†±é–€é—œéµå­— - å¾çœŸå¯¦è³‡æ–™è¨ˆç®—
      if (keywords.length > 0) {
        document.getElementById('maritimeKeywordsCloud').innerHTML = keywords.map(kw => `
          <div style="
            background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
            color: white;
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 122, 255, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 122, 255, 0.3)'">
            <span>${kw.text}</span>
            <span style="
              background: rgba(255, 255, 255, 0.25);
              padding: 2px 8px;
              border-radius: 8px;
              font-size: 12px;
              font-weight: 600;
            ">${kw.count}</span>
          </div>
        `).join('');
      } else {
        document.getElementById('maritimeKeywordsCloud').innerHTML = '<div style="text-align: center; color: #86868b; padding: 20px;">å°šç„¡é—œéµå­—è³‡æ–™</div>';
      }
    }

    // è¨Šæ¯æç¤º
    function showMaritimeMessage(message, type = 'info') {
      const div = document.createElement('div');
      div.style.cssText = `
        position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 12px;
        color: white; z-index: 10000; font-size: 14px; font-weight: 600;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15); animation: slideIn 0.3s ease;
        background: ${type === 'success' ? 'linear-gradient(135deg, #34c759 0%, #248a3d 100%)' : 'linear-gradient(135deg, #007aff 0%, #0051d5 100%)'};
      `;
      div.textContent = message;
      document.body.appendChild(div);

      setTimeout(() => {
        div.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => div.remove(), 300);
      }, 3000);
    }

    // è¡çªå°è©±æ¡†
    function showConflictDialog(result) {
      const conflicts = result.conflicts || [];
      const tableNames = {
        'teachers': 'æ•™å¸«è³‡æ–™',
        'courseAssignments': 'èª²ç¨‹å®‰æ’',
        'maritimeCourses': 'æµ·äº‹èª²ç¨‹'
      };

      let conflictDetailsHTML = '';
      if (conflicts.length > 0) {
        conflictDetailsHTML = '<div style="margin: 10px 0; padding: 10px; background: #fef3c7; border-radius: 6px; font-size: 13px;"><strong>åµæ¸¬åˆ°è®Šæ›´ï¼š</strong><ul style="margin: 5px 0; padding-left: 18px;">';
        conflicts.forEach(c => {
          const name = tableNames[c.table] || c.table;
          conflictDetailsHTML += `<li>${name}: ${c.savedCount} â†’ ${c.currentCount} ç­†</li>`;
        });
        conflictDetailsHTML += '</ul></div>';
      }

      const div = document.createElement('div');
      div.className = 'modal-backdrop show';
      div.innerHTML = `
        <div class="conflict-dialog">
          <h2 style="margin: 0 0 10px 0; font-size: 20px; color: #ff9500;">âš ï¸ è³‡æ–™è¡çªè­¦å‘Š</h2>
          <p style="color: #374151; margin: 10px 0;">${result.message || 'å¾Œç«¯æœ‰è¼ƒæ–°çš„è³‡æ–™'}</p>
          ${conflictDetailsHTML}
          ${result.activeSessions && result.activeSessions.length > 0 ? `
            <div class="conflict-user-list">
              <p style="font-size: 12px; color: gray; margin-bottom: 5px;">ç·šä¸Šä½¿ç”¨è€…ï¼š</p>
              ${result.activeSessions.map(s => `
                <div class="conflict-user-item">
                  <div style="font-size: 13px; font-weight: 600;">${s.userName || 'è¨ªå®¢'}</div>
                  <button onclick="kickUser('${s.sessionId}', '${s.userName}')" style="border: none; background: #ff3b30; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; cursor: pointer;">è¸¢å‡º</button>
                </div>
              `).join('')}
            </div>` : ''}
          <p style="color: #6b7280; font-size: 12px; margin-top: 10px;">${result.hint || 'å»ºè­°é‡æ–°è¼‰å…¥ä»¥å–å¾—æœ€æ–°è³‡æ–™'}</p>
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button onclick="this.closest('.modal-backdrop').remove()" class="secondary-btn">ç¨å¾Œè™•ç†</button>
            <button onclick="forceOverwrite()" class="secondary-btn" style="background: #ff3b30; color: white;">å¼·åˆ¶è¦†è“‹</button>
            <button onclick="window.location.reload()" class="primary-btn">é‡æ–°æ•´ç†</button>
          </div>
        </div>
      `;
      document.body.appendChild(div);
    }

    async function forceOverwrite() {
      if (!confirm('ç¢ºå®šè¦å¼·åˆ¶è¦†è“‹å—ï¼Ÿé€™æœƒè¦†è“‹å¾Œç«¯å…¶ä»–äººçš„ä¿®æ”¹ã€‚')) return;
      document.querySelector('.modal-backdrop')?.remove();
      try {
        await syncManager.saveToBackendSafe(true);
        showMaritimeMessage('âœ“ å·²å¼·åˆ¶å„²å­˜', 'success');
      } catch (e) {
        showMaritimeMessage('âœ— å„²å­˜å¤±æ•—', 'error');
      }
    }

    async function kickUser(sid, name) {
      if(confirm(`ç¢ºå®šè¸¢å‡º ${name}?`)) {
        try {
          await sessionManager.kickUser(sid);
          showMaritimeMessage('âœ“ å·²è¸¢å‡ºä½¿ç”¨è€…', 'success');
        } catch(e) {
          showMaritimeMessage('âœ— è¸¢å‡ºå¤±æ•—', 'error');
        }
      }
    }

    // å‹•ç•«
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { opacity: 0; transform: translateX(100px); }
        to { opacity: 1; transform: translateX(0); }
      }
      @keyframes slideOut {
        from { opacity: 1; transform: translateX(0); }
        to { opacity: 0; transform: translateX(100px); }
      }
    `;
    document.head.appendChild(style);

    // ==================== AI å°è©±åŠŸèƒ½ ====================

    function addAIWelcomeMessage() {
      const messages = document.getElementById('aiChatMessages');
      messages.innerHTML = `
        <div class="ai-msg system">æ­¡è¿ä½¿ç”¨ AI èª²ç¨‹é¡§å•</div>
        <div class="ai-msg assistant">
          æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºæ…§æ´¾èª² AI é¡§å•ï¼Œå·²æŒæ¡ç³»çµ±ä¸­ <strong>${maritimeCourses.length}</strong> é–€èª²ç¨‹çš„è³‡æ–™ã€‚<br><br>
          æ‚¨å¯ä»¥å•æˆ‘ï¼š<br>
          â€¢ æ ¹æ“šè·ç­‰æ¨è–¦é©åˆçš„èª²ç¨‹<br>
          â€¢ æŸ¥è©¢ç‰¹å®šä¸»é¡Œçš„è¨“ç·´èª²ç¨‹<br>
          â€¢ åˆ†æèª²ç¨‹åˆ†ä½ˆèˆ‡å»ºè­°<br>
          â€¢ è¦åŠƒèˆ¹å“¡è¨“ç·´è·¯å¾‘<br><br>
          è«‹ç›´æ¥è¼¸å…¥æ‚¨çš„å•é¡Œï¼Œæˆ–é»é¸ä¸‹æ–¹çš„å¿«æ·æŒ‰éˆ•é–‹å§‹ï¼
        </div>
      `;
    }

    let _aiCooldownTimer = null;

    async function sendAIMessage() {
      const input = document.getElementById('aiChatInput');
      const sendBtn = document.getElementById('aiChatSendBtn');
      const message = input.value.trim();
      if (!message) return;

      // å¦‚æœæœ‰å†·å»è¨ˆæ™‚å™¨ï¼Œé˜»æ­¢ç™¼é€
      if (_aiCooldownTimer) {
        showMaritimeMessage('AI å†·å»ä¸­ï¼Œè«‹ç¨å€™â€¦', 'info');
        return;
      }

      const messages = document.getElementById('aiChatMessages');

      // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
      const userDiv = document.createElement('div');
      userDiv.className = 'ai-msg user';
      userDiv.textContent = message;
      messages.appendChild(userDiv);

      input.value = '';
      sendBtn.disabled = true;
      input.disabled = true;

      // åœç”¨å¿«æ·æŒ‰éˆ•
      document.querySelectorAll('.ai-quick-btn').forEach(b => b.disabled = true);

      // é¡¯ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
      const typingDiv = document.createElement('div');
      typingDiv.className = 'ai-typing-indicator';
      typingDiv.id = 'aiTypingIndicator';
      typingDiv.innerHTML = '<div class="ai-typing-dot"></div><div class="ai-typing-dot"></div><div class="ai-typing-dot"></div>';
      messages.appendChild(typingDiv);
      messages.scrollTop = messages.scrollHeight;

      try {
        const reply = await aiChat.chat(message);

        // ç§»é™¤æ‰“å­—æŒ‡ç¤ºå™¨
        typingDiv.remove();

        // å»ºç«‹ AI å›è¦†å…ƒç´ 
        const aiDiv = document.createElement('div');
        aiDiv.className = 'ai-msg assistant';
        messages.appendChild(aiDiv);

        // ä¸²æµæ‰“å­—æ•ˆæœ
        await aiChat.simulateStream(reply, (char, idx, partial) => {
          aiDiv.innerHTML = formatAIResponse(partial);
          messages.scrollTop = messages.scrollHeight;
        }, 15);
      } catch (error) {
        typingDiv.remove();

        const errorMsg = error.message || 'é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
        const isRateLimit = errorMsg.includes('é »ç¹') || errorMsg.includes('å†·å»');

        const errorDiv = document.createElement('div');
        errorDiv.className = 'ai-msg assistant';

        if (isRateLimit) {
          // å•Ÿå‹•å†·å»å€’æ•¸ UI
          errorDiv.innerHTML = `<span style="color: #ff9500;">
            <i class="ph ph-clock-countdown"></i> ${errorMsg}<br>
            <span id="aiCooldownDisplay" style="font-size:12px; opacity:0.8;">å†·å»å€’æ•¸ä¸­â€¦</span>
          </span>`;
          messages.appendChild(errorDiv);
          _startCooldownTimer(60);
        } else {
          errorDiv.innerHTML = '<span style="color: #ff3b30;"><i class="ph ph-warning-circle"></i> ' + errorMsg + '</span>';
          messages.appendChild(errorDiv);
        }
      } finally {
        sendBtn.disabled = false;
        input.disabled = false;
        input.focus();
        document.querySelectorAll('.ai-quick-btn').forEach(b => b.disabled = false);
        messages.scrollTop = messages.scrollHeight;
      }
    }

    function _startCooldownTimer(seconds) {
      let remaining = seconds;
      const sendBtn = document.getElementById('aiChatSendBtn');
      const input = document.getElementById('aiChatInput');
      const display = document.getElementById('aiCooldownDisplay');

      sendBtn.disabled = true;
      input.disabled = true;
      input.placeholder = `å†·å»ä¸­â€¦ ${remaining} ç§’`;
      document.querySelectorAll('.ai-quick-btn').forEach(b => b.disabled = true);

      _aiCooldownTimer = setInterval(() => {
        remaining--;
        if (display) display.textContent = `é‚„éœ€ç­‰å¾… ${remaining} ç§’`;
        input.placeholder = `å†·å»ä¸­â€¦ ${remaining} ç§’`;

        if (remaining <= 0) {
          clearInterval(_aiCooldownTimer);
          _aiCooldownTimer = null;
          sendBtn.disabled = false;
          input.disabled = false;
          input.placeholder = 'è¼¸å…¥æ‚¨çš„å•é¡Œï¼Œä¾‹å¦‚ï¼šã€Œæ¨è–¦é©åˆäºŒå‰¯çš„å®‰å…¨èª²ç¨‹ã€';
          document.querySelectorAll('.ai-quick-btn').forEach(b => b.disabled = false);
          if (display) display.textContent = 'å†·å»å®Œæˆï¼Œå¯ä»¥ç¹¼çºŒæå•';
        }
      }, 1000);
    }

    function sendAIQuickMessage(text) {
      if (_aiCooldownTimer) {
        showMaritimeMessage('AI å†·å»ä¸­ï¼Œè«‹ç¨å€™â€¦', 'info');
        return;
      }
      document.getElementById('aiChatInput').value = text;
      sendAIMessage();
    }

    /**
     * å°‡ AI å›è¦†çš„ Markdown æ ¼å¼è½‰ç‚º HTML
     */
    function formatAIResponse(text) {
      return text
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/`(.+?)`/g, '<code>$1</code>')
        .replace(/^### (.+)$/gm, '<h4 style="margin:8px 0 4px; font-size:15px; font-weight:700;">$1</h4>')
        .replace(/^## (.+)$/gm, '<h3 style="margin:10px 0 6px; font-size:16px; font-weight:700;">$1</h3>')
        .replace(/^[â€¢\-] (.+)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>\n?)+/g, '<ul style="margin:6px 0; padding-left:18px;">$&</ul>')
        .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
        .replace(/\n/g, '<br>');
    }

    window.addEventListener('DOMContentLoaded', initMaritimeCourseSystem);
  </script>
</body>
</html>
