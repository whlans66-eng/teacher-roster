<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºæ…§æ´¾èª² | æµ·äº‹å°ˆæ¥­è¨“ç·´èª²ç¨‹ç³»çµ±</title>

  <style>
  :root {
    --apple-blue: #0071e3;
    --apple-blue-hover: #0077ed;
    --apple-text: #1d1d1f;
    --apple-gray: #86868b;
    --glass-bg: rgba(255, 255, 255, 0.65);
    --glass-border: rgba(255, 255, 255, 0.4);
    --card-radius: 20px;
    --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.05);
  }

  * { box-sizing: border-box; font-family: "SF Pro Text", -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; }

  body {
    background: #f5f5f7;
    min-height: 100vh;
    color: var(--apple-text);
    padding-bottom: 40px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; animation: floatUp 0.8s ease; }

  @keyframes floatUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* é ‚éƒ¨å°èˆª */
  .header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
  .back-btn {
    display: flex; align-items: center; gap: 6px; color: var(--apple-text);
    text-decoration: none; font-weight: 500; font-size: 15px; padding: 10px 20px;
    background: #ffffff; border-radius: 30px;
    border: 1px solid rgba(0, 0, 0, 0.04); transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
  }
  .back-btn:hover { background: #ffffff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
  .page-title { text-align: center; flex: 1; }
  .page-title h1 { font-size: 28px; font-weight: 700; }
  .page-title p { font-size: 13px; color: var(--apple-gray); margin-top: 4px; font-weight: 500; }

  /* iOS åˆ†é åˆ‡æ› */
  .segmented-control {
    background: #ffffff; padding: 4px;
    border-radius: 12px; display: flex; margin: 0 auto 40px auto; width: 100%; max-width: 400px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
    border: 1px solid rgba(0, 0, 0, 0.04);
  }
  .segment-btn {
    flex: 1; border: none; background: transparent; padding: 8px 0; border-radius: 9px;
    font-size: 13px; font-weight: 500; color: var(--apple-text); cursor: pointer; transition: all 0.3s ease;
  }
  .segment-btn.active { background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.12); font-weight: 600; }

  /* ç™½è‰²å¡ç‰‡ */
  .glass-panel {
    background: #ffffff;
    border: 1px solid rgba(0, 0, 0, 0.04); border-radius: var(--card-radius);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
    padding: 30px; margin-bottom: 24px; transition: transform 0.3s ease;
  }

  /* è¼¸å…¥æ¡† */
  .ios-input {
    width: 100%; padding: 14px 16px; border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    background: #f5f5f7; font-size: 15px; transition: all 0.2s;
  }
  .ios-input:focus { outline: none; background: #fff; border-color: var(--apple-blue); box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.15); }

  /* æŒ‰éˆ• */
  .primary-btn {
    background: var(--apple-blue); color: white; border: none; border-radius: 12px;
    padding: 12px 24px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 15px;
  }
  .primary-btn:hover { background: var(--apple-blue-hover); transform: scale(1.02); }

  .secondary-btn {
    background: rgba(0, 0, 0, 0.05); color: var(--apple-text); border: none;
    border-radius: 12px; padding: 12px 24px; font-weight: 600; cursor: pointer; font-size: 15px;
  }
  .secondary-btn:hover { background: rgba(0, 0, 0, 0.1); }

  .danger-btn {
    background: rgba(255, 59, 48, 0.1); color: #ff3b30; border: none;
    border-radius: 12px; padding: 12px 24px; font-weight: 600; cursor: pointer; font-size: 15px;
  }
  .danger-btn:hover { background: rgba(255, 59, 48, 0.2); }

  /* èª²ç¨‹å¡ç‰‡ */
  .course-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 24px; }
  .course-card {
    background: #ffffff;
    border: 1px solid rgba(0, 0, 0, 0.04); border-radius: 20px; padding: 24px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
  }
  .course-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), 0 12px 32px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04);
    border-color: rgba(0, 122, 255, 0.1);
  }
  .course-card.dragging {
    opacity: 0.5;
    cursor: grabbing;
  }
  .course-card.drag-over {
    border-color: rgba(0, 122, 255, 0.5);
    background: rgba(0, 122, 255, 0.05);
  }
  .drag-handle {
    cursor: grab;
    color: #86868b;
    padding: 4px;
    display: inline-flex;
    align-items: center;
    transition: color 0.2s;
  }
  .drag-handle:hover {
    color: #007aff;
  }
  .drag-handle:active {
    cursor: grabbing;
  }
  .course-title { font-size: 19px; font-weight: 700; margin-bottom: 8px; line-height: 1.3; }
  .badge {
    padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.5px; display: inline-block;
  }
  .badge-blue { background: rgba(0, 113, 227, 0.1); color: #0071e3; }
  .badge-green { background: rgba(52, 199, 89, 0.1); color: #34c759; }
  .badge-orange { background: rgba(255, 149, 0, 0.1); color: #ff9500; }

  /* é«˜äº® */
  .highlight { background-color: #fef3c7; padding: 2px 4px; border-radius: 3px; }

  /* çµ±è¨ˆå¡ç‰‡ */
  .stat-card {
    background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
    border-radius: 18px; padding: 28px; color: white; text-align: center;
    position: relative; overflow: hidden; transition: all 0.4s ease;
  }
  .stat-card.purple { background: linear-gradient(135deg, #5856d6 0%, #3634a3 100%); }
  .stat-card.green { background: linear-gradient(135deg, #34c759 0%, #248a3d 100%); }
  .stat-card:hover { transform: translateY(-4px); box-shadow: 0 16px 48px rgba(0, 122, 255, 0.3); }

  /* å½ˆçª— */
  .modal-backdrop {
    position: fixed; inset: 0; z-index: 9999; display: none; align-items: center; justify-content: center;
    background: rgba(0, 0, 0, 0.5);
  }
  .modal-backdrop.show { display: flex; }
  .apple-modal {
    background: #ffffff;
    border-radius: 24px; width: 90%; max-width: 560px; padding: 32px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(0, 0, 0, 0.04);
    max-height: 85vh; overflow-y: auto;
  }

  /* é—œéµå­—æ¨™ç±¤ */
  .keyword-tag-input {
    display: flex; align-items: center; gap: 6px; background: #f5f5f7; border-radius: 16px;
    padding: 6px 12px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    border: 1px solid rgba(0, 0, 0, 0.08);
  }
  .keyword-tag-input input {
    border: none; background: transparent; outline: none; width: 80px; font-size: 13px;
  }
  .keyword-tag-input .remove-btn {
    cursor: pointer; color: #ff3b30; font-weight: bold; font-size: 16px;
  }

  .hidden { display: none !important; }

  /* è¡çªå°è©±æ¡† */
  .conflict-dialog {
    background: #ffffff;
    padding: 30px; border-radius: 24px; max-width: 480px; width: 90%;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2); border: 1px solid rgba(0, 0, 0, 0.04);
  }
  .conflict-user-list {
    background: rgba(0,0,0,0.03); padding: 15px; border-radius: 12px; margin: 20px 0;
  }
  .conflict-user-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05);
  }

  /* åœ“é¤…åœ– */
  .pie-chart {
    width: 280px; height: 280px; border-radius: 50%;
    background: conic-gradient(from 0deg,
      #4f46e5 0deg, #4f46e5 var(--angle1, 0deg),
      #06b6d4 var(--angle1, 0deg), #06b6d4 var(--angle2, 0deg),
      #10b981 var(--angle2, 0deg), #10b981 var(--angle3, 0deg),
      #f59e0b var(--angle3, 0deg), #f59e0b var(--angle4, 0deg),
      #ef4444 var(--angle4, 0deg), #ef4444 var(--angle5, 0deg),
      #8b5cf6 var(--angle5, 0deg), #8b5cf6 var(--angle6, 0deg),
      #f97316 var(--angle6, 0deg), #f97316 var(--angle7, 0deg),
      #84cc16 var(--angle7, 0deg), #84cc16 var(--angle8, 0deg),
      #ec4899 var(--angle8, 0deg), #ec4899 360deg);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); position: relative;
    transition: all 0.4s ease; margin: 0 auto;
  }
  .pie-chart:hover { transform: scale(1.02); }
  .pie-chart::before {
    content: ''; position: absolute; top: 50%; left: 50%;
    width: 130px; height: 130px; background: #fff; border-radius: 50%;
    transform: translate(-50%, -50%); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }
  .pie-chart::after {
    content: 'ğŸ“Š\Aèª²ç¨‹åˆ†å¸ƒ'; position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%); font-size: 13px; font-weight: 600;
    color: #1d1d1f; z-index: 1; text-align: center; white-space: pre; line-height: 1.4;
  }

  .donut-chart {
    position: relative; width: 120px; height: 120px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    background: conic-gradient(from 0deg,
      var(--color) 0deg, var(--color) var(--angle, 0deg),
      rgba(0, 0, 0, 0.06) var(--angle, 0deg), rgba(0, 0, 0, 0.06) 360deg);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }
  .donut-chart::before {
    content: ''; position: absolute; width: 75px; height: 75px;
    background: white; border-radius: 50%; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
  }
  .donut-chart-label {
    position: absolute; font-size: 16px; font-weight: 600; color: #1d1d1f; z-index: 1;
  }

  .method-card {
    background: #ffffff;
    border-radius: 16px; padding: 28px 20px; text-align: center;
    transition: all 0.4s ease; border: 1px solid rgba(0, 0, 0, 0.04);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
  }
  .method-card:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05), 0 12px 32px rgba(0, 0, 0, 0.08); }
  </style>

  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <script src="js/api.js"></script>
</head>
<body>
  <script src="js/auth.js"></script>
  <script>protectPage(['admin', 'teacher']);</script>

  <div class="container">
    <div class="header-nav">
      <a href="index.html" class="back-btn">â† é¦–é </a>
      <div class="page-title">
        <h1>æ™ºæ…§æ´¾èª²</h1>
        <p>Smart Course Assignment System</p>
      </div>
      <div style="width: 80px;"></div>
    </div>

    <div class="segmented-control">
      <button id="maritimeViewTab" class="segment-btn active" onclick="switchMaritimeTab('view')">èª²ç¨‹ç€è¦½</button>
      <button id="maritimeEditTab" class="segment-btn" onclick="switchMaritimeTab('edit')">èª²ç¨‹ç®¡ç†</button>
      <button id="maritimeStatsTab" class="segment-btn" onclick="switchMaritimeTab('stats')">çµ±è¨ˆåˆ†æ</button>
    </div>

    <!-- 1. èª²ç¨‹ç€è¦½é é¢ -->
    <div id="maritimeViewPage">
      <div class="glass-panel">
        <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 20px;">ğŸ” èª²ç¨‹æœå°‹</h2>
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px;">
          <input type="text" id="maritimeSearchInput" placeholder="è¼¸å…¥èª²ç¨‹åç¨±æˆ–é—œéµå­—..." class="ios-input" oninput="displayMaritimeCourses()">
          <select id="maritimeCategoryFilter" class="ios-input" onchange="displayMaritimeCourses()">
            <option value="">æ‰€æœ‰åˆ†é¡</option>
            <option value="01">01 èˆ¹èˆ¶æ“ç¸±èˆ‡èˆªè¡Œ</option>
            <option value="02">02 é ˜å°çµ±å¾¡èˆ‡ç®¡ç†</option>
            <option value="03">03 äº‹æ•…æ¡ˆä¾‹åˆ†æ</option>
            <option value="04">04 èˆ¹èˆ¶è¨­å‚™æ“ä½œ</option>
            <option value="05">05 åœ‹éš›æ³•è¦çŸ¥è­˜</option>
            <option value="06">06 è²¨ç‰©è£å¸å¯¦å‹™</option>
            <option value="07">07 èˆ¹å“¡ç¶“é©—äº¤æµ</option>
            <option value="08">08 è·ç´šè½‰æ›èª¿é©</option>
            <option value="09">09 å…¶ä»–</option>
          </select>
        </div>
      </div>
      <div id="maritimeCourseResults" class="course-grid"></div>
    </div>

    <!-- èª²ç¨‹è©³æƒ…æª¢è¦–é é¢ -->
    <div id="courseDetailView" class="hidden">
      <div style="margin-bottom: 24px;">
        <button onclick="backToCourseList()" class="back-btn" style="display: inline-flex;">
          <i class="ph ph-arrow-left"></i>
          <span>è¿”å›èª²ç¨‹åˆ—è¡¨</span>
        </button>
      </div>
      <div id="courseDetailContent"></div>
    </div>

    <!-- 2. èª²ç¨‹ç®¡ç†é é¢ -->
    <div id="maritimeEditPage" class="hidden">
      <div class="glass-panel">
        <h2 style="font-size: 22px; font-weight: 700; margin-bottom: 24px;">æ–°å¢èª²ç¨‹</h2>
        <form id="maritimeCourseForm">
          <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div>
              <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); margin-left: 4px; display: block; margin-bottom: 6px;">èª²ç¨‹åç¨±</label>
              <input type="text" id="maritimeCourseName" required class="ios-input" placeholder="è¼¸å…¥èª²ç¨‹åç¨±">
            </div>
            <div>
              <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); margin-left: 4px; display: block; margin-bottom: 6px;">åˆ†é¡</label>
              <select id="maritimeCourseCategory" required class="ios-input">
                <option value="">é¸æ“‡åˆ†é¡</option>
                <option value="01">01 èˆ¹èˆ¶æ“ç¸±</option>
                <option value="02">02 é ˜å°çµ±å¾¡</option>
                <option value="03">03 äº‹æ•…åˆ†æ</option>
                <option value="04">04 è¨­å‚™æ“ä½œ</option>
                <option value="05">05 æ³•è¦çŸ¥è­˜</option>
                <option value="06">06 è²¨ç‰©è£å¸</option>
                <option value="07">07 ç¶“é©—äº¤æµ</option>
                <option value="08">08 è·ç´šè½‰æ›</option>
                <option value="09">09 å…¶ä»–</option>
              </select>
            </div>
            <div>
              <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); margin-left: 4px; display: block; margin-bottom: 6px;">æˆèª²æ–¹å¼</label>
              <select id="maritimeCourseMethod" required class="ios-input">
                <option value="å¯¦é«”èª²ç¨‹">å¯¦é«”èª²ç¨‹</option>
                <option value="ç·šä¸Šèª²ç¨‹">ç·šä¸Šèª²ç¨‹</option>
                <option value="æ··åˆèª²ç¨‹">æ··åˆèª²ç¨‹</option>
              </select>
            </div>
          </div>
          <div style="margin-bottom: 16px;">
            <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); margin-left: 4px; display: block; margin-bottom: 6px;">èª²ç¨‹æè¿°</label>
            <textarea id="maritimeCourseDescription" rows="3" class="ios-input" style="resize: vertical;" placeholder="è¼¸å…¥èª²ç¨‹å¤§ç¶±..."></textarea>
          </div>
          <div style="margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); margin-left: 4px;">é—œéµå­—æ¨™ç±¤</label>
              <button type="button" onclick="addMaritimeKeyword()" style="border: none; background: none; color: var(--apple-blue); font-size: 13px; font-weight: 600; cursor: pointer;">+ æ–°å¢é—œéµå­—</button>
            </div>
            <div id="maritimeKeywordList" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 12px; min-height: 50px;"></div>
          </div>
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" id="maritimeCancelEdit" class="secondary-btn">é‡ç½®</button>
            <button type="submit" class="primary-btn">å„²å­˜èª²ç¨‹</button>
          </div>
        </form>
      </div>

      <div class="glass-panel">
        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">å·²å»ºç«‹çš„èª²ç¨‹</h2>
        <input type="text" id="maritimeManageSearchInput" placeholder="æœå°‹èª²ç¨‹..." class="ios-input" style="margin-bottom: 20px;" oninput="displayManageMaritimeCourses()">
        <div id="maritimeManageCourseList" style="display: grid; gap: 12px;"></div>
      </div>
    </div>

    <!-- 3. çµ±è¨ˆåˆ†æé é¢ -->
    <div id="maritimeStatsPage" class="hidden">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px;">
        <div class="stat-card">
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ç¸½èª²ç¨‹æ•¸</div>
          <div id="maritimeTotalCourses" style="font-size: 48px; font-weight: 700; margin: 10px 0;">0</div>
          <div style="font-size: 12px; opacity: 0.8;">æŒçºŒæˆé•·ä¸­</div>
        </div>
        <div class="stat-card purple">
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">æœ€ç†±é–€åˆ†é¡</div>
          <div id="maritimePopularCategory" style="font-size: 20px; font-weight: 600; margin: 24px 0;">-</div>
        </div>
        <div class="stat-card green">
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">é—œéµå­—ç¸½æ•¸</div>
          <div id="maritimeTotalKeywords" style="font-size: 48px; font-weight: 700; margin: 10px 0;">0</div>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
        <div class="glass-panel">
          <h3 style="margin-bottom: 20px; font-size: 16px; font-weight: 600;">èª²ç¨‹åˆ†é¡åˆ†ä½ˆ</h3>
          <div id="maritimeCategoryStats"></div>
        </div>
        <div class="glass-panel">
          <h3 style="margin-bottom: 20px; font-size: 16px; font-weight: 600; text-align: center;">èª²ç¨‹åˆ†é¡åœ“é¤…åœ–</h3>
          <div id="maritimePieChart" class="pie-chart"></div>
          <div id="maritimeChartLegend" style="margin-top: 24px;"></div>
        </div>
      </div>

      <div class="glass-panel" style="margin-top: 24px;">
        <h3 style="margin-bottom: 20px; font-size: 16px; font-weight: 600;">æˆèª²æ–¹å¼çµ±è¨ˆ</h3>
        <div id="maritimeMethodStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;"></div>
      </div>

      <!-- ç†±é–€é—œéµå­— -->
      <div class="glass-panel" style="margin-top: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h3 style="font-size: 16px; font-weight: 600; display: flex; align-items: center;">
            ğŸ”‘ ç†±é–€é—œéµå­—
          </h3>
        </div>
        <div id="maritimeKeywordsCloud" style="display: flex; flex-wrap: wrap; gap: 12px;"></div>
      </div>
    </div>
  </div>

  <!-- ç·¨è¼¯å½ˆçª— -->
  <div id="maritimeCourseModal" class="modal-backdrop" onclick="if(event.target === this) closeMaritimeCourseModal()">
    <div class="apple-modal">
      <h3 id="maritimeModalTitle" style="font-size: 24px; font-weight: 700; margin-bottom: 24px; text-align: center;">ç·¨è¼¯èª²ç¨‹</h3>

      <form id="maritimeCourseModalForm" onsubmit="saveMaritimeCourseFromModal(event)">
        <div style="margin-bottom: 16px;">
          <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); display: block; margin-bottom: 6px;">èª²ç¨‹åç¨±</label>
          <input type="text" id="maritimeCourseNameModal" required class="ios-input" placeholder="èª²ç¨‹åç¨±">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div>
            <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); display: block; margin-bottom: 6px;">åˆ†é¡</label>
            <select id="maritimeCourseCategoryModal" required class="ios-input">
              <option value="01">01 èˆ¹èˆ¶æ“ç¸±</option>
              <option value="02">02 é ˜å°çµ±å¾¡</option>
              <option value="03">03 äº‹æ•…åˆ†æ</option>
              <option value="04">04 è¨­å‚™æ“ä½œ</option>
              <option value="05">05 æ³•è¦çŸ¥è­˜</option>
              <option value="06">06 è²¨ç‰©è£å¸</option>
              <option value="07">07 ç¶“é©—äº¤æµ</option>
              <option value="08">08 è·ç´šè½‰æ›</option>
              <option value="09">09 å…¶ä»–</option>
            </select>
          </div>
          <div>
            <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); display: block; margin-bottom: 6px;">æˆèª²æ–¹å¼</label>
            <select id="maritimeCourseMethodModal" required class="ios-input">
              <option value="å¯¦é«”èª²ç¨‹">å¯¦é«”èª²ç¨‹</option>
              <option value="ç·šä¸Šèª²ç¨‹">ç·šä¸Šèª²ç¨‹</option>
              <option value="æ··åˆèª²ç¨‹">æ··åˆèª²ç¨‹</option>
            </select>
          </div>
        </div>

        <div style="margin-bottom: 16px;">
          <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray); display: block; margin-bottom: 6px;">èª²ç¨‹æè¿°</label>
          <textarea id="maritimeCourseDescriptionModal" rows="3" class="ios-input" style="resize: vertical;" placeholder="èª²ç¨‹æè¿°"></textarea>
        </div>

        <div style="margin-bottom: 24px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <label style="font-size: 12px; font-weight: 600; color: var(--apple-gray);">é—œéµå­—</label>
            <button type="button" onclick="addMaritimeKeywordModal()" style="border:none; background:none; color:var(--apple-blue); font-weight:600; font-size:12px; cursor:pointer;">+ æ–°å¢</button>
          </div>
          <div id="maritimeKeywordListModal" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 40px; background: rgba(0,0,0,0.03); padding: 8px; border-radius: 8px;"></div>
        </div>

        <div style="display: flex; gap: 12px;">
          <button type="button" onclick="deleteMaritimeCourseFromModal()" class="danger-btn">åˆªé™¤èª²ç¨‹</button>
          <div style="flex: 1;"></div>
          <button type="button" onclick="closeMaritimeCourseModal()" class="secondary-btn">å–æ¶ˆ</button>
          <button type="submit" class="primary-btn">å„²å­˜è®Šæ›´</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ========== æµ·äº‹èª²ç¨‹ç³»çµ± ==========
    let maritimeCourses = [];
    let editingMaritimeCourseId = null;

    const maritimeCategoryNames = {
      '01': 'èˆ¹èˆ¶æ“ç¸±èˆ‡èˆªè¡Œå¯¦å‹™',
      '02': 'é ˜å°çµ±å¾¡èˆ‡æª¢æŸ¥æ‡‰å°',
      '03': 'äº‹æ•…æ¡ˆä¾‹åˆ†æ',
      '04': 'èˆ¹èˆ¶è¨­å‚™æ“ä½œ',
      '05': 'åœ‹éš›æ³•è¦èˆ‡ç’°å¢ƒ',
      '06': 'è²¨ç‰©è£å¸ä½œæ¥­',
      '07': 'èˆ¹å“¡ç¶“é©—äº¤æµ',
      '08': 'è·ç´šè½‰æ›èª¿é©',
      '09': 'å…¶ä»–'
    };

    // åˆ‡æ›é é¢
    function switchMaritimeTab(tab) {
      document.getElementById('maritimeViewPage').classList.add('hidden');
      document.getElementById('maritimeEditPage').classList.add('hidden');
      document.getElementById('maritimeStatsPage').classList.add('hidden');

      document.querySelectorAll('.segment-btn').forEach(btn => btn.classList.remove('active'));

      if (tab === 'view') {
        document.getElementById('maritimeViewPage').classList.remove('hidden');
        document.getElementById('maritimeViewTab').classList.add('active');
        displayMaritimeCourses();
      } else if (tab === 'edit') {
        document.getElementById('maritimeEditPage').classList.remove('hidden');
        document.getElementById('maritimeEditTab').classList.add('active');
        displayManageMaritimeCourses();
      } else if (tab === 'stats') {
        document.getElementById('maritimeStatsPage').classList.remove('hidden');
        document.getElementById('maritimeStatsTab').classList.add('active');
        displayMaritimeStats();
      }
    }

    // åˆå§‹åŒ–
    async function initMaritimeCourseSystem() {
      // å…ˆç”¨æœ¬åœ°è³‡æ–™
      maritimeCourses = JSON.parse(localStorage.getItem('maritimeCourses') || '[]');
      displayMaritimeCourses();

      // å¾Œç«¯åŒæ­¥ï¼ˆèƒŒæ™¯ï¼‰
      if (typeof initializeDataSync !== 'undefined') {
        try {
          await initializeDataSync();
          maritimeCourses = JSON.parse(localStorage.getItem('maritimeCourses') || '[]');
          displayMaritimeCourses();
        } catch (err) {
          console.warn('âš ï¸ å¾Œç«¯åŒæ­¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™:', err.message);
        }
      }

      // è¡¨å–®äº‹ä»¶
      document.getElementById('maritimeCourseForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const course = {
          id: Date.now(),
          name: document.getElementById('maritimeCourseName').value,
          category: document.getElementById('maritimeCourseCategory').value,
          method: document.getElementById('maritimeCourseMethod').value,
          description: document.getElementById('maritimeCourseDescription').value,
          keywords: Array.from(document.querySelectorAll('#maritimeKeywordList input')).map(i => i.value.trim()).filter(v => v)
        };
        maritimeCourses.push(course);
        await saveMaritimeCourses();
        showMaritimeMessage('âœ“ èª²ç¨‹æ–°å¢æˆåŠŸ', 'success');
        document.getElementById('maritimeCourseForm').reset();
        document.getElementById('maritimeKeywordList').innerHTML = '';
        addMaritimeKeyword();
        displayManageMaritimeCourses();
      });

      document.getElementById('maritimeCancelEdit').addEventListener('click', () => {
        document.getElementById('maritimeCourseForm').reset();
        document.getElementById('maritimeKeywordList').innerHTML = '';
        addMaritimeKeyword();
      });

      addMaritimeKeyword();
    }

    // é¡¯ç¤ºèª²ç¨‹åˆ—è¡¨ï¼ˆé—œéµå­—å„ªå…ˆæœå°‹ + é«˜äº®ï¼‰
    function displayMaritimeCourses() {
      const search = document.getElementById('maritimeSearchInput').value.toLowerCase();
      const catFilter = document.getElementById('maritimeCategoryFilter').value;
      const container = document.getElementById('maritimeCourseResults');

      let filteredCourses;
      let isKeywordMatch = false;

      if (search) {
        let keywordMatchedCourses = maritimeCourses.filter(course => {
          if (!course || typeof course.name !== 'string') return false;
          const matchesKeyword = Array.isArray(course.keywords)
            ? course.keywords.some(keyword => typeof keyword === 'string' && keyword.toLowerCase().includes(search))
            : false;
          const matchesCategory = !catFilter || course.category === catFilter;
          return matchesKeyword && matchesCategory;
        });

        if (keywordMatchedCourses.length > 0) {
          filteredCourses = keywordMatchedCourses;
          isKeywordMatch = true;
        } else {
          filteredCourses = maritimeCourses.filter(course => {
            if (!course || typeof course.name !== 'string') return false;
            const matchesSearch = course.name.toLowerCase().includes(search) ||
              (course.description && typeof course.description === 'string' ? course.description.toLowerCase().includes(search) : false);
            const matchesCategory = !catFilter || course.category === catFilter;
            return matchesSearch && matchesCategory;
          });
        }
      } else {
        filteredCourses = maritimeCourses.filter(course => {
          if (!course) return false;
          return !catFilter || course.category === catFilter;
        });
      }

      if (filteredCourses.length === 0) {
        container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#86868b; padding:40px;">æ²’æœ‰æ‰¾åˆ°ç›¸é—œèª²ç¨‹</div>';
        return;
      }

      let html = '';
      if (isKeywordMatch && search) {
        html += `<div style="grid-column: 1 / -1; padding: 16px; background: linear-gradient(135deg, #e6f3ff 0%, #f0f5ff 100%); border-radius: 12px; margin-bottom: 16px; text-align: center; border: 1px solid #007aff30;">
          <span style="color: #007aff; font-weight: 600;">ğŸ·ï¸ æ‰¾åˆ° ${filteredCourses.length} å€‹ç¬¦åˆé—œéµå­—ã€Œ${search}ã€çš„èª²ç¨‹</span>
        </div>`;
      }

      html += filteredCourses.map((c, index) => {
        let badgeColor = 'badge-blue';
        if (c.method === 'ç·šä¸Šèª²ç¨‹') badgeColor = 'badge-green';
        if (c.method === 'æ··åˆèª²ç¨‹') badgeColor = 'badge-orange';

        return `
          <div class="course-card" draggable="true" data-course-id="${c.id}" data-index="${index}" onclick="onCourseCardClick(event, ${c.id})">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
              <div style="display:flex; align-items:center; gap:8px;">
                <span class="drag-handle" onmousedown="event.stopPropagation()">
                  <i class="ph ph-dots-six-vertical" style="font-size:20px;"></i>
                </span>
                <span class="badge ${badgeColor}">${c.method || 'æœªè¨­å®š'}</span>
              </div>
              <span style="
                background: rgba(139, 92, 246, 0.15);
                color: #7c3aed;
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
              ">${maritimeCategoryNames[c.category] || c.category}</span>
            </div>
            <div class="course-title" style="
              display: -webkit-box;
              -webkit-line-clamp: 2;
              -webkit-box-orient: vertical;
              overflow: hidden;
              text-overflow: ellipsis;
              line-height: 1.4;
              max-height: 2.8em;
            ">${highlightMaritimeText(c.name, search)}</div>
            <div style="
              font-size:14px;
              color:#86868b;
              margin-bottom:20px;
              line-height:1.6;
              display: -webkit-box;
              -webkit-line-clamp: 2;
              -webkit-box-orient: vertical;
              overflow: hidden;
              text-overflow: ellipsis;
              max-height: 3.2em;
            ">
              ${highlightMaritimeText(c.description || 'ç„¡æè¿°', search)}
            </div>
            <div style="
              display:flex;
              gap:6px;
              flex-wrap:wrap;
              max-height: 3.2em;
              overflow: hidden;
            ">
              ${(c.keywords || []).map(k =>
                `<span style="font-size:11px; padding:4px 10px; background:rgba(0,0,0,0.05); color:#86868b; border-radius:6px;">#${highlightMaritimeText(k, search)}</span>`
              ).join('')}
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;

      // ç‚ºæ‰€æœ‰å¡ç‰‡æ·»åŠ æ‹–æ”¾äº‹ä»¶ç›£è½å™¨
      const cards = container.querySelectorAll('.course-card');
      cards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('drop', handleDrop);
        card.addEventListener('dragend', handleDragEnd);
        card.addEventListener('dragleave', handleDragLeave);
      });
    }

    // æ‹–æ”¾è®Šé‡
    let draggedCard = null;
    let isDragging = false;

    // è™•ç†å¡ç‰‡é»æ“Šï¼ˆå€åˆ†æ‹–å‹•å’Œæ™®é€šé»æ“Šï¼‰
    function onCourseCardClick(event, courseId) {
      if (!isDragging) {
        viewCourseDetail(courseId);
      }
    }

    // æ‹–å‹•é–‹å§‹
    function handleDragStart(e) {
      isDragging = true;
      draggedCard = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
    }

    // æ‹–å‹•ç¶“é
    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = 'move';

      const afterElement = getDragAfterElement(this.parentElement, e.clientY);
      const dragging = document.querySelector('.dragging');

      if (afterElement == null) {
        this.parentElement.appendChild(dragging);
      } else {
        this.parentElement.insertBefore(dragging, afterElement);
      }

      return false;
    }

    // æ”¾ä¸‹
    function handleDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }

      if (draggedCard !== this) {
        // ç²å–æ‰€æœ‰å¡ç‰‡çš„æ–°é †åº
        const container = document.getElementById('maritimeCourseResults');
        const cards = Array.from(container.querySelectorAll('.course-card'));
        const newOrder = cards.map(card => parseInt(card.dataset.courseId));

        // é‡æ–°æ’åˆ— maritimeCourses é™£åˆ—
        const reorderedCourses = newOrder.map(id =>
          maritimeCourses.find(c => c.id === id)
        ).filter(c => c !== undefined);

        // ä¿ç•™æœªåœ¨é¡¯ç¤ºåˆ—è¡¨ä¸­çš„èª²ç¨‹
        const displayedIds = new Set(newOrder);
        const hiddenCourses = maritimeCourses.filter(c => !displayedIds.has(c.id));

        maritimeCourses = [...reorderedCourses, ...hiddenCourses];
        saveMaritimeCourses();
      }

      return false;
    }

    // æ‹–å‹•çµæŸ
    function handleDragEnd(e) {
      setTimeout(() => {
        isDragging = false;
      }, 100);

      this.classList.remove('dragging');

      const cards = document.querySelectorAll('.course-card');
      cards.forEach(card => {
        card.classList.remove('drag-over');
      });
    }

    // é›¢é–‹æ‹–å‹•å€åŸŸ
    function handleDragLeave(e) {
      this.classList.remove('drag-over');
    }

    // ç²å–æ‹–å‹•å¾Œçš„ä½ç½®
    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.course-card:not(.dragging)')];

      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;

        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function highlightMaritimeText(text, searchTerm) {
      if (!searchTerm) return text;
      const regex = new RegExp(`(${searchTerm})`, 'gi');
      return text.replace(regex, '<span class="highlight">$1</span>');
    }

    // é¡¯ç¤ºç®¡ç†åˆ—è¡¨
    function displayManageMaritimeCourses() {
      const search = document.getElementById('maritimeManageSearchInput').value.toLowerCase();
      const container = document.getElementById('maritimeManageCourseList');

      const filtered = maritimeCourses.filter(course => {
        if (!course || typeof course.name !== 'string') return false;
        const matchName = course.name.toLowerCase().includes(search);
        const matchDescription = course.description && typeof course.description === 'string'
          ? course.description.toLowerCase().includes(search) : false;
        const matchKeywords = Array.isArray(course.keywords)
          ? course.keywords.some(keyword => typeof keyword === 'string' && keyword.toLowerCase().includes(search)) : false;
        return matchName || matchDescription || matchKeywords;
      });

      if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 32px 0; color: #6e6e73;">æ²’æœ‰æ‰¾åˆ°èª²ç¨‹</div>';
        return;
      }

      container.innerHTML = filtered.map(c => `
        <div style="background:white; padding:16px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
          <div>
            <div style="font-weight:600; font-size:15px;">${c.name}</div>
            <div style="font-size:12px; color:#86868b;">${maritimeCategoryNames[c.category] || c.category}</div>
          </div>
          <button onclick="editMaritimeCourse(${c.id})" class="secondary-btn" style="padding:6px 16px; font-size:13px;">ç·¨è¼¯</button>
        </div>
      `).join('');
    }

    // æ–°å¢é—œéµå­—
    function addMaritimeKeyword(val = '') {
      createKeywordTag(document.getElementById('maritimeKeywordList'), val);
    }

    function addMaritimeKeywordModal(val = '') {
      createKeywordTag(document.getElementById('maritimeKeywordListModal'), val);
    }

    function createKeywordTag(container, val) {
      const div = document.createElement('div');
      div.className = 'keyword-tag-input';
      div.innerHTML = `
        <input type="text" value="${val}" placeholder="é—œéµå­—">
        <span class="remove-btn" onclick="this.parentElement.remove()">Ã—</span>
      `;
      container.appendChild(div);
    }

    // æª¢è¦–èª²ç¨‹è©³æƒ…
    function viewCourseDetail(courseId) {
      const course = maritimeCourses.find(c => c.id === courseId);
      if (!course) return;

      // éš±è—èª²ç¨‹åˆ—è¡¨ï¼Œé¡¯ç¤ºè©³æƒ…é é¢
      document.getElementById('maritimeViewPage').querySelector('.glass-panel').classList.add('hidden');
      document.getElementById('maritimeCourseResults').classList.add('hidden');
      document.getElementById('courseDetailView').classList.remove('hidden');

      // æ ¹æ“šæˆèª²æ–¹å¼æ±ºå®šé…è‰²
      const methodColors = {
        'å¯¦é«”èª²ç¨‹': { gradient: 'from-blue-50 to-indigo-50', badge: 'bg-blue-500', text: 'text-blue-800', icon: '<i class="ph ph-buildings"></i>' },
        'ç·šä¸Šèª²ç¨‹': { gradient: 'from-green-50 to-emerald-50', badge: 'bg-green-500', text: 'text-green-800', icon: '<i class="ph ph-laptop"></i>' },
        'æ··åˆèª²ç¨‹': { gradient: 'from-orange-50 to-amber-50', badge: 'bg-orange-500', text: 'text-orange-800', icon: '<i class="ph ph-arrows-clockwise"></i>' }
      };

      const colors = methodColors[course.method] || methodColors['å¯¦é«”èª²ç¨‹'];
      const categoryName = maritimeCategoryNames[course.category] || course.category;

      const content = document.getElementById('courseDetailContent');
      content.innerHTML = `
        <!-- é ‚éƒ¨è³‡è¨Šå¡ç‰‡ -->
        <div style="background: linear-gradient(135deg, #f0f5ff 0%, #e8f4f8 100%); border-radius: 24px; padding: 40px; margin-bottom: 32px; position: relative; overflow: hidden;">
          <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: rgba(0, 122, 255, 0.08); border-radius: 50%;"></div>
          <div style="position: absolute; bottom: -30px; left: -30px; width: 150px; height: 150px; background: rgba(139, 92, 246, 0.08); border-radius: 50%;"></div>

          <div style="position: relative; z-index: 1;">
            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px;">
              <span style="background: linear-gradient(135deg, #007aff 0%, #0051d5 100%); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;">
                ${colors.icon}
                ${course.method || 'æœªè¨­å®š'}
              </span>
              <span style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600;">
                ${course.category} ${categoryName}
              </span>
            </div>

            <h1 style="font-size: 32px; font-weight: 700; color: #1d1d1f; margin-bottom: 16px; line-height: 1.3;">${course.name}</h1>

            <div style="display: flex; align-items: center; gap: 16px; color: #6e6e73; font-size: 14px;">
              <span style="display: flex; align-items: center; gap: 6px;">
                <i class="ph ph-calendar-blank"></i>
                å»ºç«‹æ–¼ ${new Date(course.id).toLocaleDateString('zh-TW')}
              </span>
              <span style="display: flex; align-items: center; gap: 6px;">
                <i class="ph ph-tag"></i>
                ${(course.keywords || []).length} å€‹é—œéµå­—
              </span>
            </div>
          </div>
        </div>

        <!-- è©³ç´°å…§å®¹å€å¡Š -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
          <!-- èª²ç¨‹æè¿° -->
          <div class="glass-panel" style="grid-column: 1 / -1;">
            <h3 style="font-size: 20px; font-weight: 700; color: #1d1d1f; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
              <span style="width: 40px; height: 40px; background: linear-gradient(135deg, #007aff 0%, #0051d5 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">
                <i class="ph ph-article"></i>
              </span>
              èª²ç¨‹æè¿°
            </h3>
            ${course.description ? `
              <div style="background: #f5f5f7; border-radius: 16px; padding: 24px; line-height: 1.8; color: #333; font-size: 15px; border-left: 4px solid #007aff;">
                ${course.description.replace(/\n/g, '<br>')}
              </div>
            ` : `
              <div style="text-align: center; padding: 40px; color: #86868b;">
                <div style="font-size: 48px; margin-bottom: 12px;"><i class="ph ph-note-pencil"></i></div>
                <p>å°šæœªå¡«å¯«èª²ç¨‹æè¿°</p>
              </div>
            `}
          </div>

          <!-- åˆ†é¡è³‡è¨Š -->
          <div class="glass-panel">
            <h3 style="font-size: 18px; font-weight: 700; color: #1d1d1f; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
              <span style="width: 36px; height: 36px; background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px;">
                <i class="ph ph-folder-open"></i>
              </span>
              èª²ç¨‹åˆ†é¡
            </h3>
            <div style="background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); border-radius: 16px; padding: 24px; text-align: center;">
              <div style="font-size: 48px; margin-bottom: 12px; color: #8b5cf6;">
                ${getCategoryIcon(course.category)}
              </div>
              <div style="font-size: 15px; font-weight: 600; color: #6d28d9;">${course.category}</div>
              <div style="font-size: 17px; font-weight: 700; color: #1d1d1f; margin-top: 8px;">${categoryName}</div>
            </div>
          </div>

          <!-- æˆèª²æ–¹å¼ -->
          <div class="glass-panel">
            <h3 style="font-size: 18px; font-weight: 700; color: #1d1d1f; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
              <span style="width: 36px; height: 36px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px;">
                <i class="ph ph-chalkboard-teacher"></i>
              </span>
              æˆèª²æ–¹å¼
            </h3>
            <div style="background: ${getMethodBackground(course.method)}; border-radius: 16px; padding: 24px; text-align: center;">
              <div style="font-size: 48px; margin-bottom: 12px;">${colors.icon}</div>
              <div style="font-size: 20px; font-weight: 700; color: #1d1d1f;">${course.method || 'æœªè¨­å®š'}</div>
              <div style="font-size: 13px; color: #6e6e73; margin-top: 8px;">${getMethodDescription(course.method)}</div>
            </div>
          </div>
        </div>

        <!-- é—œéµå­—æ¨™ç±¤ -->
        <div class="glass-panel" style="margin-top: 24px;">
          <h3 style="font-size: 18px; font-weight: 700; color: #1d1d1f; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
            <span style="width: 36px; height: 36px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px;">
              <i class="ph ph-hash"></i>
            </span>
            é—œéµå­—æ¨™ç±¤
          </h3>
          ${(course.keywords && course.keywords.length > 0) ? `
            <div style="display: flex; flex-wrap: wrap; gap: 12px;">
              ${course.keywords.map(keyword => `
                <span style="
                  background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
                  color: white;
                  padding: 10px 20px;
                  border-radius: 25px;
                  font-size: 14px;
                  font-weight: 600;
                  display: inline-flex;
                  align-items: center;
                  gap: 8px;
                  box-shadow: 0 4px 12px rgba(0, 122, 255, 0.25);
                  transition: all 0.2s ease;
                ">
                  <i class="ph ph-hash" style="font-size: 12px;"></i>
                  ${keyword}
                </span>
              `).join('')}
            </div>
          ` : `
            <div style="text-align: center; padding: 40px; color: #86868b;">
              <div style="font-size: 48px; margin-bottom: 12px;"><i class="ph ph-tag"></i></div>
              <p>å°šæœªè¨­å®šé—œéµå­—</p>
            </div>
          `}
        </div>

        <!-- æ“ä½œæŒ‰éˆ• -->
        <div style="margin-top: 32px; display: flex; justify-content: center; gap: 16px;">
          <button onclick="editMaritimeCourse(${course.id})" class="primary-btn" style="padding: 14px 32px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
            <i class="ph ph-pencil-simple"></i>
            ç·¨è¼¯èª²ç¨‹è³‡æ–™
          </button>
          <button onclick="backToCourseList()" class="secondary-btn" style="padding: 14px 32px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
            <i class="ph ph-arrow-left"></i>
            è¿”å›åˆ—è¡¨
          </button>
        </div>
      `;
    }

    // è¿”å›èª²ç¨‹åˆ—è¡¨
    function backToCourseList() {
      document.getElementById('courseDetailView').classList.add('hidden');
      document.getElementById('maritimeViewPage').querySelector('.glass-panel').classList.remove('hidden');
      document.getElementById('maritimeCourseResults').classList.remove('hidden');
    }

    // å–å¾—åˆ†é¡åœ–ç¤º
    function getCategoryIcon(category) {
      const icons = {
        '01': '<i class="ph ph-anchor"></i>',
        '02': '<i class="ph ph-users-three"></i>',
        '03': '<i class="ph ph-warning-circle"></i>',
        '04': '<i class="ph ph-gear"></i>',
        '05': '<i class="ph ph-scales"></i>',
        '06': '<i class="ph ph-package"></i>',
        '07': '<i class="ph ph-chat-circle-dots"></i>',
        '08': '<i class="ph ph-arrow-u-up-left"></i>',
        '09': '<i class="ph ph-dots-three"></i>'
      };
      return icons[category] || '<i class="ph ph-folder"></i>';
    }

    // å–å¾—æˆèª²æ–¹å¼èƒŒæ™¯è‰²
    function getMethodBackground(method) {
      const backgrounds = {
        'å¯¦é«”èª²ç¨‹': 'linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)',
        'ç·šä¸Šèª²ç¨‹': 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)',
        'æ··åˆèª²ç¨‹': 'linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)'
      };
      return backgrounds[method] || 'linear-gradient(135deg, #f5f5f7 0%, #e5e5ea 100%)';
    }

    // å–å¾—æˆèª²æ–¹å¼èªªæ˜
    function getMethodDescription(method) {
      const descriptions = {
        'å¯¦é«”èª²ç¨‹': 'é¢å°é¢èª²å ‚æ•™å­¸ï¼Œäº’å‹•æ€§å¼·',
        'ç·šä¸Šèª²ç¨‹': 'é è·ç·šä¸Šæˆèª²ï¼Œæ™‚é–“å½ˆæ€§',
        'æ··åˆèª²ç¨‹': 'çµåˆå¯¦é«”èˆ‡ç·šä¸Šçš„æ··åˆå¼æ•™å­¸'
      };
      return descriptions[method] || 'æˆèª²æ–¹å¼å¾…å®š';
    }

    // ç·¨è¼¯èª²ç¨‹
    function editMaritimeCourse(id) {
      editingMaritimeCourseId = id;
      const c = maritimeCourses.find(x => x.id === id);
      if (!c) return;

      document.getElementById('maritimeCourseNameModal').value = c.name;
      document.getElementById('maritimeCourseCategoryModal').value = c.category;
      document.getElementById('maritimeCourseMethodModal').value = c.method;
      document.getElementById('maritimeCourseDescriptionModal').value = c.description;

      const list = document.getElementById('maritimeKeywordListModal');
      list.innerHTML = '';
      if (c.keywords && c.keywords.length > 0) {
        c.keywords.forEach(k => addMaritimeKeywordModal(k));
      } else {
        addMaritimeKeywordModal();
      }

      document.getElementById('maritimeCourseModal').classList.add('show');
    }

    function closeMaritimeCourseModal() {
      document.getElementById('maritimeCourseModal').classList.remove('show');
      editingMaritimeCourseId = null;
    }

    async function saveMaritimeCourseFromModal(e) {
      e.preventDefault();
      const newData = {
        name: document.getElementById('maritimeCourseNameModal').value,
        category: document.getElementById('maritimeCourseCategoryModal').value,
        method: document.getElementById('maritimeCourseMethodModal').value,
        description: document.getElementById('maritimeCourseDescriptionModal').value,
        keywords: Array.from(document.querySelectorAll('#maritimeKeywordListModal input')).map(i => i.value.trim()).filter(v => v)
      };

      const idx = maritimeCourses.findIndex(x => x.id === editingMaritimeCourseId);
      if (idx >= 0) {
        maritimeCourses[idx] = { ...maritimeCourses[idx], ...newData };
        await saveMaritimeCourses();
        showMaritimeMessage('âœ“ èª²ç¨‹æ›´æ–°æˆåŠŸ', 'success');
        closeMaritimeCourseModal();
        displayMaritimeCourses();
        displayManageMaritimeCourses();
      }
    }

    async function deleteMaritimeCourseFromModal() {
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹èª²ç¨‹å—ï¼Ÿ')) {
        maritimeCourses = maritimeCourses.filter(x => x.id !== editingMaritimeCourseId);
        await saveMaritimeCourses();
        showMaritimeMessage('âœ“ èª²ç¨‹å·²åˆªé™¤', 'success');
        closeMaritimeCourseModal();
        displayMaritimeCourses();
        displayManageMaritimeCourses();
      }
    }

    // å„²å­˜ï¼ˆå«è¡çªæª¢æŸ¥ï¼‰
    async function saveMaritimeCourses() {
      localStorage.setItem('maritimeCourses', JSON.stringify(maritimeCourses));

      if (typeof syncManager !== 'undefined') {
        syncManager.markAsChanged();
        const result = await syncManager.saveToBackendSafe();
        if (result.conflict) {
          showConflictDialog(result);
        }
      } else if (typeof api !== 'undefined') {
        await api.save('maritimeCourses', maritimeCourses);
      }
    }

    // çµ±è¨ˆåˆ†æ - å¾çœŸå¯¦è³‡æ–™è¨ˆç®—
    function displayMaritimeStats() {
      // å¾çœŸå¯¦çš„ maritimeCourses è¨ˆç®—çµ±è¨ˆ
      const totalCourses = maritimeCourses.length;

      // å®šç¾©åˆ†é¡åç¨±å’Œé¡è‰²
      const categoryNames = {
        '01': { name: 'èˆ¹èˆ¶æ“ç¸±èˆ‡èˆªè¡Œå¯¦å‹™è¨“ç·´', color: '#4f46e5' },
        '02': { name: 'é ˜å°çµ±å¾¡èˆ‡æª¢æŸ¥æ‡‰å°ç®¡ç†', color: '#06b6d4' },
        '03': { name: 'äº‹æ•…æ¡ˆä¾‹åˆ†æèˆ‡æ‡‰è®Šè™•ç½®è¨“ç·´', color: '#10b981' },
        '04': { name: 'èˆ¹èˆ¶è¨­å‚™æ“ä½œèˆ‡æŠ€è¡“çŸ¥èƒ½è¨“ç·´', color: '#f59e0b' },
        '05': { name: 'åœ‹éš›æ³•è¦èˆ‡ç’°å¢ƒåˆè¦çŸ¥è­˜', color: '#ef4444' },
        '06': { name: 'èˆ¹èˆ¶è²¨ç‰©è£å¸ä½œæ¥­å¯¦å‹™', color: '#8b5cf6' },
        '07': { name: 'èˆ¹å“¡ç¶“é©—äº¤æµèˆ‡è·èƒ½å›é¥‹', color: '#f97316' },
        '08': { name: 'è·ç´šè½‰æ›èˆ‡å£“åŠ›èª¿é©', color: '#84cc16' },
        '09': { name: 'å…¶ä»–', color: '#ec4899' }
      };

      // çµ±è¨ˆæ¯å€‹åˆ†é¡çš„èª²ç¨‹æ•¸é‡
      const categoryCounts = {};
      maritimeCourses.forEach(course => {
        const cat = course.category || '09';
        categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
      });

      // å»ºç«‹å®Œæ•´çš„ categories ç‰©ä»¶
      const categories = {};
      Object.keys(categoryNames).forEach(code => {
        categories[code] = {
          ...categoryNames[code],
          count: categoryCounts[code] || 0
        };
      });

      // æ‰¾å‡ºæœ€ç†±é–€çš„åˆ†é¡
      let popularCategory = '09å…¶ä»–';
      let maxCount = 0;
      Object.entries(categories).forEach(([code, cat]) => {
        if (cat.count > maxCount) {
          maxCount = cat.count;
          popularCategory = code + cat.name;
        }
      });

      // çµ±è¨ˆé—œéµå­—
      const keywordCounts = {};
      maritimeCourses.forEach(course => {
        if (Array.isArray(course.keywords)) {
          course.keywords.forEach(keyword => {
            const kw = keyword.trim();
            if (kw) {
              keywordCounts[kw] = (keywordCounts[kw] || 0) + 1;
            }
          });
        }
      });

      // è½‰æ›ç‚ºé™£åˆ—ä¸¦æŒ‰å‡ºç¾æ¬¡æ•¸æ’åº
      const keywords = Object.entries(keywordCounts)
        .map(([text, count]) => ({ text, count }))
        .sort((a, b) => b.count - a.count);

      const totalKeywords = keywords.length;

      // çµ±è¨ˆæˆèª²æ–¹å¼
      const methodCounts = {};
      maritimeCourses.forEach(course => {
        const method = course.method || 'æœªè¨­å®š';
        methodCounts[method] = (methodCounts[method] || 0) + 1;
      });

      const methods = {};
      Object.entries(methodCounts).forEach(([method, count]) => {
        methods[method] = {
          count,
          percentage: totalCourses > 0 ? ((count / totalCourses) * 100).toFixed(1) : 0
        };
      });

      // é ‚éƒ¨çµ±è¨ˆå¡ç‰‡
      document.getElementById('maritimeTotalCourses').innerText = totalCourses;
      document.getElementById('maritimeTotalKeywords').innerText = totalKeywords;
      document.getElementById('maritimePopularCategory').innerText = popularCategory;

      // åˆ†é¡çµ±è¨ˆ - æ¢ç‹€åœ–
      const catHtml = Object.keys(categories).map(code => {
        const cat = categories[code];
        const percentage = totalCourses > 0 ? (cat.count / totalCourses) * 100 : 0;
        return `
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <div style="font-size:12px; width:140px; color: #1d1d1f;">${code} ${cat.name}</div>
            <div style="flex:1; background:#e5e5ea; height:8px; border-radius:4px; overflow: hidden;">
              <div style="width:${percentage}%; background:${cat.color}; height:100%; border-radius:4px; transition: width 0.3s;"></div>
            </div>
            <div style="font-size:13px; font-weight:600; width:30px; text-align:right;">${cat.count}</div>
          </div>
        `;
      }).join('');
      document.getElementById('maritimeCategoryStats').innerHTML = catHtml;

      // åœ“é¤…åœ–è§’åº¦è¨ˆç®— (åªé¡¯ç¤ºæœ‰èª²ç¨‹çš„åˆ†é¡)
      const activeCategories = Object.keys(categories).filter(code => categories[code].count > 0);
      let currentAngle = 0;
      const pieChart = document.getElementById('maritimePieChart');

      activeCategories.forEach((code, index) => {
        const cat = categories[code];
        const percentage = totalCourses > 0 ? (cat.count / totalCourses) * 360 : 0;
        currentAngle += percentage;
        pieChart.style.setProperty(`--angle${parseInt(code)}`, `${currentAngle}deg`);
      });

      // åœ“é¤…åœ–åœ–ä¾‹
      const legend = document.getElementById('maritimeChartLegend');
      legend.innerHTML = activeCategories.map(code => {
        const cat = categories[code];
        const percentage = totalCourses > 0 ? ((cat.count / totalCourses) * 100).toFixed(1) : 0;
        return `
          <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; transition: background 0.2s;">
            <div style="width: 14px; height: 14px; border-radius: 50%; background: ${cat.color}; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);"></div>
            <div style="flex: 1; font-size: 13px;">${cat.name}</div>
            <div style="font-size: 12px; color: #86868b;">${cat.count} é–€èª²ç¨‹ (${percentage}%)</div>
          </div>
        `;
      }).join('');

      // æˆèª²æ–¹å¼çµ±è¨ˆ
      const methodColors = { å¯¦é«”èª²ç¨‹: '#3b82f6', ç·šä¸Šèª²ç¨‹: '#10b981', æ··åˆèª²ç¨‹: '#f59e0b', æœªè¨­å®š: '#6b7280' };
      const methodIcons = { å¯¦é«”èª²ç¨‹: '<i class="ph ph-buildings"></i>', ç·šä¸Šèª²ç¨‹: '<i class="ph ph-laptop"></i>', æ··åˆèª²ç¨‹: '<i class="ph ph-arrows-clockwise"></i>', æœªè¨­å®š: '<i class="ph ph-question"></i>' };

      document.getElementById('maritimeMethodStats').innerHTML = Object.entries(methods).map(([method, data]) => {
        const angle = totalCourses > 0 ? (data.count / totalCourses) * 360 : 0;
        return `
          <div class="method-card">
            <div class="donut-chart" style="--color: ${methodColors[method] || '#6b7280'}; --angle: ${angle}deg; margin: 0 auto 16px;">
              <div class="donut-chart-label">${data.count}</div>
            </div>
            <div style="font-size: 32px; margin-bottom: 8px;">${methodIcons[method] || '<i class="ph ph-question"></i>'}</div>
            <h4 style="font-weight: 600; color: #1d1d1f; margin-bottom: 4px;">${method}</h4>
            <p style="font-size: 13px; color: #6e6e73;">${data.percentage}% çš„èª²ç¨‹</p>
            <p style="font-size: 12px; color: #86868b; margin-top: 4px;">å…± ${data.count} é–€èª²ç¨‹</p>
          </div>
        `;
      }).join('');

      // ç†±é–€é—œéµå­— - å¾çœŸå¯¦è³‡æ–™è¨ˆç®—
      if (keywords.length > 0) {
        document.getElementById('maritimeKeywordsCloud').innerHTML = keywords.map(kw => `
          <div style="
            background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
            color: white;
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 122, 255, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 122, 255, 0.3)'">
            <span>${kw.text}</span>
            <span style="
              background: rgba(255, 255, 255, 0.25);
              padding: 2px 8px;
              border-radius: 8px;
              font-size: 12px;
              font-weight: 600;
            ">${kw.count}</span>
          </div>
        `).join('');
      } else {
        document.getElementById('maritimeKeywordsCloud').innerHTML = '<div style="text-align: center; color: #86868b; padding: 20px;">å°šç„¡é—œéµå­—è³‡æ–™</div>';
      }
    }

    // è¨Šæ¯æç¤º
    function showMaritimeMessage(message, type = 'info') {
      const div = document.createElement('div');
      div.style.cssText = `
        position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 12px;
        color: white; z-index: 10000; font-size: 14px; font-weight: 600;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15); animation: slideIn 0.3s ease;
        background: ${type === 'success' ? 'linear-gradient(135deg, #34c759 0%, #248a3d 100%)' : 'linear-gradient(135deg, #007aff 0%, #0051d5 100%)'};
      `;
      div.textContent = message;
      document.body.appendChild(div);

      setTimeout(() => {
        div.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => div.remove(), 300);
      }, 3000);
    }

    // è¡çªå°è©±æ¡†
    function showConflictDialog(result) {
      const conflicts = result.conflicts || [];
      const tableNames = {
        'teachers': 'æ•™å¸«è³‡æ–™',
        'courseAssignments': 'èª²ç¨‹å®‰æ’',
        'maritimeCourses': 'æµ·äº‹èª²ç¨‹'
      };

      let conflictDetailsHTML = '';
      if (conflicts.length > 0) {
        conflictDetailsHTML = '<div style="margin: 10px 0; padding: 10px; background: #fef3c7; border-radius: 6px; font-size: 13px;"><strong>åµæ¸¬åˆ°è®Šæ›´ï¼š</strong><ul style="margin: 5px 0; padding-left: 18px;">';
        conflicts.forEach(c => {
          const name = tableNames[c.table] || c.table;
          conflictDetailsHTML += `<li>${name}: ${c.savedCount} â†’ ${c.currentCount} ç­†</li>`;
        });
        conflictDetailsHTML += '</ul></div>';
      }

      const div = document.createElement('div');
      div.className = 'modal-backdrop show';
      div.innerHTML = `
        <div class="conflict-dialog">
          <h2 style="margin: 0 0 10px 0; font-size: 20px; color: #ff9500;">âš ï¸ è³‡æ–™è¡çªè­¦å‘Š</h2>
          <p style="color: #374151; margin: 10px 0;">${result.message || 'å¾Œç«¯æœ‰è¼ƒæ–°çš„è³‡æ–™'}</p>
          ${conflictDetailsHTML}
          ${result.activeSessions && result.activeSessions.length > 0 ? `
            <div class="conflict-user-list">
              <p style="font-size: 12px; color: gray; margin-bottom: 5px;">ç·šä¸Šä½¿ç”¨è€…ï¼š</p>
              ${result.activeSessions.map(s => `
                <div class="conflict-user-item">
                  <div style="font-size: 13px; font-weight: 600;">${s.userName || 'è¨ªå®¢'}</div>
                  <button onclick="kickUser('${s.sessionId}', '${s.userName}')" style="border: none; background: #ff3b30; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; cursor: pointer;">è¸¢å‡º</button>
                </div>
              `).join('')}
            </div>` : ''}
          <p style="color: #6b7280; font-size: 12px; margin-top: 10px;">${result.hint || 'å»ºè­°é‡æ–°è¼‰å…¥ä»¥å–å¾—æœ€æ–°è³‡æ–™'}</p>
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button onclick="this.closest('.modal-backdrop').remove()" class="secondary-btn">ç¨å¾Œè™•ç†</button>
            <button onclick="forceOverwrite()" class="secondary-btn" style="background: #ff3b30; color: white;">å¼·åˆ¶è¦†è“‹</button>
            <button onclick="window.location.reload()" class="primary-btn">é‡æ–°æ•´ç†</button>
          </div>
        </div>
      `;
      document.body.appendChild(div);
    }

    async function forceOverwrite() {
      if (!confirm('ç¢ºå®šè¦å¼·åˆ¶è¦†è“‹å—ï¼Ÿé€™æœƒè¦†è“‹å¾Œç«¯å…¶ä»–äººçš„ä¿®æ”¹ã€‚')) return;
      document.querySelector('.modal-backdrop')?.remove();
      try {
        await syncManager.saveToBackendSafe(true);
        showMaritimeMessage('âœ“ å·²å¼·åˆ¶å„²å­˜', 'success');
      } catch (e) {
        showMaritimeMessage('âœ— å„²å­˜å¤±æ•—', 'error');
      }
    }

    async function kickUser(sid, name) {
      if(confirm(`ç¢ºå®šè¸¢å‡º ${name}?`)) {
        try {
          await sessionManager.kickUser(sid);
          showMaritimeMessage('âœ“ å·²è¸¢å‡ºä½¿ç”¨è€…', 'success');
        } catch(e) {
          showMaritimeMessage('âœ— è¸¢å‡ºå¤±æ•—', 'error');
        }
      }
    }

    // å‹•ç•«
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { opacity: 0; transform: translateX(100px); }
        to { opacity: 1; transform: translateX(0); }
      }
      @keyframes slideOut {
        from { opacity: 1; transform: translateX(0); }
        to { opacity: 0; transform: translateX(100px); }
      }
    `;
    document.head.appendChild(style);

    window.addEventListener('DOMContentLoaded', initMaritimeCourseSystem);
  </script>
</body>
</html>
