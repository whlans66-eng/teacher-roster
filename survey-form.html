<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>課程問卷 - WHL MARITRAIN</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
    }

    .container {
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .question-card {
      animation: fadeIn 0.4s ease-out backwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .star-rating {
      display: flex;
      flex-direction: row-reverse;
      justify-content: flex-end;
      gap: 8px;
    }

    .star-rating input {
      display: none;
    }

    .star-rating label {
      cursor: pointer;
      font-size: 40px;
      color: #d1d5db;
      transition: color 0.2s ease;
    }

    .star-rating input:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label {
      color: #fbbf24;
    }

    .number-rating {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .number-rating input {
      display: none;
    }

    .number-rating label {
      cursor: pointer;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s ease;
      background: white;
    }

    .number-rating input:checked + label {
      background: #3b82f6;
      border-color: #3b82f6;
      color: white;
      transform: scale(1.1);
    }

    .number-rating label:hover {
      border-color: #3b82f6;
      transform: scale(1.05);
    }

    .success-animation {
      animation: successPulse 0.6s ease-out;
    }

    @keyframes successPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <div class="container max-w-3xl w-full">

    <!-- Loading State -->
    <div id="loadingState" class="bg-white rounded-2xl shadow-2xl p-12 text-center">
      <svg class="animate-spin h-12 w-12 mx-auto text-blue-600 mb-4" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="text-gray-600">載入問卷中...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="bg-white rounded-2xl shadow-2xl p-12 text-center hidden">
      <svg class="w-16 h-16 mx-auto text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <h2 class="text-2xl font-bold text-gray-900 mb-2">無法載入問卷</h2>
      <p id="errorMessage" class="text-gray-600"></p>
    </div>

    <!-- Success State -->
    <div id="successState" class="bg-white rounded-2xl shadow-2xl p-12 text-center hidden">
      <div class="success-animation">
        <svg class="w-20 h-20 mx-auto text-green-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      <h2 class="text-3xl font-bold text-gray-900 mb-2">感謝您的回饋！</h2>
      <p class="text-gray-600 text-lg">您的問卷已成功提交</p>
      <p class="text-gray-500 text-sm mt-4">您的寶貴意見將幫助我們改進課程品質</p>
    </div>

    <!-- Survey Form -->
    <div id="surveyForm" class="hidden">
      <!-- Survey Header -->
      <div class="bg-white rounded-2xl shadow-2xl p-8 mb-6">
        <div class="text-center">
          <h1 class="text-3xl font-bold text-gray-900 mb-2" id="surveyTitle">課程問卷</h1>
          <p class="text-gray-600 mb-1" id="courseInfo"></p>
          <p class="text-gray-500 text-sm" id="templateDescription"></p>
        </div>
      </div>

      <!-- Questions -->
      <form onsubmit="submitSurvey(event)">
        <!-- Respondent Info (Optional) -->
        <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6">
          <h3 class="text-lg font-bold text-gray-900 mb-4">填寫人資訊（選填）</h3>

          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">姓名</label>
            <input type="text" id="respondentName"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="請輸入您的姓名">
          </div>

          <div class="mb-0">
            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
            <input type="email" id="respondentEmail"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="請輸入您的 Email">
          </div>
        </div>

        <div id="questionsList">
          <!-- Questions will be dynamically generated -->
        </div>

        <!-- Submit Button -->
        <div class="bg-white rounded-2xl shadow-2xl p-6 mt-6">
          <button type="submit"
            class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 rounded-lg text-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all transform hover:scale-105 shadow-lg">
            提交問卷
          </button>
        </div>
      </form>
    </div>

    <!-- Closed Survey -->
    <div id="closedState" class="bg-white rounded-2xl shadow-2xl p-12 text-center hidden">
      <svg class="w-16 h-16 mx-auto text-orange-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
      </svg>
      <h2 class="text-2xl font-bold text-gray-900 mb-2">問卷已關閉</h2>
      <p class="text-gray-600">此問卷目前不開放填寫</p>
    </div>

  </div>

  <script src="js/api.js"></script>
  <script>
    let currentSurvey = null;
    let currentTemplate = null;
    let surveyId = null;

    // 初始化
    async function init() {
      // 從 URL 獲取問卷 ID
      const urlParams = new URLSearchParams(window.location.search);
      surveyId = parseInt(urlParams.get('id'));

      if (!surveyId || isNaN(surveyId)) {
        showError('缺少問卷 ID 或 ID 無效');
        return;
      }

      try {
        // 載入數據
        const allData = await syncManager.loadFromBackend();
        const surveys = allData.surveys || [];
        const templates = allData.surveyTemplates || [];

        currentSurvey = surveys.find(s => s.id === surveyId);

        if (!currentSurvey) {
          showError('問卷不存在');
          return;
        }

        // 檢查問卷狀態
        if (currentSurvey.status !== 'active') {
          showClosed();
          return;
        }

        // 檢查過期時間
        if (currentSurvey.expiresAt) {
          const expiryDate = new Date(currentSurvey.expiresAt);
          if (expiryDate < new Date()) {
            showClosed();
            return;
          }
        }

        currentTemplate = templates.find(t => t.id === currentSurvey.templateId);

        if (!currentTemplate) {
          showError('問卷模板不存在');
          return;
        }

        // 渲染問卷
        renderSurvey();

      } catch (error) {
        console.error('載入問卷失敗:', error);
        showError('載入問卷時發生錯誤: ' + error.message);
      }
    }

    // 渲染問卷
    function renderSurvey() {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('surveyForm').classList.remove('hidden');

      // 設置標題信息
      document.getElementById('surveyTitle').textContent = currentSurvey.courseName + ' - 課程問卷';
      document.getElementById('courseInfo').textContent = `授課教師：${currentSurvey.teacherName} | 日期：${currentSurvey.courseDate}`;
      document.getElementById('templateDescription').textContent = currentTemplate.description || '';

      // 渲染問題
      const questionsList = document.getElementById('questionsList');
      questionsList.innerHTML = currentTemplate.questions.map((question, index) => {
        return renderQuestion(question, index);
      }).join('');
    }

    // 渲染單個問題
    function renderQuestion(question, index) {
      const required = question.required ? '<span class="text-red-500">*</span>' : '';
      let inputHtml = '';

      if (question.type === 'rating') {
        if (question.ratingMax === 5) {
          // 星級評分
          inputHtml = '<div class="star-rating">';
          for (let i = question.ratingMax; i >= 1; i--) {
            inputHtml += `
              <input type="radio" name="q_${question.questionId}" id="q_${question.questionId}_${i}" value="${i}" ${question.required ? 'required' : ''}>
              <label for="q_${question.questionId}_${i}">★</label>
            `;
          }
          inputHtml += '</div>';
        } else {
          // 數字評分
          inputHtml = '<div class="number-rating">';
          for (let i = 1; i <= question.ratingMax; i++) {
            inputHtml += `
              <input type="radio" name="q_${question.questionId}" id="q_${question.questionId}_${i}" value="${i}" ${question.required ? 'required' : ''}>
              <label for="q_${question.questionId}_${i}">${i}</label>
            `;
          }
          inputHtml += '</div>';
        }
      } else if (question.type === 'single') {
        inputHtml = '<div class="space-y-3">';
        question.options.forEach((option, optIndex) => {
          inputHtml += `
            <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
              <input type="radio" name="q_${question.questionId}" value="${option}" ${question.required ? 'required' : ''}
                class="mr-3 w-5 h-5 text-blue-600">
              <span class="text-gray-800">${option}</span>
            </label>
          `;
        });
        inputHtml += '</div>';
      } else if (question.type === 'multiple') {
        inputHtml = '<div class="space-y-3">';
        question.options.forEach((option, optIndex) => {
          inputHtml += `
            <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
              <input type="checkbox" name="q_${question.questionId}" value="${option}"
                class="mr-3 w-5 h-5 text-blue-600 rounded">
              <span class="text-gray-800">${option}</span>
            </label>
          `;
        });
        inputHtml += '</div>';
      } else if (question.type === 'text') {
        inputHtml = `
          <textarea name="q_${question.questionId}" rows="4" ${question.required ? 'required' : ''}
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="請輸入您的回答"></textarea>
        `;
      }

      return `
        <div class="question-card bg-white rounded-2xl shadow-2xl p-6 mb-6" style="animation-delay: ${index * 0.1}s">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">
            ${index + 1}. ${question.question} ${required}
          </h3>
          ${inputHtml}
        </div>
      `;
    }

    // 提交問卷
    async function submitSurvey(event) {
      event.preventDefault();

      const formData = new FormData(event.target);
      const answers = [];

      // 收集答案
      currentTemplate.questions.forEach(question => {
        const name = 'q_' + question.questionId;
        let answer = null;

        if (question.type === 'multiple') {
          // 多選題
          answer = formData.getAll(name);
        } else {
          // 其他類型
          answer = formData.get(name);
        }

        if (answer !== null && answer !== '' && !(Array.isArray(answer) && answer.length === 0)) {
          answers.push({
            questionId: question.questionId,
            answer: answer
          });
        }
      });

      // 創建回應記錄
      const response = {
        id: Date.now(),
        surveyId: surveyId,
        respondentName: document.getElementById('respondentName').value.trim() || '匿名',
        respondentEmail: document.getElementById('respondentEmail').value.trim() || '',
        answers: answers,
        submittedAt: new Date().toISOString()
      };

      try {
        // 保存到後端
        const allData = await syncManager.loadFromBackend();
        const responses = allData.surveyResponses || [];
        responses.push(response);

        // 更新 localStorage
        localStorage.setItem('surveyResponses', JSON.stringify(responses));

        // 同步到後端
        await syncManager.saveTable('surveyResponses');

        // 顯示成功狀態
        showSuccess();

      } catch (error) {
        console.error('提交失敗:', error);
        alert('提交問卷時發生錯誤: ' + error.message);
      }
    }

    // 顯示錯誤
    function showError(message) {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('errorState').classList.remove('hidden');
      document.getElementById('errorMessage').textContent = message;
    }

    // 顯示成功
    function showSuccess() {
      document.getElementById('surveyForm').classList.add('hidden');
      document.getElementById('successState').classList.remove('hidden');
    }

    // 顯示關閉狀態
    function showClosed() {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('closedState').classList.remove('hidden');
    }

    // 頁面載入時初始化
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
