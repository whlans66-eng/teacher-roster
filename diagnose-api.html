<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API è¯Šæ–­å·¥å…·</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="js/api.js"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">ğŸ“¡ API è¿æ¥è¯Šæ–­å·¥å…·</h1>

    <div id="results" class="space-y-4"></div>

    <button onclick="runDiagnostics()" class="mt-6 bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">
      ğŸ” å¼€å§‹è¯Šæ–­
    </button>
  </div>

  <script>
    async function runDiagnostics() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      // æµ‹è¯• 1: æ£€æŸ¥ API é…ç½®
      addResult('info', 'æµ‹è¯• 1: æ£€æŸ¥ API é…ç½®');
      addResult('info', `API URL: ${API_CONFIG.baseUrl}`);
      addResult('info', `Token: ${API_CONFIG.token ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`);

      // æµ‹è¯• 2: Ping æµ‹è¯•
      addResult('info', 'æµ‹è¯• 2: Ping åç«¯...');
      try {
        const pingResult = await api.ping();
        addResult('success', `âœ… Ping æˆåŠŸ: ${JSON.stringify(pingResult)}`);
      } catch (error) {
        addResult('error', `âŒ Ping å¤±è´¥: ${error.message}`);
        addResult('error', 'å¯èƒ½åŸå› : API URL ä¸æ­£ç¡®ã€ç½‘ç»œé—®é¢˜ã€CORS é—®é¢˜ã€æˆ–åç«¯æœªéƒ¨ç½²');
        return;
      }

      // æµ‹è¯• 3: è¯»å–æ‰€æœ‰æ•°æ®
      addResult('info', 'æµ‹è¯• 3: è¯»å–æ‰€æœ‰æ•°æ® (listAll)...');
      try {
        const allData = await api.listAll();
        addResult('success', 'âœ… è¯»å–æˆåŠŸï¼');
        addResult('info', `Teachers: ${allData.teachers?.length || 0} ç¬”`);
        addResult('info', `Course Assignments: ${allData.courseAssignments?.length || 0} ç¬”`);
        addResult('info', `Maritime Courses: ${allData.maritimeCourses?.length || 0} ç¬”`);

        // æ˜¾ç¤ºè¯¾ç¨‹æ•°æ®è¯¦æƒ…
        if (allData.courseAssignments && allData.courseAssignments.length > 0) {
          addResult('success', 'ğŸ“š è¯¾ç¨‹æ•°æ®ç¤ºä¾‹:');
          allData.courseAssignments.slice(0, 3).forEach((course, idx) => {
            addResult('info', `è¯¾ç¨‹ ${idx + 1}: ${JSON.stringify(course, null, 2)}`);
          });
        } else {
          addResult('warning', 'âš ï¸ åç«¯æ²¡æœ‰è¯¾ç¨‹æ•°æ® (courseAssignments è¡¨ä¸ºç©º)');
          addResult('info', 'è¯·åœ¨ Google Sheets ä¸­æ£€æŸ¥ courseAssignments è¡¨æ˜¯å¦æœ‰æ•°æ®');
        }

      } catch (error) {
        addResult('error', `âŒ è¯»å–å¤±è´¥: ${error.message}`);
        return;
      }

      // æµ‹è¯• 4: è¯»å–ç‰¹å®šè¡¨æ ¼
      addResult('info', 'æµ‹è¯• 4: è¯»å– courseAssignments è¡¨...');
      try {
        const courses = await api.list('courseAssignments');
        addResult('success', `âœ… è¯»å–æˆåŠŸ: ${courses.length} ç¬”è¯¾ç¨‹æ•°æ®`);

        if (courses.length > 0) {
          addResult('info', 'æ•°æ®ç»“æ„æ£€æŸ¥:');
          const firstCourse = courses[0];
          const requiredFields = ['id', 'teacherId', 'name', 'date', 'time', 'type', 'status'];
          requiredFields.forEach(field => {
            if (firstCourse.hasOwnProperty(field)) {
              addResult('success', `  âœ“ ${field}: ${firstCourse[field]}`);
            } else {
              addResult('error', `  âœ— ç¼ºå°‘å­—æ®µ: ${field}`);
            }
          });
        }
      } catch (error) {
        addResult('error', `âŒ è¯»å– courseAssignments å¤±è´¥: ${error.message}`);
        return;
      }

      // æµ‹è¯• 5: localStorage æ£€æŸ¥
      addResult('info', 'æµ‹è¯• 5: æ£€æŸ¥ localStorage...');
      const localCourses = localStorage.getItem('courseAssignments');
      if (localCourses) {
        try {
          const parsed = JSON.parse(localCourses);
          addResult('success', `âœ… localStorage æœ‰æ•°æ®: ${parsed.length} ç¬”`);
        } catch (e) {
          addResult('error', 'âŒ localStorage æ•°æ®æ ¼å¼é”™è¯¯');
        }
      } else {
        addResult('warning', 'âš ï¸ localStorage ä¸­æ²¡æœ‰ courseAssignments æ•°æ®');
      }

      // æœ€ç»ˆå»ºè®®
      addResult('info', '\n=== è¯Šæ–­å®Œæˆ ===');
      addResult('success', 'å¦‚æœæ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡ï¼Œæ•°æ®åº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤ºã€‚');
      addResult('info', 'å¦‚æœå‰ç«¯ä»ç„¶çœ‹ä¸åˆ°æ•°æ®ï¼Œè¯·æ£€æŸ¥:');
      addResult('info', '1. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯');
      addResult('info', '2. æ˜¯å¦éœ€è¦åˆ·æ–°é¡µé¢');
      addResult('info', '3. initializeDataSync() æ˜¯å¦è¢«æ­£ç¡®è°ƒç”¨');
    }

    function addResult(type, message) {
      const resultsDiv = document.getElementById('results');
      const colors = {
        info: 'bg-blue-50 border-blue-200 text-blue-800',
        success: 'bg-green-50 border-green-200 text-green-800',
        warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
        error: 'bg-red-50 border-red-200 text-red-800'
      };

      const div = document.createElement('div');
      div.className = `p-3 rounded border ${colors[type]} whitespace-pre-wrap font-mono text-sm`;
      div.textContent = message;
      resultsDiv.appendChild(div);
    }
  </script>
</body>
</html>
