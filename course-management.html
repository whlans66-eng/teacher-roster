<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>派課管理系統</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .card {
      background: #ffffff;
      border-radius: 20px;
      border: 1px solid rgba(0, 0, 0, 0.04);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .calendar-day {
      min-height: 120px;
      transition: all 0.3s ease;
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 12px;
    }

    .calendar-day:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }

    .today-highlight {
      background: linear-gradient(135deg, rgba(0, 122, 255, 0.1), rgba(88, 86, 214, 0.1)) !important;
      border: 2px solid #007aff !important;
    }

    .event-item {
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 12px;
    }

    .event-item:hover {
      opacity: 0.85;
      transform: translateY(-1px);
    }

    .modern-btn {
      background: #007aff;
      color: white;
      transition: all 0.3s ease;
    }

    .modern-btn:hover {
      background: #0051d5;
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 122, 255, 0.3);
    }

    @media (max-width: 768px) {
      .calendar-grid-container {
        display: none;
      }

      .mobile-calendar-view {
        display: block !important;
      }
    }

    .mobile-calendar-view {
      display: none;
    }

    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* 微妙的背景紋理 */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(0, 122, 255, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(88, 86, 214, 0.03) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }
  </style>
</head>
<body>
  <div class="container mx-auto px-4 py-8">
    <!-- 返回首頁 -->
    <div class="mb-6">
      <a href="index.html" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
        <span class="mr-2">←</span> 返回首頁
      </a>
    </div>

    <!-- 標題區域 -->
    <div class="text-center mb-12">
      <h1 class="text-5xl font-bold text-gray-900 mb-2" style="letter-spacing: -0.02em">派課管理系統</h1>
      <p class="text-xl text-gray-600">智能管理平台</p>
    </div>

    <div class="max-w-7xl mx-auto space-y-6">
      <!-- 課程行事曆 -->
      <div class="card p-6 fade-in" style="animation-delay: 0.1s">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
          <h2 class="text-2xl font-bold text-gray-900">📅 課程行事曆</h2>
          <div class="flex items-center gap-3">
            <button onclick="openAddCourseModal()" class="modern-btn px-6 py-2 rounded-xl font-medium">
              ✨ 新增課程
            </button>
            <div class="flex bg-gray-100 rounded-xl p-1">
              <button id="monthViewBtn" onclick="setViewMode('month')" class="px-4 py-2 rounded-lg text-sm font-semibold bg-blue-600 text-white">
                📅 月
              </button>
              <button id="weekViewBtn" onclick="setViewMode('week')" class="px-4 py-2 rounded-lg text-sm font-semibold text-gray-600 hover:bg-gray-200">
                📊 週
              </button>
            </div>
          </div>
        </div>

        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center space-x-4">
            <button onclick="previousPeriod()" class="bg-white hover:bg-gray-50 px-4 py-2 rounded-xl font-medium border border-gray-200">
              ← <span id="prevLabel">上個月</span>
            </button>
            <h3 id="currentMonth" class="text-xl font-bold text-gray-800 min-w-[200px] text-center"></h3>
            <button onclick="nextPeriod()" class="bg-white hover:bg-gray-50 px-4 py-2 rounded-xl font-medium border border-gray-200">
              <span id="nextLabel">下個月</span> →
            </button>
          </div>
          <button onclick="goToToday()" class="modern-btn px-4 py-2 rounded-xl font-medium">
            🎯 今天
          </button>
        </div>

        <!-- 行事曆網格 (桌面版) -->
        <div class="calendar-grid-container bg-white rounded-xl overflow-hidden shadow-sm border border-gray-200">
          <!-- 星期標題 -->
          <div class="grid grid-cols-7 bg-gradient-to-r from-blue-500 to-blue-600">
            <div class="p-4 text-center font-bold text-white border-r border-white/20">日</div>
            <div class="p-4 text-center font-bold text-white border-r border-white/20">一</div>
            <div class="p-4 text-center font-bold text-white border-r border-white/20">二</div>
            <div class="p-4 text-center font-bold text-white border-r border-white/20">三</div>
            <div class="p-4 text-center font-bold text-white border-r border-white/20">四</div>
            <div class="p-4 text-center font-bold text-white border-r border-white/20">五</div>
            <div class="p-4 text-center font-bold text-white">六</div>
          </div>
          <!-- 日期網格 -->
          <div id="calendarGrid" class="grid grid-cols-7"></div>
        </div>

        <!-- 手機版行事曆列表 -->
        <div class="mobile-calendar-view bg-white rounded-xl overflow-hidden shadow-sm border border-gray-200 p-4">
          <div id="mobileEventsList" class="space-y-3"></div>
        </div>
      </div>

      <!-- 統計分析區 -->
      <div id="selectedTeacherBanner" class="card p-4 mb-6 fade-in" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="text-2xl">👨‍🏫</div>
            <div class="text-white">
              <p class="text-sm opacity-90">目前檢視師資</p>
              <p id="selectedTeacherName" class="text-xl font-bold"></p>
            </div>
          </div>
          <button onclick="clearTeacherSelection()" class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg font-medium transition-colors">
            ✕ 查看全部
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- 總課程數 -->
        <div class="card p-6 card-hover fade-in">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600 mb-1">總課程數</p>
              <p id="totalCoursesCount" class="text-3xl font-bold text-gray-900">0</p>
            </div>
            <div class="text-4xl">📚</div>
          </div>
        </div>

        <!-- 總時數 -->
        <div class="card p-6 card-hover fade-in" style="animation-delay: 0.1s">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600 mb-1">總授課時數</p>
              <p id="totalHoursCount" class="text-3xl font-bold text-gray-900">0</p>
            </div>
            <div class="text-4xl">⏱️</div>
          </div>
        </div>

        <!-- 本月時數 -->
        <div class="card p-6 card-hover fade-in" style="animation-delay: 0.2s">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600 mb-1">本月總時數</p>
              <p id="monthlyHoursCount" class="text-3xl font-bold text-blue-600">0</p>
            </div>
            <div class="text-4xl">📊</div>
          </div>
        </div>
      </div>

      <!-- 師資時數分析 -->
      <div id="teacherHoursAnalysisCard" class="card p-6 fade-in" style="animation-delay: 0.3s">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-gray-900">👨‍🏫 師資時數分析 (本月目標：12 小時)</h2>
          <button onclick="toggleTeacherHoursAnalysis()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
            <span id="toggleAnalysisIcon">👁️</span> <span id="toggleAnalysisText">隱藏</span>
          </button>
        </div>
        <div id="teacherHoursAnalysis">
          <!-- 搜尋框 -->
          <div class="mb-4">
            <input type="text" id="teacherSearchInput"
                   placeholder="🔍 搜尋師資姓名..."
                   oninput="filterTeachers()"
                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <!-- 師資列表 -->
          <div id="teacherHoursList" class="space-y-4">
            <!-- 師資時數條將在這裡顯示 -->
          </div>
          <!-- 顯示更多按鈕 -->
          <div id="showMoreContainer" class="mt-4 text-center" style="display: none;">
            <button onclick="toggleShowAllTeachers()" class="px-6 py-2 text-sm font-medium text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-lg transition-colors">
              <span id="showMoreText">顯示更多</span> <span id="showMoreIcon">▼</span>
            </button>
          </div>
        </div>
      </div>

      <!-- 課程類型分佈 -->
      <div class="card p-6 fade-in" style="animation-delay: 0.4s">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">📊 課程類型分佈</h2>
        <div style="position: relative; height: 300px; max-width: 600px; margin: 0 auto;">
          <canvas id="courseTypeChart"></canvas>
        </div>
      </div>

      <!-- 今日課程總覽 -->
      <div class="card p-6 fade-in" style="animation-delay: 0.5s">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-gray-900">📅 今日課程總覽</h2>
          <div class="text-sm text-gray-600" id="todayDate"></div>
        </div>
        <div id="todayCoursesContainer" class="space-y-3">
          <!-- 今日課程將在這裡顯示 -->
        </div>
      </div>
    </div>
  </div>

  <!-- 新增課程 Modal -->
  <div id="addCourseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
    <div class="card p-8 max-w-2xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
      <h3 class="text-2xl font-bold text-gray-900 mb-6">📚 新增課程</h3>
      <form id="courseForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">選擇師資</label>
          <select id="courseTeacherId" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
            <option value="">請選擇師資</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">課程名稱</label>
          <input type="text" id="courseName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">課程日期</label>
            <input type="date" id="courseDate" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">課程類型</label>
            <select id="courseType" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="正課">正課</option>
              <option value="補課">補課</option>
              <option value="實驗課">實驗課</option>
              <option value="實作課">實作課</option>
              <option value="專題">專題</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">開始時間</label>
            <input type="time" id="startTime" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">結束時間</label>
            <input type="time" id="endTime" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">狀態</label>
          <select id="courseStatus" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
            <option value="上班">上班</option>
            <option value="休假">休假</option>
            <option value="出差">出差</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">備註</label>
          <textarea id="courseNote" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="選填：課程相關備註..."></textarea>
        </div>

        <div class="flex justify-end space-x-4 pt-4">
          <button type="button" onclick="closeAddCourseModal()" class="px-6 py-3 bg-gray-500 text-white rounded-xl font-medium hover:bg-gray-600 transition-colors">
            取消
          </button>
          <button type="submit" class="modern-btn px-6 py-3 rounded-xl font-medium">
            確認新增
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 查看/編輯課程詳情 Modal -->
  <div id="viewEventModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
    <div class="card p-8 max-w-2xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
      <h3 id="modalTitle" class="text-2xl font-bold text-gray-900 mb-6">📅 課程詳情</h3>

      <!-- 查看模式 -->
      <div id="viewMode" class="space-y-4"></div>

      <!-- 編輯模式 -->
      <form id="editCourseForm" class="space-y-4" style="display: none;">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">選擇師資</label>
          <select id="editTeacherId" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
            <option value="">請選擇師資</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">課程名稱</label>
          <input type="text" id="editCourseName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">課程日期</label>
            <input type="date" id="editCourseDate" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">課程類型</label>
            <select id="editCourseType" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="正課">正課</option>
              <option value="補課">補課</option>
              <option value="實驗課">實驗課</option>
              <option value="實作課">實作課</option>
              <option value="專題">專題</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">開始時間</label>
            <input type="time" id="editStartTime" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">結束時間</label>
            <input type="time" id="editEndTime" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">狀態</label>
          <select id="editCourseStatus" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
            <option value="上班">上班</option>
            <option value="休假">休假</option>
            <option value="出差">出差</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">備註</label>
          <textarea id="editCourseNote" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="選填：課程相關備註..."></textarea>
        </div>
      </form>

      <!-- 按鈕區 -->
      <div id="viewModeButtons" class="flex justify-end space-x-4 pt-6">
        <button onclick="closeViewEventModal()" class="px-6 py-3 bg-gray-500 text-white rounded-xl font-medium hover:bg-gray-600 transition-colors">
          關閉
        </button>
        <button onclick="enterEditMode()" class="px-6 py-3 bg-blue-500 text-white rounded-xl font-medium hover:bg-blue-600 transition-colors">
          ✏️ 編輯
        </button>
        <button id="deleteEventBtn" class="px-6 py-3 bg-red-500 text-white rounded-xl font-medium hover:bg-red-600 transition-colors">
          🗑️ 刪除
        </button>
      </div>

      <div id="editModeButtons" class="flex justify-end space-x-4 pt-6" style="display: none;">
        <button onclick="cancelEditMode()" class="px-6 py-3 bg-gray-500 text-white rounded-xl font-medium hover:bg-gray-600 transition-colors">
          取消
        </button>
        <button onclick="saveEditedCourse()" class="modern-btn px-6 py-3 rounded-xl font-medium">
          💾 儲存變更
        </button>
      </div>
    </div>
  </div>

  <script>
    // ==================== 資料管理 ====================
    let teachers = JSON.parse(localStorage.getItem('teachers') || '[]');
    let courseAssignments = JSON.parse(localStorage.getItem('courseAssignments') || '[]');
    let calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');

    let currentDate = new Date();
    let viewMode = 'month';
    let courseTypeChart = null;
    let showAllTeachers = false;
    let teacherSearchQuery = '';
    let selectedTeacherId = null;
    let editingCourseId = null;

    // ==================== 工具函數 - 獲取本地日期字串 ====================
    function getLocalDateString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // ==================== 初始化 ====================
    function init() {
      loadTeachers();
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
      renderCalendar();
      updateTodayDate();
      loadTeacherHoursAnalysisVisibility();
      document.getElementById('courseForm').addEventListener('submit', handleAddCourse);
    }

    function loadTeachers() {
      const select = document.getElementById('courseTeacherId');
      select.innerHTML = '<option value="">請選擇師資</option>';
      teachers.forEach(t => {
        select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
      });
    }

    function updateTodayDate() {
      const today = new Date();
      const dateStr = today.toLocaleDateString('zh-TW', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      });
      document.getElementById('todayDate').textContent = dateStr;
    }

    // ==================== 統計分析 ====================
    function updateStatistics() {
      // 根據選擇的師資過濾課程
      let filteredCourses = courseAssignments;
      if (selectedTeacherId !== null) {
        filteredCourses = courseAssignments.filter(c => c.teacherId === selectedTeacherId);
      }

      // 總課程數
      document.getElementById('totalCoursesCount').textContent = filteredCourses.length;

      // 總時數
      const totalHours = filteredCourses.reduce((sum, c) => sum + calculateHours(c.time), 0);
      document.getElementById('totalHoursCount').textContent = `${totalHours.toFixed(1)} 小時`;

      // 本月時數
      const thisMonth = new Date().toISOString().slice(0, 7);
      const monthlyHours = filteredCourses
        .filter(c => c.date.startsWith(thisMonth))
        .reduce((sum, c) => sum + calculateHours(c.time), 0);
      document.getElementById('monthlyHoursCount').textContent = `${monthlyHours.toFixed(1)} 小時`;
    }

    function renderTeacherHoursAnalysis() {
      const thisMonth = new Date().toISOString().slice(0, 7);
      const listContainer = document.getElementById('teacherHoursList');
      const showMoreContainer = document.getElementById('showMoreContainer');

      if (teachers.length === 0) {
        listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">尚無師資資料</p>';
        showMoreContainer.style.display = 'none';
        return;
      }

      // 過濾師資（根據搜尋條件）
      let filteredTeachers = teachers;
      if (teacherSearchQuery.trim() !== '') {
        filteredTeachers = teachers.filter(teacher =>
          teacher.name.toLowerCase().includes(teacherSearchQuery.toLowerCase())
        );
      }

      if (filteredTeachers.length === 0) {
        listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">找不到符合的師資</p>';
        showMoreContainer.style.display = 'none';
        return;
      }

      // 決定顯示的師資數量
      const displayLimit = 4;
      const shouldShowMore = filteredTeachers.length > displayLimit && teacherSearchQuery === '';
      const displayTeachers = (shouldShowMore && !showAllTeachers)
        ? filteredTeachers.slice(0, displayLimit)
        : filteredTeachers;

      // 顯示/隱藏「顯示更多」按鈕
      if (shouldShowMore) {
        showMoreContainer.style.display = 'block';
        document.getElementById('showMoreText').textContent = showAllTeachers ? '收合' : '顯示更多';
        document.getElementById('showMoreIcon').textContent = showAllTeachers ? '▲' : '▼';
      } else {
        showMoreContainer.style.display = 'none';
      }

      // 渲染師資列表
      listContainer.innerHTML = displayTeachers.map(teacher => {
        const courses = courseAssignments.filter(c =>
          c.teacherId === teacher.id && c.date.startsWith(thisMonth)
        );
        const hours = courses.reduce((sum, c) => sum + calculateHours(c.time), 0);
        const percentage = Math.min((hours / 12) * 100, 100);

        let statusClass = 'bg-red-500';
        let statusText = '未達標';
        if (hours >= 12) {
          statusClass = 'bg-green-500';
          statusText = '已達標';
        } else if (hours >= 8) {
          statusClass = 'bg-yellow-500';
          statusText = '接近達標';
        }

        const isSelected = selectedTeacherId === teacher.id;
        const selectedStyle = isSelected
          ? 'border-2 border-blue-500 bg-blue-50 shadow-lg'
          : 'border border-gray-200 hover:border-blue-300 hover:shadow-md';

        return `
          <div onclick="selectTeacher(${teacher.id})"
               class="${selectedStyle} rounded-xl p-4 cursor-pointer transition-all duration-300">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold">
                  ${(teacher.name || '?')[0]}
                </div>
                <div>
                  <h4 class="font-semibold text-gray-900">${teacher.name}</h4>
                  <p class="text-xs text-gray-500">${courses.length} 堂課</p>
                </div>
              </div>
              <div class="text-right">
                <p class="text-sm font-bold text-gray-900">${hours.toFixed(1)} / 12 小時</p>
                <span class="text-xs ${statusClass} text-white px-2 py-1 rounded-full">${statusText}</span>
              </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
              <div class="${statusClass} h-3 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
            </div>
            ${isSelected ? '<p class="text-xs text-blue-600 font-semibold mt-2 text-center">✓ 已選擇</p>' : ''}
          </div>
        `;
      }).join('');
    }

    function filterTeachers() {
      teacherSearchQuery = document.getElementById('teacherSearchInput').value;
      showAllTeachers = false; // 重置展開狀態
      renderTeacherHoursAnalysis();
    }

    function toggleShowAllTeachers() {
      showAllTeachers = !showAllTeachers;
      renderTeacherHoursAnalysis();
    }

    // ==================== 課程類型分佈圖 ====================
    function renderCourseTypeChart() {
      // 根據選擇的師資過濾課程
      let filteredCourses = courseAssignments;
      if (selectedTeacherId !== null) {
        filteredCourses = courseAssignments.filter(c => c.teacherId === selectedTeacherId);
      }

      const typeCount = {};
      filteredCourses.forEach(c => {
        typeCount[c.type] = (typeCount[c.type] || 0) + 1;
      });

      const typeCtx = document.getElementById('courseTypeChart').getContext('2d');
      if (courseTypeChart) courseTypeChart.destroy();

      courseTypeChart = new Chart(typeCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(typeCount),
          datasets: [{
            data: Object.values(typeCount),
            backgroundColor: ['#007aff', '#34c759', '#ff9500', '#ff3b30', '#5856d6'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: { size: 14 },
                padding: 15
              }
            }
          }
        }
      });
    }

    // ==================== 師資選擇功能 ====================
    function selectTeacher(teacherId) {
      selectedTeacherId = teacherId;
      const teacher = teachers.find(t => t.id === teacherId);

      // 顯示選擇的師資橫幅
      const banner = document.getElementById('selectedTeacherBanner');
      const nameElement = document.getElementById('selectedTeacherName');
      if (teacher) {
        nameElement.textContent = teacher.name;
        banner.style.display = 'block';
      }

      // 更新所有相關數據
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
    }

    function clearTeacherSelection() {
      selectedTeacherId = null;

      // 隱藏選擇的師資橫幅
      const banner = document.getElementById('selectedTeacherBanner');
      banner.style.display = 'none';

      // 更新所有相關數據
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
    }

    // ==================== 師資時數分析顯示/隱藏 ====================
    function toggleTeacherHoursAnalysis() {
      const analysisContent = document.getElementById('teacherHoursAnalysis');
      const toggleIcon = document.getElementById('toggleAnalysisIcon');
      const toggleText = document.getElementById('toggleAnalysisText');

      const isVisible = analysisContent.style.display !== 'none';

      if (isVisible) {
        analysisContent.style.display = 'none';
        toggleIcon.textContent = '👁️‍🗨️';
        toggleText.textContent = '顯示';
        localStorage.setItem('teacherHoursAnalysisVisible', 'false');
      } else {
        analysisContent.style.display = 'block';
        toggleIcon.textContent = '👁️';
        toggleText.textContent = '隱藏';
        localStorage.setItem('teacherHoursAnalysisVisible', 'true');
      }
    }

    function loadTeacherHoursAnalysisVisibility() {
      const isVisible = localStorage.getItem('teacherHoursAnalysisVisible');

      if (isVisible === 'false') {
        const analysisContent = document.getElementById('teacherHoursAnalysis');
        const toggleIcon = document.getElementById('toggleAnalysisIcon');
        const toggleText = document.getElementById('toggleAnalysisText');

        analysisContent.style.display = 'none';
        toggleIcon.textContent = '👁️‍🗨️';
        toggleText.textContent = '顯示';
      }
    }

    // ==================== 今日課程總覽 ====================
    function renderTodayCourses() {
      const todayStr = getLocalDateString(new Date());
      let todayCourses = courseAssignments.filter(c => c.date === todayStr);

      // 根據選擇的師資過濾
      if (selectedTeacherId !== null) {
        todayCourses = todayCourses.filter(c => c.teacherId === selectedTeacherId);
      }

      const container = document.getElementById('todayCoursesContainer');

      if (todayCourses.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-2">✨</div>
            <p>今天沒有排課</p>
          </div>
        `;
        return;
      }

      // 按師資分組
      const grouped = {};
      todayCourses.forEach(c => {
        if (!grouped[c.teacherId]) {
          grouped[c.teacherId] = [];
        }
        grouped[c.teacherId].push(c);
      });

      container.innerHTML = Object.entries(grouped).map(([teacherId, courses]) => {
        const teacher = teachers.find(t => t.id === Number(teacherId));
        if (!teacher) return '';

        return `
          <div class="bg-white rounded-xl p-4 border border-gray-200">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 p-0.5">
                  <div class="w-full h-full rounded-full bg-white flex items-center justify-center">
                    ${teacher.photo ?
                      `<img src="${teacher.photo}" class="w-full h-full object-cover rounded-full">` :
                      `<span class="text-lg font-bold text-gray-600">${(teacher.name || '?')[0]}</span>`
                    }
                  </div>
                </div>
                <div>
                  <h4 class="font-semibold text-gray-800">${teacher.name}</h4>
                  <p class="text-xs text-gray-500">${courses.length} 堂課</p>
                </div>
              </div>
            </div>
            <div class="space-y-2">
              ${courses.sort((a, b) => a.time.localeCompare(b.time)).map(c => {
                const statusColors = {
                  '上班': 'bg-blue-50 text-blue-700 border-blue-200',
                  '休假': 'bg-green-50 text-green-700 border-green-200',
                  '出差': 'bg-orange-50 text-orange-700 border-orange-200'
                };
                const statusClass = statusColors[c.status] || statusColors['上班'];

                return `
                  <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100 transition-colors border border-gray-200" onclick="viewEvent(${c.id})">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <p class="font-medium text-gray-800">${c.name}</p>
                        <div class="flex items-center flex-wrap gap-2 text-xs text-gray-600 mt-2">
                          <span>🕐 ${c.time}</span>
                          <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded border border-blue-200">${c.type}</span>
                          <span class="px-2 py-0.5 ${statusClass} rounded border">${c.status || '上班'}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    // ==================== 行事曆 ====================
    function setViewMode(mode) {
      viewMode = mode;
      const monthBtn = document.getElementById('monthViewBtn');
      const weekBtn = document.getElementById('weekViewBtn');

      if (mode === 'month') {
        monthBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-blue-600 text-white';
        weekBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold text-gray-600 hover:bg-gray-200';
        document.getElementById('prevLabel').textContent = '上個月';
        document.getElementById('nextLabel').textContent = '下個月';
      } else {
        weekBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-blue-600 text-white';
        monthBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold text-gray-600 hover:bg-gray-200';
        document.getElementById('prevLabel').textContent = '上週';
        document.getElementById('nextLabel').textContent = '下週';
      }

      renderCalendar();
    }

    function previousPeriod() {
      if (viewMode === 'month') {
        currentDate.setMonth(currentDate.getMonth() - 1);
      } else {
        currentDate.setDate(currentDate.getDate() - 7);
      }
      renderCalendar();
    }

    function nextPeriod() {
      if (viewMode === 'month') {
        currentDate.setMonth(currentDate.getMonth() + 1);
      } else {
        currentDate.setDate(currentDate.getDate() + 7);
      }
      renderCalendar();
    }

    function goToToday() {
      currentDate = new Date();
      renderCalendar();
    }

    function renderCalendar() {
      if (viewMode === 'month') {
        renderMonthView();
      } else {
        renderWeekView();
      }
      renderMobileCalendar();
    }

    function renderMonthView() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const monthNames = ['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月'];

      document.getElementById('currentMonth').textContent = `${year}年 ${monthNames[month]}`;

      const firstDay = new Date(year, month, 1);
      const start = new Date(firstDay);
      start.setDate(start.getDate() - firstDay.getDay());

      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      const todayStr = getLocalDateString(new Date());

      for (let w = 0; w < 6; w++) {
        for (let d = 0; d < 7; d++) {
          const cellDate = new Date(start);
          cellDate.setDate(start.getDate() + (w * 7) + d);

          const isCurrentMonth = (cellDate.getMonth() === month);
          const dateKey = getLocalDateString(cellDate);
          const isToday = (dateKey === todayStr);

          const dayEvents = courseAssignments.filter(c => c.date === dateKey);

          const cell = document.createElement('div');
          cell.className = `calendar-day p-2 ${
            isCurrentMonth ? 'bg-white' : 'bg-gray-50'
          } ${isToday ? 'today-highlight' : ''}`;

          cell.innerHTML = `
            <div class="flex justify-between items-start mb-1">
              <span class="text-base font-semibold ${isCurrentMonth ? (isToday ? 'text-blue-600' : 'text-gray-800') : 'text-gray-400'}">
                ${cellDate.getDate()}
              </span>
            </div>
            <div class="space-y-1 overflow-y-auto max-h-20">
              ${dayEvents.map(e => {
                const teacher = teachers.find(t => t.id === e.teacherId);
                const teacherName = teacher ? teacher.name : '未知';
                return `
                  <div class="event-item bg-blue-500 text-white rounded cursor-pointer hover:bg-blue-600"
                       onclick="viewEvent(${e.id})">
                    <div class="font-medium truncate">${teacherName}</div>
                    <div class="text-[10px] truncate">${e.time} ${e.name}</div>
                  </div>
                `;
              }).join('')}
            </div>
          `;

          grid.appendChild(cell);
        }
      }
    }

    function renderWeekView() {
      const startOfWeek = new Date(currentDate);
      startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);

      const monthNames = ['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月'];
      document.getElementById('currentMonth').textContent =
        `${startOfWeek.getFullYear()}年 ${monthNames[startOfWeek.getMonth()]} ${startOfWeek.getDate()}日 - ${endOfWeek.getDate()}日`;

      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      const dayNames = ['日','一','二','三','四','五','六'];
      const todayStr = getLocalDateString(new Date());

      for (let i = 0; i < 7; i++) {
        const cellDate = new Date(startOfWeek);
        cellDate.setDate(startOfWeek.getDate() + i);

        const dateKey = getLocalDateString(cellDate);
        const isToday = (dateKey === todayStr);
        const dayEvents = courseAssignments.filter(c => c.date === dateKey);

        const cell = document.createElement('div');
        cell.className = `calendar-day p-4 bg-white ${isToday ? 'today-highlight' : ''}`;

        cell.innerHTML = `
          <div class="text-center mb-4 pb-3 border-b border-gray-200">
            <div class="text-sm font-semibold ${isToday ? 'text-blue-600' : 'text-gray-600'}">${dayNames[i]}</div>
            <div class="text-2xl font-bold ${isToday ? 'text-blue-600' : 'text-gray-800'}">
              ${cellDate.getDate()}
            </div>
          </div>
          <div class="space-y-2">
            ${dayEvents.map(e => {
              const teacher = teachers.find(t => t.id === e.teacherId);
              const teacherName = teacher ? teacher.name : '未知';
              return `
                <div class="event-item bg-blue-500 text-white p-3 rounded-xl cursor-pointer hover:bg-blue-600"
                     onclick="viewEvent(${e.id})">
                  <div class="font-semibold">${teacherName}</div>
                  <div class="text-xs mt-1">⏰ ${e.time}</div>
                  <div class="text-xs">${e.name}</div>
                </div>
              `;
            }).join('')}
          </div>
        `;

        grid.appendChild(cell);
      }
    }

    function renderMobileCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const todayStr = getLocalDateString(new Date());

      const container = document.getElementById('mobileEventsList');
      let html = '';

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateKey = getLocalDateString(date);
        const dayEvents = courseAssignments.filter(c => c.date === dateKey);
        const isToday = dateKey === todayStr;

        if (dayEvents.length > 0 || isToday) {
          const dayNames = ['日','一','二','三','四','五','六'];
          html += `
            <div class="border border-gray-200 rounded-lg p-3 ${isToday ? 'bg-blue-50 border-blue-500' : 'bg-white'}">
              <div class="flex items-center justify-between mb-2">
                <span class="font-bold text-gray-800">${month + 1}月${day}日 (${dayNames[date.getDay()]})</span>
                ${isToday ? '<span class="text-xs bg-blue-500 text-white px-2 py-1 rounded">今天</span>' : ''}
              </div>
              ${dayEvents.length === 0 ?
                '<p class="text-sm text-gray-500">無課程</p>' :
                dayEvents.map(e => {
                  const teacher = teachers.find(t => t.id === e.teacherId);
                  const teacherName = teacher ? teacher.name : '未知';
                  return `
                    <div class="mt-2 p-2 bg-blue-500 text-white rounded-lg cursor-pointer hover:bg-blue-600" onclick="viewEvent(${e.id})">
                      <div class="font-semibold text-sm">${teacherName} - ${e.name}</div>
                      <div class="text-xs mt-1">⏰ ${e.time} | 📚 ${e.type}</div>
                    </div>
                  `;
                }).join('')
              }
            </div>
          `;
        }
      }

      if (!html) {
        html = '<p class="text-center text-gray-500 py-8">本月無課程</p>';
      }

      container.innerHTML = html;
    }

    // ==================== Modal 管理 ====================
    function openAddCourseModal() {
      document.getElementById('courseDate').value = getLocalDateString(new Date());
      document.getElementById('addCourseModal').classList.remove('hidden');
    }

    function closeAddCourseModal() {
      document.getElementById('addCourseModal').classList.add('hidden');
      document.getElementById('courseForm').reset();
    }

    function viewEvent(courseId) {
      const course = courseAssignments.find(c => c.id === courseId);
      if (!course) return;

      editingCourseId = courseId;
      const teacher = teachers.find(t => t.id === course.teacherId);

      // 顯示查看模式
      document.getElementById('modalTitle').textContent = '📅 課程詳情';
      document.getElementById('viewMode').style.display = 'block';
      document.getElementById('editCourseForm').style.display = 'none';
      document.getElementById('viewModeButtons').style.display = 'flex';
      document.getElementById('editModeButtons').style.display = 'none';

      document.getElementById('viewMode').innerHTML = `
        <div class="bg-gray-50 rounded-xl p-4 space-y-3 border border-gray-200">
          <div>
            <label class="text-xs font-medium text-gray-600">師資</label>
            <p class="text-lg font-semibold text-gray-900">👨‍🏫 ${teacher ? teacher.name : '未知'}</p>
          </div>
          <div>
            <label class="text-xs font-medium text-gray-600">課程名稱</label>
            <p class="text-lg font-semibold text-gray-900">${course.name}</p>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-medium text-gray-600">日期</label>
              <p class="text-sm text-gray-800">📅 ${course.date}</p>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-600">時間</label>
              <p class="text-sm text-gray-800">⏰ ${course.time}</p>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-medium text-gray-600">課程類型</label>
              <p class="text-sm text-gray-800">📚 ${course.type}</p>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-600">狀態</label>
              <p class="text-sm text-gray-800">💼 ${course.status || '上班'}</p>
            </div>
          </div>
          ${course.note ? `
          <div>
            <label class="text-xs font-medium text-gray-600">備註</label>
            <p class="text-sm text-gray-800 whitespace-pre-wrap">${course.note}</p>
          </div>
          ` : '<div class="text-center text-gray-400 text-sm py-2">無備註</div>'}
        </div>
      `;

      document.getElementById('deleteEventBtn').onclick = () => {
        if (confirm('確定要刪除此課程嗎？')) {
          deleteCourse(courseId);
          closeViewEventModal();
        }
      };

      document.getElementById('viewEventModal').classList.remove('hidden');
    }

    function enterEditMode() {
      const course = courseAssignments.find(c => c.id === editingCourseId);
      if (!course) return;

      // 載入師資列表到編輯表單
      const editTeacherSelect = document.getElementById('editTeacherId');
      editTeacherSelect.innerHTML = '<option value="">請選擇師資</option>';
      teachers.forEach(t => {
        editTeacherSelect.innerHTML += `<option value="${t.id}" ${t.id === course.teacherId ? 'selected' : ''}>${t.name}</option>`;
      });

      // 填入課程資料
      document.getElementById('editCourseName').value = course.name;
      document.getElementById('editCourseDate').value = course.date;
      document.getElementById('editCourseType').value = course.type;

      const [startTime, endTime] = course.time.split('-');
      document.getElementById('editStartTime').value = startTime;
      document.getElementById('editEndTime').value = endTime;

      document.getElementById('editCourseStatus').value = course.status || '上班';
      document.getElementById('editCourseNote').value = course.note || '';

      // 切換到編輯模式
      document.getElementById('modalTitle').textContent = '✏️ 編輯課程';
      document.getElementById('viewMode').style.display = 'none';
      document.getElementById('editCourseForm').style.display = 'block';
      document.getElementById('viewModeButtons').style.display = 'none';
      document.getElementById('editModeButtons').style.display = 'flex';
    }

    function cancelEditMode() {
      // 返回查看模式
      viewEvent(editingCourseId);
    }

    function saveEditedCourse() {
      const teacherId = Number(document.getElementById('editTeacherId').value);
      if (!teacherId) {
        alert('請選擇師資！');
        return;
      }

      const startTime = document.getElementById('editStartTime').value;
      const endTime = document.getElementById('editEndTime').value;
      const courseDate = document.getElementById('editCourseDate').value;

      // 找到要編輯的課程
      const courseIndex = courseAssignments.findIndex(c => c.id === editingCourseId);
      if (courseIndex === -1) return;

      const oldCourse = courseAssignments[courseIndex];

      // 檢查時間衝突（排除自己）
      const newTime = `${startTime}-${endTime}`;
      const conflicts = checkConflictExcludingSelf(
        editingCourseId,
        teacherId,
        courseDate,
        newTime
      );

      if (conflicts.length > 0) {
        if (!confirm(`⚠️ 衝堂警告！\n\n${conflicts.join('\n')}\n\n是否仍要繼續？`)) {
          return;
        }
      }

      // 更新課程資料
      courseAssignments[courseIndex] = {
        ...oldCourse,
        teacherId: teacherId,
        name: document.getElementById('editCourseName').value,
        date: courseDate,
        time: newTime,
        type: document.getElementById('editCourseType').value,
        status: document.getElementById('editCourseStatus').value,
        note: document.getElementById('editCourseNote').value.trim()
      };

      // 同步更新行事曆事件
      const eventIndex = calendarEvents.findIndex(e => e.courseId === editingCourseId);
      if (eventIndex !== -1) {
        const teacher = teachers.find(t => t.id === teacherId);
        calendarEvents[eventIndex] = {
          ...calendarEvents[eventIndex],
          date: courseDate,
          title: `${courseAssignments[courseIndex].name} - ${teacher.name}`,
          time: newTime,
          teacherId: teacherId,
          location: courseAssignments[courseIndex].type,
          color: getCourseTypeColor(courseAssignments[courseIndex].type)
        };
      }

      saveData();
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
      renderCalendar();
      closeViewEventModal();
      alert('✅ 課程已更新！');
    }

    function checkConflictExcludingSelf(excludeId, teacherId, date, time) {
      const conflicts = [];
      const timeToMinutes = (t) => {
        const [h, m] = t.split(':').map(Number);
        return h * 60 + m;
      };

      const [newStart, newEnd] = time.split('-');
      const newStartMin = timeToMinutes(newStart);
      const newEndMin = timeToMinutes(newEnd);

      courseAssignments.forEach(c => {
        if (c.id !== excludeId && c.teacherId === teacherId && c.date === date) {
          const [start, end] = c.time.split('-');
          const startMin = timeToMinutes(start);
          const endMin = timeToMinutes(end);

          if (!(newEndMin <= startMin || newStartMin >= endMin)) {
            conflicts.push(`- ${c.name} (${c.time})`);
          }
        }
      });

      return conflicts;
    }

    function closeViewEventModal() {
      document.getElementById('viewEventModal').classList.add('hidden');
      editingCourseId = null;
    }

    // ==================== 課程管理 ====================
    function handleAddCourse(e) {
      e.preventDefault();

      const teacherId = Number(document.getElementById('courseTeacherId').value);
      if (!teacherId) {
        alert('請選擇師資！');
        return;
      }

      const courseData = {
        id: Date.now(),
        teacherId: teacherId,
        name: document.getElementById('courseName').value,
        date: document.getElementById('courseDate').value,
        time: `${document.getElementById('startTime').value}-${document.getElementById('endTime').value}`,
        type: document.getElementById('courseType').value,
        status: document.getElementById('courseStatus').value,
        note: document.getElementById('courseNote').value.trim()
      };

      // 衝堂檢查
      const conflicts = checkConflict(courseData);
      if (conflicts.length > 0) {
        if (!confirm(`⚠️ 衝堂警告！\n\n${conflicts.join('\n')}\n\n是否仍要繼續？`)) {
          return;
        }
      }

      courseAssignments.push(courseData);

      // 同步到行事曆
      const teacher = teachers.find(t => t.id === teacherId);
      calendarEvents.push({
        id: courseData.id,
        date: courseData.date,
        title: `${courseData.name} - ${teacher.name}`,
        time: courseData.time,
        teacherId: teacherId,
        location: courseData.type,
        color: getCourseTypeColor(courseData.type),
        courseId: courseData.id
      });

      saveData();
      closeAddCourseModal();
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
      renderCalendar();
      alert('✅ 課程新增成功！');
    }

    function deleteCourse(id) {
      courseAssignments = courseAssignments.filter(c => c.id !== id);
      calendarEvents = calendarEvents.filter(e => e.courseId !== id);
      saveData();
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
      renderCalendar();
      alert('✅ 課程已刪除！');
    }

    // ==================== 工具函數 ====================
    function calculateHours(timeRange) {
      const [start, end] = timeRange.split('-');
      const startTime = new Date(`2024-01-01 ${start}`);
      const endTime = new Date(`2024-01-01 ${end}`);
      return (endTime - startTime) / (1000 * 60 * 60);
    }

    function checkConflict(newCourse) {
      const conflicts = [];
      const timeToMinutes = (time) => {
        const [h, m] = time.split(':').map(Number);
        return h * 60 + m;
      };

      const [newStart, newEnd] = newCourse.time.split('-');
      const newStartMin = timeToMinutes(newStart);
      const newEndMin = timeToMinutes(newEnd);

      courseAssignments.forEach(c => {
        if (c.teacherId === newCourse.teacherId && c.date === newCourse.date) {
          const [start, end] = c.time.split('-');
          const startMin = timeToMinutes(start);
          const endMin = timeToMinutes(end);

          if (!(newEndMin <= startMin || newStartMin >= endMin)) {
            conflicts.push(`- ${c.name} (${c.time})`);
          }
        }
      });

      return conflicts;
    }

    function getCourseTypeColor(type) {
      const colors = {
        '正課': 'bg-blue-500',
        '補課': 'bg-yellow-500',
        '實驗課': 'bg-purple-500',
        '實作課': 'bg-green-500',
        '專題': 'bg-red-500'
      };
      return colors[type] || 'bg-gray-500';
    }

    function saveData() {
      try {
        localStorage.setItem('teachers', JSON.stringify(teachers));
        localStorage.setItem('courseAssignments', JSON.stringify(courseAssignments));
        localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
      } catch (err) {
        console.error('儲存失敗:', err);
      }
    }

    // ==================== 啟動應用 ====================
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
