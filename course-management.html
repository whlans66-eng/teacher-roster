<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>派課管理系統</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- XLSX 庫 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      animation: fadeInDown 0.8s ease-out;
    }

    .header h1 {
      font-size: 48px;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: #1d1d1f;
      margin-bottom: 8px;
    }

    .header p {
      font-size: 19px;
      color: #6e6e73;
      font-weight: 400;
    }

    .back-button {
      display: inline-flex;
      align-items: center;
      padding: 12px 24px;
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 12px;
      color: #1d1d1f;
      text-decoration: none;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .back-button:hover {
      background: #f5f5f7;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      transform: translateX(-4px);
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 32px;
      box-shadow: 0 2px 16px rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(0, 0, 0, 0.04);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-bottom: 24px;
    }

    .card:hover {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    }

    .stat-card {
      background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
      border-radius: 18px;
      padding: 28px;
      color: white;
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
      transition: all 0.4s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 16px 48px rgba(0, 122, 255, 0.3);
    }

    .stat-card:hover::before {
      top: -30%;
      right: -30%;
    }

    .stat-card.purple {
      background: linear-gradient(135deg, #5856d6 0%, #3634a3 100%);
    }

    .stat-card.purple:hover {
      box-shadow: 0 16px 48px rgba(88, 86, 214, 0.3);
    }

    .stat-card.green {
      background: linear-gradient(135deg, #34c759 0%, #248a3d 100%);
    }

    .stat-card.green:hover {
      box-shadow: 0 16px 48px rgba(52, 199, 89, 0.3);
    }

    .stat-card.orange {
      background: linear-gradient(135deg, #ff9500 0%, #c76a00 100%);
    }

    .stat-card.orange:hover {
      box-shadow: 0 16px 48px rgba(255, 149, 0, 0.3);
    }

    .btn-primary {
      background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
      color: white;
      padding: 14px 28px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 16px rgba(0, 122, 255, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 122, 255, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .input-field {
      width: 100%;
      padding: 14px 18px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.3s ease;
      background: #ffffff;
    }

    .input-field:focus {
      outline: none;
      border-color: #007aff;
      box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 24px 64px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }

    .course-timeline-item {
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 14px;
      padding: 24px;
      margin-bottom: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: white;
    }

    .course-timeline-item:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      transform: translateY(-2px);
      border-color: #007aff;
    }

    .type-card {
      border-radius: 14px;
      padding: 20px;
      text-align: center;
      color: white;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .type-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
    }

    .date-range-btn {
      padding: 10px 20px;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      background: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .date-range-btn:hover {
      background: #007aff;
      color: white;
      border-color: #007aff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }

    /* 微妙的背景紋理 */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(0, 122, 255, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(88, 86, 214, 0.03) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 返回首頁按鈕 -->
    <div style="margin-bottom: 30px;">
      <a href="index.html" class="back-button">
        <span style="margin-right: 8px;">←</span> 返回首頁
      </a>
    </div>

    <!-- 標題 -->
    <div class="header">
      <h1>派課管理系統</h1>
      <p>管理師資課程分配與時數統計</p>
    </div>

    <!-- 主要內容 -->
    <div class="fade-in">
      <!-- 師資選擇與日期範圍 -->
      <div class="card">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
          <div>
            <label style="display: block; font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">選擇師資</label>
            <select id="courseTeacherSelect" onchange="updateCourseView()" class="input-field">
              <option value="">請選擇師資</option>
            </select>
          </div>
          <div>
            <label style="display: block; font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">開始日期</label>
            <input type="date" id="courseStartDate" onchange="updateCourseView()" class="input-field">
          </div>
          <div>
            <label style="display: block; font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">結束日期</label>
            <input type="date" id="courseEndDate" onchange="updateCourseView()" class="input-field">
          </div>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap;">
          <button onclick="setCourseDateRange('thisMonth')" class="date-range-btn">本月</button>
          <button onclick="setCourseDateRange('lastMonth')" class="date-range-btn">上月</button>
          <button onclick="setCourseDateRange('last3Months')" class="date-range-btn">近3月</button>
          <button onclick="setCourseDateRange('last6Months')" class="date-range-btn">近半年</button>
          <button onclick="setCourseDateRange('thisYear')" class="date-range-btn">今年</button>
        </div>
      </div>

      <!-- 統計卡片 -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px;">
        <div class="stat-card">
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">授課時數</div>
            <div id="courseTotalHours" style="font-size: 42px; font-weight: 700; margin-bottom: 4px;">0</div>
            <div style="font-size: 12px; opacity: 0.8;">小時</div>
          </div>
        </div>

        <div class="stat-card purple">
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">課程數量</div>
            <div id="courseTotalCount" style="font-size: 42px; font-weight: 700; margin-bottom: 4px;">0</div>
            <div style="font-size: 12px; opacity: 0.8;">門課程</div>
          </div>
        </div>

        <div class="stat-card green">
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">本月時數</div>
            <div id="courseMonthlyHours" style="font-size: 42px; font-weight: 700; margin-bottom: 4px;">0</div>
            <div style="font-size: 12px; opacity: 0.8;">小時</div>
          </div>
        </div>

        <div class="stat-card orange">
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">今日課程</div>
            <div id="courseTodayCount" style="font-size: 42px; font-weight: 700; margin-bottom: 4px;">0</div>
            <div style="font-size: 12px; opacity: 0.8;">門課程</div>
          </div>
        </div>
      </div>

      <!-- 課程類型分析 -->
      <div class="card">
        <h3 style="font-size: 20px; font-weight: 600; color: #1d1d1f; margin-bottom: 24px;">課程類型分析</h3>
        <div id="courseTypeCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
          <!-- 動態生成 -->
        </div>
      </div>

      <!-- 老師本週課表 -->
      <div id="teacherWeekSchedule" class="card" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h3 style="font-size: 20px; font-weight: 600; color: #1d1d1f;">本週課表 - 即時檢視可用時段</h3>
          <span style="font-size: 13px; color: #6e6e73;">綠色：可用 | 紅色：已佔用</span>
        </div>
        <div id="teacherWeekScheduleContent">
          <!-- 動態生成 -->
        </div>
      </div>

      <!-- 課程時間軸 -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h3 style="font-size: 20px; font-weight: 600; color: #1d1d1f;">課程時間軸</h3>
          <button onclick="openAddCourseModal()" class="btn-primary">
            <span style="margin-right: 8px;">➕</span>新增課程
          </button>
        </div>
        <div id="courseTimeline" style="max-height: 600px; overflow-y: auto;">
          <div style="text-align: center; color: #6e6e73; padding: 48px 0;">
            請選擇師資以查看課程
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 新增課程 Modal -->
  <div id="addCourseModal" class="modal">
    <div class="modal-content">
      <h3 style="font-size: 28px; font-weight: 600; color: #1d1d1f; margin-bottom: 24px;">新增課程</h3>
      <form id="addCourseForm" onsubmit="addCourseSubmit(event)" style="display: flex; flex-direction: column; gap: 20px;">
        <div>
          <label style="display: block; font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">課程名稱</label>
          <input type="text" id="addCourseName" required class="input-field" placeholder="請輸入課程名稱">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div>
            <label style="display: block; font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">課程日期</label>
            <input type="date" id="addCourseDate" required class="input-field">
          </div>
          <div>
            <label style="display: block; font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">課程類型</label>
            <select id="addCourseType" class="input-field">
              <option value="正課">正課</option>
              <option value="補課">補課</option>
              <option value="實驗課">實驗課</option>
              <option value="實作課">實作課</option>
              <option value="專題">專題</option>
            </select>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div>
            <label style="display: block; font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">開始時間</label>
            <input type="time" id="addCourseStartTime" required class="input-field">
          </div>
          <div>
            <label style="display: block; font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">結束時間</label>
            <input type="time" id="addCourseEndTime" required class="input-field">
          </div>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 12px;">
          <button type="button" onclick="closeAddCourseModal()" style="padding: 14px 28px; background: #f5f5f7; color: #1d1d1f; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
            取消
          </button>
          <button type="submit" class="btn-primary">確認新增</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ========== 數據管理 ==========
    let teachers = JSON.parse(localStorage.getItem('teachers') || '[]');
    let courseAssignments = JSON.parse(localStorage.getItem('courseAssignments') || '[]');
    let calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
    let currentCourseTeacherId = null;
    let currentCourseStartDate = null;
    let currentCourseEndDate = null;

    // ========== 初始化 ==========
    function init() {
      // 載入師資列表
      const teacherSelect = document.getElementById('courseTeacherSelect');
      teacherSelect.innerHTML = '<option value="">請選擇師資</option>';
      teachers.forEach(teacher => {
        const option = document.createElement('option');
        option.value = String(teacher.id);
        option.textContent = teacher.name;
        teacherSelect.appendChild(option);
      });

      // 初始化日期為本月
      initCourseDates();
    }

    // ========== 日期管理 ==========
    function initCourseDates() {
      const today = new Date();
      const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
      const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);

      currentCourseStartDate = startDate.toISOString().split('T')[0];
      currentCourseEndDate = endDate.toISOString().split('T')[0];

      document.getElementById('courseStartDate').value = currentCourseStartDate;
      document.getElementById('courseEndDate').value = currentCourseEndDate;
    }

    function setCourseDateRange(range) {
      const today = new Date();
      let startDate, endDate;

      switch(range) {
        case 'thisMonth':
          startDate = new Date(today.getFullYear(), today.getMonth(), 1);
          endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
          break;
        case 'lastMonth':
          startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
          endDate = new Date(today.getFullYear(), today.getMonth(), 0);
          break;
        case 'last3Months':
          startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
          endDate = today;
          break;
        case 'last6Months':
          startDate = new Date(today.getFullYear(), today.getMonth() - 5, 1);
          endDate = today;
          break;
        case 'thisYear':
          startDate = new Date(today.getFullYear(), 0, 1);
          endDate = today;
          break;
      }

      currentCourseStartDate = startDate.toISOString().split('T')[0];
      currentCourseEndDate = endDate.toISOString().split('T')[0];

      document.getElementById('courseStartDate').value = currentCourseStartDate;
      document.getElementById('courseEndDate').value = currentCourseEndDate;

      updateCourseView();
    }

    // ========== 課程視圖更新 ==========
    function updateCourseView() {
      const teacherId = document.getElementById('courseTeacherSelect').value;
      currentCourseTeacherId = teacherId ? Number(teacherId) : null;
      currentCourseStartDate = document.getElementById('courseStartDate').value;
      currentCourseEndDate = document.getElementById('courseEndDate').value;

      if (!currentCourseTeacherId) {
        document.getElementById('courseTimeline').innerHTML = '<div style="text-align: center; color: #6e6e73; padding: 48px 0;">請選擇師資以查看課程</div>';
        document.getElementById('courseTotalHours').textContent = '0';
        document.getElementById('courseTotalCount').textContent = '0';
        document.getElementById('courseMonthlyHours').textContent = '0';
        document.getElementById('courseTodayCount').textContent = '0';
        document.getElementById('courseTypeCards').innerHTML = '';
        document.getElementById('teacherWeekSchedule').style.display = 'none';
        return;
      }

      updateCourseStats();
      renderCourseTypeCards();
      renderCourseTimeline();
      renderTeacherWeekSchedule();
    }

    // ========== 統計計算 ==========
    function calculateCourseHours(timeRange) {
      const [start, end] = timeRange.split('-');
      const startTime = new Date(`2024-01-01 ${start}`);
      const endTime = new Date(`2024-01-01 ${end}`);
      return (endTime - startTime) / (1000 * 60 * 60);
    }

    function getFilteredCourses(teacherId) {
      if (!teacherId) return [];
      return courseAssignments.filter(course => {
        const matchTeacher = Number(course.teacherId) === Number(teacherId);
        const inDateRange = (!currentCourseStartDate || !currentCourseEndDate) ||
                           (course.date >= currentCourseStartDate && course.date <= currentCourseEndDate);
        return matchTeacher && inDateRange;
      });
    }

    function updateCourseStats() {
      const filteredCourses = getFilteredCourses(currentCourseTeacherId);

      // 總時數
      const totalHours = filteredCourses.reduce((sum, course) => {
        return sum + calculateCourseHours(course.time);
      }, 0);

      // 課程數量
      const totalCount = filteredCourses.length;

      // 本月時數
      const today = new Date();
      const monthStart = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
      const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];

      const monthCourses = courseAssignments.filter(course => {
        return course.teacherId === currentCourseTeacherId &&
               course.date >= monthStart &&
               course.date <= monthEnd;
      });

      const monthlyHours = monthCourses.reduce((sum, course) => {
        return sum + calculateCourseHours(course.time);
      }, 0);

      // 今日課程
      const todayStr = today.toISOString().split('T')[0];
      const todayCourses = courseAssignments.filter(course => {
        return course.teacherId === currentCourseTeacherId && course.date === todayStr;
      }).length;

      document.getElementById('courseTotalHours').textContent = Math.round(totalHours);
      document.getElementById('courseTotalCount').textContent = totalCount;
      document.getElementById('courseMonthlyHours').textContent = monthlyHours.toFixed(1);
      document.getElementById('courseTodayCount').textContent = todayCourses;
    }

    // ========== 課程類型分析 ==========
    function renderCourseTypeCards() {
      const filteredCourses = getFilteredCourses(currentCourseTeacherId);
      const typeCount = {};

      filteredCourses.forEach(course => {
        typeCount[course.type] = (typeCount[course.type] || 0) + 1;
      });

      const colors = {
        '正課': 'linear-gradient(135deg, #007aff 0%, #0051d5 100%)',
        '補課': 'linear-gradient(135deg, #ff9500 0%, #c76a00 100%)',
        '實驗課': 'linear-gradient(135deg, #5856d6 0%, #3634a3 100%)',
        '實作課': 'linear-gradient(135deg, #34c759 0%, #248a3d 100%)',
        '專題': 'linear-gradient(135deg, #ff2d55 0%, #c9002e 100%)'
      };

      const total = Object.values(typeCount).reduce((a, b) => a + b, 0);
      const container = document.getElementById('courseTypeCards');
      container.innerHTML = '';

      Object.entries(typeCount).forEach(([type, count]) => {
        const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
        const color = colors[type] || 'linear-gradient(135deg, #8e8e93 0%, #636366 100%)';

        const card = document.createElement('div');
        card.className = 'type-card';
        card.style.background = color;
        card.innerHTML = `
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px; font-weight: 600;">${type}</div>
          <div style="font-size: 36px; font-weight: 700; margin-bottom: 4px;">${count}</div>
          <div style="font-size: 12px; opacity: 0.8;">門課程 · ${percentage}%</div>
        `;
        container.appendChild(card);
      });

      if (total === 0) {
        container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #6e6e73; padding: 32px;">暫無課程資料</div>';
      }
    }

    // ========== 課程時間軸 ==========
    function renderCourseTimeline() {
      const filteredCourses = getFilteredCourses(currentCourseTeacherId);
      const sortedCourses = [...filteredCourses].sort((a, b) => new Date(b.date) - new Date(a.date));

      const timeline = document.getElementById('courseTimeline');
      timeline.innerHTML = '';

      if (sortedCourses.length === 0) {
        timeline.innerHTML = '<div style="text-align: center; color: #6e6e73; padding: 48px 0;">選定時間範圍內無課程資料</div>';
        return;
      }

      sortedCourses.forEach(course => {
        const hours = calculateCourseHours(course.time);
        const courseDate = new Date(course.date);
        const today = new Date();
        const isPast = courseDate < today;
        const isToday = courseDate.toDateString() === today.toDateString();

        let statusBg, statusText;
        if (isPast) {
          statusBg = '#34c759';
          statusText = '已完成';
        } else if (isToday) {
          statusBg = '#ff9500';
          statusText = '進行中';
        } else {
          statusBg = '#007aff';
          statusText = '未來';
        }

        const item = document.createElement('div');
        item.className = 'course-timeline-item';
        item.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <h4 style="font-size: 18px; font-weight: 600; color: #1d1d1f;">${course.name}</h4>
                <span style="padding: 4px 12px; background: ${statusBg}; color: white; font-size: 12px; font-weight: 600; border-radius: 8px;">${statusText}</span>
                <span style="padding: 4px 12px; background: #f5f5f7; color: #1d1d1f; font-size: 12px; font-weight: 600; border-radius: 8px;">${course.type}</span>
              </div>
              <div style="display: flex; gap: 20px; font-size: 14px; color: #6e6e73;">
                <span>📅 ${new Date(course.date).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' })}</span>
                <span>🕐 ${course.time}</span>
                <span>⏱️ ${hours.toFixed(1)}小時</span>
              </div>
            </div>
            <button onclick="deleteCourseAssignment(${course.id})" style="padding: 10px; background: #fff; border: 1px solid rgba(0, 0, 0, 0.08); border-radius: 10px; cursor: pointer; transition: all 0.3s ease; color: #ff3b30;" onmouseover="this.style.background='#fff0ee'" onmouseout="this.style.background='#fff'">
              <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
        `;
        timeline.appendChild(item);
      });
    }

    // ========== Modal 管理 ==========
    function openAddCourseModal() {
      if (!currentCourseTeacherId) {
        alert('請先選擇師資');
        return;
      }
      document.getElementById('addCourseModal').classList.add('show');
      document.getElementById('addCourseDate').value = new Date().toISOString().split('T')[0];
    }

    function closeAddCourseModal() {
      document.getElementById('addCourseModal').classList.remove('show');
      document.getElementById('addCourseForm').reset();
    }

    // 點擊 Modal 外部關閉
    document.getElementById('addCourseModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeAddCourseModal();
      }
    });

    // ========== 課程新增 ==========
    function addCourseSubmit(event) {
      event.preventDefault();

      const courseName = document.getElementById('addCourseName').value;
      const courseDate = document.getElementById('addCourseDate').value;
      const startTime = document.getElementById('addCourseStartTime').value;
      const endTime = document.getElementById('addCourseEndTime').value;
      const courseType = document.getElementById('addCourseType').value;
      const timeRange = `${startTime}-${endTime}`;

      // 檢查是否有衝堂
      const conflicts = checkTeacherConflict(currentCourseTeacherId, courseDate, startTime, endTime);

      if (conflicts.length > 0) {
        const conflictMessages = conflicts.map(c =>
          `- ${c.name} (${c.time}) [${c.type}] 來源：${c.source}`
        ).join('\n');

        const confirmMessage = `⚠️ 衝堂警告！\n\n該老師在此時段已有以下課程：\n${conflictMessages}\n\n是否仍要繼續派課？`;

        if (!confirm(confirmMessage)) {
          return;
        }
      }

      const newCourse = {
        id: Date.now(),
        teacherId: currentCourseTeacherId,
        name: courseName,
        date: courseDate,
        time: timeRange,
        type: courseType
      };

      courseAssignments.push(newCourse);
      saveCourseLocal();

      // 同步到行事曆
      const teacher = teachers.find(t => t.id === currentCourseTeacherId);
      const teacherName = teacher ? teacher.name : '未知師資';

      calendarEvents.push({
        id: newCourse.id,
        date: courseDate,
        title: `${courseName} - ${teacherName}`,
        time: timeRange,
        teacherId: currentCourseTeacherId,
        location: courseType,
        note: `課程類型：${courseType}`,
        color: getCourseTypeColor(courseType),
        courseId: newCourse.id
      });
      saveCalendarLocal();

      updateCourseView();
      closeAddCourseModal();

      alert('✅ 課程新增成功！已同步到行事曆');
    }

    // ========== 課程刪除 ==========
    function deleteCourseAssignment(courseId) {
      if (!confirm('確定要刪除此課程嗎？')) return;

      courseAssignments = courseAssignments.filter(c => c.id !== courseId);
      saveCourseLocal();

      // 同步刪除行事曆中的對應事件
      calendarEvents = calendarEvents.filter(e => e.courseId !== courseId);
      saveCalendarLocal();

      updateCourseView();

      alert('✅ 課程已刪除，已同步更新行事曆');
    }

    // ========== 衝堂檢查 ==========
    function checkTeacherConflict(teacherId, date, startTime, endTime) {
      const conflicts = [];

      const timeToMinutes = (timeStr) => {
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
      };

      const newStart = timeToMinutes(startTime);
      const newEnd = timeToMinutes(endTime);

      // 檢查派課管理中的課程
      courseAssignments.forEach(course => {
        if (course.teacherId === teacherId && course.date === date) {
          const [courseStart, courseEnd] = course.time.split('-');
          const existingStart = timeToMinutes(courseStart);
          const existingEnd = timeToMinutes(courseEnd);

          if (!(newEnd <= existingStart || newStart >= existingEnd)) {
            conflicts.push({
              name: course.name,
              time: course.time,
              type: course.type,
              source: '派課管理'
            });
          }
        }
      });

      // 檢查行事曆中的事件
      calendarEvents.forEach(event => {
        if (event.teacherId === teacherId && event.date === date && event.time) {
          const timeParts = event.time.split('-');
          if (timeParts.length === 2) {
            const [eventStart, eventEnd] = timeParts;
            const existingStart = timeToMinutes(eventStart);
            const existingEnd = timeToMinutes(eventEnd);

            if (!event.courseId && !(newEnd <= existingStart || newStart >= existingEnd)) {
              conflicts.push({
                name: event.title,
                time: event.time,
                type: event.location || '行事曆事件',
                source: '行事曆'
              });
            }
          }
        }
      });

      return conflicts;
    }

    // ========== 本週課表 ==========
    function renderTeacherWeekSchedule() {
      if (!currentCourseTeacherId) {
        document.getElementById('teacherWeekSchedule').style.display = 'none';
        return;
      }

      // 獲取本週日期範圍
      const today = new Date();
      const dayOfWeek = today.getDay();
      const monday = new Date(today);
      monday.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);

      const startDate = monday.toISOString().split('T')[0];
      const endDate = sunday.toISOString().split('T')[0];

      // 獲取課表
      const schedule = getTeacherSchedule(currentCourseTeacherId, startDate, endDate);

      const container = document.getElementById('teacherWeekScheduleContent');
      const scheduleDiv = document.getElementById('teacherWeekSchedule');

      if (schedule.length === 0) {
        scheduleDiv.style.display = 'none';
        return;
      }

      scheduleDiv.style.display = 'block';

      // 按日期分組
      const groupedByDate = {};
      schedule.forEach(item => {
        if (!groupedByDate[item.date]) {
          groupedByDate[item.date] = [];
        }
        groupedByDate[item.date].push(item);
      });

      // 生成 HTML
      const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
      let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">';

      for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        const dayEvents = groupedByDate[dateStr] || [];
        const isToday = dateStr === today.toISOString().split('T')[0];

        html += `
          <div style="border: 1px solid ${isToday ? '#007aff' : 'rgba(0,0,0,0.08)'}; border-radius: 12px; padding: 12px; background: ${isToday ? '#f0f5ff' : '#fafafa'};">
            <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: ${isToday ? '#007aff' : '#1d1d1f'};">
              週${weekDays[date.getDay()]} ${date.getMonth() + 1}/${date.getDate()}
              ${isToday ? '<span style="font-size: 11px; margin-left: 4px;">(今天)</span>' : ''}
            </div>
            <div style="display: flex; flex-direction: column; gap: 6px;">
        `;

        if (dayEvents.length === 0) {
          html += '<div style="font-size: 11px; color: #34c759; background: #e8f9ed; border-radius: 6px; padding: 6px 8px;">✓ 全天可用</div>';
        } else {
          dayEvents.forEach(event => {
            const bgColor = event.source === '派課' ? '#fff0ee' : '#fff8e6';
            const textColor = event.source === '派課' ? '#ff3b30' : '#ff9500';
            html += `
              <div style="font-size: 11px; background: ${bgColor}; color: ${textColor}; border-radius: 6px; padding: 6px 8px;">
                <div style="font-weight: 600;">${event.time}</div>
                <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${event.title}">${event.title}</div>
                <div style="opacity: 0.8;">${event.type}</div>
              </div>
            `;
          });
        }

        html += `
            </div>
          </div>
        `;
      }

      html += '</div>';
      container.innerHTML = html;
    }

    function getTeacherSchedule(teacherId, startDate, endDate) {
      const schedule = [];

      // 從派課管理獲取
      courseAssignments.forEach(course => {
        if (course.teacherId === teacherId &&
            course.date >= startDate &&
            course.date <= endDate) {
          schedule.push({
            date: course.date,
            time: course.time,
            title: course.name,
            type: course.type,
            source: '派課'
          });
        }
      });

      // 從行事曆獲取
      calendarEvents.forEach(event => {
        if (event.teacherId === teacherId &&
            event.date >= startDate &&
            event.date <= endDate &&
            !event.courseId) {
          schedule.push({
            date: event.date,
            time: event.time || '全天',
            title: event.title,
            type: event.location || '行事曆',
            source: '行事曆'
          });
        }
      });

      return schedule.sort((a, b) => a.date.localeCompare(b.date) || (a.time || '').localeCompare(b.time || ''));
    }

    // ========== 工具函數 ==========
    function getCourseTypeColor(type) {
      const colorMap = {
        '正課': '#007aff',
        '補課': '#ff9500',
        '實驗課': '#5856d6',
        '實作課': '#34c759',
        '專題': '#ff2d55'
      };
      return colorMap[type] || '#8e8e93';
    }

    function saveCourseLocal() {
      try {
        localStorage.setItem('courseAssignments', JSON.stringify(courseAssignments));
      } catch(err) {
        console.warn('localStorage 超額，課程數據保存失敗：', err);
        alert('存儲空間已滿，課程數據可能無法保存，請刪除部分數據');
      }
    }

    function saveCalendarLocal() {
      try {
        localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
      } catch(err) {
        console.warn('localStorage 超額，行事曆數據保存失敗：', err);
      }
    }

    // ========== 頁面載入時初始化 ==========
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
