<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ´¾èª²ç®¡ç†ç³»çµ±</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f7;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .teacher-card {
      background: white;
      border-radius: 20px;
      padding: 32px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(0, 0, 0, 0.04);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .teacher-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.03), rgba(118, 75, 162, 0.03));
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .teacher-card:hover::before {
      opacity: 1;
    }

    .teacher-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.12);
    }

    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modern-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }

    .modern-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <!-- è¿”å›é¦–é  -->
    <div class="mb-6">
      <a href="index.html" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
        <span class="mr-2">â†</span> è¿”å›é¦–é 
      </a>
    </div>

    <!-- æ¨™é¡Œå€åŸŸ -->
    <div class="text-center mb-12">
      <h1 class="text-5xl font-bold text-gray-900 mb-2" style="letter-spacing: -0.02em">æ´¾èª²ç®¡ç†ç³»çµ±</h1>
      <p class="text-xl text-gray-600">æ™ºèƒ½ç®¡ç†å¹³å°</p>
    </div>

    <!-- å¸«è³‡å¡ç‰‡åˆ—è¡¨ -->
    <div class="max-w-7xl mx-auto">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="teacherCardsContainer">
        <!-- å¸«è³‡å¡ç‰‡å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <!-- å¸«è³‡è©³ç´°è³‡æ–™ Modal -->
  <div id="teacherDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4" onclick="closeTeacherDetail(event)">
    <div class="bg-white rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
      <div id="teacherDetailContent"></div>
    </div>
  </div>

  <!-- æ–°å¢èª²ç¨‹ Modal -->
  <div id="addCourseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
      <h3 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“š æ–°å¢èª²ç¨‹</h3>
      <form id="courseForm" class="space-y-4">
        <input type="hidden" id="courseTeacherId">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">èª²ç¨‹åç¨±</label>
          <input type="text" id="courseName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">èª²ç¨‹æ—¥æœŸ</label>
            <input type="date" id="courseDate" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">èª²ç¨‹é¡å‹</label>
            <select id="courseType" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="æ­£èª²">æ­£èª²</option>
              <option value="è£œèª²">è£œèª²</option>
              <option value="å¯¦é©—èª²">å¯¦é©—èª²</option>
              <option value="å¯¦ä½œèª²">å¯¦ä½œèª²</option>
              <option value="å°ˆé¡Œ">å°ˆé¡Œ</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">é–‹å§‹æ™‚é–“</label>
            <input type="time" id="startTime" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">çµæŸæ™‚é–“</label>
            <input type="time" id="endTime" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
        </div>
        <div class="flex justify-end space-x-4 pt-4">
          <button type="button" onclick="closeAddCourseModal()" class="px-6 py-3 bg-gray-500 text-white rounded-xl font-medium hover:bg-gray-600 transition-colors">
            å–æ¶ˆ
          </button>
          <button type="submit" class="modern-btn px-6 py-3 text-white rounded-xl font-medium">
            ç¢ºèªæ–°å¢
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ==================== è³‡æ–™ç®¡ç† ====================
    let teachers = JSON.parse(localStorage.getItem('teachers') || '[]');
    let courseAssignments = JSON.parse(localStorage.getItem('courseAssignments') || '[]');
    let calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');

    // ==================== åˆå§‹åŒ– ====================
    function init() {
      renderTeacherCards();
      document.getElementById('courseForm').addEventListener('submit', handleAddCourse);
    }

    function renderTeacherCards() {
      const container = document.getElementById('teacherCardsContainer');

      if (teachers.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center py-16">
            <div class="text-6xl mb-4">ğŸ‘¨â€ğŸ«</div>
            <p class="text-xl text-gray-600 mb-4">å°šç„¡å¸«è³‡è³‡æ–™</p>
            <p class="text-gray-500">è«‹å…ˆåˆ°ã€Œå¸«è³‡é™£å®¹ç®¡ç†ã€æ–°å¢å¸«è³‡</p>
          </div>
        `;
        return;
      }

      container.innerHTML = teachers.map((teacher, index) => {
        const totalCourses = courseAssignments.filter(c => c.teacherId === teacher.id).length;
        const thisMonth = new Date().toISOString().slice(0, 7);
        const monthlyCourses = courseAssignments.filter(c =>
          c.teacherId === teacher.id && c.date.startsWith(thisMonth)
        ).length;

        return `
          <div class="teacher-card fade-in" style="animation-delay: ${index * 0.1}s" onclick="viewTeacherDetail(${teacher.id})">
            <div class="relative z-10">
              <!-- é ­åƒ -->
              <div class="w-24 h-24 mx-auto mb-4 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 p-1">
                <div class="w-full h-full rounded-full bg-white flex items-center justify-center overflow-hidden">
                  ${teacher.photo ?
                    `<img src="${teacher.photo}" class="w-full h-full object-cover">` :
                    `<span class="text-3xl font-bold text-gray-600">${(teacher.name || '?')[0]}</span>`
                  }
                </div>
              </div>

              <!-- å¸«è³‡è³‡è¨Š -->
              <h3 class="text-2xl font-bold text-gray-900 text-center mb-2">${teacher.name}</h3>
              <div class="text-center mb-4">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${
                  teacher.teacherType === 'internal' ?
                  'bg-blue-100 text-blue-800' :
                  'bg-purple-100 text-purple-800'
                }">
                  ${teacher.teacherType === 'internal' ? 'ğŸ‘¨â€ğŸ’¼ å…§éƒ¨è¬›å¸«' : 'ğŸ‘¨â€ğŸ“ å¤–è˜è¬›å¸«'}
                </span>
              </div>

              <!-- çµ±è¨ˆè³‡è¨Š -->
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="text-center p-3 bg-gray-50 rounded-xl">
                  <div class="text-2xl font-bold text-gray-900">${totalCourses}</div>
                  <div class="text-xs text-gray-600">ç¸½èª²ç¨‹æ•¸</div>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-xl">
                  <div class="text-2xl font-bold text-blue-600">${monthlyCourses}</div>
                  <div class="text-xs text-gray-600">æœ¬æœˆèª²ç¨‹</div>
                </div>
              </div>

              <!-- å°ˆé•·é ˜åŸŸ -->
              ${teacher.subjects && teacher.subjects.length > 0 ? `
                <div class="mb-4">
                  <div class="text-xs text-gray-600 mb-2">å°ˆé•·é ˜åŸŸ</div>
                  <div class="flex flex-wrap gap-1">
                    ${teacher.subjects.slice(0, 3).map(s =>
                      `<span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">${s}</span>`
                    ).join('')}
                    ${teacher.subjects.length > 3 ? `<span class="text-xs text-gray-500">+${teacher.subjects.length - 3}</span>` : ''}
                  </div>
                </div>
              ` : ''}

              <!-- å¿«é€Ÿæ“ä½œ -->
              <button onclick="event.stopPropagation(); openAddCourseModal(${teacher.id})"
                class="w-full modern-btn text-white px-4 py-3 rounded-xl font-medium">
                â• æ–°å¢èª²ç¨‹
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function viewTeacherDetail(teacherId) {
      const teacher = teachers.find(t => t.id === teacherId);
      if (!teacher) return;

      const courses = courseAssignments.filter(c => c.teacherId === teacherId);
      const sortedCourses = [...courses].sort((a, b) => new Date(b.date) - new Date(a.date));

      const modal = document.getElementById('teacherDetailModal');
      const content = document.getElementById('teacherDetailContent');

      // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
      const totalHours = courses.reduce((sum, c) => sum + calculateHours(c.time), 0);
      const thisMonth = new Date().toISOString().slice(0, 7);
      const monthlyCourses = courses.filter(c => c.date.startsWith(thisMonth));
      const monthlyHours = monthlyCourses.reduce((sum, c) => sum + calculateHours(c.time), 0);

      // èª²ç¨‹é¡å‹çµ±è¨ˆ
      const typeCount = {};
      courses.forEach(c => {
        typeCount[c.type] = (typeCount[c.type] || 0) + 1;
      });

      content.innerHTML = `
        <div class="p-8">
          <!-- é—œé–‰æŒ‰éˆ• -->
          <button onclick="closeTeacherDetail()" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>

          <!-- å¸«è³‡è³‡è¨Š -->
          <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl p-8 mb-8">
            <div class="flex items-center space-x-6">
              <div class="w-32 h-32 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 p-2">
                <div class="w-full h-full rounded-full bg-white flex items-center justify-center overflow-hidden">
                  ${teacher.photo ?
                    `<img src="${teacher.photo}" class="w-full h-full object-cover">` :
                    `<span class="text-4xl font-bold text-gray-600">${(teacher.name || '?')[0]}</span>`
                  }
                </div>
              </div>
              <div class="flex-1">
                <h2 class="text-4xl font-bold text-gray-900 mb-2">${teacher.name}</h2>
                <div class="flex items-center space-x-4 text-gray-600">
                  ${teacher.email ? `<span>ğŸ“§ ${teacher.email}</span>` : ''}
                  <span>${teacher.teacherType === 'internal' ? 'ğŸ‘¨â€ğŸ’¼ å…§éƒ¨è¬›å¸«' : 'ğŸ‘¨â€ğŸ“ å¤–è˜è¬›å¸«'}</span>
                  <span>${teacher.workLocation === 'onboard' ? 'ğŸš¢ æµ·ä¸Šå·¥ä½œ' : 'ğŸ¢ é™¸åœ°å·¥ä½œ'}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- çµ±è¨ˆå¡ç‰‡ -->
          <div class="grid grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 border border-gray-200">
              <div class="text-sm text-gray-600 mb-1">ç¸½æˆèª²æ™‚æ•¸</div>
              <div class="text-3xl font-bold text-gray-900">${totalHours.toFixed(1)} <span class="text-lg text-gray-500">å°æ™‚</span></div>
            </div>
            <div class="bg-white rounded-xl p-6 border border-gray-200">
              <div class="text-sm text-gray-600 mb-1">ç¸½èª²ç¨‹æ•¸</div>
              <div class="text-3xl font-bold text-gray-900">${courses.length} <span class="text-lg text-gray-500">å ‚</span></div>
            </div>
            <div class="bg-white rounded-xl p-6 border border-gray-200">
              <div class="text-sm text-gray-600 mb-1">æœ¬æœˆæ™‚æ•¸</div>
              <div class="text-3xl font-bold text-blue-600">${monthlyHours.toFixed(1)} <span class="text-lg text-gray-500">å°æ™‚</span></div>
            </div>
          </div>

          <!-- èª²ç¨‹é¡å‹åˆ†ä½ˆ -->
          ${Object.keys(typeCount).length > 0 ? `
            <div class="bg-white rounded-xl p-6 mb-8 border border-gray-200">
              <h3 class="text-xl font-bold text-gray-900 mb-4">ğŸ“Š èª²ç¨‹é¡å‹åˆ†ä½ˆ</h3>
              <div class="flex flex-wrap gap-3">
                ${Object.entries(typeCount).map(([type, count]) => `
                  <div class="flex items-center space-x-2 bg-gray-50 px-4 py-2 rounded-lg">
                    <span class="text-sm font-medium text-gray-700">${type}</span>
                    <span class="text-sm font-bold text-blue-600">${count} å ‚</span>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <!-- èª²ç¨‹æ™‚é–“è»¸ -->
          <div class="bg-white rounded-xl p-6 border border-gray-200">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-xl font-bold text-gray-900">â° èª²ç¨‹æ™‚é–“è»¸</h3>
              <button onclick="event.stopPropagation(); openAddCourseModal(${teacher.id})" class="modern-btn text-white px-6 py-2 rounded-xl font-medium">
                â• æ–°å¢èª²ç¨‹
              </button>
            </div>

            ${sortedCourses.length > 0 ? `
              <div class="space-y-4 max-h-96 overflow-y-auto">
                ${sortedCourses.map(c => `
                  <div class="bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-colors">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <h4 class="text-lg font-semibold text-gray-800 mb-2">${c.name}</h4>
                        <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                          <span>ğŸ“… ${new Date(c.date).toLocaleDateString('zh-TW')}</span>
                          <span>ğŸ• ${c.time}</span>
                          <span>ğŸ“š ${c.type}</span>
                        </div>
                      </div>
                      <button onclick="event.stopPropagation(); deleteCourse(${c.id})" class="text-red-500 hover:text-red-700 p-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : `
              <div class="text-center py-12 text-gray-500">
                <div class="text-5xl mb-4">ğŸ“</div>
                <p class="text-lg">å°šç„¡èª²ç¨‹è¨˜éŒ„</p>
                <p class="text-sm mt-2">é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢èª²ç¨‹</p>
              </div>
            `}
          </div>
        </div>
      `;

      modal.classList.remove('hidden');
    }

    function closeTeacherDetail(event) {
      if (event && event.target.id !== 'teacherDetailModal') return;
      document.getElementById('teacherDetailModal').classList.add('hidden');
    }

    function openAddCourseModal(teacherId) {
      document.getElementById('courseTeacherId').value = teacherId;
      document.getElementById('courseDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('addCourseModal').classList.remove('hidden');
    }

    function closeAddCourseModal() {
      document.getElementById('addCourseModal').classList.add('hidden');
      document.getElementById('courseForm').reset();
    }

    function handleAddCourse(e) {
      e.preventDefault();

      const teacherId = Number(document.getElementById('courseTeacherId').value);
      const courseData = {
        id: Date.now(),
        teacherId: teacherId,
        name: document.getElementById('courseName').value,
        date: document.getElementById('courseDate').value,
        time: `${document.getElementById('startTime').value}-${document.getElementById('endTime').value}`,
        type: document.getElementById('courseType').value
      };

      // è¡å ‚æª¢æŸ¥
      const conflicts = checkConflict(courseData);
      if (conflicts.length > 0) {
        if (!confirm(`âš ï¸ è¡å ‚è­¦å‘Šï¼\n\n${conflicts.join('\n')}\n\næ˜¯å¦ä»è¦ç¹¼çºŒï¼Ÿ`)) {
          return;
        }
      }

      courseAssignments.push(courseData);

      // åŒæ­¥åˆ°è¡Œäº‹æ›†
      const teacher = teachers.find(t => t.id === teacherId);
      calendarEvents.push({
        id: courseData.id,
        date: courseData.date,
        title: `${courseData.name} - ${teacher.name}`,
        time: courseData.time,
        teacherId: teacherId,
        location: courseData.type,
        color: getCourseTypeColor(courseData.type),
        courseId: courseData.id
      });

      saveData();
      closeAddCourseModal();
      renderTeacherCards();

      // å¦‚æœè©³ç´°è¦–çª—æ˜¯é–‹è‘—çš„ï¼Œé‡æ–°è¼‰å…¥
      if (!document.getElementById('teacherDetailModal').classList.contains('hidden')) {
        viewTeacherDetail(teacherId);
      }

      alert('âœ… èª²ç¨‹æ–°å¢æˆåŠŸï¼');
    }

    function deleteCourse(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤èª²ç¨‹å—ï¼Ÿ')) return;

      courseAssignments = courseAssignments.filter(c => c.id !== id);
      calendarEvents = calendarEvents.filter(e => e.courseId !== id);

      saveData();
      renderTeacherCards();

      // é‡æ–°è¼‰å…¥è©³ç´°è¦–çª—
      const modal = document.getElementById('teacherDetailModal');
      if (!modal.classList.contains('hidden')) {
        const teacherId = courseAssignments.find(c => c.id === id)?.teacherId;
        if (teacherId) {
          viewTeacherDetail(teacherId);
        } else {
          // å¦‚æœæ‰¾ä¸åˆ°èª²ç¨‹ï¼Œé—œé–‰ modal
          const allTeacherIds = [...new Set(courseAssignments.map(c => c.teacherId))];
          if (allTeacherIds.length > 0) {
            viewTeacherDetail(allTeacherIds[0]);
          } else {
            closeTeacherDetail();
          }
        }
      }

      alert('âœ… èª²ç¨‹å·²åˆªé™¤ï¼');
    }

    // ==================== å·¥å…·å‡½æ•¸ ====================
    function calculateHours(timeRange) {
      const [start, end] = timeRange.split('-');
      const startTime = new Date(`2024-01-01 ${start}`);
      const endTime = new Date(`2024-01-01 ${end}`);
      return (endTime - startTime) / (1000 * 60 * 60);
    }

    function checkConflict(newCourse) {
      const conflicts = [];
      const timeToMinutes = (time) => {
        const [h, m] = time.split(':').map(Number);
        return h * 60 + m;
      };

      const [newStart, newEnd] = newCourse.time.split('-');
      const newStartMin = timeToMinutes(newStart);
      const newEndMin = timeToMinutes(newEnd);

      courseAssignments.forEach(c => {
        if (c.teacherId === newCourse.teacherId && c.date === newCourse.date) {
          const [start, end] = c.time.split('-');
          const startMin = timeToMinutes(start);
          const endMin = timeToMinutes(end);

          if (!(newEndMin <= startMin || newStartMin >= endMin)) {
            conflicts.push(`- ${c.name} (${c.time})`);
          }
        }
      });

      return conflicts;
    }

    function getCourseTypeColor(type) {
      const colors = {
        'æ­£èª²': 'bg-blue-500',
        'è£œèª²': 'bg-yellow-500',
        'å¯¦é©—èª²': 'bg-purple-500',
        'å¯¦ä½œèª²': 'bg-green-500',
        'å°ˆé¡Œ': 'bg-red-500'
      };
      return colors[type] || 'bg-gray-500';
    }

    function saveData() {
      try {
        localStorage.setItem('teachers', JSON.stringify(teachers));
        localStorage.setItem('courseAssignments', JSON.stringify(courseAssignments));
        localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
      } catch (err) {
        console.error('å„²å­˜å¤±æ•—:', err);
      }
    }

    // ==================== å•Ÿå‹•æ‡‰ç”¨ ====================
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
