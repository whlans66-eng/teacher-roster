<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ´¾èª²ç®¡ç†ç³»çµ±</title>

  <!-- é é€£æ¥åˆ°è³‡æºæœå‹™å™¨ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">

  <!-- å­—é«”æ¨£å¼è¡¨ -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">

  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <!-- Tailwind CDN - ä½¿ç”¨ defer é¿å…é˜»å¡æ¸²æŸ“ -->
  <script defer src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js - å»¶é²åŠ è¼‰ï¼Œåƒ…åœ¨éœ€è¦æ™‚åŠ è¼‰ -->
  <script>
    // å»¶é²åŠ è¼‰ Chart.js - åƒ…åœ¨éœ€è¦åœ–è¡¨æ™‚æ‰åŠ è¼‰
    window.loadChartJS = function() {
      return new Promise((resolve, reject) => {
        if (window.Chart) {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    };
  </script>

  <style>

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      box-shadow:
        0 1px 3px rgba(0, 0, 0, 0.04),
        0 1px 2px rgba(0, 0, 0, 0.06);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.08),
        0 2px 6px rgba(0, 0, 0, 0.04);
    }

    .calendar-day {
      min-height: 120px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 10px;
    }

    .calendar-day:hover {
      transform: translateY(-1px);
      box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.06),
        0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .today-highlight {
      background: rgba(0, 122, 255, 0.06) !important;
      border: 2px solid #007aff !important;
      box-shadow:
        0 0 0 1px rgba(0, 122, 255, 0.1),
        0 4px 12px rgba(0, 122, 255, 0.15) !important;
    }

    .event-item {
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 12px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .event-item:hover {
      opacity: 0.88;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .modern-btn {
      background: #007aff;
      color: white;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:
        0 1px 3px rgba(0, 0, 0, 0.12),
        0 1px 2px rgba(0, 0, 0, 0.24);
    }

    .modern-btn:hover {
      background: #0051d5;
      transform: translateY(-1px);
      box-shadow:
        0 4px 12px rgba(0, 122, 255, 0.25),
        0 2px 4px rgba(0, 0, 0, 0.15);
    }

    /* ========== TimeTree æ’ç‰ˆ + Apple é¢¨æ ¼æ¨£å¼ ========== */

    /* Apple é¢¨æ ¼çš„ç£¨ç ‚ç»ç’ƒæ•ˆæœ */
    .apple-glass {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* Apple é…è‰² - ç³»çµ±é¡è‰² */
    :root {
      --apple-blue: #007AFF;
      --apple-green: #34C759;
      --apple-orange: #FF9500;
      --apple-red: #FF3B30;
      --apple-purple: #AF52DE;
      --apple-gray: #8E8E93;
      --apple-gray-light: #F2F2F7;
      --apple-gray-dark: #48484A;
    }

    /* TimeTree é¢¨æ ¼çš„æ“ä½œæŒ‰éˆ• */
    .action-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: var(--apple-gray-light);
      color: var(--apple-blue);
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .action-btn:hover {
      background: #E5E5EA;
      transform: translateY(-1px);
    }

    .action-btn:active {
      transform: scale(0.98);
    }

    /* Apple é¢¨æ ¼çš„è³‡è¨Šå¡ç‰‡ */
    .info-card {
      background: #FFFFFF;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      border: 0.5px solid rgba(0, 0, 0, 0.04);
    }

    /* TimeTree é¢¨æ ¼çš„åŠŸèƒ½å€å¡Š */
    .feature-block {
      background: var(--apple-gray-light);
      border-radius: 14px;
      padding: 14px 16px;
      margin: 12px 0;
      border: 0.5px solid rgba(0, 0, 0, 0.04);
    }

    .feature-block-blue {
      background: linear-gradient(135deg, rgba(0, 122, 255, 0.08) 0%, rgba(0, 122, 255, 0.04) 100%);
      border: 1px solid rgba(0, 122, 255, 0.15);
    }

    /* Apple é¢¨æ ¼çš„æŒ‰éˆ• */
    .apple-btn {
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      letter-spacing: -0.02em;
    }

    .apple-btn-primary {
      background: var(--apple-blue);
      color: white;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.25);
    }

    .apple-btn-primary:hover {
      background: #0051D5;
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.35);
      transform: translateY(-1px);
    }

    .apple-btn-secondary {
      background: var(--apple-gray-light);
      color: var(--apple-blue);
    }

    .apple-btn-secondary:hover {
      background: #E5E5EA;
      transform: translateY(-1px);
    }

    .apple-btn-success {
      background: var(--apple-green);
      color: white;
      box-shadow: 0 2px 8px rgba(52, 199, 89, 0.25);
    }

    .apple-btn-success:hover {
      background: #2AB04A;
      transform: translateY(-1px);
    }

    .apple-btn-danger {
      background: var(--apple-red);
      color: white;
      box-shadow: 0 2px 8px rgba(255, 59, 48, 0.25);
    }

    .apple-btn-danger:hover {
      background: #E6342A;
      transform: translateY(-1px);
    }

    /* TimeTree é¢¨æ ¼çš„ç•™è¨€å¡ç‰‡ */
    .comment-card {
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin: 8px 0;
      border: 0.5px solid rgba(0, 0, 0, 0.06);
      transition: all 0.2s ease;
    }

    .comment-card:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }

    /* Apple é¢¨æ ¼çš„é ­åƒ */
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--apple-blue), var(--apple-purple));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      flex-shrink: 0;
    }

    /* æ“ä½œæ­·å²æ™‚é–“è»¸ */
    .timeline-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      font-size: 13px;
      color: var(--apple-gray-dark);
    }

    .timeline-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--apple-green);
      box-shadow: 0 0 0 3px rgba(52, 199, 89, 0.15);
      flex-shrink: 0;
    }

    /* å€å¡Šæ¨™é¡Œ */
    .section-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--apple-gray-dark);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* è¼¸å…¥æ¡†æ¨£å¼ */
    .apple-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #E5E5EA;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s ease;
      background: white;
    }

    .apple-input:focus {
      outline: none;
      border-color: var(--apple-blue);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    /* åˆ†éš”ç·š */
    .divider {
      height: 0.5px;
      background: linear-gradient(90deg, transparent, #E5E5EA, transparent);
      margin: 16px 0;
    }

    /* ========== iOS åŸç”Ÿé¢¨æ ¼å¢å¼· ========== */

    /* æ¯›ç»ç’ƒ Modal èƒŒæ™¯ */
    /* Modal èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ */
    #viewEventModal,
    #addCourseModal,
    #duplicateDateModal {
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    /* Modal å¡ç‰‡å®¹å™¨ - ä½¿ç”¨ Flexbox ä¸‰å±¤çµæ§‹ */
    .modal-card {
      background: rgba(255, 255, 255, 0.95) !important;
      backdrop-filter: blur(30px) saturate(180%);
      -webkit-backdrop-filter: blur(30px) saturate(180%);
      border: 0.5px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px !important;
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2), 0 6px 20px rgba(0, 0, 0, 0.15);

      /* é—œéµï¼šFlexbox ä½ˆå±€ */
      display: flex;
      flex-direction: column;
      overflow: hidden; /* ä¿è­·åœ“è§’ä¸è¢«ç ´å£ */

      max-height: 85vh;
      width: 90%;
      max-width: 700px;
    }

    /* Modal é ­éƒ¨ - å›ºå®šä¸æ»¾å‹• */
    .modal-header {
      padding: 24px 32px;
      background: rgba(249, 249, 249, 0.8);
      border-bottom: 0.5px solid rgba(0, 0, 0, 0.1);
      flex-shrink: 0; /* é˜²æ­¢è¢«æ“ å£“ */
    }

    .modal-header h3 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
      letter-spacing: -0.015em;
      color: #1d1d1f;
    }

    /* Modal å…§å®¹å€ - å¯æ»¾å‹• */
    .modal-content {
      padding: 24px 32px;
      flex-grow: 1; /* è‡ªå‹•å¡«æ»¿å‰©é¤˜ç©ºé–“ */
      overflow-y: auto; /* åªæœ‰é€™è£¡æœƒæ»¾å‹• */

      /* ç¾åŒ–æ²è»¸ */
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    }

    .modal-content::-webkit-scrollbar {
      width: 6px;
    }

    .modal-content::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.15);
      border-radius: 10px;
    }

    .modal-content::-webkit-scrollbar-thumb:hover {
      background-color: rgba(0, 0, 0, 0.25);
    }

    /* Modal åº•éƒ¨æŒ‰éˆ•å€ - å›ºå®šä¸æ»¾å‹• */
    .modal-footer {
      padding: 20px 32px;
      background: rgba(255, 255, 255, 0.95);
      border-top: 0.5px solid rgba(0, 0, 0, 0.1);
      flex-shrink: 0; /* é˜²æ­¢è¢«æ“ å£“æˆ–æ¶ˆå¤± */
    }

    /* iOS é¢¨æ ¼çš„å½ˆå‡ºå¼æ“ä½œé¸å–® */
    .context-menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.2);
      z-index: 9999;
      display: none;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
    }

    .context-menu-overlay.show {
      display: block;
      opacity: 1;
    }

    .context-menu-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      width: 90%;
      max-width: 320px;
      background-color: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(25px) saturate(180%);
      -webkit-backdrop-filter: blur(25px) saturate(180%);
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      opacity: 0;
      transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .context-menu-overlay.show .context-menu-popup {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }

    .menu-option {
      padding: 16px 20px;
      font-size: 17px;
      color: var(--apple-gray-dark);
      border-bottom: 0.5px solid rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      background: transparent;
      transition: background-color 0.1s;
    }

    .menu-option:last-child {
      border-bottom: none;
    }

    .menu-option:active {
      background-color: rgba(0, 0, 0, 0.08);
    }

    .menu-option-danger {
      color: var(--apple-red) !important;
    }

    .menu-option .icon {
      font-size: 16px;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .menu-option svg {
      width: 18px;
      height: 18px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      opacity: 0.6;
    }

    /* iOS å¤§æ¨™é¡Œæ¨£å¼ */
    .ios-large-title {
      font-size: 34px;
      font-weight: 700;
      letter-spacing: 0.3px;
      color: #000;
      margin-bottom: 8px;
      line-height: 1.1;
    }

    /* iOS æ¥µç´°åˆ†éš”ç·š */
    .ios-separator {
      height: 0.5px;
      background: rgba(0, 0, 0, 0.1);
      margin: 16px 0;
    }

    /* iOS æ¨™æº–æŒ‰éˆ•å¢å¼· */
    .apple-btn {
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    .apple-btn:active {
      opacity: 0.6;
      transform: scale(0.98);
    }

    /* æ·¡å…¥å‹•ç•« */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in-up {
      animation: fadeInUp 0.4s ease-out;
    }

    /* ========== Modal å…§ SVG Icon æ¨£å¼ ========== */
    .modal-icon {
      display: inline-block;
      width: 18px;
      height: 18px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      vertical-align: -3px;
      margin-right: 6px;
    }

    .modal-icon-sm {
      width: 14px;
      height: 14px;
      vertical-align: -2px;
    }

    /* ========== è‡ªå‹•æ¨™ç±¤æ¨£å¼ ========== */
    .auto-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 500;
      border: 1px solid;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .auto-tag svg {
      width: 14px;
      height: 14px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .auto-tag:hover {
      opacity: 0.8;
      transform: translateY(-1px);
    }

    .auto-tag-remove {
      margin-left: 4px;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .auto-tag:hover .auto-tag-remove {
      opacity: 1;
    }

    /* ä¸åŒé¡å‹çš„æ¨™ç±¤é¡è‰² */
    .tag-important {
      background: rgba(255, 59, 48, 0.1);
      color: var(--apple-red);
      border-color: rgba(255, 59, 48, 0.3);
    }

    .tag-exam {
      background: rgba(255, 149, 0, 0.1);
      color: var(--apple-orange);
      border-color: rgba(255, 149, 0, 0.3);
    }

    .tag-experiment {
      background: rgba(175, 82, 222, 0.1);
      color: var(--apple-purple);
      border-color: rgba(175, 82, 222, 0.3);
    }

    .tag-project {
      background: rgba(0, 122, 255, 0.1);
      color: var(--apple-blue);
      border-color: rgba(0, 122, 255, 0.3);
    }

    .tag-meeting {
      background: rgba(52, 199, 89, 0.1);
      color: var(--apple-green);
      border-color: rgba(52, 199, 89, 0.3);
    }

    .tag-default {
      background: rgba(142, 142, 147, 0.1);
      color: var(--apple-gray);
      border-color: rgba(142, 142, 147, 0.3);
    }

    @media (max-width: 768px) {
      /* éš±è—æ¡Œé¢ç‰ˆè¡Œäº‹æ›†ï¼Œé¡¯ç¤ºæ‰‹æ©Ÿç‰ˆ */
      .calendar-grid-container {
        display: none;
      }

      .mobile-calendar-view {
        display: block !important;
      }

      /* å®¹å™¨å…§é‚Šè· */
      .container {
        padding-left: 16px !important;
        padding-right: 16px !important;
      }

      /* æ¨™é¡Œå€åŸŸ */
      h1 {
        font-size: 32px !important;
      }

      h2 {
        font-size: 20px !important;
      }

      /* å¡ç‰‡å…§é‚Šè· */
      .card {
        padding: 20px !important;
      }

      /* èª²ç¨‹è¡Œäº‹æ›†æ¨™é¡Œå’ŒæŒ‰éˆ• */
      .flex.flex-col.md\\:flex-row {
        flex-direction: column !important;
        align-items: flex-start !important;
      }

      .flex.items-center.gap-3 {
        flex-direction: column !important;
        width: 100%;
        gap: 12px !important;
      }

      .flex.items-center.gap-3 button {
        width: 100%;
      }

      .flex.rounded-xl.p-1 {
        width: 100%;
      }

      /* å°èˆªæ§åˆ¶ */
      .flex.items-center.justify-between.mb-6 {
        flex-direction: column !important;
        gap: 12px;
      }

      .flex.items-center.space-x-4 {
        flex-direction: column !important;
        width: 100%;
        gap: 8px !important;
      }

      .flex.items-center.space-x-4 button {
        width: 100%;
        justify-content: center;
      }

      #currentMonth {
        min-width: auto !important;
        width: 100%;
        text-align: center;
        font-size: 16px !important;
      }

      /* ä»Šå¤©æŒ‰éˆ• */
      button[onclick="goToToday()"] {
        width: 100%;
      }

      /* æŒ‰éˆ• */
      .modern-btn {
        width: 100%;
        padding: 12px 20px !important;
        font-size: 14px !important;
      }

      /* çµ±è¨ˆå¡ç‰‡ */
      .grid.grid-cols-2,
      .grid.grid-cols-3,
      .grid.grid-cols-4 {
        grid-template-columns: 1fr !important;
      }

      /* èª¿æ•´æ–‡å­—å¤§å° */
      button {
        font-size: 14px !important;
      }
    }

    /* å°æ‰‹æ©Ÿè¢å¹• (< 480px) */
    @media (max-width: 480px) {
      h1 {
        font-size: 28px !important;
      }

      h2 {
        font-size: 18px !important;
      }

      .card {
        padding: 16px !important;
      }

      button {
        font-size: 13px !important;
        padding: 10px 16px !important;
      }
    }

    .mobile-calendar-view {
      display: none;
    }

    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* å¾®å¦™çš„èƒŒæ™¯ç´‹ç† */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.35) 0%, transparent 55%),
        radial-gradient(circle at 80% 70%, rgba(252, 246, 222, 0.35) 0%, transparent 55%);
      pointer-events: none;
      z-index: -1;
    }
  </style>

  <!-- API å±¤ï¼šèˆ‡å¾Œç«¯é€šè¨Š -->
  <script src="js/api.js"></script>
</head>
<body>
  <!-- Authentication -->
  <script src="js/auth.js"></script>
  <script>
    // Protect this page - admin and teacher can access
    protectPage(['admin', 'teacher']);
  </script>

  <!-- è·¨é å°è¦½åˆ— -->
  <nav style="background: #ffffff; border-bottom: 1px solid rgba(0,0,0,0.08); box-shadow: 0 1px 3px rgba(0,0,0,0.04); position: sticky; top: 0; z-index: 50;">
    <div style="max-width: 1280px; margin: 0 auto; padding: 0 16px;">
      <div style="display: flex; align-items: center; justify-content: space-between; height: 56px;">
        <a href="index.html" style="display: flex; align-items: center; gap: 8px; color: #6b7280; text-decoration: none; font-size: 14px; font-weight: 500; transition: color 0.2s;" onmouseover="this.style.color='#1f2937'" onmouseout="this.style.color='#6b7280'">
          <i class="ph ph-house" style="font-size: 18px;"></i>
          <span>é¦–é </span>
        </a>
        <div style="display: flex; align-items: center; gap: 4px;">
          <a href="teacher-management.html" style="padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; text-decoration: none; color: #6b7280; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb';this.style.color='#374151'" onmouseout="this.style.background='transparent';this.style.color='#6b7280'">
            <i class="ph ph-user-list"></i> å¸«è³‡ç®¡ç†
          </a>
          <a href="course-management.html" style="padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; text-decoration: none; background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe;">
            <i class="ph ph-calendar"></i> è¨“ç·´æ’ç¨‹
          </a>
          <a href="maritime-courses.html" style="padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; text-decoration: none; color: #6b7280; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb';this.style.color='#374151'" onmouseout="this.style.background='transparent';this.style.color='#6b7280'">
            <i class="ph ph-anchor"></i> æ™ºæ…§æ´¾èª²
          </a>
        </div>
        <div style="width: 60px;"></div>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-8">
    <!-- æ¨™é¡Œå€åŸŸ -->
    <div class="text-center mb-12">
      <h1 class="font-bold text-gray-900 mb-2" style="font-size: 40px; letter-spacing: -0.015em; font-weight: 600;">è¨“ç·´æ’ç¨‹</h1>
      <p class="text-gray-600" style="font-size: 17px; font-weight: 400;">æ™ºèƒ½ç®¡ç†å¹³å°</p>
    </div>

    <!-- åŒæ­¥ç‹€æ…‹æç¤º -->
    <div id="syncStatusBanner" class="card p-4 mb-6 hidden border border-transparent" role="alert" aria-live="polite">
      <div class="flex items-start justify-between gap-4">
        <div class="flex items-start gap-3">
          <span id="syncStatusIcon" class="text-2xl">â„¹ï¸</span>
          <div>
            <p id="syncStatusText" class="font-semibold text-gray-800"></p>
            <p id="syncStatusHint" class="text-sm text-gray-600 mt-1" style="display: none;"></p>
          </div>
        </div>
        <button type="button" onclick="dismissSyncStatus()" class="text-gray-400 hover:text-gray-600 transition" aria-label="é—œé–‰æé†’">
          âœ•
        </button>
      </div>
    </div>

    <div class="max-w-7xl mx-auto space-y-6">
      <!-- èª²ç¨‹è¡Œäº‹æ›† -->
      <div class="card p-6 fade-in" style="animation-delay: 0.1s">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
          <h2 style="font-size: 24px; font-weight: 600; letter-spacing: -0.01em;" class="text-gray-900"><i class="ph ph-calendar"></i> èª²ç¨‹è¡Œäº‹æ›†</h2>
          <div class="flex items-center gap-3">
            <button onclick="openAddCourseModal()" class="modern-btn px-6 py-2 rounded-xl font-medium" style="font-size: 15px;">
              <i class="ph ph-plus-circle"></i> æ–°å¢èª²ç¨‹
            </button>
            <div class="flex rounded-xl p-1" style="background: rgba(118, 118, 128, 0.12);">
              <button id="monthViewBtn" onclick="setViewMode('month')" class="px-4 py-2 rounded-lg text-sm font-semibold bg-white text-gray-900" style="box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);">
                <i class="ph ph-calendar"></i> æœˆ
              </button>
              <button id="weekViewBtn" onclick="setViewMode('week')" class="px-4 py-2 rounded-lg text-sm font-semibold text-gray-600" style="background: transparent;">
                <i class="ph ph-chart-bar"></i> é€±
              </button>
            </div>
          </div>
        </div>

        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center space-x-4">
            <button onclick="previousPeriod()" class="bg-white hover:bg-gray-50 px-4 py-2 rounded-xl font-medium border border-gray-200" style="transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); font-size: 15px;">
              â† <span id="prevLabel">ä¸Šå€‹æœˆ</span>
            </button>
            <h3 id="currentMonth" class="font-semibold text-gray-800 min-w-[200px] text-center" style="font-size: 19px; font-weight: 600;"></h3>
            <button onclick="nextPeriod()" class="bg-white hover:bg-gray-50 px-4 py-2 rounded-xl font-medium border border-gray-200" style="transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); font-size: 15px;">
              <span id="nextLabel">ä¸‹å€‹æœˆ</span> â†’
            </button>
          </div>
          <button onclick="goToToday()" class="modern-btn px-4 py-2 rounded-xl font-medium" style="font-size: 15px;">
            ğŸ¯ ä»Šå¤©
          </button>
        </div>

        <!-- è¡Œäº‹æ›†ç¶²æ ¼ (æ¡Œé¢ç‰ˆ) -->
        <div class="calendar-grid-container bg-white rounded-xl overflow-hidden border border-gray-200" style="box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);">
          <!-- æ˜ŸæœŸæ¨™é¡Œ -->
          <div class="grid grid-cols-7" style="background: #007aff;">
            <div class="p-3 text-center font-semibold text-white border-r border-white/10" style="font-size: 14px;">æ—¥</div>
            <div class="p-3 text-center font-semibold text-white border-r border-white/10" style="font-size: 14px;">ä¸€</div>
            <div class="p-3 text-center font-semibold text-white border-r border-white/10" style="font-size: 14px;">äºŒ</div>
            <div class="p-3 text-center font-semibold text-white border-r border-white/10" style="font-size: 14px;">ä¸‰</div>
            <div class="p-3 text-center font-semibold text-white border-r border-white/10" style="font-size: 14px;">å››</div>
            <div class="p-3 text-center font-semibold text-white border-r border-white/10" style="font-size: 14px;">äº”</div>
            <div class="p-3 text-center font-semibold text-white" style="font-size: 14px;">å…­</div>
          </div>
          <!-- æ—¥æœŸç¶²æ ¼ -->
          <div id="calendarGrid" class="grid grid-cols-7"></div>
        </div>

        <!-- æ—¥æœŸç¯„åœé¸æ“‡å™¨ -->
        <div class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
          <div class="flex flex-col md:flex-row items-start md:items-center gap-4">
            <div class="flex items-center gap-2">
              <i class="ph ph-calendar-dots text-blue-600" style="font-size: 20px;"></i>
              <span class="font-semibold text-gray-700" style="font-size: 14px;">æ—¥æœŸç¯„åœï¼š</span>
            </div>
            <div class="flex flex-wrap items-center gap-3">
              <div class="flex items-center gap-2">
                <label class="text-gray-600" style="font-size: 13px;">å¾</label>
                <input type="date" id="dateRangeStart"
                       onchange="updateDateRange()"
                       class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       style="font-size: 14px;">
              </div>
              <div class="flex items-center gap-2">
                <label class="text-gray-600" style="font-size: 13px;">åˆ°</label>
                <input type="date" id="dateRangeEnd"
                       onchange="updateDateRange()"
                       class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       style="font-size: 14px;">
              </div>
              <button onclick="resetDateRange()"
                      class="px-4 py-2 bg-white hover:bg-gray-50 text-gray-700 rounded-lg font-medium border border-gray-300 transition-colors"
                      style="font-size: 13px;">
                <i class="ph ph-arrow-counter-clockwise"></i> é‡ç½®ç‚ºæœ¬æœˆ
              </button>
            </div>
          </div>
        </div>

        <!-- æ‰‹æ©Ÿç‰ˆè¡Œäº‹æ›†åˆ—è¡¨ -->
        <div class="mobile-calendar-view bg-white rounded-xl overflow-hidden shadow-sm border border-gray-200 p-4">
          <div id="mobileEventsList" class="space-y-3"></div>
        </div>
      </div>

      <!-- çµ±è¨ˆåˆ†æå€ -->
      <div id="selectedTeacherBanner" class="card p-4 mb-6 fade-in" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="text-2xl"><i class="ph ph-chalkboard-teacher"></i></div>
            <div class="text-white">
              <p class="text-sm opacity-90">ç›®å‰æª¢è¦–å¸«è³‡ï¼ˆå†æ¬¡é»é¸å¸«è³‡å¯å–æ¶ˆï¼‰</p>
              <p id="selectedTeacherName" class="text-xl font-bold"></p>
            </div>
          </div>
          <button onclick="clearTeacherSelection()" class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg font-medium transition-colors">
            <i class="ph ph-x"></i> æ¸…é™¤
          </button>
        </div>
      </div>

      <div id="selectedDateBanner" class="card p-4 mb-6 fade-in" style="display: none; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="text-2xl"><i class="ph ph-calendar"></i></div>
            <div class="text-white">
              <p class="text-sm opacity-90">ç›®å‰æª¢è¦–æ—¥æœŸï¼ˆå†æ¬¡é»é¸æ—¥æœŸå¯å–æ¶ˆï¼‰</p>
              <p id="selectedDateText" class="text-xl font-bold"></p>
            </div>
          </div>
          <button onclick="clearDateSelection()" class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg font-medium transition-colors">
            âœ• æ¸…é™¤
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- ç¸½èª²ç¨‹æ•¸ -->
        <div class="card p-6 card-hover fade-in">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 mb-1" style="font-size: 13px; font-weight: 500;">ç¸½èª²ç¨‹æ•¸</p>
              <p id="totalCoursesCount" class="font-bold text-gray-900" style="font-size: 32px; letter-spacing: -0.02em;">0</p>
            </div>
            <div style="font-size: 36px;"><i class="ph ph-books"></i></div>
          </div>
        </div>

        <!-- ç¸½æ™‚æ•¸ -->
        <div class="card p-6 card-hover fade-in" style="animation-delay: 0.1s">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 mb-1" style="font-size: 13px; font-weight: 500;">ç¸½æˆèª²æ™‚æ•¸</p>
              <p id="totalHoursCount" class="font-bold text-gray-900" style="font-size: 32px; letter-spacing: -0.02em;">0</p>
            </div>
            <div style="font-size: 36px;">â±ï¸</div>
          </div>
        </div>

        <!-- ç¯„åœå…§æ™‚æ•¸ -->
        <div class="card p-6 card-hover fade-in" style="animation-delay: 0.2s">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 mb-1" style="font-size: 13px; font-weight: 500;">ç¯„åœå…§ç¸½æ™‚æ•¸</p>
              <p id="monthlyHoursCount" class="font-bold text-blue-600" style="font-size: 32px; letter-spacing: -0.02em;">0</p>
            </div>
            <div style="font-size: 36px;">ğŸ“Š</div>
          </div>
        </div>
      </div>

      <!-- å¸«è³‡æ™‚æ•¸åˆ†æ -->
      <div id="teacherHoursAnalysisCard" class="card p-6 fade-in" style="animation-delay: 0.3s">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-gray-900" style="font-size: 24px; font-weight: 600; letter-spacing: -0.01em;"><i class="ph ph-chalkboard-teacher"></i> å¸«è³‡æ™‚æ•¸åˆ†æ</h2>
          <button onclick="toggleTeacherHoursAnalysis()" class="px-4 py-2 font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors" style="font-size: 14px;">
            <span id="toggleAnalysisIcon">ğŸ‘ï¸</span> <span id="toggleAnalysisText">éš±è—</span>
          </button>
        </div>
        <div id="teacherHoursAnalysis">
          <!-- é”æ¨™æé†’ -->
          <div id="targetAchievedAlert" class="mb-4" style="display: none;">
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500 p-4 rounded-lg">
              <div class="flex items-center">
                <div class="flex-shrink-0">
                  <span class="text-2xl">ğŸ‰</span>
                </div>
                <div class="ml-3">
                  <p class="text-sm font-medium text-green-800">
                    æ­å–œï¼æœ¬æœˆæœ‰ <span id="targetAchievedCount" class="font-bold text-green-900"></span> ä½å¸«è³‡å·²é”æ¨™ 12 å°æ™‚
                  </p>
                </div>
              </div>
            </div>
          </div>
          <!-- æœå°‹æ¡† -->
          <div class="mb-4">
            <input type="text" id="teacherSearchInput"
                   placeholder="ğŸ” æœå°‹å¸«è³‡å§“å..."
                   oninput="filterTeachers()"
                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);">
          </div>
          <!-- å¸«è³‡åˆ—è¡¨ -->
          <div id="teacherHoursList" class="space-y-4">
            <!-- å¸«è³‡æ™‚æ•¸æ¢å°‡åœ¨é€™è£¡é¡¯ç¤º -->
          </div>
          <!-- é¡¯ç¤ºæ›´å¤šæŒ‰éˆ• -->
          <div id="showMoreContainer" class="mt-4 text-center" style="display: none;">
            <button onclick="toggleShowAllTeachers()" class="px-6 py-2 text-sm font-medium text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-lg transition-colors">
              <span id="showMoreText">é¡¯ç¤ºæ›´å¤š</span> <span id="showMoreIcon">â–¼</span>
            </button>
          </div>
        </div>
      </div>

      <!-- èª²ç¨‹é¡å‹åˆ†ä½ˆ -->
      <div class="card p-6 fade-in" style="animation-delay: 0.4s">
        <h2 class="text-gray-900 mb-6" style="font-size: 24px; font-weight: 600; letter-spacing: -0.01em;">ğŸ“Š èª²ç¨‹é¡å‹åˆ†ä½ˆ</h2>
        <div style="position: relative; height: 300px; max-width: 600px; margin: 0 auto;">
          <canvas id="courseTypeChart"></canvas>
        </div>
      </div>

      <!-- èª²ç¨‹ç¸½è¦½ -->
      <div class="card p-6 fade-in" style="animation-delay: 0.5s">
        <div class="flex items-center justify-between mb-6">
          <h2 id="courseOverviewTitle" class="text-gray-900" style="font-size: 24px; font-weight: 600; letter-spacing: -0.01em;"><i class="ph ph-calendar"></i> ä»Šæ—¥èª²ç¨‹ç¸½è¦½</h2>
          <div class="text-gray-600" id="todayDate" style="font-size: 14px;"></div>
        </div>
        <div id="todayCoursesContainer" class="space-y-3">
          <!-- èª²ç¨‹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
        </div>
      </div>
    </div>
  </div>

  <!-- æ–°å¢èª²ç¨‹ Modal -->
  <div id="addCourseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
    <div class="modal-card">

      <!-- Modal é ­éƒ¨ -->
      <div class="modal-header">
        <h3><i class="ph ph-books"></i> æ–°å¢èª²ç¨‹</h3>
      </div>

      <!-- Modal å…§å®¹å€ï¼ˆå¯æ»¾å‹•ï¼‰ -->
      <div class="modal-content">
        <form id="courseForm" class="space-y-4">
        <div>
          <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">é¸æ“‡å¸«è³‡</label>
          <select id="courseTeacherId" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);" required>
            <option value="">è«‹é¸æ“‡å¸«è³‡</option>
          </select>
        </div>

        <div>
          <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">é¸æ“‡åŠ©æ•™</label>
          <select id="courseTaId" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);">
            <option value="">è«‹é¸æ“‡åŠ©æ•™ï¼ˆé¸å¡«ï¼‰</option>
          </select>
        </div>

        <div>
          <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">èª²ç¨‹åç¨±</label>
          <select id="courseName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);" required>
            <option value="">è«‹é¸æ“‡èª²ç¨‹</option>
          </select>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">èª²ç¨‹æ—¥æœŸ</label>
            <input type="date" id="courseDate" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);" required>
          </div>
          <div>
            <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">èª²ç¨‹é¡å‹</label>
            <select id="courseType" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);">
              <option value="æ­£èª²">æ­£èª²</option>
              <option value="è£œèª²">è£œèª²</option>
              <option value="å¯¦é©—èª²">å¯¦é©—èª²</option>
              <option value="å¯¦ä½œèª²">å¯¦ä½œèª²</option>
              <option value="å°ˆé¡Œ">å°ˆé¡Œ</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">é–‹å§‹æ™‚é–“</label>
            <input type="time" id="startTime" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);" required>
          </div>
          <div>
            <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">çµæŸæ™‚é–“</label>
            <input type="time" id="endTime" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);" required>
          </div>
        </div>

        <div>
          <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">ç‹€æ…‹</label>
          <select id="courseStatus" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);" required>
            <option value="ä¸Šç­">ä¸Šç­</option>
            <option value="ä¼‘å‡">ä¼‘å‡</option>
            <option value="å‡ºå·®">å‡ºå·®</option>
          </select>
        </div>

        <div>
          <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">å‚™è¨»</label>
          <textarea id="courseNote" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="é¸å¡«ï¼šèª²ç¨‹ç›¸é—œå‚™è¨»..." style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);"></textarea>
        </div>
        </form>
      </div>

      <!-- Modal åº•éƒ¨æŒ‰éˆ•å€ï¼ˆå›ºå®šï¼‰ -->
      <div class="modal-footer">
        <div class="flex justify-end space-x-4">
          <button type="button" onclick="closeAddCourseModal()" class="px-6 py-3 bg-gray-500 text-white rounded-xl font-medium hover:bg-gray-600" style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);">
            å–æ¶ˆ
          </button>
          <button type="button" onclick="document.getElementById('courseForm').requestSubmit()" class="modern-btn px-6 py-3 rounded-xl font-medium" style="font-size: 15px;">
            ç¢ºèªæ–°å¢
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- iOS é¢¨æ ¼çš„å½ˆå‡ºå¼æ“ä½œé¸å–® -->
  <div class="context-menu-overlay" id="contextMenuOverlay" onclick="closeContextMenu()">
    <div class="context-menu-popup" onclick="event.stopPropagation()">
      <div class="menu-option" onclick="copyCourseToClipboard(); closeContextMenu();">
        <span>è¤‡è£½</span>
        <svg viewBox="0 0 24 24">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      </div>
      <div class="menu-option" onclick="openDuplicateDateModal(); closeContextMenu();">
        <span>è¤‡è£½åˆ°å…¶ä»–æ—¥æœŸ</span>
        <svg viewBox="0 0 24 24">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
          <line x1="12" y1="14" x2="12" y2="18"></line>
          <line x1="10" y1="16" x2="14" y2="16"></line>
        </svg>
      </div>
      <div class="menu-option" onclick="shareCourse(); closeContextMenu();">
        <span>åˆ†äº«</span>
        <svg viewBox="0 0 24 24">
          <circle cx="18" cy="5" r="3"></circle>
          <circle cx="6" cy="12" r="3"></circle>
          <circle cx="18" cy="19" r="3"></circle>
          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
          <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
        </svg>
      </div>
      <div class="menu-option" onclick="openSurveyManagement(editingCourseId); closeContextMenu();">
        <span>å•å·ç®¡ç†</span>
        <svg viewBox="0 0 24 24">
          <line x1="18" y1="20" x2="18" y2="10"></line>
          <line x1="12" y1="20" x2="12" y2="4"></line>
          <line x1="6" y1="20" x2="6" y2="14"></line>
        </svg>
      </div>
      <div class="menu-option menu-option-danger" onclick="confirmDeleteCourse(); closeContextMenu();">
        <span>åˆªé™¤</span>
        <svg viewBox="0 0 24 24">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      </div>
    </div>
  </div>

  <!-- è¤‡è£½åˆ°å…¶ä»–æ—¥æœŸ Modal -->
  <div id="duplicateDateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[60] p-4">
    <div class="modal-card" style="max-width: 480px;">

      <!-- Modal é ­éƒ¨ -->
      <div class="modal-header">
        <h3><i class="ph ph-calendar"></i> è¤‡è£½åˆ°å…¶ä»–æ—¥æœŸ</h3>
      </div>

      <!-- Modal å…§å®¹å€ï¼ˆå¯æ»¾å‹•ï¼‰ -->
      <div class="modal-content">
        <div class="space-y-4">
          <div>
            <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">é¸æ“‡æ–°æ—¥æœŸ</label>
            <input type="date" id="duplicateNewDate" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="font-size: 15px;" required>
          </div>

          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <p class="text-sm text-blue-800">
              <svg class="modal-icon modal-icon-sm"><use href="#icon-lightbulb"></use></svg>
              èª²ç¨‹å°‡æœƒä¿ç•™æ‰€æœ‰è³‡è¨Šï¼ˆå¸«è³‡ã€æ™‚é–“ã€å‚™è¨»ç­‰ï¼‰ï¼Œåƒ…æ›´æ”¹æ—¥æœŸã€‚
            </p>
          </div>
        </div>
      </div>

      <!-- Modal åº•éƒ¨æŒ‰éˆ•å€ï¼ˆå›ºå®šï¼‰ -->
      <div class="modal-footer">
        <div class="flex justify-end space-x-4">
          <button onclick="closeDuplicateDateModal()" class="px-6 py-3 bg-gray-500 text-white rounded-xl font-medium hover:bg-gray-600" style="font-size: 15px;">
            å–æ¶ˆ
          </button>
          <button onclick="confirmDuplicateCourse()" class="px-6 py-3 bg-blue-500 text-white rounded-xl font-medium hover:bg-blue-600" style="font-size: 15px;">
            ç¢ºèªè¤‡è£½
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- æŸ¥çœ‹/ç·¨è¼¯èª²ç¨‹è©³æƒ… Modal -->
  <div id="viewEventModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
    <div class="modal-card">

      <!-- Modal é ­éƒ¨ -->
      <div class="modal-header">
        <h3 id="modalTitle"><i class="ph ph-calendar"></i> èª²ç¨‹è©³æƒ…</h3>
      </div>

      <!-- Modal å…§å®¹å€ï¼ˆå¯æ»¾å‹•ï¼‰ -->
      <div class="modal-content">
        <!-- æŸ¥çœ‹æ¨¡å¼ -->
        <div id="viewMode" class="space-y-4"></div>

        <!-- ç·¨è¼¯æ¨¡å¼ -->
        <form id="editCourseForm" class="space-y-4" style="display: none;">
        <div>
          <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">é¸æ“‡å¸«è³‡</label>
          <select id="editTeacherId" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);" required>
            <option value="">è«‹é¸æ“‡å¸«è³‡</option>
          </select>
        </div>

        <div>
          <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">é¸æ“‡åŠ©æ•™</label>
          <select id="editTaId" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);">
            <option value="">è«‹é¸æ“‡åŠ©æ•™ï¼ˆé¸å¡«ï¼‰</option>
          </select>
        </div>

        <div>
          <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">èª²ç¨‹åç¨±</label>
          <input type="text" id="editCourseName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);" required>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">èª²ç¨‹æ—¥æœŸ</label>
            <input type="date" id="editCourseDate" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);" required>
          </div>
          <div>
            <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">èª²ç¨‹é¡å‹</label>
            <select id="editCourseType" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);">
              <option value="æ­£èª²">æ­£èª²</option>
              <option value="è£œèª²">è£œèª²</option>
              <option value="å¯¦é©—èª²">å¯¦é©—èª²</option>
              <option value="å¯¦ä½œèª²">å¯¦ä½œèª²</option>
              <option value="å°ˆé¡Œ">å°ˆé¡Œ</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">é–‹å§‹æ™‚é–“</label>
            <input type="time" id="editStartTime" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);" required>
          </div>
          <div>
            <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">çµæŸæ™‚é–“</label>
            <input type="time" id="editEndTime" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);" required>
          </div>
        </div>

        <div>
          <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">ç‹€æ…‹</label>
          <select id="editCourseStatus" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);" required>
            <option value="ä¸Šç­">ä¸Šç­</option>
            <option value="ä¼‘å‡">ä¼‘å‡</option>
            <option value="å‡ºå·®">å‡ºå·®</option>
          </select>
        </div>

        <div>
          <label class="block font-medium text-gray-700 mb-2" style="font-size: 14px;">å‚™è¨»</label>
          <textarea id="editCourseNote" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="é¸å¡«ï¼šèª²ç¨‹ç›¸é—œå‚™è¨»..." style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);" onblur="autoGenerateTags()"></textarea>

          <!-- è‡ªå‹•ç”Ÿæˆçš„æ¨™ç±¤ -->
          <div class="mt-3">
            <div class="flex items-center justify-between mb-2">
              <label class="block font-medium text-gray-700" style="font-size: 13px;">
                <svg class="modal-icon modal-icon-sm"><use href="#icon-tag"></use></svg>
                è‡ªå‹•æ¨™ç±¤
              </label>
              <button type="button" onclick="autoGenerateTags()" class="text-xs" style="color: var(--apple-blue);">é‡æ–°ç”Ÿæˆ</button>
            </div>
            <div id="autoTagsContainer" class="flex flex-wrap gap-2"></div>
          </div>
        </div>
        </form>
      </div>

      <!-- Modal åº•éƒ¨æŒ‰éˆ•å€ï¼ˆå›ºå®šï¼‰ -->
      <div class="modal-footer">
        <!-- æŸ¥çœ‹æ¨¡å¼æŒ‰éˆ• -->
        <div id="viewModeButtons">
          <div class="flex flex-wrap gap-3 items-center">
            <button onclick="toggleContextMenu()" class="apple-btn apple-btn-secondary" style="margin-right: auto;">
              <svg class="modal-icon"><use href="#icon-more"></use></svg>
              æ›´å¤š
            </button>

            <button onclick="closeViewEventModal()" class="apple-btn apple-btn-secondary">
              é—œé–‰
            </button>
            <button onclick="enterEditMode()" class="apple-btn apple-btn-primary">
              <svg class="modal-icon"><use href="#icon-edit"></use></svg>
              ç·¨è¼¯
            </button>
          </div>
        </div>

        <!-- ç·¨è¼¯æ¨¡å¼æŒ‰éˆ• -->
        <div id="editModeButtons" class="flex justify-end space-x-4" style="display: none;">
          <button onclick="cancelEditMode()" class="px-6 py-3 bg-gray-500 text-white rounded-xl font-medium hover:bg-gray-600" style="font-size: 15px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);">
            å–æ¶ˆ
          </button>
          <button onclick="saveEditedCourse()" class="modern-btn px-6 py-3 rounded-xl font-medium" style="font-size: 15px;">
            <svg class="modal-icon"><use href="#icon-save"></use></svg>
            å„²å­˜è®Šæ›´
          </button>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ==================== è³‡æ–™ç®¡ç† ====================
    const loadArray = typeof loadArrayFromStorage === 'function'
      ? loadArrayFromStorage
      : function fallbackLoadArray(key, normalizer) {
          const raw = localStorage.getItem(key);
          if (!raw) return [];

          try {
            const parsed = JSON.parse(raw);
            if (!Array.isArray(parsed)) return [];
            return typeof normalizer === 'function' ? parsed.map(normalizer) : parsed;
          } catch (error) {
            console.warn(`âš ï¸ ç„¡æ³•è§£æ ${key}ï¼š`, error);
            return [];
          }
        };

    let teachers = loadArray('teachers', typeof normalizeTeacherRecord === 'function' ? normalizeTeacherRecord : undefined);
    let courseAssignments = loadArray('courseAssignments', typeof normalizeCourseAssignment === 'function' ? normalizeCourseAssignment : undefined);
    let calendarEvents = loadArray('calendarEvents');

    let currentDate = new Date();
    let viewMode = 'month';
    let courseTypeChart = null;
    let showAllTeachers = false;
    let teacherSearchQuery = '';
    let selectedTeacherId = null;
    let editingCourseId = null;
    let selectedDate = null;

    // æ—¥æœŸç¯„åœè®Šé‡
    let dateRangeStart = null;
    let dateRangeEnd = null;

    // ==================== é€šç”¨è¨Šæ¯é¡¯ç¤º ====================
    function showMessage(message, type = 'info', hint = '') {
      const banner = document.getElementById('syncStatusBanner');
      const textElement = document.getElementById('syncStatusText');
      const hintElement = document.getElementById('syncStatusHint');
      const iconElement = document.getElementById('syncStatusIcon');

      if (!banner || !textElement || !iconElement) {
        // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯ï¼ˆå·²é€é UI é¡¯ç¤ºï¼‰
        return;
      }

      const typeStyles = {
        info: {
          wrapper: 'bg-blue-50 border-blue-200 text-blue-800',
          icon: 'â„¹ï¸'
        },
        success: {
          wrapper: 'bg-green-50 border-green-200 text-green-700',
          icon: 'âœ“'
        },
        warning: {
          wrapper: 'bg-amber-50 border-amber-200 text-amber-700',
          icon: 'âš ï¸'
        },
        error: {
          wrapper: 'bg-red-50 border-red-200 text-red-700',
          icon: 'âœ—'
        }
      };

      const style = typeStyles[type] || typeStyles.info;

      banner.className = `card p-4 mb-6 border border-transparent ${style.wrapper}`;
      textElement.textContent = message;
      iconElement.textContent = style.icon;

      if (hint) {
        hintElement.textContent = hint;
        hintElement.style.display = 'block';
      } else {
        hintElement.textContent = '';
        hintElement.style.display = 'none';
      }

      banner.classList.remove('hidden');
    }

    function dismissSyncStatus() {
      const banner = document.getElementById('syncStatusBanner');
      if (banner) {
        banner.classList.add('hidden');
      }
    }

    // ==================== è¡çªå°è©±æ¡† - é¡¯ç¤ºè³‡æ–™è¡çªè©³æƒ… ====================
    function showConflictDialog(result) {
      const activeSessions = result.activeSessions || [];
      const conflicts = result.conflicts || [];

      // è³‡æ–™è¡çªè©³æƒ…
      let conflictDetailsHTML = '';
      if (conflicts.length > 0) {
        const tableNames = {
          'teachers': 'æ•™å¸«è³‡æ–™',
          'courseAssignments': 'èª²ç¨‹å®‰æ’',
          'maritimeCourses': 'æµ·äº‹èª²ç¨‹'
        };
        conflictDetailsHTML = '<div style="margin: 15px 0; padding: 15px; background: #fef3c7; border-radius: 8px;"><strong>åµæ¸¬åˆ°ä»¥ä¸‹è³‡æ–™è®Šæ›´ï¼š</strong><ul style="margin: 10px 0; padding-left: 20px;">';
        conflicts.forEach(c => {
          const tableName = tableNames[c.table] || c.table;
          conflictDetailsHTML += `<li style="margin: 5px 0;"><strong>${tableName}</strong>: è¼‰å…¥æ™‚ ${c.savedCount} ç­†ï¼Œç›®å‰å¾Œç«¯ ${c.currentCount} ç­†</li>`;
        });
        conflictDetailsHTML += '</ul><p style="margin: 0; color: #92400e; font-size: 14px;">Google Sheets ä¸Šçš„è³‡æ–™å·²è¢«ä¿®æ”¹ã€‚è‹¥ç¹¼çºŒå„²å­˜ï¼Œå°‡è¦†è“‹é€™äº›è®Šæ›´ã€‚</p></div>';
      }

      // åœ¨ç·šä½¿ç”¨è€…åˆ—è¡¨
      let userListHTML = '';
      if (activeSessions.length > 0) {
        userListHTML = '<div style="margin: 15px 0;"><strong>ç›®å‰åœ¨ç·šçš„ä½¿ç”¨è€…ï¼š</strong><ul style="list-style: none; padding: 10px 0; margin: 0;">';

        activeSessions.forEach(session => {
          const timeAgo = getTimeAgo(session.lastActiveTime);
          userListHTML += `
            <li style="padding: 8px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>${session.userName || 'è¨ªå®¢'}</strong>
                ${session.userEmail ? `<br><small style="color: #666;">${session.userEmail}</small>` : ''}
                <br><small style="color: #999;">æœ€å¾Œæ´»å‹•: ${timeAgo}</small>
              </div>
              <button
                onclick="kickUser('${session.sessionId}', '${session.userName}')"
                style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                è¸¢å‡º
              </button>
            </li>
          `;
        });

        userListHTML += '</ul></div>';
      }

      const hintText = result.hint || 'å»ºè­°å…ˆé‡æ–°è¼‰å…¥è³‡æ–™ï¼Œç¢ºèªæœ€æ–°ç‹€æ…‹å¾Œå†é€²è¡Œç·¨è¼¯ã€‚';

      const dialogHTML = `
        <div id="conflictDialog" style="
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0,0,0,0.5); display: flex; align-items: center;
          justify-content: center; z-index: 10000;">
          <div style="
            background: white; padding: 30px; border-radius: 12px;
            max-width: 550px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
            <h2 style="margin: 0 0 15px 0; color: #d97706;">âš ï¸ è³‡æ–™è¡çªè­¦å‘Š</h2>
            <p style="color: #374151; margin: 10px 0;">${result.message || 'å¾Œç«¯è³‡æ–™å·²è¢«ä¿®æ”¹'}</p>
            ${conflictDetailsHTML}
            ${userListHTML}
            <p style="color: #6b7280; font-size: 14px; margin: 15px 0;">${hintText}</p>
            <div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-end;">
              <button
                onclick="closeConflictDialog()"
                style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                å–æ¶ˆ
              </button>
              <button
                onclick="forceOverwriteData()"
                style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                å¼·åˆ¶è¦†è“‹
              </button>
              <button
                onclick="reloadFromBackend()"
                style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                é‡æ–°è¼‰å…¥è³‡æ–™
              </button>
            </div>
          </div>
        </div>
      `;

      // ç§»é™¤èˆŠçš„å°è©±æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      const oldDialog = document.getElementById('conflictDialog');
      if (oldDialog) {
        oldDialog.remove();
      }

      // åŠ å…¥æ–°å°è©±æ¡†
      document.body.insertAdjacentHTML('beforeend', dialogHTML);
    }

    // å¼·åˆ¶è¦†è“‹å¾Œç«¯è³‡æ–™ï¼ˆå¿½ç•¥è¡çªï¼‰
    async function forceOverwriteData() {
      if (!confirm('ç¢ºå®šè¦å¼·åˆ¶è¦†è“‹å—ï¼Ÿé€™æœƒè¦†è“‹ Google Sheets ä¸Šå…¶ä»–äººçš„ä¿®æ”¹ã€‚')) {
        return;
      }
      closeConflictDialog();
      try {
        const result = await syncManager.saveToBackendSafe(true); // forceOverwrite = true
        if (result.success) {
          showMessage('è³‡æ–™å·²å¼·åˆ¶å„²å­˜åˆ°é›²ç«¯', 'success');
        }
      } catch (error) {
        showMessage('å„²å­˜å¤±æ•—: ' + error.message, 'error');
      }
    }

    // å¾å¾Œç«¯é‡æ–°è¼‰å…¥è³‡æ–™
    async function reloadFromBackend() {
      closeConflictDialog();
      try {
        await syncManager.loadFromBackend();
        reloadCourseDataFromStorage();
        renderAllCourseViews();
        showMessage('å·²å¾é›²ç«¯é‡æ–°è¼‰å…¥æœ€æ–°è³‡æ–™', 'success');
      } catch (error) {
        showMessage('é‡æ–°è¼‰å…¥å¤±æ•—: ' + error.message, 'error');
      }
    }

    function closeConflictDialog() {
      const dialog = document.getElementById('conflictDialog');
      if (dialog) {
        dialog.remove();
      }
    }

    async function kickUser(sessionId, userName) {
      if (!confirm(`ç¢ºå®šè¦è¸¢å‡ºä½¿ç”¨è€…ã€Œ${userName}ã€å—ï¼Ÿ`)) {
        return;
      }

      try {
        await sessionManager.kickUser(sessionId);
        alert(`âœ“ å·²è¸¢å‡ºä½¿ç”¨è€…ã€Œ${userName}ã€`);

        // é‡æ–°æ•´ç†å°è©±æ¡†
        closeConflictDialog();

        // ç­‰å¾…ä¸€ä¸‹è®“è¢«è¸¢çš„ä½¿ç”¨è€…æœ‰æ™‚é–“åæ‡‰
        setTimeout(async () => {
          const result = await syncManager.saveToBackendSafe();
          if (result.conflict) {
            showConflictDialog(result);
          } else if (result.success) {
            alert('âœ“ å„²å­˜æˆåŠŸï¼');
            window.location.reload();
          }
        }, 2000);
      } catch (error) {
        alert('âœ— è¸¢å‡ºå¤±æ•—: ' + error.message);
      }
    }

    function getTimeAgo(timestamp) {
      const now = new Date();
      const time = new Date(timestamp);
      const diffMs = now - time;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);

      if (diffSec < 60) {
        return `${diffSec} ç§’å‰`;
      } else if (diffMin < 60) {
        return `${diffMin} åˆ†é˜å‰`;
      } else {
        const diffHour = Math.floor(diffMin / 60);
        return `${diffHour} å°æ™‚å‰`;
      }
    }

    // ==================== å·¥å…·å‡½æ•¸ - ç²å–æœ¬åœ°æ—¥æœŸå­—ä¸² ====================
    function getLocalDateString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // ==================== åˆå§‹åŒ– ====================
    function reloadCourseDataFromStorage() {
      teachers = loadArray('teachers', typeof normalizeTeacherRecord === 'function' ? normalizeTeacherRecord : undefined);
      courseAssignments = loadArray('courseAssignments', typeof normalizeCourseAssignment === 'function' ? normalizeCourseAssignment : undefined);
      calendarEvents = loadArray('calendarEvents');
    }

    function renderAllCourseViews() {
      loadTeachers();
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
      renderCalendar();
      updateTodayDate();
      loadTeacherHoursAnalysisVisibility();
    }

    // ==================== æ—¥æœŸç¯„åœè™•ç† ====================

    // åˆå§‹åŒ–æ—¥æœŸç¯„åœç‚ºç•¶æœˆ
    function initializeDateRange() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();

      // ç•¶æœˆç¬¬ä¸€å¤©
      const firstDay = new Date(year, month, 1);
      // ç•¶æœˆæœ€å¾Œä¸€å¤©
      const lastDay = new Date(year, month + 1, 0);

      dateRangeStart = getLocalDateString(firstDay);
      dateRangeEnd = getLocalDateString(lastDay);

      // æ›´æ–° UI
      const startInput = document.getElementById('dateRangeStart');
      const endInput = document.getElementById('dateRangeEnd');
      if (startInput) startInput.value = dateRangeStart;
      if (endInput) endInput.value = dateRangeEnd;
    }

    // æ›´æ–°æ—¥æœŸç¯„åœ
    function updateDateRange() {
      const startInput = document.getElementById('dateRangeStart');
      const endInput = document.getElementById('dateRangeEnd');

      if (startInput && endInput && startInput.value && endInput.value) {
        dateRangeStart = startInput.value;
        dateRangeEnd = endInput.value;

        // ç¢ºä¿çµæŸæ—¥æœŸä¸æ—©æ–¼é–‹å§‹æ—¥æœŸ
        if (dateRangeEnd < dateRangeStart) {
          alert('çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸï¼');
          endInput.value = dateRangeStart;
          dateRangeEnd = dateRangeStart;
          return;
        }

        // æ›´æ–°æ—¥æ›†é¡¯ç¤ºä»¥åŒ¹é…æ‰€é¸æ—¥æœŸç¯„åœ
        // è§£æé–‹å§‹æ—¥æœŸä¸¦æ›´æ–° currentDate åˆ°è©²æœˆä»½
        const startDate = new Date(dateRangeStart + 'T00:00:00');
        if (!isNaN(startDate.getTime())) {
          currentDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
          renderCalendar(); // é‡æ–°æ¸²æŸ“æ—¥æ›†ä»¥åæ˜ æ–°çš„æœˆä»½
        }

        // é‡æ–°æ¸²æŸ“æ‰€æœ‰ç›¸é—œè¦–åœ–
        renderAllCourseViews();
      }
    }

    // é‡ç½®æ—¥æœŸç¯„åœç‚ºç•¶æœˆ
    function resetDateRange() {
      initializeDateRange();
      renderAllCourseViews();
      showMessage('âœ… å·²é‡ç½®ç‚ºæœ¬æœˆç¯„åœ', 'success');
    }

    // åŒæ­¥æ—¥æœŸç¯„åœåˆ°ç•¶å‰é¡¯ç¤ºçš„æœˆä»½
    function syncDateRangeToCurrentMonth() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      // ç•¶æœˆç¬¬ä¸€å¤©
      const firstDay = new Date(year, month, 1);
      // ç•¶æœˆæœ€å¾Œä¸€å¤©
      const lastDay = new Date(year, month + 1, 0);

      dateRangeStart = getLocalDateString(firstDay);
      dateRangeEnd = getLocalDateString(lastDay);

      // æ›´æ–° UI
      const startInput = document.getElementById('dateRangeStart');
      const endInput = document.getElementById('dateRangeEnd');
      if (startInput) startInput.value = dateRangeStart;
      if (endInput) endInput.value = dateRangeEnd;

      // é‡æ–°æ¸²æŸ“æ‰€æœ‰ç›¸é—œè¦–åœ–
      renderAllCourseViews();
    }

    // æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨ç¯„åœå…§
    function isDateInRange(dateStr) {
      if (!dateRangeStart || !dateRangeEnd || !dateStr) {
        return true; // å¦‚æœæ²’æœ‰è¨­å®šç¯„åœï¼Œé¡¯ç¤ºæ‰€æœ‰
      }
      return dateStr >= dateRangeStart && dateStr <= dateRangeEnd;
    }

    async function init() {
      // åˆå§‹åŒ–æ—¥æœŸç¯„åœç‚ºç•¶æœˆ
      initializeDateRange();

      // å…ˆç”¨æœ¬åœ°è³‡æ–™å¿«é€Ÿå‘ˆç¾ç•«é¢
      reloadCourseDataFromStorage();
      renderAllCourseViews();
      document.getElementById('courseForm').addEventListener('submit', handleAddCourse);

      if (courseAssignments.length === 0) {
        showMessage('ç›®å‰å°šç„¡èª²ç¨‹è³‡æ–™å¯ä¾›é¡¯ç¤º', 'info', 'è«‹å…ˆè¨­å®šå¾Œç«¯åŒæ­¥æˆ–ä½¿ç”¨ã€Œæ–°å¢èª²ç¨‹ã€å»ºç«‹è³‡æ–™ã€‚');
      }

      // å¾Œç«¯åŒæ­¥æ”¹ç‚ºèƒŒæ™¯é€²è¡Œï¼Œé¿å…è¼‰å…¥è¢«ç¶²è·¯å»¶é²é˜»å¡
      if (typeof initializeDataSync !== 'undefined') {
        initializeDataSync()
          .then(() => {
            reloadCourseDataFromStorage();
            renderAllCourseViews();
          })
          .catch(err => {
            console.warn('âš ï¸ å¾Œç«¯åŒæ­¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™:', err.message);
            showMessage('ç›®å‰ä½¿ç”¨é›¢ç·šè³‡æ–™', 'warning', 'è«‹ç¢ºèª Google Apps Script API è¨­å®šæ˜¯å¦æ­£ç¢ºï¼Œæˆ–ç¨å¾Œå†è©¦ã€‚');
          });
      }

      // ğŸ”’ å®šæœŸåˆ·æ–°é–å®šç‹€æ…‹ï¼ˆæ¯15ç§’ï¼‰
      setInterval(() => {
        updateCoursesDisplay();
      }, 15000);
    }

    function loadTeachers() {
      const select = document.getElementById('courseTeacherId');
      select.innerHTML = '<option value="">è«‹é¸æ“‡å¸«è³‡</option>';
      teachers.forEach(t => {
        select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
      });

      // åŒæ™‚è¼‰å…¥åŠ©æ•™é¸å–®
      const taSelect = document.getElementById('courseTaId');
      taSelect.innerHTML = '<option value="">è«‹é¸æ“‡åŠ©æ•™ï¼ˆé¸å¡«ï¼‰</option>';
      teachers.forEach(t => {
        taSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`;
      });
    }

    function updateTodayDate() {
      const today = new Date();
      const dateStr = today.toLocaleDateString('zh-TW', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      });
      document.getElementById('todayDate').textContent = dateStr;
    }

    // ==================== çµ±è¨ˆåˆ†æ ====================
    function updateStatistics() {
      // æ ¹æ“šé¸æ“‡çš„å¸«è³‡ã€æ—¥æœŸå’Œæ—¥æœŸç¯„åœéæ¿¾èª²ç¨‹
      let filteredCourses = courseAssignments.filter(c => c.date && isDateInRange(c.date));

      if (selectedTeacherId !== null) {
        filteredCourses = filteredCourses.filter(c => c.teacherId === selectedTeacherId);
      }

      if (selectedDate !== null) {
        filteredCourses = filteredCourses.filter(c => c.date === selectedDate);
      }

      // ç¸½èª²ç¨‹æ•¸ï¼ˆåœ¨æ—¥æœŸç¯„åœå…§ï¼‰
      document.getElementById('totalCoursesCount').textContent = filteredCourses.length;

      // ç¸½æ™‚æ•¸ï¼ˆåœ¨æ—¥æœŸç¯„åœå…§ï¼‰
      const totalHours = filteredCourses.reduce((sum, c) => sum + calculateHours(c.time), 0);
      document.getElementById('totalHoursCount').textContent = `${totalHours.toFixed(1)} å°æ™‚`;

      // ç¯„åœå…§æ™‚æ•¸ï¼ˆåŒæ¨£åŸºæ–¼æ—¥æœŸç¯„åœï¼‰
      const rangeHours = filteredCourses.reduce((sum, c) => sum + calculateHours(c.time), 0);
      document.getElementById('monthlyHoursCount').textContent = `${rangeHours.toFixed(1)} å°æ™‚`;
    }

    function renderTeacherHoursAnalysis() {
      const listContainer = document.getElementById('teacherHoursList');
      const showMoreContainer = document.getElementById('showMoreContainer');

      // æ ¹æ“šæ—¥æœŸç¯„åœç¯©é¸èª²ç¨‹
      const filteredCourses = courseAssignments.filter(c => c.date && isDateInRange(c.date));

      console.log('ğŸ“Š å¸«è³‡æ™‚æ•¸åˆ†æèª¿è©¦ä¿¡æ¯ï¼š');
      console.log('- æ—¥æœŸç¯„åœ:', dateRangeStart, 'è‡³', dateRangeEnd);
      console.log('- ç¯„åœå…§èª²ç¨‹æ•¸:', filteredCourses.length);
      console.log('- å¸«è³‡åˆ—è¡¨äººæ•¸:', teachers.length);

      // çµ±ä¸€ teacherId ç‚ºæ•¸å­—å‹åˆ¥ï¼ˆæœ‰äº›å¯èƒ½æ˜¯å­—ä¸²ï¼‰
      // åŒæ™‚æ”¶é›†ä¸»è¬›è€å¸«å’ŒåŠ©æ•™çš„ ID
      const teacherIds = filteredCourses.map(c => Number(c.teacherId)).filter(id => !isNaN(id));
      const taIds = filteredCourses.map(c => Number(c.taId)).filter(id => !isNaN(id));
      const teacherIdsWithCourses = [...new Set([...teacherIds, ...taIds])];

      console.log('- æœ‰èª²ç¨‹çš„å¸«è³‡IDï¼ˆå«åŠ©æ•™ï¼‰:', teacherIdsWithCourses);

      // å»ºç«‹å¸«è³‡åˆ—è¡¨ï¼šåŒ…å«å¸«è³‡ç®¡ç†ä¸­çš„æ‰€æœ‰è€å¸« + ä¸åœ¨åˆ—è¡¨ä¸­ä½†æœ‰èª²ç¨‹çš„è€å¸«
      const teacherMap = new Map();

      // 1. å…ˆåŠ å…¥æ‰€æœ‰åœ¨å¸«è³‡ç®¡ç†åˆ—è¡¨ä¸­çš„è€å¸«
      teachers.forEach(teacher => {
        teacherMap.set(Number(teacher.id), teacher);
      });

      // 2. å†åŠ å…¥æœ‰èª²ç¨‹ä½†ä¸åœ¨å¸«è³‡åˆ—è¡¨ä¸­çš„è€å¸«ï¼ˆåŒ…å«ä¸»è¬›å’ŒåŠ©æ•™ï¼‰
      teacherIdsWithCourses.forEach(teacherId => {
        if (!teacherMap.has(teacherId)) {
          // å˜—è©¦å¾ä¸»è¬›æˆ–åŠ©æ•™èº«ä»½æ‰¾åˆ°åç¨±
          const courseAsTeacher = filteredCourses.find(c => Number(c.teacherId) === teacherId);
          const courseAsTa = filteredCourses.find(c => Number(c.taId) === teacherId);
          const name = courseAsTeacher?.teacherName || courseAsTa?.taName || `æœªçŸ¥å¸«è³‡ (ID: ${teacherId})`;

          teacherMap.set(teacherId, {
            id: teacherId,
            name: name,
            notInTeacherList: true
          });
        }
      });

      const allTeachers = Array.from(teacherMap.values());

      console.log('- ç¸½å¸«è³‡æ•¸ï¼ˆåŒ…å«æœ‰èª²ç¨‹å’Œç„¡èª²ç¨‹ï¼‰:', allTeachers.length);

      if (allTeachers.length === 0) {
        listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">å°šç„¡å¸«è³‡è³‡æ–™</p>';
        showMoreContainer.style.display = 'none';
        document.getElementById('targetAchievedAlert').style.display = 'none';
        return;
      }

      // éæ¿¾å¸«è³‡ï¼ˆæ ¹æ“šæœå°‹æ¢ä»¶ï¼‰
      let filteredTeachers = allTeachers;
      if (teacherSearchQuery.trim() !== '') {
        filteredTeachers = allTeachers.filter(teacher =>
          teacher.name.toLowerCase().includes(teacherSearchQuery.toLowerCase())
        );
      }

      if (filteredTeachers.length === 0) {
        listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">æ‰¾ä¸åˆ°ç¬¦åˆçš„å¸«è³‡</p>';
        showMoreContainer.style.display = 'none';
        document.getElementById('targetAchievedAlert').style.display = 'none';
        return;
      }

      // è¨ˆç®—æ¯ä½å¸«è³‡çš„æ™‚æ•¸ä¸¦æ’åº
      const teachersWithHours = filteredTeachers.map(teacher => {
        // æ ¹æ“šé¸æ“‡æƒ…å¢ƒå½ˆæ€§çµ±è¨ˆæ™‚æ•¸ï¼š
        // 1. é¸æ“‡ç‰¹å®šæ—¥æœŸ â†’ åªçµ±è¨ˆè©²æ—¥æœŸçš„èª²ç¨‹æ™‚æ•¸
        // 2. ç„¡é¸æ“‡ç‰¹å®šæ—¥æœŸ â†’ çµ±è¨ˆæ—¥æœŸç¯„åœå…§çš„æ‰€æœ‰èª²ç¨‹æ™‚æ•¸

        const courses = courseAssignments.filter(c => {
          // è¨ˆç®—ä¸»è¬›è€å¸«å’ŒåŠ©æ•™çš„èª²ç¨‹
          const matchesTeacher = Number(c.teacherId) === Number(teacher.id);
          const matchesTa = c.taId && Number(c.taId) === Number(teacher.id);
          const matchesAny = matchesTeacher || matchesTa;
          const hasValidDate = c.date;

          // å¦‚æœé¸æ“‡äº†ç‰¹å®šæ—¥æœŸï¼Œåªçµ±è¨ˆè©²æ—¥æœŸçš„èª²ç¨‹
          if (selectedDate !== null) {
            return matchesAny && hasValidDate && c.date === selectedDate;
          }

          // å¦å‰‡çµ±è¨ˆæ—¥æœŸç¯„åœå…§çš„æ‰€æœ‰èª²ç¨‹
          return matchesAny && hasValidDate && isDateInRange(c.date);
        });

        const hours = courses.reduce((sum, c) => sum + calculateHours(c.time), 0);
        return { teacher, hours, courses };
      });

      console.log('- å¸«è³‡æ™‚æ•¸çµ±è¨ˆ:', teachersWithHours.map(t => `${t.teacher.name}: ${t.hours}å°æ™‚ (${t.courses.length}å ‚èª²)`));

      // æ’åºï¼šå·²é”æ¨™(>=12å°æ™‚)æ’åœ¨å‰é¢ï¼ŒæŒ‰æ™‚æ•¸é™åº
      teachersWithHours.sort((a, b) => {
        const aAchieved = a.hours >= 12;
        const bAchieved = b.hours >= 12;
        if (aAchieved && !bAchieved) return -1;
        if (!aAchieved && bAchieved) return 1;
        return b.hours - a.hours; // åŒç­‰ç´šå…§æŒ‰æ™‚æ•¸é™åº
      });

      // è¨ˆç®—é”æ¨™äººæ•¸ä¸¦æ›´æ–°æé†’
      const achievedCount = teachersWithHours.filter(t => t.hours >= 12).length;
      const alertElement = document.getElementById('targetAchievedAlert');
      if (achievedCount > 0) {
        document.getElementById('targetAchievedCount').textContent = achievedCount;
        alertElement.style.display = 'block';
      } else {
        alertElement.style.display = 'none';
      }

      // æ±ºå®šé¡¯ç¤ºçš„å¸«è³‡æ•¸é‡
      const displayLimit = 4;
      const shouldShowMore = teachersWithHours.length > displayLimit && teacherSearchQuery === '';
      const displayTeachers = (shouldShowMore && !showAllTeachers)
        ? teachersWithHours.slice(0, displayLimit)
        : teachersWithHours;

      // é¡¯ç¤º/éš±è—ã€Œé¡¯ç¤ºæ›´å¤šã€æŒ‰éˆ•
      if (shouldShowMore) {
        showMoreContainer.style.display = 'block';
        document.getElementById('showMoreText').textContent = showAllTeachers ? 'æ”¶åˆ' : 'é¡¯ç¤ºæ›´å¤š';
        document.getElementById('showMoreIcon').textContent = showAllTeachers ? 'â–²' : 'â–¼';
      } else {
        showMoreContainer.style.display = 'none';
      }

      // æ¸²æŸ“å¸«è³‡åˆ—è¡¨
      listContainer.innerHTML = displayTeachers.map(item => {
        const { teacher, hours, courses } = item;
        const percentage = Math.min((hours / 12) * 100, 100);

        let statusClass = 'bg-red-500';
        let statusText = 'æœªé”æ¨™';
        if (hours >= 12) {
          statusClass = 'bg-green-500';
          statusText = 'å·²é”æ¨™';
        } else if (hours >= 8) {
          statusClass = 'bg-yellow-500';
          statusText = 'æ¥è¿‘é”æ¨™';
        }

        const isSelected = selectedTeacherId === teacher.id;
        const selectedStyle = isSelected
          ? 'border-2 border-blue-500 bg-blue-50 shadow-lg'
          : 'border border-gray-200 hover:border-blue-300 hover:shadow-md';

        // æ ¹æ“šé¸æ“‡æƒ…å¢ƒé¡¯ç¤ºä¸åŒçš„æ™‚æ•¸æ¨™ç±¤
        const hoursLabel = selectedDate !== null
          ? `è©²æ—¥æ™‚æ•¸: ${hours.toFixed(1)} å°æ™‚`
          : `ç¸½æ™‚æ•¸: ${hours.toFixed(1)} å°æ™‚`;

        // ç”¢ç”Ÿèª²ç¨‹æ­·å²åˆ—è¡¨ HTML
        const courseListId = `courseList_${teacher.id}`;
        const sortedCourses = [...courses].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
        const courseListHtml = sortedCourses.length > 0 ? sortedCourses.map(c => {
          const isMainTeacher = Number(c.teacherId) === Number(teacher.id);
          const roleLabel = isMainTeacher ? 'ä¸»è¬›' : 'åŠ©æ•™';
          const roleColor = isMainTeacher ? 'background:#dbeafe;color:#1e40af;' : 'background:#fef3c7;color:#92400e;';
          return `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#f9fafb;border-radius:8px;margin-bottom:4px;">
            <div style="flex:1;min-width:0;">
              <span style="font-size:13px;font-weight:500;color:#1f2937;">${c.name || 'æœªå‘½åèª²ç¨‹'}</span>
              <span style="font-size:11px;color:#6b7280;margin-left:8px;">${c.date || ''} ${c.time || ''}</span>
            </div>
            <span style="font-size:11px;font-weight:600;padding:2px 8px;border-radius:9999px;white-space:nowrap;${roleColor}">${roleLabel}</span>
          </div>`;
        }).join('') : '<p style="text-align:center;color:#9ca3af;font-size:13px;padding:8px 0;">ç„¡èª²ç¨‹è¨˜éŒ„</p>';

        return `
          <div class="${selectedStyle} rounded-xl p-4 transition-all duration-300">
            <div onclick="selectTeacher(${teacher.id})" class="cursor-pointer">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-3">
                  <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold">
                    ${(teacher.name || '?')[0]}
                  </div>
                  <div>
                    <h4 class="font-semibold text-gray-900">${teacher.name}</h4>
                    <p class="text-xs text-gray-500">${courses.length} å ‚èª²</p>
                  </div>
                </div>
                <div class="text-right">
                  <p class="text-sm font-bold text-gray-900">${hoursLabel}</p>
                  <span class="text-xs ${statusClass} text-white px-2 py-1 rounded-full">${statusText}</span>
                </div>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3">
                <div class="${statusClass} h-3 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
              </div>
              ${isSelected ? '<p class="text-xs text-blue-600 font-semibold mt-2 text-center">~ å·²é¸æ“‡</p>' : ''}
            </div>
            <div style="margin-top:8px;">
              <button onclick="event.stopPropagation(); toggleCourseList('${courseListId}')"
                style="width:100%;background:none;border:none;cursor:pointer;padding:6px 0;font-size:12px;color:#6b7280;display:flex;align-items:center;justify-content:center;gap:4px;transition:color 0.2s;"
                onmouseover="this.style.color='#374151'" onmouseout="this.style.color='#6b7280'">
                <i class="ph ph-clock-counter-clockwise" style="font-size:14px;"></i>
                <span>å”åŠ©èª²ç¨‹è¨˜éŒ„</span>
                <i class="ph ph-caret-down" id="${courseListId}_icon" style="font-size:12px;transition:transform 0.2s;"></i>
              </button>
              <div id="${courseListId}" style="display:none;max-height:200px;overflow-y:auto;margin-top:4px;padding:4px 0;">
                ${courseListHtml}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleCourseList(listId) {
      const list = document.getElementById(listId);
      const icon = document.getElementById(listId + '_icon');
      if (!list) return;
      const isVisible = list.style.display !== 'none';
      list.style.display = isVisible ? 'none' : 'block';
      if (icon) icon.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
    }

    function filterTeachers() {
      teacherSearchQuery = document.getElementById('teacherSearchInput').value;
      showAllTeachers = false; // é‡ç½®å±•é–‹ç‹€æ…‹
      renderTeacherHoursAnalysis();
    }

    function toggleShowAllTeachers() {
      showAllTeachers = !showAllTeachers;
      renderTeacherHoursAnalysis();
    }

    // ==================== èª²ç¨‹é¡å‹åˆ†ä½ˆåœ– ====================
    async function renderCourseTypeChart() {
      // å»¶é²åŠ è¼‰ Chart.js
      try {
        await window.loadChartJS();
      } catch (error) {
        console.error('ç„¡æ³•åŠ è¼‰ Chart.js:', error);
        return;
      }

      // æ ¹æ“šé¸æ“‡çš„å¸«è³‡å’Œæ—¥æœŸéæ¿¾èª²ç¨‹
      let filteredCourses = courseAssignments;

      if (selectedTeacherId !== null) {
        filteredCourses = filteredCourses.filter(c => c.teacherId === selectedTeacherId);
      }

      if (selectedDate !== null) {
        filteredCourses = filteredCourses.filter(c => c.date === selectedDate);
      }

      const typeCount = {};
      filteredCourses.forEach(c => {
        typeCount[c.type] = (typeCount[c.type] || 0) + 1;
      });

      const typeCtx = document.getElementById('courseTypeChart').getContext('2d');
      if (courseTypeChart) courseTypeChart.destroy();

      courseTypeChart = new Chart(typeCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(typeCount),
          datasets: [{
            data: Object.values(typeCount),
            backgroundColor: ['#007aff', '#34c759', '#ff9500', '#ff3b30', '#5856d6'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: { size: 14 },
                padding: 15
              }
            }
          }
        }
      });
    }

    // ==================== å¸«è³‡é¸æ“‡åŠŸèƒ½ ====================
    function selectTeacher(teacherId) {
      // Toggle åŠŸèƒ½ï¼šå¦‚æœé»é¸å·²é¸æ“‡çš„å¸«è³‡ï¼Œå‰‡å–æ¶ˆé¸æ“‡
      if (selectedTeacherId === teacherId) {
        clearTeacherSelection();
        return;
      }

      // åˆ‡æ›åˆ°æ–°å¸«è³‡
      selectedTeacherId = teacherId;
      const teacher = teachers.find(t => t.id === teacherId);

      // é¡¯ç¤ºé¸æ“‡çš„å¸«è³‡æ©«å¹…
      const banner = document.getElementById('selectedTeacherBanner');
      const nameElement = document.getElementById('selectedTeacherName');
      if (teacher) {
        nameElement.textContent = teacher.name;
        banner.style.display = 'block';
      }

      // æ›´æ–°æ‰€æœ‰ç›¸é—œæ•¸æ“š
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
    }

    function clearTeacherSelection() {
      selectedTeacherId = null;

      // éš±è—é¸æ“‡çš„å¸«è³‡æ©«å¹…
      const banner = document.getElementById('selectedTeacherBanner');
      banner.style.display = 'none';

      // æ›´æ–°æ‰€æœ‰ç›¸é—œæ•¸æ“š
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
    }

    // ==================== æ—¥æœŸé¸æ“‡åŠŸèƒ½ ====================
    function selectDate(dateStr) {
      // Toggle åŠŸèƒ½ï¼šå¦‚æœé»é¸å·²é¸æ“‡çš„æ—¥æœŸï¼Œå‰‡å–æ¶ˆé¸æ“‡
      if (selectedDate === dateStr) {
        clearDateSelection();
        return;
      }

      // åˆ‡æ›åˆ°æ–°æ—¥æœŸ
      selectedDate = dateStr;

      // é¡¯ç¤ºé¸æ“‡çš„æ—¥æœŸæ©«å¹…
      const banner = document.getElementById('selectedDateBanner');
      const textElement = document.getElementById('selectedDateText');

      const date = new Date(dateStr + 'T00:00:00');
      const formattedDate = date.toLocaleDateString('zh-TW', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      });

      textElement.textContent = formattedDate;
      banner.style.display = 'block';

      // æ›´æ–°æ‰€æœ‰ç›¸é—œæ•¸æ“š
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
    }

    function clearDateSelection() {
      selectedDate = null;

      // éš±è—é¸æ“‡çš„æ—¥æœŸæ©«å¹…
      const banner = document.getElementById('selectedDateBanner');
      banner.style.display = 'none';

      // æ›´æ–°æ‰€æœ‰ç›¸é—œæ•¸æ“š
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
    }

    // ==================== å¸«è³‡æ™‚æ•¸åˆ†æé¡¯ç¤º/éš±è— ====================
    function toggleTeacherHoursAnalysis() {
      const analysisContent = document.getElementById('teacherHoursAnalysis');
      const toggleIcon = document.getElementById('toggleAnalysisIcon');
      const toggleText = document.getElementById('toggleAnalysisText');

      const isVisible = analysisContent.style.display !== 'none';

      if (isVisible) {
        analysisContent.style.display = 'none';
        toggleIcon.textContent = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
        toggleText.textContent = 'é¡¯ç¤º';
        localStorage.setItem('teacherHoursAnalysisVisible', 'false');
      } else {
        analysisContent.style.display = 'block';
        toggleIcon.textContent = 'ğŸ‘ï¸';
        toggleText.textContent = 'éš±è—';
        localStorage.setItem('teacherHoursAnalysisVisible', 'true');
      }
    }

    function loadTeacherHoursAnalysisVisibility() {
      const isVisible = localStorage.getItem('teacherHoursAnalysisVisible');

      if (isVisible === 'false') {
        const analysisContent = document.getElementById('teacherHoursAnalysis');
        const toggleIcon = document.getElementById('toggleAnalysisIcon');
        const toggleText = document.getElementById('toggleAnalysisText');

        analysisContent.style.display = 'none';
        toggleIcon.textContent = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
        toggleText.textContent = 'é¡¯ç¤º';
      }
    }

    // ==================== ä»Šæ—¥èª²ç¨‹ç¸½è¦½ ====================
    // è¼”åŠ©å‡½æ•¸ï¼šæ›´æ–°èª²ç¨‹é¡¯ç¤ºï¼ˆç”¨æ–¼é–å®šç‹€æ…‹è®ŠåŒ–å¾Œåˆ·æ–°ï¼‰
    function updateCoursesDisplay() {
      renderTodayCourses();
    }

    async function renderTodayCourses() {
      // ğŸ”’ ç²å–æ‰€æœ‰ç·¨è¼¯é–å®šç‹€æ…‹
      let courseLocks = {};
      try {
        const locksResult = await editLockManager.getAllLocks('courseAssignments');
        if (locksResult.ok && locksResult.locks) {
          locksResult.locks.forEach(lock => {
            courseLocks[lock.recordId] = lock;
          });
        }
      } catch (error) {
        console.warn('ç„¡æ³•ç²å–é–å®šç‹€æ…‹:', error);
      }

      let titleText;
      let displayCourses;

      // æ ¹æ“šé¸æ“‡ç‹€æ³æ±ºå®šé¡¯ç¤ºæ¨¡å¼
      if (selectedTeacherId !== null && selectedDate === null) {
        // æƒ…æ³1ï¼šé¸æ“‡äº†è€å¸«ä½†æ²’é¸æ—¥æœŸ â†’ é¡¯ç¤ºè©²è€å¸«çš„æ‰€æœ‰èª²ç¨‹
        const teacher = teachers.find(t => t.id === selectedTeacherId);
        titleText = `${teacher ? teacher.name : 'æœªçŸ¥å¸«è³‡'} çš„æ‰€æœ‰èª²ç¨‹`;
        displayCourses = courseAssignments.filter(c => c.teacherId === selectedTeacherId);
      } else if (selectedDate !== null) {
        // æƒ…æ³2ï¼šé¸æ“‡äº†æ—¥æœŸï¼ˆå¯èƒ½åŒæ™‚é¸æ“‡äº†è€å¸«ï¼‰
        const date = new Date(selectedDate + 'T00:00:00');
        const dateText = date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

        if (selectedTeacherId !== null) {
          const teacher = teachers.find(t => t.id === selectedTeacherId);
          titleText = `${dateText} - ${teacher ? teacher.name : 'æœªçŸ¥å¸«è³‡'} çš„èª²ç¨‹`;
          displayCourses = courseAssignments.filter(c => c.date === selectedDate && c.teacherId === selectedTeacherId);
        } else {
          titleText = `${dateText} èª²ç¨‹ç¸½è¦½`;
          displayCourses = courseAssignments.filter(c => c.date === selectedDate);
        }
      } else {
        // æƒ…æ³3ï¼šéƒ½æ²’é¸æ“‡ â†’ é¡¯ç¤ºä»Šå¤©çš„èª²ç¨‹
        const todayDate = getLocalDateString(new Date());
        titleText = 'ä»Šæ—¥èª²ç¨‹ç¸½è¦½';
        displayCourses = courseAssignments.filter(c => c.date === todayDate);
      }

      document.getElementById('courseOverviewTitle').textContent = titleText;

      const container = document.getElementById('todayCoursesContainer');

      if (displayCourses.length === 0) {
        let emptyMessage = 'ä»Šå¤©æ²’æœ‰æ’èª²';
        if (selectedTeacherId !== null && selectedDate === null) {
          emptyMessage = 'è©²å¸«è³‡å°šæœªæœ‰æ’èª²ç´€éŒ„';
        } else if (selectedDate !== null) {
          emptyMessage = 'è©²æ—¥æœŸæ²’æœ‰æ’èª²';
        }

        container.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-2">âœ¨</div>
            <p>${emptyMessage}</p>
          </div>
        `;
        return;
      }

      // æ’åºèª²ç¨‹ï¼šå…ˆæŒ‰æ—¥æœŸï¼Œå†æŒ‰æ™‚é–“
      const sortedCourses = displayCourses.sort((a, b) => {
        if (a.date !== b.date) {
          return a.date.localeCompare(b.date);
        }
        return a.time.localeCompare(b.time);
      });

      // å¦‚æœæ˜¯é¡¯ç¤ºæŸå€‹è€å¸«çš„æ‰€æœ‰èª²ç¨‹ï¼ŒæŒ‰æ—¥æœŸåˆ†çµ„
      if (selectedTeacherId !== null && selectedDate === null) {
        const groupedByDate = {};
        sortedCourses.forEach(c => {
          if (!groupedByDate[c.date]) {
            groupedByDate[c.date] = [];
          }
          groupedByDate[c.date].push(c);
        });

        container.innerHTML = Object.entries(groupedByDate).map(([date, courses]) => {
          const dateObj = new Date(date + 'T00:00:00');
          const dateText = dateObj.toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'long' });

          return `
            <div class="bg-white rounded-xl p-4 border border-gray-200">
              <div class="flex items-center justify-between mb-3 pb-3 border-b border-gray-200">
                <h4 class="font-semibold text-gray-800"><i class="ph ph-calendar"></i> ${dateText}</h4>
                <span class="text-xs text-gray-500">${courses.length} å ‚èª²</span>
              </div>
              <div class="space-y-2">
                ${courses.map(c => {
                  const statusColors = {
                    'ä¸Šç­': 'bg-blue-50 text-blue-700 border-blue-200',
                    'ä¼‘å‡': 'bg-green-50 text-green-700 border-green-200',
                    'å‡ºå·®': 'bg-orange-50 text-orange-700 border-orange-200'
                  };
                  const statusClass = statusColors[c.status] || statusColors['ä¸Šç­'];

                  // ğŸ”’ æª¢æŸ¥é–å®šç‹€æ…‹
                  const lock = courseLocks[c.id];
                  const isLocked = lock && lock.userName;
                  const lockBadge = isLocked ? `<span class="px-2 py-0.5 bg-red-50 text-red-700 rounded border border-red-200"><i class="ph ph-lock"></i> ${lock.userName} ç·¨è¼¯ä¸­</span>` : '';

                  return `
                    <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100 transition-colors border border-gray-200 ${isLocked ? 'border-red-300' : ''}" onclick="viewEvent(${c.id})">
                      <div class="flex justify-between items-start">
                        <div class="flex-1">
                          <p class="font-medium text-gray-800">${c.name}</p>
                          <div class="flex items-center flex-wrap gap-2 text-xs text-gray-600 mt-2">
                            <span>ğŸ• ${c.time}</span>
                            <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded border border-blue-200">${c.type}</span>
                            <span class="px-2 py-0.5 ${statusClass} rounded border">${c.status || 'ä¸Šç­'}</span>
                            ${lockBadge}
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }).join('');
      } else {
        // æŒ‰å¸«è³‡åˆ†çµ„ï¼ˆåŸæœ‰é‚è¼¯ï¼‰
        const grouped = {};
        sortedCourses.forEach(c => {
          if (!grouped[c.teacherId]) {
            grouped[c.teacherId] = [];
          }
          grouped[c.teacherId].push(c);
        });

        container.innerHTML = Object.entries(grouped).map(([teacherId, courses]) => {
          const teacher = teachers.find(t => t.id === Number(teacherId));
          if (!teacher) return '';

          return `
            <div class="bg-white rounded-xl p-4 border border-gray-200">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-3">
                  <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 p-0.5">
                    <div class="w-full h-full rounded-full bg-white flex items-center justify-center">
                      ${teacher.photo ?
                        `<img src="${teacher.photo}" class="w-full h-full object-cover rounded-full">` :
                        `<span class="text-lg font-bold text-gray-600">${(teacher.name || '?')[0]}</span>`
                      }
                    </div>
                  </div>
                  <div>
                    <h4 class="font-semibold text-gray-800">${teacher.name}</h4>
                    <p class="text-xs text-gray-500">${courses.length} å ‚èª²</p>
                  </div>
                </div>
              </div>
              <div class="space-y-2">
                ${courses.map(c => {
                  const statusColors = {
                    'ä¸Šç­': 'bg-blue-50 text-blue-700 border-blue-200',
                    'ä¼‘å‡': 'bg-green-50 text-green-700 border-green-200',
                    'å‡ºå·®': 'bg-orange-50 text-orange-700 border-orange-200'
                  };
                  const statusClass = statusColors[c.status] || statusColors['ä¸Šç­'];

                  // ğŸ”’ æª¢æŸ¥é–å®šç‹€æ…‹
                  const lock = courseLocks[c.id];
                  const isLocked = lock && lock.userName;
                  const lockBadge = isLocked ? `<span class="px-2 py-0.5 bg-red-50 text-red-700 rounded border border-red-200"><i class="ph ph-lock"></i> ${lock.userName} ç·¨è¼¯ä¸­</span>` : '';

                  return `
                    <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100 transition-colors border border-gray-200 ${isLocked ? 'border-red-300' : ''}" onclick="viewEvent(${c.id})">
                      <div class="flex justify-between items-start">
                        <div class="flex-1">
                          <p class="font-medium text-gray-800">${c.name}</p>
                          <div class="flex items-center flex-wrap gap-2 text-xs text-gray-600 mt-2">
                            <span>ğŸ• ${c.time}</span>
                            <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded border border-blue-200">${c.type}</span>
                            <span class="px-2 py-0.5 ${statusClass} rounded border">${c.status || 'ä¸Šç­'}</span>
                            ${lockBadge}
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }).join('');
      }
    }

    // ==================== è¡Œäº‹æ›† ====================
    function setViewMode(mode) {
      viewMode = mode;
      const monthBtn = document.getElementById('monthViewBtn');
      const weekBtn = document.getElementById('weekViewBtn');

      if (mode === 'month') {
        monthBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-white text-gray-900';
        monthBtn.style.cssText = 'box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);';
        weekBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold text-gray-600';
        weekBtn.style.cssText = 'background: transparent;';
        document.getElementById('prevLabel').textContent = 'ä¸Šå€‹æœˆ';
        document.getElementById('nextLabel').textContent = 'ä¸‹å€‹æœˆ';
      } else {
        weekBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-white text-gray-900';
        weekBtn.style.cssText = 'box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);';
        monthBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold text-gray-600';
        monthBtn.style.cssText = 'background: transparent;';
        document.getElementById('prevLabel').textContent = 'ä¸Šé€±';
        document.getElementById('nextLabel').textContent = 'ä¸‹é€±';
      }

      renderCalendar();
    }

    function previousPeriod() {
      if (viewMode === 'month') {
        currentDate.setMonth(currentDate.getMonth() - 1);
      } else {
        currentDate.setDate(currentDate.getDate() - 7);
      }
      renderCalendar();
      // åŒæ­¥æ—¥æœŸç¯„åœåˆ°æ–°çš„æœˆä»½
      if (viewMode === 'month') {
        syncDateRangeToCurrentMonth();
      }
    }

    function nextPeriod() {
      if (viewMode === 'month') {
        currentDate.setMonth(currentDate.getMonth() + 1);
      } else {
        currentDate.setDate(currentDate.getDate() + 7);
      }
      renderCalendar();
      // åŒæ­¥æ—¥æœŸç¯„åœåˆ°æ–°çš„æœˆä»½
      if (viewMode === 'month') {
        syncDateRangeToCurrentMonth();
      }
    }

    function goToToday() {
      currentDate = new Date();
      renderCalendar();
      // åŒæ­¥æ—¥æœŸç¯„åœåˆ°ç•¶å‰æœˆä»½
      if (viewMode === 'month') {
        syncDateRangeToCurrentMonth();
      }
    }

    function renderCalendar() {
      if (viewMode === 'month') {
        renderMonthView();
      } else {
        renderWeekView();
      }
      renderMobileCalendar();
    }

    function renderMonthView() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const monthNames = ['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];

      document.getElementById('currentMonth').textContent = `${year}å¹´ ${monthNames[month]}`;

      const firstDay = new Date(year, month, 1);
      const start = new Date(firstDay);
      start.setDate(start.getDate() - firstDay.getDay());

      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      const todayStr = getLocalDateString(new Date());

      for (let w = 0; w < 6; w++) {
        for (let d = 0; d < 7; d++) {
          const cellDate = new Date(start);
          cellDate.setDate(start.getDate() + (w * 7) + d);

          const isCurrentMonth = (cellDate.getMonth() === month);
          const dateKey = getLocalDateString(cellDate);
          const isToday = (dateKey === todayStr);

          const dayEvents = courseAssignments.filter(c => c.date === dateKey);

          const isSelectedDate = (dateKey === selectedDate);

          const cell = document.createElement('div');
          cell.className = `calendar-day p-2 ${
            isCurrentMonth ? 'bg-white' : 'bg-gray-50'
          } ${isToday ? 'today-highlight' : ''} ${isSelectedDate ? 'ring-2 ring-pink-500 ring-inset' : ''}`;

          cell.innerHTML = `
            <div class="flex justify-between items-start mb-1">
              <span onclick="selectDate('${dateKey}')"
                    class="text-base font-semibold cursor-pointer hover:bg-blue-100 px-2 py-1 rounded transition-colors ${
                isCurrentMonth ? (isToday ? 'text-blue-600' : 'text-gray-800') : 'text-gray-400'
              } ${isSelectedDate ? 'bg-pink-100 text-pink-700' : ''}">
                ${cellDate.getDate()}
              </span>
            </div>
            <div class="space-y-1 overflow-y-auto max-h-20">
              ${dayEvents.map(e => {
                const teacher = teachers.find(t => t.id === e.teacherId);
                const teacherName = teacher ? teacher.name : 'æœªçŸ¥';
                return `
                  <div class="event-item bg-blue-500 text-white rounded cursor-pointer hover:bg-blue-600"
                       onclick="viewEvent(${e.id}); event.stopPropagation();">
                    <div class="font-medium truncate">${teacherName}</div>
                    <div class="text-[10px]" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3;">${e.time} ${e.name}</div>
                  </div>
                `;
              }).join('')}
            </div>
          `;

          grid.appendChild(cell);
        }
      }
    }

    function renderWeekView() {
      const startOfWeek = new Date(currentDate);
      startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);

      const monthNames = ['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
      document.getElementById('currentMonth').textContent =
        `${startOfWeek.getFullYear()}å¹´ ${monthNames[startOfWeek.getMonth()]} ${startOfWeek.getDate()}æ—¥ - ${endOfWeek.getDate()}æ—¥`;

      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      const dayNames = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
      const todayStr = getLocalDateString(new Date());

      for (let i = 0; i < 7; i++) {
        const cellDate = new Date(startOfWeek);
        cellDate.setDate(startOfWeek.getDate() + i);

        const dateKey = getLocalDateString(cellDate);
        const isToday = (dateKey === todayStr);
        const isSelectedDate = (dateKey === selectedDate);
        const dayEvents = courseAssignments.filter(c => c.date === dateKey);

        const cell = document.createElement('div');
        cell.className = `calendar-day p-4 bg-white ${isToday ? 'today-highlight' : ''} ${isSelectedDate ? 'ring-2 ring-pink-500 ring-inset' : ''}`;

        cell.innerHTML = `
          <div onclick="selectDate('${dateKey}')" class="text-center mb-4 pb-3 border-b border-gray-200 cursor-pointer hover:bg-blue-50 rounded-lg transition-colors ${isSelectedDate ? 'bg-pink-50' : ''}">
            <div class="text-sm font-semibold ${isToday ? 'text-blue-600' : (isSelectedDate ? 'text-pink-600' : 'text-gray-600')}">${dayNames[i]}</div>
            <div class="text-2xl font-bold ${isToday ? 'text-blue-600' : (isSelectedDate ? 'text-pink-600' : 'text-gray-800')}">
              ${cellDate.getDate()}
            </div>
          </div>
          <div class="space-y-2">
            ${dayEvents.map(e => {
              const teacher = teachers.find(t => t.id === e.teacherId);
              const teacherName = teacher ? teacher.name : 'æœªçŸ¥';
              return `
                <div class="event-item bg-blue-500 text-white p-3 rounded-xl cursor-pointer hover:bg-blue-600"
                     onclick="viewEvent(${e.id}); event.stopPropagation();">
                  <div class="font-semibold">${teacherName}</div>
                  <div class="text-xs mt-1"><i class="ph ph-clock"></i> ${e.time}</div>
                  <div class="text-xs" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4;">${e.name}</div>
                </div>
              `;
            }).join('')}
          </div>
        `;

        grid.appendChild(cell);
      }
    }

    function renderMobileCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const todayStr = getLocalDateString(new Date());

      const container = document.getElementById('mobileEventsList');
      let html = '';

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateKey = getLocalDateString(date);
        const dayEvents = courseAssignments.filter(c => c.date === dateKey);
        const isToday = dateKey === todayStr;

        if (dayEvents.length > 0 || isToday) {
          const dayNames = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
          html += `
            <div class="border border-gray-200 rounded-lg p-3 ${isToday ? 'bg-blue-50 border-blue-500' : 'bg-white'}">
              <div class="flex items-center justify-between mb-2">
                <span class="font-bold text-gray-800">${month + 1}æœˆ${day}æ—¥ (${dayNames[date.getDay()]})</span>
                ${isToday ? '<span class="text-xs bg-blue-500 text-white px-2 py-1 rounded">ä»Šå¤©</span>' : ''}
              </div>
              ${dayEvents.length === 0 ?
                '<p class="text-sm text-gray-500">ç„¡èª²ç¨‹</p>' :
                dayEvents.map(e => {
                  const teacher = teachers.find(t => t.id === e.teacherId);
                  const teacherName = teacher ? teacher.name : 'æœªçŸ¥';
                  return `
                    <div class="mt-2 p-2 bg-blue-500 text-white rounded-lg cursor-pointer hover:bg-blue-600" onclick="viewEvent(${e.id})">
                      <div class="font-semibold text-sm" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4;">${teacherName} - ${e.name}</div>
                      <div class="text-xs mt-1"><i class="ph ph-clock"></i> ${e.time} | <i class="ph ph-books"></i> ${e.type}</div>
                    </div>
                  `;
                }).join('')
              }
            </div>
          `;
        }
      }

      if (!html) {
        html = '<p class="text-center text-gray-500 py-8">æœ¬æœˆç„¡èª²ç¨‹</p>';
      }

      container.innerHTML = html;
    }

    // ==================== Modal ç®¡ç† ====================
    function openAddCourseModal() {
      document.getElementById('courseDate').value = getLocalDateString(new Date());

      // è¼‰å…¥æ™ºæ…§æ´¾èª²çš„èª²ç¨‹æ¸…å–®
      loadMaritimeCoursesToDatalist();

      document.getElementById('addCourseModal').classList.remove('hidden');
    }

    // è¼‰å…¥æ™ºæ…§æ´¾èª²çš„èª²ç¨‹åç¨±åˆ°ä¸‹æ‹‰é¸å–®
    function loadMaritimeCoursesToDatalist() {
      try {
        const maritimeCourses = JSON.parse(localStorage.getItem('maritimeCourses')) || [];
        const selectElement = document.getElementById('courseName');

        // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™ç¬¬ä¸€å€‹ã€Œè«‹é¸æ“‡èª²ç¨‹ã€ï¼‰
        selectElement.innerHTML = '<option value="">è«‹é¸æ“‡èª²ç¨‹</option>';

        // å–å¾—ä¸é‡è¤‡çš„èª²ç¨‹åç¨±
        const uniqueCourseNames = [...new Set(maritimeCourses.map(c => c.name))];

        // æ’åºèª²ç¨‹åç¨±
        uniqueCourseNames.sort();

        // åŠ å…¥åˆ° select
        uniqueCourseNames.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          selectElement.appendChild(option);
        });
      } catch (error) {
        console.warn('ç„¡æ³•è¼‰å…¥æ™ºæ…§æ´¾èª²èª²ç¨‹æ¸…å–®:', error);
      }
    }

    function closeAddCourseModal() {
      document.getElementById('addCourseModal').classList.add('hidden');
      document.getElementById('courseForm').reset();
    }

    async function viewEvent(courseId) {
      const course = courseAssignments.find(c => c.id === courseId);
      if (!course) return;

      // ğŸ”’ å˜—è©¦å–å¾—ç·¨è¼¯é–å®š
      const lockResult = await editLockManager.acquireLock('courseAssignments', courseId);

      if (lockResult.locked && !lockResult.ownLock) {
        // å·²è¢«å…¶ä»–äººé–å®š
        const lockedBy = lockResult.lockedBy || 'å…¶ä»–ä½¿ç”¨è€…';
        const lockedTime = lockResult.lockedAt ? new Date(lockResult.lockedAt).toLocaleTimeString('zh-TW') : '';

        if (confirm(`âš ï¸ æ­¤èª²ç¨‹æ­£è¢« ${lockedBy} ç·¨è¼¯ä¸­\né–å®šæ™‚é–“ï¼š${lockedTime}\n\næ˜¯å¦è¦ä»¥ã€Œå”¯è®€æ¨¡å¼ã€æŸ¥çœ‹ï¼Ÿ`)) {
          // ä»¥å”¯è®€æ¨¡å¼æŸ¥çœ‹ï¼Œä¿å­˜ courseId ç”¨æ–¼æŸ¥çœ‹å’Œåˆªé™¤
          editingCourseId = courseId;
          // æ¨™è¨˜ç‚ºå”¯è®€æ¨¡å¼
          window.isReadOnlyMode = true;
        } else {
          return; // å–æ¶ˆæŸ¥çœ‹
        }
      } else if (lockResult.locked && lockResult.ownLock) {
        // æˆåŠŸå–å¾—é–å®š
        // å·²é–å®šèª²ç¨‹
        editingCourseId = courseId;
        window.isReadOnlyMode = false;
      } else {
        // æœªèƒ½å–å¾—é–å®šï¼ˆå…¶ä»–éŒ¯èª¤ï¼‰
        editingCourseId = courseId;
        window.isReadOnlyMode = false;
      }

      // é¸æ“‡è©²èª²ç¨‹çš„æ—¥æœŸä¸¦æ›´æ–°èª²ç¨‹ç¸½è¦½
      selectDate(course.date);

      // åªåœ¨æ‰‹æ©Ÿç‰ˆï¼ˆè¢å¹•å¯¬åº¦ <= 768pxï¼‰æ‰æ»¾å‹•åˆ°èª²ç¨‹ç¸½è¦½å€åŸŸ
      if (window.innerWidth <= 768) {
        setTimeout(() => {
          const courseOverview = document.getElementById('courseOverviewTitle');
          if (courseOverview) {
            courseOverview.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }, 100);
      }
      const teacher = teachers.find(t => t.id === course.teacherId);

      // é¡¯ç¤ºæŸ¥çœ‹æ¨¡å¼
      const modalTitle = document.getElementById('modalTitle');
      modalTitle.innerHTML = '<i class="ph ph-calendar"></i> èª²ç¨‹è©³æƒ…';
      modalTitle.style.cssText = 'font-size: 28px; font-weight: 600; letter-spacing: -0.015em;';
      document.getElementById('viewMode').style.display = 'block';
      document.getElementById('editCourseForm').style.display = 'none';
      document.getElementById('viewModeButtons').style.display = 'flex';
      document.getElementById('editModeButtons').style.display = 'none';

      // è¼‰å…¥ç¤¾äº¤è³‡æ–™
      const courseComments = loadArray('comments').filter(c => c.courseId === courseId);
      const activityLogs = loadArray('activityLog').filter(a => a.courseId === courseId);
      const currentUserId = 'user_1'; // æ¨¡æ“¬ç•¶å‰ç”¨æˆ¶ ID
      const currentUserName = 'ç®¡ç†å“¡'; // æ¨¡æ“¬ç•¶å‰ç”¨æˆ¶åç¨±

      // å–å¾—åŠ©æ•™è³‡è¨Š
      const ta = course.taId ? teachers.find(t => t.id === course.taId) : null;

      document.getElementById('viewMode').innerHTML = `
        <!-- TimeTree + Apple é¢¨æ ¼çš„èª²ç¨‹è©³æƒ… -->

        <!-- èª²ç¨‹åŸºæœ¬è³‡è¨Š -->
        <div class="info-card space-y-4">
          <div>
            <div class="text-xs font-medium" style="color: var(--apple-gray); margin-bottom: 4px;">æˆèª²æ•™å¸«</div>
            <div class="flex items-center gap-2">
              <span class="text-2xl"><i class="ph ph-chalkboard-teacher"></i></span>
              <span class="text-lg font-semibold" style="color: var(--apple-gray-dark);">${teacher ? teacher.name : 'æœªçŸ¥'}</span>
            </div>
          </div>

          ${course.taId && ta ? `
          <div>
            <div class="text-xs font-medium" style="color: var(--apple-gray); margin-bottom: 4px;">åŠ©æ•™</div>
            <div class="flex items-center gap-2">
              <span class="text-2xl"><i class="ph ph-user"></i></span>
              <span class="text-lg font-semibold" style="color: var(--apple-gray-dark);">${ta.name}</span>
            </div>
          </div>
          ` : ''}

          <div>
            <div class="text-xs font-medium" style="color: var(--apple-gray); margin-bottom: 4px;">èª²ç¨‹åç¨±</div>
            <div class="text-xl font-semibold" style="color: #1d1d1f;">${course.name}</div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs font-medium" style="color: var(--apple-gray); margin-bottom: 4px;">æ—¥æœŸ</div>
              <div class="flex items-center gap-2">
                <span><i class="ph ph-calendar"></i></span>
                <span class="text-sm font-medium">${course.date}</span>
              </div>
            </div>
            <div>
              <div class="text-xs font-medium" style="color: var(--apple-gray); margin-bottom: 4px;">æ™‚é–“</div>
              <div class="flex items-center gap-2">
                <span><i class="ph ph-clock"></i></span>
                <span class="text-sm font-medium">${course.time}</span>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs font-medium" style="color: var(--apple-gray); margin-bottom: 4px;">é¡å‹</div>
              <div class="flex items-center gap-2">
                <span><i class="ph ph-books"></i></span>
                <span class="text-sm font-medium">${course.type}</span>
              </div>
            </div>
            <div>
              <div class="text-xs font-medium" style="color: var(--apple-gray); margin-bottom: 4px;">ç‹€æ…‹</div>
              <div class="flex items-center gap-2">
                <span><i class="ph ph-briefcase"></i></span>
                <span class="text-sm font-medium">${course.status || 'ä¸Šç­'}</span>
              </div>
            </div>
          </div>

          ${course.note ? `
          <div>
            <div class="text-xs font-medium" style="color: var(--apple-gray); margin-bottom: 4px;">å‚™è¨»</div>
            <div class="text-sm" style="color: var(--apple-gray-dark); display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5;">${course.note}</div>
            ${course.tags && course.tags.length > 0 ? `
              <div class="flex flex-wrap gap-2 mt-3">
                ${course.tags.map(tag => {
                  // åˆ¤æ–·æ¨™ç±¤é¡å‹ä¸¦çµ¦äºˆå°æ‡‰é¡è‰²
                  let tagClass = 'tag-default';
                  let tagIcon = 'icon-tag';
                  for (const [key, rule] of Object.entries(TAG_RULES)) {
                    if (rule.keywords.includes(tag)) {
                      tagClass = rule.class;
                      tagIcon = rule.icon;
                      break;
                    }
                  }
                  return `<span class="auto-tag ${tagClass}" style="cursor: default;"><svg class="modal-icon-sm"><use href="#${tagIcon}"></use></svg><span>${tag}</span></span>`;
                }).join('')}
              </div>
            ` : ''}
          </div>
          ` : ''}
        </div>

        <!-- æé†’è¨­å®š -->
        <div class="feature-block feature-block-blue">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="text-2xl">ğŸ””</span>
              <div>
                <div class="text-sm font-semibold" style="color: var(--apple-gray-dark);">æé†’è¨­å®š</div>
                <div class="text-xs" style="color: var(--apple-gray);">${course.reminderTime || 'æœªè¨­å®šæé†’'}</div>
              </div>
            </div>
            <button onclick="setReminder()" class="action-btn" style="flex-shrink: 0;">
              ${course.reminderTime ? 'ä¿®æ”¹' : 'è¨­å®š'}
            </button>
          </div>
        </div>

        <!-- ç•™è¨€è¨è«–å€ -->
        <div>
          <div class="section-title">
            <span>ğŸ’¬</span>
            <span>è¨è«–å€</span>
          </div>

          <!-- ç•™è¨€åˆ—è¡¨ -->
          <div id="commentsList" class="space-y-2 mb-4 max-h-80 overflow-y-auto">
            ${courseComments.length > 0 ? courseComments.map(comment => `
              <div class="comment-card">
                <div class="flex items-start gap-3">
                  <div class="avatar">
                    ${comment.userName.charAt(0)}
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between mb-1">
                      <span class="text-sm font-semibold" style="color: var(--apple-gray-dark);">${comment.userName}</span>
                      <span class="text-xs" style="color: var(--apple-gray);">${formatTimestamp(comment.timestamp)}</span>
                    </div>
                    <p class="text-sm whitespace-pre-wrap" style="color: #1d1d1f; line-height: 1.5;">${comment.content}</p>
                  </div>
                </div>
              </div>
            `).join('') : `
              <div class="text-center py-8" style="color: var(--apple-gray);">
                <div class="text-3xl mb-2">ğŸ’¬</div>
                <div class="text-sm">å°šç„¡ç•™è¨€ï¼Œæˆç‚ºç¬¬ä¸€å€‹ç•™è¨€çš„äººï¼</div>
              </div>
            `}
          </div>

          <!-- æ–°å¢ç•™è¨€ -->
          <div class="flex gap-2">
            <textarea id="newCommentInput" rows="2" class="apple-input flex-1" placeholder="è¼¸å…¥ç•™è¨€..." style="resize: none;"></textarea>
            <button onclick="addComment()" class="apple-btn apple-btn-primary self-end" style="padding: 10px 16px; white-space: nowrap;">
              ç™¼é€
            </button>
          </div>
        </div>

        <div class="divider"></div>

        <!-- æ“ä½œæ­·å² -->
        <div>
          <div class="section-title">
            <span>ğŸ“œ</span>
            <span>æ“ä½œæ­·å²</span>
          </div>
          <div class="space-y-1 max-h-48 overflow-y-auto">
            ${activityLogs.length > 0 ? activityLogs.slice().reverse().map(log => `
              <div class="timeline-item">
                <div class="timeline-dot"></div>
                <span class="font-medium">${log.userName}</span>
                <span>${log.action}</span>
                <span style="color: var(--apple-gray); margin-left: auto;">${formatTimestamp(log.timestamp)}</span>
              </div>
            `).join('') : `
              <div class="text-center py-4" style="color: var(--apple-gray); font-size: 13px;">
                å°šç„¡æ“ä½œè¨˜éŒ„
              </div>
            `}
          </div>
        </div>
      `;

      // åˆå§‹åŒ–ç¤¾äº¤åŠŸèƒ½
      initSocialFeatures(courseId, currentUserId, currentUserName);

      document.getElementById('viewEventModal').classList.remove('hidden');
    }

    // é¡¯ç¤ºã€ŒåŠŸèƒ½é–‹ç™¼ä¸­ã€æ¨¡æ…‹è¦–çª—
    function showUnderDevelopmentModal(title, description) {
      // å‰µå»ºæ¨¡æ…‹è¦–çª—
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.3s ease;
      `;

      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 24px;
          padding: 48px 40px;
          max-width: 480px;
          width: 90%;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          text-align: center;
          animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        ">
          <div style="
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.3);
          ">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
          </div>
          <h3 style="
            font-size: 28px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
          ">${title}</h3>
          <p style="
            font-size: 17px;
            color: #6e6e73;
            margin-bottom: 8px;
            line-height: 1.5;
          ">${description}</p>
          <p style="
            font-size: 15px;
            color: #86868b;
            margin-bottom: 32px;
          ">æ­¤åŠŸèƒ½ç›®å‰å°šåœ¨é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼</p>
          <button onclick="this.closest('[style*=fixed]').remove()" style="
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            border: none;
            padding: 14px 48px;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 24px rgba(245, 158, 11, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(245, 158, 11, 0.3)'">
            æˆ‘çŸ¥é“äº†
          </button>
        </div>
      `;

      // æ·»åŠ å‹•ç•«æ¨£å¼ï¼ˆå¦‚æœé‚„æ²’æœ‰ï¼‰
      if (!document.getElementById('modal-animations-style')) {
        const style = document.createElement('style');
        style.id = 'modal-animations-style';
        style.textContent = `
          @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }
          @keyframes slideUp {
            from {
              opacity: 0;
              transform: translateY(30px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
        `;
        document.head.appendChild(style);
      }

      // é»æ“ŠèƒŒæ™¯é—œé–‰
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });

      document.body.appendChild(modal);
    }

    function enterEditMode() {
      const course = courseAssignments.find(c => c.id === editingCourseId);
      if (!course) return;

      // è¼‰å…¥å¸«è³‡åˆ—è¡¨åˆ°ç·¨è¼¯è¡¨å–®
      const editTeacherSelect = document.getElementById('editTeacherId');
      editTeacherSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¸«è³‡</option>';
      teachers.forEach(t => {
        editTeacherSelect.innerHTML += `<option value="${t.id}" ${t.id === course.teacherId ? 'selected' : ''}>${t.name}</option>`;
      });

      // è¼‰å…¥åŠ©æ•™åˆ—è¡¨åˆ°ç·¨è¼¯è¡¨å–®
      const editTaSelect = document.getElementById('editTaId');
      editTaSelect.innerHTML = '<option value="">è«‹é¸æ“‡åŠ©æ•™ï¼ˆé¸å¡«ï¼‰</option>';
      teachers.forEach(t => {
        editTaSelect.innerHTML += `<option value="${t.id}" ${t.id === course.taId ? 'selected' : ''}>${t.name}</option>`;
      });

      // å¡«å…¥èª²ç¨‹è³‡æ–™
      document.getElementById('editCourseName').value = course.name;
      document.getElementById('editCourseDate').value = course.date;
      document.getElementById('editCourseType').value = course.type;

      const [startTime, endTime] = course.time.split('-');
      document.getElementById('editStartTime').value = startTime;
      document.getElementById('editEndTime').value = endTime;

      document.getElementById('editCourseStatus').value = course.status || 'ä¸Šç­';
      document.getElementById('editCourseNote').value = course.note || '';

      // è¼‰å…¥å·²æœ‰çš„æ¨™ç±¤
      if (course.tags && course.tags.length > 0) {
        // å¾ç¾æœ‰æ¨™ç±¤æ¢å¾©
        currentTags = course.tags.map(tagText => {
          // æª¢æŸ¥æ¨™ç±¤é¡å‹
          for (const [key, rule] of Object.entries(TAG_RULES)) {
            if (rule.keywords.includes(tagText)) {
              return {
                text: tagText,
                class: rule.class,
                icon: rule.icon,
                type: key
              };
            }
          }
          // é è¨­æ¨™ç±¤
          return {
            text: tagText,
            class: 'tag-default',
            icon: 'ğŸ·ï¸',
            type: 'custom'
          };
        });
        renderTags();
      } else {
        // æ²’æœ‰æ¨™ç±¤æ™‚è‡ªå‹•ç”Ÿæˆ
        autoGenerateTags();
      }

      // åˆ‡æ›åˆ°ç·¨è¼¯æ¨¡å¼
      const modalTitle = document.getElementById('modalTitle');
      modalTitle.textContent = 'âœï¸ ç·¨è¼¯èª²ç¨‹';
      modalTitle.style.cssText = 'font-size: 28px; font-weight: 600; letter-spacing: -0.015em;';
      document.getElementById('viewMode').style.display = 'none';
      document.getElementById('editCourseForm').style.display = 'block';
      document.getElementById('viewModeButtons').style.display = 'none';
      document.getElementById('editModeButtons').style.display = 'flex';
    }

    function cancelEditMode() {
      // è¿”å›æŸ¥çœ‹æ¨¡å¼
      viewEvent(editingCourseId);
    }

    async function saveEditedCourse() {
      const teacherId = Number(document.getElementById('editTeacherId').value);
      if (!teacherId) {
        alert('è«‹é¸æ“‡å¸«è³‡ï¼');
        return;
      }

      const startTime = document.getElementById('editStartTime').value;
      const endTime = document.getElementById('editEndTime').value;
      const courseDate = document.getElementById('editCourseDate').value;

      // æ‰¾åˆ°è¦ç·¨è¼¯çš„èª²ç¨‹
      const courseIndex = courseAssignments.findIndex(c => c.id === editingCourseId);
      if (courseIndex === -1) return;

      const oldCourse = courseAssignments[courseIndex];

      // æª¢æŸ¥æ™‚é–“è¡çªï¼ˆæ’é™¤è‡ªå·±ï¼‰
      const newTime = `${startTime}-${endTime}`;
      const conflicts = checkConflictExcludingSelf(
        editingCourseId,
        teacherId,
        courseDate,
        newTime
      );

      if (conflicts.length > 0) {
        if (!confirm(`âš ï¸ è¡å ‚è­¦å‘Šï¼\n\n${conflicts.join('\n')}\n\næ˜¯å¦ä»è¦ç¹¼çºŒï¼Ÿ`)) {
          return;
        }
      }

      // æ›´æ–°èª²ç¨‹è³‡æ–™ï¼ˆåŒ…å«è‡ªå‹•ç”Ÿæˆçš„æ¨™ç±¤ï¼‰
      // å–å¾—è€å¸«è³‡è¨Š
      const teacher = teachers.find(t => t.id === teacherId);
      const teacherName = teacher ? teacher.name : 'æœªçŸ¥å¸«è³‡';

      // å–å¾—åŠ©æ•™è³‡è¨Šï¼ˆé¸å¡«ï¼‰
      const taIdValue = document.getElementById('editTaId').value;
      const taId = taIdValue ? Number(taIdValue) : null;
      const ta = taId ? teachers.find(t => t.id === taId) : null;
      const taName = ta ? ta.name : null;

      const newCourseName = document.getElementById('editCourseName').value;

      courseAssignments[courseIndex] = {
        ...oldCourse,
        teacherId: teacherId,
        teacherName: teacherName,
        taId: taId,
        taName: taName,
        name: newCourseName,
        date: courseDate,
        time: newTime,
        type: document.getElementById('editCourseType').value,
        status: document.getElementById('editCourseStatus').value,
        note: document.getElementById('editCourseNote').value.trim(),
        tags: getCurrentTags(),
        updatedAt: new Date().toISOString()
      };

      // ğŸ“ è‡ªå‹•å¡«å……è¬›æˆèª²ç¨‹ï¼ˆç·¨è¼¯æ¨¡å¼ï¼‰
      const courseName = newCourseName.trim();

      // ç‚ºä¸»è¬›å¸«è‡ªå‹•å¡«å……
      if (teacher && courseName) {
        // ç¢ºä¿ subjects é™£åˆ—å­˜åœ¨
        if (!teacher.subjects) {
          teacher.subjects = [];
        }

        // æª¢æŸ¥èª²ç¨‹åç¨±æ˜¯å¦å·²å­˜åœ¨æ–¼è¬›æˆèª²ç¨‹ä¸­ï¼ˆé¿å…é‡è¤‡ï¼‰
        if (!teacher.subjects.includes(courseName)) {
          teacher.subjects.push(courseName);
          console.log(`âœ“ å·²è‡ªå‹•å°‡ã€Œ${courseName}ã€åŠ å…¥ ${teacherName} çš„è¬›æˆèª²ç¨‹`);
        }
      }

      // ç‚ºåŠ©æ•™è‡ªå‹•å¡«å……
      if (ta && courseName) {
        // ç¢ºä¿ subjects é™£åˆ—å­˜åœ¨
        if (!ta.subjects) {
          ta.subjects = [];
        }

        // æª¢æŸ¥èª²ç¨‹åç¨±æ˜¯å¦å·²å­˜åœ¨æ–¼è¬›æˆèª²ç¨‹ä¸­ï¼ˆé¿å…é‡è¤‡ï¼‰
        if (!ta.subjects.includes(courseName)) {
          ta.subjects.push(courseName);
          console.log(`âœ“ å·²è‡ªå‹•å°‡ã€Œ${courseName}ã€åŠ å…¥ ${taName} çš„è¬›æˆèª²ç¨‹ï¼ˆåŠ©æ•™ï¼‰`);
        }
      }

      // åŒæ­¥æ›´æ–°è¡Œäº‹æ›†äº‹ä»¶
      const eventIndex = calendarEvents.findIndex(e => e.courseId === editingCourseId);
      if (eventIndex !== -1) {
        calendarEvents[eventIndex] = {
          ...calendarEvents[eventIndex],
          date: courseDate,
          title: `${courseAssignments[courseIndex].name} - ${teacherName}`,
          time: newTime,
          teacherId: teacherId,
          location: courseAssignments[courseIndex].type,
          color: getCourseTypeColor(courseAssignments[courseIndex].type)
        };
      }

      saveData();
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
      renderCalendar();

      // ğŸ”“ é—œé–‰å°è©±æ¡†ä¸¦é‡‹æ”¾é–å®š
      await closeViewEventModal();
      alert('âœ“ èª²ç¨‹å·²æ›´æ–°ï¼');
    }

    function checkConflictExcludingSelf(excludeId, teacherId, date, time) {
      const conflicts = [];
      const timeToMinutes = (t) => {
        const [h, m] = t.split(':').map(Number);
        return h * 60 + m;
      };

      const [newStart, newEnd] = time.split('-');
      const newStartMin = timeToMinutes(newStart);
      const newEndMin = timeToMinutes(newEnd);

      courseAssignments.forEach(c => {
        if (c.id !== excludeId && c.teacherId === teacherId && c.date === date) {
          const [start, end] = c.time.split('-');
          const startMin = timeToMinutes(start);
          const endMin = timeToMinutes(end);

          if (!(newEndMin <= startMin || newStartMin >= endMin)) {
            conflicts.push(`- ${c.name} (${c.time})`);
          }
        }
      });

      return conflicts;
    }

    async function closeViewEventModal() {
      // ğŸ”“ é‡‹æ”¾ç·¨è¼¯é–å®š
      if (editingCourseId && !window.isReadOnlyMode) {
        await editLockManager.releaseLock('courseAssignments', editingCourseId);
        // å·²é‡‹æ”¾èª²ç¨‹é–å®š
      }

      document.getElementById('viewEventModal').classList.add('hidden');
      editingCourseId = null;
      window.isReadOnlyMode = false;

      // æ›´æ–°èª²ç¨‹åˆ—è¡¨ä»¥åæ˜ é–å®šç‹€æ…‹è®ŠåŒ–
      updateCoursesDisplay();
    }

    // ==================== èª²ç¨‹ç®¡ç† ====================
    function handleAddCourse(e) {
      e.preventDefault();

      const teacherId = Number(document.getElementById('courseTeacherId').value);
      if (!teacherId) {
        alert('è«‹é¸æ“‡å¸«è³‡ï¼');
        return;
      }

      // å–å¾—è€å¸«è³‡è¨Š
      const teacher = teachers.find(t => t.id === teacherId);
      const teacherName = teacher ? teacher.name : 'æœªçŸ¥å¸«è³‡';

      // å–å¾—åŠ©æ•™è³‡è¨Šï¼ˆé¸å¡«ï¼‰
      const taIdValue = document.getElementById('courseTaId').value;
      const taId = taIdValue ? Number(taIdValue) : null;
      const ta = taId ? teachers.find(t => t.id === taId) : null;
      const taName = ta ? ta.name : null;

      const courseData = {
        id: Date.now(),
        teacherId: teacherId,
        teacherName: teacherName,
        taId: taId,
        taName: taName,
        name: document.getElementById('courseName').value,
        date: document.getElementById('courseDate').value,
        time: `${document.getElementById('startTime').value}-${document.getElementById('endTime').value}`,
        type: document.getElementById('courseType').value,
        status: document.getElementById('courseStatus').value,
        note: document.getElementById('courseNote').value.trim()
      };

      // è¡å ‚æª¢æŸ¥
      const conflicts = checkConflict(courseData);
      if (conflicts.length > 0) {
        if (!confirm(`âš ï¸ è¡å ‚è­¦å‘Šï¼\n\n${conflicts.join('\n')}\n\næ˜¯å¦ä»è¦ç¹¼çºŒï¼Ÿ`)) {
          return;
        }
      }

      courseAssignments.push(courseData);

      // ğŸ“ è‡ªå‹•å¡«å……è¬›æˆèª²ç¨‹
      const courseName = courseData.name.trim();

      // ç‚ºä¸»è¬›å¸«è‡ªå‹•å¡«å……
      if (teacher && courseName) {
        // ç¢ºä¿ subjects é™£åˆ—å­˜åœ¨
        if (!teacher.subjects) {
          teacher.subjects = [];
        }

        // æª¢æŸ¥èª²ç¨‹åç¨±æ˜¯å¦å·²å­˜åœ¨æ–¼è¬›æˆèª²ç¨‹ä¸­ï¼ˆé¿å…é‡è¤‡ï¼‰
        if (!teacher.subjects.includes(courseName)) {
          teacher.subjects.push(courseName);
          console.log(`âœ“ å·²è‡ªå‹•å°‡ã€Œ${courseName}ã€åŠ å…¥ ${teacherName} çš„è¬›æˆèª²ç¨‹`);
        }
      }

      // ç‚ºåŠ©æ•™è‡ªå‹•å¡«å……
      if (ta && courseName) {
        // ç¢ºä¿ subjects é™£åˆ—å­˜åœ¨
        if (!ta.subjects) {
          ta.subjects = [];
        }

        // æª¢æŸ¥èª²ç¨‹åç¨±æ˜¯å¦å·²å­˜åœ¨æ–¼è¬›æˆèª²ç¨‹ä¸­ï¼ˆé¿å…é‡è¤‡ï¼‰
        if (!ta.subjects.includes(courseName)) {
          ta.subjects.push(courseName);
          console.log(`âœ“ å·²è‡ªå‹•å°‡ã€Œ${courseName}ã€åŠ å…¥ ${taName} çš„è¬›æˆèª²ç¨‹ï¼ˆåŠ©æ•™ï¼‰`);
        }
      }

      // åŒæ­¥åˆ°è¡Œäº‹æ›†
      calendarEvents.push({
        id: courseData.id,
        date: courseData.date,
        title: `${courseData.name} - ${teacherName}`,
        time: courseData.time,
        teacherId: teacherId,
        location: courseData.type,
        color: getCourseTypeColor(courseData.type),
        courseId: courseData.id
      });

      saveData();
      closeAddCourseModal();
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
      renderCalendar();
      alert('âœ“ èª²ç¨‹æ–°å¢æˆåŠŸï¼');
    }

    function deleteCourse(id) {
      courseAssignments = courseAssignments.filter(c => c.id !== id);
      calendarEvents = calendarEvents.filter(e => e.courseId !== id);
      saveData();
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
      renderCalendar();
      alert('âœ“ èª²ç¨‹å·²åˆªé™¤ï¼');
    }

    // ==================== å·¥å…·å‡½æ•¸ ====================
    function calculateHours(timeRange) {
      const [start, end] = timeRange.split('-');
      const startTime = new Date(`2024-01-01 ${start}`);
      const endTime = new Date(`2024-01-01 ${end}`);
      return (endTime - startTime) / (1000 * 60 * 60);
    }

    function checkConflict(newCourse) {
      const conflicts = [];
      const timeToMinutes = (time) => {
        const [h, m] = time.split(':').map(Number);
        return h * 60 + m;
      };

      const [newStart, newEnd] = newCourse.time.split('-');
      const newStartMin = timeToMinutes(newStart);
      const newEndMin = timeToMinutes(newEnd);

      courseAssignments.forEach(c => {
        if (c.teacherId === newCourse.teacherId && c.date === newCourse.date) {
          const [start, end] = c.time.split('-');
          const startMin = timeToMinutes(start);
          const endMin = timeToMinutes(end);

          if (!(newEndMin <= startMin || newStartMin >= endMin)) {
            conflicts.push(`- ${c.name} (${c.time})`);
          }
        }
      });

      return conflicts;
    }

    function getCourseTypeColor(type) {
      const colors = {
        'æ­£èª²': 'bg-blue-500',
        'è£œèª²': 'bg-yellow-500',
        'å¯¦é©—èª²': 'bg-purple-500',
        'å¯¦ä½œèª²': 'bg-green-500',
        'å°ˆé¡Œ': 'bg-red-500'
      };
      return colors[type] || 'bg-gray-500';
    }

    // ==================== è‡ªå‹•æ¨™ç±¤ç”Ÿæˆç³»çµ± ====================

    // æ¨™ç±¤é—œéµå­—è¦å‰‡
    const TAG_RULES = {
      important: {
        keywords: ['é‡è¦', 'å¿…é ˆ', 'æ³¨æ„', 'å‹™å¿…', 'åˆ‡è¨˜', 'é—œéµ', 'ç·Šæ€¥'],
        class: 'tag-important',
        icon: 'icon-alert'
      },
      exam: {
        keywords: ['è€ƒè©¦', 'æ¸¬é©—', 'è©•é‡', 'æœŸä¸­', 'æœŸæœ«', 'å°è€ƒ', 'å¤§è€ƒ'],
        class: 'tag-exam',
        icon: 'icon-file'
      },
      experiment: {
        keywords: ['å¯¦é©—', 'å¯¦ç¿’', 'å¯¦ä½œ', 'å¯¦å‹™', 'æ“ä½œ', 'ç·´ç¿’'],
        class: 'tag-experiment',
        icon: 'icon-flask'
      },
      project: {
        keywords: ['å°ˆé¡Œ', 'å ±å‘Š', 'ä½œæ¥­', 'ç¿’é¡Œ', 'ç¹³äº¤', 'æˆªæ­¢'],
        class: 'tag-project',
        icon: 'icon-presentation'
      },
      meeting: {
        keywords: ['æœƒè­°', 'è¨è«–', 'èªªæ˜', 'è¬›è§£', 'æ¼”è¬›', 'åº§è«‡'],
        class: 'tag-meeting',
        icon: 'icon-users'
      }
    };

    let currentTags = [];

    /**
     * è‡ªå‹•å¾å‚™è¨»ç”Ÿæˆæ¨™ç±¤
     */
    function autoGenerateTags() {
      const noteText = document.getElementById('editCourseNote').value.trim();

      if (!noteText) {
        currentTags = [];
        renderTags();
        return;
      }

      const detectedTags = [];

      // æª¢æŸ¥æ¯å€‹è¦å‰‡
      Object.entries(TAG_RULES).forEach(([key, rule]) => {
        rule.keywords.forEach(keyword => {
          if (noteText.includes(keyword)) {
            // é¿å…é‡è¤‡
            if (!detectedTags.find(t => t.text === keyword)) {
              detectedTags.push({
                text: keyword,
                class: rule.class,
                icon: rule.icon,
                type: key
              });
            }
          }
        });
      });

      // æå–å¯èƒ½çš„è‡ªå®šç¾©é—œéµå­—ï¼ˆ3-6å€‹å­—çš„è©çµ„ï¼‰
      const customKeywords = extractCustomKeywords(noteText);
      customKeywords.forEach(keyword => {
        if (!detectedTags.find(t => t.text === keyword)) {
          detectedTags.push({
            text: keyword,
            class: 'tag-default',
            icon: 'ğŸ·ï¸',
            type: 'custom'
          });
        }
      });

      // é™åˆ¶æ¨™ç±¤æ•¸é‡ï¼ˆæœ€å¤š6å€‹ï¼‰
      currentTags = detectedTags.slice(0, 6);
      renderTags();
    }

    /**
     * æå–è‡ªå®šç¾©é—œéµå­—
     */
    function extractCustomKeywords(text) {
      const keywords = [];

      // ç§»é™¤æ¨™é»ç¬¦è™Ÿï¼ŒæŒ‰ç©ºæ ¼ã€é€—è™Ÿã€å¥è™Ÿåˆ†å‰²
      const words = text.replace(/[ï¼Œã€‚ï¼ï¼Ÿã€ï¼›ï¼š""''ï¼ˆï¼‰ã€Šã€‹ã€ã€‘]/g, ' ')
                       .split(/\s+/)
                       .filter(w => w.length >= 2 && w.length <= 8);

      // å–å‰3å€‹è©ä½œç‚ºé—œéµå­—
      return words.slice(0, 3);
    }

    /**
     * æ¸²æŸ“æ¨™ç±¤
     */
    function renderTags() {
      const container = document.getElementById('autoTagsContainer');
      if (!container) return;

      if (currentTags.length === 0) {
        container.innerHTML = '<span class="text-xs" style="color: var(--apple-gray);">è¼¸å…¥å‚™è¨»å¾Œè‡ªå‹•ç”Ÿæˆæ¨™ç±¤...</span>';
        return;
      }

      container.innerHTML = currentTags.map((tag, index) => `
        <div class="auto-tag ${tag.class}">
          <svg class="modal-icon-sm"><use href="#${tag.icon}"></use></svg>
          <span>${tag.text}</span>
          <span class="auto-tag-remove" onclick="removeTag(${index}); event.stopPropagation();">Ã—</span>
        </div>
      `).join('');
    }

    /**
     * ç§»é™¤æ¨™ç±¤
     */
    function removeTag(index) {
      currentTags.splice(index, 1);
      renderTags();
    }

    /**
     * ç²å–ç•¶å‰æ¨™ç±¤ï¼ˆç”¨æ–¼å„²å­˜ï¼‰
     */
    function getCurrentTags() {
      return currentTags.map(t => t.text);
    }

    // ==================== iOS é¢¨æ ¼å½ˆå‡ºå¼é¸å–® ====================

    /**
     * åˆ‡æ›å½ˆå‡ºå¼é¸å–®
     */
    function toggleContextMenu() {
      const overlay = document.getElementById('contextMenuOverlay');
      overlay.classList.toggle('show');
    }

    /**
     * é—œé–‰å½ˆå‡ºå¼é¸å–®
     */
    function closeContextMenu() {
      const overlay = document.getElementById('contextMenuOverlay');
      overlay.classList.remove('show');
    }

    /**
     * ç¢ºèªåˆªé™¤èª²ç¨‹ï¼ˆå¾é¸å–®è§¸ç™¼ï¼‰
     */
    function confirmDeleteCourse() {
      // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„èª²ç¨‹ ID
      if (!editingCourseId) {
        alert('âœ— ç„¡æ³•åˆªé™¤ï¼šæœªé¸æ“‡æœ‰æ•ˆçš„èª²ç¨‹');
        return;
      }

      // æª¢æŸ¥æ˜¯å¦ç‚ºå”¯è®€æ¨¡å¼
      if (window.isReadOnlyMode) {
        alert('âœ— ç„¡æ³•åˆªé™¤ï¼šæ­¤èª²ç¨‹æ­£è¢«å…¶ä»–äººç·¨è¼¯ä¸­ï¼Œç„¡æ³•åœ¨å”¯è®€æ¨¡å¼ä¸‹åˆªé™¤');
        return;
      }

      if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤èª²ç¨‹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        deleteCourse(editingCourseId);
        closeViewEventModal();
      }
    }

    // ==================== Phase 1: è¤‡è£½ã€åˆ†äº«åŠŸèƒ½ ====================

    /**
     * åŠŸèƒ½ 1.1: è¤‡è£½èª²ç¨‹è³‡è¨Šåˆ°å‰ªè²¼ç°¿
     */
    async function copyCourseToClipboard() {
      const course = courseAssignments.find(c => c.id === editingCourseId);
      if (!course) return;

      const teacher = teachers.find(t => t.id === course.teacherId);
      const courseText = `èª²ç¨‹ï¼š${course.name}\n` +
                        `æ•™å¸«ï¼š${teacher ? teacher.name : 'æœªçŸ¥'}\n` +
                        `æ—¥æœŸï¼š${course.date}\n` +
                        `æ™‚é–“ï¼š${course.time}\n` +
                        `é¡å‹ï¼š${course.type}\n` +
                        `${course.note ? 'å‚™è¨»ï¼š' + course.note : ''}`;

      try {
        // ä½¿ç”¨ç¾ä»£ Clipboard API
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(courseText);
          showMessage('èª²ç¨‹è³‡è¨Šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'success');
        } else {
          // é™ç´šæ–¹æ¡ˆï¼šä½¿ç”¨å‚³çµ±æ–¹å¼
          const textarea = document.createElement('textarea');
          textarea.value = courseText;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          showMessage('èª²ç¨‹è³‡è¨Šå·²è¤‡è£½ï¼', 'success');
        }
      } catch (err) {
        console.error('è¤‡è£½å¤±æ•—:', err);
        showMessage('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½', 'error');
      }
    }

    /**
     * åŠŸèƒ½ 1.2: é–‹å•Ÿã€Œè¤‡è£½åˆ°å…¶ä»–æ—¥æœŸã€Modal
     */
    function openDuplicateDateModal() {
      const course = courseAssignments.find(c => c.id === editingCourseId);
      if (!course) return;

      // è¨­å®šé è¨­æ—¥æœŸç‚ºæ˜å¤©
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowStr = tomorrow.toISOString().split('T')[0];
      document.getElementById('duplicateNewDate').value = tomorrowStr;

      // é¡¯ç¤º Modal
      document.getElementById('duplicateDateModal').classList.remove('hidden');
    }

    /**
     * é—œé–‰ã€Œè¤‡è£½åˆ°å…¶ä»–æ—¥æœŸã€Modal
     */
    function closeDuplicateDateModal() {
      document.getElementById('duplicateDateModal').classList.add('hidden');
    }

    /**
     * ç¢ºèªè¤‡è£½èª²ç¨‹åˆ°æ–°æ—¥æœŸ
     */
    function confirmDuplicateCourse() {
      const newDate = document.getElementById('duplicateNewDate').value;
      if (!newDate) {
        alert('è«‹é¸æ“‡æ–°æ—¥æœŸï¼');
        return;
      }

      const originalCourse = courseAssignments.find(c => c.id === editingCourseId);
      if (!originalCourse) return;

      // æª¢æŸ¥æ™‚é–“è¡çª
      const conflicts = checkTimeConflict(
        originalCourse.teacherId,
        newDate,
        originalCourse.time
      );

      if (conflicts.length > 0) {
        const continueAnyway = confirm(
          `âš ï¸ è¡å ‚è­¦å‘Šï¼\n\n${conflicts.join('\n')}\n\næ˜¯å¦ä»è¦ç¹¼çºŒè¤‡è£½ï¼Ÿ`
        );
        if (!continueAnyway) return;
      }

      // å»ºç«‹æ–°èª²ç¨‹ï¼ˆè¤‡è£½æ‰€æœ‰è³‡è¨Šï¼Œåƒ…æ”¹æ—¥æœŸï¼‰
      const newCourseId = Date.now();
      const newCourse = {
        ...originalCourse,
        id: newCourseId,
        date: newDate
      };

      courseAssignments.push(newCourse);

      // åŒæ­¥å»ºç«‹è¡Œäº‹æ›†äº‹ä»¶
      const teacher = teachers.find(t => t.id === newCourse.teacherId);
      const newEvent = {
        id: newCourseId,
        courseId: newCourseId,
        date: newDate,
        title: `${newCourse.name} - ${teacher ? teacher.name : ''}`,
        time: newCourse.time,
        teacherId: newCourse.teacherId,
        location: newCourse.type,
        color: getCourseTypeColor(newCourse.type)
      };
      calendarEvents.push(newEvent);

      // å„²å­˜ä¸¦æ›´æ–°ä»‹é¢
      saveData();
      updateStatistics();
      renderCalendar();
      renderTodayCourses();
      closeDuplicateDateModal();

      showMessage(`èª²ç¨‹å·²æˆåŠŸè¤‡è£½åˆ° ${newDate}ï¼`, 'success');
    }

    /**
     * æª¢æŸ¥æ™‚é–“è¡çªï¼ˆç”¨æ–¼è¤‡è£½èª²ç¨‹ï¼‰
     */
    function checkTimeConflict(teacherId, date, time) {
      const conflicts = [];
      const timeToMinutes = (t) => {
        const [h, m] = t.split(':').map(Number);
        return h * 60 + m;
      };

      const [newStart, newEnd] = time.split('-');
      const newStartMin = timeToMinutes(newStart);
      const newEndMin = timeToMinutes(newEnd);

      courseAssignments.forEach(c => {
        if (c.teacherId === teacherId && c.date === date) {
          const [start, end] = c.time.split('-');
          const startMin = timeToMinutes(start);
          const endMin = timeToMinutes(end);

          if (!(newEndMin <= startMin || newStartMin >= endMin)) {
            conflicts.push(`- ${c.name} (${c.time})`);
          }
        }
      });

      return conflicts;
    }

    /**
     * åŠŸèƒ½ 1.3: åˆ†äº«èª²ç¨‹ï¼ˆä½¿ç”¨ Web Share API æˆ–ç”¢ç”Ÿé€£çµï¼‰
     */
    async function shareCourse() {
      const course = courseAssignments.find(c => c.id === editingCourseId);
      if (!course) return;

      const teacher = teachers.find(t => t.id === course.teacherId);
      const shareText = `èª²ç¨‹è³‡è¨Š\n\n` +
                       `èª²ç¨‹ï¼š${course.name}\n` +
                       `æ•™å¸«ï¼š${teacher ? teacher.name : 'æœªçŸ¥'}\n` +
                       `æ—¥æœŸï¼š${course.date}\n` +
                       `æ™‚é–“ï¼š${course.time}\n` +
                       `é¡å‹ï¼š${course.type}`;

      const shareUrl = window.location.href;

      try {
        // å„ªå…ˆä½¿ç”¨ Web Share APIï¼ˆè¡Œå‹•è£ç½®æ”¯æ´ï¼‰
        if (navigator.share) {
          await navigator.share({
            title: course.name,
            text: shareText,
            url: shareUrl
          });
          showMessage('èª²ç¨‹å·²åˆ†äº«ï¼', 'success');
        } else {
          // é™ç´šæ–¹æ¡ˆï¼šè¤‡è£½åˆ†äº«æ–‡å­—åˆ°å‰ªè²¼ç°¿
          const fullText = shareText + `\n\né€£çµï¼š${shareUrl}`;

          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(fullText);
            showMessage('åˆ†äº«é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'success', 'æ‚¨å¯ä»¥è²¼åˆ° Lineã€Email æˆ–å…¶ä»–åœ°æ–¹åˆ†äº«');
          } else {
            // æœ€å¾Œé™ç´šæ–¹æ¡ˆ
            const textarea = document.createElement('textarea');
            textarea.value = fullText;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showMessage('åˆ†äº«é€£çµå·²è¤‡è£½ï¼', 'success');
          }
        }
      } catch (err) {
        console.error('åˆ†äº«å¤±æ•—:', err);
        if (err.name === 'AbortError') {
          // ä½¿ç”¨è€…å–æ¶ˆåˆ†äº«ï¼Œä¸é¡¯ç¤ºéŒ¯èª¤
          return;
        }
        showMessage('åˆ†äº«å¤±æ•—', 'error');
      }
    }

    // ==================== Phase 3: ç¤¾äº¤äº’å‹•åŠŸèƒ½ ====================

    let currentCourseId = null;
    let currentUserId = null;
    let currentUserName = null;

    /**
     * åˆå§‹åŒ–ç¤¾äº¤åŠŸèƒ½
     */
    function initSocialFeatures(courseId, userId, userName) {
      currentCourseId = courseId;
      currentUserId = userId;
      currentUserName = userName;
    }

    /**
     * æ–°å¢ç•™è¨€
     */
    function addComment() {
      const input = document.getElementById('newCommentInput');
      const content = input.value.trim();

      if (!content) {
        alert('è«‹è¼¸å…¥ç•™è¨€å…§å®¹ï¼');
        return;
      }

      const comments = loadArray('comments');
      comments.push({
        id: Date.now(),
        courseId: currentCourseId,
        userId: currentUserId,
        userName: currentUserName,
        userAvatar: '', // å¯ä»¥å¾ŒçºŒæ–°å¢é ­åƒåŠŸèƒ½
        content: content,
        timestamp: new Date().toISOString(),
        updatedAt: null
      });

      localStorage.setItem('comments', JSON.stringify(comments));
      logActivity(currentCourseId, 'ç™¼è¡¨äº†ç•™è¨€', 'comment');

      input.value = '';
      viewEvent(currentCourseId); // é‡æ–°æ¸²æŸ“
    }

    /**
     * è¨­å®šæé†’
     */
    function setReminder() {
      const course = courseAssignments.find(c => c.id === currentCourseId);
      if (!course) return;

      const reminderOptions = [
        { value: 'èª²ç¨‹ç•¶å¤© 09:00', label: 'èª²ç¨‹ç•¶å¤©æ—©ä¸Š 9:00' },
        { value: '1å¤©å‰', label: '1å¤©å‰' },
        { value: '3å¤©å‰', label: '3å¤©å‰' },
        { value: '1é€±å‰', label: '1é€±å‰' }
      ];

      let optionsHtml = reminderOptions.map(opt =>
        `<option value="${opt.value}" ${course.reminderTime === opt.value ? 'selected' : ''}>${opt.label}</option>`
      ).join('');

      const reminder = prompt(
        `è«‹é¸æ“‡æé†’æ™‚é–“ï¼š\n\n` +
        `1. èª²ç¨‹ç•¶å¤©æ—©ä¸Š 9:00\n` +
        `2. 1å¤©å‰\n` +
        `3. 3å¤©å‰\n` +
        `4. 1é€±å‰\n` +
        `5. æ¸…é™¤æé†’\n\n` +
        `è«‹è¼¸å…¥é¸é …ç·¨è™Ÿ (1-5)ï¼š`
      );

      if (reminder === null) return;

      const reminderMap = {
        '1': 'èª²ç¨‹ç•¶å¤© 09:00',
        '2': '1å¤©å‰',
        '3': '3å¤©å‰',
        '4': '1é€±å‰',
        '5': null
      };

      const selectedReminder = reminderMap[reminder];
      if (selectedReminder === undefined) {
        alert('ç„¡æ•ˆçš„é¸é …ï¼');
        return;
      }

      course.reminderTime = selectedReminder;
      course.updatedAt = new Date().toISOString();

      saveData();
      logActivity(currentCourseId, selectedReminder ? `è¨­å®šæé†’ï¼š${selectedReminder}` : 'æ¸…é™¤æé†’', 'reminder');
      viewEvent(currentCourseId);
      showMessage(selectedReminder ? `æé†’å·²è¨­å®šï¼š${selectedReminder}` : 'æé†’å·²æ¸…é™¤', 'success');
    }

    /**
     * è¨˜éŒ„æ“ä½œæ­·å²
     */
    function logActivity(courseId, action, actionType = 'general') {
      const activityLog = loadArray('activityLog');
      activityLog.push({
        id: Date.now(),
        courseId: courseId,
        userId: currentUserId || 'user_1',
        userName: currentUserName || 'ç®¡ç†å“¡',
        action: action,
        actionType: actionType,
        details: '',
        timestamp: new Date().toISOString()
      });

      localStorage.setItem('activityLog', JSON.stringify(activityLog));
    }

    /**
     * æ ¼å¼åŒ–æ™‚é–“æˆ³è¨˜
     */
    function formatTimestamp(timestamp) {
      if (!timestamp) return '';

      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'å‰›å‰›';
      if (diffMins < 60) return `${diffMins}åˆ†é˜å‰`;
      if (diffHours < 24) return `${diffHours}å°æ™‚å‰`;
      if (diffDays < 7) return `${diffDays}å¤©å‰`;

      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hour = String(date.getHours()).padStart(2, '0');
      const minute = String(date.getMinutes()).padStart(2, '0');

      if (year === now.getFullYear()) {
        return `${month}-${day} ${hour}:${minute}`;
      }
      return `${year}-${month}-${day}`;
    }

    // ==================== å•å·ç®¡ç†åŠŸèƒ½ ====================

    function openSurveyManagement(courseId) {
      const course = courseAssignments.find(c => c.id === courseId);
      if (!course) return;

      // è¼‰å…¥å•å·æ•¸æ“š
      const surveys = JSON.parse(localStorage.getItem('surveys') || '[]');
      const surveyTemplates = JSON.parse(localStorage.getItem('surveyTemplates') || '[]');
      const surveyResponses = JSON.parse(localStorage.getItem('surveyResponses') || '[]');

      // æŸ¥æ‰¾æ­¤èª²ç¨‹çš„å•å·
      const courseSurveys = surveys.filter(s => s.courseId === courseId);

      let message = `ğŸ“Š èª²ç¨‹å•å·ç®¡ç†\n\n`;
      message += `èª²ç¨‹ï¼š${course.name}\n`;
      message += `æ—¥æœŸï¼š${course.date}\n\n`;

      if (courseSurveys.length === 0) {
        message += `æ­¤èª²ç¨‹å°šæœªå‰µå»ºå•å·ã€‚\n\n`;
        message += `è«‹å‰å¾€ã€Œå•å·ç®¡ç†ç³»çµ±ã€ç‚ºæ­¤èª²ç¨‹å‰µå»ºå•å·ã€‚\n\n`;
        const goToSurvey = confirm(message + 'æ˜¯å¦è¦å‰å¾€å•å·ç®¡ç†ç³»çµ±ï¼Ÿ');
        if (goToSurvey) {
          window.location.href = 'survey-management.html';
        }
      } else {
        message += `å·²å‰µå»º ${courseSurveys.length} å€‹å•å·ï¼š\n\n`;

        courseSurveys.forEach((survey, index) => {
          const template = surveyTemplates.find(t => t.id === survey.templateId);
          const responses = surveyResponses.filter(r => r.surveyId === survey.id);
          const statusText = survey.status === 'active' ? 'âœ“ é–‹æ”¾ä¸­' : 'âœ— å·²é—œé–‰';

          message += `${index + 1}. ${template ? template.name : 'æœªçŸ¥æ¨¡æ¿'}\n`;
          message += `   ç‹€æ…‹ï¼š${statusText}\n`;
          message += `   å›æ‡‰æ•¸ï¼š${responses.length} ä»½\n`;
          message += `   é€£çµï¼š${survey.shareUrl}\n\n`;
        });

        message += `\nè«‹å‰å¾€ã€Œå•å·ç®¡ç†ç³»çµ±ã€æŸ¥çœ‹è©³ç´°çµ±è¨ˆæˆ–ç®¡ç†å•å·ã€‚`;

        const goToSurvey = confirm(message + '\n\næ˜¯å¦è¦å‰å¾€å•å·ç®¡ç†ç³»çµ±ï¼Ÿ');
        if (goToSurvey) {
          window.location.href = 'survey-management.html';
        }
      }
    }

    function saveData() {
      try {
        // å„²å­˜åˆ° localStorage
        localStorage.setItem('teachers', JSON.stringify(teachers));
        localStorage.setItem('courseAssignments', JSON.stringify(courseAssignments));
        localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));

        // æ¨™è¨˜æœ¬åœ°è³‡æ–™å·²ä¿®æ”¹
        if (typeof syncManager !== 'undefined') {
          syncManager.markAsChanged();

          // ä½¿ç”¨å®‰å…¨å„²å­˜æ¨¡å¼ï¼ˆæª¢æŸ¥è¡çªï¼‰
          syncManager.saveToBackendSafe().then(result => {
            if (result.conflict) {
              showConflictDialog(result);
              console.warn('ç™¼ç¾è³‡æ–™è¡çªï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            } else if (result.success) {
              // è³‡æ–™å·²å®‰å…¨å„²å­˜åˆ°é›²ç«¯
            }
          }).catch(err => {
            console.warn('âš ï¸ å¾Œç«¯åŒæ­¥å¤±æ•—ï¼Œè³‡æ–™å·²ä¿å­˜åœ¨æœ¬åœ°:', err.message);
          });
        }
      } catch (err) {
        console.error('å„²å­˜å¤±æ•—:', err);
      }
    }

    // ==================== å•Ÿå‹•æ‡‰ç”¨ ====================
    window.addEventListener('DOMContentLoaded', init);
  </script>

  <!-- SVG Icon å®šç¾©åº«ï¼ˆåƒ…ç”¨æ–¼ Modalï¼‰ -->
  <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <symbol id="icon-edit" viewBox="0 0 24 24">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
      </symbol>
      <symbol id="icon-save" viewBox="0 0 24 24">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
        <polyline points="17 21 17 13 7 13 7 21"></polyline>
        <polyline points="7 3 7 8 15 8"></polyline>
      </symbol>
      <symbol id="icon-more" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="1"></circle>
        <circle cx="19" cy="12" r="1"></circle>
        <circle cx="5" cy="12" r="1"></circle>
      </symbol>
      <symbol id="icon-tag" viewBox="0 0 24 24">
        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
        <line x1="7" y1="7" x2="7.01" y2="7"></line>
      </symbol>
      <symbol id="icon-alert" viewBox="0 0 24 24">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
        <line x1="12" y1="9" x2="12" y2="13"></line>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </symbol>
      <symbol id="icon-file" viewBox="0 0 24 24">
        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
        <polyline points="13 2 13 9 20 9"></polyline>
      </symbol>
      <symbol id="icon-flask" viewBox="0 0 24 24">
        <path d="M9 3h6"></path>
        <path d="M10 3v7.586a2 2 0 0 1-.586 1.414L4 17.414A2 2 0 0 0 5.414 21h13.172a2 2 0 0 0 1.414-3.586l-5.414-5.414A2 2 0 0 1 14 10.586V3"></path>
      </symbol>
      <symbol id="icon-presentation" viewBox="0 0 24 24">
        <path d="M2 3h20"></path>
        <path d="M21 3v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V3"></path>
        <path d="M7 21l5-5 5 5"></path>
      </symbol>
      <symbol id="icon-users" viewBox="0 0 24 24">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
      </symbol>
      <symbol id="icon-lightbulb" viewBox="0 0 24 24">
        <path d="M9 18h6"></path>
        <path d="M10 22h4"></path>
        <path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"></path>
      </symbol>
    </defs>
  </svg>

</body>
</html>
