<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ´¾èª²ç®¡ç†ç³»çµ±</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .calendar-day {
      min-height: 120px;
      transition: all 0.3s ease;
    }

    .calendar-day:hover {
      background: rgba(255, 255, 255, 0.95) !important;
      transform: scale(1.02);
    }

    .today-highlight {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2)) !important;
      border: 2px solid #667eea !important;
    }

    .event-item {
      padding: 6px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 11px;
    }

    .event-item:hover {
      opacity: 0.8;
      transform: scale(1.05);
    }

    .modern-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }

    .modern-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    @media (max-width: 768px) {
      .calendar-grid-container {
        display: none;
      }

      .mobile-calendar-view {
        display: block !important;
      }
    }

    .mobile-calendar-view {
      display: none;
    }
  </style>
</head>
<body>
  <div class="min-h-screen p-4 md:p-6">
    <!-- è¿”å›é¦–é  -->
    <div class="mb-6">
      <a href="index.html" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-white/20 backdrop-blur-sm border border-white/30 rounded-lg hover:bg-white/30 transition-colors">
        <span class="mr-2">â†</span> è¿”å›é¦–é 
      </a>
    </div>

    <!-- æ¨™é¡Œ -->
    <div class="text-center mb-8">
      <h1 class="text-5xl font-bold text-white mb-2" style="letter-spacing: -0.02em">æ´¾èª²ç®¡ç†ç³»çµ±</h1>
      <p class="text-xl text-white/80">æ™ºèƒ½ç®¡ç†å¹³å°</p>
    </div>

    <div class="max-w-7xl mx-auto">
      <!-- ä»Šæ—¥èª²ç¨‹ç¸½è¦½ -->
      <div class="glass-effect rounded-2xl p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-gray-800">ğŸ“… ä»Šæ—¥èª²ç¨‹ç¸½è¦½</h2>
          <div class="text-sm text-gray-600" id="todayDate"></div>
        </div>
        <div id="todayCoursesContainer" class="space-y-3">
          <!-- ä»Šæ—¥èª²ç¨‹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
        </div>
      </div>

      <!-- è¡Œäº‹æ›† -->
      <div class="glass-effect rounded-2xl p-6 mb-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
          <h2 class="text-2xl font-bold text-gray-800">ğŸ“… èª²ç¨‹è¡Œäº‹æ›†</h2>
          <div class="flex items-center gap-3">
            <button onclick="openAddCourseModal()" class="modern-btn text-white px-6 py-2 rounded-xl font-medium">
              âœ¨ æ–°å¢èª²ç¨‹
            </button>
            <div class="flex bg-white rounded-xl p-1 shadow">
              <button id="monthViewBtn" onclick="setViewMode('month')" class="px-4 py-2 rounded-lg text-sm font-semibold bg-gradient-to-r from-purple-500 to-blue-500 text-white">
                ğŸ“… æœˆ
              </button>
              <button id="weekViewBtn" onclick="setViewMode('week')" class="px-4 py-2 rounded-lg text-sm font-semibold text-gray-600 hover:bg-gray-100">
                ğŸ“Š é€±
              </button>
            </div>
          </div>
        </div>

        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center space-x-4">
            <button onclick="previousPeriod()" class="bg-white hover:bg-gray-100 px-4 py-2 rounded-xl font-medium">
              â† <span id="prevLabel">ä¸Šå€‹æœˆ</span>
            </button>
            <h3 id="currentMonth" class="text-xl font-bold text-gray-800 min-w-[200px] text-center"></h3>
            <button onclick="nextPeriod()" class="bg-white hover:bg-gray-100 px-4 py-2 rounded-xl font-medium">
              <span id="nextLabel">ä¸‹å€‹æœˆ</span> â†’
            </button>
          </div>
          <button onclick="goToToday()" class="modern-btn text-white px-4 py-2 rounded-xl font-medium">
            ğŸ¯ ä»Šå¤©
          </button>
        </div>

        <!-- è¡Œäº‹æ›†ç¶²æ ¼ (æ¡Œé¢ç‰ˆ) -->
        <div class="calendar-grid-container bg-white rounded-xl overflow-hidden shadow-lg">
          <!-- æ˜ŸæœŸæ¨™é¡Œ -->
          <div class="grid grid-cols-7 bg-gradient-to-r from-purple-500 to-blue-500">
            <div class="p-4 text-center font-bold text-white border-r border-white/20">æ—¥</div>
            <div class="p-4 text-center font-bold text-white border-r border-white/20">ä¸€</div>
            <div class="p-4 text-center font-bold text-white border-r border-white/20">äºŒ</div>
            <div class="p-4 text-center font-bold text-white border-r border-white/20">ä¸‰</div>
            <div class="p-4 text-center font-bold text-white border-r border-white/20">å››</div>
            <div class="p-4 text-center font-bold text-white border-r border-white/20">äº”</div>
            <div class="p-4 text-center font-bold text-white">å…­</div>
          </div>
          <!-- æ—¥æœŸç¶²æ ¼ -->
          <div id="calendarGrid" class="grid grid-cols-7"></div>
        </div>

        <!-- æ‰‹æ©Ÿç‰ˆè¡Œäº‹æ›†åˆ—è¡¨ -->
        <div class="mobile-calendar-view bg-white rounded-xl overflow-hidden shadow-lg p-4">
          <div id="mobileEventsList" class="space-y-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ–°å¢èª²ç¨‹ Modal -->
  <div id="addCourseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="glass-effect rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
      <h3 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“š æ–°å¢èª²ç¨‹</h3>
      <form id="courseForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡å¸«è³‡</label>
          <select id="courseTeacherId" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
            <option value="">è«‹é¸æ“‡å¸«è³‡</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">èª²ç¨‹åç¨±</label>
          <input type="text" id="courseName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">èª²ç¨‹æ—¥æœŸ</label>
            <input type="date" id="courseDate" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">èª²ç¨‹é¡å‹</label>
            <select id="courseType" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="æ­£èª²">æ­£èª²</option>
              <option value="è£œèª²">è£œèª²</option>
              <option value="å¯¦é©—èª²">å¯¦é©—èª²</option>
              <option value="å¯¦ä½œèª²">å¯¦ä½œèª²</option>
              <option value="å°ˆé¡Œ">å°ˆé¡Œ</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">é–‹å§‹æ™‚é–“</label>
            <input type="time" id="startTime" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">çµæŸæ™‚é–“</label>
            <input type="time" id="endTime" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
        </div>
        <div class="flex justify-end space-x-4 pt-4">
          <button type="button" onclick="closeAddCourseModal()" class="px-6 py-3 bg-gray-500 text-white rounded-xl font-medium hover:bg-gray-600 transition-colors">
            å–æ¶ˆ
          </button>
          <button type="submit" class="modern-btn px-6 py-3 text-white rounded-xl font-medium">
            ç¢ºèªæ–°å¢
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- æŸ¥çœ‹èª²ç¨‹è©³æƒ… Modal -->
  <div id="viewEventModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="glass-effect rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
      <h3 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“… èª²ç¨‹è©³æƒ…</h3>
      <div id="eventDetails" class="space-y-4"></div>
      <div class="flex justify-end space-x-4 pt-6">
        <button onclick="closeViewEventModal()" class="px-6 py-3 bg-gray-500 text-white rounded-xl font-medium">
          é—œé–‰
        </button>
        <button id="deleteEventBtn" class="px-6 py-3 bg-red-500 text-white rounded-xl font-medium">
          ğŸ—‘ï¸ åˆªé™¤
        </button>
      </div>
    </div>
  </div>

  <script>
    // ==================== è³‡æ–™ç®¡ç† ====================
    let teachers = JSON.parse(localStorage.getItem('teachers') || '[]');
    let courseAssignments = JSON.parse(localStorage.getItem('courseAssignments') || '[]');
    let calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');

    let currentDate = new Date();
    let viewMode = 'month';

    // ==================== åˆå§‹åŒ– ====================
    function init() {
      loadTeachers();
      renderTodayCourses();
      renderCalendar();
      updateTodayDate();
      document.getElementById('courseForm').addEventListener('submit', handleAddCourse);
    }

    function loadTeachers() {
      const select = document.getElementById('courseTeacherId');
      select.innerHTML = '<option value="">è«‹é¸æ“‡å¸«è³‡</option>';
      teachers.forEach(t => {
        select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
      });
    }

    function updateTodayDate() {
      const today = new Date();
      const dateStr = today.toLocaleDateString('zh-TW', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      });
      document.getElementById('todayDate').textContent = dateStr;
    }

    // ==================== ä»Šæ—¥èª²ç¨‹ç¸½è¦½ ====================
    function renderTodayCourses() {
      const today = new Date().toISOString().split('T')[0];
      const todayCourses = courseAssignments.filter(c => c.date === today);

      const container = document.getElementById('todayCoursesContainer');

      if (todayCourses.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-2">âœ¨</div>
            <p>ä»Šå¤©æ²’æœ‰æ’èª²</p>
          </div>
        `;
        return;
      }

      // æŒ‰å¸«è³‡åˆ†çµ„
      const grouped = {};
      todayCourses.forEach(c => {
        if (!grouped[c.teacherId]) {
          grouped[c.teacherId] = [];
        }
        grouped[c.teacherId].push(c);
      });

      container.innerHTML = Object.entries(grouped).map(([teacherId, courses]) => {
        const teacher = teachers.find(t => t.id === Number(teacherId));
        if (!teacher) return '';

        return `
          <div class="bg-white rounded-xl p-4 border border-gray-200">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 p-0.5">
                  <div class="w-full h-full rounded-full bg-white flex items-center justify-center">
                    ${teacher.photo ?
                      `<img src="${teacher.photo}" class="w-full h-full object-cover rounded-full">` :
                      `<span class="text-lg font-bold text-gray-600">${(teacher.name || '?')[0]}</span>`
                    }
                  </div>
                </div>
                <div>
                  <h4 class="font-semibold text-gray-800">${teacher.name}</h4>
                  <p class="text-xs text-gray-500">${courses.length} å ‚èª²</p>
                </div>
              </div>
            </div>
            <div class="space-y-2">
              ${courses.sort((a, b) => a.time.localeCompare(b.time)).map(c => `
                <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100 transition-colors" onclick="viewEvent(${c.id})">
                  <div class="flex justify-between items-center">
                    <div class="flex-1">
                      <p class="font-medium text-gray-800">${c.name}</p>
                      <div class="flex items-center space-x-3 text-xs text-gray-600 mt-1">
                        <span>ğŸ• ${c.time}</span>
                        <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded">${c.type}</span>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    // ==================== è¡Œäº‹æ›† ====================
    function setViewMode(mode) {
      viewMode = mode;
      const monthBtn = document.getElementById('monthViewBtn');
      const weekBtn = document.getElementById('weekViewBtn');

      if (mode === 'month') {
        monthBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-gradient-to-r from-purple-500 to-blue-500 text-white';
        weekBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold text-gray-600 hover:bg-gray-100';
        document.getElementById('prevLabel').textContent = 'ä¸Šå€‹æœˆ';
        document.getElementById('nextLabel').textContent = 'ä¸‹å€‹æœˆ';
      } else {
        weekBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-gradient-to-r from-purple-500 to-blue-500 text-white';
        monthBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold text-gray-600 hover:bg-gray-100';
        document.getElementById('prevLabel').textContent = 'ä¸Šé€±';
        document.getElementById('nextLabel').textContent = 'ä¸‹é€±';
      }

      renderCalendar();
    }

    function previousPeriod() {
      if (viewMode === 'month') {
        currentDate.setMonth(currentDate.getMonth() - 1);
      } else {
        currentDate.setDate(currentDate.getDate() - 7);
      }
      renderCalendar();
    }

    function nextPeriod() {
      if (viewMode === 'month') {
        currentDate.setMonth(currentDate.getMonth() + 1);
      } else {
        currentDate.setDate(currentDate.getDate() + 7);
      }
      renderCalendar();
    }

    function goToToday() {
      currentDate = new Date();
      renderCalendar();
    }

    function renderCalendar() {
      if (viewMode === 'month') {
        renderMonthView();
      } else {
        renderWeekView();
      }
      renderMobileCalendar();
    }

    function renderMonthView() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const monthNames = ['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];

      document.getElementById('currentMonth').textContent = `${year}å¹´ ${monthNames[month]}`;

      const firstDay = new Date(year, month, 1);
      const start = new Date(firstDay);
      start.setDate(start.getDate() - firstDay.getDay());

      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      const today = new Date().toDateString();

      for (let w = 0; w < 6; w++) {
        for (let d = 0; d < 7; d++) {
          const cellDate = new Date(start);
          cellDate.setDate(start.getDate() + (w * 7) + d);

          const isCurrentMonth = (cellDate.getMonth() === month);
          const isToday = (cellDate.toDateString() === today);
          const dateKey = cellDate.toISOString().split('T')[0];

          // é¡¯ç¤ºæ‰€æœ‰èª²ç¨‹ï¼ˆä¸é™å¸«è³‡ï¼‰
          const dayEvents = courseAssignments.filter(c => c.date === dateKey);

          const cell = document.createElement('div');
          cell.className = `calendar-day border-r border-b border-gray-200 p-2 ${
            isCurrentMonth ? 'bg-white/60' : 'bg-gray-100/40'
          } ${isToday ? 'today-highlight' : ''}`;

          cell.innerHTML = `
            <div class="flex justify-between items-start mb-1">
              <span class="text-lg font-bold ${isCurrentMonth ? (isToday ? 'text-purple-600' : 'text-gray-800') : 'text-gray-400'}">
                ${cellDate.getDate()}
              </span>
            </div>
            <div class="space-y-1 overflow-y-auto max-h-24">
              ${dayEvents.map(e => {
                const teacher = teachers.find(t => t.id === e.teacherId);
                const teacherName = teacher ? teacher.name : 'æœªçŸ¥';
                return `
                  <div class="event-item bg-blue-500 text-white rounded cursor-pointer hover:bg-blue-600"
                       onclick="viewEvent(${e.id})">
                    <div class="font-medium truncate">${teacherName}</div>
                    <div class="text-[10px] truncate">${e.time} ${e.name}</div>
                  </div>
                `;
              }).join('')}
            </div>
          `;

          grid.appendChild(cell);
        }
      }
    }

    function renderWeekView() {
      const startOfWeek = new Date(currentDate);
      startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);

      const monthNames = ['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
      document.getElementById('currentMonth').textContent =
        `${startOfWeek.getFullYear()}å¹´ ${monthNames[startOfWeek.getMonth()]} ${startOfWeek.getDate()}æ—¥ - ${endOfWeek.getDate()}æ—¥`;

      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      const dayNames = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
      const today = new Date().toDateString();

      for (let i = 0; i < 7; i++) {
        const cellDate = new Date(startOfWeek);
        cellDate.setDate(startOfWeek.getDate() + i);

        const isToday = (cellDate.toDateString() === today);
        const dateKey = cellDate.toISOString().split('T')[0];
        const dayEvents = courseAssignments.filter(c => c.date === dateKey);

        const cell = document.createElement('div');
        cell.className = `calendar-day border-r border-b border-gray-200 p-4 bg-white/60 ${isToday ? 'today-highlight' : ''}`;

        cell.innerHTML = `
          <div class="text-center mb-4 pb-3 border-b border-gray-200">
            <div class="text-sm font-semibold ${isToday ? 'text-purple-600' : 'text-gray-600'}">${dayNames[i]}</div>
            <div class="text-2xl font-bold ${isToday ? 'text-purple-600' : 'text-gray-800'}">
              ${cellDate.getDate()}
            </div>
          </div>
          <div class="space-y-2">
            ${dayEvents.map(e => {
              const teacher = teachers.find(t => t.id === e.teacherId);
              const teacherName = teacher ? teacher.name : 'æœªçŸ¥';
              return `
                <div class="event-item bg-blue-500 text-white p-3 rounded-xl cursor-pointer hover:bg-blue-600"
                     onclick="viewEvent(${e.id})">
                  <div class="font-semibold">${teacherName}</div>
                  <div class="text-xs mt-1">â° ${e.time}</div>
                  <div class="text-xs">${e.name}</div>
                </div>
              `;
            }).join('')}
          </div>
        `;

        grid.appendChild(cell);
      }
    }

    function renderMobileCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date().toISOString().split('T')[0];

      const container = document.getElementById('mobileEventsList');
      let html = '';

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateKey = date.toISOString().split('T')[0];
        const dayEvents = courseAssignments.filter(c => c.date === dateKey);
        const isToday = dateKey === today;

        if (dayEvents.length > 0 || isToday) {
          const dayNames = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
          html += `
            <div class="border rounded-lg p-3 ${isToday ? 'bg-blue-50 border-blue-500' : 'bg-gray-50'}">
              <div class="flex items-center justify-between mb-2">
                <span class="font-bold text-gray-800">${month + 1}æœˆ${day}æ—¥ (${dayNames[date.getDay()]})</span>
                ${isToday ? '<span class="text-xs bg-blue-500 text-white px-2 py-1 rounded">ä»Šå¤©</span>' : ''}
              </div>
              ${dayEvents.length === 0 ?
                '<p class="text-sm text-gray-500">ç„¡èª²ç¨‹</p>' :
                dayEvents.map(e => {
                  const teacher = teachers.find(t => t.id === e.teacherId);
                  const teacherName = teacher ? teacher.name : 'æœªçŸ¥';
                  return `
                    <div class="mt-2 p-2 bg-blue-500 text-white rounded-lg cursor-pointer hover:bg-blue-600" onclick="viewEvent(${e.id})">
                      <div class="font-semibold text-sm">${teacherName} - ${e.name}</div>
                      <div class="text-xs mt-1">â° ${e.time} | ğŸ“š ${e.type}</div>
                    </div>
                  `;
                }).join('')
              }
            </div>
          `;
        }
      }

      if (!html) {
        html = '<p class="text-center text-gray-500 py-8">æœ¬æœˆç„¡èª²ç¨‹</p>';
      }

      container.innerHTML = html;
    }

    // ==================== Modal ç®¡ç† ====================
    function openAddCourseModal() {
      document.getElementById('courseDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('addCourseModal').classList.remove('hidden');
    }

    function closeAddCourseModal() {
      document.getElementById('addCourseModal').classList.add('hidden');
      document.getElementById('courseForm').reset();
    }

    function viewEvent(courseId) {
      const course = courseAssignments.find(c => c.id === courseId);
      if (!course) return;

      const teacher = teachers.find(t => t.id === course.teacherId);

      document.getElementById('eventDetails').innerHTML = `
        <div class="bg-white/50 rounded-xl p-4 space-y-3">
          <div>
            <label class="text-xs font-medium text-gray-600">å¸«è³‡</label>
            <p class="text-lg font-semibold text-gray-800">ğŸ‘¨â€ğŸ« ${teacher ? teacher.name : 'æœªçŸ¥'}</p>
          </div>
          <div>
            <label class="text-xs font-medium text-gray-600">èª²ç¨‹åç¨±</label>
            <p class="text-lg font-semibold text-gray-800">${course.name}</p>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-medium text-gray-600">æ—¥æœŸ</label>
              <p class="text-sm text-gray-800">ğŸ“… ${course.date}</p>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-600">æ™‚é–“</label>
              <p class="text-sm text-gray-800">â° ${course.time}</p>
            </div>
          </div>
          <div>
            <label class="text-xs font-medium text-gray-600">èª²ç¨‹é¡å‹</label>
            <p class="text-sm text-gray-800">ğŸ“š ${course.type}</p>
          </div>
        </div>
      `;

      document.getElementById('deleteEventBtn').onclick = () => {
        if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤èª²ç¨‹å—ï¼Ÿ')) {
          deleteCourse(courseId);
          closeViewEventModal();
        }
      };

      document.getElementById('viewEventModal').classList.remove('hidden');
    }

    function closeViewEventModal() {
      document.getElementById('viewEventModal').classList.add('hidden');
    }

    // ==================== èª²ç¨‹ç®¡ç† ====================
    function handleAddCourse(e) {
      e.preventDefault();

      const teacherId = Number(document.getElementById('courseTeacherId').value);
      if (!teacherId) {
        alert('è«‹é¸æ“‡å¸«è³‡ï¼');
        return;
      }

      const courseData = {
        id: Date.now(),
        teacherId: teacherId,
        name: document.getElementById('courseName').value,
        date: document.getElementById('courseDate').value,
        time: `${document.getElementById('startTime').value}-${document.getElementById('endTime').value}`,
        type: document.getElementById('courseType').value
      };

      // è¡å ‚æª¢æŸ¥
      const conflicts = checkConflict(courseData);
      if (conflicts.length > 0) {
        if (!confirm(`âš ï¸ è¡å ‚è­¦å‘Šï¼\n\n${conflicts.join('\n')}\n\næ˜¯å¦ä»è¦ç¹¼çºŒï¼Ÿ`)) {
          return;
        }
      }

      courseAssignments.push(courseData);

      // åŒæ­¥åˆ°è¡Œäº‹æ›†
      const teacher = teachers.find(t => t.id === teacherId);
      calendarEvents.push({
        id: courseData.id,
        date: courseData.date,
        title: `${courseData.name} - ${teacher.name}`,
        time: courseData.time,
        teacherId: teacherId,
        location: courseData.type,
        color: getCourseTypeColor(courseData.type),
        courseId: courseData.id
      });

      saveData();
      closeAddCourseModal();
      renderTodayCourses();
      renderCalendar();
      alert('âœ… èª²ç¨‹æ–°å¢æˆåŠŸï¼');
    }

    function deleteCourse(id) {
      courseAssignments = courseAssignments.filter(c => c.id !== id);
      calendarEvents = calendarEvents.filter(e => e.courseId !== id);
      saveData();
      renderTodayCourses();
      renderCalendar();
      alert('âœ… èª²ç¨‹å·²åˆªé™¤ï¼');
    }

    // ==================== å·¥å…·å‡½æ•¸ ====================
    function checkConflict(newCourse) {
      const conflicts = [];
      const timeToMinutes = (time) => {
        const [h, m] = time.split(':').map(Number);
        return h * 60 + m;
      };

      const [newStart, newEnd] = newCourse.time.split('-');
      const newStartMin = timeToMinutes(newStart);
      const newEndMin = timeToMinutes(newEnd);

      courseAssignments.forEach(c => {
        if (c.teacherId === newCourse.teacherId && c.date === newCourse.date) {
          const [start, end] = c.time.split('-');
          const startMin = timeToMinutes(start);
          const endMin = timeToMinutes(end);

          if (!(newEndMin <= startMin || newStartMin >= endMin)) {
            conflicts.push(`- ${c.name} (${c.time})`);
          }
        }
      });

      return conflicts;
    }

    function getCourseTypeColor(type) {
      const colors = {
        'æ­£èª²': 'bg-blue-500',
        'è£œèª²': 'bg-yellow-500',
        'å¯¦é©—èª²': 'bg-purple-500',
        'å¯¦ä½œèª²': 'bg-green-500',
        'å°ˆé¡Œ': 'bg-red-500'
      };
      return colors[type] || 'bg-gray-500';
    }

    function saveData() {
      try {
        localStorage.setItem('teachers', JSON.stringify(teachers));
        localStorage.setItem('courseAssignments', JSON.stringify(courseAssignments));
        localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
      } catch (err) {
        console.error('å„²å­˜å¤±æ•—:', err);
      }
    }

    // ==================== å•Ÿå‹•æ‡‰ç”¨ ====================
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
