<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ´¾èª²ç®¡ç†ç³»çµ± - ç¾ä»£åŒ–è¨“ç·´æ’ç¨‹</title>

  <!-- é é€£æ¥åˆ°è³‡æºæœå‹™å™¨ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">

  <!-- å­—é«”æ¨£å¼è¡¨ -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap">

  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <!-- Tailwind CDN -->
  <script defer src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js - å»¶é²åŠ è¼‰ -->
  <script>
    window.loadChartJS = function() {
      return new Promise((resolve, reject) => {
        if (window.Chart) {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    };
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      background: #f8fafc;
      color: #0f172a;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ========== Slate è‰²ç³»è¨­è¨ˆç³»çµ± ========== */
    :root {
      --slate-50: #f8fafc;
      --slate-100: #f1f5f9;
      --slate-200: #e2e8f0;
      --slate-300: #cbd5e1;
      --slate-400: #94a3b8;
      --slate-500: #64748b;
      --slate-600: #475569;
      --slate-700: #334155;
      --slate-800: #1e293b;
      --slate-900: #0f172a;
      
      --blue-500: #3b82f6;
      --blue-600: #2563eb;
      --emerald-500: #10b981;
      --emerald-600: #059669;
      --amber-500: #f59e0b;
      --purple-500: #a855f7;
      --red-500: #ef4444;
    }

    /* ========== ç¾ä»£åŒ–å¡ç‰‡è¨­è¨ˆ ========== */
    .card {
      background: #ffffff;
      border-radius: 20px;
      border: 1px solid var(--slate-200);
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.12), 0 2px 6px rgba(15, 23, 42, 0.08);
    }

    /* ========== å¸«è³‡å´é‚Šæ¬„å¡ç‰‡ ========== */
    .teacher-card {
      background: white;
      border: 1.5px solid var(--slate-200);
      border-radius: 16px;
      padding: 14px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .teacher-card:hover {
      border-color: var(--blue-500);
      background: var(--slate-50);
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }

    .teacher-card.selected {
      border-color: var(--blue-500);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(99, 102, 241, 0.08));
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2);
    }

    .teacher-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--blue-500), var(--purple-500));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 16px;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    /* ========== å‹•æ…‹çµ±è¨ˆå¡ç‰‡ ========== */
    .stat-card {
      background: linear-gradient(135deg, #ffffff 0%, var(--slate-50) 100%);
      border-radius: 20px;
      padding: 24px;
      border: 1.5px solid var(--slate-200);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
      border-radius: 50%;
      transform: translate(30%, -30%);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
      border-color: var(--blue-500);
    }

    .stat-card.blue {
      border-color: var(--blue-500);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(96, 165, 250, 0.05));
    }

    .stat-card.emerald {
      border-color: var(--emerald-500);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(52, 211, 153, 0.05));
    }

    .stat-card.amber {
      border-color: var(--amber-500);
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), rgba(251, 191, 36, 0.05));
    }

    /* ========== SVG ç”œç”œåœˆåœ–æ¨£å¼ ========== */
    .donut-chart-container {
      position: relative;
      display: inline-block;
    }

    .donut-segment {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .donut-segment:hover {
      opacity: 0.8;
      filter: brightness(1.1);
    }

    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 24px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--slate-50);
      border-radius: 12px;
      border: 1px solid var(--slate-200);
      transition: all 0.2s ease;
    }

    .legend-item:hover {
      background: white;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* ========== å€‹äººå‰©é¤˜æ™‚æ•¸å¡ç‰‡ï¼ˆæ¼¸è®ŠèƒŒæ™¯ï¼‰========== */
    .hours-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 24px;
      padding: 28px;
      color: white;
      position: relative;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.25);
    }

    .hours-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
      border-radius: 50%;
    }

    .hours-progress-ring {
      width: 120px;
      height: 120px;
    }

    /* ========== è¡Œäº‹æ›†å¢å¼·å‹•ç•« ========== */
    .calendar-day {
      min-height: 120px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--slate-200);
      border-radius: 12px;
      background: white;
    }

    .calendar-day:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.1);
      border-color: var(--blue-500);
    }

    .today-highlight {
      background: rgba(59, 130, 246, 0.08) !important;
      border: 2px solid var(--blue-500) !important;
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2) !important;
    }

    /* è¡Œäº‹æ›†å±•é–‹/æ”¶åˆå‹•ç•« */
    .calendar-collapsed {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transform: scaleY(0);
      transform-origin: top;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.6, 1);
    }

    .calendar-expanded {
      max-height: 2000px;
      opacity: 1;
      transform: scaleY(1);
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ========== ç¾ä»£åŒ–èª²ç¨‹åˆ—è¡¨ ========== */
    .course-item {
      background: white;
      border: 1.5px solid var(--slate-200);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .course-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--blue-500);
      transition: width 0.3s ease;
    }

    .course-item:hover {
      border-color: var(--blue-500);
      transform: translateX(4px);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.12);
    }

    .course-item:hover::before {
      width: 6px;
    }

    .course-badge {
      padding: 6px 14px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge-blue {
      background: rgba(59, 130, 246, 0.1);
      color: var(--blue-600);
    }

    .badge-emerald {
      background: rgba(16, 185, 129, 0.1);
      color: var(--emerald-600);
    }

    .badge-amber {
      background: rgba(245, 158, 11, 0.1);
      color: #d97706;
    }

    /* ========== Modal ç¾ä»£åŒ–è¨­è¨ˆ ========== */
    .modal-card {
      background: rgba(255, 255, 255, 0.98) !important;
      backdrop-filter: blur(30px) saturate(180%);
      -webkit-backdrop-filter: blur(30px) saturate(180%);
      border: 1px solid var(--slate-200);
      border-radius: 24px !important;
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.25);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      max-height: 90vh;
      width: 90%;
      max-width: 800px;
    }

    .modal-header {
      padding: 28px 32px;
      background: linear-gradient(135deg, var(--slate-50), white);
      border-bottom: 1px solid var(--slate-200);
      flex-shrink: 0;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--slate-900);
    }

    .modal-content {
      padding: 28px 32px;
      flex-grow: 1;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--slate-300) transparent;
    }

    .modal-content::-webkit-scrollbar {
      width: 6px;
    }

    .modal-content::-webkit-scrollbar-thumb {
      background-color: var(--slate-300);
      border-radius: 10px;
    }

    .modal-footer {
      padding: 24px 32px;
      background: var(--slate-50);
      border-top: 1px solid var(--slate-200);
      flex-shrink: 0;
    }

    /* ========== èª²ç¨‹è©•é‘‘è¡¨å–® ========== */
    .rating-stars {
      display: flex;
      gap: 8px;
      font-size: 32px;
    }

    .rating-star {
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--slate-300);
    }

    .rating-star:hover,
    .rating-star.active {
      color: #fbbf24;
      transform: scale(1.1);
    }

    .evaluation-section {
      background: var(--slate-50);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid var(--slate-200);
    }

    .evaluation-criteria {
      display: grid;
      gap: 20px;
    }

    .criteria-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: white;
      border-radius: 12px;
      border: 1px solid var(--slate-200);
    }

    .criteria-label {
      font-weight: 600;
      color: var(--slate-700);
    }

    .criteria-score {
      display: flex;
      gap: 6px;
    }

    .score-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid var(--slate-300);
      background: white;
      color: var(--slate-600);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .score-btn:hover {
      border-color: var(--blue-500);
      background: var(--blue-50);
      color: var(--blue-600);
      transform: scale(1.1);
    }

    .score-btn.selected {
      border-color: var(--blue-500);
      background: var(--blue-500);
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    /* ========== æŒ‰éˆ•ç³»çµ± ========== */
    .modern-btn {
      background: var(--blue-500);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .modern-btn:hover {
      background: var(--blue-600);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.35);
    }

    .modern-btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--slate-100);
      color: var(--slate-700);
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.1);
    }

    .btn-secondary:hover {
      background: var(--slate-200);
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.15);
    }

    /* ========== å‹•ç•« ========== */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .slide-in {
      animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ========== éŸ¿æ‡‰å¼è¨­è¨ˆ ========== */
    @media (max-width: 1024px) {
      .lg\\:col-span-1, .lg\\:col-span-3 {
        grid-column: span 1 !important;
      }

      .calendar-grid-container {
        display: none;
      }

      .mobile-calendar-view {
        display: block !important;
      }
    }

    .mobile-calendar-view {
      display: none;
    }

    /* ========== å¾®å¦™çš„èƒŒæ™¯ç´‹ç† ========== */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(168, 85, 247, 0.06) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }
  </style>

  <!-- API å±¤ï¼šèˆ‡å¾Œç«¯é€šè¨Š -->
  <script src="js/api.js"></script>
</head>
<body>
  <!-- Authentication -->
  <script src="js/auth.js"></script>
  <script>
    protectPage(['admin', 'teacher']);
  </script>

  <!-- å…¨å±å®¹å™¨ï¼š4 æ å¸ƒå±€ -->
  <div class="min-h-screen bg-slate-50">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-0 min-h-screen">

      <!-- ==================== å·¦å´å¸«è³‡åˆ—è¡¨å´é‚Šæ¬„ (1/4) ==================== -->
      <aside class="lg:col-span-1 bg-white border-r border-slate-200 overflow-y-auto" style="max-height: 100vh;">
        <!-- å›ºå®šé ‚éƒ¨ï¼šæ¨™é¡Œå’Œæœå°‹ -->
        <div class="sticky top-0 bg-white z-10 border-b border-slate-200 p-6">
          <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <i class="ph ph-users-three text-2xl"></i>
            å¸«è³‡åˆ—è¡¨
          </h2>
          <input
            type="text"
            id="sidebarTeacherSearch"
            placeholder="ğŸ” æœå°‹å¸«è³‡å§“å..."
            oninput="filterSidebarTeachers()"
            class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">

          <!-- å¿«é€Ÿéæ¿¾æŒ‰éˆ• -->
          <div class="mt-3 flex gap-2">
            <button onclick="filterByStatus('all')" class="flex-1 px-3 py-1.5 text-xs bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-all">
              å…¨éƒ¨
            </button>
            <button onclick="filterByStatus('é”æ¨™')" class="flex-1 px-3 py-1.5 text-xs bg-emerald-50 text-emerald-700 rounded-lg hover:bg-emerald-100 transition-all">
              å·²é”æ¨™
            </button>
            <button onclick="filterByStatus('æœªé”æ¨™')" class="flex-1 px-3 py-1.5 text-xs bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition-all">
              æœªé”æ¨™
            </button>
          </div>
        </div>

        <!-- å¸«è³‡å¡ç‰‡åˆ—è¡¨ -->
        <div id="sidebarTeacherList" class="p-4 space-y-3">
          <!-- å¸«è³‡å¡ç‰‡å°‡åœ¨é€™è£¡å‹•æ…‹æ¸²æŸ“ -->
        </div>
      </aside>

      <!-- ==================== ä¸»å…§å®¹å€ (3/4) ==================== -->
      <main class="lg:col-span-3 overflow-y-auto p-6 pb-20" style="max-height: 100vh;">
        <!-- è¿”å›é¦–é  -->
        <div class="mb-6">
          <a href="index.html" class="inline-flex items-center px-4 py-2.5 font-medium text-slate-700 bg-white border border-slate-300 rounded-xl hover:bg-slate-50 shadow-sm hover:shadow transition-all">
            <i class="ph ph-arrow-left mr-2"></i> è¿”å›é¦–é 
          </a>
        </div>

        <!-- æ¨™é¡Œå€åŸŸ -->
        <div class="mb-8">
          <h1 class="text-5xl font-bold text-slate-900 mb-2 tracking-tight">è¨“ç·´æ’ç¨‹</h1>
          <p class="text-lg text-slate-600">æ™ºèƒ½ç®¡ç†å¹³å° - ç¾ä»£åŒ–è¨­è¨ˆ</p>
        </div>

        <!-- åŒæ­¥ç‹€æ…‹æç¤º -->
        <div id="syncStatusBanner" class="card p-4 mb-6 hidden border border-transparent" role="alert" aria-live="polite">
          <div class="flex items-start justify-between gap-4">
            <div class="flex items-start gap-3">
              <span id="syncStatusIcon" class="text-2xl">â„¹ï¸</span>
              <div>
                <p id="syncStatusText" class="font-semibold text-slate-800"></p>
                <p id="syncStatusHint" class="text-sm text-slate-600 mt-1" style="display: none;"></p>
              </div>
            </div>
            <button type="button" onclick="dismissSyncStatus()" class="text-slate-400 hover:text-slate-600 transition" aria-label="é—œé–‰æé†’">
              <i class="ph ph-x"></i>
            </button>
          </div>
        </div>

        <!-- ä¸»å…§å®¹å®¹å™¨ -->
        <div class="max-w-7xl mx-auto space-y-6">

          <!-- ==================== å‹•æ…‹çµ±è¨ˆå¡ç‰‡å€ ==================== -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 fade-in">
            <!-- ç¸½èª²ç¨‹æ•¸ -->
            <div class="stat-card card-hover">
              <div class="flex items-center justify-between">
                <div class="relative z-10">
                  <p class="text-slate-600 mb-1 text-sm font-medium">ç¸½èª²ç¨‹æ•¸</p>
                  <p id="totalCoursesCount" class="text-4xl font-bold text-slate-900">0</p>
                </div>
                <div class="text-5xl opacity-60">
                  <i class="ph ph-books"></i>
                </div>
              </div>
            </div>

            <!-- ç¸½æˆèª²æ™‚æ•¸ -->
            <div class="stat-card card-hover emerald">
              <div class="flex items-center justify-between">
                <div class="relative z-10">
                  <p class="text-emerald-700 mb-1 text-sm font-medium">ç¸½æˆèª²æ™‚æ•¸</p>
                  <p id="totalHoursCount" class="text-4xl font-bold text-emerald-900">0</p>
                </div>
                <div class="text-5xl text-emerald-500 opacity-60">
                  <i class="ph ph-clock"></i>
                </div>
              </div>
            </div>

            <!-- æœ¬æœˆæ™‚æ•¸ -->
            <div class="stat-card card-hover blue">
              <div class="flex items-center justify-between">
                <div class="relative z-10">
                  <p class="text-blue-700 mb-1 text-sm font-medium">æœ¬æœˆç¸½æ™‚æ•¸</p>
                  <p id="monthlyHoursCount" class="text-4xl font-bold text-blue-900">0</p>
                </div>
                <div class="text-5xl text-blue-500 opacity-60">
                  <i class="ph ph-chart-bar"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- ==================== å¸«è³‡ç¯©é¸æ©«å¹… ==================== -->
          <div id="selectedTeacherBanner" class="card p-5 fade-in" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="text-3xl text-white">
                  <i class="ph ph-funnel"></i>
                </div>
                <div class="text-white">
                  <p class="text-sm opacity-90">ç¯©é¸å¸«è³‡</p>
                  <p id="selectedTeacherName" class="text-xl font-bold"></p>
                </div>
              </div>
              <button onclick="clearTeacherSelection()" class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-xl font-medium transition-all backdrop-blur-sm">
                <i class="ph ph-x"></i> æ¸…é™¤
              </button>
            </div>
          </div>

          <!-- æ—¥æœŸç¯©é¸æ©«å¹… -->
          <div id="selectedDateBanner" class="card p-5 fade-in" style="display: none; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="text-3xl text-white">
                  <i class="ph ph-calendar-check"></i>
                </div>
                <div class="text-white">
                  <p class="text-sm opacity-90">ç¯©é¸æ—¥æœŸ</p>
                  <p id="selectedDateText" class="text-xl font-bold"></p>
                </div>
              </div>
              <button onclick="clearDateSelection()" class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-xl font-medium transition-all backdrop-blur-sm">
                <i class="ph ph-x"></i> æ¸…é™¤
              </button>
            </div>
          </div>

          <!-- ==================== èª²ç¨‹è¡Œäº‹æ›† ==================== -->
          <div class="card p-6 fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
              <div class="flex items-center gap-3">
                <h2 class="text-2xl font-bold text-slate-900">
                  <i class="ph ph-calendar"></i> èª²ç¨‹è¡Œäº‹æ›†
                </h2>
                <button id="calendarToggleBtn" onclick="toggleCalendar()" class="p-2 hover:bg-slate-100 rounded-lg transition-all">
                  <i id="calendarToggleIcon" class="ph ph-caret-up text-slate-600"></i>
                </button>
              </div>
              <div class="flex items-center gap-3">
                <button onclick="openAddCourseModal()" class="modern-btn">
                  <i class="ph ph-plus-circle"></i> æ–°å¢èª²ç¨‹
                </button>
                <div class="flex rounded-xl p-1 bg-slate-100">
                  <button id="monthViewBtn" onclick="setViewMode('month')" class="px-4 py-2 rounded-lg text-sm font-semibold bg-white text-slate-900 shadow-sm">
                    <i class="ph ph-calendar"></i> æœˆ
                  </button>
                  <button id="weekViewBtn" onclick="setViewMode('week')" class="px-4 py-2 rounded-lg text-sm font-semibold text-slate-600">
                    <i class="ph ph-chart-bar"></i> å‘¨
                  </button>
                </div>
              </div>
            </div>

            <!-- è¡Œäº‹æ›†å®¹å™¨ï¼ˆå¯å±•é–‹/æ”¶åˆï¼‰-->
            <div id="calendarContainer" class="calendar-expanded">
              <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-4">
                  <button onclick="previousPeriod()" class="btn-secondary px-4 py-2 rounded-xl font-medium">
                    <i class="ph ph-caret-left"></i> <span id="prevLabel">ä¸Šå€‹æœˆ</span>
                  </button>
                  <h3 id="currentMonth" class="font-semibold text-slate-800 min-w-[200px] text-center text-lg"></h3>
                  <button onclick="nextPeriod()" class="btn-secondary px-4 py-2 rounded-xl font-medium">
                    <span id="nextLabel">ä¸‹å€‹æœˆ</span> <i class="ph ph-caret-right"></i>
                  </button>
                </div>
                <button onclick="goToToday()" class="modern-btn">
                  <i class="ph ph-crosshair"></i> ä»Šå¤©
                </button>
              </div>

              <!-- è¡Œäº‹æ›†ç¶²æ ¼ (æ¡Œé¢ç‰ˆ) -->
              <div class="calendar-grid-container bg-white rounded-xl overflow-hidden border border-slate-200 shadow-sm">
                <!-- æ˜ŸæœŸæ¨™é¡Œ -->
                <div class="grid grid-cols-7 bg-gradient-to-r from-blue-500 to-blue-600">
                  <div class="p-3 text-center font-semibold text-white border-r border-white/10">æ—¥</div>
                  <div class="p-3 text-center font-semibold text-white border-r border-white/10">ä¸€</div>
                  <div class="p-3 text-center font-semibold text-white border-r border-white/10">äºŒ</div>
                  <div class="p-3 text-center font-semibold text-white border-r border-white/10">ä¸‰</div>
                  <div class="p-3 text-center font-semibold text-white border-r border-white/10">å››</div>
                  <div class="p-3 text-center font-semibold text-white border-r border-white/10">äº”</div>
                  <div class="p-3 text-center font-semibold text-white">å…­</div>
                </div>
                <!-- æ—¥æœŸç¶²æ ¼ -->
                <div id="calendarGrid" class="grid grid-cols-7"></div>
              </div>

              <!-- æ‰‹æ©Ÿç‰ˆè¡Œäº‹æ›†åˆ—è¡¨ -->
              <div class="mobile-calendar-view bg-white rounded-xl overflow-hidden shadow-sm border border-slate-200 p-4">
                <div id="mobileEventsList" class="space-y-3"></div>
              </div>
            </div>
          </div>

          <!-- ==================== èª²ç¨‹é¡å‹åˆ†å¸ƒï¼ˆSVG ç”œç”œåœˆåœ–ï¼‰==================== -->
          <div class="card p-6 fade-in">
            <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-2">
              <i class="ph ph-chart-donut"></i> èª²ç¨‹é¡å‹åˆ†å¸ƒ
            </h2>
            <div class="flex flex-col md:flex-row items-center justify-center gap-8">
              <!-- SVG ç”œç”œåœˆåœ– -->
              <div class="donut-chart-container">
                <svg id="donutChart" width="280" height="280" viewBox="0 0 280 280">
                  <!-- ç”œç”œåœˆåœ–å°‡åœ¨é€™è£¡å‹•æ…‹æ¸²æŸ“ -->
                </svg>
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                  <div class="text-center">
                    <div id="donutCenterCount" class="text-4xl font-bold text-slate-900">0</div>
                    <div class="text-sm text-slate-600">ç¸½èª²ç¨‹</div>
                  </div>
                </div>
              </div>

              <!-- åœ–ä¾‹ -->
              <div id="donutLegend" class="chart-legend flex-col">
                <!-- åœ–ä¾‹å°‡åœ¨é€™è£¡å‹•æ…‹æ¸²æŸ“ -->
              </div>
            </div>
          </div>

          <!-- ==================== å€‹äººå‰©é¤˜æ™‚æ•¸å¡ç‰‡ï¼ˆæ¼¸è®ŠèƒŒæ™¯ï¼‰==================== -->
          <div id="remainingHoursCard" class="hours-card fade-in" style="display: none;">
            <div class="flex items-center justify-between relative z-10">
              <div>
                <p class="text-white/80 text-sm mb-2">æœ¬æœˆå‰©é¤˜æ™‚æ•¸</p>
                <h3 id="remainingHoursTeacher" class="text-2xl font-bold text-white mb-1"></h3>
                <p id="remainingHoursValue" class="text-5xl font-bold text-white"></p>
                <p class="text-white/70 text-sm mt-2">ç›®æ¨™ï¼š12 å°æ™‚/æœˆ</p>
              </div>

              <!-- ç’°å½¢é€²åº¦åœ– -->
              <svg class="hours-progress-ring" viewBox="0 0 120 120">
                <circle
                  cx="60"
                  cy="60"
                  r="52"
                  fill="none"
                  stroke="rgba(255, 255, 255, 0.2)"
                  stroke-width="8"
                />
                <circle
                  id="progressCircle"
                  cx="60"
                  cy="60"
                  r="52"
                  fill="none"
                  stroke="white"
                  stroke-width="8"
                  stroke-linecap="round"
                  stroke-dasharray="326.7"
                  stroke-dashoffset="326.7"
                  transform="rotate(-90 60 60)"
                  style="transition: stroke-dashoffset 1s ease;"
                />
                <text x="60" y="65" text-anchor="middle" fill="white" font-size="24" font-weight="bold" id="progressPercent">0%</text>
              </svg>
            </div>
          </div>

          <!-- ==================== ç¾ä»£åŒ–èª²ç¨‹åˆ—è¡¨ ==================== -->
          <div class="card p-6 fade-in">
            <div class="flex items-center justify-between mb-6">
              <h2 id="courseOverviewTitle" class="text-2xl font-bold text-slate-900 flex items-center gap-2">
                <i class="ph ph-list-bullets"></i> ä»Šæ—¥èª²ç¨‹ç¸½è¦½
              </h2>
              <div class="text-slate-600" id="todayDate"></div>
            </div>
            <div id="todayCoursesContainer" class="space-y-3">
              <!-- èª²ç¨‹é …å°‡åœ¨é€™è£¡é¡¯ç¤º -->
            </div>
          </div>

        </div>
      </main>

    </div>
  </div>

  <!-- ==================== Modals ==================== -->

  <!-- æ–°å¢èª²ç¨‹ Modal -->
  <div id="addCourseModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
    <div class="modal-card">
      <!-- Modal é ­éƒ¨ -->
      <div class="modal-header">
        <h3><i class="ph ph-plus-circle"></i> æ–°å¢èª²ç¨‹</h3>
      </div>

      <!-- Modal å…§å®¹å€ -->
      <div class="modal-content">
        <form id="courseForm" class="space-y-4">
          <div>
            <label class="block font-semibold text-slate-700 mb-2">é¸æ“‡å¸«è³‡</label>
            <select id="courseTeacherId" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" required>
              <option value="">è«‹é¸æ“‡å¸«è³‡</option>
            </select>
          </div>

          <div>
            <label class="block font-semibold text-slate-700 mb-2">èª²ç¨‹åç¨±</label>
            <select id="courseName" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" required>
              <option value="">è«‹é¸æ“‡èª²ç¨‹</option>
            </select>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block font-semibold text-slate-700 mb-2">èª²ç¨‹æ—¥æœŸ</label>
              <input type="date" id="courseDate" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" required>
            </div>
            <div>
              <label class="block font-semibold text-slate-700 mb-2">èª²ç¨‹é¡å‹</label>
              <select id="courseType" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                <option value="æ­£èª²">æ­£èª²</option>
                <option value="è£œèª²">è£œèª²</option>
                <option value="å¯¦é©—èª²">å¯¦é©—èª²</option>
                <option value="å¯¦ä½œèª²">å¯¦ä½œèª²</option>
                <option value="å°ˆé¡Œ">å°ˆé¡Œ</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block font-semibold text-slate-700 mb-2">é–‹å§‹æ™‚é–“</label>
              <input type="time" id="startTime" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" required>
            </div>
            <div>
              <label class="block font-semibold text-slate-700 mb-2">çµæŸæ™‚é–“</label>
              <input type="time" id="endTime" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" required>
            </div>
          </div>

          <div>
            <label class="block font-semibold text-slate-700 mb-2">ç‹€æ…‹</label>
            <select id="courseStatus" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" required>
              <option value="ä¸Šç­">ä¸Šç­</option>
              <option value="ä¼‘å‡">ä¼‘å‡</option>
              <option value="å‡ºå·®">å‡ºå·®</option>
            </select>
          </div>

          <div>
            <label class="block font-semibold text-slate-700 mb-2">å‚™è¨»</label>
            <textarea id="courseNote" rows="3" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="é¸å¡«ï¼šèª²ç¨‹ç›¸é—œå‚™è¨»..."></textarea>
          </div>
        </form>
      </div>

      <!-- Modal åº•éƒ¨ -->
      <div class="modal-footer">
        <div class="flex justify-end gap-3">
          <button type="button" onclick="closeAddCourseModal()" class="btn-secondary px-6 py-3 rounded-xl font-semibold">
            å–æ¶ˆ
          </button>
          <button type="button" onclick="document.getElementById('courseForm').requestSubmit()" class="modern-btn px-6 py-3">
            <i class="ph ph-check-circle"></i> ç¢ºèªæ–°å¢
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- æŸ¥çœ‹/ç·¨è¼¯èª²ç¨‹ Modal -->
  <div id="viewEventModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
    <div class="modal-card">
      <!-- Modal å¤´éƒ¨ -->
      <div class="modal-header">
        <h3 id="modalTitle"><i class="ph ph-info"></i> èª²ç¨‹è©³æƒ…</h3>
      </div>

      <!-- Modal å…§å®¹åŒº -->
      <div class="modal-content">
        <!-- æŸ¥çœ‹æ¨¡å¼ -->
        <div id="viewMode" class="space-y-4"></div>

        <!-- ç·¨è¼¯æ¨¡å¼ -->
        <form id="editCourseForm" class="space-y-4" style="display: none;">
          <div>
            <label class="block font-semibold text-slate-700 mb-2">é¸æ“‡å¸«è³‡</label>
            <select id="editTeacherId" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" required>
              <option value="">è¯·é¸æ“‡å¸«è³‡</option>
            </select>
          </div>

          <div>
            <label class="block font-semibold text-slate-700 mb-2">èª²ç¨‹åç§°</label>
            <input type="text" id="editCourseName" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" required>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block font-semibold text-slate-700 mb-2">èª²ç¨‹æ—¥æœŸ</label>
              <input type="date" id="editCourseDate" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" required>
            </div>
            <div>
              <label class="block font-semibold text-slate-700 mb-2">èª²ç¨‹é¡å‹</label>
              <select id="editCourseType" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                <option value="æ­£èª²">æ­£èª²</option>
                <option value="è£œèª²">è£œèª²</option>
                <option value="å¯¦é©—è¯¾">å¯¦é©—è¯¾</option>
                <option value="å¯¦ä½œè¯¾">å¯¦ä½œè¯¾</option>
                <option value="å°ˆé¡Œ">å°ˆé¡Œ</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block font-semibold text-slate-700 mb-2">é–‹å§‹æ™‚é–“</label>
              <input type="time" id="editStartTime" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" required>
            </div>
            <div>
              <label class="block font-semibold text-slate-700 mb-2">çµæŸæ™‚é–“</label>
              <input type="time" id="editEndTime" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" required>
            </div>
          </div>

          <div>
            <label class="block font-semibold text-slate-700 mb-2">ç‹€æ…‹</label>
            <select id="editCourseStatus" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" required>
              <option value="ä¸Šç­">ä¸Šç­</option>
              <option value="ä¼‘å‡">ä¼‘å‡</option>
              <option value="å‡ºå·®">å‡ºå·®</option>
            </select>
          </div>

          <div>
            <label class="block font-semibold text-slate-700 mb-2">å‚™è¨»</label>
            <textarea id="editCourseNote" rows="3" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="é¸å¡«ï¼šèª²ç¨‹ç›¸é—œå‚™è¨»..."></textarea>
          </div>
        </form>
      </div>

      <!-- Modal åº•éƒ¨ -->
      <div class="modal-footer">
        <!-- æŸ¥çœ‹æ¨¡å¼æŒ‰é’® -->
        <div id="viewModeButtons" class="flex flex-wrap gap-3 items-center">
          <button onclick="openEvaluationModal()" class="btn-secondary flex-1">
            <i class="ph ph-star"></i> èª²ç¨‹è©•é‘‘
          </button>
          <button onclick="closeViewEventModal()" class="btn-secondary">
            é—œé–‰
          </button>
          <button onclick="enterEditMode()" class="modern-btn">
            <i class="ph ph-pencil"></i> ç·¨è¼¯
          </button>
        </div>

        <!-- ç·¨è¼¯æ¨¡å¼æŒ‰é’® -->
        <div id="editModeButtons" class="flex justify-end gap-3" style="display: none;">
          <button onclick="cancelEditMode()" class="btn-secondary px-6 py-3">
            å–æ¶ˆ
          </button>
          <button onclick="saveEditedCourse()" class="modern-btn px-6 py-3">
            <i class="ph ph-check-circle"></i> ä¿å­˜è®Šæ›´
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== èª²ç¨‹è©•é‘‘ Modal ==================== -->
  <div id="evaluationModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[60] p-4 backdrop-blur-sm">
    <div class="modal-card">
      <!-- Modal å¤´éƒ¨ -->
      <div class="modal-header">
        <h3><i class="ph ph-star"></i> èª²ç¨‹è©•é‘‘</h3>
      </div>

      <!-- Modal å…§å®¹åŒº -->
      <div class="modal-content">
        <!-- æ•´ä½“è©•åˆ† -->
        <div class="evaluation-section">
          <h4 class="text-lg font-bold text-slate-900 mb-3">æ•´ä½“è©•åˆ†</h4>
          <div class="flex items-center justify-center gap-2 mb-4">
            <div class="rating-stars" id="overallRating">
              <span class="rating-star" data-value="1">â˜…</span>
              <span class="rating-star" data-value="2">â˜…</span>
              <span class="rating-star" data-value="3">â˜…</span>
              <span class="rating-star" data-value="4">â˜…</span>
              <span class="rating-star" data-value="5">â˜…</span>
            </div>
          </div>
          <p id="ratingText" class="text-center text-slate-600 text-sm">è¯·é¸æ“‡è©•åˆ†</p>
        </div>

        <!-- è©³ç´°è©•åˆ†æ¨™æº– -->
        <div class="evaluation-section">
          <h4 class="text-lg font-bold text-slate-900 mb-4">è©³ç´°è©•åˆ†ï¼ˆ1-5åˆ†ï¼‰</h4>
          <div class="evaluation-criteria">
            <!-- æ•™å­¦å…§å®¹ -->
            <div class="criteria-item">
              <span class="criteria-label">æ•™å­¦å…§å®¹å……å®åº¦</span>
              <div class="criteria-score" id="contentScore">
                <button class="score-btn" data-criteria="content" data-score="1">1</button>
                <button class="score-btn" data-criteria="content" data-score="2">2</button>
                <button class="score-btn" data-criteria="content" data-score="3">3</button>
                <button class="score-btn" data-criteria="content" data-score="4">4</button>
                <button class="score-btn" data-criteria="content" data-score="5">5</button>
              </div>
            </div>

            <!-- æ•™å­¦æ–¹æ³• -->
            <div class="criteria-item">
              <span class="criteria-label">æ•™å­¦æ–¹æ³•æœ‰æ•ˆæ€§</span>
              <div class="criteria-score" id="methodScore">
                <button class="score-btn" data-criteria="method" data-score="1">1</button>
                <button class="score-btn" data-criteria="method" data-score="2">2</button>
                <button class="score-btn" data-criteria="method" data-score="3">3</button>
                <button class="score-btn" data-criteria="method" data-score="4">4</button>
                <button class="score-btn" data-criteria="method" data-score="5">5</button>
              </div>
            </div>

            <!-- å¸ˆç”Ÿäº’åŠ¨ -->
            <div class="criteria-item">
              <span class="criteria-label">å¸ˆç”Ÿäº’åŠ¨è´¨é‡</span>
              <div class="criteria-score" id="interactionScore">
                <button class="score-btn" data-criteria="interaction" data-score="1">1</button>
                <button class="score-btn" data-criteria="interaction" data-score="2">2</button>
                <button class="score-btn" data-criteria="interaction" data-score="3">3</button>
                <button class="score-btn" data-criteria="interaction" data-score="4">4</button>
                <button class="score-btn" data-criteria="interaction" data-score="5">5</button>
              </div>
            </div>

            <!-- æ•™æä½¿ç”¨ -->
            <div class="criteria-item">
              <span class="criteria-label">æ•™æä½¿ç”¨é€‚å½“æ€§</span>
              <div class="criteria-score" id="materialScore">
                <button class="score-btn" data-criteria="material" data-score="1">1</button>
                <button class="score-btn" data-criteria="material" data-score="2">2</button>
                <button class="score-btn" data-criteria="material" data-score="3">3</button>
                <button class="score-btn" data-criteria="material" data-score="4">4</button>
                <button class="score-btn" data-criteria="material" data-score="5">5</button>
              </div>
            </div>

            <!-- æ™‚é–“ç®¡ç† -->
            <div class="criteria-item">
              <span class="criteria-label">æ™‚é–“ç®¡ç†èƒ½åŠ›</span>
              <div class="criteria-score" id="timeScore">
                <button class="score-btn" data-criteria="time" data-score="1">1</button>
                <button class="score-btn" data-criteria="time" data-score="2">2</button>
                <button class="score-btn" data-criteria="time" data-score="3">3</button>
                <button class="score-btn" data-criteria="time" data-score="4">4</button>
                <button class="score-btn" data-criteria="time" data-score="5">5</button>
              </div>
            </div>
          </div>
        </div>

        <!-- æ–‡å­—è©•èª -->
        <div class="evaluation-section">
          <h4 class="text-lg font-bold text-slate-900 mb-3">æ–‡å­—è©•èª</h4>
          <textarea
            id="evaluationComment"
            rows="4"
            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none"
            placeholder="è¯·è¼¸å…¥æ‚¨å¯¹æœ¬æ¬¡èª²ç¨‹çš„å»ºè®®å’Œè©•èª..."></textarea>
        </div>

        <!-- è©•é‘‘ç»“æœæ‘˜è¦ -->
        <div id="evaluationSummary" class="evaluation-section" style="display: none;">
          <h4 class="text-lg font-bold text-slate-900 mb-3">è©•é‘‘æ‘˜è¦</h4>
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded-xl border border-slate-200">
              <p class="text-sm text-slate-600 mb-1">ç¶œåˆå¾—åˆ†</p>
              <p id="summaryAverage" class="text-3xl font-bold text-blue-600">-</p>
            </div>
            <div class="bg-white p-4 rounded-xl border border-slate-200">
              <p class="text-sm text-slate-600 mb-1">è©•é‘‘ç­‰çº§</p>
              <p id="summaryGrade" class="text-3xl font-bold text-emerald-600">-</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal åº•éƒ¨ -->
      <div class="modal-footer">
        <div class="flex justify-end gap-3">
          <button onclick="closeEvaluationModal()" class="btn-secondary px-6 py-3">
            å–æ¶ˆ
          </button>
          <button onclick="submitEvaluation()" class="modern-btn px-6 py-3">
            <i class="ph ph-check-circle"></i> æäº¤è©•é‘‘
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- è¤‡è£½åˆ°å…¶ä»–æ—¥æœŸ Modal -->
  <div id="duplicateDateModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[60] p-4 backdrop-blur-sm">
    <div class="modal-card" style="max-width: 480px;">
      <div class="modal-header">
        <h3><i class="ph ph-copy"></i> è¤‡è£½åˆ°å…¶ä»–æ—¥æœŸ</h3>
      </div>
      <div class="modal-content">
        <div class="space-y-4">
          <div>
            <label class="block font-semibold text-slate-700 mb-2">é¸æ“‡æ–°æ—¥æœŸ</label>
            <input type="date" id="duplicateNewDate" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" required>
          </div>
          <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
            <p class="text-sm text-blue-800">
              <i class="ph ph-info mr-2"></i>
              èª²ç¨‹å°†ä¼šä¿ç•™æ‰€æœ‰ä¿¡æ¯ï¼ˆå¸«è³‡ã€æ™‚é–“ã€å‚™è¨»ç­‰ï¼‰ï¼Œåƒ…æ›´æ”¹æ—¥æœŸã€‚
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="flex justify-end gap-3">
          <button onclick="closeDuplicateDateModal()" class="btn-secondary px-6 py-3">
            å–æ¶ˆ
          </button>
          <button onclick="confirmDuplicateCourse()" class="modern-btn px-6 py-3">
            <i class="ph ph-check-circle"></i> ç¢ºèªè¤‡è£½
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- iOS é£æ ¼çš„å¼¹å‡ºå¼æ“ä½œèœå• -->
  <div class="context-menu-overlay" id="contextMenuOverlay" onclick="closeContextMenu()" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 9999; display: none; opacity: 0; transition: opacity 0.2s;">
    <div class="context-menu-popup" onclick="event.stopPropagation()" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 320px; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
      <div class="menu-option" onclick="copyCourseToClipboard(); closeContextMenu();" style="padding: 16px 20px; border-bottom: 1px solid var(--slate-200); cursor: pointer; transition: background 0.1s;">
        <span>è¤‡è£½</span>
        <i class="ph ph-copy"></i>
      </div>
      <div class="menu-option" onclick="openDuplicateDateModal(); closeContextMenu();" style="padding: 16px 20px; border-bottom: 1px solid var(--slate-200); cursor: pointer; transition: background 0.1s;">
        <span>è¤‡è£½åˆ°å…¶ä»–æ—¥æœŸ</span>
        <i class="ph ph-calendar-plus"></i>
      </div>
      <div class="menu-option" onclick="shareCourse(); closeContextMenu();" style="padding: 16px 20px; border-bottom: 1px solid var(--slate-200); cursor: pointer; transition: background 0.1s;">
        <span>åˆ†äº«</span>
        <i class="ph ph-share-network"></i>
      </div>
      <div class="menu-option" onclick="confirmDeleteCourse(); closeContextMenu();" style="padding: 16px 20px; cursor: pointer; transition: background 0.1s; color: var(--red-500);">
        <span>åˆªé™¤</span>
        <i class="ph ph-trash"></i>
      </div>
    </div>
  </div>

  <script>
    // ==================== æ•¸æ“šç®¡ç† ====================
    const loadArray = typeof loadArrayFromStorage === 'function'
      ? loadArrayFromStorage
      : function fallbackLoadArray(key, normalizer) {
          const raw = localStorage.getItem(key);
          if (!raw) return [];
          try {
            const parsed = JSON.parse(raw);
            if (!Array.isArray(parsed)) return [];
            return typeof normalizer === 'function' ? parsed.map(normalizer) : parsed;
          } catch (error) {
            console.warn('âš ï¸ ç„¡æ³•è§£æ ' + key + 'ï¼š', error);
            return [];
          }
        };

    let teachers = loadArray('teachers', typeof normalizeTeacherRecord === 'function' ? normalizeTeacherRecord : undefined);
    let courseAssignments = loadArray('courseAssignments', typeof normalizeCourseAssignment === 'function' ? normalizeCourseAssignment : undefined);
    let calendarEvents = loadArray('calendarEvents');

    let currentDate = new Date();
    let viewMode = 'month';
    let courseTypeChart = null;
    let showAllTeachers = false;
    let teacherSearchQuery = '';
    let selectedTeacherId = null;
    let editingCourseId = null;
    let selectedDate = null;
    let currentCourseId = null;
    let sidebarFilterStatus = 'all';
    let isCalendarExpanded = true;
    let evaluationData = {};

    function saveData() {
      try {
        localStorage.setItem('teachers', JSON.stringify(teachers));
        localStorage.setItem('courseAssignments', JSON.stringify(courseAssignments));
        localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
        if (typeof syncToServer === 'function') {
          syncToServer();
        }
      } catch (error) {
        console.error('ä¿å­˜æ•¸æ“šå¤±è´¥:', error);
      }
    }

    // ==================== æ–°åŠŸèƒ½ï¼šå¸«è³‡ä¾§è¾¹æ æ¸²æŸ“ ====================
    function renderSidebarTeachers() {
      const container = document.getElementById('sidebarTeacherList');
      if (!container) return;

      const thisMonth = new Date().toISOString().slice(0, 7);
      const teachersWithHours = teachers.map(teacher => {
        const courses = courseAssignments.filter(c =>
          c.teacherId === teacher.id &&
          c.date.startsWith(thisMonth)
        );
        const hours = courses.reduce((sum, c) => sum + calculateHours(c.time), 0);
        const targetHours = teacher.targetHours || 12;
        const remainingHours = Math.max(0, targetHours - hours);
        const status = hours >= targetHours ? 'é”æ¨™' : 'æœªé”æ¨™';
        
        return { teacher, hours, courses: courses.length, remainingHours, status };
      });

      const searchQuery = (document.getElementById('sidebarTeacherSearch')?.value || '').toLowerCase();
      let filteredTeachers = teachersWithHours.filter(item =>
        item.teacher.name.toLowerCase().includes(searchQuery)
      );

      if (sidebarFilterStatus !== 'all') {
        filteredTeachers = filteredTeachers.filter(item => item.status === sidebarFilterStatus);
      }

      filteredTeachers.sort((a, b) => {
        if (a.status !== b.status) {
          return a.status === 'æœªé”æ¨™' ? -1 : 1;
        }
        return b.remainingHours - a.remainingHours;
      });

      if (filteredTeachers.length === 0) {
        container.innerHTML = '<p class="text-slate-500 text-center py-8 text-sm">æœªæ‰¾åˆ°åŒ¹é…çš„å¸«è³‡</p>';
        return;
      }

      container.innerHTML = filteredTeachers.map(item => {
        const isSelected = selectedTeacherId === item.teacher.id;
        const percentage = Math.min((item.hours / (item.teacher.targetHours || 12)) * 100, 100);
        const statusColor = item.status === 'é”æ¨™' ? 'emerald' : 'red';
        const initials = item.teacher.name.charAt(0);

        return '<div class="teacher-card ' + (isSelected ? 'selected' : '') + '" onclick="selectTeacher(' + item.teacher.id + ')">' +
          '<div class="flex items-center gap-3 mb-2">' +
            '<div class="teacher-avatar">' + initials + '</div>' +
            '<div class="flex-1 min-w-0">' +
              '<h4 class="font-bold text-slate-900 truncate">' + item.teacher.name + '</h4>' +
              '<p class="text-xs text-slate-600">' + item.courses + ' é—¨èª²ç¨‹</p>' +
            '</div>' +
            '<span class="px-2 py-1 text-xs font-semibold rounded-lg bg-' + statusColor + '-100 text-' + statusColor + '-700">' +
              item.status +
            '</span>' +
          '</div>' +
          '<div class="space-y-1.5">' +
            '<div class="flex justify-between text-xs text-slate-600">' +
              '<span>æœ¬æœˆæ™‚æ•¸</span>' +
              '<span class="font-bold text-slate-900">' + item.hours.toFixed(1) + 'h / ' + (item.teacher.targetHours || 12) + 'h</span>' +
            '</div>' +
            '<div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden">' +
              '<div class="bg-gradient-to-r from-blue-500 to-purple-500 h-full rounded-full transition-all duration-500" style="width: ' + percentage + '%"></div>' +
            '</div>' +
            (item.status === 'æœªé”æ¨™' ? '<p class="text-xs text-slate-600 mt-1"><i class="ph ph-clock"></i> é‚„éœ€ ' + item.remainingHours.toFixed(1) + ' å°æ—¶</p>' : '') +
          '</div>' +
        '</div>';
      }).join('');
    }

    function filterSidebarTeachers() {
      renderSidebarTeachers();
    }

    function filterByStatus(status) {
      sidebarFilterStatus = status;
      renderSidebarTeachers();
    }

    // ==================== æ–°åŠŸèƒ½ï¼šSVG ç”œç”œåœˆåœ– ====================
    function renderDonutChart() {
      const svg = document.getElementById('donutChart');
      const legendContainer = document.getElementById('donutLegend');
      const centerCount = document.getElementById('donutCenterCount');
      
      if (!svg || !legendContainer || !centerCount) return;

      let filteredCourses = courseAssignments;
      if (selectedTeacherId) {
        filteredCourses = courseAssignments.filter(c => c.teacherId === selectedTeacherId);
      }
      if (selectedDate) {
        filteredCourses = filteredCourses.filter(c => c.date === selectedDate);
      }

      const typeCount = {};
      const typeColors = {
        'æ­£èª²': '#3b82f6',
        'è£œèª²': '#f59e0b',
        'å¯¦é©—è¯¾': '#a855f7',
        'å¯¦ä½œè¯¾': '#10b981',
        'å°ˆé¡Œ': '#ef4444'
      };

      filteredCourses.forEach(course => {
        const type = course.type || 'å…¶ä»–';
        typeCount[type] = (typeCount[type] || 0) + 1;
      });

      const total = filteredCourses.length;
      centerCount.textContent = total;

      if (total === 0) {
        svg.innerHTML = '<text x="140" y="140" text-anchor="middle" fill="#94a3b8" font-size="14">æš‚æ— æ•¸æ“š</text>';
        legendContainer.innerHTML = '<p class="text-slate-500 text-sm">æš‚æ— èª²ç¨‹æ•¸æ“š</p>';
        return;
      }

      const radius = 100;
      const innerRadius = 70;
      const cx = 140;
      const cy = 140;
      let currentAngle = -90;
      let segments = '';
      let legends = '';

      Object.entries(typeCount).forEach(([type, count]) => {
        const percentage = (count / total) * 100;
        const angle = (count / total) * 360;
        const endAngle = currentAngle + angle;

        const startX = cx + radius * Math.cos((currentAngle * Math.PI) / 180);
        const startY = cy + radius * Math.sin((currentAngle * Math.PI) / 180);
        const endX = cx + radius * Math.cos((endAngle * Math.PI) / 180);
        const endY = cy + radius * Math.sin((endAngle * Math.PI) / 180);

        const innerStartX = cx + innerRadius * Math.cos((currentAngle * Math.PI) / 180);
        const innerStartY = cy + innerRadius * Math.sin((currentAngle * Math.PI) / 180);
        const innerEndX = cx + innerRadius * Math.cos((endAngle * Math.PI) / 180);
        const innerEndY = cy + innerRadius * Math.sin((endAngle * Math.PI) / 180);

        const largeArcFlag = angle > 180 ? 1 : 0;

        const pathData = 'M ' + startX + ' ' + startY +
          ' A ' + radius + ' ' + radius + ' 0 ' + largeArcFlag + ' 1 ' + endX + ' ' + endY +
          ' L ' + innerEndX + ' ' + innerEndY +
          ' A ' + innerRadius + ' ' + innerRadius + ' 0 ' + largeArcFlag + ' 0 ' + innerStartX + ' ' + innerStartY +
          ' Z';

        const color = typeColors[type] || '#64748b';
        segments += '<path d="' + pathData + '" fill="' + color + '" class="donut-segment" opacity="0.9"><title>' + type + ': ' + count + ' é—¨ (' + percentage.toFixed(1) + '%)</title></path>';

        legends += '<div class="legend-item">' +
          '<div class="legend-color" style="background: ' + color + ';"></div>' +
          '<span class="text-sm text-slate-700 font-medium">' + type + '</span>' +
          '<span class="text-sm font-bold text-slate-900">' + count + '</span>' +
        '</div>';

        currentAngle = endAngle;
      });

      svg.innerHTML = segments;
      legendContainer.innerHTML = legends;
    }

    // ==================== æ–°åŠŸèƒ½ï¼šè¡Œäº‹å†å±•å¼€/æ”¶åˆ ====================
    function toggleCalendar() {
      const container = document.getElementById('calendarContainer');
      const icon = document.getElementById('calendarToggleIcon');
      
      if (!container || !icon) return;

      isCalendarExpanded = !isCalendarExpanded;

      if (isCalendarExpanded) {
        container.classList.remove('calendar-collapsed');
        container.classList.add('calendar-expanded');
        icon.className = 'ph ph-caret-up text-slate-600';
      } else {
        container.classList.remove('calendar-expanded');
        container.classList.add('calendar-collapsed');
        icon.className = 'ph ph-caret-down text-slate-600';
      }
    }

    // ==================== æ–°åŠŸèƒ½ï¼šå€‹äººå‰©é¤˜æ™‚æ•¸å¡ç‰‡ ====================
    function renderRemainingHoursCard() {
      const card = document.getElementById('remainingHoursCard');
      if (!card || !selectedTeacherId) {
        if (card) card.style.display = 'none';
        return;
      }

      const teacher = teachers.find(t => t.id === selectedTeacherId);
      if (!teacher) {
        card.style.display = 'none';
        return;
      }

      const thisMonth = new Date().toISOString().slice(0, 7);
      const courses = courseAssignments.filter(c =>
        c.teacherId === teacher.id &&
        c.date.startsWith(thisMonth)
      );
      const hours = courses.reduce((sum, c) => sum + calculateHours(c.time), 0);
      const targetHours = teacher.targetHours || 12;
      const remainingHours = Math.max(0, targetHours - hours);
      const percentage = Math.min((hours / targetHours) * 100, 100);

      document.getElementById('remainingHoursTeacher').textContent = teacher.name;
      document.getElementById('remainingHoursValue').textContent = remainingHours.toFixed(1) + 'h';
      document.getElementById('progressPercent').textContent = percentage.toFixed(0) + '%';

      const circle = document.getElementById('progressCircle');
      const circumference = 2 * Math.PI * 52;
      const offset = circumference - (percentage / 100) * circumference;
      circle.style.strokeDashoffset = offset;

      card.style.display = 'block';
    }

    // ==================== æ–°åŠŸèƒ½ï¼šèª²ç¨‹è©•é‘‘ ====================
    function openEvaluationModal() {
      const modal = document.getElementById('evaluationModal');
      if (!modal) return;

      evaluationData = {
        courseId: editingCourseId,
        overallRating: 0,
        contentScore: 0,
        methodScore: 0,
        interactionScore: 0,
        materialScore: 0,
        timeScore: 0,
        comment: ''
      };

      document.querySelectorAll('.rating-star').forEach(star => star.classList.remove('active'));
      document.querySelectorAll('.score-btn').forEach(btn => btn.classList.remove('selected'));
      document.getElementById('evaluationComment').value = '';
      document.getElementById('evaluationSummary').style.display = 'none';
      document.getElementById('ratingText').textContent = 'è¯·é¸æ“‡è©•åˆ†';

      modal.classList.remove('hidden');

      document.querySelectorAll('.rating-star').forEach(star => {
        star.onclick = function() {
          const value = parseInt(this.dataset.value);
          evaluationData.overallRating = value;
          
          document.querySelectorAll('.rating-star').forEach((s, index) => {
            if (index < value) {
              s.classList.add('active');
            } else {
              s.classList.remove('active');
            }
          });

          const texts = ['', 'å¾ˆå·®', 'è¾ƒå·®', 'ä¸€èˆ¬', 'è‰¯å¥½', 'ä¼˜ç§€'];
          document.getElementById('ratingText').textContent = texts[value] || '';
        };
      });

      document.querySelectorAll('.score-btn').forEach(btn => {
        btn.onclick = function() {
          const criteria = this.dataset.criteria;
          const score = parseInt(this.dataset.score);
          evaluationData[criteria + 'Score'] = score;

          const container = this.parentElement;
          container.querySelectorAll('.score-btn').forEach(b => b.classList.remove('selected'));
          this.classList.add('selected');

          updateEvaluationSummary();
        };
      });
    }

    function updateEvaluationSummary() {
      const scores = [
        evaluationData.contentScore,
        evaluationData.methodScore,
        evaluationData.interactionScore,
        evaluationData.materialScore,
        evaluationData.timeScore
      ].filter(s => s > 0);

      if (scores.length === 0) return;

      const average = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2);
      let grade = 'C';
      if (average >= 4.5) grade = 'A+';
      else if (average >= 4.0) grade = 'A';
      else if (average >= 3.5) grade = 'B+';
      else if (average >= 3.0) grade = 'B';
      else if (average >= 2.5) grade = 'C+';

      document.getElementById('summaryAverage').textContent = average;
      document.getElementById('summaryGrade').textContent = grade;
      document.getElementById('evaluationSummary').style.display = 'block';
    }

    function submitEvaluation() {
      if (evaluationData.overallRating === 0) {
        alert('è¯·é¸æ“‡æ•´ä½“è©•åˆ†ï¼');
        return;
      }

      const requiredScores = ['contentScore', 'methodScore', 'interactionScore', 'materialScore', 'timeScore'];
      const missingScores = requiredScores.filter(score => evaluationData[score] === 0);
      
      if (missingScores.length > 0) {
        alert('è¯·å®Œæˆæ‰€æœ‰è©³ç´°è©•åˆ†ï¼');
        return;
      }

      evaluationData.comment = document.getElementById('evaluationComment').value.trim();
      evaluationData.timestamp = new Date().toISOString();

      let evaluations = loadArray('courseEvaluations');
      evaluations.push(evaluationData);
      localStorage.setItem('courseEvaluations', JSON.stringify(evaluations));

      closeEvaluationModal();
      showMessage('èª²ç¨‹è©•é‘‘å·²æäº¤æˆåŠŸï¼', 'success');
    }

    function closeEvaluationModal() {

    // åŠ¨æ€çµ±è¨ˆå¡ç‰‡é¢œè‰²æ›´æ–°
    function updateStatCardColors() {
      const totalCard = document.querySelector('.stat-card:nth-child(1)');
      const hoursCard = document.querySelector('.stat-card:nth-child(2)');
      const monthlyCard = document.querySelector('.stat-card:nth-child(3)');

      if (selectedTeacherId || selectedDate) {
        if (totalCard) totalCard.classList.add('amber');
        if (hoursCard) hoursCard.classList.add('blue');
        if (monthlyCard) monthlyCard.classList.add('amber');
      } else {
        if (totalCard) totalCard.classList.remove('blue', 'emerald', 'amber');
        if (hoursCard) {
          hoursCard.classList.remove('blue', 'amber');
          hoursCard.classList.add('emerald');
        }
        if (monthlyCard) {
          monthlyCard.classList.remove('emerald', 'amber');
          monthlyCard.classList.add('blue');
        }
      }
    }
      const modal = document.getElementById('evaluationModal');

    // åŠ¨æ€çµ±è¨ˆå¡ç‰‡é¢œè‰²æ›´æ–°
    function updateStatCardColors() {
      const totalCard = document.querySelector('.stat-card:nth-child(1)');
      const hoursCard = document.querySelector('.stat-card:nth-child(2)');
      const monthlyCard = document.querySelector('.stat-card:nth-child(3)');

      if (selectedTeacherId || selectedDate) {
        if (totalCard) totalCard.classList.add('amber');
        if (hoursCard) hoursCard.classList.add('blue');
        if (monthlyCard) monthlyCard.classList.add('amber');
      } else {
        if (totalCard) totalCard.classList.remove('blue', 'emerald', 'amber');
        if (hoursCard) {
          hoursCard.classList.remove('blue', 'amber');
          hoursCard.classList.add('emerald');
        }
        if (monthlyCard) {
          monthlyCard.classList.remove('emerald', 'amber');
          monthlyCard.classList.add('blue');
        }
      }
    }
      if (modal) modal.classList.add('hidden');

    // åŠ¨æ€çµ±è¨ˆå¡ç‰‡é¢œè‰²æ›´æ–°
    function updateStatCardColors() {
      const totalCard = document.querySelector('.stat-card:nth-child(1)');
      const hoursCard = document.querySelector('.stat-card:nth-child(2)');
      const monthlyCard = document.querySelector('.stat-card:nth-child(3)');

      if (selectedTeacherId || selectedDate) {
        if (totalCard) totalCard.classList.add('amber');
        if (hoursCard) hoursCard.classList.add('blue');
        if (monthlyCard) monthlyCard.classList.add('amber');
      } else {
        if (totalCard) totalCard.classList.remove('blue', 'emerald', 'amber');
        if (hoursCard) {
          hoursCard.classList.remove('blue', 'amber');
          hoursCard.classList.add('emerald');
        }
        if (monthlyCard) {
          monthlyCard.classList.remove('emerald', 'amber');
          monthlyCard.classList.add('blue');
        }
      }
    }
    }

    // åŠ¨æ€çµ±è¨ˆå¡ç‰‡é¢œè‰²æ›´æ–°
    function updateStatCardColors() {
      const totalCard = document.querySelector('.stat-card:nth-child(1)');
      const hoursCard = document.querySelector('.stat-card:nth-child(2)');
      const monthlyCard = document.querySelector('.stat-card:nth-child(3)');

      if (selectedTeacherId || selectedDate) {
        if (totalCard) totalCard.classList.add('amber');
        if (hoursCard) hoursCard.classList.add('blue');
        if (monthlyCard) monthlyCard.classList.add('amber');
      } else {
        if (totalCard) totalCard.classList.remove('blue', 'emerald', 'amber');
        if (hoursCard) {
          hoursCard.classList.remove('blue', 'amber');
          hoursCard.classList.add('emerald');
        }
        if (monthlyCard) {
          monthlyCard.classList.remove('emerald', 'amber');
          monthlyCard.classList.add('blue');
        }
      }
    }
    // ==================== é€šç”¨è¨Šæ¯é¡¯ç¤º ====================
    function showMessage(message, type = 'info', hint = '') {
      const banner = document.getElementById('syncStatusBanner');
      const textElement = document.getElementById('syncStatusText');
      const hintElement = document.getElementById('syncStatusHint');
      const iconElement = document.getElementById('syncStatusIcon');

      if (!banner || !textElement || !iconElement) {
        // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯ï¼ˆå·²é€é UI é¡¯ç¤ºï¼‰
        return;
      }

      const typeStyles = {
        info: {
          wrapper: 'bg-blue-50 border-blue-200 text-blue-800',
          icon: 'â„¹ï¸'
        },
        success: {
          wrapper: 'bg-green-50 border-green-200 text-green-700',
          icon: 'âœ“'
        },
        warning: {
          wrapper: 'bg-amber-50 border-amber-200 text-amber-700',
          icon: 'âš ï¸'
        },
        error: {
          wrapper: 'bg-red-50 border-red-200 text-red-700',
          icon: 'âœ—'
        }
      };

      const style = typeStyles[type] || typeStyles.info;

      banner.className = `card p-4 mb-6 border border-transparent ${style.wrapper}`;
      textElement.textContent = message;
      iconElement.textContent = style.icon;

      if (hint) {
        hintElement.textContent = hint;
        hintElement.style.display = 'block';
      } else {
        hintElement.textContent = '';
        hintElement.style.display = 'none';
      }

      banner.classList.remove('hidden');
    }

    function dismissSyncStatus() {
      const banner = document.getElementById('syncStatusBanner');
      if (banner) {
        banner.classList.add('hidden');
      }
    }

    // ==================== è¡çªå°è©±æ¡† - é¡¯ç¤ºåœ¨ç·šä½¿ç”¨è€… ====================
    function showConflictDialog(result) {
      const activeSessions = result.activeSessions || [];

      let userListHTML = '';
      if (activeSessions.length === 0) {
        userListHTML = '<p style="color: #666; margin: 10px 0;">ç›®å‰æ²’æœ‰å…¶ä»–ä½¿ç”¨è€…åœ¨ç·š</p>';
      } else {
        userListHTML = '<div style="margin: 15px 0;"><strong>ç›®å‰åœ¨ç·šçš„ä½¿ç”¨è€…ï¼š</strong><ul style="list-style: none; padding: 10px 0; margin: 0;">';

        activeSessions.forEach(session => {
          const timeAgo = getTimeAgo(session.lastActiveTime);
          userListHTML += `
            <li style="padding: 8px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>${session.userName || 'è¨ªå®¢'}</strong>
                ${session.userEmail ? `<br><small style="color: #666;">${session.userEmail}</small>` : ''}
                <br><small style="color: #999;">æœ€å¾Œæ´»å‹•: ${timeAgo}</small>
              </div>
              <button
                onclick="kickUser('${session.sessionId}', '${session.userName}')"
                style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                è¸¢å‡º
              </button>
            </li>
          `;
        });

        userListHTML += '</ul></div>';
      }

      const dialogHTML = `
        <div id="conflictDialog" style="
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0,0,0,0.5); display: flex; align-items: center;
          justify-content: center; z-index: 10000;">
          <div style="
            background: white; padding: 30px; border-radius: 12px;
            max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h2 style="margin: 0 0 15px 0; color: #d97706;">âš ï¸ è³‡æ–™è¡çªè­¦å‘Š</h2>
            <p style="color: #374151; margin: 10px 0;">${result.message}</p>
            ${userListHTML}
            <div style="margin-top: 20px; text-align: right;">
              <button
                onclick="closeConflictDialog()"
                style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 16px; margin-right: 10px;">
                é—œé–‰
              </button>
              <button
                onclick="window.location.reload()"
                style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 16px;">
                é‡æ–°æ•´ç†é é¢
              </button>
            </div>
          </div>
        </div>
      `;

      // ç§»é™¤èˆŠçš„å°è©±æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      const oldDialog = document.getElementById('conflictDialog');
      if (oldDialog) {
        oldDialog.remove();
      }

      // åŠ å…¥æ–°å°è©±æ¡†
      document.body.insertAdjacentHTML('beforeend', dialogHTML);
    }

    function closeConflictDialog() {
      const dialog = document.getElementById('conflictDialog');
      if (dialog) {
        dialog.remove();
      }
    }

    async function kickUser(sessionId, userName) {
      if (!confirm(`ç¢ºå®šè¦è¸¢å‡ºä½¿ç”¨è€…ã€Œ${userName}ã€å—ï¼Ÿ`)) {
        return;
      }

      try {
        await sessionManager.kickUser(sessionId);
        alert(`âœ“ å·²è¸¢å‡ºä½¿ç”¨è€…ã€Œ${userName}ã€`);

        // é‡æ–°æ•´ç†å°è©±æ¡†
        closeConflictDialog();

        // ç­‰å¾…ä¸€ä¸‹è®“è¢«è¸¢çš„ä½¿ç”¨è€…æœ‰æ™‚é–“åæ‡‰
        setTimeout(async () => {
          const result = await syncManager.saveToBackendSafe();
          if (result.conflict) {
            showConflictDialog(result);
          } else if (result.success) {
            alert('âœ“ å„²å­˜æˆåŠŸï¼');
            window.location.reload();
          }
        }, 2000);
      } catch (error) {
        alert('âœ— è¸¢å‡ºå¤±æ•—: ' + error.message);
      }
    }

    function getTimeAgo(timestamp) {
      const now = new Date();
      const time = new Date(timestamp);
      const diffMs = now - time;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);

      if (diffSec < 60) {
        return `${diffSec} ç§’å‰`;
      } else if (diffMin < 60) {
        return `${diffMin} åˆ†é˜å‰`;
      } else {
        const diffHour = Math.floor(diffMin / 60);
        return `${diffHour} å°æ™‚å‰`;
      }
    }

    // ==================== å·¥å…·å‡½æ•¸ - ç²å–æœ¬åœ°æ—¥æœŸå­—ä¸² ====================
    function getLocalDateString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // ==================== åˆå§‹åŒ– ====================
    function reloadCourseDataFromStorage() {
      teachers = loadArray('teachers', typeof normalizeTeacherRecord === 'function' ? normalizeTeacherRecord : undefined);
      courseAssignments = loadArray('courseAssignments', typeof normalizeCourseAssignment === 'function' ? normalizeCourseAssignment : undefined);
      calendarEvents = loadArray('calendarEvents');
    }

    function renderAllCourseViews() {
      loadTeachers();
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
      renderCalendar();
      renderDonutChart();
      renderSidebarTeachers();
      renderSidebarTeachers();
      renderDonutChart();
      renderRemainingHoursCard();
      updateTodayDate();
      loadTeacherHoursAnalysisVisibility();
    }

    async function init() {
      // å…ˆç”¨æœ¬åœ°è³‡æ–™å¿«é€Ÿå‘ˆç¾ç•«é¢
      reloadCourseDataFromStorage();
      renderAllCourseViews();
      document.getElementById('courseForm').addEventListener('submit', handleAddCourse);

      if (courseAssignments.length === 0) {
        showMessage('ç›®å‰å°šç„¡èª²ç¨‹è³‡æ–™å¯ä¾›é¡¯ç¤º', 'info', 'è«‹å…ˆè¨­å®šå¾Œç«¯åŒæ­¥æˆ–ä½¿ç”¨ã€Œæ–°å¢èª²ç¨‹ã€å»ºç«‹è³‡æ–™ã€‚');
      }

      // å¾Œç«¯åŒæ­¥æ”¹ç‚ºèƒŒæ™¯é€²è¡Œï¼Œé¿å…è¼‰å…¥è¢«ç¶²è·¯å»¶é²é˜»å¡
      if (typeof initializeDataSync !== 'undefined') {
        initializeDataSync()
          .then(() => {
            reloadCourseDataFromStorage();
            renderAllCourseViews();
          })
          .catch(err => {
            console.warn('âš ï¸ å¾Œç«¯åŒæ­¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™:', err.message);
            showMessage('ç›®å‰ä½¿ç”¨é›¢ç·šè³‡æ–™', 'warning', 'è«‹ç¢ºèª Google Apps Script API è¨­å®šæ˜¯å¦æ­£ç¢ºï¼Œæˆ–ç¨å¾Œå†è©¦ã€‚');
          });
      }

      // ğŸ”’ å®šæœŸåˆ·æ–°é–å®šç‹€æ…‹ï¼ˆæ¯15ç§’ï¼‰
      setInterval(() => {
        updateCoursesDisplay();
      }, 15000);
    }

    function loadTeachers() {
      const select = document.getElementById('courseTeacherId');
      select.innerHTML = '<option value="">è«‹é¸æ“‡å¸«è³‡</option>';
      teachers.forEach(t => {
        select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
      });
    }

    function updateTodayDate() {
      const today = new Date();
      const dateStr = today.toLocaleDateString('zh-TW', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      });
      document.getElementById('todayDate').textContent = dateStr;
    }

    // ==================== çµ±è¨ˆåˆ†æ ====================
    function updateStatistics() {
      // æ ¹æ“šé¸æ“‡çš„å¸«è³‡å’Œæ—¥æœŸéæ¿¾èª²ç¨‹
      let filteredCourses = courseAssignments;

      if (selectedTeacherId !== null) {
        filteredCourses = filteredCourses.filter(c => c.teacherId === selectedTeacherId);
      }

      if (selectedDate !== null) {
        filteredCourses = filteredCourses.filter(c => c.date === selectedDate);
      }

      // ç¸½èª²ç¨‹æ•¸
      document.getElementById('totalCoursesCount').textContent = filteredCourses.length;
      // Update dynamic stat cards colors
      updateStatCardColors();

      // ç¸½æ™‚æ•¸
      const totalHours = filteredCourses.reduce((sum, c) => sum + calculateHours(c.time), 0);
      document.getElementById('totalHoursCount').textContent = `${totalHours.toFixed(1)} å°æ™‚`;

      // æœ¬æœˆæ™‚æ•¸
      const thisMonth = new Date().toISOString().slice(0, 7);
      const monthlyHours = filteredCourses
        .filter(c => c.date.startsWith(thisMonth))
        .reduce((sum, c) => sum + calculateHours(c.time), 0);
      document.getElementById('monthlyHoursCount').textContent = `${monthlyHours.toFixed(1)} å°æ™‚`;
    }

    function renderTeacherHoursAnalysis() {
      const thisMonth = new Date().toISOString().slice(0, 7);
      const listContainer = document.getElementById('teacherHoursList');
      const showMoreContainer = document.getElementById('showMoreContainer');

      if (teachers.length === 0) {
        listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">å°šç„¡å¸«è³‡è³‡æ–™</p>';
        showMoreContainer.style.display = 'none';
        return;
      }

      // éæ¿¾å¸«è³‡ï¼ˆæ ¹æ“šæœå°‹æ¢ä»¶ï¼‰
      let filteredTeachers = teachers;
      if (teacherSearchQuery.trim() !== '') {
        filteredTeachers = teachers.filter(teacher =>
          teacher.name.toLowerCase().includes(teacherSearchQuery.toLowerCase())
        );
      }

      if (filteredTeachers.length === 0) {
        listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">æ‰¾ä¸åˆ°ç¬¦åˆçš„å¸«è³‡</p>';
        showMoreContainer.style.display = 'none';
        document.getElementById('targetAchievedAlert').style.display = 'none';
        return;
      }

      // è¨ˆç®—æ¯ä½å¸«è³‡çš„æ™‚æ•¸ä¸¦æ’åº
      const teachersWithHours = filteredTeachers.map(teacher => {
        const courses = courseAssignments.filter(c =>
          c.teacherId === teacher.id && c.date.startsWith(thisMonth)
        );
        const hours = courses.reduce((sum, c) => sum + calculateHours(c.time), 0);
        return { teacher, hours, courses };
      });

      // æ’åºï¼šå·²é”æ¨™(>=12å°æ™‚)æ’åœ¨å‰é¢ï¼ŒæŒ‰æ™‚æ•¸é™åº
      teachersWithHours.sort((a, b) => {
        const aAchieved = a.hours >= 12;
        const bAchieved = b.hours >= 12;
        if (aAchieved && !bAchieved) return -1;
        if (!aAchieved && bAchieved) return 1;
        return b.hours - a.hours; // åŒç­‰ç´šå…§æŒ‰æ™‚æ•¸é™åº
      });

      // è¨ˆç®—é”æ¨™äººæ•¸ä¸¦æ›´æ–°æé†’
      const achievedCount = teachersWithHours.filter(t => t.hours >= 12).length;
      const alertElement = document.getElementById('targetAchievedAlert');
      if (achievedCount > 0) {
        document.getElementById('targetAchievedCount').textContent = achievedCount;
        alertElement.style.display = 'block';
      } else {
        alertElement.style.display = 'none';
      }

      // æ±ºå®šé¡¯ç¤ºçš„å¸«è³‡æ•¸é‡
      const displayLimit = 4;
      const shouldShowMore = teachersWithHours.length > displayLimit && teacherSearchQuery === '';
      const displayTeachers = (shouldShowMore && !showAllTeachers)
        ? teachersWithHours.slice(0, displayLimit)
        : teachersWithHours;

      // é¡¯ç¤º/éš±è—ã€Œé¡¯ç¤ºæ›´å¤šã€æŒ‰éˆ•
      if (shouldShowMore) {
        showMoreContainer.style.display = 'block';
        document.getElementById('showMoreText').textContent = showAllTeachers ? 'æ”¶åˆ' : 'é¡¯ç¤ºæ›´å¤š';
        document.getElementById('showMoreIcon').textContent = showAllTeachers ? 'â–²' : 'â–¼';
      } else {
        showMoreContainer.style.display = 'none';
      }

      // æ¸²æŸ“å¸«è³‡åˆ—è¡¨
      listContainer.innerHTML = displayTeachers.map(item => {
        const { teacher, hours, courses } = item;
        const percentage = Math.min((hours / 12) * 100, 100);

        let statusClass = 'bg-red-500';
        let statusText = 'æœªé”æ¨™';
        if (hours >= 12) {
          statusClass = 'bg-green-500';
          statusText = 'å·²é”æ¨™';
        } else if (hours >= 8) {
          statusClass = 'bg-yellow-500';
          statusText = 'æ¥è¿‘é”æ¨™';
        }

        const isSelected = selectedTeacherId === teacher.id;
        const selectedStyle = isSelected
          ? 'border-2 border-blue-500 bg-blue-50 shadow-lg'
          : 'border border-gray-200 hover:border-blue-300 hover:shadow-md';

        return `
          <div onclick="selectTeacher(${teacher.id})"
               class="${selectedStyle} rounded-xl p-4 cursor-pointer transition-all duration-300">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold">
                  ${(teacher.name || '?')[0]}
                </div>
                <div>
                  <h4 class="font-semibold text-gray-900">${teacher.name}</h4>
                  <p class="text-xs text-gray-500">${courses.length} å ‚èª²</p>
                </div>
              </div>
              <div class="text-right">
                <p class="text-sm font-bold text-gray-900">${hours.toFixed(1)} / 12 å°æ™‚</p>
                <span class="text-xs ${statusClass} text-white px-2 py-1 rounded-full">${statusText}</span>
              </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
              <div class="${statusClass} h-3 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
            </div>
            ${isSelected ? '<p class="text-xs text-blue-600 font-semibold mt-2 text-center">âœ“ å·²é¸æ“‡</p>' : ''}
          </div>
        `;
      }).join('');
    }

    function filterTeachers() {
      teacherSearchQuery = document.getElementById('teacherSearchInput').value;
      showAllTeachers = false; // é‡ç½®å±•é–‹ç‹€æ…‹
      renderTeacherHoursAnalysis();
    }

    function toggleShowAllTeachers() {
      showAllTeachers = !showAllTeachers;
      renderTeacherHoursAnalysis();
    }

    // ==================== èª²ç¨‹é¡å‹åˆ†ä½ˆåœ– ====================
    async function renderCourseTypeChart() {
      // å»¶é²åŠ è¼‰ Chart.js
      try {
        await window.loadChartJS();
      } catch (error) {
        console.error('ç„¡æ³•åŠ è¼‰ Chart.js:', error);
        return;
      }

      // æ ¹æ“šé¸æ“‡çš„å¸«è³‡å’Œæ—¥æœŸéæ¿¾èª²ç¨‹
      let filteredCourses = courseAssignments;

      if (selectedTeacherId !== null) {
        filteredCourses = filteredCourses.filter(c => c.teacherId === selectedTeacherId);
      }

      if (selectedDate !== null) {
        filteredCourses = filteredCourses.filter(c => c.date === selectedDate);
      }

      const typeCount = {};
      filteredCourses.forEach(c => {
        typeCount[c.type] = (typeCount[c.type] || 0) + 1;
      });

      const typeCtx = document.getElementById('courseTypeChart').getContext('2d');
      if (courseTypeChart) courseTypeChart.destroy();

      courseTypeChart = new Chart(typeCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(typeCount),
          datasets: [{
            data: Object.values(typeCount),
            backgroundColor: ['#007aff', '#34c759', '#ff9500', '#ff3b30', '#5856d6'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: { size: 14 },
                padding: 15
              }
            }
          }
        }
      });
    }

    // ==================== å¸«è³‡é¸æ“‡åŠŸèƒ½ ====================
    function selectTeacher(teacherId) {
      // Toggle åŠŸèƒ½ï¼šå¦‚æœé»é¸å·²é¸æ“‡çš„å¸«è³‡ï¼Œå‰‡å–æ¶ˆé¸æ“‡
      if (selectedTeacherId === teacherId) {
        clearTeacherSelection();
        return;
      }

      // åˆ‡æ›åˆ°æ–°å¸«è³‡
      selectedTeacherId = teacherId;
      const teacher = teachers.find(t => t.id === teacherId);

      // é¡¯ç¤ºé¸æ“‡çš„å¸«è³‡æ©«å¹…
      const banner = document.getElementById('selectedTeacherBanner');
      const nameElement = document.getElementById('selectedTeacherName');
      if (teacher) {
        nameElement.textContent = teacher.name;
        banner.style.display = 'block';
      }

      // æ›´æ–°æ‰€æœ‰ç›¸é—œæ•¸æ“š
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
    }

    function clearTeacherSelection() {
      selectedTeacherId = null;

      // éš±è—é¸æ“‡çš„å¸«è³‡æ©«å¹…
      const banner = document.getElementById('selectedTeacherBanner');
      banner.style.display = 'none';

      // æ›´æ–°æ‰€æœ‰ç›¸é—œæ•¸æ“š
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
    }

    // ==================== æ—¥æœŸé¸æ“‡åŠŸèƒ½ ====================
    function selectDate(dateStr) {
      // Toggle åŠŸèƒ½ï¼šå¦‚æœé»é¸å·²é¸æ“‡çš„æ—¥æœŸï¼Œå‰‡å–æ¶ˆé¸æ“‡
      if (selectedDate === dateStr) {
        clearDateSelection();
        return;
      }

      // åˆ‡æ›åˆ°æ–°æ—¥æœŸ
      selectedDate = dateStr;

      // é¡¯ç¤ºé¸æ“‡çš„æ—¥æœŸæ©«å¹…
      const banner = document.getElementById('selectedDateBanner');
      const textElement = document.getElementById('selectedDateText');

      const date = new Date(dateStr + 'T00:00:00');
      const formattedDate = date.toLocaleDateString('zh-TW', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      });

      textElement.textContent = formattedDate;
      banner.style.display = 'block';

      // æ›´æ–°æ‰€æœ‰ç›¸é—œæ•¸æ“š
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
    }

    function clearDateSelection() {
      selectedDate = null;

      // éš±è—é¸æ“‡çš„æ—¥æœŸæ©«å¹…
      const banner = document.getElementById('selectedDateBanner');
      banner.style.display = 'none';

      // æ›´æ–°æ‰€æœ‰ç›¸é—œæ•¸æ“š
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
    }

    // ==================== å¸«è³‡æ™‚æ•¸åˆ†æé¡¯ç¤º/éš±è— ====================
    function toggleTeacherHoursAnalysis() {
      const analysisContent = document.getElementById('teacherHoursAnalysis');
      const toggleIcon = document.getElementById('toggleAnalysisIcon');
      const toggleText = document.getElementById('toggleAnalysisText');

      const isVisible = analysisContent.style.display !== 'none';

      if (isVisible) {
        analysisContent.style.display = 'none';
        toggleIcon.textContent = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
        toggleText.textContent = 'é¡¯ç¤º';
        localStorage.setItem('teacherHoursAnalysisVisible', 'false');
      } else {
        analysisContent.style.display = 'block';
        toggleIcon.textContent = 'ğŸ‘ï¸';
        toggleText.textContent = 'éš±è—';
        localStorage.setItem('teacherHoursAnalysisVisible', 'true');
      }
    }

    function loadTeacherHoursAnalysisVisibility() {
      const isVisible = localStorage.getItem('teacherHoursAnalysisVisible');

      if (isVisible === 'false') {
        const analysisContent = document.getElementById('teacherHoursAnalysis');
        const toggleIcon = document.getElementById('toggleAnalysisIcon');
        const toggleText = document.getElementById('toggleAnalysisText');

        analysisContent.style.display = 'none';
        toggleIcon.textContent = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
        toggleText.textContent = 'é¡¯ç¤º';
      }
    }

    // ==================== ä»Šæ—¥èª²ç¨‹ç¸½è¦½ ====================
    // è¼”åŠ©å‡½æ•¸ï¼šæ›´æ–°èª²ç¨‹é¡¯ç¤ºï¼ˆç”¨æ–¼é–å®šç‹€æ…‹è®ŠåŒ–å¾Œåˆ·æ–°ï¼‰
    function updateCoursesDisplay() {
      renderTodayCourses();
    }

    async function renderTodayCourses() {
      // ğŸ”’ ç²å–æ‰€æœ‰ç·¨è¼¯é–å®šç‹€æ…‹
      let courseLocks = {};
      try {
        const locksResult = await editLockManager.getAllLocks('courseAssignments');
        if (locksResult.ok && locksResult.locks) {
          locksResult.locks.forEach(lock => {
            courseLocks[lock.recordId] = lock;
          });
        }
      } catch (error) {
        console.warn('ç„¡æ³•ç²å–é–å®šç‹€æ…‹:', error);
      }

      let titleText;
      let displayCourses;

      // æ ¹æ“šé¸æ“‡ç‹€æ³æ±ºå®šé¡¯ç¤ºæ¨¡å¼
      if (selectedTeacherId !== null && selectedDate === null) {
        // æƒ…æ³1ï¼šé¸æ“‡äº†è€å¸«ä½†æ²’é¸æ—¥æœŸ â†’ é¡¯ç¤ºè©²è€å¸«çš„æ‰€æœ‰èª²ç¨‹
        const teacher = teachers.find(t => t.id === selectedTeacherId);
        titleText = `${teacher ? teacher.name : 'æœªçŸ¥å¸«è³‡'} çš„æ‰€æœ‰èª²ç¨‹`;
        displayCourses = courseAssignments.filter(c => c.teacherId === selectedTeacherId);
      } else if (selectedDate !== null) {
        // æƒ…æ³2ï¼šé¸æ“‡äº†æ—¥æœŸï¼ˆå¯èƒ½åŒæ™‚é¸æ“‡äº†è€å¸«ï¼‰
        const date = new Date(selectedDate + 'T00:00:00');
        const dateText = date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

        if (selectedTeacherId !== null) {
          const teacher = teachers.find(t => t.id === selectedTeacherId);
          titleText = `${dateText} - ${teacher ? teacher.name : 'æœªçŸ¥å¸«è³‡'} çš„èª²ç¨‹`;
          displayCourses = courseAssignments.filter(c => c.date === selectedDate && c.teacherId === selectedTeacherId);
        } else {
          titleText = `${dateText} èª²ç¨‹ç¸½è¦½`;
          displayCourses = courseAssignments.filter(c => c.date === selectedDate);
        }
      } else {
        // æƒ…æ³3ï¼šéƒ½æ²’é¸æ“‡ â†’ é¡¯ç¤ºä»Šå¤©çš„èª²ç¨‹
        const todayDate = getLocalDateString(new Date());
        titleText = 'ä»Šæ—¥èª²ç¨‹ç¸½è¦½';
        displayCourses = courseAssignments.filter(c => c.date === todayDate);
      }

      document.getElementById('courseOverviewTitle').textContent = titleText;

      const container = document.getElementById('todayCoursesContainer');

      if (displayCourses.length === 0) {
        let emptyMessage = 'ä»Šå¤©æ²’æœ‰æ’èª²';
        if (selectedTeacherId !== null && selectedDate === null) {
          emptyMessage = 'è©²å¸«è³‡å°šæœªæœ‰æ’èª²ç´€éŒ„';
        } else if (selectedDate !== null) {
          emptyMessage = 'è©²æ—¥æœŸæ²’æœ‰æ’èª²';
        }

        container.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-2">âœ¨</div>
            <p>${emptyMessage}</p>
          </div>
        `;
        return;
      }

      // æ’åºèª²ç¨‹ï¼šå…ˆæŒ‰æ—¥æœŸï¼Œå†æŒ‰æ™‚é–“
      const sortedCourses = displayCourses.sort((a, b) => {
        if (a.date !== b.date) {
          return a.date.localeCompare(b.date);
        }
        return a.time.localeCompare(b.time);
      });

      // å¦‚æœæ˜¯é¡¯ç¤ºæŸå€‹è€å¸«çš„æ‰€æœ‰èª²ç¨‹ï¼ŒæŒ‰æ—¥æœŸåˆ†çµ„
      if (selectedTeacherId !== null && selectedDate === null) {
        const groupedByDate = {};
        sortedCourses.forEach(c => {
          if (!groupedByDate[c.date]) {
            groupedByDate[c.date] = [];
          }
          groupedByDate[c.date].push(c);
        });

        container.innerHTML = Object.entries(groupedByDate).map(([date, courses]) => {
          const dateObj = new Date(date + 'T00:00:00');
          const dateText = dateObj.toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'long' });

          return `
            <div class="bg-white rounded-xl p-4 border border-gray-200">
              <div class="flex items-center justify-between mb-3 pb-3 border-b border-gray-200">
                <h4 class="font-semibold text-gray-800"><i class="ph ph-calendar"></i> ${dateText}</h4>
                <span class="text-xs text-gray-500">${courses.length} å ‚èª²</span>
              </div>
              <div class="space-y-2">
                ${courses.map(c => {
                  const statusColors = {
                    'ä¸Šç­': 'bg-blue-50 text-blue-700 border-blue-200',
                    'ä¼‘å‡': 'bg-green-50 text-green-700 border-green-200',
                    'å‡ºå·®': 'bg-orange-50 text-orange-700 border-orange-200'
                  };
                  const statusClass = statusColors[c.status] || statusColors['ä¸Šç­'];

                  // ğŸ”’ æª¢æŸ¥é–å®šç‹€æ…‹
                  const lock = courseLocks[c.id];
                  const isLocked = lock && lock.userName;
                  const lockBadge = isLocked ? `<span class="px-2 py-0.5 bg-red-50 text-red-700 rounded border border-red-200"><i class="ph ph-lock"></i> ${lock.userName} ç·¨è¼¯ä¸­</span>` : '';

                  return `
                    <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100 transition-colors border border-gray-200 ${isLocked ? 'border-red-300' : ''}" onclick="viewEvent(${c.id})">
                      <div class="flex justify-between items-start">
                        <div class="flex-1">
                          <p class="font-medium text-gray-800">${c.name}</p>
                          <div class="flex items-center flex-wrap gap-2 text-xs text-gray-600 mt-2">
                            <span>ğŸ• ${c.time}</span>
                            <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded border border-blue-200">${c.type}</span>
                            <span class="px-2 py-0.5 ${statusClass} rounded border">${c.status || 'ä¸Šç­'}</span>
                            ${lockBadge}
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }).join('');
      } else {
        // æŒ‰å¸«è³‡åˆ†çµ„ï¼ˆåŸæœ‰é‚è¼¯ï¼‰
        const grouped = {};
        sortedCourses.forEach(c => {
          if (!grouped[c.teacherId]) {
            grouped[c.teacherId] = [];
          }
          grouped[c.teacherId].push(c);
        });

        container.innerHTML = Object.entries(grouped).map(([teacherId, courses]) => {
          const teacher = teachers.find(t => t.id === Number(teacherId));
          if (!teacher) return '';

          return `
            <div class="bg-white rounded-xl p-4 border border-gray-200">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-3">
                  <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 p-0.5">
                    <div class="w-full h-full rounded-full bg-white flex items-center justify-center">
                      ${teacher.photo ?
                        `<img src="${teacher.photo}" class="w-full h-full object-cover rounded-full">` :
                        `<span class="text-lg font-bold text-gray-600">${(teacher.name || '?')[0]}</span>`
                      }
                    </div>
                  </div>
                  <div>
                    <h4 class="font-semibold text-gray-800">${teacher.name}</h4>
                    <p class="text-xs text-gray-500">${courses.length} å ‚èª²</p>
                  </div>
                </div>
              </div>
              <div class="space-y-2">
                ${courses.map(c => {
                  const statusColors = {
                    'ä¸Šç­': 'bg-blue-50 text-blue-700 border-blue-200',
                    'ä¼‘å‡': 'bg-green-50 text-green-700 border-green-200',
                    'å‡ºå·®': 'bg-orange-50 text-orange-700 border-orange-200'
                  };
                  const statusClass = statusColors[c.status] || statusColors['ä¸Šç­'];

                  // ğŸ”’ æª¢æŸ¥é–å®šç‹€æ…‹
                  const lock = courseLocks[c.id];
                  const isLocked = lock && lock.userName;
                  const lockBadge = isLocked ? `<span class="px-2 py-0.5 bg-red-50 text-red-700 rounded border border-red-200"><i class="ph ph-lock"></i> ${lock.userName} ç·¨è¼¯ä¸­</span>` : '';

                  return `
                    <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100 transition-colors border border-gray-200 ${isLocked ? 'border-red-300' : ''}" onclick="viewEvent(${c.id})">
                      <div class="flex justify-between items-start">
                        <div class="flex-1">
                          <p class="font-medium text-gray-800">${c.name}</p>
                          <div class="flex items-center flex-wrap gap-2 text-xs text-gray-600 mt-2">
                            <span>ğŸ• ${c.time}</span>
                            <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded border border-blue-200">${c.type}</span>
                            <span class="px-2 py-0.5 ${statusClass} rounded border">${c.status || 'ä¸Šç­'}</span>
                            ${lockBadge}
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }).join('');
      }
    }

    // ==================== è¡Œäº‹æ›† ====================
    function setViewMode(mode) {
      viewMode = mode;
      const monthBtn = document.getElementById('monthViewBtn');
      const weekBtn = document.getElementById('weekViewBtn');

      if (mode === 'month') {
        monthBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-white text-gray-900';
        monthBtn.style.cssText = 'box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);';
        weekBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold text-gray-600';
        weekBtn.style.cssText = 'background: transparent;';
        document.getElementById('prevLabel').textContent = 'ä¸Šå€‹æœˆ';
        document.getElementById('nextLabel').textContent = 'ä¸‹å€‹æœˆ';
      } else {
        weekBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-white text-gray-900';
        weekBtn.style.cssText = 'box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);';
        monthBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold text-gray-600';
        monthBtn.style.cssText = 'background: transparent;';
        document.getElementById('prevLabel').textContent = 'ä¸Šé€±';
        document.getElementById('nextLabel').textContent = 'ä¸‹é€±';
      }

      renderCalendar();
      renderSidebarTeachers();
      renderDonutChart();
      renderRemainingHoursCard();
    }

    function previousPeriod() {
      if (viewMode === 'month') {
        currentDate.setMonth(currentDate.getMonth() - 1);
      } else {
        currentDate.setDate(currentDate.getDate() - 7);
      }
      renderCalendar();
      renderSidebarTeachers();
      renderDonutChart();
      renderRemainingHoursCard();
    }

    function nextPeriod() {
      if (viewMode === 'month') {
        currentDate.setMonth(currentDate.getMonth() + 1);
      } else {
        currentDate.setDate(currentDate.getDate() + 7);
      }
      renderCalendar();
      renderSidebarTeachers();
      renderDonutChart();
      renderRemainingHoursCard();
    }

    function goToToday() {
      currentDate = new Date();
      renderCalendar();
      renderSidebarTeachers();
      renderDonutChart();
      renderRemainingHoursCard();
    }

    function renderCalendar() {
      if (viewMode === 'month') {
        renderMonthView();
      } else {
        renderWeekView();
      }
      renderMobileCalendar();
    }

    function renderMonthView() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const monthNames = ['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];

      document.getElementById('currentMonth').textContent = `${year}å¹´ ${monthNames[month]}`;

      const firstDay = new Date(year, month, 1);
      const start = new Date(firstDay);
      start.setDate(start.getDate() - firstDay.getDay());

      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      const todayStr = getLocalDateString(new Date());

      for (let w = 0; w < 6; w++) {
        for (let d = 0; d < 7; d++) {
          const cellDate = new Date(start);
          cellDate.setDate(start.getDate() + (w * 7) + d);

          const isCurrentMonth = (cellDate.getMonth() === month);
          const dateKey = getLocalDateString(cellDate);
          const isToday = (dateKey === todayStr);

          const dayEvents = courseAssignments.filter(c => c.date === dateKey);

          const isSelectedDate = (dateKey === selectedDate);

          const cell = document.createElement('div');
          cell.className = `calendar-day p-2 ${
            isCurrentMonth ? 'bg-white' : 'bg-gray-50'
          } ${isToday ? 'today-highlight' : ''} ${isSelectedDate ? 'ring-2 ring-pink-500 ring-inset' : ''}`;

          cell.innerHTML = `
            <div class="flex justify-between items-start mb-1">
              <span onclick="selectDate('${dateKey}')"
                    class="text-base font-semibold cursor-pointer hover:bg-blue-100 px-2 py-1 rounded transition-colors ${
                isCurrentMonth ? (isToday ? 'text-blue-600' : 'text-gray-800') : 'text-gray-400'
              } ${isSelectedDate ? 'bg-pink-100 text-pink-700' : ''}">
                ${cellDate.getDate()}
              </span>
            </div>
            <div class="space-y-1 overflow-y-auto max-h-20">
              ${dayEvents.map(e => {
                const teacher = teachers.find(t => t.id === e.teacherId);
                const teacherName = teacher ? teacher.name : 'æœªçŸ¥';
                return `
                  <div class="event-item bg-blue-500 text-white rounded cursor-pointer hover:bg-blue-600"
                       onclick="viewEvent(${e.id}); event.stopPropagation();">
                    <div class="font-medium truncate">${teacherName}</div>
                    <div class="text-[10px]" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3;">${e.time} ${e.name}</div>
                  </div>
                `;
              }).join('')}
            </div>
          `;

          grid.appendChild(cell);
        }
      }
    }

    function renderWeekView() {
      const startOfWeek = new Date(currentDate);
      startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);

      const monthNames = ['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
      document.getElementById('currentMonth').textContent =
        `${startOfWeek.getFullYear()}å¹´ ${monthNames[startOfWeek.getMonth()]} ${startOfWeek.getDate()}æ—¥ - ${endOfWeek.getDate()}æ—¥`;

      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      const dayNames = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
      const todayStr = getLocalDateString(new Date());

      for (let i = 0; i < 7; i++) {
        const cellDate = new Date(startOfWeek);
        cellDate.setDate(startOfWeek.getDate() + i);

        const dateKey = getLocalDateString(cellDate);
        const isToday = (dateKey === todayStr);
        const isSelectedDate = (dateKey === selectedDate);
        const dayEvents = courseAssignments.filter(c => c.date === dateKey);

        const cell = document.createElement('div');
        cell.className = `calendar-day p-4 bg-white ${isToday ? 'today-highlight' : ''} ${isSelectedDate ? 'ring-2 ring-pink-500 ring-inset' : ''}`;

        cell.innerHTML = `
          <div onclick="selectDate('${dateKey}')" class="text-center mb-4 pb-3 border-b border-gray-200 cursor-pointer hover:bg-blue-50 rounded-lg transition-colors ${isSelectedDate ? 'bg-pink-50' : ''}">
            <div class="text-sm font-semibold ${isToday ? 'text-blue-600' : (isSelectedDate ? 'text-pink-600' : 'text-gray-600')}">${dayNames[i]}</div>
            <div class="text-2xl font-bold ${isToday ? 'text-blue-600' : (isSelectedDate ? 'text-pink-600' : 'text-gray-800')}">
              ${cellDate.getDate()}
            </div>
          </div>
          <div class="space-y-2">
            ${dayEvents.map(e => {
              const teacher = teachers.find(t => t.id === e.teacherId);
              const teacherName = teacher ? teacher.name : 'æœªçŸ¥';
              return `
                <div class="event-item bg-blue-500 text-white p-3 rounded-xl cursor-pointer hover:bg-blue-600"
                     onclick="viewEvent(${e.id}); event.stopPropagation();">
                  <div class="font-semibold">${teacherName}</div>
                  <div class="text-xs mt-1"><i class="ph ph-clock"></i> ${e.time}</div>
                  <div class="text-xs" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4;">${e.name}</div>
                </div>
              `;
            }).join('')}
          </div>
        `;

        grid.appendChild(cell);
      }
    }

    function renderMobileCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const todayStr = getLocalDateString(new Date());

      const container = document.getElementById('mobileEventsList');
      let html = '';

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateKey = getLocalDateString(date);
        const dayEvents = courseAssignments.filter(c => c.date === dateKey);
        const isToday = dateKey === todayStr;

        if (dayEvents.length > 0 || isToday) {
          const dayNames = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
          html += `
            <div class="border border-gray-200 rounded-lg p-3 ${isToday ? 'bg-blue-50 border-blue-500' : 'bg-white'}">
              <div class="flex items-center justify-between mb-2">
                <span class="font-bold text-gray-800">${month + 1}æœˆ${day}æ—¥ (${dayNames[date.getDay()]})</span>
                ${isToday ? '<span class="text-xs bg-blue-500 text-white px-2 py-1 rounded">ä»Šå¤©</span>' : ''}
              </div>
              ${dayEvents.length === 0 ?
                '<p class="text-sm text-gray-500">ç„¡èª²ç¨‹</p>' :
                dayEvents.map(e => {
                  const teacher = teachers.find(t => t.id === e.teacherId);
                  const teacherName = teacher ? teacher.name : 'æœªçŸ¥';
                  return `
                    <div class="mt-2 p-2 bg-blue-500 text-white rounded-lg cursor-pointer hover:bg-blue-600" onclick="viewEvent(${e.id})">
                      <div class="font-semibold text-sm" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4;">${teacherName} - ${e.name}</div>
                      <div class="text-xs mt-1"><i class="ph ph-clock"></i> ${e.time} | <i class="ph ph-books"></i> ${e.type}</div>
                    </div>
                  `;
                }).join('')
              }
            </div>
          `;
        }
      }

      if (!html) {
        html = '<p class="text-center text-gray-500 py-8">æœ¬æœˆç„¡èª²ç¨‹</p>';
      }

      container.innerHTML = html;
    }

    // ==================== Modal ç®¡ç† ====================
    function openAddCourseModal() {
      document.getElementById('courseDate').value = getLocalDateString(new Date());

      // è¼‰å…¥æ™ºæ…§æ´¾èª²çš„èª²ç¨‹æ¸…å–®
      loadMaritimeCoursesToDatalist();

      document.getElementById('addCourseModal').classList.remove('hidden');
    }

    // è¼‰å…¥æ™ºæ…§æ´¾èª²çš„èª²ç¨‹åç¨±åˆ°ä¸‹æ‹‰é¸å–®
    function loadMaritimeCoursesToDatalist() {
      try {
        const maritimeCourses = JSON.parse(localStorage.getItem('maritimeCourses')) || [];
        const selectElement = document.getElementById('courseName');

        // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™ç¬¬ä¸€å€‹ã€Œè«‹é¸æ“‡èª²ç¨‹ã€ï¼‰
        selectElement.innerHTML = '<option value="">è«‹é¸æ“‡èª²ç¨‹</option>';

        // å–å¾—ä¸é‡è¤‡çš„èª²ç¨‹åç¨±
        const uniqueCourseNames = [...new Set(maritimeCourses.map(c => c.name))];

        // æ’åºèª²ç¨‹åç¨±
        uniqueCourseNames.sort();

        // åŠ å…¥åˆ° select
        uniqueCourseNames.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          selectElement.appendChild(option);
        });
      } catch (error) {
        console.warn('ç„¡æ³•è¼‰å…¥æ™ºæ…§æ´¾èª²èª²ç¨‹æ¸…å–®:', error);
      }
    }

    function closeAddCourseModal() {
      document.getElementById('addCourseModal').classList.add('hidden');
      document.getElementById('courseForm').reset();
    }

    async function viewEvent(courseId) {
      const course = courseAssignments.find(c => c.id === courseId);
      if (!course) return;

      // ğŸ”’ å˜—è©¦å–å¾—ç·¨è¼¯é–å®š
      const lockResult = await editLockManager.acquireLock('courseAssignments', courseId);

      if (lockResult.locked && !lockResult.ownLock) {
        // å·²è¢«å…¶ä»–äººé–å®š
        const lockedBy = lockResult.lockedBy || 'å…¶ä»–ä½¿ç”¨è€…';
        const lockedTime = lockResult.lockedAt ? new Date(lockResult.lockedAt).toLocaleTimeString('zh-TW') : '';

        if (confirm(`âš ï¸ æ­¤èª²ç¨‹æ­£è¢« ${lockedBy} ç·¨è¼¯ä¸­\né–å®šæ™‚é–“ï¼š${lockedTime}\n\næ˜¯å¦è¦ä»¥ã€Œå”¯è®€æ¨¡å¼ã€æŸ¥çœ‹ï¼Ÿ`)) {
          // ä»¥å”¯è®€æ¨¡å¼æŸ¥çœ‹ï¼Œä¿å­˜ courseId ç”¨æ–¼æŸ¥çœ‹å’Œåˆªé™¤
          editingCourseId = courseId;
          // æ¨™è¨˜ç‚ºå”¯è®€æ¨¡å¼
          window.isReadOnlyMode = true;
        } else {
          return; // å–æ¶ˆæŸ¥çœ‹
        }
      } else if (lockResult.locked && lockResult.ownLock) {
        // æˆåŠŸå–å¾—é–å®š
        // å·²é–å®šèª²ç¨‹
        editingCourseId = courseId;
        window.isReadOnlyMode = false;
      } else {
        // æœªèƒ½å–å¾—é–å®šï¼ˆå…¶ä»–éŒ¯èª¤ï¼‰
        editingCourseId = courseId;
        window.isReadOnlyMode = false;
      }

      // é¸æ“‡è©²èª²ç¨‹çš„æ—¥æœŸä¸¦æ›´æ–°èª²ç¨‹ç¸½è¦½
      selectDate(course.date);

      // åªåœ¨æ‰‹æ©Ÿç‰ˆï¼ˆè¢å¹•å¯¬åº¦ <= 768pxï¼‰æ‰æ»¾å‹•åˆ°èª²ç¨‹ç¸½è¦½å€åŸŸ
      if (window.innerWidth <= 768) {
        setTimeout(() => {
          const courseOverview = document.getElementById('courseOverviewTitle');
          if (courseOverview) {
            courseOverview.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }, 100);
      }
      const teacher = teachers.find(t => t.id === course.teacherId);

      // é¡¯ç¤ºæŸ¥çœ‹æ¨¡å¼
      const modalTitle = document.getElementById('modalTitle');
      modalTitle.innerHTML = '<i class="ph ph-calendar"></i> èª²ç¨‹è©³æƒ…';
      modalTitle.style.cssText = 'font-size: 28px; font-weight: 600; letter-spacing: -0.015em;';
      document.getElementById('viewMode').style.display = 'block';
      document.getElementById('editCourseForm').style.display = 'none';
      document.getElementById('viewModeButtons').style.display = 'flex';
      document.getElementById('editModeButtons').style.display = 'none';

      // è¼‰å…¥ç¤¾äº¤è³‡æ–™
      const courseLikes = loadArray('likes').filter(l => l.courseId === courseId);
      const courseComments = loadArray('comments').filter(c => c.courseId === courseId);
      const activityLogs = loadArray('activityLog').filter(a => a.courseId === courseId);
      const currentUserId = 'user_1'; // æ¨¡æ“¬ç•¶å‰ç”¨æˆ¶ ID
      const currentUserName = 'ç®¡ç†å“¡'; // æ¨¡æ“¬ç•¶å‰ç”¨æˆ¶åç¨±
      const userHasLiked = courseLikes.some(l => l.userId === currentUserId);

      document.getElementById('viewMode').innerHTML = `
        <!-- TimeTree + Apple é¢¨æ ¼çš„èª²ç¨‹è©³æƒ… -->

        <!-- èª²ç¨‹åŸºæœ¬è³‡è¨Š -->
        <div class="info-card space-y-4">
          <div>
            <div class="text-xs font-medium" style="color: var(--apple-gray); margin-bottom: 4px;">æˆèª²æ•™å¸«</div>
            <div class="flex items-center gap-2">
              <span class="text-2xl"><i class="ph ph-chalkboard-teacher"></i></span>
              <span class="text-lg font-semibold" style="color: var(--apple-gray-dark);">${teacher ? teacher.name : 'æœªçŸ¥'}</span>
            </div>
          </div>

          <div>
            <div class="text-xs font-medium" style="color: var(--apple-gray); margin-bottom: 4px;">èª²ç¨‹åç¨±</div>
            <div class="text-xl font-semibold" style="color: #1d1d1f;">${course.name}</div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs font-medium" style="color: var(--apple-gray); margin-bottom: 4px;">æ—¥æœŸ</div>
              <div class="flex items-center gap-2">
                <span><i class="ph ph-calendar"></i></span>
                <span class="text-sm font-medium">${course.date}</span>
              </div>
            </div>
            <div>
              <div class="text-xs font-medium" style="color: var(--apple-gray); margin-bottom: 4px;">æ™‚é–“</div>
              <div class="flex items-center gap-2">
                <span><i class="ph ph-clock"></i></span>
                <span class="text-sm font-medium">${course.time}</span>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs font-medium" style="color: var(--apple-gray); margin-bottom: 4px;">é¡å‹</div>
              <div class="flex items-center gap-2">
                <span><i class="ph ph-books"></i></span>
                <span class="text-sm font-medium">${course.type}</span>
              </div>
            </div>
            <div>
              <div class="text-xs font-medium" style="color: var(--apple-gray); margin-bottom: 4px;">ç‹€æ…‹</div>
              <div class="flex items-center gap-2">
                <span><i class="ph ph-briefcase"></i></span>
                <span class="text-sm font-medium">${course.status || 'ä¸Šç­'}</span>
              </div>
            </div>
          </div>

          ${course.note ? `
          <div>
            <div class="text-xs font-medium" style="color: var(--apple-gray); margin-bottom: 4px;">å‚™è¨»</div>
            <div class="text-sm" style="color: var(--apple-gray-dark); display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5;">${course.note}</div>
            ${course.tags && course.tags.length > 0 ? `
              <div class="flex flex-wrap gap-2 mt-3">
                ${course.tags.map(tag => {
                  // åˆ¤æ–·æ¨™ç±¤é¡å‹ä¸¦çµ¦äºˆå°æ‡‰é¡è‰²
                  let tagClass = 'tag-default';
                  let tagIcon = 'icon-tag';
                  for (const [key, rule] of Object.entries(TAG_RULES)) {
                    if (rule.keywords.includes(tag)) {
                      tagClass = rule.class;
                      tagIcon = rule.icon;
                      break;
                    }
                  }
                  return `<span class="auto-tag ${tagClass}" style="cursor: default;"><svg class="modal-icon-sm"><use href="#${tagIcon}"></use></svg><span>${tag}</span></span>`;
                }).join('')}
              </div>
            ` : ''}
          </div>
          ` : ''}
        </div>

        <!-- æé†’è¨­å®š -->
        <div class="feature-block feature-block-blue">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="text-2xl">ğŸ””</span>
              <div>
                <div class="text-sm font-semibold" style="color: var(--apple-gray-dark);">æé†’è¨­å®š</div>
                <div class="text-xs" style="color: var(--apple-gray);">${course.reminderTime || 'æœªè¨­å®šæé†’'}</div>
              </div>
            </div>
            <button onclick="setReminder()" class="action-btn" style="flex-shrink: 0;">
              ${course.reminderTime ? 'ä¿®æ”¹' : 'è¨­å®š'}
            </button>
          </div>
        </div>

        <!-- RSVP ç¢ºèªç‹€æ…‹ -->
        <div class="feature-block feature-block-green">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="text-2xl">âœ“</span>
              <div>
                <div class="text-sm font-semibold" style="color: var(--apple-gray-dark);">åƒåŠ ç¢ºèª</div>
                <div class="text-xs font-medium" style="color: ${course.rsvpStatus === 'å·²ç¢ºèª' ? 'var(--apple-green)' : 'var(--apple-gray)'};">
                  ${course.rsvpStatus === 'å·²ç¢ºèª' ? 'âœ“ ' : ''}${course.rsvpStatus || 'å¾…ç¢ºèª'}
                </div>
              </div>
            </div>
            <button onclick="toggleRSVP()" class="apple-btn ${course.rsvpStatus === 'å·²ç¢ºèª' ? 'apple-btn-secondary' : 'apple-btn-success'}" style="flex-shrink: 0; padding: 8px 16px; font-size: 13px;">
              ${course.rsvpStatus === 'å·²ç¢ºèª' ? 'å–æ¶ˆ' : 'ç¢ºèª'}
            </button>
          </div>
        </div>

        <div class="divider"></div>

        <!-- TimeTree é¢¨æ ¼çš„ç¤¾äº¤äº’å‹•å€ -->
        <div class="flex items-center gap-3">
          <button onclick="toggleLike()" class="social-btn ${userHasLiked ? 'liked' : ''}" id="likeButton">
            <span class="text-xl" id="likeIcon">${userHasLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
            <span class="font-semibold">${courseLikes.length}</span>
          </button>

          <div class="social-btn" style="cursor: default;">
            <span class="text-xl">ğŸ’¬</span>
            <span class="font-semibold">${courseComments.length}</span>
          </div>
        </div>

        <div class="divider"></div>

        <!-- ç•™è¨€è¨è«–å€ -->
        <div>
          <div class="section-title">
            <span>ğŸ’¬</span>
            <span>è¨è«–å€</span>
          </div>

          <!-- ç•™è¨€åˆ—è¡¨ -->
          <div id="commentsList" class="space-y-2 mb-4 max-h-80 overflow-y-auto">
            ${courseComments.length > 0 ? courseComments.map(comment => `
              <div class="comment-card">
                <div class="flex items-start gap-3">
                  <div class="avatar">
                    ${comment.userName.charAt(0)}
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between mb-1">
                      <span class="text-sm font-semibold" style="color: var(--apple-gray-dark);">${comment.userName}</span>
                      <span class="text-xs" style="color: var(--apple-gray);">${formatTimestamp(comment.timestamp)}</span>
                    </div>
                    <p class="text-sm whitespace-pre-wrap" style="color: #1d1d1f; line-height: 1.5;">${comment.content}</p>
                  </div>
                </div>
              </div>
            `).join('') : `
              <div class="text-center py-8" style="color: var(--apple-gray);">
                <div class="text-3xl mb-2">ğŸ’¬</div>
                <div class="text-sm">å°šç„¡ç•™è¨€ï¼Œæˆç‚ºç¬¬ä¸€å€‹ç•™è¨€çš„äººï¼</div>
              </div>
            `}
          </div>

          <!-- æ–°å¢ç•™è¨€ -->
          <div class="flex gap-2">
            <textarea id="newCommentInput" rows="2" class="apple-input flex-1" placeholder="è¼¸å…¥ç•™è¨€..." style="resize: none;"></textarea>
            <button onclick="addComment()" class="apple-btn apple-btn-primary self-end" style="padding: 10px 16px; white-space: nowrap;">
              ç™¼é€
            </button>
          </div>
        </div>

        <div class="divider"></div>

        <!-- æ“ä½œæ­·å² -->
        <div>
          <div class="section-title">
            <span>ğŸ“œ</span>
            <span>æ“ä½œæ­·å²</span>
          </div>
          <div class="space-y-1 max-h-48 overflow-y-auto">
            ${activityLogs.length > 0 ? activityLogs.slice().reverse().map(log => `
              <div class="timeline-item">
                <div class="timeline-dot"></div>
                <span class="font-medium">${log.userName}</span>
                <span>${log.action}</span>
                <span style="color: var(--apple-gray); margin-left: auto;">${formatTimestamp(log.timestamp)}</span>
              </div>
            `).join('') : `
              <div class="text-center py-4" style="color: var(--apple-gray); font-size: 13px;">
                å°šç„¡æ“ä½œè¨˜éŒ„
              </div>
            `}
          </div>
        </div>
      `;

      // åˆå§‹åŒ–ç¤¾äº¤åŠŸèƒ½
      initSocialFeatures(courseId, currentUserId, currentUserName);

      document.getElementById('viewEventModal').classList.remove('hidden');
    }

    // é¡¯ç¤ºã€ŒåŠŸèƒ½é–‹ç™¼ä¸­ã€æ¨¡æ…‹è¦–çª—
    function showUnderDevelopmentModal(title, description) {
      // å‰µå»ºæ¨¡æ…‹è¦–çª—
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.3s ease;
      `;

      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 24px;
          padding: 48px 40px;
          max-width: 480px;
          width: 90%;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          text-align: center;
          animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        ">
          <div style="
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.3);
          ">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
          </div>
          <h3 style="
            font-size: 28px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
          ">${title}</h3>
          <p style="
            font-size: 17px;
            color: #6e6e73;
            margin-bottom: 8px;
            line-height: 1.5;
          ">${description}</p>
          <p style="
            font-size: 15px;
            color: #86868b;
            margin-bottom: 32px;
          ">æ­¤åŠŸèƒ½ç›®å‰å°šåœ¨é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼</p>
          <button onclick="this.closest('[style*=fixed]').remove()" style="
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            border: none;
            padding: 14px 48px;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 24px rgba(245, 158, 11, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(245, 158, 11, 0.3)'">
            æˆ‘çŸ¥é“äº†
          </button>
        </div>
      `;

      // æ·»åŠ å‹•ç•«æ¨£å¼ï¼ˆå¦‚æœé‚„æ²’æœ‰ï¼‰
      if (!document.getElementById('modal-animations-style')) {
        const style = document.createElement('style');
        style.id = 'modal-animations-style';
        style.textContent = `
          @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }
          @keyframes slideUp {
            from {
              opacity: 0;
              transform: translateY(30px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
        `;
        document.head.appendChild(style);
      }

      // é»æ“ŠèƒŒæ™¯é—œé–‰
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });

      document.body.appendChild(modal);
    }

    function enterEditMode() {
      const course = courseAssignments.find(c => c.id === editingCourseId);
      if (!course) return;

      // è¼‰å…¥å¸«è³‡åˆ—è¡¨åˆ°ç·¨è¼¯è¡¨å–®
      const editTeacherSelect = document.getElementById('editTeacherId');
      editTeacherSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¸«è³‡</option>';
      teachers.forEach(t => {
        editTeacherSelect.innerHTML += `<option value="${t.id}" ${t.id === course.teacherId ? 'selected' : ''}>${t.name}</option>`;
      });

      // å¡«å…¥èª²ç¨‹è³‡æ–™
      document.getElementById('editCourseName').value = course.name;
      document.getElementById('editCourseDate').value = course.date;
      document.getElementById('editCourseType').value = course.type;

      const [startTime, endTime] = course.time.split('-');
      document.getElementById('editStartTime').value = startTime;
      document.getElementById('editEndTime').value = endTime;

      document.getElementById('editCourseStatus').value = course.status || 'ä¸Šç­';
      document.getElementById('editCourseNote').value = course.note || '';

      // è¼‰å…¥å·²æœ‰çš„æ¨™ç±¤
      if (course.tags && course.tags.length > 0) {
        // å¾ç¾æœ‰æ¨™ç±¤æ¢å¾©
        currentTags = course.tags.map(tagText => {
          // æª¢æŸ¥æ¨™ç±¤é¡å‹
          for (const [key, rule] of Object.entries(TAG_RULES)) {
            if (rule.keywords.includes(tagText)) {
              return {
                text: tagText,
                class: rule.class,
                icon: rule.icon,
                type: key
              };
            }
          }
          // é è¨­æ¨™ç±¤
          return {
            text: tagText,
            class: 'tag-default',
            icon: 'ğŸ·ï¸',
            type: 'custom'
          };
        });
        renderTags();
      } else {
        // æ²’æœ‰æ¨™ç±¤æ™‚è‡ªå‹•ç”Ÿæˆ
        autoGenerateTags();
      }

      // åˆ‡æ›åˆ°ç·¨è¼¯æ¨¡å¼
      const modalTitle = document.getElementById('modalTitle');
      modalTitle.textContent = 'âœï¸ ç·¨è¼¯èª²ç¨‹';
      modalTitle.style.cssText = 'font-size: 28px; font-weight: 600; letter-spacing: -0.015em;';
      document.getElementById('viewMode').style.display = 'none';
      document.getElementById('editCourseForm').style.display = 'block';
      document.getElementById('viewModeButtons').style.display = 'none';
      document.getElementById('editModeButtons').style.display = 'flex';
    }

    function cancelEditMode() {
      // è¿”å›æŸ¥çœ‹æ¨¡å¼
      viewEvent(editingCourseId);
    }

    async function saveEditedCourse() {
      const teacherId = Number(document.getElementById('editTeacherId').value);
      if (!teacherId) {
        alert('è«‹é¸æ“‡å¸«è³‡ï¼');
        return;
      }

      const startTime = document.getElementById('editStartTime').value;
      const endTime = document.getElementById('editEndTime').value;
      const courseDate = document.getElementById('editCourseDate').value;

      // æ‰¾åˆ°è¦ç·¨è¼¯çš„èª²ç¨‹
      const courseIndex = courseAssignments.findIndex(c => c.id === editingCourseId);
      if (courseIndex === -1) return;

      const oldCourse = courseAssignments[courseIndex];

      // æª¢æŸ¥æ™‚é–“è¡çªï¼ˆæ’é™¤è‡ªå·±ï¼‰
      const newTime = `${startTime}-${endTime}`;
      const conflicts = checkConflictExcludingSelf(
        editingCourseId,
        teacherId,
        courseDate,
        newTime
      );

      if (conflicts.length > 0) {
        if (!confirm(`âš ï¸ è¡å ‚è­¦å‘Šï¼\n\n${conflicts.join('\n')}\n\næ˜¯å¦ä»è¦ç¹¼çºŒï¼Ÿ`)) {
          return;
        }
      }

      // æ›´æ–°èª²ç¨‹è³‡æ–™ï¼ˆåŒ…å«è‡ªå‹•ç”Ÿæˆçš„æ¨™ç±¤ï¼‰
      courseAssignments[courseIndex] = {
        ...oldCourse,
        teacherId: teacherId,
        name: document.getElementById('editCourseName').value,
        date: courseDate,
        time: newTime,
        type: document.getElementById('editCourseType').value,
        status: document.getElementById('editCourseStatus').value,
        note: document.getElementById('editCourseNote').value.trim(),
        tags: getCurrentTags(),
        updatedAt: new Date().toISOString()
      };

      // åŒæ­¥æ›´æ–°è¡Œäº‹æ›†äº‹ä»¶
      const eventIndex = calendarEvents.findIndex(e => e.courseId === editingCourseId);
      if (eventIndex !== -1) {
        const teacher = teachers.find(t => t.id === teacherId);
        calendarEvents[eventIndex] = {
          ...calendarEvents[eventIndex],
          date: courseDate,
          title: `${courseAssignments[courseIndex].name} - ${teacher.name}`,
          time: newTime,
          teacherId: teacherId,
          location: courseAssignments[courseIndex].type,
          color: getCourseTypeColor(courseAssignments[courseIndex].type)
        };
      }

      saveData();
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
      renderCalendar();
      renderSidebarTeachers();
      renderDonutChart();
      renderRemainingHoursCard();

      // ğŸ”“ é—œé–‰å°è©±æ¡†ä¸¦é‡‹æ”¾é–å®š
      await closeViewEventModal();
      alert('âœ“ èª²ç¨‹å·²æ›´æ–°ï¼');
    }

    function checkConflictExcludingSelf(excludeId, teacherId, date, time) {
      const conflicts = [];
      const timeToMinutes = (t) => {
        const [h, m] = t.split(':').map(Number);
        return h * 60 + m;
      };

      const [newStart, newEnd] = time.split('-');
      const newStartMin = timeToMinutes(newStart);
      const newEndMin = timeToMinutes(newEnd);

      courseAssignments.forEach(c => {
        if (c.id !== excludeId && c.teacherId === teacherId && c.date === date) {
          const [start, end] = c.time.split('-');
          const startMin = timeToMinutes(start);
          const endMin = timeToMinutes(end);

          if (!(newEndMin <= startMin || newStartMin >= endMin)) {
            conflicts.push(`- ${c.name} (${c.time})`);
          }
        }
      });

      return conflicts;
    }

    async function closeViewEventModal() {
      // ğŸ”“ é‡‹æ”¾ç·¨è¼¯é–å®š
      if (editingCourseId && !window.isReadOnlyMode) {
        await editLockManager.releaseLock('courseAssignments', editingCourseId);
        // å·²é‡‹æ”¾èª²ç¨‹é–å®š
      }

      document.getElementById('viewEventModal').classList.add('hidden');
      editingCourseId = null;
      window.isReadOnlyMode = false;

      // æ›´æ–°èª²ç¨‹åˆ—è¡¨ä»¥åæ˜ é–å®šç‹€æ…‹è®ŠåŒ–
      updateCoursesDisplay();
    }

    // ==================== èª²ç¨‹ç®¡ç† ====================
    function handleAddCourse(e) {
      e.preventDefault();

      const teacherId = Number(document.getElementById('courseTeacherId').value);
      if (!teacherId) {
        alert('è«‹é¸æ“‡å¸«è³‡ï¼');
        return;
      }

      const courseData = {
        id: Date.now(),
        teacherId: teacherId,
        name: document.getElementById('courseName').value,
        date: document.getElementById('courseDate').value,
        time: `${document.getElementById('startTime').value}-${document.getElementById('endTime').value}`,
        type: document.getElementById('courseType').value,
        status: document.getElementById('courseStatus').value,
        note: document.getElementById('courseNote').value.trim()
      };

      // è¡å ‚æª¢æŸ¥
      const conflicts = checkConflict(courseData);
      if (conflicts.length > 0) {
        if (!confirm(`âš ï¸ è¡å ‚è­¦å‘Šï¼\n\n${conflicts.join('\n')}\n\næ˜¯å¦ä»è¦ç¹¼çºŒï¼Ÿ`)) {
          return;
        }
      }

      courseAssignments.push(courseData);

      // åŒæ­¥åˆ°è¡Œäº‹æ›†
      const teacher = teachers.find(t => t.id === teacherId);
      calendarEvents.push({
        id: courseData.id,
        date: courseData.date,
        title: `${courseData.name} - ${teacher.name}`,
        time: courseData.time,
        teacherId: teacherId,
        location: courseData.type,
        color: getCourseTypeColor(courseData.type),
        courseId: courseData.id
      });

      saveData();
      closeAddCourseModal();
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
      renderCalendar();
      renderSidebarTeachers();
      renderDonutChart();
      renderRemainingHoursCard();
      alert('âœ“ èª²ç¨‹æ–°å¢æˆåŠŸï¼');
    }

    function deleteCourse(id) {
      courseAssignments = courseAssignments.filter(c => c.id !== id);
      calendarEvents = calendarEvents.filter(e => e.courseId !== id);
      saveData();
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
      renderCalendar();
      renderSidebarTeachers();
      renderDonutChart();
      renderRemainingHoursCard();
      alert('âœ“ èª²ç¨‹å·²åˆªé™¤ï¼');
    }

    // ==================== å·¥å…·å‡½æ•¸ ====================
    function calculateHours(timeRange) {
      const [start, end] = timeRange.split('-');
      const startTime = new Date(`2024-01-01 ${start}`);
      const endTime = new Date(`2024-01-01 ${end}`);
      return (endTime - startTime) / (1000 * 60 * 60);
    }

    function checkConflict(newCourse) {
      const conflicts = [];
      const timeToMinutes = (time) => {
        const [h, m] = time.split(':').map(Number);
        return h * 60 + m;
      };

      const [newStart, newEnd] = newCourse.time.split('-');
      const newStartMin = timeToMinutes(newStart);
      const newEndMin = timeToMinutes(newEnd);

      courseAssignments.forEach(c => {
        if (c.teacherId === newCourse.teacherId && c.date === newCourse.date) {
          const [start, end] = c.time.split('-');
          const startMin = timeToMinutes(start);
          const endMin = timeToMinutes(end);

          if (!(newEndMin <= startMin || newStartMin >= endMin)) {
            conflicts.push(`- ${c.name} (${c.time})`);
          }
        }
      });

      return conflicts;
    }

    function getCourseTypeColor(type) {
      const colors = {
        'æ­£èª²': 'bg-blue-500',
        'è£œèª²': 'bg-yellow-500',
        'å¯¦é©—èª²': 'bg-purple-500',
        'å¯¦ä½œèª²': 'bg-green-500',
        'å°ˆé¡Œ': 'bg-red-500'
      };
      return colors[type] || 'bg-gray-500';
    }

    // ==================== è‡ªå‹•æ¨™ç±¤ç”Ÿæˆç³»çµ± ====================

    // æ¨™ç±¤é—œéµå­—è¦å‰‡
    const TAG_RULES = {
      important: {
        keywords: ['é‡è¦', 'å¿…é ˆ', 'æ³¨æ„', 'å‹™å¿…', 'åˆ‡è¨˜', 'é—œéµ', 'ç·Šæ€¥'],
        class: 'tag-important',
        icon: 'icon-alert'
      },
      exam: {
        keywords: ['è€ƒè©¦', 'æ¸¬é©—', 'è©•é‡', 'æœŸä¸­', 'æœŸæœ«', 'å°è€ƒ', 'å¤§è€ƒ'],
        class: 'tag-exam',
        icon: 'icon-file'
      },
      experiment: {
        keywords: ['å¯¦é©—', 'å¯¦ç¿’', 'å¯¦ä½œ', 'å¯¦å‹™', 'æ“ä½œ', 'ç·´ç¿’'],
        class: 'tag-experiment',
        icon: 'icon-flask'
      },
      project: {
        keywords: ['å°ˆé¡Œ', 'å ±å‘Š', 'ä½œæ¥­', 'ç¿’é¡Œ', 'ç¹³äº¤', 'æˆªæ­¢'],
        class: 'tag-project',
        icon: 'icon-presentation'
      },
      meeting: {
        keywords: ['æœƒè­°', 'è¨è«–', 'èªªæ˜', 'è¬›è§£', 'æ¼”è¬›', 'åº§è«‡'],
        class: 'tag-meeting',
        icon: 'icon-users'
      }
    };

    let currentTags = [];

    /**
     * è‡ªå‹•å¾å‚™è¨»ç”Ÿæˆæ¨™ç±¤
     */
    function autoGenerateTags() {
      const noteText = document.getElementById('editCourseNote').value.trim();

      if (!noteText) {
        currentTags = [];
        renderTags();
        return;
      }

      const detectedTags = [];

      // æª¢æŸ¥æ¯å€‹è¦å‰‡
      Object.entries(TAG_RULES).forEach(([key, rule]) => {
        rule.keywords.forEach(keyword => {
          if (noteText.includes(keyword)) {
            // é¿å…é‡è¤‡
            if (!detectedTags.find(t => t.text === keyword)) {
              detectedTags.push({
                text: keyword,
                class: rule.class,
                icon: rule.icon,
                type: key
              });
            }
          }
        });
      });

      // æå–å¯èƒ½çš„è‡ªå®šç¾©é—œéµå­—ï¼ˆ3-6å€‹å­—çš„è©çµ„ï¼‰
      const customKeywords = extractCustomKeywords(noteText);
      customKeywords.forEach(keyword => {
        if (!detectedTags.find(t => t.text === keyword)) {
          detectedTags.push({
            text: keyword,
            class: 'tag-default',
            icon: 'ğŸ·ï¸',
            type: 'custom'
          });
        }
      });

      // é™åˆ¶æ¨™ç±¤æ•¸é‡ï¼ˆæœ€å¤š6å€‹ï¼‰
      currentTags = detectedTags.slice(0, 6);
      renderTags();
    }

    /**
     * æå–è‡ªå®šç¾©é—œéµå­—
     */
    function extractCustomKeywords(text) {
      const keywords = [];

      // ç§»é™¤æ¨™é»ç¬¦è™Ÿï¼ŒæŒ‰ç©ºæ ¼ã€é€—è™Ÿã€å¥è™Ÿåˆ†å‰²
      const words = text.replace(/[ï¼Œã€‚ï¼ï¼Ÿã€ï¼›ï¼š""''ï¼ˆï¼‰ã€Šã€‹ã€ã€‘]/g, ' ')
                       .split(/\s+/)
                       .filter(w => w.length >= 2 && w.length <= 8);

      // å–å‰3å€‹è©ä½œç‚ºé—œéµå­—
      return words.slice(0, 3);
    }

    /**
     * æ¸²æŸ“æ¨™ç±¤
     */
    function renderTags() {
      const container = document.getElementById('autoTagsContainer');
      if (!container) return;

      if (currentTags.length === 0) {
        container.innerHTML = '<span class="text-xs" style="color: var(--apple-gray);">è¼¸å…¥å‚™è¨»å¾Œè‡ªå‹•ç”Ÿæˆæ¨™ç±¤...</span>';
        return;
      }

      container.innerHTML = currentTags.map((tag, index) => `
        <div class="auto-tag ${tag.class}">
          <svg class="modal-icon-sm"><use href="#${tag.icon}"></use></svg>
          <span>${tag.text}</span>
          <span class="auto-tag-remove" onclick="removeTag(${index}); event.stopPropagation();">Ã—</span>
        </div>
      `).join('');
    }

    /**
     * ç§»é™¤æ¨™ç±¤
     */
    function removeTag(index) {
      currentTags.splice(index, 1);
      renderTags();
    }

    /**
     * ç²å–ç•¶å‰æ¨™ç±¤ï¼ˆç”¨æ–¼å„²å­˜ï¼‰
     */
    function getCurrentTags() {
      return currentTags.map(t => t.text);
    }

    // ==================== iOS é¢¨æ ¼å½ˆå‡ºå¼é¸å–® ====================

    /**
     * åˆ‡æ›å½ˆå‡ºå¼é¸å–®
     */
    function toggleContextMenu() {
      const overlay = document.getElementById('contextMenuOverlay');
      overlay.classList.toggle('show');
    }

    /**
     * é—œé–‰å½ˆå‡ºå¼é¸å–®
     */
    function closeContextMenu() {
      const overlay = document.getElementById('contextMenuOverlay');
      overlay.classList.remove('show');
    }

    /**
     * ç¢ºèªåˆªé™¤èª²ç¨‹ï¼ˆå¾é¸å–®è§¸ç™¼ï¼‰
     */
    function confirmDeleteCourse() {
      // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„èª²ç¨‹ ID
      if (!editingCourseId) {
        alert('âœ— ç„¡æ³•åˆªé™¤ï¼šæœªé¸æ“‡æœ‰æ•ˆçš„èª²ç¨‹');
        return;
      }

      // æª¢æŸ¥æ˜¯å¦ç‚ºå”¯è®€æ¨¡å¼
      if (window.isReadOnlyMode) {
        alert('âœ— ç„¡æ³•åˆªé™¤ï¼šæ­¤èª²ç¨‹æ­£è¢«å…¶ä»–äººç·¨è¼¯ä¸­ï¼Œç„¡æ³•åœ¨å”¯è®€æ¨¡å¼ä¸‹åˆªé™¤');
        return;
      }

      if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤èª²ç¨‹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        deleteCourse(editingCourseId);
        closeViewEventModal();
      }
    }

    // ==================== Phase 1: è¤‡è£½ã€åˆ†äº«åŠŸèƒ½ ====================

    /**
     * åŠŸèƒ½ 1.1: è¤‡è£½èª²ç¨‹è³‡è¨Šåˆ°å‰ªè²¼ç°¿
     */
    async function copyCourseToClipboard() {
      const course = courseAssignments.find(c => c.id === editingCourseId);
      if (!course) return;

      const teacher = teachers.find(t => t.id === course.teacherId);
      const courseText = `èª²ç¨‹ï¼š${course.name}\n` +
                        `æ•™å¸«ï¼š${teacher ? teacher.name : 'æœªçŸ¥'}\n` +
                        `æ—¥æœŸï¼š${course.date}\n` +
                        `æ™‚é–“ï¼š${course.time}\n` +
                        `é¡å‹ï¼š${course.type}\n` +
                        `${course.note ? 'å‚™è¨»ï¼š' + course.note : ''}`;

      try {
        // ä½¿ç”¨ç¾ä»£ Clipboard API
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(courseText);
          showMessage('èª²ç¨‹è³‡è¨Šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'success');
        } else {
          // é™ç´šæ–¹æ¡ˆï¼šä½¿ç”¨å‚³çµ±æ–¹å¼
          const textarea = document.createElement('textarea');
          textarea.value = courseText;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          showMessage('èª²ç¨‹è³‡è¨Šå·²è¤‡è£½ï¼', 'success');
        }
      } catch (err) {
        console.error('è¤‡è£½å¤±æ•—:', err);
        showMessage('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½', 'error');
      }
    }

    /**
     * åŠŸèƒ½ 1.2: é–‹å•Ÿã€Œè¤‡è£½åˆ°å…¶ä»–æ—¥æœŸã€Modal
     */
    function openDuplicateDateModal() {
      const course = courseAssignments.find(c => c.id === editingCourseId);
      if (!course) return;

      // è¨­å®šé è¨­æ—¥æœŸç‚ºæ˜å¤©
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowStr = tomorrow.toISOString().split('T')[0];
      document.getElementById('duplicateNewDate').value = tomorrowStr;

      // é¡¯ç¤º Modal
      document.getElementById('duplicateDateModal').classList.remove('hidden');
    }

    /**
     * é—œé–‰ã€Œè¤‡è£½åˆ°å…¶ä»–æ—¥æœŸã€Modal
     */
    function closeDuplicateDateModal() {
      document.getElementById('duplicateDateModal').classList.add('hidden');
    }

    /**
     * ç¢ºèªè¤‡è£½èª²ç¨‹åˆ°æ–°æ—¥æœŸ
     */
    function confirmDuplicateCourse() {
      const newDate = document.getElementById('duplicateNewDate').value;
      if (!newDate) {
        alert('è«‹é¸æ“‡æ–°æ—¥æœŸï¼');
        return;
      }

      const originalCourse = courseAssignments.find(c => c.id === editingCourseId);
      if (!originalCourse) return;

      // æª¢æŸ¥æ™‚é–“è¡çª
      const conflicts = checkTimeConflict(
        originalCourse.teacherId,
        newDate,
        originalCourse.time
      );

      if (conflicts.length > 0) {
        const continueAnyway = confirm(
          `âš ï¸ è¡å ‚è­¦å‘Šï¼\n\n${conflicts.join('\n')}\n\næ˜¯å¦ä»è¦ç¹¼çºŒè¤‡è£½ï¼Ÿ`
        );
        if (!continueAnyway) return;
      }

      // å»ºç«‹æ–°èª²ç¨‹ï¼ˆè¤‡è£½æ‰€æœ‰è³‡è¨Šï¼Œåƒ…æ”¹æ—¥æœŸï¼‰
      const newCourseId = Date.now();
      const newCourse = {
        ...originalCourse,
        id: newCourseId,
        date: newDate
      };

      courseAssignments.push(newCourse);

      // åŒæ­¥å»ºç«‹è¡Œäº‹æ›†äº‹ä»¶
      const teacher = teachers.find(t => t.id === newCourse.teacherId);
      const newEvent = {
        id: newCourseId,
        courseId: newCourseId,
        date: newDate,
        title: `${newCourse.name} - ${teacher ? teacher.name : ''}`,
        time: newCourse.time,
        teacherId: newCourse.teacherId,
        location: newCourse.type,
        color: getCourseTypeColor(newCourse.type)
      };
      calendarEvents.push(newEvent);

      // å„²å­˜ä¸¦æ›´æ–°ä»‹é¢
      saveData();
      updateStatistics();
      renderCalendar();
      renderSidebarTeachers();
      renderDonutChart();
      renderRemainingHoursCard();
      renderTodayCourses();
      closeDuplicateDateModal();

      showMessage(`èª²ç¨‹å·²æˆåŠŸè¤‡è£½åˆ° ${newDate}ï¼`, 'success');
    }

    /**
     * æª¢æŸ¥æ™‚é–“è¡çªï¼ˆç”¨æ–¼è¤‡è£½èª²ç¨‹ï¼‰
     */
    function checkTimeConflict(teacherId, date, time) {
      const conflicts = [];
      const timeToMinutes = (t) => {
        const [h, m] = t.split(':').map(Number);
        return h * 60 + m;
      };

      const [newStart, newEnd] = time.split('-');
      const newStartMin = timeToMinutes(newStart);
      const newEndMin = timeToMinutes(newEnd);

      courseAssignments.forEach(c => {
        if (c.teacherId === teacherId && c.date === date) {
          const [start, end] = c.time.split('-');
          const startMin = timeToMinutes(start);
          const endMin = timeToMinutes(end);

          if (!(newEndMin <= startMin || newStartMin >= endMin)) {
            conflicts.push(`- ${c.name} (${c.time})`);
          }
        }
      });

      return conflicts;
    }

    /**
     * åŠŸèƒ½ 1.3: åˆ†äº«èª²ç¨‹ï¼ˆä½¿ç”¨ Web Share API æˆ–ç”¢ç”Ÿé€£çµï¼‰
     */
    async function shareCourse() {
      const course = courseAssignments.find(c => c.id === editingCourseId);
      if (!course) return;

      const teacher = teachers.find(t => t.id === course.teacherId);
      const shareText = `èª²ç¨‹è³‡è¨Š\n\n` +
                       `èª²ç¨‹ï¼š${course.name}\n` +
                       `æ•™å¸«ï¼š${teacher ? teacher.name : 'æœªçŸ¥'}\n` +
                       `æ—¥æœŸï¼š${course.date}\n` +
                       `æ™‚é–“ï¼š${course.time}\n` +
                       `é¡å‹ï¼š${course.type}`;

      const shareUrl = window.location.href;

      try {
        // å„ªå…ˆä½¿ç”¨ Web Share APIï¼ˆè¡Œå‹•è£ç½®æ”¯æ´ï¼‰
        if (navigator.share) {
          await navigator.share({
            title: course.name,
            text: shareText,
            url: shareUrl
          });
          showMessage('èª²ç¨‹å·²åˆ†äº«ï¼', 'success');
        } else {
          // é™ç´šæ–¹æ¡ˆï¼šè¤‡è£½åˆ†äº«æ–‡å­—åˆ°å‰ªè²¼ç°¿
          const fullText = shareText + `\n\né€£çµï¼š${shareUrl}`;

          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(fullText);
            showMessage('åˆ†äº«é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'success', 'æ‚¨å¯ä»¥è²¼åˆ° Lineã€Email æˆ–å…¶ä»–åœ°æ–¹åˆ†äº«');
          } else {
            // æœ€å¾Œé™ç´šæ–¹æ¡ˆ
            const textarea = document.createElement('textarea');
            textarea.value = fullText;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showMessage('åˆ†äº«é€£çµå·²è¤‡è£½ï¼', 'success');
          }
        }
      } catch (err) {
        console.error('åˆ†äº«å¤±æ•—:', err);
        if (err.name === 'AbortError') {
          // ä½¿ç”¨è€…å–æ¶ˆåˆ†äº«ï¼Œä¸é¡¯ç¤ºéŒ¯èª¤
          return;
        }
        showMessage('åˆ†äº«å¤±æ•—', 'error');
      }
    }

    // ==================== Phase 3: ç¤¾äº¤äº’å‹•åŠŸèƒ½ ====================

    let currentCourseId = null;
    let currentUserId = null;
    let currentUserName = null;

    /**
     * åˆå§‹åŒ–ç¤¾äº¤åŠŸèƒ½
     */
    function initSocialFeatures(courseId, userId, userName) {
      currentCourseId = courseId;
      currentUserId = userId;
      currentUserName = userName;
    }

    /**
     * åˆ‡æ›æŒ‰è®šï¼ˆå¸¶å‹•ç•«æ•ˆæœï¼‰
     */
    function toggleLike() {
      let likes = loadArray('likes');
      const existingLike = likes.find(l => l.courseId === currentCourseId && l.userId === currentUserId);

      // è§¸ç™¼æ„›å¿ƒå‹•ç•«
      const likeIcon = document.getElementById('likeIcon');
      const likeButton = document.getElementById('likeButton');

      if (likeIcon) {
        likeIcon.classList.add('heart-animation');
        setTimeout(() => {
          likeIcon.classList.remove('heart-animation');
        }, 600);
      }

      if (existingLike) {
        // å–æ¶ˆæŒ‰è®š
        likes = likes.filter(l => !(l.courseId === currentCourseId && l.userId === currentUserId));
        logActivity(currentCourseId, 'å–æ¶ˆäº†æŒ‰è®š', 'unlike');
      } else {
        // æ–°å¢æŒ‰è®š
        likes.push({
          id: Date.now(),
          courseId: currentCourseId,
          userId: currentUserId,
          userName: currentUserName,
          timestamp: new Date().toISOString()
        });
        logActivity(currentCourseId, 'æŒ‰äº†è®š', 'like');
      }

      localStorage.setItem('likes', JSON.stringify(likes));
      viewEvent(currentCourseId); // é‡æ–°æ¸²æŸ“
    }

    /**
     * æ–°å¢ç•™è¨€
     */
    function addComment() {
      const input = document.getElementById('newCommentInput');
      const content = input.value.trim();

      if (!content) {
        alert('è«‹è¼¸å…¥ç•™è¨€å…§å®¹ï¼');
        return;
      }

      const comments = loadArray('comments');
      comments.push({
        id: Date.now(),
        courseId: currentCourseId,
        userId: currentUserId,
        userName: currentUserName,
        userAvatar: '', // å¯ä»¥å¾ŒçºŒæ–°å¢é ­åƒåŠŸèƒ½
        content: content,
        timestamp: new Date().toISOString(),
        updatedAt: null
      });

      localStorage.setItem('comments', JSON.stringify(comments));
      logActivity(currentCourseId, 'ç™¼è¡¨äº†ç•™è¨€', 'comment');

      input.value = '';
      viewEvent(currentCourseId); // é‡æ–°æ¸²æŸ“
    }

    /**
     * åˆ‡æ› RSVP ç¢ºèªç‹€æ…‹
     */
    function toggleRSVP() {
      const course = courseAssignments.find(c => c.id === currentCourseId);
      if (!course) return;

      const newStatus = course.rsvpStatus === 'å·²ç¢ºèª' ? 'å¾…ç¢ºèª' : 'å·²ç¢ºèª';
      course.rsvpStatus = newStatus;
      course.updatedAt = new Date().toISOString();

      saveData();
      logActivity(currentCourseId, newStatus === 'å·²ç¢ºèª' ? 'ç¢ºèªåƒåŠ èª²ç¨‹' : 'å–æ¶ˆåƒåŠ ç¢ºèª', 'rsvp');
      viewEvent(currentCourseId); // é‡æ–°æ¸²æŸ“
      showMessage(`å·²${newStatus === 'å·²ç¢ºèª' ? 'ç¢ºèª' : 'å–æ¶ˆ'}åƒåŠ ï¼`, 'success');
    }

    /**
     * è¨­å®šæé†’
     */
    function setReminder() {
      const course = courseAssignments.find(c => c.id === currentCourseId);
      if (!course) return;

      const reminderOptions = [
        { value: 'èª²ç¨‹ç•¶å¤© 09:00', label: 'èª²ç¨‹ç•¶å¤©æ—©ä¸Š 9:00' },
        { value: '1å¤©å‰', label: '1å¤©å‰' },
        { value: '3å¤©å‰', label: '3å¤©å‰' },
        { value: '1é€±å‰', label: '1é€±å‰' }
      ];

      let optionsHtml = reminderOptions.map(opt =>
        `<option value="${opt.value}" ${course.reminderTime === opt.value ? 'selected' : ''}>${opt.label}</option>`
      ).join('');

      const reminder = prompt(
        `è«‹é¸æ“‡æé†’æ™‚é–“ï¼š\n\n` +
        `1. èª²ç¨‹ç•¶å¤©æ—©ä¸Š 9:00\n` +
        `2. 1å¤©å‰\n` +
        `3. 3å¤©å‰\n` +
        `4. 1é€±å‰\n` +
        `5. æ¸…é™¤æé†’\n\n` +
        `è«‹è¼¸å…¥é¸é …ç·¨è™Ÿ (1-5)ï¼š`
      );

      if (reminder === null) return;

      const reminderMap = {
        '1': 'èª²ç¨‹ç•¶å¤© 09:00',
        '2': '1å¤©å‰',
        '3': '3å¤©å‰',
        '4': '1é€±å‰',
        '5': null
      };

      const selectedReminder = reminderMap[reminder];
      if (selectedReminder === undefined) {
        alert('ç„¡æ•ˆçš„é¸é …ï¼');
        return;
      }

      course.reminderTime = selectedReminder;
      course.updatedAt = new Date().toISOString();

      saveData();
      logActivity(currentCourseId, selectedReminder ? `è¨­å®šæé†’ï¼š${selectedReminder}` : 'æ¸…é™¤æé†’', 'reminder');
      viewEvent(currentCourseId);
      showMessage(selectedReminder ? `æé†’å·²è¨­å®šï¼š${selectedReminder}` : 'æé†’å·²æ¸…é™¤', 'success');
    }

    /**
     * è¨˜éŒ„æ“ä½œæ­·å²
     */
    function logActivity(courseId, action, actionType = 'general') {
      const activityLog = loadArray('activityLog');
      activityLog.push({
        id: Date.now(),
        courseId: courseId,
        userId: currentUserId || 'user_1',
        userName: currentUserName || 'ç®¡ç†å“¡',
        action: action,
        actionType: actionType,
        details: '',
        timestamp: new Date().toISOString()
      });

      localStorage.setItem('activityLog', JSON.stringify(activityLog));
    }

    /**
     * æ ¼å¼åŒ–æ™‚é–“æˆ³è¨˜
     */
    function formatTimestamp(timestamp) {
      if (!timestamp) return '';

      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'å‰›å‰›';
      if (diffMins < 60) return `${diffMins}åˆ†é˜å‰`;
      if (diffHours < 24) return `${diffHours}å°æ™‚å‰`;
      if (diffDays < 7) return `${diffDays}å¤©å‰`;

      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hour = String(date.getHours()).padStart(2, '0');
      const minute = String(date.getMinutes()).padStart(2, '0');

      if (year === now.getFullYear()) {
        return `${month}-${day} ${hour}:${minute}`;
      }
      return `${year}-${month}-${day}`;
    }

    // ==================== å•å·ç®¡ç†åŠŸèƒ½ ====================

    function openSurveyManagement(courseId) {
      const course = courseAssignments.find(c => c.id === courseId);
      if (!course) return;

      // è¼‰å…¥å•å·æ•¸æ“š
      const surveys = JSON.parse(localStorage.getItem('surveys') || '[]');
      const surveyTemplates = JSON.parse(localStorage.getItem('surveyTemplates') || '[]');
      const surveyResponses = JSON.parse(localStorage.getItem('surveyResponses') || '[]');

      // æŸ¥æ‰¾æ­¤èª²ç¨‹çš„å•å·
      const courseSurveys = surveys.filter(s => s.courseId === courseId);

      let message = `ğŸ“Š èª²ç¨‹å•å·ç®¡ç†\n\n`;
      message += `èª²ç¨‹ï¼š${course.name}\n`;
      message += `æ—¥æœŸï¼š${course.date}\n\n`;

      if (courseSurveys.length === 0) {
        message += `æ­¤èª²ç¨‹å°šæœªå‰µå»ºå•å·ã€‚\n\n`;
        message += `è«‹å‰å¾€ã€Œå•å·ç®¡ç†ç³»çµ±ã€ç‚ºæ­¤èª²ç¨‹å‰µå»ºå•å·ã€‚\n\n`;
        const goToSurvey = confirm(message + 'æ˜¯å¦è¦å‰å¾€å•å·ç®¡ç†ç³»çµ±ï¼Ÿ');
        if (goToSurvey) {
          window.location.href = 'survey-management.html';
        }
      } else {
        message += `å·²å‰µå»º ${courseSurveys.length} å€‹å•å·ï¼š\n\n`;

        courseSurveys.forEach((survey, index) => {
          const template = surveyTemplates.find(t => t.id === survey.templateId);
          const responses = surveyResponses.filter(r => r.surveyId === survey.id);
          const statusText = survey.status === 'active' ? 'âœ“ é–‹æ”¾ä¸­' : 'âœ— å·²é—œé–‰';

          message += `${index + 1}. ${template ? template.name : 'æœªçŸ¥æ¨¡æ¿'}\n`;
          message += `   ç‹€æ…‹ï¼š${statusText}\n`;
          message += `   å›æ‡‰æ•¸ï¼š${responses.length} ä»½\n`;
          message += `   é€£çµï¼š${survey.shareUrl}\n\n`;
        });

        message += `\nè«‹å‰å¾€ã€Œå•å·ç®¡ç†ç³»çµ±ã€æŸ¥çœ‹è©³ç´°çµ±è¨ˆæˆ–ç®¡ç†å•å·ã€‚`;

        const goToSurvey = confirm(message + '\n\næ˜¯å¦è¦å‰å¾€å•å·ç®¡ç†ç³»çµ±ï¼Ÿ');
        if (goToSurvey) {
          window.location.href = 'survey-management.html';
        }
      }
    }

    function saveData() {
      try {
        // å„²å­˜åˆ° localStorage
        localStorage.setItem('teachers', JSON.stringify(teachers));
        localStorage.setItem('courseAssignments', JSON.stringify(courseAssignments));
        localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));

        // æ¨™è¨˜æœ¬åœ°è³‡æ–™å·²ä¿®æ”¹
        if (typeof syncManager !== 'undefined') {
          syncManager.markAsChanged();

          // ä½¿ç”¨å®‰å…¨å„²å­˜æ¨¡å¼ï¼ˆæª¢æŸ¥è¡çªï¼‰
          syncManager.saveToBackendSafe().then(result => {
            if (result.conflict) {
              showConflictDialog(result);
              console.warn('ç™¼ç¾è³‡æ–™è¡çªï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            } else if (result.success) {
              // è³‡æ–™å·²å®‰å…¨å„²å­˜åˆ°é›²ç«¯
            }
          }).catch(err => {
            console.warn('âš ï¸ å¾Œç«¯åŒæ­¥å¤±æ•—ï¼Œè³‡æ–™å·²ä¿å­˜åœ¨æœ¬åœ°:', err.message);
          });
        }
      } catch (err) {
        console.error('å„²å­˜å¤±æ•—:', err);
      }
    }

    // ==================== å•Ÿå‹•æ‡‰ç”¨ ====================
    window.addEventListener('DOMContentLoaded', init);
  </script>

  <!-- SVG Icon å®šç¾©åº«ï¼ˆåƒ…ç”¨æ–¼ Modalï¼‰ -->
  <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <symbol id="icon-edit" viewBox="0 0 24 24">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
      </symbol>
      <symbol id="icon-save" viewBox="0 0 24 24">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
        <polyline points="17 21 17 13 7 13 7 21"></polyline>
        <polyline points="7 3 7 8 15 8"></polyline>
      </symbol>
      <symbol id="icon-more" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="1"></circle>
        <circle cx="19" cy="12" r="1"></circle>
        <circle cx="5" cy="12" r="1"></circle>
      </symbol>
      <symbol id="icon-tag" viewBox="0 0 24 24">
        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
        <line x1="7" y1="7" x2="7.01" y2="7"></line>
      </symbol>
      <symbol id="icon-alert" viewBox="0 0 24 24">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
        <line x1="12" y1="9" x2="12" y2="13"></line>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </symbol>
      <symbol id="icon-file" viewBox="0 0 24 24">
        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
        <polyline points="13 2 13 9 20 9"></polyline>
      </symbol>
      <symbol id="icon-flask" viewBox="0 0 24 24">
        <path d="M9 3h6"></path>
        <path d="M10 3v7.586a2 2 0 0 1-.586 1.414L4 17.414A2 2 0 0 0 5.414 21h13.172a2 2 0 0 0 1.414-3.586l-5.414-5.414A2 2 0 0 1 14 10.586V3"></path>
      </symbol>
      <symbol id="icon-presentation" viewBox="0 0 24 24">
        <path d="M2 3h20"></path>
        <path d="M21 3v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V3"></path>
        <path d="M7 21l5-5 5 5"></path>
      </symbol>
      <symbol id="icon-users" viewBox="0 0 24 24">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
      </symbol>
      <symbol id="icon-lightbulb" viewBox="0 0 24 24">
        <path d="M9 18h6"></path>
        <path d="M10 22h4"></path>
        <path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"></path>
      </symbol>
    </defs>
  </svg>

  </script>
</body>
</html>
