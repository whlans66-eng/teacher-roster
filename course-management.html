<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ´¾èª²ç®¡ç†ç³»çµ±</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .card {
      background: #ffffff;
      border-radius: 20px;
      border: 1px solid rgba(0, 0, 0, 0.04);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .calendar-day {
      min-height: 120px;
      transition: all 0.3s ease;
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 12px;
    }

    .calendar-day:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }

    .today-highlight {
      background: linear-gradient(135deg, rgba(0, 122, 255, 0.1), rgba(88, 86, 214, 0.1)) !important;
      border: 2px solid #007aff !important;
    }

    .event-item {
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 12px;
    }

    .event-item:hover {
      opacity: 0.85;
      transform: translateY(-1px);
    }

    .modern-btn {
      background: #007aff;
      color: white;
      transition: all 0.3s ease;
    }

    .modern-btn:hover {
      background: #0051d5;
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 122, 255, 0.3);
    }

    @media (max-width: 768px) {
      .calendar-grid-container {
        display: none;
      }

      .mobile-calendar-view {
        display: block !important;
      }
    }

    .mobile-calendar-view {
      display: none;
    }

    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* å¾®å¦™çš„èƒŒæ™¯ç´‹ç† */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(0, 122, 255, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(88, 86, 214, 0.03) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }
  </style>
</head>
<body>
  <div class="container mx-auto px-4 py-8">
    <!-- è¿”å›é¦–é  -->
    <div class="mb-6">
      <a href="index.html" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
        <span class="mr-2">â†</span> è¿”å›é¦–é 
      </a>
    </div>

    <!-- æ¨™é¡Œå€åŸŸ -->
    <div class="text-center mb-12">
      <h1 class="text-5xl font-bold text-gray-900 mb-2" style="letter-spacing: -0.02em">æ´¾èª²ç®¡ç†ç³»çµ±</h1>
      <p class="text-xl text-gray-600">æ™ºèƒ½ç®¡ç†å¹³å°</p>
    </div>

    <div class="max-w-7xl mx-auto space-y-6">
      <!-- èª²ç¨‹è¡Œäº‹æ›† -->
      <div class="card p-6 fade-in" style="animation-delay: 0.1s">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
          <h2 class="text-2xl font-bold text-gray-900">ğŸ“… èª²ç¨‹è¡Œäº‹æ›†</h2>
          <div class="flex items-center gap-3">
            <button onclick="openAddCourseModal()" class="modern-btn px-6 py-2 rounded-xl font-medium">
              âœ¨ æ–°å¢èª²ç¨‹
            </button>
            <div class="flex bg-gray-100 rounded-xl p-1">
              <button id="monthViewBtn" onclick="setViewMode('month')" class="px-4 py-2 rounded-lg text-sm font-semibold bg-blue-600 text-white">
                ğŸ“… æœˆ
              </button>
              <button id="weekViewBtn" onclick="setViewMode('week')" class="px-4 py-2 rounded-lg text-sm font-semibold text-gray-600 hover:bg-gray-200">
                ğŸ“Š é€±
              </button>
            </div>
          </div>
        </div>

        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center space-x-4">
            <button onclick="previousPeriod()" class="bg-white hover:bg-gray-50 px-4 py-2 rounded-xl font-medium border border-gray-200">
              â† <span id="prevLabel">ä¸Šå€‹æœˆ</span>
            </button>
            <h3 id="currentMonth" class="text-xl font-bold text-gray-800 min-w-[200px] text-center"></h3>
            <button onclick="nextPeriod()" class="bg-white hover:bg-gray-50 px-4 py-2 rounded-xl font-medium border border-gray-200">
              <span id="nextLabel">ä¸‹å€‹æœˆ</span> â†’
            </button>
          </div>
          <button onclick="goToToday()" class="modern-btn px-4 py-2 rounded-xl font-medium">
            ğŸ¯ ä»Šå¤©
          </button>
        </div>

        <!-- è¡Œäº‹æ›†ç¶²æ ¼ (æ¡Œé¢ç‰ˆ) -->
        <div class="calendar-grid-container bg-white rounded-xl overflow-hidden shadow-sm border border-gray-200">
          <!-- æ˜ŸæœŸæ¨™é¡Œ -->
          <div class="grid grid-cols-7 bg-gradient-to-r from-blue-500 to-blue-600">
            <div class="p-4 text-center font-bold text-white border-r border-white/20">æ—¥</div>
            <div class="p-4 text-center font-bold text-white border-r border-white/20">ä¸€</div>
            <div class="p-4 text-center font-bold text-white border-r border-white/20">äºŒ</div>
            <div class="p-4 text-center font-bold text-white border-r border-white/20">ä¸‰</div>
            <div class="p-4 text-center font-bold text-white border-r border-white/20">å››</div>
            <div class="p-4 text-center font-bold text-white border-r border-white/20">äº”</div>
            <div class="p-4 text-center font-bold text-white">å…­</div>
          </div>
          <!-- æ—¥æœŸç¶²æ ¼ -->
          <div id="calendarGrid" class="grid grid-cols-7"></div>
        </div>

        <!-- æ‰‹æ©Ÿç‰ˆè¡Œäº‹æ›†åˆ—è¡¨ -->
        <div class="mobile-calendar-view bg-white rounded-xl overflow-hidden shadow-sm border border-gray-200 p-4">
          <div id="mobileEventsList" class="space-y-3"></div>
        </div>
      </div>

      <!-- çµ±è¨ˆåˆ†æå€ -->
      <div id="selectedTeacherBanner" class="card p-4 mb-6 fade-in" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="text-2xl">ğŸ‘¨â€ğŸ«</div>
            <div class="text-white">
              <p class="text-sm opacity-90">ç›®å‰æª¢è¦–å¸«è³‡</p>
              <p id="selectedTeacherName" class="text-xl font-bold"></p>
            </div>
          </div>
          <button onclick="clearTeacherSelection()" class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg font-medium transition-colors">
            âœ• æŸ¥çœ‹å…¨éƒ¨
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- ç¸½èª²ç¨‹æ•¸ -->
        <div class="card p-6 card-hover fade-in">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600 mb-1">ç¸½èª²ç¨‹æ•¸</p>
              <p id="totalCoursesCount" class="text-3xl font-bold text-gray-900">0</p>
            </div>
            <div class="text-4xl">ğŸ“š</div>
          </div>
        </div>

        <!-- ç¸½æ™‚æ•¸ -->
        <div class="card p-6 card-hover fade-in" style="animation-delay: 0.1s">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600 mb-1">ç¸½æˆèª²æ™‚æ•¸</p>
              <p id="totalHoursCount" class="text-3xl font-bold text-gray-900">0</p>
            </div>
            <div class="text-4xl">â±ï¸</div>
          </div>
        </div>

        <!-- æœ¬æœˆæ™‚æ•¸ -->
        <div class="card p-6 card-hover fade-in" style="animation-delay: 0.2s">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600 mb-1">æœ¬æœˆç¸½æ™‚æ•¸</p>
              <p id="monthlyHoursCount" class="text-3xl font-bold text-blue-600">0</p>
            </div>
            <div class="text-4xl">ğŸ“Š</div>
          </div>
        </div>
      </div>

      <!-- å¸«è³‡æ™‚æ•¸åˆ†æ -->
      <div id="teacherHoursAnalysisCard" class="card p-6 fade-in" style="animation-delay: 0.3s">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-gray-900">ğŸ‘¨â€ğŸ« å¸«è³‡æ™‚æ•¸åˆ†æ (æœ¬æœˆç›®æ¨™ï¼š12 å°æ™‚)</h2>
          <button onclick="toggleTeacherHoursAnalysis()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
            <span id="toggleAnalysisIcon">ğŸ‘ï¸</span> <span id="toggleAnalysisText">éš±è—</span>
          </button>
        </div>
        <div id="teacherHoursAnalysis">
          <!-- æœå°‹æ¡† -->
          <div class="mb-4">
            <input type="text" id="teacherSearchInput"
                   placeholder="ğŸ” æœå°‹å¸«è³‡å§“å..."
                   oninput="filterTeachers()"
                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <!-- å¸«è³‡åˆ—è¡¨ -->
          <div id="teacherHoursList" class="space-y-4">
            <!-- å¸«è³‡æ™‚æ•¸æ¢å°‡åœ¨é€™è£¡é¡¯ç¤º -->
          </div>
          <!-- é¡¯ç¤ºæ›´å¤šæŒ‰éˆ• -->
          <div id="showMoreContainer" class="mt-4 text-center" style="display: none;">
            <button onclick="toggleShowAllTeachers()" class="px-6 py-2 text-sm font-medium text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-lg transition-colors">
              <span id="showMoreText">é¡¯ç¤ºæ›´å¤š</span> <span id="showMoreIcon">â–¼</span>
            </button>
          </div>
        </div>
      </div>

      <!-- èª²ç¨‹é¡å‹åˆ†ä½ˆ -->
      <div class="card p-6 fade-in" style="animation-delay: 0.4s">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ“Š èª²ç¨‹é¡å‹åˆ†ä½ˆ</h2>
        <div style="position: relative; height: 300px; max-width: 600px; margin: 0 auto;">
          <canvas id="courseTypeChart"></canvas>
        </div>
      </div>

      <!-- ä»Šæ—¥èª²ç¨‹ç¸½è¦½ -->
      <div class="card p-6 fade-in" style="animation-delay: 0.5s">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-gray-900">ğŸ“… ä»Šæ—¥èª²ç¨‹ç¸½è¦½</h2>
          <div class="text-sm text-gray-600" id="todayDate"></div>
        </div>
        <div id="todayCoursesContainer" class="space-y-3">
          <!-- ä»Šæ—¥èª²ç¨‹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
        </div>
      </div>
    </div>
  </div>

  <!-- æ–°å¢èª²ç¨‹ Modal -->
  <div id="addCourseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
    <div class="card p-8 max-w-2xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
      <h3 class="text-2xl font-bold text-gray-900 mb-6">ğŸ“š æ–°å¢èª²ç¨‹</h3>
      <form id="courseForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡å¸«è³‡</label>
          <select id="courseTeacherId" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
            <option value="">è«‹é¸æ“‡å¸«è³‡</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">èª²ç¨‹åç¨±</label>
          <input type="text" id="courseName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">èª²ç¨‹æ—¥æœŸ</label>
            <input type="date" id="courseDate" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">èª²ç¨‹é¡å‹</label>
            <select id="courseType" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="æ­£èª²">æ­£èª²</option>
              <option value="è£œèª²">è£œèª²</option>
              <option value="å¯¦é©—èª²">å¯¦é©—èª²</option>
              <option value="å¯¦ä½œèª²">å¯¦ä½œèª²</option>
              <option value="å°ˆé¡Œ">å°ˆé¡Œ</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">é–‹å§‹æ™‚é–“</label>
            <input type="time" id="startTime" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">çµæŸæ™‚é–“</label>
            <input type="time" id="endTime" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ç‹€æ…‹</label>
          <select id="courseStatus" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
            <option value="ä¸Šç­">ä¸Šç­</option>
            <option value="ä¼‘å‡">ä¼‘å‡</option>
            <option value="å‡ºå·®">å‡ºå·®</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
          <textarea id="courseNote" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="é¸å¡«ï¼šèª²ç¨‹ç›¸é—œå‚™è¨»..."></textarea>
        </div>

        <div class="flex justify-end space-x-4 pt-4">
          <button type="button" onclick="closeAddCourseModal()" class="px-6 py-3 bg-gray-500 text-white rounded-xl font-medium hover:bg-gray-600 transition-colors">
            å–æ¶ˆ
          </button>
          <button type="submit" class="modern-btn px-6 py-3 rounded-xl font-medium">
            ç¢ºèªæ–°å¢
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- æŸ¥çœ‹/ç·¨è¼¯èª²ç¨‹è©³æƒ… Modal -->
  <div id="viewEventModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
    <div class="card p-8 max-w-2xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
      <h3 id="modalTitle" class="text-2xl font-bold text-gray-900 mb-6">ğŸ“… èª²ç¨‹è©³æƒ…</h3>

      <!-- æŸ¥çœ‹æ¨¡å¼ -->
      <div id="viewMode" class="space-y-4"></div>

      <!-- ç·¨è¼¯æ¨¡å¼ -->
      <form id="editCourseForm" class="space-y-4" style="display: none;">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡å¸«è³‡</label>
          <select id="editTeacherId" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
            <option value="">è«‹é¸æ“‡å¸«è³‡</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">èª²ç¨‹åç¨±</label>
          <input type="text" id="editCourseName" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">èª²ç¨‹æ—¥æœŸ</label>
            <input type="date" id="editCourseDate" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">èª²ç¨‹é¡å‹</label>
            <select id="editCourseType" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="æ­£èª²">æ­£èª²</option>
              <option value="è£œèª²">è£œèª²</option>
              <option value="å¯¦é©—èª²">å¯¦é©—èª²</option>
              <option value="å¯¦ä½œèª²">å¯¦ä½œèª²</option>
              <option value="å°ˆé¡Œ">å°ˆé¡Œ</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">é–‹å§‹æ™‚é–“</label>
            <input type="time" id="editStartTime" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">çµæŸæ™‚é–“</label>
            <input type="time" id="editEndTime" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ç‹€æ…‹</label>
          <select id="editCourseStatus" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
            <option value="ä¸Šç­">ä¸Šç­</option>
            <option value="ä¼‘å‡">ä¼‘å‡</option>
            <option value="å‡ºå·®">å‡ºå·®</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
          <textarea id="editCourseNote" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="é¸å¡«ï¼šèª²ç¨‹ç›¸é—œå‚™è¨»..."></textarea>
        </div>
      </form>

      <!-- æŒ‰éˆ•å€ -->
      <div id="viewModeButtons" class="flex justify-end space-x-4 pt-6">
        <button onclick="closeViewEventModal()" class="px-6 py-3 bg-gray-500 text-white rounded-xl font-medium hover:bg-gray-600 transition-colors">
          é—œé–‰
        </button>
        <button onclick="enterEditMode()" class="px-6 py-3 bg-blue-500 text-white rounded-xl font-medium hover:bg-blue-600 transition-colors">
          âœï¸ ç·¨è¼¯
        </button>
        <button id="deleteEventBtn" class="px-6 py-3 bg-red-500 text-white rounded-xl font-medium hover:bg-red-600 transition-colors">
          ğŸ—‘ï¸ åˆªé™¤
        </button>
      </div>

      <div id="editModeButtons" class="flex justify-end space-x-4 pt-6" style="display: none;">
        <button onclick="cancelEditMode()" class="px-6 py-3 bg-gray-500 text-white rounded-xl font-medium hover:bg-gray-600 transition-colors">
          å–æ¶ˆ
        </button>
        <button onclick="saveEditedCourse()" class="modern-btn px-6 py-3 rounded-xl font-medium">
          ğŸ’¾ å„²å­˜è®Šæ›´
        </button>
      </div>
    </div>
  </div>

  <script>
    // ==================== è³‡æ–™ç®¡ç† ====================
    let teachers = JSON.parse(localStorage.getItem('teachers') || '[]');
    let courseAssignments = JSON.parse(localStorage.getItem('courseAssignments') || '[]');
    let calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');

    let currentDate = new Date();
    let viewMode = 'month';
    let courseTypeChart = null;
    let showAllTeachers = false;
    let teacherSearchQuery = '';
    let selectedTeacherId = null;
    let editingCourseId = null;

    // ==================== å·¥å…·å‡½æ•¸ - ç²å–æœ¬åœ°æ—¥æœŸå­—ä¸² ====================
    function getLocalDateString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // ==================== åˆå§‹åŒ– ====================
    function init() {
      loadTeachers();
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
      renderCalendar();
      updateTodayDate();
      loadTeacherHoursAnalysisVisibility();
      document.getElementById('courseForm').addEventListener('submit', handleAddCourse);
    }

    function loadTeachers() {
      const select = document.getElementById('courseTeacherId');
      select.innerHTML = '<option value="">è«‹é¸æ“‡å¸«è³‡</option>';
      teachers.forEach(t => {
        select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
      });
    }

    function updateTodayDate() {
      const today = new Date();
      const dateStr = today.toLocaleDateString('zh-TW', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      });
      document.getElementById('todayDate').textContent = dateStr;
    }

    // ==================== çµ±è¨ˆåˆ†æ ====================
    function updateStatistics() {
      // æ ¹æ“šé¸æ“‡çš„å¸«è³‡éæ¿¾èª²ç¨‹
      let filteredCourses = courseAssignments;
      if (selectedTeacherId !== null) {
        filteredCourses = courseAssignments.filter(c => c.teacherId === selectedTeacherId);
      }

      // ç¸½èª²ç¨‹æ•¸
      document.getElementById('totalCoursesCount').textContent = filteredCourses.length;

      // ç¸½æ™‚æ•¸
      const totalHours = filteredCourses.reduce((sum, c) => sum + calculateHours(c.time), 0);
      document.getElementById('totalHoursCount').textContent = `${totalHours.toFixed(1)} å°æ™‚`;

      // æœ¬æœˆæ™‚æ•¸
      const thisMonth = new Date().toISOString().slice(0, 7);
      const monthlyHours = filteredCourses
        .filter(c => c.date.startsWith(thisMonth))
        .reduce((sum, c) => sum + calculateHours(c.time), 0);
      document.getElementById('monthlyHoursCount').textContent = `${monthlyHours.toFixed(1)} å°æ™‚`;
    }

    function renderTeacherHoursAnalysis() {
      const thisMonth = new Date().toISOString().slice(0, 7);
      const listContainer = document.getElementById('teacherHoursList');
      const showMoreContainer = document.getElementById('showMoreContainer');

      if (teachers.length === 0) {
        listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">å°šç„¡å¸«è³‡è³‡æ–™</p>';
        showMoreContainer.style.display = 'none';
        return;
      }

      // éæ¿¾å¸«è³‡ï¼ˆæ ¹æ“šæœå°‹æ¢ä»¶ï¼‰
      let filteredTeachers = teachers;
      if (teacherSearchQuery.trim() !== '') {
        filteredTeachers = teachers.filter(teacher =>
          teacher.name.toLowerCase().includes(teacherSearchQuery.toLowerCase())
        );
      }

      if (filteredTeachers.length === 0) {
        listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">æ‰¾ä¸åˆ°ç¬¦åˆçš„å¸«è³‡</p>';
        showMoreContainer.style.display = 'none';
        return;
      }

      // æ±ºå®šé¡¯ç¤ºçš„å¸«è³‡æ•¸é‡
      const displayLimit = 4;
      const shouldShowMore = filteredTeachers.length > displayLimit && teacherSearchQuery === '';
      const displayTeachers = (shouldShowMore && !showAllTeachers)
        ? filteredTeachers.slice(0, displayLimit)
        : filteredTeachers;

      // é¡¯ç¤º/éš±è—ã€Œé¡¯ç¤ºæ›´å¤šã€æŒ‰éˆ•
      if (shouldShowMore) {
        showMoreContainer.style.display = 'block';
        document.getElementById('showMoreText').textContent = showAllTeachers ? 'æ”¶åˆ' : 'é¡¯ç¤ºæ›´å¤š';
        document.getElementById('showMoreIcon').textContent = showAllTeachers ? 'â–²' : 'â–¼';
      } else {
        showMoreContainer.style.display = 'none';
      }

      // æ¸²æŸ“å¸«è³‡åˆ—è¡¨
      listContainer.innerHTML = displayTeachers.map(teacher => {
        const courses = courseAssignments.filter(c =>
          c.teacherId === teacher.id && c.date.startsWith(thisMonth)
        );
        const hours = courses.reduce((sum, c) => sum + calculateHours(c.time), 0);
        const percentage = Math.min((hours / 12) * 100, 100);

        let statusClass = 'bg-red-500';
        let statusText = 'æœªé”æ¨™';
        if (hours >= 12) {
          statusClass = 'bg-green-500';
          statusText = 'å·²é”æ¨™';
        } else if (hours >= 8) {
          statusClass = 'bg-yellow-500';
          statusText = 'æ¥è¿‘é”æ¨™';
        }

        const isSelected = selectedTeacherId === teacher.id;
        const selectedStyle = isSelected
          ? 'border-2 border-blue-500 bg-blue-50 shadow-lg'
          : 'border border-gray-200 hover:border-blue-300 hover:shadow-md';

        return `
          <div onclick="selectTeacher(${teacher.id})"
               class="${selectedStyle} rounded-xl p-4 cursor-pointer transition-all duration-300">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold">
                  ${(teacher.name || '?')[0]}
                </div>
                <div>
                  <h4 class="font-semibold text-gray-900">${teacher.name}</h4>
                  <p class="text-xs text-gray-500">${courses.length} å ‚èª²</p>
                </div>
              </div>
              <div class="text-right">
                <p class="text-sm font-bold text-gray-900">${hours.toFixed(1)} / 12 å°æ™‚</p>
                <span class="text-xs ${statusClass} text-white px-2 py-1 rounded-full">${statusText}</span>
              </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
              <div class="${statusClass} h-3 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
            </div>
            ${isSelected ? '<p class="text-xs text-blue-600 font-semibold mt-2 text-center">âœ“ å·²é¸æ“‡</p>' : ''}
          </div>
        `;
      }).join('');
    }

    function filterTeachers() {
      teacherSearchQuery = document.getElementById('teacherSearchInput').value;
      showAllTeachers = false; // é‡ç½®å±•é–‹ç‹€æ…‹
      renderTeacherHoursAnalysis();
    }

    function toggleShowAllTeachers() {
      showAllTeachers = !showAllTeachers;
      renderTeacherHoursAnalysis();
    }

    // ==================== èª²ç¨‹é¡å‹åˆ†ä½ˆåœ– ====================
    function renderCourseTypeChart() {
      // æ ¹æ“šé¸æ“‡çš„å¸«è³‡éæ¿¾èª²ç¨‹
      let filteredCourses = courseAssignments;
      if (selectedTeacherId !== null) {
        filteredCourses = courseAssignments.filter(c => c.teacherId === selectedTeacherId);
      }

      const typeCount = {};
      filteredCourses.forEach(c => {
        typeCount[c.type] = (typeCount[c.type] || 0) + 1;
      });

      const typeCtx = document.getElementById('courseTypeChart').getContext('2d');
      if (courseTypeChart) courseTypeChart.destroy();

      courseTypeChart = new Chart(typeCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(typeCount),
          datasets: [{
            data: Object.values(typeCount),
            backgroundColor: ['#007aff', '#34c759', '#ff9500', '#ff3b30', '#5856d6'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: { size: 14 },
                padding: 15
              }
            }
          }
        }
      });
    }

    // ==================== å¸«è³‡é¸æ“‡åŠŸèƒ½ ====================
    function selectTeacher(teacherId) {
      selectedTeacherId = teacherId;
      const teacher = teachers.find(t => t.id === teacherId);

      // é¡¯ç¤ºé¸æ“‡çš„å¸«è³‡æ©«å¹…
      const banner = document.getElementById('selectedTeacherBanner');
      const nameElement = document.getElementById('selectedTeacherName');
      if (teacher) {
        nameElement.textContent = teacher.name;
        banner.style.display = 'block';
      }

      // æ›´æ–°æ‰€æœ‰ç›¸é—œæ•¸æ“š
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
    }

    function clearTeacherSelection() {
      selectedTeacherId = null;

      // éš±è—é¸æ“‡çš„å¸«è³‡æ©«å¹…
      const banner = document.getElementById('selectedTeacherBanner');
      banner.style.display = 'none';

      // æ›´æ–°æ‰€æœ‰ç›¸é—œæ•¸æ“š
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
    }

    // ==================== å¸«è³‡æ™‚æ•¸åˆ†æé¡¯ç¤º/éš±è— ====================
    function toggleTeacherHoursAnalysis() {
      const analysisContent = document.getElementById('teacherHoursAnalysis');
      const toggleIcon = document.getElementById('toggleAnalysisIcon');
      const toggleText = document.getElementById('toggleAnalysisText');

      const isVisible = analysisContent.style.display !== 'none';

      if (isVisible) {
        analysisContent.style.display = 'none';
        toggleIcon.textContent = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
        toggleText.textContent = 'é¡¯ç¤º';
        localStorage.setItem('teacherHoursAnalysisVisible', 'false');
      } else {
        analysisContent.style.display = 'block';
        toggleIcon.textContent = 'ğŸ‘ï¸';
        toggleText.textContent = 'éš±è—';
        localStorage.setItem('teacherHoursAnalysisVisible', 'true');
      }
    }

    function loadTeacherHoursAnalysisVisibility() {
      const isVisible = localStorage.getItem('teacherHoursAnalysisVisible');

      if (isVisible === 'false') {
        const analysisContent = document.getElementById('teacherHoursAnalysis');
        const toggleIcon = document.getElementById('toggleAnalysisIcon');
        const toggleText = document.getElementById('toggleAnalysisText');

        analysisContent.style.display = 'none';
        toggleIcon.textContent = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
        toggleText.textContent = 'é¡¯ç¤º';
      }
    }

    // ==================== ä»Šæ—¥èª²ç¨‹ç¸½è¦½ ====================
    function renderTodayCourses() {
      const todayStr = getLocalDateString(new Date());
      let todayCourses = courseAssignments.filter(c => c.date === todayStr);

      // æ ¹æ“šé¸æ“‡çš„å¸«è³‡éæ¿¾
      if (selectedTeacherId !== null) {
        todayCourses = todayCourses.filter(c => c.teacherId === selectedTeacherId);
      }

      const container = document.getElementById('todayCoursesContainer');

      if (todayCourses.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-2">âœ¨</div>
            <p>ä»Šå¤©æ²’æœ‰æ’èª²</p>
          </div>
        `;
        return;
      }

      // æŒ‰å¸«è³‡åˆ†çµ„
      const grouped = {};
      todayCourses.forEach(c => {
        if (!grouped[c.teacherId]) {
          grouped[c.teacherId] = [];
        }
        grouped[c.teacherId].push(c);
      });

      container.innerHTML = Object.entries(grouped).map(([teacherId, courses]) => {
        const teacher = teachers.find(t => t.id === Number(teacherId));
        if (!teacher) return '';

        return `
          <div class="bg-white rounded-xl p-4 border border-gray-200">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 p-0.5">
                  <div class="w-full h-full rounded-full bg-white flex items-center justify-center">
                    ${teacher.photo ?
                      `<img src="${teacher.photo}" class="w-full h-full object-cover rounded-full">` :
                      `<span class="text-lg font-bold text-gray-600">${(teacher.name || '?')[0]}</span>`
                    }
                  </div>
                </div>
                <div>
                  <h4 class="font-semibold text-gray-800">${teacher.name}</h4>
                  <p class="text-xs text-gray-500">${courses.length} å ‚èª²</p>
                </div>
              </div>
            </div>
            <div class="space-y-2">
              ${courses.sort((a, b) => a.time.localeCompare(b.time)).map(c => {
                const statusColors = {
                  'ä¸Šç­': 'bg-blue-50 text-blue-700 border-blue-200',
                  'ä¼‘å‡': 'bg-green-50 text-green-700 border-green-200',
                  'å‡ºå·®': 'bg-orange-50 text-orange-700 border-orange-200'
                };
                const statusClass = statusColors[c.status] || statusColors['ä¸Šç­'];

                return `
                  <div class="bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100 transition-colors border border-gray-200" onclick="viewEvent(${c.id})">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <p class="font-medium text-gray-800">${c.name}</p>
                        <div class="flex items-center flex-wrap gap-2 text-xs text-gray-600 mt-2">
                          <span>ğŸ• ${c.time}</span>
                          <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded border border-blue-200">${c.type}</span>
                          <span class="px-2 py-0.5 ${statusClass} rounded border">${c.status || 'ä¸Šç­'}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    // ==================== è¡Œäº‹æ›† ====================
    function setViewMode(mode) {
      viewMode = mode;
      const monthBtn = document.getElementById('monthViewBtn');
      const weekBtn = document.getElementById('weekViewBtn');

      if (mode === 'month') {
        monthBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-blue-600 text-white';
        weekBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold text-gray-600 hover:bg-gray-200';
        document.getElementById('prevLabel').textContent = 'ä¸Šå€‹æœˆ';
        document.getElementById('nextLabel').textContent = 'ä¸‹å€‹æœˆ';
      } else {
        weekBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold bg-blue-600 text-white';
        monthBtn.className = 'px-4 py-2 rounded-lg text-sm font-semibold text-gray-600 hover:bg-gray-200';
        document.getElementById('prevLabel').textContent = 'ä¸Šé€±';
        document.getElementById('nextLabel').textContent = 'ä¸‹é€±';
      }

      renderCalendar();
    }

    function previousPeriod() {
      if (viewMode === 'month') {
        currentDate.setMonth(currentDate.getMonth() - 1);
      } else {
        currentDate.setDate(currentDate.getDate() - 7);
      }
      renderCalendar();
    }

    function nextPeriod() {
      if (viewMode === 'month') {
        currentDate.setMonth(currentDate.getMonth() + 1);
      } else {
        currentDate.setDate(currentDate.getDate() + 7);
      }
      renderCalendar();
    }

    function goToToday() {
      currentDate = new Date();
      renderCalendar();
    }

    function renderCalendar() {
      if (viewMode === 'month') {
        renderMonthView();
      } else {
        renderWeekView();
      }
      renderMobileCalendar();
    }

    function renderMonthView() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const monthNames = ['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];

      document.getElementById('currentMonth').textContent = `${year}å¹´ ${monthNames[month]}`;

      const firstDay = new Date(year, month, 1);
      const start = new Date(firstDay);
      start.setDate(start.getDate() - firstDay.getDay());

      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      const todayStr = getLocalDateString(new Date());

      for (let w = 0; w < 6; w++) {
        for (let d = 0; d < 7; d++) {
          const cellDate = new Date(start);
          cellDate.setDate(start.getDate() + (w * 7) + d);

          const isCurrentMonth = (cellDate.getMonth() === month);
          const dateKey = getLocalDateString(cellDate);
          const isToday = (dateKey === todayStr);

          const dayEvents = courseAssignments.filter(c => c.date === dateKey);

          const cell = document.createElement('div');
          cell.className = `calendar-day p-2 ${
            isCurrentMonth ? 'bg-white' : 'bg-gray-50'
          } ${isToday ? 'today-highlight' : ''}`;

          cell.innerHTML = `
            <div class="flex justify-between items-start mb-1">
              <span class="text-base font-semibold ${isCurrentMonth ? (isToday ? 'text-blue-600' : 'text-gray-800') : 'text-gray-400'}">
                ${cellDate.getDate()}
              </span>
            </div>
            <div class="space-y-1 overflow-y-auto max-h-20">
              ${dayEvents.map(e => {
                const teacher = teachers.find(t => t.id === e.teacherId);
                const teacherName = teacher ? teacher.name : 'æœªçŸ¥';
                return `
                  <div class="event-item bg-blue-500 text-white rounded cursor-pointer hover:bg-blue-600"
                       onclick="viewEvent(${e.id})">
                    <div class="font-medium truncate">${teacherName}</div>
                    <div class="text-[10px] truncate">${e.time} ${e.name}</div>
                  </div>
                `;
              }).join('')}
            </div>
          `;

          grid.appendChild(cell);
        }
      }
    }

    function renderWeekView() {
      const startOfWeek = new Date(currentDate);
      startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);

      const monthNames = ['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'];
      document.getElementById('currentMonth').textContent =
        `${startOfWeek.getFullYear()}å¹´ ${monthNames[startOfWeek.getMonth()]} ${startOfWeek.getDate()}æ—¥ - ${endOfWeek.getDate()}æ—¥`;

      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      const dayNames = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
      const todayStr = getLocalDateString(new Date());

      for (let i = 0; i < 7; i++) {
        const cellDate = new Date(startOfWeek);
        cellDate.setDate(startOfWeek.getDate() + i);

        const dateKey = getLocalDateString(cellDate);
        const isToday = (dateKey === todayStr);
        const dayEvents = courseAssignments.filter(c => c.date === dateKey);

        const cell = document.createElement('div');
        cell.className = `calendar-day p-4 bg-white ${isToday ? 'today-highlight' : ''}`;

        cell.innerHTML = `
          <div class="text-center mb-4 pb-3 border-b border-gray-200">
            <div class="text-sm font-semibold ${isToday ? 'text-blue-600' : 'text-gray-600'}">${dayNames[i]}</div>
            <div class="text-2xl font-bold ${isToday ? 'text-blue-600' : 'text-gray-800'}">
              ${cellDate.getDate()}
            </div>
          </div>
          <div class="space-y-2">
            ${dayEvents.map(e => {
              const teacher = teachers.find(t => t.id === e.teacherId);
              const teacherName = teacher ? teacher.name : 'æœªçŸ¥';
              return `
                <div class="event-item bg-blue-500 text-white p-3 rounded-xl cursor-pointer hover:bg-blue-600"
                     onclick="viewEvent(${e.id})">
                  <div class="font-semibold">${teacherName}</div>
                  <div class="text-xs mt-1">â° ${e.time}</div>
                  <div class="text-xs">${e.name}</div>
                </div>
              `;
            }).join('')}
          </div>
        `;

        grid.appendChild(cell);
      }
    }

    function renderMobileCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const todayStr = getLocalDateString(new Date());

      const container = document.getElementById('mobileEventsList');
      let html = '';

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateKey = getLocalDateString(date);
        const dayEvents = courseAssignments.filter(c => c.date === dateKey);
        const isToday = dateKey === todayStr;

        if (dayEvents.length > 0 || isToday) {
          const dayNames = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
          html += `
            <div class="border border-gray-200 rounded-lg p-3 ${isToday ? 'bg-blue-50 border-blue-500' : 'bg-white'}">
              <div class="flex items-center justify-between mb-2">
                <span class="font-bold text-gray-800">${month + 1}æœˆ${day}æ—¥ (${dayNames[date.getDay()]})</span>
                ${isToday ? '<span class="text-xs bg-blue-500 text-white px-2 py-1 rounded">ä»Šå¤©</span>' : ''}
              </div>
              ${dayEvents.length === 0 ?
                '<p class="text-sm text-gray-500">ç„¡èª²ç¨‹</p>' :
                dayEvents.map(e => {
                  const teacher = teachers.find(t => t.id === e.teacherId);
                  const teacherName = teacher ? teacher.name : 'æœªçŸ¥';
                  return `
                    <div class="mt-2 p-2 bg-blue-500 text-white rounded-lg cursor-pointer hover:bg-blue-600" onclick="viewEvent(${e.id})">
                      <div class="font-semibold text-sm">${teacherName} - ${e.name}</div>
                      <div class="text-xs mt-1">â° ${e.time} | ğŸ“š ${e.type}</div>
                    </div>
                  `;
                }).join('')
              }
            </div>
          `;
        }
      }

      if (!html) {
        html = '<p class="text-center text-gray-500 py-8">æœ¬æœˆç„¡èª²ç¨‹</p>';
      }

      container.innerHTML = html;
    }

    // ==================== Modal ç®¡ç† ====================
    function openAddCourseModal() {
      document.getElementById('courseDate').value = getLocalDateString(new Date());
      document.getElementById('addCourseModal').classList.remove('hidden');
    }

    function closeAddCourseModal() {
      document.getElementById('addCourseModal').classList.add('hidden');
      document.getElementById('courseForm').reset();
    }

    function viewEvent(courseId) {
      const course = courseAssignments.find(c => c.id === courseId);
      if (!course) return;

      editingCourseId = courseId;
      const teacher = teachers.find(t => t.id === course.teacherId);

      // é¡¯ç¤ºæŸ¥çœ‹æ¨¡å¼
      document.getElementById('modalTitle').textContent = 'ğŸ“… èª²ç¨‹è©³æƒ…';
      document.getElementById('viewMode').style.display = 'block';
      document.getElementById('editCourseForm').style.display = 'none';
      document.getElementById('viewModeButtons').style.display = 'flex';
      document.getElementById('editModeButtons').style.display = 'none';

      document.getElementById('viewMode').innerHTML = `
        <div class="bg-gray-50 rounded-xl p-4 space-y-3 border border-gray-200">
          <div>
            <label class="text-xs font-medium text-gray-600">å¸«è³‡</label>
            <p class="text-lg font-semibold text-gray-900">ğŸ‘¨â€ğŸ« ${teacher ? teacher.name : 'æœªçŸ¥'}</p>
          </div>
          <div>
            <label class="text-xs font-medium text-gray-600">èª²ç¨‹åç¨±</label>
            <p class="text-lg font-semibold text-gray-900">${course.name}</p>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-medium text-gray-600">æ—¥æœŸ</label>
              <p class="text-sm text-gray-800">ğŸ“… ${course.date}</p>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-600">æ™‚é–“</label>
              <p class="text-sm text-gray-800">â° ${course.time}</p>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-medium text-gray-600">èª²ç¨‹é¡å‹</label>
              <p class="text-sm text-gray-800">ğŸ“š ${course.type}</p>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-600">ç‹€æ…‹</label>
              <p class="text-sm text-gray-800">ğŸ’¼ ${course.status || 'ä¸Šç­'}</p>
            </div>
          </div>
          ${course.note ? `
          <div>
            <label class="text-xs font-medium text-gray-600">å‚™è¨»</label>
            <p class="text-sm text-gray-800 whitespace-pre-wrap">${course.note}</p>
          </div>
          ` : '<div class="text-center text-gray-400 text-sm py-2">ç„¡å‚™è¨»</div>'}
        </div>
      `;

      document.getElementById('deleteEventBtn').onclick = () => {
        if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤èª²ç¨‹å—ï¼Ÿ')) {
          deleteCourse(courseId);
          closeViewEventModal();
        }
      };

      document.getElementById('viewEventModal').classList.remove('hidden');
    }

    function enterEditMode() {
      const course = courseAssignments.find(c => c.id === editingCourseId);
      if (!course) return;

      // è¼‰å…¥å¸«è³‡åˆ—è¡¨åˆ°ç·¨è¼¯è¡¨å–®
      const editTeacherSelect = document.getElementById('editTeacherId');
      editTeacherSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¸«è³‡</option>';
      teachers.forEach(t => {
        editTeacherSelect.innerHTML += `<option value="${t.id}" ${t.id === course.teacherId ? 'selected' : ''}>${t.name}</option>`;
      });

      // å¡«å…¥èª²ç¨‹è³‡æ–™
      document.getElementById('editCourseName').value = course.name;
      document.getElementById('editCourseDate').value = course.date;
      document.getElementById('editCourseType').value = course.type;

      const [startTime, endTime] = course.time.split('-');
      document.getElementById('editStartTime').value = startTime;
      document.getElementById('editEndTime').value = endTime;

      document.getElementById('editCourseStatus').value = course.status || 'ä¸Šç­';
      document.getElementById('editCourseNote').value = course.note || '';

      // åˆ‡æ›åˆ°ç·¨è¼¯æ¨¡å¼
      document.getElementById('modalTitle').textContent = 'âœï¸ ç·¨è¼¯èª²ç¨‹';
      document.getElementById('viewMode').style.display = 'none';
      document.getElementById('editCourseForm').style.display = 'block';
      document.getElementById('viewModeButtons').style.display = 'none';
      document.getElementById('editModeButtons').style.display = 'flex';
    }

    function cancelEditMode() {
      // è¿”å›æŸ¥çœ‹æ¨¡å¼
      viewEvent(editingCourseId);
    }

    function saveEditedCourse() {
      const teacherId = Number(document.getElementById('editTeacherId').value);
      if (!teacherId) {
        alert('è«‹é¸æ“‡å¸«è³‡ï¼');
        return;
      }

      const startTime = document.getElementById('editStartTime').value;
      const endTime = document.getElementById('editEndTime').value;
      const courseDate = document.getElementById('editCourseDate').value;

      // æ‰¾åˆ°è¦ç·¨è¼¯çš„èª²ç¨‹
      const courseIndex = courseAssignments.findIndex(c => c.id === editingCourseId);
      if (courseIndex === -1) return;

      const oldCourse = courseAssignments[courseIndex];

      // æª¢æŸ¥æ™‚é–“è¡çªï¼ˆæ’é™¤è‡ªå·±ï¼‰
      const newTime = `${startTime}-${endTime}`;
      const conflicts = checkConflictExcludingSelf(
        editingCourseId,
        teacherId,
        courseDate,
        newTime
      );

      if (conflicts.length > 0) {
        if (!confirm(`âš ï¸ è¡å ‚è­¦å‘Šï¼\n\n${conflicts.join('\n')}\n\næ˜¯å¦ä»è¦ç¹¼çºŒï¼Ÿ`)) {
          return;
        }
      }

      // æ›´æ–°èª²ç¨‹è³‡æ–™
      courseAssignments[courseIndex] = {
        ...oldCourse,
        teacherId: teacherId,
        name: document.getElementById('editCourseName').value,
        date: courseDate,
        time: newTime,
        type: document.getElementById('editCourseType').value,
        status: document.getElementById('editCourseStatus').value,
        note: document.getElementById('editCourseNote').value.trim()
      };

      // åŒæ­¥æ›´æ–°è¡Œäº‹æ›†äº‹ä»¶
      const eventIndex = calendarEvents.findIndex(e => e.courseId === editingCourseId);
      if (eventIndex !== -1) {
        const teacher = teachers.find(t => t.id === teacherId);
        calendarEvents[eventIndex] = {
          ...calendarEvents[eventIndex],
          date: courseDate,
          title: `${courseAssignments[courseIndex].name} - ${teacher.name}`,
          time: newTime,
          teacherId: teacherId,
          location: courseAssignments[courseIndex].type,
          color: getCourseTypeColor(courseAssignments[courseIndex].type)
        };
      }

      saveData();
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
      renderCalendar();
      closeViewEventModal();
      alert('âœ… èª²ç¨‹å·²æ›´æ–°ï¼');
    }

    function checkConflictExcludingSelf(excludeId, teacherId, date, time) {
      const conflicts = [];
      const timeToMinutes = (t) => {
        const [h, m] = t.split(':').map(Number);
        return h * 60 + m;
      };

      const [newStart, newEnd] = time.split('-');
      const newStartMin = timeToMinutes(newStart);
      const newEndMin = timeToMinutes(newEnd);

      courseAssignments.forEach(c => {
        if (c.id !== excludeId && c.teacherId === teacherId && c.date === date) {
          const [start, end] = c.time.split('-');
          const startMin = timeToMinutes(start);
          const endMin = timeToMinutes(end);

          if (!(newEndMin <= startMin || newStartMin >= endMin)) {
            conflicts.push(`- ${c.name} (${c.time})`);
          }
        }
      });

      return conflicts;
    }

    function closeViewEventModal() {
      document.getElementById('viewEventModal').classList.add('hidden');
      editingCourseId = null;
    }

    // ==================== èª²ç¨‹ç®¡ç† ====================
    function handleAddCourse(e) {
      e.preventDefault();

      const teacherId = Number(document.getElementById('courseTeacherId').value);
      if (!teacherId) {
        alert('è«‹é¸æ“‡å¸«è³‡ï¼');
        return;
      }

      const courseData = {
        id: Date.now(),
        teacherId: teacherId,
        name: document.getElementById('courseName').value,
        date: document.getElementById('courseDate').value,
        time: `${document.getElementById('startTime').value}-${document.getElementById('endTime').value}`,
        type: document.getElementById('courseType').value,
        status: document.getElementById('courseStatus').value,
        note: document.getElementById('courseNote').value.trim()
      };

      // è¡å ‚æª¢æŸ¥
      const conflicts = checkConflict(courseData);
      if (conflicts.length > 0) {
        if (!confirm(`âš ï¸ è¡å ‚è­¦å‘Šï¼\n\n${conflicts.join('\n')}\n\næ˜¯å¦ä»è¦ç¹¼çºŒï¼Ÿ`)) {
          return;
        }
      }

      courseAssignments.push(courseData);

      // åŒæ­¥åˆ°è¡Œäº‹æ›†
      const teacher = teachers.find(t => t.id === teacherId);
      calendarEvents.push({
        id: courseData.id,
        date: courseData.date,
        title: `${courseData.name} - ${teacher.name}`,
        time: courseData.time,
        teacherId: teacherId,
        location: courseData.type,
        color: getCourseTypeColor(courseData.type),
        courseId: courseData.id
      });

      saveData();
      closeAddCourseModal();
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
      renderCalendar();
      alert('âœ… èª²ç¨‹æ–°å¢æˆåŠŸï¼');
    }

    function deleteCourse(id) {
      courseAssignments = courseAssignments.filter(c => c.id !== id);
      calendarEvents = calendarEvents.filter(e => e.courseId !== id);
      saveData();
      updateStatistics();
      renderTeacherHoursAnalysis();
      renderCourseTypeChart();
      renderTodayCourses();
      renderCalendar();
      alert('âœ… èª²ç¨‹å·²åˆªé™¤ï¼');
    }

    // ==================== å·¥å…·å‡½æ•¸ ====================
    function calculateHours(timeRange) {
      const [start, end] = timeRange.split('-');
      const startTime = new Date(`2024-01-01 ${start}`);
      const endTime = new Date(`2024-01-01 ${end}`);
      return (endTime - startTime) / (1000 * 60 * 60);
    }

    function checkConflict(newCourse) {
      const conflicts = [];
      const timeToMinutes = (time) => {
        const [h, m] = time.split(':').map(Number);
        return h * 60 + m;
      };

      const [newStart, newEnd] = newCourse.time.split('-');
      const newStartMin = timeToMinutes(newStart);
      const newEndMin = timeToMinutes(newEnd);

      courseAssignments.forEach(c => {
        if (c.teacherId === newCourse.teacherId && c.date === newCourse.date) {
          const [start, end] = c.time.split('-');
          const startMin = timeToMinutes(start);
          const endMin = timeToMinutes(end);

          if (!(newEndMin <= startMin || newStartMin >= endMin)) {
            conflicts.push(`- ${c.name} (${c.time})`);
          }
        }
      });

      return conflicts;
    }

    function getCourseTypeColor(type) {
      const colors = {
        'æ­£èª²': 'bg-blue-500',
        'è£œèª²': 'bg-yellow-500',
        'å¯¦é©—èª²': 'bg-purple-500',
        'å¯¦ä½œèª²': 'bg-green-500',
        'å°ˆé¡Œ': 'bg-red-500'
      };
      return colors[type] || 'bg-gray-500';
    }

    function saveData() {
      try {
        localStorage.setItem('teachers', JSON.stringify(teachers));
        localStorage.setItem('courseAssignments', JSON.stringify(courseAssignments));
        localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
      } catch (err) {
        console.error('å„²å­˜å¤±æ•—:', err);
      }
    }

    // ==================== å•Ÿå‹•æ‡‰ç”¨ ====================
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
