<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ´¾èª²ç®¡ç†ç³»çµ±</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- XLSX åº« -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      animation: fadeInDown 0.8s ease-out;
    }

    .header h1 {
      font-size: 48px;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: #1d1d1f;
      margin-bottom: 8px;
    }

    .header p {
      font-size: 19px;
      color: #6e6e73;
      font-weight: 400;
    }

    .back-button {
      display: inline-flex;
      align-items: center;
      padding: 12px 24px;
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 12px;
      color: #1d1d1f;
      text-decoration: none;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .back-button:hover {
      background: #f5f5f7;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      transform: translateX(-4px);
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 32px;
      box-shadow: 0 2px 16px rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(0, 0, 0, 0.04);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-bottom: 24px;
    }

    .card:hover {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    }

    .stat-card {
      background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
      border-radius: 18px;
      padding: 28px;
      color: white;
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
      transition: all 0.4s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 16px 48px rgba(0, 122, 255, 0.3);
    }

    .stat-card:hover::before {
      top: -30%;
      right: -30%;
    }

    .stat-card.purple {
      background: linear-gradient(135deg, #5856d6 0%, #3634a3 100%);
    }

    .stat-card.purple:hover {
      box-shadow: 0 16px 48px rgba(88, 86, 214, 0.3);
    }

    .stat-card.green {
      background: linear-gradient(135deg, #34c759 0%, #248a3d 100%);
    }

    .stat-card.green:hover {
      box-shadow: 0 16px 48px rgba(52, 199, 89, 0.3);
    }

    .stat-card.orange {
      background: linear-gradient(135deg, #ff9500 0%, #c76a00 100%);
    }

    .stat-card.orange:hover {
      box-shadow: 0 16px 48px rgba(255, 149, 0, 0.3);
    }

    .btn-primary {
      background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
      color: white;
      padding: 14px 28px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 16px rgba(0, 122, 255, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 122, 255, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .input-field {
      width: 100%;
      padding: 14px 18px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.3s ease;
      background: #ffffff;
    }

    .input-field:focus {
      outline: none;
      border-color: #007aff;
      box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 24px 64px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }

    .course-timeline-item {
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 14px;
      padding: 24px;
      margin-bottom: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: white;
    }

    .course-timeline-item:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      transform: translateY(-2px);
      border-color: #007aff;
    }

    .type-card {
      border-radius: 14px;
      padding: 20px;
      text-align: center;
      color: white;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .type-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
    }

    .date-range-btn {
      padding: 10px 20px;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      background: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .date-range-btn:hover {
      background: #007aff;
      color: white;
      border-color: #007aff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }

    /* å¾®å¦™çš„èƒŒæ™¯ç´‹ç† */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(0, 122, 255, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(88, 86, 214, 0.03) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- è¿”å›é¦–é æŒ‰éˆ• -->
    <div style="margin-bottom: 30px;">
      <a href="index.html" class="back-button">
        <span style="margin-right: 8px;">â†</span> è¿”å›é¦–é 
      </a>
    </div>

    <!-- æ¨™é¡Œ -->
    <div class="header">
      <h1>æ´¾èª²ç®¡ç†ç³»çµ±</h1>
      <p>ç®¡ç†å¸«è³‡èª²ç¨‹åˆ†é…èˆ‡æ™‚æ•¸çµ±è¨ˆ</p>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="fade-in">
      <!-- å¸«è³‡é¸æ“‡èˆ‡æ—¥æœŸç¯„åœ -->
      <div class="card">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
          <div>
            <label style="display: block; font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">é¸æ“‡å¸«è³‡</label>
            <select id="courseTeacherSelect" onchange="updateCourseView()" class="input-field">
              <option value="">è«‹é¸æ“‡å¸«è³‡</option>
            </select>
          </div>
          <div>
            <label style="display: block; font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">é–‹å§‹æ—¥æœŸ</label>
            <input type="date" id="courseStartDate" onchange="updateCourseView()" class="input-field">
          </div>
          <div>
            <label style="display: block; font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">çµæŸæ—¥æœŸ</label>
            <input type="date" id="courseEndDate" onchange="updateCourseView()" class="input-field">
          </div>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap;">
          <button onclick="setCourseDateRange('thisMonth')" class="date-range-btn">æœ¬æœˆ</button>
          <button onclick="setCourseDateRange('lastMonth')" class="date-range-btn">ä¸Šæœˆ</button>
          <button onclick="setCourseDateRange('last3Months')" class="date-range-btn">è¿‘3æœˆ</button>
          <button onclick="setCourseDateRange('last6Months')" class="date-range-btn">è¿‘åŠå¹´</button>
          <button onclick="setCourseDateRange('thisYear')" class="date-range-btn">ä»Šå¹´</button>
        </div>
      </div>

      <!-- çµ±è¨ˆå¡ç‰‡ -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px;">
        <div class="stat-card">
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">æˆèª²æ™‚æ•¸</div>
            <div id="courseTotalHours" style="font-size: 42px; font-weight: 700; margin-bottom: 4px;">0</div>
            <div style="font-size: 12px; opacity: 0.8;">å°æ™‚</div>
          </div>
        </div>

        <div class="stat-card purple">
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">èª²ç¨‹æ•¸é‡</div>
            <div id="courseTotalCount" style="font-size: 42px; font-weight: 700; margin-bottom: 4px;">0</div>
            <div style="font-size: 12px; opacity: 0.8;">é–€èª²ç¨‹</div>
          </div>
        </div>

        <div class="stat-card green">
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">æœ¬æœˆæ™‚æ•¸</div>
            <div id="courseMonthlyHours" style="font-size: 42px; font-weight: 700; margin-bottom: 4px;">0</div>
            <div style="font-size: 12px; opacity: 0.8;">å°æ™‚</div>
          </div>
        </div>

        <div class="stat-card orange">
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ä»Šæ—¥èª²ç¨‹</div>
            <div id="courseTodayCount" style="font-size: 42px; font-weight: 700; margin-bottom: 4px;">0</div>
            <div style="font-size: 12px; opacity: 0.8;">é–€èª²ç¨‹</div>
          </div>
        </div>
      </div>

      <!-- èª²ç¨‹é¡å‹åˆ†æ -->
      <div class="card">
        <h3 style="font-size: 20px; font-weight: 600; color: #1d1d1f; margin-bottom: 24px;">èª²ç¨‹é¡å‹åˆ†æ</h3>
        <div id="courseTypeCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
          <!-- å‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>

      <!-- è€å¸«æœ¬é€±èª²è¡¨ -->
      <div id="teacherWeekSchedule" class="card" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h3 style="font-size: 20px; font-weight: 600; color: #1d1d1f;">æœ¬é€±èª²è¡¨ - å³æ™‚æª¢è¦–å¯ç”¨æ™‚æ®µ</h3>
          <span style="font-size: 13px; color: #6e6e73;">ç¶ è‰²ï¼šå¯ç”¨ | ç´…è‰²ï¼šå·²ä½”ç”¨</span>
        </div>
        <div id="teacherWeekScheduleContent">
          <!-- å‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>

      <!-- èª²ç¨‹æ™‚é–“è»¸ -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h3 style="font-size: 20px; font-weight: 600; color: #1d1d1f;">èª²ç¨‹æ™‚é–“è»¸</h3>
          <button onclick="openAddCourseModal()" class="btn-primary">
            <span style="margin-right: 8px;">â•</span>æ–°å¢èª²ç¨‹
          </button>
        </div>
        <div id="courseTimeline" style="max-height: 600px; overflow-y: auto;">
          <div style="text-align: center; color: #6e6e73; padding: 48px 0;">
            è«‹é¸æ“‡å¸«è³‡ä»¥æŸ¥çœ‹èª²ç¨‹
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ–°å¢èª²ç¨‹ Modal -->
  <div id="addCourseModal" class="modal">
    <div class="modal-content">
      <h3 style="font-size: 28px; font-weight: 600; color: #1d1d1f; margin-bottom: 24px;">æ–°å¢èª²ç¨‹</h3>
      <form id="addCourseForm" onsubmit="addCourseSubmit(event)" style="display: flex; flex-direction: column; gap: 20px;">
        <div>
          <label style="display: block; font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">èª²ç¨‹åç¨±</label>
          <input type="text" id="addCourseName" required class="input-field" placeholder="è«‹è¼¸å…¥èª²ç¨‹åç¨±">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div>
            <label style="display: block; font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">èª²ç¨‹æ—¥æœŸ</label>
            <input type="date" id="addCourseDate" required class="input-field">
          </div>
          <div>
            <label style="display: block; font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">èª²ç¨‹é¡å‹</label>
            <select id="addCourseType" class="input-field">
              <option value="æ­£èª²">æ­£èª²</option>
              <option value="è£œèª²">è£œèª²</option>
              <option value="å¯¦é©—èª²">å¯¦é©—èª²</option>
              <option value="å¯¦ä½œèª²">å¯¦ä½œèª²</option>
              <option value="å°ˆé¡Œ">å°ˆé¡Œ</option>
            </select>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div>
            <label style="display: block; font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">é–‹å§‹æ™‚é–“</label>
            <input type="time" id="addCourseStartTime" required class="input-field">
          </div>
          <div>
            <label style="display: block; font-size: 14px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px;">çµæŸæ™‚é–“</label>
            <input type="time" id="addCourseEndTime" required class="input-field">
          </div>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 12px;">
          <button type="button" onclick="closeAddCourseModal()" style="padding: 14px 28px; background: #f5f5f7; color: #1d1d1f; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
            å–æ¶ˆ
          </button>
          <button type="submit" class="btn-primary">ç¢ºèªæ–°å¢</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ========== æ•¸æ“šç®¡ç† ==========
    let teachers = JSON.parse(localStorage.getItem('teachers') || '[]');
    let courseAssignments = JSON.parse(localStorage.getItem('courseAssignments') || '[]');
    let calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
    let currentCourseTeacherId = null;
    let currentCourseStartDate = null;
    let currentCourseEndDate = null;

    // ========== åˆå§‹åŒ– ==========
    function init() {
      // è¼‰å…¥å¸«è³‡åˆ—è¡¨
      const teacherSelect = document.getElementById('courseTeacherSelect');
      teacherSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¸«è³‡</option>';
      teachers.forEach(teacher => {
        const option = document.createElement('option');
        option.value = String(teacher.id);
        option.textContent = teacher.name;
        teacherSelect.appendChild(option);
      });

      // åˆå§‹åŒ–æ—¥æœŸç‚ºæœ¬æœˆ
      initCourseDates();
    }

    // ========== æ—¥æœŸç®¡ç† ==========
    function initCourseDates() {
      const today = new Date();
      const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
      const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);

      currentCourseStartDate = startDate.toISOString().split('T')[0];
      currentCourseEndDate = endDate.toISOString().split('T')[0];

      document.getElementById('courseStartDate').value = currentCourseStartDate;
      document.getElementById('courseEndDate').value = currentCourseEndDate;
    }

    function setCourseDateRange(range) {
      const today = new Date();
      let startDate, endDate;

      switch(range) {
        case 'thisMonth':
          startDate = new Date(today.getFullYear(), today.getMonth(), 1);
          endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
          break;
        case 'lastMonth':
          startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
          endDate = new Date(today.getFullYear(), today.getMonth(), 0);
          break;
        case 'last3Months':
          startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
          endDate = today;
          break;
        case 'last6Months':
          startDate = new Date(today.getFullYear(), today.getMonth() - 5, 1);
          endDate = today;
          break;
        case 'thisYear':
          startDate = new Date(today.getFullYear(), 0, 1);
          endDate = today;
          break;
      }

      currentCourseStartDate = startDate.toISOString().split('T')[0];
      currentCourseEndDate = endDate.toISOString().split('T')[0];

      document.getElementById('courseStartDate').value = currentCourseStartDate;
      document.getElementById('courseEndDate').value = currentCourseEndDate;

      updateCourseView();
    }

    // ========== èª²ç¨‹è¦–åœ–æ›´æ–° ==========
    function updateCourseView() {
      const teacherId = document.getElementById('courseTeacherSelect').value;
      currentCourseTeacherId = teacherId ? Number(teacherId) : null;
      currentCourseStartDate = document.getElementById('courseStartDate').value;
      currentCourseEndDate = document.getElementById('courseEndDate').value;

      if (!currentCourseTeacherId) {
        document.getElementById('courseTimeline').innerHTML = '<div style="text-align: center; color: #6e6e73; padding: 48px 0;">è«‹é¸æ“‡å¸«è³‡ä»¥æŸ¥çœ‹èª²ç¨‹</div>';
        document.getElementById('courseTotalHours').textContent = '0';
        document.getElementById('courseTotalCount').textContent = '0';
        document.getElementById('courseMonthlyHours').textContent = '0';
        document.getElementById('courseTodayCount').textContent = '0';
        document.getElementById('courseTypeCards').innerHTML = '';
        document.getElementById('teacherWeekSchedule').style.display = 'none';
        return;
      }

      updateCourseStats();
      renderCourseTypeCards();
      renderCourseTimeline();
      renderTeacherWeekSchedule();
    }

    // ========== çµ±è¨ˆè¨ˆç®— ==========
    function calculateCourseHours(timeRange) {
      const [start, end] = timeRange.split('-');
      const startTime = new Date(`2024-01-01 ${start}`);
      const endTime = new Date(`2024-01-01 ${end}`);
      return (endTime - startTime) / (1000 * 60 * 60);
    }

    function getFilteredCourses(teacherId) {
      if (!teacherId) return [];
      return courseAssignments.filter(course => {
        const matchTeacher = Number(course.teacherId) === Number(teacherId);
        const inDateRange = (!currentCourseStartDate || !currentCourseEndDate) ||
                           (course.date >= currentCourseStartDate && course.date <= currentCourseEndDate);
        return matchTeacher && inDateRange;
      });
    }

    function updateCourseStats() {
      const filteredCourses = getFilteredCourses(currentCourseTeacherId);

      // ç¸½æ™‚æ•¸
      const totalHours = filteredCourses.reduce((sum, course) => {
        return sum + calculateCourseHours(course.time);
      }, 0);

      // èª²ç¨‹æ•¸é‡
      const totalCount = filteredCourses.length;

      // æœ¬æœˆæ™‚æ•¸
      const today = new Date();
      const monthStart = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
      const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];

      const monthCourses = courseAssignments.filter(course => {
        return course.teacherId === currentCourseTeacherId &&
               course.date >= monthStart &&
               course.date <= monthEnd;
      });

      const monthlyHours = monthCourses.reduce((sum, course) => {
        return sum + calculateCourseHours(course.time);
      }, 0);

      // ä»Šæ—¥èª²ç¨‹
      const todayStr = today.toISOString().split('T')[0];
      const todayCourses = courseAssignments.filter(course => {
        return course.teacherId === currentCourseTeacherId && course.date === todayStr;
      }).length;

      document.getElementById('courseTotalHours').textContent = Math.round(totalHours);
      document.getElementById('courseTotalCount').textContent = totalCount;
      document.getElementById('courseMonthlyHours').textContent = monthlyHours.toFixed(1);
      document.getElementById('courseTodayCount').textContent = todayCourses;
    }

    // ========== èª²ç¨‹é¡å‹åˆ†æ ==========
    function renderCourseTypeCards() {
      const filteredCourses = getFilteredCourses(currentCourseTeacherId);
      const typeCount = {};

      filteredCourses.forEach(course => {
        typeCount[course.type] = (typeCount[course.type] || 0) + 1;
      });

      const colors = {
        'æ­£èª²': 'linear-gradient(135deg, #007aff 0%, #0051d5 100%)',
        'è£œèª²': 'linear-gradient(135deg, #ff9500 0%, #c76a00 100%)',
        'å¯¦é©—èª²': 'linear-gradient(135deg, #5856d6 0%, #3634a3 100%)',
        'å¯¦ä½œèª²': 'linear-gradient(135deg, #34c759 0%, #248a3d 100%)',
        'å°ˆé¡Œ': 'linear-gradient(135deg, #ff2d55 0%, #c9002e 100%)'
      };

      const total = Object.values(typeCount).reduce((a, b) => a + b, 0);
      const container = document.getElementById('courseTypeCards');
      container.innerHTML = '';

      Object.entries(typeCount).forEach(([type, count]) => {
        const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
        const color = colors[type] || 'linear-gradient(135deg, #8e8e93 0%, #636366 100%)';

        const card = document.createElement('div');
        card.className = 'type-card';
        card.style.background = color;
        card.innerHTML = `
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px; font-weight: 600;">${type}</div>
          <div style="font-size: 36px; font-weight: 700; margin-bottom: 4px;">${count}</div>
          <div style="font-size: 12px; opacity: 0.8;">é–€èª²ç¨‹ Â· ${percentage}%</div>
        `;
        container.appendChild(card);
      });

      if (total === 0) {
        container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #6e6e73; padding: 32px;">æš«ç„¡èª²ç¨‹è³‡æ–™</div>';
      }
    }

    // ========== èª²ç¨‹æ™‚é–“è»¸ ==========
    function renderCourseTimeline() {
      const filteredCourses = getFilteredCourses(currentCourseTeacherId);
      const sortedCourses = [...filteredCourses].sort((a, b) => new Date(b.date) - new Date(a.date));

      const timeline = document.getElementById('courseTimeline');
      timeline.innerHTML = '';

      if (sortedCourses.length === 0) {
        timeline.innerHTML = '<div style="text-align: center; color: #6e6e73; padding: 48px 0;">é¸å®šæ™‚é–“ç¯„åœå…§ç„¡èª²ç¨‹è³‡æ–™</div>';
        return;
      }

      sortedCourses.forEach(course => {
        const hours = calculateCourseHours(course.time);
        const courseDate = new Date(course.date);
        const today = new Date();
        const isPast = courseDate < today;
        const isToday = courseDate.toDateString() === today.toDateString();

        let statusBg, statusText;
        if (isPast) {
          statusBg = '#34c759';
          statusText = 'å·²å®Œæˆ';
        } else if (isToday) {
          statusBg = '#ff9500';
          statusText = 'é€²è¡Œä¸­';
        } else {
          statusBg = '#007aff';
          statusText = 'æœªä¾†';
        }

        const item = document.createElement('div');
        item.className = 'course-timeline-item';
        item.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <h4 style="font-size: 18px; font-weight: 600; color: #1d1d1f;">${course.name}</h4>
                <span style="padding: 4px 12px; background: ${statusBg}; color: white; font-size: 12px; font-weight: 600; border-radius: 8px;">${statusText}</span>
                <span style="padding: 4px 12px; background: #f5f5f7; color: #1d1d1f; font-size: 12px; font-weight: 600; border-radius: 8px;">${course.type}</span>
              </div>
              <div style="display: flex; gap: 20px; font-size: 14px; color: #6e6e73;">
                <span>ğŸ“… ${new Date(course.date).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' })}</span>
                <span>ğŸ• ${course.time}</span>
                <span>â±ï¸ ${hours.toFixed(1)}å°æ™‚</span>
              </div>
            </div>
            <button onclick="deleteCourseAssignment(${course.id})" style="padding: 10px; background: #fff; border: 1px solid rgba(0, 0, 0, 0.08); border-radius: 10px; cursor: pointer; transition: all 0.3s ease; color: #ff3b30;" onmouseover="this.style.background='#fff0ee'" onmouseout="this.style.background='#fff'">
              <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
        `;
        timeline.appendChild(item);
      });
    }

    // ========== Modal ç®¡ç† ==========
    function openAddCourseModal() {
      if (!currentCourseTeacherId) {
        alert('è«‹å…ˆé¸æ“‡å¸«è³‡');
        return;
      }
      document.getElementById('addCourseModal').classList.add('show');
      document.getElementById('addCourseDate').value = new Date().toISOString().split('T')[0];
    }

    function closeAddCourseModal() {
      document.getElementById('addCourseModal').classList.remove('show');
      document.getElementById('addCourseForm').reset();
    }

    // é»æ“Š Modal å¤–éƒ¨é—œé–‰
    document.getElementById('addCourseModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeAddCourseModal();
      }
    });

    // ========== èª²ç¨‹æ–°å¢ ==========
    function addCourseSubmit(event) {
      event.preventDefault();

      const courseName = document.getElementById('addCourseName').value;
      const courseDate = document.getElementById('addCourseDate').value;
      const startTime = document.getElementById('addCourseStartTime').value;
      const endTime = document.getElementById('addCourseEndTime').value;
      const courseType = document.getElementById('addCourseType').value;
      const timeRange = `${startTime}-${endTime}`;

      // æª¢æŸ¥æ˜¯å¦æœ‰è¡å ‚
      const conflicts = checkTeacherConflict(currentCourseTeacherId, courseDate, startTime, endTime);

      if (conflicts.length > 0) {
        const conflictMessages = conflicts.map(c =>
          `- ${c.name} (${c.time}) [${c.type}] ä¾†æºï¼š${c.source}`
        ).join('\n');

        const confirmMessage = `âš ï¸ è¡å ‚è­¦å‘Šï¼\n\nè©²è€å¸«åœ¨æ­¤æ™‚æ®µå·²æœ‰ä»¥ä¸‹èª²ç¨‹ï¼š\n${conflictMessages}\n\næ˜¯å¦ä»è¦ç¹¼çºŒæ´¾èª²ï¼Ÿ`;

        if (!confirm(confirmMessage)) {
          return;
        }
      }

      const newCourse = {
        id: Date.now(),
        teacherId: currentCourseTeacherId,
        name: courseName,
        date: courseDate,
        time: timeRange,
        type: courseType
      };

      courseAssignments.push(newCourse);
      saveCourseLocal();

      // åŒæ­¥åˆ°è¡Œäº‹æ›†
      const teacher = teachers.find(t => t.id === currentCourseTeacherId);
      const teacherName = teacher ? teacher.name : 'æœªçŸ¥å¸«è³‡';

      calendarEvents.push({
        id: newCourse.id,
        date: courseDate,
        title: `${courseName} - ${teacherName}`,
        time: timeRange,
        teacherId: currentCourseTeacherId,
        location: courseType,
        note: `èª²ç¨‹é¡å‹ï¼š${courseType}`,
        color: getCourseTypeColor(courseType),
        courseId: newCourse.id
      });
      saveCalendarLocal();

      updateCourseView();
      closeAddCourseModal();

      alert('âœ… èª²ç¨‹æ–°å¢æˆåŠŸï¼å·²åŒæ­¥åˆ°è¡Œäº‹æ›†');
    }

    // ========== èª²ç¨‹åˆªé™¤ ==========
    function deleteCourseAssignment(courseId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤èª²ç¨‹å—ï¼Ÿ')) return;

      courseAssignments = courseAssignments.filter(c => c.id !== courseId);
      saveCourseLocal();

      // åŒæ­¥åˆªé™¤è¡Œäº‹æ›†ä¸­çš„å°æ‡‰äº‹ä»¶
      calendarEvents = calendarEvents.filter(e => e.courseId !== courseId);
      saveCalendarLocal();

      updateCourseView();

      alert('âœ… èª²ç¨‹å·²åˆªé™¤ï¼Œå·²åŒæ­¥æ›´æ–°è¡Œäº‹æ›†');
    }

    // ========== è¡å ‚æª¢æŸ¥ ==========
    function checkTeacherConflict(teacherId, date, startTime, endTime) {
      const conflicts = [];

      const timeToMinutes = (timeStr) => {
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
      };

      const newStart = timeToMinutes(startTime);
      const newEnd = timeToMinutes(endTime);

      // æª¢æŸ¥æ´¾èª²ç®¡ç†ä¸­çš„èª²ç¨‹
      courseAssignments.forEach(course => {
        if (course.teacherId === teacherId && course.date === date) {
          const [courseStart, courseEnd] = course.time.split('-');
          const existingStart = timeToMinutes(courseStart);
          const existingEnd = timeToMinutes(courseEnd);

          if (!(newEnd <= existingStart || newStart >= existingEnd)) {
            conflicts.push({
              name: course.name,
              time: course.time,
              type: course.type,
              source: 'æ´¾èª²ç®¡ç†'
            });
          }
        }
      });

      // æª¢æŸ¥è¡Œäº‹æ›†ä¸­çš„äº‹ä»¶
      calendarEvents.forEach(event => {
        if (event.teacherId === teacherId && event.date === date && event.time) {
          const timeParts = event.time.split('-');
          if (timeParts.length === 2) {
            const [eventStart, eventEnd] = timeParts;
            const existingStart = timeToMinutes(eventStart);
            const existingEnd = timeToMinutes(eventEnd);

            if (!event.courseId && !(newEnd <= existingStart || newStart >= existingEnd)) {
              conflicts.push({
                name: event.title,
                time: event.time,
                type: event.location || 'è¡Œäº‹æ›†äº‹ä»¶',
                source: 'è¡Œäº‹æ›†'
              });
            }
          }
        }
      });

      return conflicts;
    }

    // ========== æœ¬é€±èª²è¡¨ ==========
    function renderTeacherWeekSchedule() {
      if (!currentCourseTeacherId) {
        document.getElementById('teacherWeekSchedule').style.display = 'none';
        return;
      }

      // ç²å–æœ¬é€±æ—¥æœŸç¯„åœ
      const today = new Date();
      const dayOfWeek = today.getDay();
      const monday = new Date(today);
      monday.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);

      const startDate = monday.toISOString().split('T')[0];
      const endDate = sunday.toISOString().split('T')[0];

      // ç²å–èª²è¡¨
      const schedule = getTeacherSchedule(currentCourseTeacherId, startDate, endDate);

      const container = document.getElementById('teacherWeekScheduleContent');
      const scheduleDiv = document.getElementById('teacherWeekSchedule');

      if (schedule.length === 0) {
        scheduleDiv.style.display = 'none';
        return;
      }

      scheduleDiv.style.display = 'block';

      // æŒ‰æ—¥æœŸåˆ†çµ„
      const groupedByDate = {};
      schedule.forEach(item => {
        if (!groupedByDate[item.date]) {
          groupedByDate[item.date] = [];
        }
        groupedByDate[item.date].push(item);
      });

      // ç”Ÿæˆ HTML
      const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
      let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">';

      for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        const dayEvents = groupedByDate[dateStr] || [];
        const isToday = dateStr === today.toISOString().split('T')[0];

        html += `
          <div style="border: 1px solid ${isToday ? '#007aff' : 'rgba(0,0,0,0.08)'}; border-radius: 12px; padding: 12px; background: ${isToday ? '#f0f5ff' : '#fafafa'};">
            <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: ${isToday ? '#007aff' : '#1d1d1f'};">
              é€±${weekDays[date.getDay()]} ${date.getMonth() + 1}/${date.getDate()}
              ${isToday ? '<span style="font-size: 11px; margin-left: 4px;">(ä»Šå¤©)</span>' : ''}
            </div>
            <div style="display: flex; flex-direction: column; gap: 6px;">
        `;

        if (dayEvents.length === 0) {
          html += '<div style="font-size: 11px; color: #34c759; background: #e8f9ed; border-radius: 6px; padding: 6px 8px;">âœ“ å…¨å¤©å¯ç”¨</div>';
        } else {
          dayEvents.forEach(event => {
            const bgColor = event.source === 'æ´¾èª²' ? '#fff0ee' : '#fff8e6';
            const textColor = event.source === 'æ´¾èª²' ? '#ff3b30' : '#ff9500';
            html += `
              <div style="font-size: 11px; background: ${bgColor}; color: ${textColor}; border-radius: 6px; padding: 6px 8px;">
                <div style="font-weight: 600;">${event.time}</div>
                <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${event.title}">${event.title}</div>
                <div style="opacity: 0.8;">${event.type}</div>
              </div>
            `;
          });
        }

        html += `
            </div>
          </div>
        `;
      }

      html += '</div>';
      container.innerHTML = html;
    }

    function getTeacherSchedule(teacherId, startDate, endDate) {
      const schedule = [];

      // å¾æ´¾èª²ç®¡ç†ç²å–
      courseAssignments.forEach(course => {
        if (course.teacherId === teacherId &&
            course.date >= startDate &&
            course.date <= endDate) {
          schedule.push({
            date: course.date,
            time: course.time,
            title: course.name,
            type: course.type,
            source: 'æ´¾èª²'
          });
        }
      });

      // å¾è¡Œäº‹æ›†ç²å–
      calendarEvents.forEach(event => {
        if (event.teacherId === teacherId &&
            event.date >= startDate &&
            event.date <= endDate &&
            !event.courseId) {
          schedule.push({
            date: event.date,
            time: event.time || 'å…¨å¤©',
            title: event.title,
            type: event.location || 'è¡Œäº‹æ›†',
            source: 'è¡Œäº‹æ›†'
          });
        }
      });

      return schedule.sort((a, b) => a.date.localeCompare(b.date) || (a.time || '').localeCompare(b.time || ''));
    }

    // ========== å·¥å…·å‡½æ•¸ ==========
    function getCourseTypeColor(type) {
      const colorMap = {
        'æ­£èª²': '#007aff',
        'è£œèª²': '#ff9500',
        'å¯¦é©—èª²': '#5856d6',
        'å¯¦ä½œèª²': '#34c759',
        'å°ˆé¡Œ': '#ff2d55'
      };
      return colorMap[type] || '#8e8e93';
    }

    function saveCourseLocal() {
      try {
        localStorage.setItem('courseAssignments', JSON.stringify(courseAssignments));
      } catch(err) {
        console.warn('localStorage è¶…é¡ï¼Œèª²ç¨‹æ•¸æ“šä¿å­˜å¤±æ•—ï¼š', err);
        alert('å­˜å„²ç©ºé–“å·²æ»¿ï¼Œèª²ç¨‹æ•¸æ“šå¯èƒ½ç„¡æ³•ä¿å­˜ï¼Œè«‹åˆªé™¤éƒ¨åˆ†æ•¸æ“š');
      }
    }

    function saveCalendarLocal() {
      try {
        localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
      } catch(err) {
        console.warn('localStorage è¶…é¡ï¼Œè¡Œäº‹æ›†æ•¸æ“šä¿å­˜å¤±æ•—ï¼š', err);
      }
    }

    // ========== é é¢è¼‰å…¥æ™‚åˆå§‹åŒ– ==========
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
