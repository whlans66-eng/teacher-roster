<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™»å…¥ - æ•™å¸«èŠ±åå†Šç³»çµ±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .login-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      width: 100%;
      max-width: 420px;
      overflow: hidden;
    }

    .login-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px 30px;
      text-align: center;
    }

    .login-header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .login-header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .login-body {
      padding: 40px 30px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 15px;
      transition: border-color 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group .input-hint {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }

    .role-selector {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 25px;
    }

    .role-option {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .role-option:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }

    .role-option.selected {
      border-color: #667eea;
      background: #667eea;
      color: white;
    }

    .role-option .role-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .role-option .role-name {
      font-size: 14px;
      font-weight: 600;
    }

    .btn-login {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-login:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-login:active {
      transform: translateY(0);
    }

    .btn-login:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .demo-accounts {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .demo-accounts h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 12px;
    }

    .demo-account {
      background: white;
      padding: 10px 12px;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .demo-account:hover {
      background: #e8eaf6;
    }

    .demo-account .account-info {
      flex: 1;
    }

    .demo-account .account-role {
      color: #667eea;
      font-weight: 600;
    }

    .demo-account .btn-use {
      padding: 4px 12px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .login-footer {
      padding: 20px 30px;
      background: #f8f9fa;
      text-align: center;
      font-size: 13px;
      color: #666;
    }

    .login-footer a {
      color: #667eea;
      text-decoration: none;
    }

    .login-footer a:hover {
      text-decoration: underline;
    }

    .loading-spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .btn-login.loading .btn-text {
      display: none;
    }

    .btn-login.loading .loading-spinner {
      display: block;
    }
  </style>
</head>
<body>
  <div class="login-container">
    <!-- ç™»å…¥é ­éƒ¨ -->
    <div class="login-header">
      <h1>ğŸ“ æ•™å¸«èŠ±åå†Šç³»çµ±</h1>
      <p>Teacher Roster Management System</p>
    </div>

    <!-- ç™»å…¥è¡¨å–® -->
    <div class="login-body">
      <!-- éŒ¯èª¤è¨Šæ¯ -->
      <div class="error-message" id="error-message">
        ç™»å…¥å¤±æ•—ï¼šç”¨æˆ¶åæˆ–å¯†ç¢¼éŒ¯èª¤
      </div>

      <!-- è§’è‰²é¸æ“‡ï¼ˆç¤ºç¯„ç”¨ï¼‰ -->
      <div class="form-group">
        <label>é¸æ“‡è§’è‰²ï¼ˆç¤ºç¯„ç”¨ï¼‰</label>
        <div class="role-selector">
          <div class="role-option" data-role="student">
            <div class="role-icon">ğŸ“</div>
            <div class="role-name">å­¸å“¡</div>
          </div>
          <div class="role-option" data-role="teacher">
            <div class="role-icon">ğŸ‘¨â€ğŸ«</div>
            <div class="role-name">æ•™å¸«</div>
          </div>
          <div class="role-option" data-role="admin">
            <div class="role-icon">âš™ï¸</div>
            <div class="role-name">ç®¡ç†è€…</div>
          </div>
        </div>
      </div>

      <!-- ç™»å…¥è¡¨å–® -->
      <form id="login-form">
        <div class="form-group">
          <label for="username">ç”¨æˆ¶åæˆ– Email</label>
          <input
            type="text"
            id="username"
            name="username"
            placeholder="è«‹è¼¸å…¥ç”¨æˆ¶åæˆ– Email"
            required
            autocomplete="username"
          >
        </div>

        <div class="form-group">
          <label for="password">å¯†ç¢¼</label>
          <input
            type="password"
            id="password"
            name="password"
            placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
            required
            autocomplete="current-password"
          >
          <div class="input-hint">ç¤ºç¯„ç’°å¢ƒè«‹ä½¿ç”¨ä¸‹æ–¹æ¸¬è©¦å¸³è™Ÿ</div>
        </div>

        <button type="submit" class="btn-login" id="login-btn">
          <span class="btn-text">ç™»å…¥</span>
          <div class="loading-spinner"></div>
        </button>
      </form>

      <!-- ç¤ºç¯„å¸³è™Ÿ -->
      <div class="demo-accounts">
        <h3>ğŸ”‘ æ¸¬è©¦å¸³è™Ÿï¼ˆç¤ºç¯„ç”¨ï¼‰</h3>

        <div class="demo-account" onclick="useDemoAccount('student001', 'password123')">
          <div class="account-info">
            <div><strong>student001</strong></div>
            <div class="account-role">å­¸å“¡</div>
          </div>
          <button class="btn-use" type="button">ä½¿ç”¨</button>
        </div>

        <div class="demo-account" onclick="useDemoAccount('teacher001', 'password123')">
          <div class="account-info">
            <div><strong>teacher001</strong></div>
            <div class="account-role">æ•™å¸« (ç‹å¤§æ˜)</div>
          </div>
          <button class="btn-use" type="button">ä½¿ç”¨</button>
        </div>

        <div class="demo-account" onclick="useDemoAccount('admin', 'admin123')">
          <div class="account-info">
            <div><strong>admin</strong></div>
            <div class="account-role">ç®¡ç†è€…</div>
          </div>
          <button class="btn-use" type="button">ä½¿ç”¨</button>
        </div>
      </div>
    </div>

    <!-- ç™»å…¥åº•éƒ¨ -->
    <div class="login-footer">
      <p>
        é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ <a href="register.html">è¨»å†Šæ–°å¸³è™Ÿ</a>
        <br>
        <a href="forgot-password.html">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</a>
      </p>
    </div>
  </div>

  <!-- å¼•å…¥æ¬Šé™æ§åˆ¶è¼”åŠ©å‡½æ•¸ -->
  <script src="auth-helpers.js"></script>

  <script>
    // API è¨­å®šï¼ˆè«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš› API åœ°å€ï¼‰
    const API_BASE_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';

    // ============================================
    // è§’è‰²é¸æ“‡ï¼ˆåƒ…ä¾›ç¤ºç¯„ï¼‰
    // ============================================

    let selectedRole = null;

    document.querySelectorAll('.role-option').forEach(option => {
      option.addEventListener('click', function() {
        // ç§»é™¤å…¶ä»–é¸é …çš„ selected é¡
        document.querySelectorAll('.role-option').forEach(opt => {
          opt.classList.remove('selected');
        });

        // åŠ å…¥ selected é¡
        this.classList.add('selected');

        selectedRole = this.getAttribute('data-role');

        console.log('é¸æ“‡è§’è‰²:', selectedRole);
      });
    });

    // ============================================
    // ç™»å…¥è¡¨å–®è™•ç†
    // ============================================

    const loginForm = document.getElementById('login-form');
    const loginBtn = document.getElementById('login-btn');
    const errorMessage = document.getElementById('error-message');

    loginForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      if (!username || !password) {
        showError('è«‹è¼¸å…¥ç”¨æˆ¶åå’Œå¯†ç¢¼');
        return;
      }

      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      loginBtn.classList.add('loading');
      loginBtn.disabled = true;
      hideError();

      try {
        // å‘¼å«ç™»å…¥ API
        const result = await performLogin(username, password);

        if (result.ok) {
          // ç™»å…¥æˆåŠŸ
          console.log('ç™»å…¥æˆåŠŸ:', result.data);

          // è¨­å®šèªè­‰ç‹€æ…‹
          setAuthState(result.data.user, result.data.token);

          // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
          alert('ç™»å…¥æˆåŠŸï¼æ­¡è¿ï¼Œ' + result.data.user.full_name);

          // æª¢æŸ¥æ˜¯å¦æœ‰ redirect åƒæ•¸
          const urlParams = new URLSearchParams(window.location.search);
          const redirect = urlParams.get('redirect');

          if (redirect) {
            window.location.href = redirect;
          } else {
            // æ ¹æ“šè§’è‰²å°å‘ä¸åŒé é¢
            redirectByRole(result.data.user.role);
          }
        } else {
          // ç™»å…¥å¤±æ•—
          showError(result.error || 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç”¨æˆ¶åå’Œå¯†ç¢¼');
        }
      } catch (error) {
        console.error('ç™»å…¥éŒ¯èª¤:', error);
        showError('ç™»å…¥å¤±æ•—ï¼š' + error.message);
      } finally {
        // éš±è—è¼‰å…¥ç‹€æ…‹
        loginBtn.classList.remove('loading');
        loginBtn.disabled = false;
      }
    });

    /**
     * åŸ·è¡Œç™»å…¥ API å‘¼å«
     */
    async function performLogin(username, password) {
      // é€™è£¡æ˜¯ç¤ºç¯„ï¼Œå¯¦éš›æ‡‰å‘¼å«æ‚¨çš„ Google Apps Script API
      console.log('å‘¼å«ç™»å…¥ API:', username);

      // ç¤ºç¯„æ¨¡å¼ï¼šç›´æ¥è¿”å›æˆåŠŸ
      if (isDemoMode()) {
        return simulateLogin(username, password);
      }

      // å¯¦éš› API å‘¼å«
      const response = await fetch(API_BASE_URL + '?action=login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
      });

      return await response.json();
    }

    /**
     * æ¨¡æ“¬ç™»å…¥ï¼ˆç¤ºç¯„ç”¨ï¼‰
     */
    function simulateLogin(username, password) {
      // å»¶é² 1 ç§’æ¨¡æ“¬ç¶²è·¯è«‹æ±‚
      return new Promise((resolve) => {
        setTimeout(() => {
          // ç¤ºç¯„å¸³è™Ÿè³‡æ–™
          const demoAccounts = {
            'student001': {
              password: 'password123',
              user: {
                id: 'student-001',
                username: 'student001',
                email: 'student@example.com',
                full_name: 'å­¸å“¡å¼µä¸‰',
                role: 'student',
                permissions: ['teacher.view', 'course.view', 'assignment.view', 'survey.respond']
              }
            },
            'teacher001': {
              password: 'password123',
              user: {
                id: 'teacher-001',
                username: 'teacher001',
                email: 'wang@example.com',
                full_name: 'ç‹å¤§æ˜',
                role: 'teacher',
                permissions: ['teacher.view', 'teacher.update_own', 'course.view', 'assignment.view_own', 'survey.view_own']
              }
            },
            'admin': {
              password: 'admin123',
              user: {
                id: 'admin-001',
                username: 'admin',
                email: 'admin@example.com',
                full_name: 'ç³»çµ±ç®¡ç†å“¡',
                role: 'admin',
                permissions: ['*']
              }
            }
          };

          const account = demoAccounts[username];

          if (!account || account.password !== password) {
            resolve({
              ok: false,
              error: 'ç”¨æˆ¶åæˆ–å¯†ç¢¼éŒ¯èª¤'
            });
          } else {
            resolve({
              ok: true,
              data: {
                user: account.user,
                token: 'demo-token-' + username + '-' + Date.now(),
                expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000)
              }
            });
          }
        }, 1000);
      });
    }

    /**
     * æ ¹æ“šè§’è‰²å°å‘ä¸åŒé é¢
     */
    function redirectByRole(role) {
      const roleHomePage = {
        'visitor': '/index.html',
        'student': '/my-schedule.html',
        'teacher': '/my-profile.html',
        'admin': '/admin/teachers.html'
      };

      const homePage = roleHomePage[role] || '/index.html';
      console.log('å°å‘:', homePage);

      // ç¤ºç¯„æ¨¡å¼ï¼šå°å‘æ•™å¸«åˆ—è¡¨
      window.location.href = 'teacher-card-example.html';
    }

    /**
     * é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
     */
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('show');
    }

    /**
     * éš±è—éŒ¯èª¤è¨Šæ¯
     */
    function hideError() {
      errorMessage.classList.remove('show');
    }

    /**
     * ä½¿ç”¨ç¤ºç¯„å¸³è™Ÿ
     */
    function useDemoAccount(username, password) {
      document.getElementById('username').value = username;
      document.getElementById('password').value = password;

      // è‡ªå‹•é¸æ“‡å°æ‡‰è§’è‰²
      const roleMap = {
        'student001': 'student',
        'teacher001': 'teacher',
        'admin': 'admin'
      };

      const role = roleMap[username];
      if (role) {
        document.querySelectorAll('.role-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        document.querySelector(`.role-option[data-role="${role}"]`)?.classList.add('selected');
      }
    }

    /**
     * æª¢æŸ¥æ˜¯å¦ç‚ºç¤ºç¯„æ¨¡å¼
     */
    function isDemoMode() {
      // å¦‚æœ API_BASE_URL åŒ…å« YOUR_SCRIPT_IDï¼Œè¦–ç‚ºç¤ºç¯„æ¨¡å¼
      return API_BASE_URL.includes('YOUR_SCRIPT_ID');
    }

    // ============================================
    // åˆå§‹åŒ–
    // ============================================

    // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
    if (restoreAuthState()) {
      const role = getCurrentRole();
      console.log('å·²ç™»å…¥ï¼Œè§’è‰²:', role);

      if (confirm('æ‚¨å·²ç™»å…¥ï¼Œæ˜¯å¦è¦ç¹¼çºŒç™»å…¥å…¶ä»–å¸³è™Ÿï¼Ÿ')) {
        clearAuthState();
      } else {
        redirectByRole(role);
      }
    }

    // é¡¯ç¤ºç¤ºç¯„æ¨¡å¼æç¤º
    if (isDemoMode()) {
      console.log('%cğŸ­ ç¤ºç¯„æ¨¡å¼', 'color: #667eea; font-size: 16px; font-weight: bold;');
      console.log('è«‹ä½¿ç”¨ä¸‹æ–¹æ¸¬è©¦å¸³è™Ÿç™»å…¥');
      console.log('');
      console.log('æ¸¬è©¦å¸³è™Ÿï¼š');
      console.log('- student001 / password123 (å­¸å“¡)');
      console.log('- teacher001 / password123 (æ•™å¸«)');
      console.log('- admin / admin123 (ç®¡ç†è€…)');
    }
  </script>
</body>
</html>
