<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>å¸«è³‡é™£å®¹ç®¡ç†ç³»çµ±</title>

  <!-- Tailwind èˆ‡ XLSXï¼ˆCDNï¼‰ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- å­—é«” -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
    body{font-family:'Noto Sans TC',system-ui,-apple-system,sans-serif}
    .fade-in{animation:fadeIn .3s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .slide-in{animation:slideIn .3s ease-out}
    @keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
    .move-transition{transition:transform .2s ease-in-out}
    .location-option.selected{border-color:#3b82f6;background-color:#eff6ff}
    .location-option.selected.onboard{border-color:#3b82f6;background-color:#dbeafe}
    .location-option.selected.onshore{border-color:#10b981;background-color:#d1fae5}
    .teacher-type-option.selected{border-color:#3b82f6;background-color:#eff6ff}
    .teacher-type-option.selected.internal{border-color:#3b82f6;background-color:#dbeafe}
    .teacher-type-option.selected.external{border-color:#8b5cf6;background-color:#f3e8ff}
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <!-- æ¨™é¡Œå€åŸŸ -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">å¸«è³‡é™£å®¹ç®¡ç†</h1>
      <p class="text-gray-600">ç®¡ç†æ‚¨çš„æ•™å¸«åœ˜éšŠè³‡è¨Š</p>
    </div>

    <!-- å¸«è³‡åˆ—è¡¨é é¢ -->
    <div id="teacherList" class="fade-in">
      <div class="flex flex-col space-y-4 mb-6">
        <!-- æ¨™é¡Œå’Œæ¨¡å¼åˆ‡æ› -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
          <div class="flex items-center space-x-4">
            <h2 class="text-2xl font-semibold text-gray-800">å¸«è³‡åˆ—è¡¨</h2>

            <!-- æ¨¡å¼åˆ‡æ› -->
            <div class="flex bg-gray-100 rounded-lg p-1">
              <button onclick="switchMode('edit')" id="editModeBtn" class="px-4 py-2 rounded-md text-sm font-medium transition-all bg-blue-600 text-white">âœï¸ ç·¨è¼¯æ¨¡å¼</button>
              <button onclick="switchMode('display')" id="displayModeBtn" class="px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-600 hover:text-gray-800">ğŸ‘ï¸ å‘ˆç¾æ¨¡å¼</button>
            </div>

            <div class="flex space-x-3">
              <!-- åŒ¯å‡º -->
              <div class="flex space-x-2">
                <button type="button" onclick="exportToCSV_API()" id="exportCSVBtn" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow-lg hover:shadow-xl flex items-center space-x-2">
                  <span>ğŸ“Š</span><span>CSV</span>
                </button>
                <button type="button" onclick="exportToXLSX_API()" id="exportXLSXBtn" class="bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow-lg hover:shadow-xl flex items-center space-x-2">
                  <span>ğŸ“‹</span><span>XLSX</span>
                </button>
              </div>

              <!-- çµ±è¨ˆ -->
              <button onclick="showStatisticsView()" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-200 shadow-lg hover:shadow-xl flex items-center space-x-2">
                <span>ğŸ“ˆ</span><span>çµ±è¨ˆåˆ†æ</span>
              </button>
            </div>
          </div>

          <!-- æœå°‹ + æ–°å¢ -->
          <div class="flex flex-col md:flex-row items-stretch md:items-center space-y-3 md:space-y-0 md:space-x-4 w<strong></strong>full md:w-auto">
            <div class="relative">
              <input id="searchInput" type="text" placeholder="æœå°‹å¸«è³‡å§“åã€èª²ç¨‹ã€ç¶“æ­·..." class="w-full md:w-80 px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" oninput="searchTeachers()">
              <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">ğŸ”</div>
              <button onclick="clearSearch()" id="clearBtn" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">âœ•</button>
            </div>
            <button onclick="addNewTeacher()" id="addTeacherBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 shadow-lg hover:shadow-xl whitespace-nowrap">
              â• æ–°å¢å¸«è³‡
            </button>
          </div>
        </div>

        <!-- æ¨¡å¼èªªæ˜ -->
        <div id="modeDescription" class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <div class="flex items-center space-x-2">
            <span class="text-blue-600">â„¹ï¸</span>
            <span class="text-blue-700 text-sm font-medium">ç·¨è¼¯æ¨¡å¼ï¼šå¯ä»¥æ–°å¢ã€ç·¨è¼¯ã€åˆªé™¤ã€è¤‡è£½å’Œæ’åºå¸«è³‡</span>
          </div>
        </div>
      </div>

      <!-- æœå°‹æç¤º -->
      <div id="searchResults" class="hidden mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
        <span class="text-blue-700 font-medium"></span>
      </div>

      <!-- å¡ç‰‡ç¶²æ ¼ -->
      <div id="teacherGrid" class="grid gap-6"></div>
    </div>

    <!-- çµ±è¨ˆé  -->
    <div id="executiveView" class="hidden fade-in">
      <div class="bg-white rounded-xl shadow-2xl p-8 max-w-7xl mx-auto">
        <button onclick="backToListFromExecutive()" class="mb-6 text-purple-600 hover:text-purple-800 font-medium flex items-center transition-colors">â† è¿”å›å¸«è³‡ç®¡ç†</button>
        <div class="text-center mb-8">
          <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent mb-2">å¸«è³‡çµ±è¨ˆåˆ†æ</h1>
          <p class="text-gray-600">æ·±åº¦åˆ†æå¸«è³‡é™£å®¹çµæ§‹èˆ‡åˆ†å¸ƒ</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-blue-100 text-sm font-medium">ç¸½å¸«è³‡æ•¸é‡</p>
                <p id="totalCount" class="text-3xl font-bold">0</p>
              </div><div class="text-4xl opacity-80">ğŸ‘¥</div>
            </div>
          </div>
          <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl p-6 text-white">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-indigo-100 text-sm font-medium">å…§éƒ¨å¸«è³‡</p>
                <p id="internalCount" class="text-3xl font-bold">0</p>
                <p id="internalPercent" class="text-indigo-200 text-xs">0%</p>
              </div><div class="text-4xl opacity-80">ğŸ‘¨â€ğŸ’¼</div>
            </div>
          </div>
          <div class="bg-gradient-to-br fromç´«-500 toç´«-600 rounded-xl p-6 text-white">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-purple-100 text-sm font-medium">å¤–éƒ¨å¸«è³‡</p>
                <p id="externalCount" class="text-3xl font-bold">0</p>
                <p id="externalPercent" class="text-purple-200 text-xs">0%</p>
              </div><div class="text-4xl opacity-80">ğŸ‘¨â€ğŸ“</div>
            </div>
          </div>
          <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-green-100 text-sm font-medium">æµ·ä¸Š/é™¸åœ°</p>
                <p class="text-lg font-bold"><span id="onboardCount">0</span>/<span id="onshoreCount">0</span></p>
                <p id="locationRatio" class="text-green-200 text-xs">æ¯”ä¾‹ 0:0</p>
              </div><div class="text-4xl opacity-80">ğŸš¢</div>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          <div class="bg-gray-50 rounded-xl p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><span class="mr-2">ğŸ“Š</span>å¸«è³‡é¡å‹åˆ†æ</h3>
            <div class="space-y-4">
              <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                <div class="flex items-center space-x-3"><div class="w-4 h-4 bg-blue-500 rounded-full"></div><span class="font-medium text-gray-700">å…§éƒ¨å¸«è³‡</span></div>
                <div class="text-right"><div class="font-bold text-blue-600" id="internalCountDetail">0 ä½</div><div class="text-sm text-gray-500" id="internalPercentDetail">0%</div></div>
              </div>
              <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                <div class="flex items-center space-x-3"><div class="w-4 h-4 bg-purple-500 rounded-full"></div><span class="font-medium text-gray-700">å¤–éƒ¨å¸«è³‡</span></div>
                <div class="text-right"><div class="font-bold text-purple-600" id="externalCountDetail">0 ä½</div><div class="text-sm text-gray-500" id="externalPercentDetail">0%</div></div>
              </div>
            </div>
          </div>
          <div class="bg-gray-50 rounded-xl p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex itemsä¸­å¿ƒ"><span class="mr-2">ğŸ—ºï¸</span>å·¥ä½œåœ°é»åˆ†æ</h3>
            <div class="space-y-4">
              <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                <div class="flex items-center space-x-3"><div class="w-4 h-4 bg-orange-500 rounded-full"></div><span class="font-medium text-gray-700">æµ·ä¸Šå·¥ä½œ</span></div>
                <div class="text-right"><div class="font-bold text-orange-600" id="onboardCountDetail">0 ä½</div><div class="text-sm text-gray-500" id="onboardPercentDetail">0%</div></div>
              </div>
              <div class="flex items-center justifyä¹‹é–“ p-4 bg-white rounded-lg shadow-sm">
                <div class="flex items-center space-x-3"><div class="w-4 h-4 bg-green-500 rounded-full"></div><span class="font-medium text-gray-700">é™¸åœ°å·¥ä½œ</span></div>
                <div class="text-right"><div class="font-bold text-green-600" id="onshoreCountDetail">0 ä½</div><div class="text-sm text-gray-500" id="onshorePercentDetail">0%</div></div>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 rounded-xl p-6 mb-8">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><span class="mr-2">ğŸ”„</span>äº¤å‰åˆ†æ</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white rounded-lg p-4 text-center shadow-sm">
              <div class="text-2xl font-bold text-orange-600" id="internalOnboard">0</div><div class="text-sm text-gray-600">å…§éƒ¨æµ·ä¸Šå¸«è³‡</div>
            </div>
            <div class="bg-white rounded-lg p-4 text-center shadow-sm">
              <div class="text-2xl font-bold text-green-600" id="internalOnshore">0</div><div class="text-sm text-gray-600">å…§éƒ¨é™¸åœ°å¸«è³‡</div>
            </div>
            <div class="bg-white rounded-lg p-4 text-center shadow-sm">
              <div class="text-2xl font-bold text-orange-600" id="externalOnboard">0</div><div class="text-sm text-gray-600">å¤–éƒ¨æµ·ä¸Šå¸«è³‡</div>
            </div>
            <div class="bg-white rounded-lg p-4 textä¸­å¿ƒ shadow-sm">
              <div class="text-2xl font-bold text-green-600" id="externalOnshore">0</div><div class="text-sm text-gray-600">å¤–éƒ¨é™¸åœ°å¸«è³‡</div>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 rounded-xl p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><span class="mr-2">ğŸ“š</span>èª²ç¨‹çµ±è¨ˆåˆ†æ</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white rounded-lg p-4 shadow-sm text-center">
              <div class="text-3xl font-bold text-indigo-600" id="totalSubjects">0</div>
              <div class="text-sm text-gray-600 mt-1">ç¸½èª²ç¨‹æ•¸</div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm text-center">
              <div class="text-3xl font-bold text-purple-600" id="avgSubjectsPerTeacher">0</div>
              <div class="text-sm text-gray-600 mt-1">å¹³å‡æ¯äººèª²ç¨‹æ•¸</div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm text-center">
              <div class="text-3xl font-bold text-orange-600" id="uniqueSubjects">0</div>
              <div class="text-sm text-gray-600 mt-1">ä¸é‡è¤‡èª²ç¨‹æ•¸</div>
            </div>
          </div>
          <div class="mt-6">
            <h4 class="text-lg font-semibold text-gray-700 mb-3">ç†±é–€èª²ç¨‹æ’è¡Œ</h4>
            <div id="popularSubjects" class="space-y-2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- å¸«è³‡è©³ç´°ï¼ˆå‘ˆç¾æ¨¡å¼ï¼‰ -->
    <div id="teacherDetailView" class="hidden slide-in">
      <div class="bgç™½ rounded-xl shadow-2xl p-8 max-w-4xl mx-auto">
        <button onclick="backToList()" class="mb-6 text-blue-600 hover:text-blue-800 font-medium flex items-center transition-colors">â† è¿”å›å¸«è³‡åˆ—è¡¨</button>
        <div id="teacherDetailContent"></div>
      </div>
    </div>

    <!-- å¸«è³‡è©³ç´°ï¼ˆç·¨è¼¯ï¼‰ -->
    <div id="teacherDetail" class="hidden slide-in">
      <div class="bg-white rounded-xl shadow-2xl p-8 max-w-4xl mx-auto">
        <button onclick="backToList()" class="mb-6 text-blue-600 hover:text-blue-800 font-medium flex items-center transition-colors">â† è¿”å›å¸«è³‡åˆ—è¡¨</button>
        <form id="teacherForm" class="space-y-6">
          <!-- åŸºæœ¬è³‡è¨Š -->
          <div class="bg-gray-50 p-6 rounded-lg">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">åŸºæœ¬è³‡è¨Š</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">å§“å *</label>
                <input type="text" id="teacherName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="email" id="teacherEmail" placeholder="example@email.com" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
              </div>

              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-3">å¸«è³‡é¡å‹ *</label>
                <div class="flex space-x-4">
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" name="teacherType" value="internal" id="typeInternal" class="sr-only">
                    <div class="teacher-type-option flex items-center space-x-3 px-6 py-4 border-2 border-gray-300 rounded-lg transition-all hover:border-blue-400 hover:bg-blue-50">
                      <div class="text-2xl">ğŸ‘¨â€ğŸ’¼</div>
                      <div><div class="font-medium text-gray-800">å…§éƒ¨å¸«è³‡</div><div class="text-sm text-gray-500">å…¬å¸å…§éƒ¨æ•™å¸«</div></div>
                    </div>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" name="teacherType" value="external" id="typeExternal" class="sr-only">
                    <div class="teacher-type-option flex items-center space-x-3 px-6 py-4 border-2 border-gray-300 rounded-lg transition-all hover:border-purple-400 hover:bg-purple-50">
                      <div class="text-2xl">ğŸ‘¨â€ğŸ“</div>
                      <div><div class="font-medium text-gray-800">å¤–éƒ¨å¸«è³‡</div><div class="text-sm text-gray-500">å¤–è˜å°ˆæ¥­æ•™å¸«</div></div>
                    </div>
                  </label>
                </div>
              </div>

              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-3">å·¥ä½œåœ°é» *</label>
                <div class="flex space-x-4">
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" name="workLocation" value="onboard" id="locationOnboard" class="sr-only">
                    <div class="location-option flex items-center space-x-3 px-6 py-4 border-2 border-gray-300 rounded-lg transition-all hover:border-orange-400 hover:bg-orange-50">
                      <div class="text-2xl">ğŸš¢</div><div><div class="font-medium text-gray-800">åœ¨èˆ¹</div><div class="text-sm text-gray-500">æµ·ä¸Šå·¥ä½œ</div></div>
                    </div>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" name="workLocation" value="onshore" id="locationOnshore" class="sr-only">
                    <div class="location-option flex items-center space-x-3 px-6 py-4 border-2 border-gray-300 rounded-lg transition-all hover:border-green-400 hover:bg-green-50">
                      <div class="text-2xl">ğŸ¢</div><div><div class="font-medium text-gray-800">åœ¨å²¸</div><div class="text-sm text-gray-500">é™¸åœ°å·¥ä½œ</div></div>
                    </div>
                  </label>
                </div>
              </div>

              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">ç…§ç‰‡</label>
                <div class="flex items-center space-x-4">
                  <div id="photoPreview" class="w-20 h-20 bg-gray-200 rounded-full flex items-center justify-center text-gray-500 text-2xl">ğŸ‘¤</div>
                  <input type="file" id="teacherPhoto" accept="image/*" class="hidden" onchange="previewPhoto(this)">
                  <button type="button" onclick="document.getElementById('teacherPhoto').click()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">é¸æ“‡ç…§ç‰‡</button>
                </div>
              </div>
            </div>
          </div>

          <!-- ç¶“æ­· -->
          <div class="bg-gray-50 p-6 rounded-lg">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-semibold text-gray-800">å·¥ä½œç¶“æ­·</h3>
              <button type="button" onclick="addExperience()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">â• æ–°å¢ç¶“æ­·</button>
            </div>
            <div id="experienceList" class="space-y-3"></div>
          </div>

          <!-- è­‰æ›¸ -->
          <div class="bg-gray-50 p-6 rounded-lg">
            <div class="flex justifyä¹‹é–“ items-center mb-4">
              <h3 class="text-xl font-semibold text-gray-800">è­‰æ›¸èˆ‡è³‡æ ¼</h3>
              <button type="button" onclick="addCertificate()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">â• æ–°å¢è­‰æ›¸</button>
            </div>
            <div id="certificateList" class="space-y-3"></div>
          </div>

          <!-- èª²ç¨‹ -->
          <div class="bg-gray-50 p-6 rounded-lg">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-semibold text-gray-800">è¬›æˆèª²ç¨‹</h3>
              <button type="button" onclick="addSubject()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">â• æ–°å¢èª²ç¨‹</button>
            </div>
            <div id="subjectList" class="space-y-3"></div>
          </div>

          <div class="flex justify-between pt-6">
            <button type="button" onclick="deleteTeacher()" id="deleteBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium transition-colors hidden">ğŸ—‘ï¸ åˆªé™¤å¸«è³‡</button>
            <div class="flex space-x-4 ml-auto">
              <button type="button" onclick="backToList()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">å–æ¶ˆ</button>
              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">ğŸ’¾ å„²å­˜</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ====== å¾Œç«¯ API è¨­å®š / å·¥å…· ====== -->
  <script>
    /* === (æ–°å¢) ç°¡æ˜“å‰ç«¯ç™»å…¥ä¿è­·ï¼šåªå­˜ SHA-256 é›œæ¹Šï¼Œä¸å­˜æ˜ç¢¼ === */
    const PASSWORD_HASH = '8c3b73d24b3d2e678b314d748ec17fa0fb97880f51ddcdf13c0b64bd34fb50f'; // ä½ çš„å¯†ç¢¼çš„ SHA-256
    const LS_LOGIN_KEY  = 'teacher_mgmt_login_v1';

    const toHex = (buf)=>[...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    async function sha256(text){
      const enc = new TextEncoder().encode(text);
      const digest = await crypto.subtle.digest('SHA-256', enc);
      return toHex(digest);
    }
    function buildGate(){
      const wrap = document.createElement('div');
      wrap.className = 'fixed inset-0 z-[9999] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center';
      wrap.innerHTML = `
        <div class="w-[92vw] max-w-[420px] bg-white rounded-2xl shadow-2xl p-6">
          <div class="text-2xl font-extrabold text-slate-900 mb-1">è«‹è¼¸å…¥å¯†ç¢¼</div>
          <div class="text-sm text-slate-500 mb-3">æ­¤é é¢åƒ…ä¾›å…§éƒ¨ä½¿ç”¨ã€‚è¼¸å…¥æ­£ç¢ºå¯†ç¢¼å¾Œæ–¹å¯é€²å…¥ç³»çµ±ã€‚</div>
          <input id="gatePw" type="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full border-2 border-slate-200 rounded-xl p-3 outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100" autocomplete="current-password">
          <button id="gateBtn" class="w-full mt-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl py-3 font-semibold">ç™»å…¥</button>
          <div id="gateErr" class="mt-2 text-red-600 text-sm min-h-[1.2rem]"></div>
        </div>`;
      document.body.appendChild(wrap);
      return wrap;
    }
    function requireLogin(){
      return new Promise((resolve)=>{
        if(localStorage.getItem(LS_LOGIN_KEY)==='ok'){ resolve(true); return; }
        const ui = buildGate();
        const $pw  = ui.querySelector('#gatePw');
        const $btn = ui.querySelector('#gateBtn');
        const $err = ui.querySelector('#gateErr');

        const go = async ()=>{
          const pw = ($pw.value||'').trim();
          if(!pw){ $err.textContent='è«‹è¼¸å…¥å¯†ç¢¼'; return; }
          try{
            const h = await sha256(pw);
            if(h === PASSWORD_HASH){
              localStorage.setItem(LS_LOGIN_KEY,'ok');
              ui.remove();
              resolve(true);
            }else{
              $err.textContent='å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡';
              $pw.select();
            }
          }catch(e){
            $err.textContent='ç€è¦½å™¨ä¸æ”¯æ´åŠ å¯†æ¨¡çµ„ï¼Œè«‹æ›´æ›ç€è¦½å™¨å†è©¦';
          }
        };
        $btn.addEventListener('click', go);
        $pw.addEventListener('keydown', e=>{ if(e.key==='Enter') go(); });
        setTimeout(()=> $pw.focus(), 50);
      });
    }

    /* === ä½ çš„ Web App URLï¼ˆè«‹ä¿æŒ Execute as: Meã€Who has access: Anyoneï¼‰ === */
    const API_BASE  = 'https://script.google.com/macros/s/AKfycbwboryIzd9D60pnkVmffL23httEhuZIApOd9O5Ofgnv4MGm9u3gUTkfmOweEAX-hQ07Pg/exec';
    const API_TOKEN = 'tr_demo_12345';
    const hasAPI = () => typeof API_BASE === 'string' && API_BASE.startsWith('https://script.google.com/macros/s/');

    /* ---------- ç›´å‚³ Driveï¼ˆFormDataï¼Œé¿å… CORSï¼›â‰¤30MBï¼‰ ---------- */
    async function apiUploadToDrive(file){
      if(!hasAPI()) throw new Error('å°šæœªè¨­å®š API');
      if(file.size > 30*1024*1024) throw new Error('æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 30MB');

      const fd = new FormData();
      fd.append('action', 'uploadfile');
      fd.append('token',  API_TOKEN);
      fd.append('file',   file, file.name);

      const res = await fetch(API_BASE, { method:'POST', body: fd });
      const j = await res.json();
      if(!j.ok) throw new Error(j.error || 'ä¸Šå‚³å¤±æ•—');
      return j; // {ok,id,url,name,size,mime}
    }

    /* ---------- æ­£å¸¸åŒ– ---------- */
    function normalize(list){
      if (!Array.isArray(list)) return [];
      const toStr = v => (v == null ? '' : String(v));
      const arrStr = a => Array.isArray(a) ? a.map(toStr).filter(Boolean) : [];
      return list.map(t => ({
        id: t?.id ?? Date.now(),
        name: toStr(t?.name),
        email: toStr(t?.email),
        teacherType: (t?.teacherType === 'external' ? 'external' : 'internal'),
        workLocation: (t?.workLocation === 'onboard' ? 'onboard' : 'onshore'),
        photo: toStr(t?.photo), // URLï¼ˆDriveï¼‰
        experiences: arrStr(t?.experiences),
        certificates: Array.isArray(t?.certificates)
          ? t.certificates.map(c => (typeof c === 'string'
              ? toStr(c)
              : { name: toStr(c?.name), fileName: toStr(c?.fileName), fileUrl: toStr(c?.fileUrl) }
            )).filter(x => (typeof x === 'string' ? x : x.name))
          : [],
        subjects: arrStr(t?.subjects),
      }));
    }
    const initial = name => (String(name ?? '').trim()[0] || '?');

    /* ---------- ç‹€æ…‹ ---------- */
    let teachers = normalize(JSON.parse(localStorage.getItem('teachers') || '[]'));
    let currentTeacherId = null;
    let draggedElement = null;
    let filteredTeachers = [];
    let currentMode = 'edit';

    /* ---------- éœé»˜åŒæ­¥ï¼ˆ0.1ç§’ï¼‰ ---------- */
    const SYNC_DEBOUNCE_MS = 100;
    let syncTimer = null, syncing = false, syncAgain = false;

    function slimForLocal(items){
      return (items||[]).map(t=>({
        id:t.id, name:t.name, email:t.email,
        teacherType:t.teacherType, workLocation:t.workLocation,
        photo:t.photo, experiences:t.experiences||[],
        certificates:(t.certificates||[]).map(c=> typeof c==='string' ? c : ({name:c.name,fileName:c.fileName,fileUrl:c.fileUrl})),
        subjects:t.subjects||[]
      }));
    }
    function saveLocalSilently(){
      try{
        localStorage.setItem('teachers', JSON.stringify(slimForLocal(teachers)));
      }catch(err){
        console.warn('localStorage è¶…é¡ï¼Œå·²æ”¹å­˜æœ€å°è³‡è¨Šï¼š', err);
        try{
          const min = teachers.map(t=>({id:t.id,name:t.name,teacherType:t.teacherType,workLocation:t.workLocation}));
          localStorage.setItem('teachers', JSON.stringify(min));
        }catch(e){}
      }
    }

    function scheduleCloudSave(){
      if(!hasAPI()) return;
      if(syncTimer) clearTimeout(syncTimer);
      syncTimer = setTimeout(doCloudSave, SYNC_DEBOUNCE_MS);
    }
    async function doCloudSave(){
      if(syncing){ syncAgain=true; return; }
      syncing = true;
      try{
        const body = new URLSearchParams();
        body.append('action','saveAll');
        body.append('token', API_TOKEN);
        body.append('teachers', JSON.stringify(teachers));
        await fetch(API_BASE, { method:'POST', body });
      }catch(e){
        console.warn('é›²ç«¯éœé»˜ä¸Šå‚³å¤±æ•—ï¼š', e);
      }finally{
        syncing=false;
        if(syncAgain){ syncAgain=false; scheduleCloudSave(); }
      }
    }

    async function cloudLoadSilent(){
      if(!hasAPI()) return null;
      try{
        const url = `${API_BASE}?action=list&token=${encodeURIComponent(API_TOKEN)}`;
        const res = await fetch(url, { method:'GET' });
        const data = await res.json();
        if(data && data.ok && Array.isArray(data.data)) return data.data;
      }catch(e){
        console.warn('é›²ç«¯éœé»˜è¼‰å…¥å¤±æ•—ï¼š', e);
      }
      return null;
    }

    /* ---------- å•Ÿå‹•ï¼ˆæ”¹ï¼šå…ˆé€šéå¯†ç¢¼é–˜ï¼Œå†åˆå§‹åŒ–ï¼‰ ---------- */
    document.addEventListener('DOMContentLoaded', async () => {
      await requireLogin(); // â˜… å…ˆç™»å…¥
      renderTeacherGrid();
      setupLocationSelection();

      const cloud = await cloudLoadSilent();
      if(Array.isArray(cloud)){
        teachers = normalize(cloud);
        saveLocalSilently();
        renderTeacherGrid();
      }
    });

    /* ---------- äº’å‹• ---------- */
    function setupLocationSelection() {
      document.addEventListener('change', function(e) {
        if (e.target.name === 'workLocation') {
          document.querySelectorAll('.location-option').forEach(o=>o.classList.remove('selected','onboard','onshore'));
          e.target.closest('label').querySelector('.location-option').classList.add('selected', e.target.value);
        }
        if (e.target.name === 'teacherType') {
          document.querySelectorAll('.teacher-type-option').forEach(o=>o.classList.remove('selected','internal','external'));
          e.target.closest('label').querySelector('.teacher-type-option').classList.add('selected', e.target.value);
        }
      });
    }

    function switchMode(mode){
      currentMode = mode;
      const editBtn = document.getElementById('editModeBtn');
      const displayBtn = document.getElementById('displayModeBtn');
      const addBtn = document.getElementById('addTeacherBtn');
      const modeDescription = document.getElementById('modeDescription');

      if (mode === 'edit') {
        editBtn.className = 'px-4 py-2 rounded-md text-sm font-medium transition-all bg-blue-600 text-white';
        displayBtn.className = 'px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-600 hover:text-gray-800';
        addBtn.classList.remove('hidden');
        document.getElementById('exportCSVBtn')?.classList.remove('hidden');
        document.getElementById('exportXLSXBtn')?.classList.remove('hidden');
        modeDescription.innerHTML = `
          <div class="flex items-center space-x-2">
            <span class="text-blue-600">â„¹ï¸</span>
            <span class="text-blue-700 text-sm font-medium">ç·¨è¼¯æ¨¡å¼ï¼šå¯ä»¥æ–°å¢ã€ç·¨è¼¯ã€åˆªé™¤ã€è¤‡è£½å’Œæ’åºå¸«è³‡</span>
          </div>`;
        modeDescription.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3';
      } else {
        editBtn.className = 'px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-600 hover:text-gray-800';
        displayBtn.className = 'px-4 py-2 rounded-md text-sm font-medium transition-all bg-green-600 text-white';
        addBtn.classList.add('hidden');
        document.getElementById('exportCSVBtn')?.classList.add('hidden');
        document.getElementById('exportXLSXBtn')?.classList.add('hidden');
        modeDescription.innerHTML = `
          <div class="flex items-center space-x-2">
            <span class="text-green-600">ğŸ‘ï¸</span>
            <span class="text-green-700 text-sm font-medium">å‘ˆç¾æ¨¡å¼ï¼šä»¥ç¾è§€çš„æ–¹å¼å±•ç¤ºå¸«è³‡é™£å®¹ï¼Œé©åˆå°å¤–å±•ç¤º</span>
          </div>`;
        modeDescription.className = 'bg-green-50 border border-green-200 rounded-lg p-3';
      }
      renderTeacherGrid();
    }

    function renderTeacherGrid(teachersToRender = null) {
      const grid = document.getElementById('teacherGrid');
      grid.innerHTML = '';
      grid.className = currentMode==='edit'
        ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6'
        : 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8';

      const displayTeachers = teachersToRender || teachers;
      if (displayTeachers.length === 0) {
        const searchInput = document.getElementById('searchInput');
        const isSearching = searchInput && searchInput.value.trim() !== '';
        grid.innerHTML = isSearching ? `
          <div class="col-span-full text-center py-12">
            <div class="text-6xl mb-4">ğŸ”</div>
            <h3 class="text-xl font-medium text-gray-600 mb-2">æ‰¾ä¸åˆ°ç¬¦åˆçš„å¸«è³‡</h3>
            <p class="text-gray-500">è«‹å˜—è©¦å…¶ä»–é—œéµå­—æˆ–æ¸…é™¤æœå°‹æ¢ä»¶</p>
          </div>` : `
          <div class="col-span-full text-center py-12">
            <div class="text-6xl mb-4">ğŸ‘¨â€ğŸ«</div>
            <h3 class="text-xl font-medium text-gray-600 mb-2">å°šæœªæ–°å¢ä»»ä½•å¸«è³‡</h3>
            <p class="text-gray-500">é»æ“Šä¸Šæ–¹ã€Œæ–°å¢å¸«è³‡ã€æŒ‰éˆ•é–‹å§‹å»ºç«‹æ‚¨çš„å¸«è³‡é™£å®¹</p>
          </div>`;
        return;
      }

      displayTeachers.forEach((teacher, index) => {
        const card = document.createElement('div');

        if (currentMode === 'edit') {
          card.className = 'bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer transform hover:-translate-y-1 group';
          card.draggable = true;
          card.dataset.teacherId = teacher.id;
          card.dataset.index = index;
          card.onclick = () => editTeacher(teacher.id);
          card.addEventListener('dragstart', handleDragStart);
          card.addEventListener('dragover', handleDragOver);
          card.addEventListener('drop', handleDrop);
          card.addEventListener('dragend', handleDragEnd);
          card.innerHTML = `
            <div class="p-4 text-center relative">
              <div class="absolute top-2 left-2 flex flex-col space-y-1">
                ${teacher.teacherType==='internal' ? `
                  <div class="bg-blue-500 text-white px-2 py-1 rounded-full text-xs font-medium flex items-center space-x-1">
                    <span>ğŸ‘¨â€ğŸ’¼</span><span>å…§éƒ¨</span>
                  </div>` : `
                  <div class="bg-purple-500 text-white px-2 py-1 rounded-full text-xs font-medium flex items-center space-x-1">
                    <span>ğŸ‘¨â€ğŸ“</span><span>å¤–éƒ¨</span>
                  </div>`}
                ${teacher.workLocation==='onboard' ? `
                  <div class="bg-orange-500 textç™½ px-2 py-1 rounded-full text-xs font-medium flex items-center space-x-1">
                    <span>ğŸš¢</span><span>åœ¨èˆ¹</span>
                  </div>` : `
                  <div class="bg-green-600 text-white px-2 py-1 rounded-full text-xs font-medium flex items-center space-x-1">
                    <span>ğŸ¢</span><span>åœ¨å²¸</span>
                  </div>`}
              </div>
              <div class="w-16 h-16 mx-auto mb-3 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white text-xl font-bold overflow-hidden">
                ${teacher.photo ? `<img src="${teacher.photo}" class="w-full h-full object-cover rounded-full">` : initial(teacher.name)}
              </div>
              <h3 class="text-lg font-semibold text-gray-800">${teacher.name}</h3>
              <div class="mt-1 text-sm ${teacher.workLocation==='onboard'?'text-orange-600':'text-green-600'} font-medium">
                ${teacher.workLocation==='onboard'?'ğŸš¢ æµ·ä¸Šå·¥ä½œ':'ğŸ¢ é™¸åœ°å·¥ä½œ'}
              </div>
              <div class="mt-2 text-xs text-gray-500 cursor-move">â‹®â‹® æ‹–æ‹½æ’åº</div>
              <button onclick="event.stopPropagation(); copyTeacher(${teacher.id})"
                class="absolute top-2 right-2 bg-green-500 hover:bg-green-600 text-white p-2 rounded-full text-xs transition-colors shadow-lg opacity-0 group-hover:opacity-100" title="è¤‡è£½å¸«è³‡">ğŸ“‹</button>
            </div>`;
        } else {
          const isInternal = teacher.teacherType === 'internal';
          const bgGradient = isInternal ? 'from-blue-50 to-indigo-50' : 'from-purple-50 to-pink-50';
          const titleColor = isInternal ? 'text-blue-800' : 'text-purple-800';
          const categoryTitle = isInternal ? 'å…¬å¸å…§éƒ¨è¬›å¸«' : 'å¤–è˜å°ˆæ¥­è¬›å¸«';
          const categoryIcon = isInternal ? 'ğŸ‘¨â€ğŸ’¼' : 'ğŸ‘¨â€ğŸ“';
          const categoryBadgeColor = isInternal ? 'bg-blue-500' : 'bg-purple-500';
          card.className = 'bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 overflow-hidden cursor-pointer';
          card.onclick = () => viewTeacherDetail(teacher.id);
          card.innerHTML = `
            <div class="relative p-8 bg-gradient-to-br ${bgGradient} text-center">
              <div class="absolute top-3 right-3">
                <div class="${categoryBadgeColor} text-white px-3 py-1 rounded-full text-xs font-medium flex items-center space-x-1">
                  <span>${categoryIcon}</span><span>${categoryTitle}</span>
                </div>
              </div>
              <div class="w-20 h-20 mx-auto mb-4 rounded-full ${isInternal?'bg-gradient-to-br from-blue-400 to-indigo-500':'bg-gradient-to-br from-purple-400 to-pink-500'} p-1 shadow-lg">
                <div class="w-full h-full rounded-full bg-white flex items-center justify-center overflow-hidden">
                  ${teacher.photo ? `<img src="${teacher.photo}" class="w-full h-full object-cover rounded-full">` : `<span class="text-xl font-bold text-gray-600">${initial(teacher.name)}</span>`}
                </div>
              </div>
              <h3 class="text-2xl font-bold ${titleColor} mb-2">${teacher.name}</h3>
              <div class="text-sm ${teacher.workLocation==='onboard'?'text-orange-600':'text-green-600'} font-medium mb-2">
                ${teacher.workLocation==='onboard'?'ğŸš¢ æµ·ä¸Šå·¥ä½œ':'ğŸ¢ é™¸åœ°å·¥ä½œ'}
              </div>
              <div class="text-xs text-gray-500 opacity-70">é»æ“ŠæŸ¥çœ‹è©³ç´°è³‡æ–™</div>
            </div>`;
        }
        grid.appendChild(card);
      });
    }

    function addNewTeacher(){
      currentTeacherId = null;
      document.getElementById('teacherList').classList.add('hidden');
      document.getElementById('teacherDetail').classList.remove('hidden');
      document.getElementById('deleteBtn').classList.add('hidden');
      document.getElementById('teacherForm').reset();
      const photoBox = document.getElementById('photoPreview');
      photoBox.innerHTML = 'ğŸ‘¤'; photoBox.removeAttribute('data-url');
      document.getElementById('experienceList').innerHTML = '';
      document.getElementById('certificateList').innerHTML = '';
      document.getElementById('subjectList').innerHTML = '';
      document.querySelectorAll('.location-option').forEach(o=>o.classList.remove('selected','onboard','onshore'));
      document.querySelectorAll('.teacher-type-option').forEach(o=>o.classList.remove('selected','internal','external'));
      addExperience(); addCertificate(); addSubject();
    }

    function editTeacher(teacherId){
      const teacher = teachers.find(t=>t.id===teacherId); if(!teacher) return;
      currentTeacherId = teacherId;
      document.getElementById('teacherList').classList.add('hidden');
      document.getElementById('teacherDetail').classList.remove('hidden');
      document.getElementById('deleteBtn').classList.remove('hidden');
      document.getElementById('teacherName').value = teacher.name;
      document.getElementById('teacherEmail').value = teacher.email || '';
      const teacherType = teacher.teacherType || 'internal';
      document.getElementById(teacherType==='internal'?'typeInternal':'typeExternal').checked = true;
      const workLocation = teacher.workLocation || 'onshore';
      document.getElementById(workLocation==='onboard'?'locationOnboard':'locationOnshore').checked = true;

      document.querySelectorAll('.teacher-type-option').forEach(o=>o.classList.remove('selected','internal','external'));
      document.querySelector(`input[value="${teacherType}"]`).closest('label').querySelector('.teacher-type-option').classList.add('selected',teacherType);
      document.querySelectorAll('.location-option').forEach(o=>o.classList.remove('selected','onboard','onshore'));
      document.querySelector(`input[value="${workLocation}"]`).closest('label').querySelector('.location-option').classList.add('selected',workLocation);

      const photoBox = document.getElementById('photoPreview');
      if (teacher.photo){
        photoBox.innerHTML = `<img src="${teacher.photo}" class="w-full h-full object-cover rounded-full">`;
        photoBox.setAttribute('data-url', teacher.photo);
      }else{
        photoBox.innerHTML = 'ğŸ‘¤'; photoBox.removeAttribute('data-url');
      }

      document.getElementById('experienceList').innerHTML = '';
      (teacher.experiences||[]).forEach(exp=>addExperience(exp));
      document.getElementById('certificateList').innerHTML = '';
      (teacher.certificates||[]).forEach(cert=>{
        if (typeof cert === 'string') addCertificate(cert);
        else addCertificate(cert.name||'', cert.fileName||'', cert.fileUrl||'');
      });
      document.getElementById('subjectList').innerHTML = '';
      (teacher.subjects||[]).forEach(s=>addSubject(s));
    }

    function viewTeacherDetail(teacherId){
      const teacher = teachers.find(t=>t.id===teacherId); if(!teacher) return;
      document.getElementById('teacherList').classList.add('hidden');
      document.getElementById('teacherDetailView').classList.remove('hidden');
      const isInternal = teacher.teacherType==='internal';
      const bgGradient = isInternal?'from-blue-50 to-indigo-50':'from-purple-50 to-pink-50';
      const titleColor = isInternal?'text-blue-800':'text-purple-800';
      const categoryTitle = isInternal?'å…¬å¸å…§éƒ¨è¬›å¸«':'å¤–è˜å°ˆæ¥­è¬›å¸«';
      const categoryIcon = isInternal?'ğŸ‘¨â€ğŸ’¼':'ğŸ‘¨â€ğŸ“';
      const categoryBadgeColor = isInternal?'bg-blue-500':'bg-purple-500';

      const content = document.getElementById('teacherDetailContent');
      content.innerHTML = `
        <div class="bg-gradient-to-br ${bgGradient} rounded-2xl p-8 mb-8 relative overflow-hidden">
          <div class="relative z-10 flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-8">
            <div class="w-32 h-32 rounded-full ${isInternal?'bg-gradient-to-br from-blue-400 to-indigo-500':'bg-gradient-to-br from-purple-400 to-pink-500'} p-2 shadow-xl">
              <div class="w-full h-full rounded-full bg-white flex items-center justify-center overflow-hidden">
                ${teacher.photo ? `<img src="${teacher.photo}" class="w-28 h-28 object-cover rounded-full">` : `<span class="text-4xl font-bold text-gray-600">${initial(teacher.name)}</span>`}
              </div>
            </div>
            <div class="flex-1 text-center md:text-left">
              <div class="mb-4">
                <div class="${categoryBadgeColor} text-white px-4 py-2 rounded-full text-sm font-medium inline-flex items-center space-x-2">
                  <span>${categoryIcon}</span><span>${categoryTitle}</span>
                </div>
              </div>
              <h1 class="text-4xl font-bold ${titleColor} mb-3">${teacher.name}</h1>
              <div class="space-y-2 text-lg">
                ${teacher.email ? `<div class="flex items-center justify-center md:justify-start space-x-2"><span class="text-gray-600">ğŸ“§</span><span class="text-gray-700">${teacher.email}</span></div>` : ''}
                <div class="flex items-center justify-center md:justify-start space-x-2">
                  <span class="${teacher.workLocation==='onboard'?'text-orange-600':'text-green-600'}">${teacher.workLocation==='onboard'?'ğŸš¢':'ğŸ¢'}</span>
                  <span class="${teacher.workLocation==='onboard'?'text-orange-600':'text-green-600'} font-medium">${teacher.workLocation==='onboard'?'æµ·ä¸Šå·¥ä½œ':'é™¸åœ°å·¥ä½œ'}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div class="bg-gray-50 rounded-xl p-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><span class="mr-3 text-3xl">ğŸ’¼</span>å·¥ä½œç¶“æ­·</h3>
            ${(teacher.experiences&&teacher.experiences.length>0)?`
              <div class="space-y-3">
                ${teacher.experiences.map(exp=>`<div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-blue-500"><p class="text-gray-700">${exp}</p></div>`).join('')}
              </div>`:`
              <div class="text-center py-8 text-gray-500"><div class="text-4xl mb-2">ğŸ“</div><p>å°šæœªå¡«å¯«å·¥ä½œç¶“æ­·</p></div>`}
          </div>

          <div class="bg-gray-50 rounded-xl p-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><span class="mr-3 text-3xl">ğŸ†</span>è­‰æ›¸èˆ‡è³‡æ ¼</h3>
            ${(teacher.certificates&&teacher.certificates.length>0)?`
              <div class="space-y-3">
                ${teacher.certificates.map(cert=>{
                  const certName = typeof cert==='string'?cert:cert.name;
                  const fileUrl  = typeof cert==='object' ? cert.fileUrl : '';
                  return `<div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                      <p class="text-gray-700 flex-1">${certName}</p>
                      ${fileUrl?`<button onclick="viewCertificateFromDetail('${certName}','${fileUrl}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition-colors ml-3">ğŸ‘ï¸ æª¢è¦–</button>`:''}
                    </div></div>`;
                }).join('')}
              </div>`:`
              <div class="text-center py-8 text-gray-500"><div class="text-4xl mb-2">ğŸ“</div><p>å°šæœªå¡«å¯«è­‰æ›¸è³‡æ ¼</p></div>`}
          </div>
        </div>

        <div class="bg-gray-50 rounded-xl p-6 mt-8">
          <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><span class="mr-3 text-3xl">ğŸ“š</span>è¬›æˆèª²ç¨‹</h3>
          ${(teacher.subjects&&teacher.subjects.length>0)?`
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
              ${teacher.subjects.map(s=>`<div class="bg-white rounded-lg p-4 shadow-sm text-center border-l-4 border-purple-500"><p class="text-gray-700 font-medium">${s}</p></div>`).join('')}
            </div>`:`
            <div class="text-center py-8 text-gray-500"><div class="text-4xl mb-2">ğŸ“–</div><p>å°šæœªå¡«å¯«è¬›æˆèª²ç¨‹</p></div>`}
        </div>

        ${currentMode==='edit'?`
        <div class="mt-8 text-center">
          <button onclick="editTeacher(${teacher.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium transition-colors shadow-lg hover:shadow-xl">âœï¸ ç·¨è¼¯å¸«è³‡è³‡æ–™</button>
        </div>`:''}
      `;
    }

    function viewCertificateFromDetail(fileName,fileUrl){
      if(!fileUrl){ alert('æ²’æœ‰æª”æ¡ˆå¯ä»¥æª¢è¦–'); return; }
      const isPdf = String(fileName).toLowerCase().endsWith('.pdf');
      const w = window.open('', '_blank');
      if(isPdf){
        w.document.write(`<html><head><title>${fileName}</title></head><body style="margin:0;"><embed src="${fileUrl}" type="application/pdf" width="100%" height="100%"></body></html>`);
      }else{
        w.document.write(`<html><head><title>${fileName}</title></head><body style="margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#f0f0f0;"><img src="${fileUrl}" style="max-width:100%;max-height:100%;object-fit:contain;"></body></html>`);
      }
    }

    function backToList(){
      document.getElementById('teacherDetail').classList.add('hidden');
      document.getElementById('teacherDetailView').classList.add('hidden');
      document.getElementById('teacherList').classList.remove('hidden');
      renderTeacherGrid();
    }

    function addExperience(value=''){
      const c = document.getElementById('experienceList');
      const div = document.createElement('div');
      div.className = 'flex items-center space-x-2 bg-white p-3 rounded-lg border border-gray-200 move-transition';
      div.innerHTML = `
        <div class="flex flex-col space-y-1">
          <button type="button" onclick="moveUp(this)" class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">â†‘</button>
          <button type="button" onclick="moveDown(this)" class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">â†“</button>
        </div>
        <input type="text" value="${value}" placeholder="è«‹è¼¸å…¥å·¥ä½œç¶“æ­·..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <button type="button" onclick="this.parentElement.remove()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm">âœ•</button>`;
      c.appendChild(div);
    }

    function addCertificate(value='', fileName='', fileUrl=''){
      const c = document.getElementById('certificateList');
      const div = document.createElement('div');
      div.className = 'bg-white p-4 rounded-lg border border-gray-200 move-transition';
      const uid = Date.now()+Math.random();
      div.innerHTML = `
        <div class="flex items-start space-x-3">
          <div class="flex flex-col space-y-1">
            <button type="button" onclick="moveUp(this)" class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">â†‘</button>
            <button type="button" onclick="moveDown(this)" class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">â†“</button>
          </div>
          <div class="flex-1 space-y-3">
            <input type="text" value="${value}" placeholder="è«‹è¼¸å…¥è­‰æ›¸æˆ–è³‡æ ¼åç¨±..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <div class="flex items-center space-x-2">
              <input type="file" id="certFile_${uid}" accept=".jpg,.jpeg,.pdf" class="hidden" onchange="handleCertificateFile(this)">
              <button type="button" onclick="document.getElementById('certFile_${uid}').click()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm">ğŸ“ ä¸Šå‚³æª”æ¡ˆ</button>
              <div class="file-info text-sm text-gray-600" data-filename="${fileName}" data-fileurl="${fileUrl}">${fileName?`å·²ä¸Šå‚³: ${fileName}`:'æœªä¸Šå‚³æª”æ¡ˆ'}</div>
              ${fileUrl?`<button type="button" onclick="viewCertificateFile(this)" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs">ğŸ‘ï¸ æª¢è¦–</button>`:''}
            </div>
          </div>
          <button type="button" onclick="this.closest('.bg-white').remove()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm">âœ•</button>
        </div>`;
      c.appendChild(div);
    }

    async function handleCertificateFile(input){
      if(!(input.files && input.files[0])) return;
      const file = input.files[0];
      const info = input.parentElement.querySelector('.file-info');
      const okTypes = ['image/jpeg','image/jpg','application/pdf'];
      if(!okTypes.includes(file.type)){ alert('åªæ”¯æ´ JPG å’Œ PDF æª”æ¡ˆæ ¼å¼'); return; }
      if(file.size > 30*1024*1024){ alert('æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 30MB'); return; }

      const old = info.textContent;
      info.textContent = 'ä¸Šå‚³ä¸­...';
      try{
        const r = await apiUploadToDrive(file);
        info.setAttribute('data-filename', r.name || file.name);
        info.setAttribute('data-fileurl',  r.url);
        info.textContent = `å·²ä¸Šå‚³: ${r.name || file.name}`;
        let btn = info.parentElement.querySelector('button[onclick="viewCertificateFile(this)"]');
        if(!btn){
          btn = document.createElement('button');
          btn.type='button';
          btn.onclick=()=>viewCertificateFile(btn);
          btn.className='bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs';
          btn.innerHTML='ğŸ‘ï¸ æª¢è¦–';
          info.parentElement.appendChild(btn);
        }
      }catch(err){
        console.error(err);
        info.textContent = old || 'ä¸Šå‚³å¤±æ•—';
        alert('ä¸Šå‚³å¤±æ•—ï¼š' + err.message);
      }
    }

    function viewCertificateFile(button){
      const info = button.parentElement.querySelector('.file-info');
      const fileName = info.getAttribute('data-filename') || 'æª”æ¡ˆ';
      const fileUrl  = info.getAttribute('data-fileurl')  || '';
      if(!fileUrl){ alert('æ²’æœ‰æª”æ¡ˆå¯ä»¥æª¢è¦–'); return; }
      const isPdf = fileName.toLowerCase().endsWith('.pdf');
      const w = window.open('', '_blank');
      if(isPdf){
        w.document.write(`<html><head><title>${fileName}</title></head><body style="margin:0;"><embed src="${fileUrl}" type="application/pdf" width="100%" height="100%"></body></html>`);
      }else{
        w.document.write(`<html><head><title>${fileName}</title></head><body style="margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#f0f0f0;"><img src="${fileUrl}" style="max-width:100%;max-height:100%;object-fit:contain;"></body></html>`);
      }
    }

    function addSubject(value=''){
      const c = document.getElementById('subjectList');
      const div = document.createElement('div');
      div.className = 'flex items-center space-x-2 bg-white p-3 rounded-lg border border-gray-200 move-transition';
      div.innerHTML = `
        <div class="flex flex-col space-y-1">
          <button type="button" onclick="moveUp(this)" class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">â†‘</button>
          <button type="button" onclick="moveDown(this)" class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">â†“</button>
        </div>
        <input type="text" value="${value}" placeholder="è«‹è¼¸å…¥è¬›æˆèª²ç¨‹..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <button type="button" onclick="this.parentElement.remove()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm">âœ•</button>`;
      c.appendChild(div);
    }

    function moveUp(button){
      const item = button.closest('.bg-white') || button.closest('.flex.items-center');
      const prev = item.previousElementSibling;
      if(prev){ item.parentNode.insertBefore(item, prev); item.style.transform='translateY(-5px)'; setTimeout(()=>{item.style.transform='translateY(0)'},200); }
    }
    function moveDown(button){
      const item = button.closest('.bg-white') || button.closest('.flex.items-center');
      const next = item.nextElementSibling;
      if(next){ item.parentNode.insertBefore(next, item); item.style.transform='translateY(5px)'; setTimeout(()=>{item.style.transform='translateY(0)'},200); }
    }

    async function previewPhoto(input){
      if (!(input.files && input.files[0])) return;
      const file = input.files[0];
      if (file.size > 30*1024*1024){ alert('ç…§ç‰‡ä¸èƒ½è¶…é 30MB'); return; }

      // å…ˆæœ¬åœ°é è¦½
      const reader = new FileReader();
      reader.onload = e => { document.getElementById('photoPreview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-full">`; };
      reader.readAsDataURL(file);

      // ç›´å‚³ Driveï¼Œå¯«å› URL
      try{
        const r = await apiUploadToDrive(file);
        document.getElementById('photoPreview').setAttribute('data-url', r.url);
      }catch(err){
        console.error(err);
        alert('ç…§ç‰‡ä¸Šå‚³å¤±æ•—ï¼š' + err.message);
      }
    }

    // å„²å­˜ï¼ˆéœé»˜ï¼šæœ¬æ©Ÿå¿«å– + é›²ç«¯ä¸Šå‚³ï¼‰
    document.getElementById('teacherForm').addEventListener('submit', function(e){
      e.preventDefault();
      const name = document.getElementById('teacherName').value.trim();
      const email = document.getElementById('teacherEmail').value.trim();
      const teacherType = document.querySelector('input[name="teacherType"]:checked')?.value;
      const workLocation = document.querySelector('input[name="workLocation"]:checked')?.value;
      if(!name){ alert('è«‹è¼¸å…¥å¸«è³‡å§“å'); return; }
      if(!teacherType){ alert('è«‹é¸æ“‡å¸«è³‡é¡å‹'); return; }
      if(!workLocation){ alert('è«‹é¸æ“‡å·¥ä½œåœ°é»'); return; }
      if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ alert('è«‹è¼¸å…¥æ­£ç¢ºçš„Emailæ ¼å¼'); return; }

      const experiences = Array.from(document.querySelectorAll('#experienceList input')).map(i=>i.value.trim()).filter(Boolean);
      const certificates = Array.from(document.querySelectorAll('#certificateList .bg-white')).map(item=>{
        const nameInput = item.querySelector('input[type="text"]');
        const info = item.querySelector('.file-info');
        const nm = nameInput.value.trim(); if(!nm) return null;
        const fileName = info.getAttribute('data-filename') || '';
        const fileUrl  = info.getAttribute('data-fileurl')  || '';
        return fileUrl ? { name:nm, fileName, fileUrl } : nm;
      }).filter(Boolean);
      const subjects = Array.from(document.querySelectorAll('#subjectList input')).map(i=>i.value.trim()).filter(Boolean);

      const photoBox = document.getElementById('photoPreview');
      const photoUrl = photoBox.getAttribute('data-url') || '';

      const teacherData = { id: currentTeacherId || Date.now(), name, email, teacherType, workLocation, photo: photoUrl, experiences, certificates, subjects };

      if(currentTeacherId){
        const idx = teachers.findIndex(t=>t.id===currentTeacherId); teachers[idx]=teacherData;
      }else{
        teachers.push(teacherData);
      }
      teachers = normalize(teachers);
      saveLocalSilently();
      scheduleCloudSave();
      backToList();
    });

    function deleteTeacher(){
      if(!currentTeacherId) return;
      if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½å¸«è³‡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')){
        teachers = teachers.filter(t=>t.id!==currentTeacherId);
        saveLocalSilently();
        scheduleCloudSave();
        backToList();
      }
    }

    function copyTeacher(teacherId){
      const t = teachers.find(x=>x.id===teacherId); if(!t) return;
      const copy = {
        id: Date.now(),
        name: (t.name || '') + ' (è¤‡è£½)',
        email: t.email || '',
        teacherType: t.teacherType || 'internal',
        workLocation: t.workLocation || 'onshore',
        photo: t.photo,
        experiences: [...(t.experiences||[])],
        certificates: (t.certificates||[]).map(c=> typeof c==='string'? c : ({name:c.name,fileName:c.fileName,fileUrl:c.fileUrl})),
        subjects: [...(t.subjects||[])]
      };
      const i = teachers.findIndex(x=>x.id===teacherId);
      teachers.splice(i+1,0,copy);
      teachers = normalize(teachers);
      saveLocalSilently();
      scheduleCloudSave();
      renderTeacherGrid();
    }

    function handleDragStart(e){ draggedElement = this; this.style.opacity='0.5'; e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/html', this.outerHTML); }
    function handleDragOver(e){ if(e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect='move'; return false; }
    function handleDrop(e){
      if(e.stopPropagation) e.stopPropagation();
      if(draggedElement !== this){
        const di = parseInt(draggedElement.dataset.index);
        const ti = parseInt(this.dataset.index);
        const d = teachers[di];
        teachers.splice(di,1);
        teachers.splice(ti,0,d);
        saveLocalSilently();
        scheduleCloudSave();
        renderTeacherGrid();
      }
      return false;
    }
    function handleDragEnd(){ this.style.opacity='1'; draggedElement=null; }

    function searchTeachers(){
      const searchInput = document.getElementById('searchInput');
      const kw = searchInput.value.trim().toLowerCase();
      const clearBtn = document.getElementById('clearBtn');
      const searchResults = document.getElementById('searchResults');
      if(kw){ clearBtn.classList.remove('hidden'); }
      else { clearBtn.classList.add('hidden'); searchResults.classList.add('hidden'); renderTeacherGrid(); return; }

      filteredTeachers = teachers.filter(t=>{
        if(String(t.name||'').toLowerCase().includes(kw)) return true;
        if(t.email && String(t.email).toLowerCase().includes(kw)) return true;
        if((t.experiences||[]).some(x=>String(x).toLowerCase().includes(kw))) return true;
        if((t.certificates||[]).some(c=> typeof c==='string' ? String(c).toLowerCase().includes(kw) : String(c.name||'').toLowerCase().includes(kw))) return true;
        if((t.subjects||[]).some(s=>String(s).toLowerCase().includes(kw))) return true;
        return false;
      });

      if(filteredTeachers.length>0){
        searchResults.classList.remove('hidden');
        searchResults.querySelector('span').textContent = `æ‰¾åˆ° ${filteredTeachers.length} ä½ç¬¦åˆã€Œ${searchInput.value}ã€çš„å¸«è³‡`;
      }else{ searchResults.classList.add('hidden'); }
      renderTeacherGrid(filteredTeachers);
    }

    function clearSearch(){
      const searchInput = document.getElementById('searchInput');
      searchInput.value = '';
      document.getElementById('clearBtn').classList.add('hidden');
      document.getElementById('searchResults').classList.add('hidden');
      filteredTeachers = [];
      renderTeacherGrid();
    }

    function showStatisticsView(){ document.getElementById('teacherList').classList.add('hidden'); document.getElementById('executiveView').classList.remove('hidden'); renderStatisticsView(); }
    function backToListFromExecutive(){ document.getElementById('executiveView').classList.add('hidden'); document.getElementById('teacherList').classList.remove('hidden'); }

    function renderStatisticsView(){
      const total = teachers.length;
      const internal = teachers.filter(t=>t.teacherType==='internal').length;
      const external = teachers.filter(t=>t.teacherType==='external').length;
      const onboard = teachers.filter(t=>t.workLocation==='onboard').length;
      const onshore = teachers.filter(t=>t.workLocation==='onshore').length;
      const internalOnboard = teachers.filter(t=>t.teacherType==='internal' && t.workLocation==='onboard').length;
      const internalOnshore = teachers.filter(t=>t.teacherType==='internal' && t.workLocation==='onshore').length;
      const externalOnboard = teachers.filter(t=>t.teacherType==='external' && t.workLocation==='onboard').length;
      const externalOnshore = teachers.filter(t=>t.teacherType==='external' && t.workLocation==='onshore').length;
      const allSubjects = teachers.flatMap(t=>t.subjects||[]);
      const uniqueSubjects = [...new Set(allSubjects)];
      const avg = total>0 ? (allSubjects.length/total).toFixed(1) : 0;

      document.getElementById('totalCount').textContent = total;
      document.getElementById('internalCount').textContent = internal;
      document.getElementById('externalCount').textContent = external;
      document.getElementById('onboardCount').textContent = onboard;
      document.getElementById('onshoreCount').textContent = onshore;

      const ip = total>0 ? ((internal/total)*100).toFixed(1) : 0;
      const ep = total>0 ? ((external/total)*100).toFixed(1) : 0;
      const obp = total>0 ? ((onboard/total)*100).toFixed(1) : 0;
      const osp = total>0 ? ((onshore/total)*100).toFixed(1) : 0;

      document.getElementById('internalPercent').textContent = `${ip}%`;
      document.getElementById('externalPercent').textContent = `${ep}%`;
      document.getElementById('locationRatio').textContent = `æ¯”ä¾‹ ${onboard}:${onshore}`;

      document.getElementById('internalCountDetail').textContent = `${internal} ä½`;
      document.getElementById('internalPercentDetail').textContent = `${ip}%`;
      document.getElementById('externalCountDetail').textContent = `${external} ä½`;
      document.getElementById('externalPercentDetail').textContent = `${ep}%`;
      document.getElementById('onboardCountDetail').textContent = `${onboard} ä½`;
      document.getElementById('onboardPercentDetail').textContent = `${obp}%`;
      document.getElementById('onshoreCountDetail').textContent = `${onshore} ä½`;
      document.getElementById('onshorePercentDetail').textContent = `${osp}%`;

      document.getElementById('internalOnboard').textContent = internalOnboard;
      document.getElementById('internalOnshore').textContent = internalOnshore;
      document.getElementById('externalOnboard').textContent = externalOnboard;
      document.getElementById('externalOnshore').textContent = externalOnshore;

      document.getElementById('totalSubjects').textContent = allSubjects.length;
      document.getElementById('avgSubjectsPerTeacher').textContent = avg;
      document.getElementById('uniqueSubjects').textContent = uniqueSubjects.length;

      const counts = {}; allSubjects.forEach(s=>counts[s]=(counts[s]||0)+1);
      const sorted = Object.entries(counts).sort(([,a],[,b])=>b-a).slice(0,10);
      const box = document.getElementById('popularSubjects');
      box.innerHTML = sorted.length>0 ? sorted.map(([s,c],i)=>`
        <div class="flex items-center justifyä¹‹é–“ p-3 bg-white rounded-lg shadow-sm">
          <div class="flex items-center space-x-3">
            <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-full flex items-center justify-center text-sm font-bold">${i+1}</div>
            <span class="font-medium text-gray-700">${s}</span>
          </div>
          <div class="text-right">
            <div class="font-bold text-purple-600">${c} ä½</div>
            <div class="text-xs text-gray-500">å¸«è³‡æ•™æˆ</div>
          </div>
        </div>`).join('') : `
        <div class="text-center py-8 text-gray-500"><div class="text-4xl mb-2">ğŸ“š</div><p>å°šæœªæœ‰èª²ç¨‹è³‡æ–™</p></div>`;
    }

    /* åŒ¯å‡º */
    function _collectRows(){
      if(!Array.isArray(teachers) || teachers.length===0){ alert('ç›®å‰æ²’æœ‰å¸«è³‡è³‡æ–™å¯ä»¥åŒ¯å‡º'); return null; }
      return teachers.map((t,i)=>({
        idx:i+1,
        name:t.name||'',
        email:t.email||'',
        teacherType:t.teacherType==='internal'?'å…§éƒ¨å¸«è³‡':'å¤–éƒ¨å¸«è³‡',
        workLocation:t.workLocation==='onboard'?'æµ·ä¸Šå·¥ä½œ':'é™¸åœ°å·¥ä½œ',
        experiences:(t.experiences||[]).join('ï¼›') || 'ç„¡',
        certificates:(t.certificates||[]).map(c=> typeof c==='string'? c : (c?.name||'')).filter(Boolean).join('ï¼›') || 'ç„¡',
        subjects:(t.subjects||[]).join('ï¼›') || 'ç„¡'
      }));
    }
    function forceDownload(dataOrBlob, filename, mime='text/plain;charset=utf-8'){
      const blob = dataOrBlob instanceof Blob ? dataOrBlob : new Blob([String(dataOrBlob)],{type:mime});
      try{
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.target = '_blank'; a.rel='noopener';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        setTimeout(()=>URL.revokeObjectURL(url),1500);
        return;
      }catch(e){}
      try{
        const fr = new FileReader();
        fr.onload = ()=>{ const w = window.open(fr.result,'_blank'); if(!w) alert('ç€è¦½å™¨å°é–äº†ä¸‹è¼‰è¦–çª—ï¼Œè«‹å…è¨±å½ˆå‡ºè¦–çª—'); };
        fr.readAsDataURL(blob); return;
      }catch(e){}
      blob.text().then(txt=>{
        const w = window.open('','_blank');
        if(w){
          w.document.write('<pre style="white-space:pre-wrap;word-break:break-all;font:12px/1.4 monospace;">'
            + txt.replace(/[<>&]/g, s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s])) + '</pre>');
        }else{ alert('ç„¡æ³•å¦é–‹è¦–çª—ï¼Œè«‹å…è¨±å½ˆå‡ºè¦–çª—'); }
      });
    }
    function csvCell(s){ s=(s??'').toString().replace(/\r\n|\r/g,'\n').replace(/"/g,'""'); return `"${s}"`; }
    function _fn(prefix,ext){ const d=new Date(); return `${prefix}_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}.${ext}`; }

    function exportToCSV_API(){
      const rows = _collectRows(); if(!rows) return;
      const headers = ['åºè™Ÿ','å§“å','Email','å¸«è³‡é¡å‹','å·¥ä½œåœ°é»','å·¥ä½œç¶“æ­·','è­‰æ›¸èˆ‡è³‡æ ¼','è¬›æˆèª²ç¨‹'];
      let csv = headers.join(',') + '\n';
      rows.forEach(r=>{
        csv += [r.idx,csvCell(r.name),csvCell(r.email),csvCell(r.teacherType),csvCell(r.workLocation),csvCell(r.experiences),csvCell(r.certificates),csvCell(r.subjects)].join(',') + '\n';
      });
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csv], { type:'text/csv;charset=utf-8' });
      forceDownload(blob, _fn('å¸«è³‡é™£å®¹','csv'), 'text/csv;charset=utf-8');
    }
    function exportToXLSX_API(){
      const rows = _collectRows(); if(!rows) return;
      const aoa = [['åºè™Ÿ','å§“å','Email','å¸«è³‡é¡å‹','å·¥ä½œåœ°é»','å·¥ä½œç¶“æ­·','è­‰æ›¸èˆ‡è³‡æ ¼','è¬›æˆèª²ç¨‹'], ...rows.map(r=>[r.idx,r.name,r.email,r.teacherType,r.workLocation,r.experiences,r.certificates,r.subjects])];
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      ws['!cols'] = aoa[0].map((_,c)=>({wch: Math.min(40, Math.max(...aoa.map(r=> (r[c]? String(r[c]).length : 0)))+2)}));
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'å¸«è³‡é™£å®¹');
      const ab = XLSX.write(wb, { bookType:'xlsx', type:'array' });
      const blob = new Blob([ab], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      forceDownload(blob, _fn('å¸«è³‡é™£å®¹','xlsx'), 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
    }
  </script>
</body>
</html>
