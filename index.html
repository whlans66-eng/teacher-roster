<script>
/* ========= å¾Œç«¯ API è¨­å®š ========= */
const API_BASE  = 'https://script.google.com/macros/s/AKfycbxrHAjUapfIlLauKu6uRKBLB7fESIijlKrPM7VR50bXHhRkYyPcBwHVXOGF4xyfAP9npQ/exec';
const API_TOKEN = 'tr_demo_12345';
function hasAPI(){ return typeof API_BASE==='string' && API_BASE.startsWith('https://script.google.com/macros/s/'); }

/* ========= ç‹€æ…‹ ========= */
let teachers = JSON.parse(localStorage.getItem('teachers')) || [];
let currentTeacherId = null;
let draggedElement    = null;
let filteredTeachers  = [];
let currentMode       = 'edit';

document.addEventListener('DOMContentLoaded', () => {
  renderTeacherGrid();
  setupLocationSelection();
  if (!hasAPI()) document.querySelectorAll('.cloud-btn').forEach(b=>b.classList.add('hidden'));
});

/* ========= é›²ç«¯åŒæ­¥ï¼ˆApps Scriptï¼‰ ========= */
// ä¸è§¸ç™¼ preflightï¼šç”¨ text/plain çš„ POST
async function cloudLoad(){
  if(!hasAPI()){ alert('å°šæœªè¨­å®šå¾Œç«¯ API'); return; }
  try{
    const res = await fetch(API_BASE, {
      method: 'POST',
      headers: { 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify({ action:'list', token: API_TOKEN })
    });
    const data = await res.json();
    if (data && data.ok && Array.isArray(data.data)){
      teachers = data.data;
      localStorage.setItem('teachers', JSON.stringify(teachers));
      renderTeacherGrid();
      alert('å·²å¾é›²ç«¯è¼‰å…¥ ' + teachers.length + ' ç­†è³‡æ–™');
    }else{
      alert('é›²ç«¯å›å‚³æ ¼å¼ä¸æ­£ç¢ºï¼š' + (data?.error || ''));
    }
  }catch(err){
    console.error(err);
    alert('é›²ç«¯è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
}
function _sanitizeForCloud(){
  // åƒ…å‚³åŸºæœ¬æ¬„ä½ï¼ˆä¸å‚³ base64 ç…§ç‰‡/è­‰æ›¸æª”ï¼‰
  return teachers.map(t=>({
    id:t.id, name:t.name, email:t.email,
    teacherType:t.teacherType, workLocation:t.workLocation,
    photoUrl: '', // è‹¥è¦åšçœŸæ­£æª”æ¡ˆä¸Šå‚³å†è£œ
    experiences:t.experiences||[],
    certificates:(t.certificates||[]).map(c=>typeof c==='string'?c:(c?.name||'')),
    subjects:t.subjects||[]
  }));
}
async function cloudSave(){
  if(!hasAPI()){ alert('å°šæœªè¨­å®šå¾Œç«¯ API'); return; }
  try{
    const payload = { action:'saveAll', token: API_TOKEN, teachers:_sanitizeForCloud() };
    const res = await fetch(API_BASE, {
      method: 'POST',
      headers: { 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data.ok){
      alert('å·²å„²å­˜åˆ°é›²ç«¯ï¼Œå…± ' + (data.count ?? teachers.length) + ' ç­†');
    }else{
      alert('å„²å­˜å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
    }
  }catch(err){
    console.error(err);
    alert('é›²ç«¯å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
}

/* ========= äº’å‹•/ç•«é¢ï¼ˆä¸‹æ–¹ç¶­æŒä½ åŸæœ¬åŠŸèƒ½ï¼‰ ========= */
function setupLocationSelection() {
  document.addEventListener('change', function(e) {
    if (e.target.name === 'workLocation') {
      document.querySelectorAll('.location-option').forEach(o=>o.classList.remove('selected','onboard','onshore'));
      e.target.closest('label').querySelector('.location-option').classList.add('selected', e.target.value);
    }
    if (e.target.name === 'teacherType') {
      document.querySelectorAll('.teacher-type-option').forEach(o=>o.classList.remove('selected','internal','external'));
      e.target.closest('label').querySelector('.teacher-type-option').classList.add('selected', e.target.value);
    }
  });
}

function switchMode(mode){
  currentMode = mode;
  const editBtn = document.getElementById('editModeBtn');
  const displayBtn = document.getElementById('displayModeBtn');
  const addBtn = document.getElementById('addTeacherBtn');
  const modeDescription = document.getElementById('modeDescription');

  if (mode === 'edit') {
    if (editBtn) editBtn.className = 'px-4 py-2 rounded-md text-sm font-medium transition-all bg-blue-600 text-white';
    if (displayBtn) displayBtn.className = 'px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-600 hover:text-gray-800';
    if (addBtn) addBtn.classList.remove('hidden');
    document.getElementById('exportCSVBtn')?.classList.remove('hidden');
    document.getElementById('exportXLSXBtn')?.classList.remove('hidden');
    if (modeDescription) {
      modeDescription.innerHTML = `
        <div class="flex items-center space-x-2">
          <span class="text-blue-600">â„¹ï¸</span>
          <span class="text-blue-700 text-sm font-medium">ç·¨è¼¯æ¨¡å¼ï¼šå¯ä»¥æ–°å¢ã€ç·¨è¼¯ã€åˆªé™¤ã€è¤‡è£½å’Œæ’åºå¸«è³‡</span>
        </div>`;
      modeDescription.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3';
    }
  } else {
    if (editBtn) editBtn.className = 'px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-600 hover:text-gray-800';
    if (displayBtn) displayBtn.className = 'px-4 py-2 rounded-md text-sm font-medium transition-all bg-green-600 text-white';
    if (addBtn) addBtn.classList.add('hidden');
    document.getElementById('exportCSVBtn')?.classList.add('hidden');
    document.getElementById('exportXLSXBtn')?.classList.add('hidden');
    if (modeDescription) {
      modeDescription.innerHTML = `
        <div class="flex items-center space-x-2">
          <span class="text-green-600">ğŸ‘ï¸</span>
          <span class="text-green-700 text-sm font-medium">å‘ˆç¾æ¨¡å¼ï¼šä»¥ç¾è§€çš„æ–¹å¼å±•ç¤ºå¸«è³‡é™£å®¹ï¼Œé©åˆå°å¤–å±•ç¤º</span>
        </div>`;
      modeDescription.className = 'bg-green-50 border border-green-200 rounded-lg p-3';
    }
  }
  renderTeacherGrid();
}

function renderTeacherGrid(teachersToRender=null){
  const grid = document.getElementById('teacherGrid');
  if (!grid) return;
  grid.innerHTML = '';
  grid.className = currentMode==='edit'
    ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6'
    : 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8';

  const displayTeachers = teachersToRender || teachers;
  if (displayTeachers.length===0){
    const searchInput = document.getElementById('searchInput');
    const isSearching = searchInput && searchInput.value.trim() !== '';
    grid.innerHTML = isSearching ? `
      <div class="col-span-full text-center py-12">
        <div class="text-6xl mb-4">ğŸ”</div>
        <h3 class="text-xl font-medium text-gray-600 mb-2">æ‰¾ä¸åˆ°ç¬¦åˆçš„å¸«è³‡</h3>
        <p class="text-gray-500">è«‹å˜—è©¦å…¶ä»–é—œéµå­—æˆ–æ¸…é™¤æœå°‹æ¢ä»¶</p>
      </div>` : `
      <div class="col-span-full text-center py-12">
        <div class="text-6xl mb-4">ğŸ‘¨â€ğŸ«</div>
        <h3 class="text-xl font-medium text-gray-600 mb-2">å°šæœªæ–°å¢ä»»ä½•å¸«è³‡</h3>
        <p class="text-gray-500">é»æ“Šä¸Šæ–¹ã€Œæ–°å¢å¸«è³‡ã€æŒ‰éˆ•é–‹å§‹å»ºç«‹æ‚¨çš„å¸«è³‡é™£å®¹</p>
      </div>`;
    return;
  }

  displayTeachers.forEach((teacher, index)=>{
    const card = document.createElement('div');

    if (currentMode==='edit'){
      card.className = 'bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer transform hover:-translate-y-1 group';
      card.draggable = true;
      card.dataset.teacherId = teacher.id;
      card.dataset.index = index;
      card.onclick = () => editTeacher(teacher.id);
      card.addEventListener('dragstart', handleDragStart);
      card.addEventListener('dragover', handleDragOver);
      card.addEventListener('drop', handleDrop);
      card.addEventListener('dragend', handleDragEnd);
      card.innerHTML = `
        <div class="p-4 text-center relative">
          <div class="absolute top-2 left-2 flex flex-col space-y-1">
            ${teacher.teacherType==='internal' ? `
              <div class="bg-blue-500 text-white px-2 py-1 rounded-full text-xs font-medium flex items-center space-x-1">
                <span>ğŸ‘¨â€ğŸ’¼</span><span>å…§éƒ¨</span>
              </div>` :
              `<div class="bg-purple-500 text-white px-2 py-1 rounded-full text-xs font-medium flex items-center space-x-1">
                <span>ğŸ‘¨â€ğŸ“</span><span>å¤–éƒ¨</span>
              </div>`
            }
            ${teacher.workLocation==='onboard' ? `
              <div class="bg-orange-500 text-white px-2 py-1 rounded-full text-xs font-medium flex items-center space-x-1">
                <span>ğŸš¢</span><span>åœ¨èˆ¹</span>
              </div>` :
              `<div class="bg-green-600 text-white px-2 py-1 rounded-full text-xs font-medium flex items-center space-x-1">
                <span>ğŸ¢</span><span>åœ¨å²¸</span>
              </div>`
            }
          </div>
          <div class="w-16 h-16 mx-auto mb-3 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white text-xl font-bold">
            ${teacher.photo ? `<img src="${teacher.photo}" class="w-full h-full object-cover rounded-full">` : (teacher.name||'?').charAt(0)}
          </div>
          <h3 class="text-lg font-semibold text-gray-800">${teacher.name}</h3>
          <div class="mt-1 text-sm ${teacher.workLocation==='onboard'?'text-orange-600':'text-green-600'} font-medium">
            ${teacher.workLocation==='onboard'?'ğŸš¢ æµ·ä¸Šå·¥ä½œ':'ğŸ¢ é™¸åœ°å·¥ä½œ'}
          </div>
          <div class="mt-2 text-xs text-gray-500 cursor-move">â‹®â‹® æ‹–æ‹½æ’åº</div>
          <button onclick="event.stopPropagation(); copyTeacher(${teacher.id})"
            class="absolute top-2 right-2 bg-green-500 hover:bg-green-600 text-white p-2 rounded-full text-xs transition-colors shadow-lg opacity-0 group-hover:opacity-100" title="è¤‡è£½å¸«è³‡">ğŸ“‹</button>
        </div>`;
    }else{
      const isInternal = teacher.teacherType==='internal';
      const bgGradient = isInternal ? 'from-blue-50 to-indigo-50' : 'from-purple-50 to-pink-50';
      const titleColor = isInternal ? 'text-blue-800' : 'text-purple-800';
      const categoryTitle = isInternal ? 'å…¬å¸å…§éƒ¨è¬›å¸«' : 'å¤–è˜å°ˆæ¥­è¬›å¸«';
      const categoryIcon  = isInternal ? 'ğŸ‘¨â€ğŸ’¼' : 'ğŸ‘¨â€ğŸ“';
      const categoryBadgeColor = isInternal ? 'bg-blue-500' : 'bg-purple-500';
      card.className = 'bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 overflow-hidden cursor-pointer';
      card.onclick = () => viewTeacherDetail(teacher.id);
      card.innerHTML = `
        <div class="relative p-8 bg-gradient-to-br ${bgGradient} text-center">
          <div class="absolute top-3 right-3">
            <div class="${categoryBadgeColor} text-white px-3 py-1 rounded-full text-xs font-medium flex items-center space-x-1">
              <span>${categoryIcon}</span><span>${categoryTitle}</span>
            </div>
          </div>
          <div class="w-20 h-20 mx-auto mb-4 rounded-full ${isInternal?'bg-gradient-to-br from-blue-400 to-indigo-500':'bg-gradient-to-br from-purple-400 to-pink-500'} p-1 shadow-lg">
            <div class="w-full h-full rounded-full bg-white flex items-center justify-center">
              ${teacher.photo ? `<img src="${teacher.photo}" class="w-18 h-18 object-cover rounded-full">` : `<span class="text-xl font-bold text-gray-600">${(teacher.name||'?').charAt(0)}</span>`}
            </div>
          </div>
          <h3 class="text-2xl font-bold ${titleColor} mb-2">${teacher.name}</h3>
          <div class="text-sm ${teacher.workLocation==='onboard'?'text-orange-600':'text-green-600'} font-medium mb-2">
            ${teacher.workLocation==='onboard'?'ğŸš¢ æµ·ä¸Šå·¥ä½œ':'ğŸ¢ é™¸åœ°å·¥ä½œ'}
          </div>
          <div class="text-xs text-gray-500 opacity-70">é»æ“ŠæŸ¥çœ‹è©³ç´°è³‡æ–™</div>
        </div>`;
    }
    grid.appendChild(card);
  });
}

/* è¡¨å–®/è©³ç´° */
function addNewTeacher(){
  currentTeacherId = null;
  document.getElementById('teacherList').classList.add('hidden');
  document.getElementById('teacherDetail').classList.remove('hidden');
  document.getElementById('deleteBtn').classList.add('hidden');
  document.getElementById('teacherForm').reset();
  document.getElementById('photoPreview').innerHTML = 'ğŸ‘¤';
  document.getElementById('experienceList').innerHTML = '';
  document.getElementById('certificateList').innerHTML = '';
  document.getElementById('subjectList').innerHTML = '';
  document.querySelectorAll('.location-option').forEach(o=>o.classList.remove('selected','onboard','onshore'));
  document.querySelectorAll('.teacher-type-option').forEach(o=>o.classList.remove('selected','internal','external'));
  addExperience(); addCertificate(); addSubject();
}
function editTeacher(teacherId){
  const teacher = teachers.find(t=>t.id===teacherId); if(!teacher) return;
  currentTeacherId = teacherId;
  document.getElementById('teacherList').classList.add('hidden');
  document.getElementById('teacherDetail').classList.remove('hidden');
  document.getElementById('deleteBtn').classList.remove('hidden');
  document.getElementById('teacherName').value  = teacher.name || '';
  document.getElementById('teacherEmail').value = teacher.email || '';
  const teacherType  = teacher.teacherType || 'internal';
  const workLocation = teacher.workLocation || 'onshore';
  document.getElementById(teacherType==='internal'?'typeInternal':'typeExternal').checked = true;
  document.getElementById(workLocation==='onboard'?'locationOnboard':'locationOnshore').checked = true;

  document.querySelectorAll('.teacher-type-option').forEach(o=>o.classList.remove('selected','internal','external'));
  document.querySelector(`input[value="${teacherType}"]`).closest('label').querySelector('.teacher-type-option').classList.add('selected',teacherType);
  document.querySelectorAll('.location-option').forEach(o=>o.classList.remove('selected','onboard','onshore'));
  document.querySelector(`input[value="${workLocation}"]`).closest('label').querySelector('.location-option').classList.add('selected',workLocation);

  document.getElementById('photoPreview').innerHTML = teacher.photo ? `<img src="${teacher.photo}" class="w-full h-full object-cover rounded-full">` : 'ğŸ‘¤';

  document.getElementById('experienceList').innerHTML = '';
  (teacher.experiences||[]).forEach(exp=>addExperience(exp));
  document.getElementById('certificateList').innerHTML = '';
  (teacher.certificates||[]).forEach(cert=>{
    if (typeof cert === 'string') addCertificate(cert);
    else addCertificate(cert.name||'', cert.fileName||'', cert.fileData||'');
  });
  document.getElementById('subjectList').innerHTML = '';
  (teacher.subjects||[]).forEach(s=>addSubject(s));
}
function viewTeacherDetail(teacherId){
  const teacher = teachers.find(t=>t.id===teacherId); if(!teacher) return;
  document.getElementById('teacherList').classList.add('hidden');
  document.getElementById('teacherDetailView').classList.remove('hidden');
  const isInternal = teacher.teacherType==='internal';
  const bgGradient = isInternal?'from-blue-50 to-indigo-50':'from-purple-50 to-pink-50';
  const titleColor = isInternal?'text-blue-800':'text-purple-800';
  const categoryTitle = isInternal?'å…¬å¸å…§éƒ¨è¬›å¸«':'å¤–è˜å°ˆæ¥­è¬›å¸«';
  const categoryIcon  = isInternal?'ğŸ‘¨â€ğŸ’¼':'ğŸ‘¨â€ğŸ“';
  const categoryBadgeColor = isInternal?'bg-blue-500':'bg-purple-500';

  const content = document.getElementById('teacherDetailContent');
  content.innerHTML = `
    <div class="bg-gradient-to-br ${bgGradient} rounded-2xl p-8 mb-8 relative overflow-hidden">
      <div class="relative z-10 flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-8">
        <div class="w-32 h-32 rounded-full ${isInternal?'bg-gradient-to-br from-blue-400 to-indigo-500':'bg-gradient-to-br from-purple-400 to-pink-500'} p-2 shadow-xl">
          <div class="w-full h-full rounded-full bg-white flex items-center justify-center">
            ${teacher.photo ? `<img src="${teacher.photo}" class="w-28 h-28 object-cover rounded-full">` : `<span class="text-4xl font-bold text-gray-600">${(teacher.name||'?').charAt(0)}</span>`}
          </div>
        </div>
        <div class="flex-1 text-center md:text-left">
          <div class="mb-4">
            <div class="${categoryBadgeColor} text-white px-4 py-2 rounded-full text-sm font-medium inline-flex items-center space-x-2">
              <span>${categoryIcon}</span><span>${categoryTitle}</span>
            </div>
          </div>
          <h1 class="text-4xl font-bold ${titleColor} mb-3">${teacher.name}</h1>
          <div class="space-y-2 text-lg">
            ${teacher.email ? `<div class="flex items-center justify-center md:justify-start space-x-2"><span class="text-gray-600">ğŸ“§</span><span class="text-gray-700">${teacher.email}</span></div>` : ''}
            <div class="flex items-center justify-center md:justify-start space-x-2">
              <span class="${teacher.workLocation==='onboard'?'text-orange-600':'text-green-600'}">${teacher.workLocation==='onboard'?'ğŸš¢':'ğŸ¢'}</span>
              <span class="${teacher.workLocation==='onboard'?'text-orange-600':'text-green-600'} font-medium">${teacher.workLocation==='onboard'?'æµ·ä¸Šå·¥ä½œ':'é™¸åœ°å·¥ä½œ'}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="bg-gray-50 rounded-xl p-6">
        <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><span class="mr-3 text-3xl">ğŸ’¼</span>å·¥ä½œç¶“æ­·</h3>
        ${(teacher.experiences&&teacher.experiences.length>0)?`
          <div class="space-y-3">
            ${teacher.experiences.map(exp=>`<div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-blue-500"><p class="text-gray-700">${exp}</p></div>`).join('')}
          </div>`:`<div class="text-center py-8 text-gray-500"><div class="text-4xl mb-2">ğŸ“</div><p>å°šæœªå¡«å¯«å·¥ä½œç¶“æ­·</p></div>`}
      </div>
      <div class="bg-gray-50 rounded-xl p-6">
        <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><span class="mr-3 text-3xl">ğŸ†</span>è­‰æ›¸èˆ‡è³‡æ ¼</h3>
        ${(teacher.certificates&&teacher.certificates.length>0)?`
          <div class="space-y-3">
            ${teacher.certificates.map(cert=>{
              const certName = typeof cert==='string'?cert:cert.name;
              const hasFile = typeof cert==='object' && cert.fileName;
              return `<div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                  <p class="text-gray-700 flex-1">${certName}</p>
                  ${hasFile?`<button onclick="viewCertificateFromDetail('${cert.fileName}','${cert.fileData}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition-colors ml-3">ğŸ‘ï¸ æª¢è¦–</button>`:''}
                </div></div>`;
            }).join('')}
          </div>`:`<div class="text-center py-8 text-gray-500"><div class="text-4xl mb-2">ğŸ“</div><p>å°šæœªå¡«å¯«è­‰æ›¸è³‡æ ¼</p></div>`}
      </div>
    </div>
    <div class="bg-gray-50 rounded-xl p-6 mt-8">
      <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><span class="mr-3 text-3xl">ğŸ“š</span>è¬›æˆèª²ç¨‹</h3>
      ${(teacher.subjects&&teacher.subjects.length>0)?`
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
          ${teacher.subjects.map(s=>`<div class="bg-white rounded-lg p-4 shadow-sm text-center border-l-4 border-purple-500"><p class="text-gray-700 font-medium">${s}</p></div>`).join('')}
        </div>`:`<div class="text-center py-8 text-gray-500"><div class="text-4xl mb-2">ğŸ“–</div><p>å°šæœªå¡«å¯«è¬›æˆèª²ç¨‹</p></div>`}
    </div>
    ${currentMode==='edit'?`
      <div class="mt-8 text-center">
        <button onclick="editTeacher(${teacher.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium transition-colors shadow-lg hover:shadow-xl">âœï¸ ç·¨è¼¯å¸«è³‡è³‡æ–™</button>
      </div>`:''}
  `;
}
function viewCertificateFromDetail(fileName,fileData){
  if(!fileData){ alert('æ²’æœ‰æª”æ¡ˆå¯ä»¥æª¢è¦–'); return; }
  const w = window.open('', '_blank');
  if(fileName.toLowerCase().endsWith('.pdf')){
    w.document.write(`<html><head><title>${fileName}</title></head><body style="margin:0;"><embed src="${fileData}" type="application/pdf" width="100%" height="100%"></body></html>`);
  }else{
    w.document.write(`<html><head><title>${fileName}</title></head><body style="margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#f0f0f0;"><img src="${fileData}" style="max-width:100%;max-height:100%;object-fit:contain;"></body></html>`);
  }
}
function backToList(){
  document.getElementById('teacherDetail').classList.add('hidden');
  document.getElementById('teacherDetailView').classList.add('hidden');
  document.getElementById('teacherList').classList.remove('hidden');
  renderTeacherGrid();
}

/* å¯å¢æ¸›æ¬„ä½çš„è¼¸å…¥åˆ— */
function addExperience(value=''){
  const c = document.getElementById('experienceList');
  const div = document.createElement('div');
  div.className = 'flex items-center space-x-2 bg-white p-3 rounded-lg border border-gray-200';
  div.innerHTML = `
    <div class="flex flex-col space-y-1">
      <button type="button" onclick="moveUp(this)" class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">â†‘</button>
      <button type="button" onclick="moveDown(this)" class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">â†“</button>
    </div>
    <input type="text" value="${value}" placeholder="è«‹è¼¸å…¥å·¥ä½œç¶“æ­·..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
    <button type="button" onclick="this.parentElement.remove()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm">âœ•</button>`;
  c.appendChild(div);
}
function addCertificate(value='', fileName='', fileData=''){
  const c = document.getElementById('certificateList');
  const div = document.createElement('div');
  div.className = 'bg-white p-4 rounded-lg border border-gray-200';
  const uid = Date.now()+Math.random();
  div.innerHTML = `
    <div class="flex items-start space-x-3">
      <div class="flex flex-col space-y-1">
        <button type="button" onclick="moveUp(this)" class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">â†‘</button>
        <button type="button" onclick="moveDown(this)" class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">â†“</button>
      </div>
      <div class="flex-1 space-y-3">
        <input type="text" value="${value}" placeholder="è«‹è¼¸å…¥è­‰æ›¸æˆ–è³‡æ ¼åç¨±..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <div class="flex items-center space-x-2">
          <input type="file" id="certFile_${uid}" accept=".jpg,.jpeg,.pdf" class="hidden" onchange="handleCertificateFile(this)">
          <button type="button" onclick="document.getElementById('certFile_${uid}').click()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm">ğŸ“ ä¸Šå‚³æª”æ¡ˆ</button>
          <div class="file-info text-sm text-gray-600" data-filename="${fileName}" data-filedata="${fileData}">${fileName?`å·²ä¸Šå‚³: ${fileName}`:'æœªä¸Šå‚³æª”æ¡ˆ'}</div>
          ${fileName?`<button type="button" onclick="viewCertificateFile(this)" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs">ğŸ‘ï¸ æª¢è¦–</button>`:''}
        </div>
      </div>
      <button type="button" onclick="this.closest('.bg-white').remove()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm">âœ•</button>
    </div>`;
  c.appendChild(div);
}
function handleCertificateFile(input){
  if(input.files && input.files[0]){
    const file = input.files[0];
    const info = input.parentElement.querySelector('.file-info');
    const okTypes = ['image/jpeg','image/jpg','application/pdf'];
    if(!okTypes.includes(file.type)){ alert('åªæ”¯æ´ JPG å’Œ PDF æª”æ¡ˆæ ¼å¼'); return; }
    if(file.size > 10*1024*1024){ alert('æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 10MB'); return; }
    const reader = new FileReader();
    reader.onload = e=>{
      info.setAttribute('data-filename', file.name);
      info.setAttribute('data-filedata', e.target.result);
      info.textContent = `å·²ä¸Šå‚³: ${file.name}`;
      const exist = info.parentElement.querySelector('button[onclick="viewCertificateFile(this)"]');
      if(!exist){
        const btn = document.createElement('button');
        btn.type='button'; btn.onclick=()=>viewCertificateFile(btn);
        btn.className='bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs'; btn.innerHTML='ğŸ‘ï¸ æª¢è¦–';
        info.parentElement.appendChild(btn);
      }
    };
    reader.readAsDataURL(file);
  }
}
function viewCertificateFile(button){
  const info = button.parentElement.querySelector('.file-info');
  const fileName = info.getAttribute('data-filename');
  const fileData = info.getAttribute('data-filedata');
  if(!fileData){ alert('æ²’æœ‰æª”æ¡ˆå¯ä»¥æª¢è¦–'); return; }
  const w = window.open('', '_blank');
  if(fileName.toLowerCase().endsWith('.pdf')){
    w.document.write(`<html><head><title>${fileName}</title></head><body style="margin:0;"><embed src="${fileData}" type="application/pdf" width="100%" height="100%"></body></html>`);
  }else{
    w.document.write(`<html><head><title>${fileName}</title></head><body style="margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#f0f0f0;"><img src="${fileData}" style="max-width:100%;max-height:100%;object-fit:contain;"></body></html>`);
  }
}
function addSubject(value=''){
  const c = document.getElementById('subjectList');
  const div = document.createElement('div');
  div.className = 'flex items-center space-x-2 bg-white p-3 rounded-lg border border-gray-200';
  div.innerHTML = `
    <div class="flex flex-col space-y-1">
      <button type="button" onclick="moveUp(this)" class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">â†‘</button>
      <button type="button" onclick="moveDown(this)" class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-xs">â†“</button>
    </div>
    <input type="text" value="${value}" placeholder="è«‹è¼¸å…¥è¬›æˆèª²ç¨‹..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
    <button type="button" onclick="this.parentElement.remove()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm">âœ•</button>`;
  c.appendChild(div);
}
function moveUp(button){
  const item = button.closest('.bg-white') || button.closest('.flex.items-center');
  const prev = item.previousElementSibling;
  if(prev){ item.parentNode.insertBefore(item, prev); }
}
function moveDown(button){
  const item = button.closest('.bg-white') || button.closest('.flex.items-center');
  const next = item.nextElementSibling;
  if(next){ item.parentNode.insertBefore(next, item); }
}
function previewPhoto(input){
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = e => { document.getElementById('photoPreview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-full">`; };
    reader.readAsDataURL(input.files[0]);
  }
}
document.getElementById('teacherForm')?.addEventListener('submit', function(e){
  e.preventDefault();
  const name = document.getElementById('teacherName').value.trim();
  const email = document.getElementById('teacherEmail').value.trim();
  const teacherType  = document.querySelector('input[name="teacherType"]:checked')?.value;
  const workLocation = document.querySelector('input[name="workLocation"]:checked')?.value;
  if(!name){ alert('è«‹è¼¸å…¥å¸«è³‡å§“å'); return; }
  if(!teacherType){ alert('è«‹é¸æ“‡å¸«è³‡é¡å‹'); return; }
  if(!workLocation){ alert('è«‹é¸æ“‡å·¥ä½œåœ°é»'); return; }
  if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ alert('è«‹è¼¸å…¥æ­£ç¢ºçš„Emailæ ¼å¼'); return; }

  const experiences = Array.from(document.querySelectorAll('#experienceList input')).map(i=>i.value.trim()).filter(Boolean);
  const certificates = Array.from(document.querySelectorAll('#certificateList .bg-white')).map(item=>{
    const nameInput = item.querySelector('input[type="text"]');
    const info = item.querySelector('.file-info');
    const nm = nameInput.value.trim(); if(!nm) return null;
    const fileName = info.getAttribute('data-filename');
    const fileData = info.getAttribute('data-filedata');
    return (fileName && fileData) ? { name:nm, fileName, fileData } : nm;
  }).filter(Boolean);
  const subjects = Array.from(document.querySelectorAll('#subjectList input')).map(i=>i.value.trim()).filter(Boolean);
  const photoImg = document.querySelector('#photoPreview img');
  const photo = photoImg ? photoImg.src : null;

  const teacherData = { id: currentTeacherId || Date.now(), name, email, teacherType, workLocation, photo, experiences, certificates, subjects };
  if(currentTeacherId){
    const idx = teachers.findIndex(t=>t.id===currentTeacherId);
    teachers[idx] = teacherData;
  }else{
    teachers.push(teacherData);
  }
  localStorage.setItem('teachers', JSON.stringify(teachers));
  backToList();
  alert(currentTeacherId ? 'å¸«è³‡è³‡æ–™å·²æ›´æ–°ï¼' : 'å¸«è³‡å·²æ–°å¢ï¼');
});
function deleteTeacher(){
  if(!currentTeacherId) return;
  if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½å¸«è³‡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')){
    teachers = teachers.filter(t=>t.id!==currentTeacherId);
    localStorage.setItem('teachers', JSON.stringify(teachers));
    backToList();
    alert('å¸«è³‡å·²åˆªé™¤ï¼');
  }
}
function copyTeacher(teacherId){
  const t = teachers.find(x=>x.id===teacherId); if(!t) return;
  const copy = {
    id: Date.now(),
    name: t.name + ' (è¤‡è£½)',
    email: t.email || '',
    teacherType: t.teacherType || 'internal',
    workLocation: t.workLocation || 'onshore',
    photo: t.photo,
    experiences: [...(t.experiences||[])],
    certificates: (t.certificates||[]).map(c=> typeof c==='string'? c : ({name:c.name,fileName:c.fileName,fileData:c.fileData})),
    subjects: [...(t.subjects||[])]
  };
  const i = teachers.findIndex(x=>x.id===teacherId);
  teachers.splice(i+1,0,copy);
  localStorage.setItem('teachers', JSON.stringify(teachers));
  renderTeacherGrid();
  alert(`å·²è¤‡è£½å¸«è³‡ã€Œ${t.name}ã€ï¼`);
}

/* æ‹–æ‹½æ’åº */
function handleDragStart(e){ draggedElement = this; this.style.opacity='0.5'; e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/html', this.outerHTML); }
function handleDragOver(e){ if(e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect='move'; return false; }
function handleDrop(e){
  if(e.stopPropagation) e.stopPropagation();
  if(draggedElement !== this){
    const di = parseInt(draggedElement.dataset.index,10);
    const ti = parseInt(this.dataset.index,10);
    const d = teachers[di];
    teachers.splice(di,1);
    teachers.splice(ti,0,d);
    localStorage.setItem('teachers', JSON.stringify(teachers));
    renderTeacherGrid();
  }
  return false;
}
function handleDragEnd(){ this.style.opacity='1'; draggedElement=null; }

/* æœå°‹/çµ±è¨ˆ/åŒ¯å‡º */
function searchTeachers(){
  const searchInput = document.getElementById('searchInput');
  const kw = (searchInput?.value || '').trim().toLowerCase();
  const clearBtn = document.getElementById('clearBtn');
  const searchResults = document.getElementById('searchResults');
  if(kw){ clearBtn?.classList.remove('hidden'); }
  else { clearBtn?.classList.add('hidden'); searchResults?.classList.add('hidden'); renderTeacherGrid(); return; }

  filteredTeachers = teachers.filter(t=>{
    if((t.name||'').toLowerCase().includes(kw)) return true;
    if(t.email && t.email.toLowerCase().includes(kw)) return true;
    if((t.experiences||[]).some(x=>x.toLowerCase().includes(kw))) return true;
    if((t.certificates||[]).some(c=> typeof c==='string' ? c.toLowerCase().includes(kw) : (c.name||'').toLowerCase().includes(kw))) return true;
    if((t.subjects||[]).some(s=>s.toLowerCase().includes(kw))) return true;
    return false;
  });
  if(filteredTeachers.length>0){
    searchResults?.classList.remove('hidden');
    searchResults.querySelector('span').textContent = `æ‰¾åˆ° ${filteredTeachers.length} ä½ç¬¦åˆã€Œ${searchInput.value}ã€çš„å¸«è³‡`;
  }else{
    searchResults?.classList.add('hidden');
  }
  renderTeacherGrid(filteredTeachers);
}
function clearSearch(){
  const searchInput = document.getElementById('searchInput');
  if (searchInput) searchInput.value = '';
  document.getElementById('clearBtn')?.classList.add('hidden');
  document.getElementById('searchResults')?.classList.add('hidden');
  filteredTeachers = [];
  renderTeacherGrid();
}

function showStatisticsView(){
  document.getElementById('teacherList').classList.add('hidden');
  document.getElementById('executiveView').classList.remove('hidden');
  renderStatisticsView();
}
function backToListFromExecutive(){
  document.getElementById('executiveView').classList.add('hidden');
  document.getElementById('teacherList').classList.remove('hidden');
}
function renderStatisticsView(){
  const total   = teachers.length;
  const internal= teachers.filter(t=>t.teacherType==='internal').length;
  const external= teachers.filter(t=>t.teacherType==='external').length;
  const onboard = teachers.filter(t=>t.workLocation==='onboard').length;
  const onshore = teachers.filter(t=>t.workLocation==='onshore').length;

  const internalOnboard = teachers.filter(t=>t.teacherType==='internal' && t.workLocation==='onboard').length;
  const internalOnshore = teachers.filter(t=>t.teacherType==='internal' && t.workLocation==='onshore').length;
  const externalOnboard = teachers.filter(t=>t.teacherType==='external' && t.workLocation==='onboard').length;
  const externalOnshore = teachers.filter(t=>t.teacherType==='external' && t.workLocation==='onshore').length;

  const allSubjects    = teachers.flatMap(t=>t.subjects||[]);
  const uniqueSubjects = [...new Set(allSubjects)];
  const avg = total>0 ? (allSubjects.length/total).toFixed(1) : 0;

  const byId = id => document.getElementById(id);
  byId('totalCount').textContent = total;
  byId('internalCount').textContent = internal;
  byId('externalCount').textContent = external;
  byId('onboardCount').textContent = onboard;
  byId('onshoreCount').textContent = onshore;

  const ip  = total>0 ? ((internal/total)*100).toFixed(1) : 0;
  const ep  = total>0 ? ((external/total)*100).toFixed(1) : 0;
  const obp = total>0 ? ((onboard/total)*100).toFixed(1) : 0;
  const osp = total>0 ? ((onshore/total)*100).toFixed(1) : 0;

  byId('internalPercent').textContent = `${ip}%`;
  byId('externalPercent').textContent = `${ep}%`;
  byId('locationRatio').textContent   = `æ¯”ä¾‹ ${onboard}:${onshore}`;

  byId('internalCountDetail').textContent  = `${internal} ä½`;
  byId('internalPercentDetail').textContent= `${ip}%`;
  byId('externalCountDetail').textContent  = `${external} ä½`;
  byId('externalPercentDetail').textContent= `${ep}%`;
  byId('onboardCountDetail').textContent   = `${onboard} ä½`;
  byId('onboardPercentDetail').textContent = `${obp}%`;
  byId('onshoreCountDetail').textContent   = `${onshore} ä½`;
  byId('onshorePercentDetail').textContent = `${osp}%`;

  byId('internalOnboard').textContent = internalOnboard;
  byId('internalOnshore').textContent = internalOnshore;
  byId('externalOnboard').textContent = externalOnboard;
  byId('externalOnshore').textContent = externalOnshore;

  byId('totalSubjects').textContent        = allSubjects.length;
  byId('avgSubjectsPerTeacher').textContent= avg;
  byId('uniqueSubjects').textContent       = uniqueSubjects.length;

  const counts = {}; allSubjects.forEach(s=>counts[s]=(counts[s]||0)+1);
  const sorted = Object.entries(counts).sort(([,a],[,b])=>b-a).slice(0,10);
  const box = byId('popularSubjects');
  box.innerHTML = sorted.length>0 ? sorted.map(([s,c],i)=>`
    <div class="flex items-center justify-between p-3 bg-white rounded-lg shadow-sm">
      <div class="flex items-center space-x-3">
        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-full flex items-center justify-center text-sm font-bold">${i+1}</div>
        <span class="font-medium text-gray-700">${s}</span>
      </div>
      <div class="text-right">
        <div class="font-bold text-purple-600">${c} ä½</div>
        <div class="text-xs text-gray-500">å¸«è³‡æ•™æˆ</div>
      </div>
    </div>`).join('') : `
    <div class="text-center py-8 text-gray-500"><div class="text-4xl mb-2">ğŸ“š</div><p>å°šæœªæœ‰èª²ç¨‹è³‡æ–™</p></div>`;
}

function testFunction(){ console.log('æ¸¬è©¦æŒ‰éˆ•è¢«é»æ“Š'); alert('æ¸¬è©¦æŒ‰éˆ•æ­£å¸¸å·¥ä½œï¼'); }

/* åŒ¯å‡ºï¼ˆCSV / XLSXï¼‰ */
function _collectRows(){
  if(!Array.isArray(teachers) || teachers.length===0){ alert('ç›®å‰æ²’æœ‰å¸«è³‡è³‡æ–™å¯ä»¥åŒ¯å‡º'); return null; }
  return teachers.map((t,i)=>({
    idx:i+1,
    name:t.name||'',
    email:t.email||'',
    teacherType:t.teacherType==='internal'?'å…§éƒ¨å¸«è³‡':'å¤–éƒ¨å¸«è³‡',
    workLocation:t.workLocation==='onboard'?'æµ·ä¸Šå·¥ä½œ':'é™¸åœ°å·¥ä½œ',
    experiences:(t.experiences||[]).join('ï¼›') || 'ç„¡',
    certificates:(t.certificates||[]).map(c=> typeof c==='string'? c : (c?.name||'')).filter(Boolean).join('ï¼›') || 'ç„¡',
    subjects:(t.subjects||[]).join('ï¼›') || 'ç„¡'
  }));
}
function forceDownload(dataOrBlob, filename, mime='text/plain;charset=utf-8'){
  const blob = dataOrBlob instanceof Blob ? dataOrBlob : new Blob([String(dataOrBlob)],{type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.target = '_blank'; a.rel='noopener';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),1500);
}
function csvCell(s){ s=(s??'').toString().replace(/\r\n|\r/g,'\n').replace(/"/g,'""'); return `"${s}"`; }
function _fn(prefix,ext){ const d=new Date(); return `${prefix}_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}.${ext}`; }

function exportToCSV_API(){
  const rows = _collectRows(); if(!rows) return;
  const headers = ['åºè™Ÿ','å§“å','Email','å¸«è³‡é¡å‹','å·¥ä½œåœ°é»','å·¥ä½œç¶“æ­·','è­‰æ›¸èˆ‡è³‡æ ¼','è¬›æˆèª²ç¨‹'];
  let csv = headers.join(',') + '\n';
  rows.forEach(r=>{
    csv += [r.idx,csvCell(r.name),csvCell(r.email),csvCell(r.teacherType),csvCell(r.workLocation),csvCell(r.experiences),csvCell(r.certificates),csvCell(r.subjects)].join(',') + '\n';
  });
  const BOM = '\uFEFF';
  const blob = new Blob([BOM + csv], { type:'text/csv;charset=utf-8' });
  forceDownload(blob, _fn('å¸«è³‡é™£å®¹','csv'), 'text/csv;charset=utf-8');
}
function exportToXLSX_API(){
  if (typeof XLSX==='undefined'){ alert('XLSX å‡½å¼åº«å°šæœªè¼‰å…¥'); return; }
  const rows = _collectRows(); if(!rows) return;
  const aoa = [['åºè™Ÿ','å§“å','Email','å¸«è³‡é¡å‹','å·¥ä½œåœ°é»','å·¥ä½œç¶“æ­·','è­‰æ›¸èˆ‡è³‡æ ¼','è¬›æˆèª²ç¨‹'], ...rows.map(r=>[r.idx,r.name,r.email,r.teacherType,r.workLocation,r.experiences,r.certificates,r.subjects])];
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  ws['!cols'] = aoa[0].map((_,c)=>({wch: Math.min(40, Math.max(...aoa.map(r=> (r[c]? String(r[c]).length : 0)))+2)}));
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'å¸«è³‡é™£å®¹');
  const ab = XLSX.write(wb, { bookType:'xlsx', type:'array' });
  const blob = new Blob([ab], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  forceDownload(blob, _fn('å¸«è³‡é™£å®¹','xlsx'), 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
}
</script>
