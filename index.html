<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>師資陣容管理系統</title>
  <!-- Tailwind / XLSX（CDN） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
    body { font-family:'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">師資陣容管理</h1>
      <p class="text-gray-600">管理您的教師團隊資訊</p>
    </div>

    <!-- 功能列 -->
    <div class="flex flex-wrap items-center gap-3 mb-6">
      <button id="editModeBtn" class="px-4 py-2 rounded-md text-sm font-medium bg-blue-600 text-white">✏️ 編輯模式</button>
      <button id="displayModeBtn" class="px-4 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-gray-800">👁️ 呈現模式</button>

      <button id="exportCSVBtn"  class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">📊 CSV</button>
      <button id="exportXLSXBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">📋 XLSX</button>

      <button id="cloudLoadBtn" class="cloud-btn bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-medium">☁️ 由雲端載入</button>
      <button id="cloudSaveBtn" class="cloud-btn bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium">☁️ 儲存到雲端</button>

      <button id="testBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium">測試</button>

      <div class="ml-auto flex gap-2">
        <input id="searchInput" class="w-72 px-3 py-2 rounded border" placeholder="搜尋師資姓名、課程、經歷…"/>
        <button id="addTeacherBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">➕ 新增師資</button>
      </div>
    </div>

    <!-- 模式說明 -->
    <div id="modeDescription" class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-6">
      <div class="flex items-center gap-2">
        <span class="text-blue-600">ℹ️</span>
        <span class="text-blue-700 text-sm font-medium">編輯模式：可以新增、編輯、刪除、複製和排序師資</span>
      </div>
    </div>

    <!-- 清單 -->
    <div id="teacherGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

    <!-- 編輯面板 -->
    <div id="editor" class="hidden mt-8">
      <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-xl font-bold mb-4" id="editorTitle">新增師資</h2>
        <form id="teacherForm" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-gray-600">姓名 *</label>
              <input id="f_name" class="w-full px-3 py-2 rounded border" required />
            </div>
            <div>
              <label class="text-sm text-gray-600">Email</label>
              <input id="f_email" type="email" class="w-full px-3 py-2 rounded border" />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-gray-600">師資類型 *</label>
              <div class="flex gap-4 mt-2">
                <label class="flex items-center gap-2"><input type="radio" name="f_type" value="internal"> 內部</label>
                <label class="flex items-center gap-2"><input type="radio" name="f_type" value="external"> 外部</label>
              </div>
            </div>
            <div>
              <label class="text-sm text-gray-600">工作地點 *</label>
              <div class="flex gap-4 mt-2">
                <label class="flex items-center gap-2"><input type="radio" name="f_loc" value="onboard"> 海上</label>
                <label class="flex items-center gap-2"><input type="radio" name="f_loc" value="onshore"> 陸地</label>
              </div>
            </div>
          </div>

          <div>
            <label class="text-sm text-gray-600">工作經歷（每行一筆）</label>
            <textarea id="f_exps" class="w-full px-3 py-2 rounded border" rows="3"></textarea>
          </div>

          <div>
            <label class="text-sm text-gray-600">證書與資格（每行一筆）</label>
            <textarea id="f_certs" class="w-full px-3 py-2 rounded border" rows="3"></textarea>
          </div>

          <div>
            <label class="text-sm text-gray-600">講授課程（每行一筆）</label>
            <textarea id="f_subjs" class="w-full px-3 py-2 rounded border" rows="3"></textarea>
          </div>

          <div class="flex justify-end gap-3">
            <button type="button" id="deleteBtn" class="hidden bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">刪除</button>
            <button type="button" id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">取消</button>
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">儲存</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
  /* ========= 後端 API 設定 ========= */
  const API_BASE  = 'https://script.google.com/macros/s/AKfycbw6lXfe_YhHYQLMVwfmAJ3iFjbzgtmDBnVVNMH8JH0kZXxTPQ_cMbL4N3pXvtIVt8ZHHg/exec';
  const API_TOKEN = 'tr_demo_12345';
  const hasAPI   = () => typeof API_BASE === 'string' && API_BASE.startsWith('https://script.google.com/macros/');

  /* ========= 狀態 ========= */
  let teachers = JSON.parse(localStorage.getItem('teachers') || '[]');
  let currentId = null;
  let currentMode = 'edit';

  /* ========= 工具 ========= */
  const $ = sel => document.querySelector(sel);
  const saveLocal = () => localStorage.setItem('teachers', JSON.stringify(teachers));
  const uuid = () => 't_' + Date.now() + '_' + Math.floor(Math.random()*1e6);

  function sanitizeForCloud(list){
    return list.map(t => ({
      id: t.id, name:t.name, email:t.email,
      teacherType:t.teacherType, workLocation:t.workLocation,
      photoUrl: t.photoUrl || '',
      experiences: Array.isArray(t.experiences) ? t.experiences : [],
      certificates: Array.isArray(t.certificates) ? t.certificates : [],
      subjects: Array.isArray(t.subjects) ? t.subjects : [],
    }));
  }

  /* ========= 雲端同步 ========= */
  async function cloudLoad(){
    if(!hasAPI()){ alert('尚未設定後端 API'); return; }
    try{
      const url = `${API_BASE}?action=list&token=${encodeURIComponent(API_TOKEN)}`;
      const res = await fetch(url, { method:'GET' });
      const data = await res.json();
      if (data && data.ok && Array.isArray(data.data)){
        teachers = data.data.map(t => ({
          id:t.id, name:t.name, email:t.email,
          teacherType:t.teacherType, workLocation:t.workLocation,
          photoUrl:t.photoUrl || '',
          experiences:t.experiences||[], certificates:t.certificates||[], subjects:t.subjects||[]
        }));
        saveLocal();
        renderGrid();
        alert(`已從雲端載入 ${teachers.length} 筆資料`);
      }else{
        alert('雲端回傳格式不正確');
      }
    }catch(err){
      console.error(err);
      alert('雲端載入失敗，請稍後再試');
    }
  }

  async function cloudSave(){
    if(!hasAPI()){ alert('尚未設定後端 API'); return; }
    try{
      const payload = { action:'saveAll', token:API_TOKEN, teachers:sanitizeForCloud(teachers) };
      const res = await fetch(API_BASE, {
        method:'POST',
        headers: { 'Content-Type':'text/plain;charset=utf-8' }, // 避免 CORS 預檢
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data && data.ok){
        alert(`已儲存到雲端，共 ${data.count ?? teachers.length} 筆`);
      }else{
        alert('儲存失敗：' + (data?.error || '未知錯誤'));
      }
    }catch(err){
      console.error(err);
      alert('雲端儲存失敗，請稍後再試');
    }
  }

  /* ========= UI：模式切換 ========= */
  function switchMode(mode){
    currentMode = mode;
    if (mode === 'edit'){
      $('#editModeBtn').className = 'px-4 py-2 rounded-md text-sm font-medium bg-blue-600 text-white';
      $('#displayModeBtn').className = 'px-4 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-gray-800';
      $('#modeDescription').className = 'bg-blue-50 border border-blue-200 rounded-lg p-3 mb-6';
      $('#modeDescription').innerHTML = '<div class="flex items-center gap-2"><span class="text-blue-600">ℹ️</span><span class="text-blue-700 text-sm font-medium">編輯模式：可以新增、編輯、刪除、複製和排序師資</span></div>';
      $('#addTeacherBtn').classList.remove('hidden');
      $('#exportCSVBtn').classList.remove('hidden');
      $('#exportXLSXBtn').classList.remove('hidden');
    }else{
      $('#displayModeBtn').className = 'px-4 py-2 rounded-md text-sm font-medium bg-green-600 text-white';
      $('#editModeBtn').className = 'px-4 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-gray-800';
      $('#modeDescription').className = 'bg-green-50 border border-green-200 rounded-lg p-3 mb-6';
      $('#modeDescription').innerHTML = '<div class="flex items-center gap-2"><span class="text-green-600">👁️</span><span class="text-green-700 text-sm font-medium">呈現模式：以美觀的方式展示師資陣容</span></div>';
      $('#addTeacherBtn').classList.add('hidden');
      $('#exportCSVBtn').classList.add('hidden');
      $('#exportXLSXBtn').classList.add('hidden');
    }
    renderGrid();
  }

  /* ========= UI：清單 ========= */
  function renderGrid(list=null){
    const grid = $('#teacherGrid');
    grid.innerHTML = '';
    const data = list || teachers;

    if (!data.length){
      grid.innerHTML = `
        <div class="col-span-full text-center py-12 bg-white rounded-xl shadow">
          <div class="text-6xl mb-4">👨‍🏫</div>
          <div class="text-gray-600">尚無資料，點「新增師資」開始建立</div>
        </div>`;
      return;
    }

    data.forEach(t => {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-xl shadow hover:shadow-lg transition p-5 cursor-pointer';
      card.innerHTML = `
        <div class="flex items-center justify-between mb-3">
          <div class="text-xs px-2 py-1 rounded-full ${t.teacherType==='internal'?'bg-blue-100 text-blue-700':'bg-purple-100 text-purple-700'}">
            ${t.teacherType==='internal'?'內部':'外部'}
          </div>
          <div class="text-xs px-2 py-1 rounded-full ${t.workLocation==='onboard'?'bg-orange-100 text-orange-700':'bg-green-100 text-green-700'}">
            ${t.workLocation==='onboard'?'海上':'陸地'}
          </div>
        </div>
        <div class="text-lg font-semibold text-gray-800">${t.name || '(未命名)'}</div>
        ${t.email ? `<div class="text-sm text-gray-500 mt-1">${t.email}</div>`:''}
        <div class="text-xs text-gray-400 mt-3">${(t.subjects||[]).slice(0,3).join('、')}${(t.subjects||[]).length>3?' …':''}</div>
      `;
      card.onclick = () => openEditor(t.id);
      grid.appendChild(card);
    });
  }

  /* ========= 編輯 ========= */
  function openEditor(id=null){
    currentId = id;
    $('#editor').classList.remove('hidden');
    $('#editorTitle').textContent = id ? '編輯師資' : '新增師資';
    $('#deleteBtn').classList.toggle('hidden', !id);

    let t = id ? teachers.find(x=>x.id===id) : {name:'',email:'',teacherType:'internal',workLocation:'onshore',experiences:[],certificates:[],subjects:[]};

    $('#f_name').value = t.name || '';
    $('#f_email').value = t.email || '';
    document.querySelectorAll('input[name="f_type"]').forEach(r => r.checked = (r.value === (t.teacherType||'internal')));
    document.querySelectorAll('input[name="f_loc"]').forEach(r => r.checked = (r.value === (t.workLocation||'onshore')));
    $('#f_exps').value  = (t.experiences||[]).join('\n');
    $('#f_certs').value = (t.certificates||[]).join('\n');
    $('#f_subjs').value = (t.subjects||[]).join('\n');
    window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});
  }

  function closeEditor(){
    $('#editor').classList.add('hidden');
    currentId = null;
  }

  function gatherForm(){
    const name = $('#f_name').value.trim();
    const email = $('#f_email').value.trim();
    const teacherType = document.querySelector('input[name="f_type"]:checked')?.value;
    const workLocation = document.querySelector('input[name="f_loc"]:checked')?.value;
    if (!name) { alert('請輸入姓名'); return null; }
    if (!teacherType) { alert('請選擇師資類型'); return null; }
    if (!workLocation) { alert('請選擇工作地點'); return null; }

    const exps  = $('#f_exps').value.split('\n').map(s=>s.trim()).filter(Boolean);
    const certs = $('#f_certs').value.split('\n').map(s=>s.trim()).filter(Boolean);
    const subjs = $('#f_subjs').value.split('\n').map(s=>s.trim()).filter(Boolean);

    return {
      id: currentId || uuid(),
      name, email, teacherType, workLocation,
      experiences: exps, certificates: certs, subjects: subjs
    };
  }

  /* ========= 事件 ========= */
  $('#editModeBtn').onclick    = () => switchMode('edit');
  $('#displayModeBtn').onclick = () => switchMode('display');
  $('#addTeacherBtn').onclick  = () => openEditor(null);
  $('#cloudLoadBtn').onclick   = cloudLoad;
  $('#cloudSaveBtn').onclick   = cloudSave;
  $('#testBtn').onclick        = () => alert('測試按鈕正常工作！');
  $('#cancelBtn').onclick      = closeEditor;

  $('#deleteBtn').onclick = () => {
    if (!currentId) return;
    if (confirm('確定要刪除嗎？')){
      teachers = teachers.filter(t => t.id !== currentId);
      saveLocal();
      closeEditor();
      renderGrid();
      alert('已刪除');
    }
  };

  $('#teacherForm').addEventListener('submit', e => {
    e.preventDefault();
    const t = gatherForm();
    if (!t) return;
    const idx = teachers.findIndex(x => x.id === t.id);
    if (idx >= 0) teachers[idx] = t; else teachers.push(t);
    saveLocal();
    closeEditor();
    renderGrid();
    alert('已儲存');
  });

  $('#searchInput').addEventListener('input', e => {
    const kw = e.target.value.trim().toLowerCase();
    if (!kw) { renderGrid(); return; }
    const list = teachers.filter(t =>
      (t.name||'').toLowerCase().includes(kw) ||
      (t.email||'').toLowerCase().includes(kw) ||
      (t.experiences||[]).some(x => x.toLowerCase().includes(kw)) ||
      (t.certificates||[]).some(x => x.toLowerCase().includes(kw)) ||
      (t.subjects||[]).some(x => x.toLowerCase().includes(kw))
    );
    renderGrid(list);
  });

  // 匯出
  function rowsForExport(){
    if (!teachers.length){ alert('沒有資料'); return null; }
    return teachers.map((t,i) => ({
      序號: i+1,
      姓名: t.name || '',
      Email: t.email || '',
      師資類型: t.teacherType==='internal'?'內部':'外部',
      工作地點: t.workLocation==='onboard'?'海上':'陸地',
      工作經歷: (t.experiences||[]).join('；') || '無',
      證書與資格: (t.certificates||[]).join('；') || '無',
      講授課程: (t.subjects||[]).join('；') || '無',
    }));
  }
  $('#exportCSVBtn').onclick = () => {
    const rows = rowsForExport(); if(!rows) return;
    const header = Object.keys(rows[0]);
    const escape = s => `"${String(s??'').replace(/"/g,'""').replace(/\r\n|\r/g,'\n')}"`;
    let csv = header.join(',') + '\n';
    rows.forEach(r => csv += header.map(h => escape(r[h])).join(',') + '\n');
    const blob = new Blob(['\uFEFF' + csv], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href = url; a.download = `師資陣容_${Date.now()}.csv`; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  };
  $('#exportXLSXBtn').onclick = () => {
    const rows = rowsForExport(); if(!rows) return;
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, '師資陣容');
    const ab = XLSX.write(wb, { bookType:'xlsx', type:'array' });
    const blob = new Blob([ab], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href = url; a.download = `師資陣容_${Date.now()}.xlsx`; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  };

  // 初始化
  switchMode('edit');
  renderGrid();
  if (!hasAPI()) document.querySelectorAll('.cloud-btn').forEach(b => b.classList.add('hidden'));
  </script>
</body>
</html>
