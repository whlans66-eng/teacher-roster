<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¸«è³‡é™£å®¹ç®¡ç†ç³»çµ±</title>
  <!-- Tailwind / XLSXï¼ˆCDNï¼‰ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
    body { font-family:'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">å¸«è³‡é™£å®¹ç®¡ç†</h1>
      <p class="text-gray-600">ç®¡ç†æ‚¨çš„æ•™å¸«åœ˜éšŠè³‡è¨Š</p>
    </div>

    <!-- åŠŸèƒ½åˆ— -->
    <div class="flex flex-wrap items-center gap-3 mb-6">
      <button id="editModeBtn" class="px-4 py-2 rounded-md text-sm font-medium bg-blue-600 text-white">âœï¸ ç·¨è¼¯æ¨¡å¼</button>
      <button id="displayModeBtn" class="px-4 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-gray-800">ğŸ‘ï¸ å‘ˆç¾æ¨¡å¼</button>

      <button id="exportCSVBtn"  class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">ğŸ“Š CSV</button>
      <button id="exportXLSXBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">ğŸ“‹ XLSX</button>

      <button id="cloudLoadBtn" class="cloud-btn bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-medium">â˜ï¸ ç”±é›²ç«¯è¼‰å…¥</button>
      <button id="cloudSaveBtn" class="cloud-btn bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium">â˜ï¸ å„²å­˜åˆ°é›²ç«¯</button>

      <button id="testBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium">æ¸¬è©¦</button>

      <div class="ml-auto flex gap-2">
        <input id="searchInput" class="w-72 px-3 py-2 rounded border" placeholder="æœå°‹å¸«è³‡å§“åã€èª²ç¨‹ã€ç¶“æ­·â€¦"/>
        <button id="addTeacherBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">â• æ–°å¢å¸«è³‡</button>
      </div>
    </div>

    <!-- æ¨¡å¼èªªæ˜ -->
    <div id="modeDescription" class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-6">
      <div class="flex items-center gap-2">
        <span class="text-blue-600">â„¹ï¸</span>
        <span class="text-blue-700 text-sm font-medium">ç·¨è¼¯æ¨¡å¼ï¼šå¯ä»¥æ–°å¢ã€ç·¨è¼¯ã€åˆªé™¤ã€è¤‡è£½å’Œæ’åºå¸«è³‡</span>
      </div>
    </div>

    <!-- æ¸…å–® -->
    <div id="teacherGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

    <!-- ç·¨è¼¯é¢æ¿ -->
    <div id="editor" class="hidden mt-8">
      <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-xl font-bold mb-4" id="editorTitle">æ–°å¢å¸«è³‡</h2>
        <form id="teacherForm" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-gray-600">å§“å *</label>
              <input id="f_name" class="w-full px-3 py-2 rounded border" required />
            </div>
            <div>
              <label class="text-sm text-gray-600">Email</label>
              <input id="f_email" type="email" class="w-full px-3 py-2 rounded border" />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-gray-600">å¸«è³‡é¡å‹ *</label>
              <div class="flex gap-4 mt-2">
                <label class="flex items-center gap-2"><input type="radio" name="f_type" value="internal"> å…§éƒ¨</label>
                <label class="flex items-center gap-2"><input type="radio" name="f_type" value="external"> å¤–éƒ¨</label>
              </div>
            </div>
            <div>
              <label class="text-sm text-gray-600">å·¥ä½œåœ°é» *</label>
              <div class="flex gap-4 mt-2">
                <label class="flex items-center gap-2"><input type="radio" name="f_loc" value="onboard"> æµ·ä¸Š</label>
                <label class="flex items-center gap-2"><input type="radio" name="f_loc" value="onshore"> é™¸åœ°</label>
              </div>
            </div>
          </div>

          <div>
            <label class="text-sm text-gray-600">å·¥ä½œç¶“æ­·ï¼ˆæ¯è¡Œä¸€ç­†ï¼‰</label>
            <textarea id="f_exps" class="w-full px-3 py-2 rounded border" rows="3"></textarea>
          </div>

          <div>
            <label class="text-sm text-gray-600">è­‰æ›¸èˆ‡è³‡æ ¼ï¼ˆæ¯è¡Œä¸€ç­†ï¼‰</label>
            <textarea id="f_certs" class="w-full px-3 py-2 rounded border" rows="3"></textarea>
          </div>

          <div>
            <label class="text-sm text-gray-600">è¬›æˆèª²ç¨‹ï¼ˆæ¯è¡Œä¸€ç­†ï¼‰</label>
            <textarea id="f_subjs" class="w-full px-3 py-2 rounded border" rows="3"></textarea>
          </div>

          <div class="flex justify-end gap-3">
            <button type="button" id="deleteBtn" class="hidden bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">åˆªé™¤</button>
            <button type="button" id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">å–æ¶ˆ</button>
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">å„²å­˜</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
  /* ========= å¾Œç«¯ API è¨­å®š ========= */
  const API_BASE  = 'https://script.google.com/macros/s/AKfycbw6lXfe_YhHYQLMVwfmAJ3iFjbzgtmDBnVVNMH8JH0kZXxTPQ_cMbL4N3pXvtIVt8ZHHg/exec';
  const API_TOKEN = 'tr_demo_12345';
  const hasAPI   = () => typeof API_BASE === 'string' && API_BASE.startsWith('https://script.google.com/macros/');

  /* ========= ç‹€æ…‹ ========= */
  let teachers = JSON.parse(localStorage.getItem('teachers') || '[]');
  let currentId = null;
  let currentMode = 'edit';

  /* ========= å·¥å…· ========= */
  const $ = sel => document.querySelector(sel);
  const saveLocal = () => localStorage.setItem('teachers', JSON.stringify(teachers));
  const uuid = () => 't_' + Date.now() + '_' + Math.floor(Math.random()*1e6);

  function sanitizeForCloud(list){
    return list.map(t => ({
      id: t.id, name:t.name, email:t.email,
      teacherType:t.teacherType, workLocation:t.workLocation,
      photoUrl: t.photoUrl || '',
      experiences: Array.isArray(t.experiences) ? t.experiences : [],
      certificates: Array.isArray(t.certificates) ? t.certificates : [],
      subjects: Array.isArray(t.subjects) ? t.subjects : [],
    }));
  }

  /* ========= é›²ç«¯åŒæ­¥ ========= */
  async function cloudLoad(){
    if(!hasAPI()){ alert('å°šæœªè¨­å®šå¾Œç«¯ API'); return; }
    try{
      const url = `${API_BASE}?action=list&token=${encodeURIComponent(API_TOKEN)}`;
      const res = await fetch(url, { method:'GET' });
      const data = await res.json();
      if (data && data.ok && Array.isArray(data.data)){
        teachers = data.data.map(t => ({
          id:t.id, name:t.name, email:t.email,
          teacherType:t.teacherType, workLocation:t.workLocation,
          photoUrl:t.photoUrl || '',
          experiences:t.experiences||[], certificates:t.certificates||[], subjects:t.subjects||[]
        }));
        saveLocal();
        renderGrid();
        alert(`å·²å¾é›²ç«¯è¼‰å…¥ ${teachers.length} ç­†è³‡æ–™`);
      }else{
        alert('é›²ç«¯å›å‚³æ ¼å¼ä¸æ­£ç¢º');
      }
    }catch(err){
      console.error(err);
      alert('é›²ç«¯è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  }

  async function cloudSave(){
    if(!hasAPI()){ alert('å°šæœªè¨­å®šå¾Œç«¯ API'); return; }
    try{
      const payload = { action:'saveAll', token:API_TOKEN, teachers:sanitizeForCloud(teachers) };
      const res = await fetch(API_BASE, {
        method:'POST',
        headers: { 'Content-Type':'text/plain;charset=utf-8' }, // é¿å… CORS é æª¢
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data && data.ok){
        alert(`å·²å„²å­˜åˆ°é›²ç«¯ï¼Œå…± ${data.count ?? teachers.length} ç­†`);
      }else{
        alert('å„²å­˜å¤±æ•—ï¼š' + (data?.error || 'æœªçŸ¥éŒ¯èª¤'));
      }
    }catch(err){
      console.error(err);
      alert('é›²ç«¯å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  }

  /* ========= UIï¼šæ¨¡å¼åˆ‡æ› ========= */
  function switchMode(mode){
    currentMode = mode;
    if (mode === 'edit'){
      $('#editModeBtn').className = 'px-4 py-2 rounded-md text-sm font-medium bg-blue-600 text-white';
      $('#displayModeBtn').className = 'px-4 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-gray-800';
      $('#modeDescription').className = 'bg-blue-50 border border-blue-200 rounded-lg p-3 mb-6';
      $('#modeDescription').innerHTML = '<div class="flex items-center gap-2"><span class="text-blue-600">â„¹ï¸</span><span class="text-blue-700 text-sm font-medium">ç·¨è¼¯æ¨¡å¼ï¼šå¯ä»¥æ–°å¢ã€ç·¨è¼¯ã€åˆªé™¤ã€è¤‡è£½å’Œæ’åºå¸«è³‡</span></div>';
      $('#addTeacherBtn').classList.remove('hidden');
      $('#exportCSVBtn').classList.remove('hidden');
      $('#exportXLSXBtn').classList.remove('hidden');
    }else{
      $('#displayModeBtn').className = 'px-4 py-2 rounded-md text-sm font-medium bg-green-600 text-white';
      $('#editModeBtn').className = 'px-4 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-gray-800';
      $('#modeDescription').className = 'bg-green-50 border border-green-200 rounded-lg p-3 mb-6';
      $('#modeDescription').innerHTML = '<div class="flex items-center gap-2"><span class="text-green-600">ğŸ‘ï¸</span><span class="text-green-700 text-sm font-medium">å‘ˆç¾æ¨¡å¼ï¼šä»¥ç¾è§€çš„æ–¹å¼å±•ç¤ºå¸«è³‡é™£å®¹</span></div>';
      $('#addTeacherBtn').classList.add('hidden');
      $('#exportCSVBtn').classList.add('hidden');
      $('#exportXLSXBtn').classList.add('hidden');
    }
    renderGrid();
  }

  /* ========= UIï¼šæ¸…å–® ========= */
  function renderGrid(list=null){
    const grid = $('#teacherGrid');
    grid.innerHTML = '';
    const data = list || teachers;

    if (!data.length){
      grid.innerHTML = `
        <div class="col-span-full text-center py-12 bg-white rounded-xl shadow">
          <div class="text-6xl mb-4">ğŸ‘¨â€ğŸ«</div>
          <div class="text-gray-600">å°šç„¡è³‡æ–™ï¼Œé»ã€Œæ–°å¢å¸«è³‡ã€é–‹å§‹å»ºç«‹</div>
        </div>`;
      return;
    }

    data.forEach(t => {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-xl shadow hover:shadow-lg transition p-5 cursor-pointer';
      card.innerHTML = `
        <div class="flex items-center justify-between mb-3">
          <div class="text-xs px-2 py-1 rounded-full ${t.teacherType==='internal'?'bg-blue-100 text-blue-700':'bg-purple-100 text-purple-700'}">
            ${t.teacherType==='internal'?'å…§éƒ¨':'å¤–éƒ¨'}
          </div>
          <div class="text-xs px-2 py-1 rounded-full ${t.workLocation==='onboard'?'bg-orange-100 text-orange-700':'bg-green-100 text-green-700'}">
            ${t.workLocation==='onboard'?'æµ·ä¸Š':'é™¸åœ°'}
          </div>
        </div>
        <div class="text-lg font-semibold text-gray-800">${t.name || '(æœªå‘½å)'}</div>
        ${t.email ? `<div class="text-sm text-gray-500 mt-1">${t.email}</div>`:''}
        <div class="text-xs text-gray-400 mt-3">${(t.subjects||[]).slice(0,3).join('ã€')}${(t.subjects||[]).length>3?' â€¦':''}</div>
      `;
      card.onclick = () => openEditor(t.id);
      grid.appendChild(card);
    });
  }

  /* ========= ç·¨è¼¯ ========= */
  function openEditor(id=null){
    currentId = id;
    $('#editor').classList.remove('hidden');
    $('#editorTitle').textContent = id ? 'ç·¨è¼¯å¸«è³‡' : 'æ–°å¢å¸«è³‡';
    $('#deleteBtn').classList.toggle('hidden', !id);

    let t = id ? teachers.find(x=>x.id===id) : {name:'',email:'',teacherType:'internal',workLocation:'onshore',experiences:[],certificates:[],subjects:[]};

    $('#f_name').value = t.name || '';
    $('#f_email').value = t.email || '';
    document.querySelectorAll('input[name="f_type"]').forEach(r => r.checked = (r.value === (t.teacherType||'internal')));
    document.querySelectorAll('input[name="f_loc"]').forEach(r => r.checked = (r.value === (t.workLocation||'onshore')));
    $('#f_exps').value  = (t.experiences||[]).join('\n');
    $('#f_certs').value = (t.certificates||[]).join('\n');
    $('#f_subjs').value = (t.subjects||[]).join('\n');
    window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});
  }

  function closeEditor(){
    $('#editor').classList.add('hidden');
    currentId = null;
  }

  function gatherForm(){
    const name = $('#f_name').value.trim();
    const email = $('#f_email').value.trim();
    const teacherType = document.querySelector('input[name="f_type"]:checked')?.value;
    const workLocation = document.querySelector('input[name="f_loc"]:checked')?.value;
    if (!name) { alert('è«‹è¼¸å…¥å§“å'); return null; }
    if (!teacherType) { alert('è«‹é¸æ“‡å¸«è³‡é¡å‹'); return null; }
    if (!workLocation) { alert('è«‹é¸æ“‡å·¥ä½œåœ°é»'); return null; }

    const exps  = $('#f_exps').value.split('\n').map(s=>s.trim()).filter(Boolean);
    const certs = $('#f_certs').value.split('\n').map(s=>s.trim()).filter(Boolean);
    const subjs = $('#f_subjs').value.split('\n').map(s=>s.trim()).filter(Boolean);

    return {
      id: currentId || uuid(),
      name, email, teacherType, workLocation,
      experiences: exps, certificates: certs, subjects: subjs
    };
  }

  /* ========= äº‹ä»¶ ========= */
  $('#editModeBtn').onclick    = () => switchMode('edit');
  $('#displayModeBtn').onclick = () => switchMode('display');
  $('#addTeacherBtn').onclick  = () => openEditor(null);
  $('#cloudLoadBtn').onclick   = cloudLoad;
  $('#cloudSaveBtn').onclick   = cloudSave;
  $('#testBtn').onclick        = () => alert('æ¸¬è©¦æŒ‰éˆ•æ­£å¸¸å·¥ä½œï¼');
  $('#cancelBtn').onclick      = closeEditor;

  $('#deleteBtn').onclick = () => {
    if (!currentId) return;
    if (confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')){
      teachers = teachers.filter(t => t.id !== currentId);
      saveLocal();
      closeEditor();
      renderGrid();
      alert('å·²åˆªé™¤');
    }
  };

  $('#teacherForm').addEventListener('submit', e => {
    e.preventDefault();
    const t = gatherForm();
    if (!t) return;
    const idx = teachers.findIndex(x => x.id === t.id);
    if (idx >= 0) teachers[idx] = t; else teachers.push(t);
    saveLocal();
    closeEditor();
    renderGrid();
    alert('å·²å„²å­˜');
  });

  $('#searchInput').addEventListener('input', e => {
    const kw = e.target.value.trim().toLowerCase();
    if (!kw) { renderGrid(); return; }
    const list = teachers.filter(t =>
      (t.name||'').toLowerCase().includes(kw) ||
      (t.email||'').toLowerCase().includes(kw) ||
      (t.experiences||[]).some(x => x.toLowerCase().includes(kw)) ||
      (t.certificates||[]).some(x => x.toLowerCase().includes(kw)) ||
      (t.subjects||[]).some(x => x.toLowerCase().includes(kw))
    );
    renderGrid(list);
  });

  // åŒ¯å‡º
  function rowsForExport(){
    if (!teachers.length){ alert('æ²’æœ‰è³‡æ–™'); return null; }
    return teachers.map((t,i) => ({
      åºè™Ÿ: i+1,
      å§“å: t.name || '',
      Email: t.email || '',
      å¸«è³‡é¡å‹: t.teacherType==='internal'?'å…§éƒ¨':'å¤–éƒ¨',
      å·¥ä½œåœ°é»: t.workLocation==='onboard'?'æµ·ä¸Š':'é™¸åœ°',
      å·¥ä½œç¶“æ­·: (t.experiences||[]).join('ï¼›') || 'ç„¡',
      è­‰æ›¸èˆ‡è³‡æ ¼: (t.certificates||[]).join('ï¼›') || 'ç„¡',
      è¬›æˆèª²ç¨‹: (t.subjects||[]).join('ï¼›') || 'ç„¡',
    }));
  }
  $('#exportCSVBtn').onclick = () => {
    const rows = rowsForExport(); if(!rows) return;
    const header = Object.keys(rows[0]);
    const escape = s => `"${String(s??'').replace(/"/g,'""').replace(/\r\n|\r/g,'\n')}"`;
    let csv = header.join(',') + '\n';
    rows.forEach(r => csv += header.map(h => escape(r[h])).join(',') + '\n');
    const blob = new Blob(['\uFEFF' + csv], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href = url; a.download = `å¸«è³‡é™£å®¹_${Date.now()}.csv`; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  };
  $('#exportXLSXBtn').onclick = () => {
    const rows = rowsForExport(); if(!rows) return;
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'å¸«è³‡é™£å®¹');
    const ab = XLSX.write(wb, { bookType:'xlsx', type:'array' });
    const blob = new Blob([ab], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href = url; a.download = `å¸«è³‡é™£å®¹_${Date.now()}.xlsx`; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  };

  // åˆå§‹åŒ–
  switchMode('edit');
  renderGrid();
  if (!hasAPI()) document.querySelectorAll('.cloud-btn').forEach(b => b.classList.add('hidden'));
  </script>
</body>
</html>
