<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å„²å­˜åŠŸèƒ½æ¸¬è©¦</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-8" style="background-color: #f0ebd8;">
  <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
    <h1 class="text-2xl font-bold mb-6">ğŸ“ å¸«è³‡å„²å­˜åŠŸèƒ½æ¸¬è©¦</h1>

    <div id="status" class="mb-4 p-4 rounded-lg bg-gray-100">
      <p class="text-gray-600">ç­‰å¾…æ¸¬è©¦...</p>
    </div>

    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-2">å¸«è³‡å§“å</label>
        <input type="text" id="teacherName" class="w-full border rounded-lg px-4 py-2" placeholder="è¼¸å…¥å§“å" value="æ¸¬è©¦è€å¸«">
      </div>

      <button onclick="testSave()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700">
        ğŸ’¾ æ¸¬è©¦å„²å­˜
      </button>

      <button onclick="testLoad()" class="w-full bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700">
        ğŸ“¥ æ¸¬è©¦è®€å–
      </button>

      <button onclick="testConnection()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700">
        ğŸ”Œ æ¸¬è©¦é€£ç·š
      </button>
    </div>

    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
      <h3 class="font-medium mb-2">ğŸ“‹ æ“ä½œè¨˜éŒ„</h3>
      <div id="log" class="text-sm space-y-1 font-mono"></div>
    </div>
  </div>

  <script>
    // API é…ç½®
    const API_CONFIG = {
      baseUrl: 'https://script.google.com/macros/s/AKfycbwFBrPAnYRtQtuRuxBjY84PKhDA_9RjYIKpoHt_kWXVyNcyD4nDqHp1uytt670JuMXXKw/exec',
      token: 'tr_demo_12345',
      timeout: 30000
    };

    class TestAPI {
      constructor(config) {
        this.baseUrl = config.baseUrl;
        this.token = config.token;
        this.timeout = config.timeout;
      }

      async _get(params) {
        const url = new URL(this.baseUrl);
        url.searchParams.append('token', this.token);
        Object.keys(params).forEach(key => {
          url.searchParams.append(key, params[key]);
        });

        addLog(`ğŸ”„ GET ${url.toString()}`);

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), this.timeout);

        try {
          const response = await fetch(url.toString(), {
            method: 'GET',
            signal: controller.signal
          });
          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          addLog(`âœ… å›æ‡‰: ${JSON.stringify(data).substring(0, 100)}...`);
          return data;
        } catch (error) {
          clearTimeout(timeoutId);
          addLog(`âŒ éŒ¯èª¤: ${error.message}`);
          throw error;
        }
      }

      async _post(data) {
        addLog(`ğŸ”„ POST ${this.baseUrl}`);
        addLog(`ğŸ“¦ è³‡æ–™: ${JSON.stringify(data).substring(0, 100)}...`);

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), this.timeout);

        try {
          const response = await fetch(this.baseUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
              token: this.token,
              action: data.action,
              table: data.table || '',
              data: JSON.stringify(data.data || {})
            }),
            signal: controller.signal
          });
          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();
          addLog(`âœ… å›æ‡‰: ${JSON.stringify(result)}`);
          return result;
        } catch (error) {
          clearTimeout(timeoutId);
          addLog(`âŒ éŒ¯èª¤: ${error.message}`);
          throw error;
        }
      }

      async ping() {
        return await this._get({ action: 'ping' });
      }

      async list(table) {
        const response = await this._get({ action: 'list', table });
        return response.data || [];
      }

      async save(table, data) {
        return await this._post({ action: 'save', table, data });
      }
    }

    const api = new TestAPI(API_CONFIG);

    function addLog(message) {
      const log = document.getElementById('log');
      const entry = document.createElement('div');
      const time = new Date().toLocaleTimeString();
      entry.textContent = `[${time}] ${message}`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }

    function updateStatus(message, type = 'info') {
      const status = document.getElementById('status');
      const colors = {
        info: 'bg-blue-100 text-blue-800',
        success: 'bg-green-100 text-green-800',
        error: 'bg-red-100 text-red-800',
        warning: 'bg-yellow-100 text-yellow-800'
      };
      status.className = `mb-4 p-4 rounded-lg ${colors[type]}`;
      status.innerHTML = `<p class="font-medium">${message}</p>`;
    }

    async function testConnection() {
      addLog('=== é–‹å§‹æ¸¬è©¦é€£ç·š ===');
      updateStatus('ğŸ”Œ æ¸¬è©¦é€£ç·šä¸­...', 'info');

      try {
        const result = await api.ping();
        updateStatus('âœ… é€£ç·šæˆåŠŸï¼å¾Œç«¯æ­£å¸¸é‹ä½œ', 'success');
        addLog(`é€£ç·šæ¸¬è©¦çµæœ: ${JSON.stringify(result)}`);
      } catch (error) {
        updateStatus(`âŒ é€£ç·šå¤±æ•—: ${error.message}`, 'error');
        addLog(`é€£ç·šæ¸¬è©¦å¤±æ•—: ${error.message}`);
      }
    }

    async function testSave() {
      const name = document.getElementById('teacherName').value;
      if (!name) {
        alert('è«‹è¼¸å…¥å¸«è³‡å§“å');
        return;
      }

      addLog('=== é–‹å§‹æ¸¬è©¦å„²å­˜ ===');
      updateStatus('ğŸ’¾ å„²å­˜ä¸­...', 'info');

      const testData = [{
        id: Date.now(),
        name: name,
        email: 'test@example.com',
        teacherType: 'internal',
        workLocation: 'onshore',
        photo: '',
        experiences: ['æ¸¬è©¦ç¶“æ­·'],
        certificates: ['æ¸¬è©¦è­‰æ›¸'],
        subjects: ['æ¸¬è©¦ç§‘ç›®'],
        tags: ['æ¸¬è©¦æ¨™ç±¤']
      }];

      try {
        const result = await api.save('teachers', testData);
        updateStatus('âœ… å„²å­˜æˆåŠŸï¼', 'success');
        addLog(`å„²å­˜æˆåŠŸ: ${JSON.stringify(result)}`);
      } catch (error) {
        updateStatus(`âŒ å„²å­˜å¤±æ•—: ${error.message}`, 'error');
        addLog(`å„²å­˜å¤±æ•—: ${error.message}`);
      }
    }

    async function testLoad() {
      addLog('=== é–‹å§‹æ¸¬è©¦è®€å– ===');
      updateStatus('ğŸ“¥ è®€å–ä¸­...', 'info');

      try {
        const teachers = await api.list('teachers');
        updateStatus(`âœ… è®€å–æˆåŠŸï¼æ‰¾åˆ° ${teachers.length} ä½å¸«è³‡`, 'success');
        addLog(`è®€å–æˆåŠŸ: å…± ${teachers.length} ç­†è³‡æ–™`);
        if (teachers.length > 0) {
          addLog(`æœ€æ–°è³‡æ–™: ${JSON.stringify(teachers[teachers.length - 1])}`);
        }
      } catch (error) {
        updateStatus(`âŒ è®€å–å¤±æ•—: ${error.message}`, 'error');
        addLog(`è®€å–å¤±æ•—: ${error.message}`);
      }
    }

    // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ¸¬è©¦é€£ç·š
    window.addEventListener('DOMContentLoaded', () => {
      addLog('ğŸ“± æ¸¬è©¦é é¢å·²è¼‰å…¥');
      addLog(`ğŸ”§ API URL: ${API_CONFIG.baseUrl}`);
      addLog(`ğŸ”‘ Token: ${API_CONFIG.token}`);
      addLog('');
      addLog('ğŸ‘† è«‹é»é¸ä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦');
    });
  </script>
</body>
</html>
